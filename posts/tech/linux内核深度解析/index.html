<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Linuxå†…æ ¸æ·±åº¦è§£æ | zain&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº">
<meta name="author" content="
&nbsp;Zain">
<link rel="canonical" href="https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">
<link crossorigin="anonymous" href="/zain/assets/css/stylesheet.6bbe4903eaf247f5c3db656a51fd7b09d982ab42029edfdc123f359e2748dc03.css" integrity="sha256-a75JA&#43;ryR/XD22VqUf17CdmCq0ICnt/cEj81nidI3AM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/zain/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="apple-touch-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="mask-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Linuxå†…æ ¸æ·±åº¦è§£æ" />
<meta property="og:description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-05T00:17:58&#43;08:00" />
<meta property="article:modified_time" content="2022-10-05T00:17:58&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linuxå†…æ ¸æ·±åº¦è§£æ"/>
<meta name="twitter:description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://liuz0123.gitee.io/zain/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Linuxå†…æ ¸æ·±åº¦è§£æ",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Linuxå†…æ ¸æ·±åº¦è§£æ",
  "name": "Linuxå†…æ ¸æ·±åº¦è§£æ",
  "description": "å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº",
  "keywords": [
    ""
  ],
  "articleBody": "å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒºçš„äº’æ–¥ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ– å¤„ç†å™¨ä¸Šç”µ-\u003eæ‰§è¡Œå¼•å¯¼ç¨‹åº-\u003eåŠ è½½å†…æ ¸åˆ°å†…å­˜-\u003eæ‰§è¡Œå†…æ ¸-\u003eå†…æ ¸åˆå§‹åŒ–-\u003eå¯åŠ¨ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ ARM64å¤„ç†å™¨åˆ°ç‰©ç†åœ°å€0å–ç¬¬ä¸€æ¡æŒ‡ä»¤\n1.1 å¼•å¯¼ç¨‹åº 1.1.1 å…¥å£_start ARM64å¤„ç†å™¨U-Bootç¨‹åºæ‰§è¡Œè¿‡ç¨‹ï¼Œå…¥å£u-boot/arch/arm/cpu/armv8/start.Sæ ‡è¯†_start\n.globl\t_start _start: #if defined(CONFIG_LINUX_KERNEL_IMAGE_HEADER) #include #elif defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK) #include #else b\treset #endif 1.1.2 reset reset: /* Allow the board to save important registers */ /* å…è®¸æ¿å¡ä¿å­˜é‡è¦çš„å¯„å­˜å™¨*/ b\tsave_boot_params .globl\tsave_boot_params_ret save_boot_params_ret: #ifdef CONFIG_SYS_RESET_SCTRL bl reset_sctrl // åˆå§‹åŒ–ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨ #endif /* * å¼‚å¸¸çº§åˆ«å¯èƒ½æ˜¯3ã€2æˆ–è€…1ï¼Œåˆå§‹çŠ¶æ€ï¼š * å°ç«¯å­—èŠ‚åºï¼Œç¦æ­¢MMUï¼Œç¦æ­¢æŒ‡ä»¤/æ•°æ®ç¼“å­˜ */ adr x0, vectors witch_el x1, 3f, 2f, 1f 3: msr vbar_el3, x0 // å¼‚å¸¸çº§åˆ«3ï¼Œå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL3è®¾ç½®ä½å¼‚å¸¸å‘é‡çš„èµ·å§‹åœ°å€ mrs x0, scr_el3 // è®¾ç½®å®‰å…¨é…ç½®å¯„å­˜å™¨SCR_EL3 orr x0, x0, #0xf /* è®¾ç½®å¯„å­˜å™¨SCR_EL3çš„NSã€IRQã€FIQå’ŒEAå››ä¸ªä½ */ msr scr_el3, x0 msr cptr_el3, xzr /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½*/ #ifdef COUNTER_FREQUENCY ldr x0, =COUNTER_FREQUENCY msr cntfrq_el0, x0 /* åˆå§‹åŒ–å¯„å­˜å™¨CNTFRQ */ #endif b 0f 2: msr vbar_el2, x0 // å¼‚å¸¸çº§åˆ«2 mov x0, #0x33ff msr cptr_el2, x0 /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */ b 0f 1: msr vbar_el1, x0 mov x0, #3 \u003c\u003c 20 msr cpacr_el1, x0 /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */ 0: â€¦ /* åº”ç”¨ARMå¤„ç†å™¨ç‰¹å®šçš„å‹˜è¯¯è¡¨*/ bl apply_core_errata /* å¤„ç†å™¨ç‰¹å®šçš„åˆå§‹åŒ–*/ bl lowlevel_init // æ‰§è¡Œboard_init_f()æ‰€éœ€æœ€å°åˆå§‹åŒ– #if defined(CONFIG_ARMV8_SPIN_TABLE) \u0026\u0026 !defined(CONFIG_SPL_BUILD) branch_if_master x0, x1, master_cpu b spin_table_secondary_jump // arch/arm/cpu/armv8/spin_tabli.c /* ç»å¯¹ä¸ä¼šè¿”å›*/ #elif defined(CONFIG_ARMV8_MULTIENTRY) branch_if_master x0, x1, master_cpu /* * ä»å¤„ç†å™¨ */ slave_cpu: wfe ldr x1, =CPU_RELEASE_ADDR // ä»å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œå®ƒè¢«å”¤é†’çš„æ—¶å€™ï¼Œä»åœ°å€CPU_RELEASE_ADDRè¯»å–å‡½æ•° ldr x0, [x1] cbz x0, slave_cpu br x0 /* è·³è½¬åˆ°æŒ‡å®šåœ°å€*/ #endif /* CONFIG_ARMV8_MULTIENTRY */ master_cpu: bl _main // ä¸»å¤„ç†å™¨æ‰§è¡Œå‡½æ•° U-Bootåˆ†ä¸ºSPLå’Œæ­£å¸¸çš„U-Bootç¨‹åºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦ç¼–è¯‘ä¸ºSPLï¼Œéœ€è¦å¼€å¯é…ç½®å®CONFIG_SPL_BUILDã€‚SPLæ˜¯â€œSecondary Program Loaderâ€çš„ç®€ç§°ï¼Œå³ç¬¬äºŒé˜¶æ®µç¨‹åºåŠ è½½å™¨ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯ç›¸å¯¹äºå¤„ç†å™¨é‡Œé¢çš„åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åºæ¥è¯´çš„ï¼Œå¤„ç†å™¨å¯åŠ¨æ—¶æœ€å…ˆæ‰§è¡Œçš„æ˜¯åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åº\n1.1.3 å‡½æ•°_main // arch/arm/lib/crt0_64.S ENTRY(_main) /* * è®¾ç½®åˆå§‹çš„Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”è°ƒç”¨board_init_f(0)ã€‚ */ #if defined(CONFIG_SPL_BUILD) \u0026\u0026 defined(CONFIG_SPL_STACK ldr x0, =(CONFIG_SPL_STACK) #else ldr x0, =(CONFIG_SYS_INIT_SP_ADDR) #endif bic sp, x0, #0xf /* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚*/ mov x0, sp bl board_init_f_alloc_reserve // åœ¨æ ˆçš„é¡¶éƒ¨ä¸ºç»“æ„ä½“global_dataåˆ†é…ç©ºé—´ mov sp, x0 /* è®¾ç½®gd */ mov x18, x0 bl board_init_f_init_reserve // å‡½æ•°board_init_f_init_reserveï¼Œåˆå§‹åŒ–ç»“æ„ä½“global_data mov x0, #0 bl board_init_f // common/board_f.c æ‰§è¡Œæ•°ç»„init_sequence_fä¸­çš„æ¯ä¸ªå‡½æ•° #if !defined(CONFIG_SPL_BUILD) /* * è®¾ç½®ä¸­é—´ç¯å¢ƒï¼ˆæ–°çš„æ ˆæŒ‡é’ˆå’Œgdï¼‰ï¼Œç„¶åè°ƒç”¨å‡½æ•° * relocate_code(addr_moni)ã€‚ * */ ldr x0, [x18, #GD_START_ADDR_SP] /* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-\u003estart_addr_sp */ bic sp, x0, #0xf /* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚ */ ldr x18, [x18, #GD_BD] /* æŠŠå¯„å­˜å™¨x18è®¾ç½®ä¸ºgd-\u003ebd */ sub x18, x18, #GD_SIZE /* æ–°çš„gdåœ¨bdçš„ä¸‹é¢ */ adr lr, relocation_return ldr x9, [x18, #GD_RELOC_OFF] /* æŠŠå¯„å­˜å™¨x9è®¾ç½®ä¸ºgd-\u003ereloc_off */ add lr, lr, x9 /* åœ¨é‡å®šä½åæ–°çš„è¿”å›åœ°å€ */ ldr x0, [x18, #GD_RELOCADDR] /* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-\u003erelocaddr */ b relocate_code relocation_return: /* * è®¾ç½®æœ€ç»ˆçš„å®Œæ•´ç¯å¢ƒ */ bl c_runtime_cpu_setup /* ä»ç„¶è°ƒç”¨æ—§çš„ä¾‹ç¨‹ æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€*/ #endif /* !CONFIG_SPL_BUILD */ #if defined(CONFIG_SPL_BUILD) bl spl_relocate_stack_gd /* å¯èƒ½è¿”å›ç©ºæŒ‡é’ˆ é‡æ–°å®šä½æ ˆ*/ /* * æ‰§è¡Œâ€œsp = (x0 != NULL) ? x0 : spâ€ï¼Œ * è§„é¿è¿™ä¸ªçº¦æŸï¼š * å¸¦æ¡ä»¶çš„movæŒ‡ä»¤ä¸èƒ½æŠŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•° */ mov x1, sp cmp x0, #0 csel x0, x0, x1, ne mov sp, x0 #endif /* * ç”¨0åˆå§‹åŒ–æœªåˆå§‹åŒ–æ•°æ®æ®µ */ ldr x0, =__bss_start /* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/ ldr x1, =__bss_end /* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/ clear_loop: str xzr, [x0], #8 cmp x0, x1 b.lo clear_loop /* è°ƒç”¨å‡½æ•°board_init_r(gd_t *id, ulong dest_addr) */ mov x0, x18 /* gd_t */ ldr x1, [x18, #GD_RELOCADDR] /* dest_addr */ b board_init_r /* ç›¸å¯¹ç¨‹åºè®¡æ•°å™¨çš„è·³è½¬ common/board_r.c æ‰§è¡Œæ•°ç»„init_sequence_rä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œæœ€åä¸€ä¸ªå‡½æ•°æ˜¯run_main_loop */ /* ä¸ä¼šè¿è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºå‡½æ•°board_init_r()ä¸ä¼šè¿”å›*/ ENDPROC(_main) 1.1.4 å‡½æ•°run_main_loop æ•°ç»„init_sequence_ræœ€åä¸€ä¸ªå‡½æ•°run_main_loopï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹ï¼›\nrun_main_loop main_loop bootdely_process # è¯»å–ç¯å¢ƒå˜é‡bootdelay(å»¶è¿Ÿæ—¶é—´)å’Œbootcmd(ç¯å¢ƒå˜é‡) autoboot_command abortboot # ç­‰å¾…ç”¨æˆ·æŒ‰é”® run_command_list # æœªç­‰å¾…åˆ°æŒ‰é”®ï¼Œè‡ªåŠ¨æ‰§è¡Œç¯å¢ƒå˜é‡bootcmd bootmå‘½ä»¤å¤„ç†å‡½æ•°do_bootm\ndo_bootm do_bootm_states bootm_start # åˆå§‹åŒ–å…¨å±€å˜é‡bootm_header_timages bootm_find_os # æŠŠå†…æ ¸é•œåƒä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜ bootm_find_other # ARM64 æ‰å¹³è®¾å¤‡æ ‘(Flattended Device Tree FDT)äºŒè¿›åˆ¶æ–‡ä»¶ bootm_load_os # è§£å‹ç—…åŠ è½½å†…æ ¸åˆ°æ­£ç¡®ä½ç½® bootm_os_get_boot_func # åœ¨æ“ä½œç³»ç»Ÿç±»å‹æ•°ç»„boot_osä¸­æŸ¥æ‰¾å¼•å¯¼å‡½æ•°ï¼Œlinuxå†…æ ¸å¼•å¯¼å‡½æ•°do_bootm_linux do_bootm_linux(flag=BOOTM_STATE_OS_PREP) # è°ƒç”¨boot_prep_linux boot_prep_linux # 1.åˆ†é…ä¸€å—å†…å­˜ï¼ŒæŠŠè®¾å¤‡æ•°äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ 2.ä¿®æ”¹æ‰å¹³è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ boot_selected_os # do_bootm_linux(flag=BOOTM_STATE_OS_GO) boot_jump_linux # è´Ÿè´£è·³è½¬åˆ°Linuxå†…æ ¸ boot_jum_linux do_nonsec_virt_switch smp_kick_all_cpus # CONFIG_GICV2æˆ–CONFIG_GICV3ï¼Œä¸­æ–­æ§åˆ¶å™¨ç‰ˆæœ¬2ï¼Œ3 dcache_disable # ç¦ç”¨å¤„ç†å™¨çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†å•å…ƒ # åœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ # å¼€å¯é…ç½®å® CONFIG_ARMV8_SWITCH_TO_EL1 armv8_switch_to_el2 switch_to_el1 armv8_switch_to_el1 å†…æ ¸å…¥å£ # åœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ armv8_switch_to_el2 å†…æ ¸å…¥å£ 1.2 å†…æ ¸åˆå§‹åŒ– å†…æ ¸åˆå§‹åŒ–åˆ†ä¸ºæ±‡ç¼–è¯­è¨€éƒ¨åˆ†å’ŒCè¯­è¨€éƒ¨åˆ†\n1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ† ARM64æ¶æ„å†…æ ¸å…¥å£_headï¼Œç›´æ¥è·³è½¬åˆ°æ ‡å·stext\n// linux-4.14.295/arch/arm64/kernel/head.S _head: #ifdef CONFIG_EFI // æä¾›UEFIè¿è¡Œæ—¶æ”¯æŒUEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æ˜¯ç»Ÿä¸€çš„å¯æ‰©å±•å›ºä»¶æ¥å£ï¼Œç”¨äºå–ä»£BIOS add x13, x18, #0x16 b stext #else b stext // è·³è½¬åˆ°å†…æ ¸èµ·å§‹ä½ç½® .long0 // ä¿ç•™ #endif stext\n// linux-4.14.295/arch/arm64/kernel/head.S ENTRY(stext) bl preserve_boot_args // æŠŠå¼•å¯¼ç¨‹åºä¼ é€’çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_argsä¸­ bl el2_setup // é™çº§åˆ°å¼‚å¸¸çº§åˆ«1, å¯„å­˜å™¨w0å­˜æ”¾cpu_boot_mode adrp x23, __PHYS_OFFSET and x23, x23, MIN_KIMG_ALIGN - 1 // KASLRåç§»ï¼Œé»˜è®¤å€¼æ˜¯0 bl set_cpu_boot_mode_flag // __boot_cpu_mode[2] æ•°ç»„ bl __create_page_tables // åˆ›å»ºé¡µè¡¨æ˜ å°„ /* * ä¸‹é¢è°ƒç”¨è®¾ç½®å¤„ç†å™¨çš„ä»£ç ï¼Œè¯·çœ‹æ–‡ä»¶â€œarch/arm64/mm/proc.Sâ€ * äº†è§£ç»†èŠ‚ã€‚ * è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å·²ç»ä¸ºå¼€å¯å†…å­˜ç®¡ç†å•å…ƒåšå¥½å‡†å¤‡ï¼Œ * è½¬æ¢æ§åˆ¶å¯„å­˜å™¨å·²ç»è®¾ç½®å¥½ã€‚ */ bl __cpu_setup // åˆå§‹åŒ–å¤„ç†å™¨ b __primary_switch // ä¸»å¤„ç†å™¨å¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿›å…¥Cè¯­è¨€éƒ¨åˆ†å…¥å£å‡½æ•°start_kernel ENDPROC(stext) å‡½æ•°el2_setup a.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯1ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ã€‚ b.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯2ï¼Œé‚£ä¹ˆæ ¹æ®å¤„ç†å™¨æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼ˆVirtualization Host Extensionsï¼ŒVHEï¼‰ï¼Œå†³å®šæ˜¯å¦éœ€è¦é™çº§åˆ°å¼‚å¸¸çº§åˆ«1ã€‚ 1ï¼‰å¦‚æœå¤„ç†å™¨æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ã€‚ \\\n2ï¼‰å¦‚æœå¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆé™çº§åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ \\\nåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼ŒKVMï¼‰ï¼ŒKVMçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œå› æ­¤è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚ å¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒKVMè™šæ‹Ÿæœºã€‚QEMUåˆ›å»ºä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå’ŒKVMçš„äº¤äº’è¿‡ç¨‹ \\\n// æ‰“å¼€KVMå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚ fd = open(\"/dev/kvm\", O_RDWR); // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ vmfd = ioctl(fd, KVM_CREATE_VM, 0); // KVMä¸ºæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªkvm_vcpuç»“æ„ä½“ï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿå¤„ç†å™¨çš„æ–‡ä»¶æè¿°ç¬¦ vcpu_fd = ioctl(vmfd, KVM_CREATE_VCPU, 0); ä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰QEMUè¿›ç¨‹è°ƒç”¨â€œioctl(vcpu_fd, KVM_RUN, 0)â€ï¼Œé™·å…¥åˆ°å†…æ ¸ã€‚ ï¼ˆ2ï¼‰KVMæ‰§è¡Œå‘½ä»¤KVM_RUNï¼Œä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚ ï¼ˆ3ï¼‰KVMé¦–å…ˆæŠŠè°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨ä¿å­˜åœ¨kvm_vcpuç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠæ‰€æœ‰å¯„å­˜å™¨è®¾ç½®ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿçš„å¯„å­˜å™¨å€¼ï¼Œæœ€åä»å¼‚å¸¸çº§åˆ«2è¿”å›åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚ ä¸ºäº†æé«˜åˆ‡æ¢é€Ÿåº¦ï¼ŒARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦å…ˆä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2 \\\nå‡½æ•°__create_page_tables 1ï¼‰åˆ›å»ºæ’ç­‰æ˜ å°„ï¼Œè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ 2ï¼‰ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ \\\næ˜ å°„ä»£ç èŠ‚.idmap.text,æ’ç­‰æ˜ å°„ä»£ç èŠ‚çš„èµ·å§‹åœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_startä¸­ï¼Œç»“æŸåœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_endä¸­ã€‚æ’ç­‰æ˜ å°„æ˜¯ä¸ºæ’ç­‰æ˜ å°„ä»£ç èŠ‚åˆ›å»ºçš„æ˜ å°„ï¼Œidmap_pg_diræ˜¯æ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•ï¼ˆå³ç¬¬ä¸€çº§é¡µè¡¨ï¼‰çš„èµ·å§‹åœ°å€ã€‚å†…æ ¸çš„é¡µè¡¨ä¸­ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ï¼Œå†…æ ¸é•œåƒçš„èµ·å§‹åœ°å€æ˜¯_textï¼Œç»“æŸåœ°å€æ˜¯_endï¼Œswapper_pg_diræ˜¯å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹åœ°å€\nå‡½æ•°__primary_switch 1ï¼‰__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ 2ï¼‰__primary_switched __enable_mmuæ‰§è¡Œæµç¨‹ 1ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨0(TTBR0_EL1)è®¾ç½®ä¸ºæ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€ 2ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨1(TTBR1_EL1)è®¾ç½®ä¸ºå†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€ 3ï¼‰è®¾ç½®ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR_EL1)ï¼Œå¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼ŒåMMUæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ __primary_switchæ‰§è¡Œæµç¨‹ 1ï¼‰æŠŠå½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨è®¾ç½®ä¸º0å·çº¿ç¨‹å†…æ ¸æ ˆçš„é¡¶éƒ¨(init_thread_union + THREAD_SIZE) 2ï¼‰æŠŠå¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨(SP_EL0)è®¾ç½®ä¸º0å·çº¿ç¨‹çš„ç»“æ„ä½“thread_infoçš„åœ°å€(init_task.thread_info) 3ï¼‰æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(VBAR_EL1)è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€(vectors) 4ï¼‰è®¡ç®—å†…æ ¸é•œåƒçš„èµ·å§‹è™šæ‹Ÿåœ°å€(kimage_vaddr)å’Œç‰©ç†åœ°å€çš„å·®å€¼ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡kimage_voffsetä¸­ 5ï¼‰ç”¨0åˆå§‹åŒ–å†…æ ¸çš„æœªåˆå§‹åŒ–æ•°æ®æ®µ 6ï¼‰è°ƒç”¨Cè¯­è¨€å‡½æ•°start_kernel \\\n1.2.2 Cè¯­è¨€éƒ¨åˆ† å†…æ ¸åˆå§‹åŒ–çš„Cè¯­è¨€éƒ¨åˆ†å…¥å£æ˜¯å‡½æ•°start_kernelï¼Œå‡½æ•°start_kernelé¦–å…ˆåˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼Œå³åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼Œç„¶åè°ƒç”¨å‡½æ•°rest_initã€‚å‡½æ•°rest_initçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰åˆ›å»º1å·çº¿ç¨‹ï¼Œå³initçº¿ç¨‹ï¼Œçº¿ç¨‹å‡½æ•°æ˜¯kernel_initã€‚ ï¼ˆ2ï¼‰åˆ›å»º2å·çº¿ç¨‹ï¼Œå³kthreaddçº¿ç¨‹ï¼Œè´Ÿè´£åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚ ï¼ˆ3ï¼‰0å·çº¿ç¨‹æœ€ç»ˆå˜æˆç©ºé—²çº¿ç¨‹ã€‚ \\\ninitçº¿ç¨‹ç»§ç»­åˆå§‹åŒ–ï¼Œæ‰§è¡Œçš„ä¸»è¦æ“ä½œå¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰smp_prepare_cpus()ï¼šåœ¨å¯åŠ¨ä»å¤„ç†å™¨ä»¥å‰æ‰§è¡Œå‡†å¤‡å·¥ä½œã€‚ ï¼ˆ2ï¼‰do_pre_smp_initcalls()ï¼šæ‰§è¡Œå¿…é¡»åœ¨åˆå§‹åŒ–SMPç³»ç»Ÿä»¥å‰æ‰§è¡Œçš„æ—©æœŸåˆå§‹åŒ–ï¼Œå³ä½¿ç”¨å®early_initcallæ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ã€‚ ï¼ˆ3ï¼‰smp_init()ï¼šåˆå§‹åŒ–SMPç³»ç»Ÿï¼Œå¯åŠ¨æ‰€æœ‰ä»å¤„ç†å™¨ã€‚ ï¼ˆ4ï¼‰do_initcalls()ï¼šæ‰§è¡Œçº§åˆ«0ï½7çš„åˆå§‹åŒ–ã€‚ ï¼ˆ5ï¼‰æ‰“å¼€æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶â€œ/dev/consoleâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2åˆ†åˆ«æ˜¯æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œéƒ½æ˜¯æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚ ï¼ˆ6ï¼‰prepare_namespace()ï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è£…è½½initç¨‹åºæ—¶éœ€è¦ä»å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¯»æ–‡ä»¶ã€‚ ï¼ˆ7ï¼‰free_initmem()ï¼šé‡Šæ”¾åˆå§‹åŒ–ä»£ç å’Œæ•°æ®å ç”¨çš„å†…å­˜ã€‚ ï¼ˆ8ï¼‰è£…è½½initç¨‹åºï¼ˆU-Bootç¨‹åºå¯ä»¥ä¼ é€’å†…æ ¸å‚æ•°â€œinit=â€ä»¥æŒ‡å®šinitç¨‹åºï¼‰ï¼Œä»å†…æ ¸çº¿ç¨‹è½¬æ¢æˆç”¨æˆ·ç©ºé—´çš„initè¿›ç¨‹ã€‚ \\\nçº§åˆ«0ï½7çš„åˆå§‹åŒ–ï¼Œæ˜¯æŒ‡ä½¿ç”¨ä»¥ä¸‹å®æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼š\n// include/linux/init.h #define pure_initcall(fn) __define_initcall(fn, 0) #define core_initcall(fn) __define_initcall(fn, 1) #define core_initcall_sync(fn) __define_initcall(fn, 1s) #define postcore_initcall(fn) __define_initcall(fn, 2) #define postcore_initcall_sync(fn) __define_initcall(fn, 2s) #define arch_initcall(fn) __define_initcall(fn, 3) #define arch_initcall_sync(fn) __define_initcall(fn, 3s) #define subsys_initcall(fn) __define_initcall(fn, 4) #define subsys_initcall_sync(fn) __define_initcall(fn, 4s) #define fs_initcall(fn) __define_initcall(fn, 5) #define fs_initcall_sync(fn) __define_initcall(fn, 5s) #define rootfs_initcall(fn) __define_initcall(fn, rootfs) #define device_initcall(fn) __define_initcall(fn, 6) #define device_initcall_sync(fn) __define_initcall(fn, 6s) #define late_initcall(fn) __define_initcall(fn, 7) #define late_initcall_sync(fn) __define_initcall(fn, 7s) 1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼ å¯¹ç§°å¤šå¤„ç†å™¨(Symmetirc Multi-Processor SMP) 3ç§å¼•å¯¼ä»å¤„ç†å™¨æ–¹æ³• \\\nè‡ªæ—‹è¡¨ ç”µæºçŠ¶æ€åè°ƒæ¥å£ ACPIåœè½¦åè®® 1.3 initè¿›ç¨‹ initè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç”¨æˆ·ç¨‹åºã€‚Linuxç³»ç»Ÿinitç¨‹åºæœ‰sysvinitã€busybox initã€upstartã€systemdå’Œprocdã€‚sysvinitæ˜¯Unixç³»ç»Ÿ5(System V)initç¨‹åºï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶/etc/initab\nç¬¬2ç«  è¿›ç¨‹ç®¡ç† 2.1 è¿›ç¨‹ Linuxå†…æ ¸æŠŠè¿›ç¨‹ç§°ä¸ºtaskï¼Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ è¿›ç¨‹æœ‰ä¸¤ç§ç‰¹æ®Šå½¢å¼ï¼šæ²¡æœ‰ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œå…±äº«ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚ task_structç»“æ„ä½“æ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸»è¦æˆå‘˜\nvolatile long state; // è¿›ç¨‹çŠ¶æ€ pid_t pid; // å…¨å±€è¿›ç¨‹å· struct pid_link pid[PIDTYPE_MAX]; // è¿›ç¨‹å·ï¼Œè¿›ç¨‹ç»„æ ‡è¯†ç¬¦å’Œä¼šè¯æ ‡è¯†ç¬¦ struct task_struct *group_leader; // æŒ‡å‘è¿›æ‘ç»„çš„ç»„é•¿ char comm[TASK_COMM_LEN]; // è¿›ç¨‹å cpumask_t cpus_allowed; // å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ struct fs_struct *fs; // æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼Œä¸»è¦æ˜¯è¿›ç¨‹çš„æ ¹ç›®å½•å’Œå½“å‰å·¥ä½œç›®å½• struct nsproxy *nsproxy; // å‘½åç©ºé—´ struct sysv_sem sysvsem; // UNIxç³»ç»Ÿ5ä¿¡å·é‡å’Œå…±äº«å†…å­˜ struct sysv_shm sysvshm; 2.2 å‘½åç©ºé—´ ",
  "wordCount" : "5193",
  "inLanguage": "en",
  "datePublished": "2022-10-05T00:17:58+08:00",
  "dateModified": "2022-10-05T00:17:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "Zain"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "zain's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://liuz0123.gitee.io/zain/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://liuz0123.gitee.io/zain/" accesskey="h" title="Zain&#39;s Blog (Alt + H)">
            <img src="https://liuz0123.gitee.io/zain/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Zain&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://liuz0123.gitee.io/zain/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/links" title="ğŸ¤ é—²è¨€ä¿—è¯­">
                <span>ğŸ¤ é—²è¨€ä¿—è¯­</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://liuz0123.gitee.io/zain/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
            <h1 class="post-title">
                Linuxå†…æ ¸æ·±åº¦è§£æ
            </h1>
            <div class="post-meta">Create:&nbsp;<span title='2022-10-05 00:17:58 +0800 CST'>2022-10-05</span>&nbsp;|&nbsp;Update:&nbsp;2022-10-05&nbsp;|&nbsp;Words:&nbsp;5193&nbsp;|&nbsp;&nbsp;11 min&nbsp;|&nbsp;
&nbsp;Zain



                &nbsp;|&nbsp;tags: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://liuz0123.gitee.io/zain/tags/tech/">tech</a>
                    <a href="https://liuz0123.gitee.io/zain/tags/linux/">ã€linux</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| Viewers: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%86%85%e5%ae%b9%e6%8f%90%e7%ba%b2" aria-label="å†…å®¹æçº²">å†…å®¹æçº²</a></li>
                <li>
                    <a href="#%e7%ac%ac1%e7%ab%a0-%e5%86%85%e6%a0%b8%e5%bc%95%e5%af%bc%e5%92%8c%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#11-%e5%bc%95%e5%af%bc%e7%a8%8b%e5%ba%8f" aria-label="1.1 å¼•å¯¼ç¨‹åº">1.1 å¼•å¯¼ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#111-%e5%85%a5%e5%8f%a3_start" aria-label="1.1.1 å…¥å£_start">1.1.1 å…¥å£_start</a></li>
                <li>
                    <a href="#112-reset" aria-label="1.1.2 reset">1.1.2 <code>reset</code></a></li>
                <li>
                    <a href="#113-%e5%87%bd%e6%95%b0_main" aria-label="1.1.3 å‡½æ•°_main">1.1.3 å‡½æ•°_main</a></li>
                <li>
                    <a href="#114-%e5%87%bd%e6%95%b0run_main_loop" aria-label="1.1.4 å‡½æ•°run_main_loop">1.1.4 å‡½æ•°run_main_loop</a></li></ul>
                </li>
                <li>
                    <a href="#12-%e5%86%85%e6%a0%b8%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="1.2 å†…æ ¸åˆå§‹åŒ–">1.2 å†…æ ¸åˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#121-%e6%b1%87%e7%bc%96%e8%af%ad%e8%a8%80%e9%83%a8%e5%88%86" aria-label="1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†</a></li>
                <li>
                    <a href="#122-c%e8%af%ad%e8%a8%80%e9%83%a8%e5%88%86" aria-label="1.2.2 Cè¯­è¨€éƒ¨åˆ†">1.2.2 Cè¯­è¨€éƒ¨åˆ†</a></li>
                <li>
                    <a href="#123-smp%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%95%e5%af%bc" aria-label="1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼">1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼</a></li></ul>
                </li>
                <li>
                    <a href="#13-init%e8%bf%9b%e7%a8%8b" aria-label="1.3 initè¿›ç¨‹">1.3 initè¿›ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac2%e7%ab%a0-%e8%bf%9b%e7%a8%8b%e7%ae%a1%e7%90%86" aria-label="ç¬¬2ç«  è¿›ç¨‹ç®¡ç†">ç¬¬2ç«  è¿›ç¨‹ç®¡ç†</a><ul>
                        
                <li>
                    <a href="#21-%e8%bf%9b%e7%a8%8b" aria-label="2.1 è¿›ç¨‹">2.1 è¿›ç¨‹</a></li>
                <li>
                    <a href="#22-%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4" aria-label="2.2 å‘½åç©ºé—´">2.2 å‘½åç©ºé—´</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="å†…å®¹æçº²">å†…å®¹æçº²<a hidden class="anchor" aria-hidden="true" href="#å†…å®¹æçº²">#</a></h1>
<ul>
<li>å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot</li>
<li>å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹</li>
<li>å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜</li>
<li>å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼</li>
<li>ä¿æŠ¤ä¸´ç•ŒåŒºçš„äº’æ–¥</li>
<li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</li>
</ul>
<h1 id="ç¬¬1ç« -å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1ç« -å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">#</a></h1>
<p>â€‚å¤„ç†å™¨ä¸Šç”µ-&gt;æ‰§è¡Œå¼•å¯¼ç¨‹åº-&gt;åŠ è½½å†…æ ¸åˆ°å†…å­˜-&gt;æ‰§è¡Œå†…æ ¸-&gt;å†…æ ¸åˆå§‹åŒ–-&gt;å¯åŠ¨ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹
â€ƒARM64å¤„ç†å™¨åˆ°ç‰©ç†åœ°å€0å–ç¬¬ä¸€æ¡æŒ‡ä»¤</p>
<h2 id="11-å¼•å¯¼ç¨‹åº">1.1 å¼•å¯¼ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#11-å¼•å¯¼ç¨‹åº">#</a></h2>
<h3 id="111-å…¥å£_start">1.1.1 å…¥å£_start<a hidden class="anchor" aria-hidden="true" href="#111-å…¥å£_start">#</a></h3>
<p>â€ƒARM64å¤„ç†å™¨U-Bootç¨‹åºæ‰§è¡Œè¿‡ç¨‹ï¼Œå…¥å£<a href="https://elixir.bootlin.com/u-boot/latest/source/arch/arm/cpu/armv8/start.S#L20"><code>u-boot/arch/arm/cpu/armv8/start.S</code></a>æ ‡è¯†<code>_start</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.globl	_start
</span></span><span style="display:flex;"><span>_start:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_LINUX_KERNEL_IMAGE_HEADER)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/boot0-linux-kernel-header.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/arch/boot0.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b	reset
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><h3 id="112-reset">1.1.2 <code>reset</code><a hidden class="anchor" aria-hidden="true" href="#112-reset">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>reset:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Allow the board to save important registers */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å…è®¸æ¿å¡ä¿å­˜é‡è¦çš„å¯„å­˜å™¨*/</span>
</span></span><span style="display:flex;"><span>	b	save_boot_params
</span></span><span style="display:flex;"><span>.globl	save_boot_params_ret
</span></span><span style="display:flex;"><span>save_boot_params_ret:
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SYS_RESET_SCTRL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl reset_sctrl   <span style="color:#75715e">// åˆå§‹åŒ–ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å¼‚å¸¸çº§åˆ«å¯èƒ½æ˜¯3ã€2æˆ–è€…1ï¼Œåˆå§‹çŠ¶æ€ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å°ç«¯å­—èŠ‚åºï¼Œç¦æ­¢MMUï¼Œç¦æ­¢æŒ‡ä»¤/æ•°æ®ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>    adr  x0, vectors
</span></span><span style="display:flex;"><span>    witch_el x1, <span style="color:#ae81ff">3f</span>, <span style="color:#ae81ff">2f</span>, <span style="color:#ae81ff">1f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>  msr  vbar_el3, x0    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«3ï¼Œå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL3è®¾ç½®ä½å¼‚å¸¸å‘é‡çš„èµ·å§‹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mrs  x0, scr_el3   <span style="color:#75715e">// è®¾ç½®å®‰å…¨é…ç½®å¯„å­˜å™¨SCR_EL3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    orr  x0, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>         <span style="color:#75715e">/* è®¾ç½®å¯„å­˜å™¨SCR_EL3çš„NSã€IRQã€FIQå’ŒEAå››ä¸ªä½ */</span>
</span></span><span style="display:flex;"><span>    msr  scr_el3, x0
</span></span><span style="display:flex;"><span>    msr  cptr_el3, xzr           <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef COUNTER_FREQUENCY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>COUNTER_FREQUENCY
</span></span><span style="display:flex;"><span>    msr  cntfrq_el0, x0          <span style="color:#75715e">/* åˆå§‹åŒ–å¯„å­˜å™¨CNTFRQ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    <span style="color:#ae81ff">0f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>  msr   vbar_el2, x0   <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x33ff</span>
</span></span><span style="display:flex;"><span>    msr  cptr_el2, x0            <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */</span>
</span></span><span style="display:flex;"><span>    b    <span style="color:#ae81ff">0f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>  msr    vbar_el1, x0
</span></span><span style="display:flex;"><span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    msr  cpacr_el1, x0           <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* åº”ç”¨ARMå¤„ç†å™¨ç‰¹å®šçš„å‹˜è¯¯è¡¨*/</span>
</span></span><span style="display:flex;"><span>bl   apply_core_errata
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* å¤„ç†å™¨ç‰¹å®šçš„åˆå§‹åŒ–*/</span>
</span></span><span style="display:flex;"><span>bl   lowlevel_init    <span style="color:#75715e">// æ‰§è¡Œboard_init_f()æ‰€éœ€æœ€å°åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_ARMV8_SPIN_TABLE) &amp;&amp; !defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    branch_if_master x0, x1, master_cpu
</span></span><span style="display:flex;"><span>    b    spin_table_secondary_jump    <span style="color:#75715e">// arch/arm/cpu/armv8/spin_tabli.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">/* ç»å¯¹ä¸ä¼šè¿”å›*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(CONFIG_ARMV8_MULTIENTRY)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>branch_if_master x0, x1, master_cpu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* ä»å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>slave_cpu:
</span></span><span style="display:flex;"><span>    wfe
</span></span><span style="display:flex;"><span>    ldr  x1, <span style="color:#f92672">=</span>CPU_RELEASE_ADDR  <span style="color:#75715e">// ä»å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œå®ƒè¢«å”¤é†’çš„æ—¶å€™ï¼Œä»åœ°å€CPU_RELEASE_ADDRè¯»å–å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, [x1]
</span></span><span style="display:flex;"><span>    cbz  x0, slave_cpu
</span></span><span style="display:flex;"><span>    br   x0               <span style="color:#75715e">/* è·³è½¬åˆ°æŒ‡å®šåœ°å€*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_ARMV8_MULTIENTRY */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>master_cpu:
</span></span><span style="display:flex;"><span>    bl   _main  <span style="color:#75715e">// ä¸»å¤„ç†å™¨æ‰§è¡Œå‡½æ•°
</span></span></span></code></pre></div><p>â€ƒU-Bootåˆ†ä¸ºSPLå’Œæ­£å¸¸çš„U-Bootç¨‹åºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦ç¼–è¯‘ä¸ºSPLï¼Œéœ€è¦å¼€å¯é…ç½®å®CONFIG_SPL_BUILDã€‚SPLæ˜¯â€œSecondary Program Loaderâ€çš„ç®€ç§°ï¼Œå³ç¬¬äºŒé˜¶æ®µç¨‹åºåŠ è½½å™¨ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯ç›¸å¯¹äºå¤„ç†å™¨é‡Œé¢çš„åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åºæ¥è¯´çš„ï¼Œå¤„ç†å™¨å¯åŠ¨æ—¶æœ€å…ˆæ‰§è¡Œçš„æ˜¯åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åº</p>
<h3 id="113-å‡½æ•°_main">1.1.3 å‡½æ•°_main<a hidden class="anchor" aria-hidden="true" href="#113-å‡½æ•°_main">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm/lib/crt0_64.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ENTRY(_main)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * è®¾ç½®åˆå§‹çš„Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”è°ƒç”¨board_init_f(0)ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>(CONFIG_SPL_STACK)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>(CONFIG_SYS_INIT_SP_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bic  sp, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>    <span style="color:#75715e">/* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚*/</span>
</span></span><span style="display:flex;"><span>    mov  x0, sp
</span></span><span style="display:flex;"><span>    bl   board_init_f_alloc_reserve <span style="color:#75715e">// åœ¨æ ˆçš„é¡¶éƒ¨ä¸ºç»“æ„ä½“global_dataåˆ†é…ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  sp, x0
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è®¾ç½®gd */</span>
</span></span><span style="display:flex;"><span>    mov  x18, x0
</span></span><span style="display:flex;"><span>    bl   board_init_f_init_reserve  <span style="color:#75715e">// å‡½æ•°board_init_f_init_reserveï¼Œåˆå§‹åŒ–ç»“æ„ä½“global_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    bl   board_init_f  <span style="color:#75715e">// common/board_f.c   æ‰§è¡Œæ•°ç»„init_sequence_fä¸­çš„æ¯ä¸ªå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if !defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * è®¾ç½®ä¸­é—´ç¯å¢ƒï¼ˆæ–°çš„æ ˆæŒ‡é’ˆå’Œgdï¼‰ï¼Œç„¶åè°ƒç”¨å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * relocate_code(addr_moni)ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>    ldr  x0, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_START_ADDR_SP]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-&gt;start_addr_sp */</span>
</span></span><span style="display:flex;"><span>    bic  sp, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>             <span style="color:#75715e">/* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚ */</span>
</span></span><span style="display:flex;"><span>    ldr  x18, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_BD]       <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x18è®¾ç½®ä¸ºgd-&gt;bd */</span>
</span></span><span style="display:flex;"><span>    sub  x18, x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_SIZE       <span style="color:#75715e">/* æ–°çš„gdåœ¨bdçš„ä¸‹é¢ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    adr  lr, relocation_return
</span></span><span style="display:flex;"><span>    ldr  x9, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOC_OFF]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x9è®¾ç½®ä¸ºgd-&gt;reloc_off */</span>
</span></span><span style="display:flex;"><span>    add  lr, lr, x9    <span style="color:#75715e">/* åœ¨é‡å®šä½åæ–°çš„è¿”å›åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    ldr  x0, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOCADDR]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-&gt;relocaddr */</span>
</span></span><span style="display:flex;"><span>    b    relocate_code
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>relocation_return:
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * è®¾ç½®æœ€ç»ˆçš„å®Œæ•´ç¯å¢ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>    bl   c_runtime_cpu_setup      <span style="color:#75715e">/* ä»ç„¶è°ƒç”¨æ—§çš„ä¾‹ç¨‹ æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* !CONFIG_SPL_BUILD */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   spl_relocate_stack_gd    <span style="color:#75715e">/* å¯èƒ½è¿”å›ç©ºæŒ‡é’ˆ é‡æ–°å®šä½æ ˆ*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * æ‰§è¡Œâ€œsp = (x0 != NULL) ? x0 : spâ€ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è§„é¿è¿™ä¸ªçº¦æŸï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * å¸¦æ¡ä»¶çš„movæŒ‡ä»¤ä¸èƒ½æŠŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    mov  x1, sp
</span></span><span style="display:flex;"><span>    cmp  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    csel x0, x0, x1, ne
</span></span><span style="display:flex;"><span>    mov  sp, x0
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * ç”¨0åˆå§‹åŒ–æœªåˆå§‹åŒ–æ•°æ®æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>    ldr  x0, <span style="color:#f92672">=</span>__bss_start      <span style="color:#75715e">/* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/</span>
</span></span><span style="display:flex;"><span>    ldr  x1, <span style="color:#f92672">=</span>__bss_end        <span style="color:#75715e">/* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/</span>
</span></span><span style="display:flex;"><span>clear_loop:
</span></span><span style="display:flex;"><span>    str  xzr, [x0], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    cmp  x0, x1
</span></span><span style="display:flex;"><span>    b.lo clear_loop
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è°ƒç”¨å‡½æ•°board_init_r(gd_t *id, ulong dest_addr) */</span>
</span></span><span style="display:flex;"><span>    mov  x0, x18                     <span style="color:#75715e">/* gd_t */</span>
</span></span><span style="display:flex;"><span>    ldr  x1, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOCADDR]    <span style="color:#75715e">/* dest_addr */</span>
</span></span><span style="display:flex;"><span>    b    board_init_r                <span style="color:#75715e">/* ç›¸å¯¹ç¨‹åºè®¡æ•°å™¨çš„è·³è½¬ common/board_r.c æ‰§è¡Œæ•°ç»„init_sequence_rä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œæœ€åä¸€ä¸ªå‡½æ•°æ˜¯run_main_loop */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* ä¸ä¼šè¿è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºå‡½æ•°board_init_r()ä¸ä¼šè¿”å›*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ENDPROC(_main)
</span></span></code></pre></div><h3 id="114-å‡½æ•°run_main_loop">1.1.4 å‡½æ•°run_main_loop<a hidden class="anchor" aria-hidden="true" href="#114-å‡½æ•°run_main_loop">#</a></h3>
<p>â€ƒæ•°ç»„<code>init_sequence_r</code>æœ€åä¸€ä¸ªå‡½æ•°<code>run_main_loop</code>ï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹ï¼›</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>run_main_loop
</span></span><span style="display:flex;"><span>    main_loop
</span></span><span style="display:flex;"><span>        bootdely_process <span style="color:#75715e"># è¯»å–ç¯å¢ƒå˜é‡bootdelay(å»¶è¿Ÿæ—¶é—´)å’Œbootcmd(ç¯å¢ƒå˜é‡)</span>
</span></span><span style="display:flex;"><span>        autoboot_command
</span></span><span style="display:flex;"><span>            abortboot    <span style="color:#75715e"># ç­‰å¾…ç”¨æˆ·æŒ‰é”®</span>
</span></span><span style="display:flex;"><span>            run_command_list  <span style="color:#75715e"># æœªç­‰å¾…åˆ°æŒ‰é”®ï¼Œè‡ªåŠ¨æ‰§è¡Œç¯å¢ƒå˜é‡bootcmd</span>
</span></span></code></pre></div><p>â€ƒ<code>bootm</code>å‘½ä»¤å¤„ç†å‡½æ•°<code>do_bootm</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>do_bootm
</span></span><span style="display:flex;"><span>    do_bootm_states
</span></span><span style="display:flex;"><span>        bootm_start   <span style="color:#75715e"># åˆå§‹åŒ–å…¨å±€å˜é‡bootm_header_timages</span>
</span></span><span style="display:flex;"><span>        bootm_find_os    <span style="color:#75715e"># æŠŠå†…æ ¸é•œåƒä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜</span>
</span></span><span style="display:flex;"><span>        bootm_find_other    <span style="color:#75715e"># ARM64 æ‰å¹³è®¾å¤‡æ ‘(Flattended Device Tree FDT)äºŒè¿›åˆ¶æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        bootm_load_os  <span style="color:#75715e"># è§£å‹ç—…åŠ è½½å†…æ ¸åˆ°æ­£ç¡®ä½ç½®</span>
</span></span><span style="display:flex;"><span>        bootm_os_get_boot_func  <span style="color:#75715e"># åœ¨æ“ä½œç³»ç»Ÿç±»å‹æ•°ç»„boot_osä¸­æŸ¥æ‰¾å¼•å¯¼å‡½æ•°ï¼Œlinuxå†…æ ¸å¼•å¯¼å‡½æ•°do_bootm_linux</span>
</span></span><span style="display:flex;"><span>        do_bootm_linux<span style="color:#f92672">(</span>flag<span style="color:#f92672">=</span>BOOTM_STATE_OS_PREP<span style="color:#f92672">)</span>  <span style="color:#75715e"># è°ƒç”¨boot_prep_linux</span>
</span></span><span style="display:flex;"><span>            boot_prep_linux  <span style="color:#75715e"># 1.åˆ†é…ä¸€å—å†…å­˜ï¼ŒæŠŠè®¾å¤‡æ•°äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ 2.ä¿®æ”¹æ‰å¹³è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        boot_selected_os  <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>            do_bootm_linux<span style="color:#f92672">(</span>flag<span style="color:#f92672">=</span>BOOTM_STATE_OS_GO<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                boot_jump_linux  <span style="color:#75715e"># è´Ÿè´£è·³è½¬åˆ°Linuxå†…æ ¸</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>boot_jum_linux
</span></span><span style="display:flex;"><span>    do_nonsec_virt_switch
</span></span><span style="display:flex;"><span>        smp_kick_all_cpus  <span style="color:#75715e"># CONFIG_GICV2æˆ–CONFIG_GICV3ï¼Œä¸­æ–­æ§åˆ¶å™¨ç‰ˆæœ¬2ï¼Œ3</span>
</span></span><span style="display:flex;"><span>        dcache_disable  <span style="color:#75715e"># ç¦ç”¨å¤„ç†å™¨çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†å•å…ƒ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ # å¼€å¯é…ç½®å® CONFIG_ARMV8_SWITCH_TO_EL1</span>
</span></span><span style="display:flex;"><span>    armv8_switch_to_el2
</span></span><span style="display:flex;"><span>        switch_to_el1
</span></span><span style="display:flex;"><span>            armv8_switch_to_el1
</span></span><span style="display:flex;"><span>                å†…æ ¸å…¥å£
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸</span>
</span></span><span style="display:flex;"><span>    armv8_switch_to_el2
</span></span><span style="display:flex;"><span>        å†…æ ¸å…¥å£
</span></span></code></pre></div><h2 id="12-å†…æ ¸åˆå§‹åŒ–">1.2 å†…æ ¸åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#12-å†…æ ¸åˆå§‹åŒ–">#</a></h2>
<p>â€ƒå†…æ ¸åˆå§‹åŒ–åˆ†ä¸ºæ±‡ç¼–è¯­è¨€éƒ¨åˆ†å’ŒCè¯­è¨€éƒ¨åˆ†</p>
<h3 id="121-æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#121-æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">#</a></h3>
<p>â€ƒARM64æ¶æ„å†…æ ¸å…¥å£<code>_head</code>ï¼Œç›´æ¥è·³è½¬åˆ°æ ‡å·<code>stext</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>_head:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_EFI   </span><span style="color:#75715e">// æä¾›UEFIè¿è¡Œæ—¶æ”¯æŒUEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æ˜¯ç»Ÿä¸€çš„å¯æ‰©å±•å›ºä»¶æ¥å£ï¼Œç”¨äºå–ä»£BIOS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    add  x13, x18, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x16</span>
</span></span><span style="display:flex;"><span>    b    stext
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    stext       <span style="color:#75715e">// è·³è½¬åˆ°å†…æ ¸èµ·å§‹ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .long0           <span style="color:#75715e">// ä¿ç•™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>â€‚<code>stext</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ENTRY(stext)
</span></span><span style="display:flex;"><span>    bl   preserve_boot_args  <span style="color:#75715e">// æŠŠå¼•å¯¼ç¨‹åºä¼ é€’çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_argsä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   el2_setup        <span style="color:#75715e">// é™çº§åˆ°å¼‚å¸¸çº§åˆ«1, å¯„å­˜å™¨w0å­˜æ”¾cpu_boot_mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    adrp x23, __PHYS_OFFSET
</span></span><span style="display:flex;"><span>    and  x23, x23, MIN_KIMG_ALIGN <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e">// KASLRåç§»ï¼Œé»˜è®¤å€¼æ˜¯0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   set_cpu_boot_mode_flag  <span style="color:#75715e">// __boot_cpu_mode[2] æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   __create_page_tables  <span style="color:#75715e">// åˆ›å»ºé¡µè¡¨æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * ä¸‹é¢è°ƒç”¨è®¾ç½®å¤„ç†å™¨çš„ä»£ç ï¼Œè¯·çœ‹æ–‡ä»¶â€œarch/arm64/mm/proc.Sâ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * äº†è§£ç»†èŠ‚ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å·²ç»ä¸ºå¼€å¯å†…å­˜ç®¡ç†å•å…ƒåšå¥½å‡†å¤‡ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è½¬æ¢æ§åˆ¶å¯„å­˜å™¨å·²ç»è®¾ç½®å¥½ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    bl    __cpu_setup        <span style="color:#75715e">// åˆå§‹åŒ–å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    __primary_switch  <span style="color:#75715e">// ä¸»å¤„ç†å™¨å¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿›å…¥Cè¯­è¨€éƒ¨åˆ†å…¥å£å‡½æ•°start_kernel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ENDPROC(stext)
</span></span></code></pre></div><ol>
<li>å‡½æ•°el2_setup</li>
</ol>
<blockquote>
<p>a.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯1ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ã€‚   <br>
b.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯2ï¼Œé‚£ä¹ˆæ ¹æ®å¤„ç†å™¨æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼ˆVirtualization Host Extensionsï¼ŒVHEï¼‰ï¼Œå†³å®šæ˜¯å¦éœ€è¦é™çº§åˆ°å¼‚å¸¸çº§åˆ«1ã€‚    <br>
1ï¼‰å¦‚æœå¤„ç†å™¨æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ã€‚    \<br>
2ï¼‰å¦‚æœå¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆé™çº§åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸      \</p>
</blockquote>
<p>â€ƒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼ŒKVMï¼‰ï¼ŒKVMçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œå› æ­¤è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚       <br>
â€ƒå¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒKVMè™šæ‹Ÿæœºã€‚QEMUåˆ›å»ºä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå’ŒKVMçš„äº¤äº’è¿‡ç¨‹           \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ‰“å¼€KVMå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/kvm&#34;</span>, O_RDWR);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vmfd <span style="color:#f92672">=</span> ioctl(fd, KVM_CREATE_VM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// KVMä¸ºæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªkvm_vcpuç»“æ„ä½“ï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿå¤„ç†å™¨çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vcpu_fd <span style="color:#f92672">=</span> ioctl(vmfd, KVM_CREATE_VCPU, <span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>â€ƒä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹å¦‚ä¸‹ã€‚      <br>
â€ƒï¼ˆ1ï¼‰QEMUè¿›ç¨‹è°ƒç”¨â€œioctl(vcpu_fd, KVM_RUN, 0)â€ï¼Œé™·å…¥åˆ°å†…æ ¸ã€‚     <br>
â€ƒï¼ˆ2ï¼‰KVMæ‰§è¡Œå‘½ä»¤KVM_RUNï¼Œä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚           <br>
â€ƒï¼ˆ3ï¼‰KVMé¦–å…ˆæŠŠè°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨ä¿å­˜åœ¨kvm_vcpuç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠæ‰€æœ‰å¯„å­˜å™¨è®¾ç½®ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿçš„å¯„å­˜å™¨å€¼ï¼Œæœ€åä»å¼‚å¸¸çº§åˆ«2è¿”å›åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚           <br>
â€ƒä¸ºäº†æé«˜åˆ‡æ¢é€Ÿåº¦ï¼ŒARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦å…ˆä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2      \</p>
<br>
<ol start="2">
<li>å‡½æ•°__create_page_tables</li>
</ol>
<blockquote>
<p>1ï¼‰åˆ›å»ºæ’ç­‰æ˜ å°„ï¼Œè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€<code>__enable_mmu</code>å¼€å¯å†…å­˜ç®¡ç†å•å…ƒ        <br>
2ï¼‰ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„             \</p>
</blockquote>
<p>â€ƒæ˜ å°„ä»£ç èŠ‚<code>.idmap.text</code>,æ’ç­‰æ˜ å°„ä»£ç èŠ‚çš„èµ·å§‹åœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_startä¸­ï¼Œç»“æŸåœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_endä¸­ã€‚æ’ç­‰æ˜ å°„æ˜¯ä¸ºæ’ç­‰æ˜ å°„ä»£ç èŠ‚åˆ›å»ºçš„æ˜ å°„ï¼Œidmap_pg_diræ˜¯æ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•ï¼ˆå³ç¬¬ä¸€çº§é¡µè¡¨ï¼‰çš„èµ·å§‹åœ°å€ã€‚å†…æ ¸çš„é¡µè¡¨ä¸­ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ï¼Œå†…æ ¸é•œåƒçš„èµ·å§‹åœ°å€æ˜¯_textï¼Œç»“æŸåœ°å€æ˜¯_endï¼Œswapper_pg_diræ˜¯å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹åœ°å€</p>
<br>
<ol start="3">
<li>å‡½æ•°__primary_switch</li>
</ol>
<blockquote>
<p>1ï¼‰__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ            <br>
2ï¼‰__primary_switched   <br>
â€‚__enable_mmuæ‰§è¡Œæµç¨‹  <br>
â€ƒ1ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨0(TTBR0_EL1)è®¾ç½®ä¸ºæ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€     <br>
â€ƒ2ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨1(TTBR1_EL1)è®¾ç½®ä¸ºå†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€        <br>
â€ƒ3ï¼‰è®¾ç½®ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR_EL1)ï¼Œå¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼ŒåMMUæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€    <br>
â€‚__primary_switchæ‰§è¡Œæµç¨‹      <br>
â€ƒ1ï¼‰æŠŠå½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨è®¾ç½®ä¸º0å·çº¿ç¨‹å†…æ ¸æ ˆçš„é¡¶éƒ¨(init_thread_union + THREAD_SIZE)           <br>
â€ƒ2ï¼‰æŠŠå¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨(SP_EL0)è®¾ç½®ä¸º0å·çº¿ç¨‹çš„ç»“æ„ä½“<code>thread_info</code>çš„åœ°å€(init_task.thread_info)        <br>
â€ƒ3ï¼‰æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(VBAR_EL1)è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€(vectors)     <br>
â€ƒ4ï¼‰è®¡ç®—å†…æ ¸é•œåƒçš„èµ·å§‹è™šæ‹Ÿåœ°å€(kimage_vaddr)å’Œç‰©ç†åœ°å€çš„å·®å€¼ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡kimage_voffsetä¸­     <br>
â€ƒ5ï¼‰ç”¨0åˆå§‹åŒ–å†…æ ¸çš„æœªåˆå§‹åŒ–æ•°æ®æ®µ      <br>
â€ƒ6ï¼‰è°ƒç”¨Cè¯­è¨€å‡½æ•°<code>start_kernel</code>      \</p>
</blockquote>
<br>
<h3 id="122-cè¯­è¨€éƒ¨åˆ†">1.2.2 Cè¯­è¨€éƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#122-cè¯­è¨€éƒ¨åˆ†">#</a></h3>
<p>â€ƒå†…æ ¸åˆå§‹åŒ–çš„Cè¯­è¨€éƒ¨åˆ†å…¥å£æ˜¯å‡½æ•°<code>start_kernel</code>ï¼Œå‡½æ•°start_kernelé¦–å…ˆåˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼Œå³åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼Œç„¶åè°ƒç”¨å‡½æ•°<code>rest_init</code>ã€‚å‡½æ•°rest_initçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚   <br>
â€‚ï¼ˆ1ï¼‰åˆ›å»º1å·çº¿ç¨‹ï¼Œå³initçº¿ç¨‹ï¼Œçº¿ç¨‹å‡½æ•°æ˜¯kernel_initã€‚     <br>
â€‚ï¼ˆ2ï¼‰åˆ›å»º2å·çº¿ç¨‹ï¼Œå³kthreaddçº¿ç¨‹ï¼Œè´Ÿè´£åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚     <br>
â€‚ï¼ˆ3ï¼‰0å·çº¿ç¨‹æœ€ç»ˆå˜æˆç©ºé—²çº¿ç¨‹ã€‚    \</p>
<p>initçº¿ç¨‹ç»§ç»­åˆå§‹åŒ–ï¼Œæ‰§è¡Œçš„ä¸»è¦æ“ä½œå¦‚ä¸‹ã€‚    <br>
â€‚ï¼ˆ1ï¼‰smp_prepare_cpus()ï¼šåœ¨å¯åŠ¨ä»å¤„ç†å™¨ä»¥å‰æ‰§è¡Œå‡†å¤‡å·¥ä½œã€‚   <br>
â€‚ï¼ˆ2ï¼‰do_pre_smp_initcalls()ï¼šæ‰§è¡Œå¿…é¡»åœ¨åˆå§‹åŒ–SMPç³»ç»Ÿä»¥å‰æ‰§è¡Œçš„æ—©æœŸåˆå§‹åŒ–ï¼Œå³ä½¿ç”¨å®early_initcallæ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ã€‚   <br>
â€‚ï¼ˆ3ï¼‰smp_init()ï¼šåˆå§‹åŒ–SMPç³»ç»Ÿï¼Œå¯åŠ¨æ‰€æœ‰ä»å¤„ç†å™¨ã€‚   <br>
â€‚ï¼ˆ4ï¼‰do_initcalls()ï¼šæ‰§è¡Œçº§åˆ«0ï½7çš„åˆå§‹åŒ–ã€‚ <br>
â€‚ï¼ˆ5ï¼‰æ‰“å¼€æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶â€œ/dev/consoleâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2åˆ†åˆ«æ˜¯æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œéƒ½æ˜¯æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚   <br>
â€ƒï¼ˆ6ï¼‰prepare_namespace()ï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è£…è½½initç¨‹åºæ—¶éœ€è¦ä»å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¯»æ–‡ä»¶ã€‚   <br>
â€ƒï¼ˆ7ï¼‰free_initmem()ï¼šé‡Šæ”¾åˆå§‹åŒ–ä»£ç å’Œæ•°æ®å ç”¨çš„å†…å­˜ã€‚   <br>
â€ƒï¼ˆ8ï¼‰è£…è½½initç¨‹åºï¼ˆU-Bootç¨‹åºå¯ä»¥ä¼ é€’å†…æ ¸å‚æ•°â€œinit=â€ä»¥æŒ‡å®šinitç¨‹åºï¼‰ï¼Œä»å†…æ ¸çº¿ç¨‹è½¬æ¢æˆç”¨æˆ·ç©ºé—´çš„initè¿›ç¨‹ã€‚  \</p>
<p>â€‚çº§åˆ«0ï½7çš„åˆå§‹åŒ–ï¼Œæ˜¯æŒ‡ä½¿ç”¨ä»¥ä¸‹å®æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/init.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define pure_initcall(fn)           __define_initcall(fn, 0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define core_initcall(fn)           __define_initcall(fn, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define core_initcall_sync(fn)      __define_initcall(fn, 1s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define postcore_initcall(fn)       __define_initcall(fn, 2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define postcore_initcall_sync(fn)  __define_initcall(fn, 2s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_initcall(fn)           __define_initcall(fn, 3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_initcall_sync(fn)      __define_initcall(fn, 3s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define subsys_initcall(fn)         __define_initcall(fn, 4)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define subsys_initcall_sync(fn)    __define_initcall(fn, 4s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define fs_initcall(fn)             __define_initcall(fn, 5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define fs_initcall_sync(fn)        __define_initcall(fn, 5s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define rootfs_initcall(fn)         __define_initcall(fn, rootfs)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define device_initcall(fn)         __define_initcall(fn, 6)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define device_initcall_sync(fn)    __define_initcall(fn, 6s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define late_initcall(fn)           __define_initcall(fn, 7)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define late_initcall_sync(fn)      __define_initcall(fn, 7s)
</span></span></span></code></pre></div><h3 id="123-smpç³»ç»Ÿçš„å¼•å¯¼">1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼<a hidden class="anchor" aria-hidden="true" href="#123-smpç³»ç»Ÿçš„å¼•å¯¼">#</a></h3>
<p>â€‚å¯¹ç§°å¤šå¤„ç†å™¨(Symmetirc Multi-Processor SMP)       <br>
â€ƒ3ç§å¼•å¯¼ä»å¤„ç†å™¨æ–¹æ³•      \</p>
<ul>
<li>è‡ªæ—‹è¡¨</li>
<li>ç”µæºçŠ¶æ€åè°ƒæ¥å£</li>
<li>ACPIåœè½¦åè®®</li>
</ul>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/ARM64_SMP_spin_table.png" alt="ARM64æ¶æ„ä¸‹SMPç³»ç»Ÿçš„è‡ªæ—‹è¡¨å¼•å¯¼è¿‡ç¨‹"  />
</p>
<h2 id="13-initè¿›ç¨‹">1.3 initè¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#13-initè¿›ç¨‹">#</a></h2>
<p>â€ƒinitè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç”¨æˆ·ç¨‹åºã€‚Linuxç³»ç»Ÿinitç¨‹åºæœ‰<code>sysvinit</code>ã€busybox initã€upstartã€<code>systemd</code>å’Œprocdã€‚sysvinitæ˜¯Unixç³»ç»Ÿ5(System V)initç¨‹åºï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶<code>/etc/initab</code></p>
<br>
<h1 id="ç¬¬2ç« -è¿›ç¨‹ç®¡ç†">ç¬¬2ç«  è¿›ç¨‹ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2ç« -è¿›ç¨‹ç®¡ç†">#</a></h1>
<h2 id="21-è¿›ç¨‹">2.1 è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#21-è¿›ç¨‹">#</a></h2>
<p>â€ƒLinuxå†…æ ¸æŠŠè¿›ç¨‹ç§°ä¸ºtaskï¼Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´       <br>
â€ƒè¿›ç¨‹æœ‰ä¸¤ç§ç‰¹æ®Šå½¢å¼ï¼šæ²¡æœ‰ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œå…±äº«ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚     <br>
â€ƒtask_structç»“æ„ä½“æ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸»è¦æˆå‘˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> state;    <span style="color:#75715e">// è¿›ç¨‹çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pid_t pid;              <span style="color:#75715e">// å…¨å±€è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> pid_link pid[PIDTYPE_MAX];   <span style="color:#75715e">// è¿›ç¨‹å·ï¼Œè¿›ç¨‹ç»„æ ‡è¯†ç¬¦å’Œä¼šè¯æ ‡è¯†ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>group_leader;   <span style="color:#75715e">// æŒ‡å‘è¿›æ‘ç»„çš„ç»„é•¿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> comm[TASK_COMM_LEN];           <span style="color:#75715e">// è¿›ç¨‹å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>cpumask_t cpus_allowed;             <span style="color:#75715e">// å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> fs_struct <span style="color:#f92672">*</span>fs;               <span style="color:#75715e">// æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ï¼Œä¸»è¦æ˜¯è¿›ç¨‹çš„æ ¹ç›®å½•å’Œå½“å‰å·¥ä½œç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>nsproxy;            <span style="color:#75715e">// å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sysv_sem sysvsem;            <span style="color:#75715e">// UNIxç³»ç»Ÿ5ä¿¡å·é‡å’Œå…±äº«å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sysv_shm sysvshm;
</span></span></code></pre></div><h2 id="22-å‘½åç©ºé—´">2.2 å‘½åç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#22-å‘½åç©ºé—´">#</a></h2>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://liuz0123.gitee.io/zain/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://liuz0123.gitee.io/zain/img/alipay.jpg" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://liuz0123.gitee.io/zain/posts/na/%E9%81%93%E6%AD%89/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>è¯·æ±‚å¨œçš„åŸè°…</span>
  </a>
  <a class="next" href="https://liuz0123.gitee.io/zain/posts/blog/git/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>git</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://twikoo.js.org/quick-start.html#%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou', 
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://liuz0123.gitee.io/zain/" style="color:#939393;">zain&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·ç”³è¯·ä¸­</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="å¡«è‡ªå·±çš„å…¬å®‰å›¾æ ‡é“¾æ¥" style="float:left;margin: 0px 5px 0px 0px;"/>
             å…¬ç½‘å®‰å¤‡
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
