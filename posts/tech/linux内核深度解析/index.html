<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Linuxå†…æ ¸æ·±åº¦è§£æ | zain&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº">
<meta name="author" content="
&nbsp;Zain">
<link rel="canonical" href="https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">
<link crossorigin="anonymous" href="/zain/assets/css/stylesheet.6bbe4903eaf247f5c3db656a51fd7b09d982ab42029edfdc123f359e2748dc03.css" integrity="sha256-a75JA&#43;ryR/XD22VqUf17CdmCq0ICnt/cEj81nidI3AM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/zain/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="apple-touch-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="mask-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Linuxå†…æ ¸æ·±åº¦è§£æ" />
<meta property="og:description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-05T00:17:58&#43;08:00" />
<meta property="article:modified_time" content="2022-10-05T00:17:58&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linuxå†…æ ¸æ·±åº¦è§£æ"/>
<meta name="twitter:description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://liuz0123.gitee.io/zain/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Linuxå†…æ ¸æ·±åº¦è§£æ",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Linuxå†…æ ¸æ·±åº¦è§£æ",
  "name": "Linuxå†…æ ¸æ·±åº¦è§£æ",
  "description": "å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº",
  "keywords": [
    ""
  ],
  "articleBody": "å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒºçš„äº’æ–¥ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ– å¤„ç†å™¨ä¸Šç”µ-\u003eæ‰§è¡Œå¼•å¯¼ç¨‹åº-\u003eåŠ è½½å†…æ ¸åˆ°å†…å­˜-\u003eæ‰§è¡Œå†…æ ¸-\u003eå†…æ ¸åˆå§‹åŒ–-\u003eå¯åŠ¨ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ ARM64å¤„ç†å™¨åˆ°ç‰©ç†åœ°å€0å–ç¬¬ä¸€æ¡æŒ‡ä»¤\n1.1 å¼•å¯¼ç¨‹åº 1.1.1 å…¥å£_start ARM64å¤„ç†å™¨U-Bootç¨‹åºæ‰§è¡Œè¿‡ç¨‹ï¼Œå…¥å£u-boot/arch/arm/cpu/armv8/start.Sæ ‡è¯†_start\n.globl\t_start _start: #if defined(CONFIG_LINUX_KERNEL_IMAGE_HEADER) #include #elif defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK) #include #else b\treset #endif 1.1.2 reset reset: /* Allow the board to save important registers */ /* å…è®¸æ¿å¡ä¿å­˜é‡è¦çš„å¯„å­˜å™¨*/ b\tsave_boot_params .globl\tsave_boot_params_ret save_boot_params_ret: #ifdef CONFIG_SYS_RESET_SCTRL bl reset_sctrl // åˆå§‹åŒ–ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨ #endif /* * å¼‚å¸¸çº§åˆ«å¯èƒ½æ˜¯3ã€2æˆ–è€…1ï¼Œåˆå§‹çŠ¶æ€ï¼š * å°ç«¯å­—èŠ‚åºï¼Œç¦æ­¢MMUï¼Œç¦æ­¢æŒ‡ä»¤/æ•°æ®ç¼“å­˜ */ adr x0, vectors witch_el x1, 3f, 2f, 1f 3: msr vbar_el3, x0 // å¼‚å¸¸çº§åˆ«3ï¼Œå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL3è®¾ç½®ä½å¼‚å¸¸å‘é‡çš„èµ·å§‹åœ°å€ mrs x0, scr_el3 // è®¾ç½®å®‰å…¨é…ç½®å¯„å­˜å™¨SCR_EL3 orr x0, x0, #0xf /* è®¾ç½®å¯„å­˜å™¨SCR_EL3çš„NSã€IRQã€FIQå’ŒEAå››ä¸ªä½ */ msr scr_el3, x0 msr cptr_el3, xzr /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½*/ #ifdef COUNTER_FREQUENCY ldr x0, =COUNTER_FREQUENCY msr cntfrq_el0, x0 /* åˆå§‹åŒ–å¯„å­˜å™¨CNTFRQ */ #endif b 0f 2: msr vbar_el2, x0 // å¼‚å¸¸çº§åˆ«2 mov x0, #0x33ff msr cptr_el2, x0 /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */ b 0f 1: msr vbar_el1, x0 mov x0, #3 \u003c\u003c 20 msr cpacr_el1, x0 /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */ 0: â€¦ /* åº”ç”¨ARMå¤„ç†å™¨ç‰¹å®šçš„å‹˜è¯¯è¡¨*/ bl apply_core_errata /* å¤„ç†å™¨ç‰¹å®šçš„åˆå§‹åŒ–*/ bl lowlevel_init // æ‰§è¡Œboard_init_f()æ‰€éœ€æœ€å°åˆå§‹åŒ– #if defined(CONFIG_ARMV8_SPIN_TABLE) \u0026\u0026 !defined(CONFIG_SPL_BUILD) branch_if_master x0, x1, master_cpu b spin_table_secondary_jump // arch/arm/cpu/armv8/spin_tabli.c /* ç»å¯¹ä¸ä¼šè¿”å›*/ #elif defined(CONFIG_ARMV8_MULTIENTRY) branch_if_master x0, x1, master_cpu /* * ä»å¤„ç†å™¨ */ slave_cpu: wfe // ä»å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œå®ƒè¢«å”¤é†’çš„æ—¶å€™ï¼Œä»åœ°å€CPU_RELEASE_ADDRè¯»å–å‡½æ•° ldr x1, =CPU_RELEASE_ADDR ldr x0, [x1] cbz x0, slave_cpu br x0 /* è·³è½¬åˆ°æŒ‡å®šåœ°å€*/ #endif /* CONFIG_ARMV8_MULTIENTRY */ master_cpu: bl _main // ä¸»å¤„ç†å™¨æ‰§è¡Œå‡½æ•° U-Bootåˆ†ä¸ºSPLå’Œæ­£å¸¸çš„U-Bootç¨‹åºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦ç¼–è¯‘ä¸ºSPLï¼Œéœ€è¦å¼€å¯é…ç½®å®CONFIG_SPL_BUILDã€‚SPLæ˜¯â€œSecondary Program Loaderâ€çš„ç®€ç§°ï¼Œå³ç¬¬äºŒé˜¶æ®µç¨‹åºåŠ è½½å™¨ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯ç›¸å¯¹äºå¤„ç†å™¨é‡Œé¢çš„åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åºæ¥è¯´çš„ï¼Œå¤„ç†å™¨å¯åŠ¨æ—¶æœ€å…ˆæ‰§è¡Œçš„æ˜¯åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åº\n1.1.3 å‡½æ•°_main // arch/arm/lib/crt0_64.S ENTRY(_main) // è®¾ç½®åˆå§‹çš„Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”è°ƒç”¨board_init_f(0)ã€‚ #if defined(CONFIG_SPL_BUILD) \u0026\u0026 defined(CONFIG_SPL_STACK ldr x0, =(CONFIG_SPL_STACK) #else ldr x0, =(CONFIG_SYS_INIT_SP_ADDR) #endif bic sp, x0, #0xf /* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚*/ mov x0, sp bl board_init_f_alloc_reserve // åœ¨æ ˆçš„é¡¶éƒ¨ä¸ºç»“æ„ä½“global_dataåˆ†é…ç©ºé—´ mov sp, x0 mov x18, x0 /* è®¾ç½®gd */ // å‡½æ•°board_init_f_init_reserveï¼Œåˆå§‹åŒ–ç»“æ„ä½“global_data bl board_init_f_init_reserve mov x0, #0 bl board_init_f // common/board_f.c æ‰§è¡Œæ•°ç»„init_sequence_fä¸­çš„æ¯ä¸ªå‡½æ•° #if !defined(CONFIG_SPL_BUILD) // è®¾ç½®ä¸­é—´ç¯å¢ƒï¼ˆæ–°çš„æ ˆæŒ‡é’ˆå’Œgdï¼‰ï¼Œç„¶åè°ƒç”¨å‡½æ•° // relocate_code(addr_moni) ldr x0, [x18, #GD_START_ADDR_SP] /* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-\u003estart_addr_sp */ bic sp, x0, #0xf /* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚ */ ldr x18, [x18, #GD_BD] /* æŠŠå¯„å­˜å™¨x18è®¾ç½®ä¸ºgd-\u003ebd */ sub x18, x18, #GD_SIZE /* æ–°çš„gdåœ¨bdçš„ä¸‹é¢ */ adr lr, relocation_return ldr x9, [x18, #GD_RELOC_OFF] /* æŠŠå¯„å­˜å™¨x9è®¾ç½®ä¸ºgd-\u003ereloc_off */ add lr, lr, x9 /* åœ¨é‡å®šä½åæ–°çš„è¿”å›åœ°å€ */ ldr x0, [x18, #GD_RELOCADDR] /* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-\u003erelocaddr */ b relocate_code relocation_return: // è®¾ç½®æœ€ç»ˆçš„å®Œæ•´ç¯å¢ƒ /* ä»ç„¶è°ƒç”¨æ—§çš„ä¾‹ç¨‹ æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€*/ bl c_runtime_cpu_setup #endif /* !CONFIG_SPL_BUILD */ #if defined(CONFIG_SPL_BUILD) bl spl_relocate_stack_gd /* å¯èƒ½è¿”å›ç©ºæŒ‡é’ˆ é‡æ–°å®šä½æ ˆ*/ // æ‰§è¡Œâ€œsp = (x0 != NULL) ? x0 : spâ€ï¼Œ // è§„é¿è¿™ä¸ªçº¦æŸï¼š // å¸¦æ¡ä»¶çš„movæŒ‡ä»¤ä¸èƒ½æŠŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•° mov x1, sp cmp x0, #0 csel x0, x0, x1, ne mov sp, x0 #endif // ç”¨0åˆå§‹åŒ–æœªåˆå§‹åŒ–æ•°æ®æ®µ ldr x0, =__bss_start /* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/ ldr x1, =__bss_end /* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/ clear_loop: str xzr, [x0], #8 cmp x0, x1 b.lo clear_loop /* è°ƒç”¨å‡½æ•°board_init_r(gd_t *id, ulong dest_addr) */ mov x0, x18 /* gd_t */ ldr x1, [x18, #GD_RELOCADDR] /* dest_addr */ /* ç›¸å¯¹ç¨‹åºè®¡æ•°å™¨çš„è·³è½¬ common/board_r.c æ‰§è¡Œæ•°ç»„init_sequence_rä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œæœ€åä¸€ä¸ªå‡½æ•°æ˜¯run_main_loop */ b board_init_r /* ä¸ä¼šè¿è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºå‡½æ•°board_init_r()ä¸ä¼šè¿”å›*/ ENDPROC(_main) 1.1.4 å‡½æ•°run_main_loop æ•°ç»„init_sequence_ræœ€åä¸€ä¸ªå‡½æ•°run_main_loopï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹ï¼›\nrun_main_loop main_loop bootdely_process # è¯»å–ç¯å¢ƒå˜é‡bootdelay(å»¶è¿Ÿæ—¶é—´)å’Œbootcmd(ç¯å¢ƒå˜é‡) autoboot_command abortboot # ç­‰å¾…ç”¨æˆ·æŒ‰é”® run_command_list # æœªç­‰å¾…åˆ°æŒ‰é”®ï¼Œè‡ªåŠ¨æ‰§è¡Œç¯å¢ƒå˜é‡bootcmd bootmå‘½ä»¤å¤„ç†å‡½æ•°do_bootm\ndo_bootm do_bootm_states bootm_start # åˆå§‹åŒ–å…¨å±€å˜é‡bootm_header_timages bootm_find_os # æŠŠå†…æ ¸é•œåƒä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜ bootm_find_other # ARM64 æ‰å¹³è®¾å¤‡æ ‘(Flattended Device Tree FDT)äºŒè¿›åˆ¶æ–‡ä»¶ bootm_load_os # è§£å‹ç—…åŠ è½½å†…æ ¸åˆ°æ­£ç¡®ä½ç½® bootm_os_get_boot_func # åœ¨æ“ä½œç³»ç»Ÿç±»å‹æ•°ç»„boot_osä¸­æŸ¥æ‰¾å¼•å¯¼å‡½æ•°ï¼Œlinuxå†…æ ¸å¼•å¯¼å‡½æ•°do_bootm_linux do_bootm_linux(flag=BOOTM_STATE_OS_PREP) # è°ƒç”¨boot_prep_linux boot_prep_linux # 1.åˆ†é…ä¸€å—å†…å­˜ï¼ŒæŠŠè®¾å¤‡æ•°äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ 2.ä¿®æ”¹æ‰å¹³è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ boot_selected_os # do_bootm_linux(flag=BOOTM_STATE_OS_GO) boot_jump_linux # è´Ÿè´£è·³è½¬åˆ°Linuxå†…æ ¸ boot_jum_linux do_nonsec_virt_switch smp_kick_all_cpus # CONFIG_GICV2æˆ–CONFIG_GICV3ï¼Œä¸­æ–­æ§åˆ¶å™¨ç‰ˆæœ¬2ï¼Œ3 dcache_disable # ç¦ç”¨å¤„ç†å™¨çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†å•å…ƒ # åœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ # å¼€å¯é…ç½®å® CONFIG_ARMV8_SWITCH_TO_EL1 armv8_switch_to_el2 switch_to_el1 armv8_switch_to_el1 å†…æ ¸å…¥å£ # åœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ armv8_switch_to_el2 å†…æ ¸å…¥å£ 1.2 å†…æ ¸åˆå§‹åŒ– å†…æ ¸åˆå§‹åŒ–åˆ†ä¸ºæ±‡ç¼–è¯­è¨€éƒ¨åˆ†å’ŒCè¯­è¨€éƒ¨åˆ†\n1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ† ARM64æ¶æ„å†…æ ¸å…¥å£_headï¼Œç›´æ¥è·³è½¬åˆ°æ ‡å·stext\n// linux-4.14.295/arch/arm64/kernel/head.S _head: #ifdef CONFIG_EFI // æä¾›UEFIè¿è¡Œæ—¶æ”¯æŒUEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æ˜¯ç»Ÿä¸€çš„å¯æ‰©å±•å›ºä»¶æ¥å£ï¼Œç”¨äºå–ä»£BIOS add x13, x18, #0x16 b stext #else b stext // è·³è½¬åˆ°å†…æ ¸èµ·å§‹ä½ç½® .long0 // ä¿ç•™ #endif stext\n// linux-4.14.295/arch/arm64/kernel/head.S ENTRY(stext) bl preserve_boot_args // æŠŠå¼•å¯¼ç¨‹åºä¼ é€’çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_argsä¸­ bl el2_setup // é™çº§åˆ°å¼‚å¸¸çº§åˆ«1, å¯„å­˜å™¨w0å­˜æ”¾cpu_boot_mode adrp x23, __PHYS_OFFSET and x23, x23, MIN_KIMG_ALIGN - 1 // KASLRåç§»ï¼Œé»˜è®¤å€¼æ˜¯0 bl set_cpu_boot_mode_flag // __boot_cpu_mode[2] æ•°ç»„ bl __create_page_tables // åˆ›å»ºé¡µè¡¨æ˜ å°„ /* ä¸‹é¢è°ƒç”¨è®¾ç½®å¤„ç†å™¨çš„ä»£ç ï¼Œè¯·çœ‹æ–‡ä»¶â€œarch/arm64/mm/proc.Sâ€ äº†è§£ç»†èŠ‚ã€‚ * è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å·²ç»ä¸ºå¼€å¯å†…å­˜ç®¡ç†å•å…ƒåšå¥½å‡†å¤‡ï¼Œ * è½¬æ¢æ§åˆ¶å¯„å­˜å™¨å·²ç»è®¾ç½®å¥½ã€‚*/ bl __cpu_setup // åˆå§‹åŒ–å¤„ç†å™¨ b __primary_switch // ä¸»å¤„ç†å™¨å¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿›å…¥Cè¯­è¨€éƒ¨åˆ†å…¥å£å‡½æ•°start_kernel ENDPROC(stext) å‡½æ•°el2_setup a.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯1ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ã€‚ b.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯2ï¼Œé‚£ä¹ˆæ ¹æ®å¤„ç†å™¨æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼ˆVirtualization Host Extensionsï¼ŒVHEï¼‰ï¼Œå†³å®šæ˜¯å¦éœ€è¦é™çº§åˆ°å¼‚å¸¸çº§åˆ«1ã€‚ 1ï¼‰å¦‚æœå¤„ç†å™¨æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ã€‚ \\\n2ï¼‰å¦‚æœå¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆé™çº§åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ \\\nåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼ŒKVMï¼‰ï¼ŒKVMçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œå› æ­¤è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚ å¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒKVMè™šæ‹Ÿæœºã€‚QEMUåˆ›å»ºä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå’ŒKVMçš„äº¤äº’è¿‡ç¨‹ \\\n// æ‰“å¼€KVMå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚ fd = open(\"/dev/kvm\", O_RDWR); // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ vmfd = ioctl(fd, KVM_CREATE_VM, 0); // KVMä¸ºæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªkvm_vcpuç»“æ„ä½“ï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿå¤„ç†å™¨çš„æ–‡ä»¶æè¿°ç¬¦ vcpu_fd = ioctl(vmfd, KVM_CREATE_VCPU, 0); ä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰QEMUè¿›ç¨‹è°ƒç”¨â€œioctl(vcpu_fd, KVM_RUN, 0)â€ï¼Œé™·å…¥åˆ°å†…æ ¸ã€‚ ï¼ˆ2ï¼‰KVMæ‰§è¡Œå‘½ä»¤KVM_RUNï¼Œä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚ ï¼ˆ3ï¼‰KVMé¦–å…ˆæŠŠè°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨ä¿å­˜åœ¨kvm_vcpuç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠæ‰€æœ‰å¯„å­˜å™¨è®¾ç½®ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿçš„å¯„å­˜å™¨å€¼ï¼Œæœ€åä»å¼‚å¸¸çº§åˆ«2è¿”å›åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚ ä¸ºäº†æé«˜åˆ‡æ¢é€Ÿåº¦ï¼ŒARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦å…ˆä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2 \\\nå‡½æ•°__create_page_tables 1ï¼‰åˆ›å»ºæ’ç­‰æ˜ å°„ï¼Œè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ 2ï¼‰ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ \\\næ˜ å°„ä»£ç èŠ‚.idmap.text,æ’ç­‰æ˜ å°„ä»£ç èŠ‚çš„èµ·å§‹åœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_startä¸­ï¼Œç»“æŸåœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_endä¸­ã€‚æ’ç­‰æ˜ å°„æ˜¯ä¸ºæ’ç­‰æ˜ å°„ä»£ç èŠ‚åˆ›å»ºçš„æ˜ å°„ï¼Œidmap_pg_diræ˜¯æ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•ï¼ˆå³ç¬¬ä¸€çº§é¡µè¡¨ï¼‰çš„èµ·å§‹åœ°å€ã€‚å†…æ ¸çš„é¡µè¡¨ä¸­ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ï¼Œå†…æ ¸é•œåƒçš„èµ·å§‹åœ°å€æ˜¯_textï¼Œç»“æŸåœ°å€æ˜¯_endï¼Œswapper_pg_diræ˜¯å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹åœ°å€\nå‡½æ•°__primary_switch 1ï¼‰__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ 2ï¼‰__primary_switched __enable_mmuæ‰§è¡Œæµç¨‹ 1ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨0(TTBR0_EL1)è®¾ç½®ä¸ºæ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€ 2ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨1(TTBR1_EL1)è®¾ç½®ä¸ºå†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€ 3ï¼‰è®¾ç½®ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR_EL1)ï¼Œå¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼ŒåMMUæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ __primary_switchæ‰§è¡Œæµç¨‹ 1ï¼‰æŠŠå½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨è®¾ç½®ä¸º0å·çº¿ç¨‹å†…æ ¸æ ˆçš„é¡¶éƒ¨(init_thread_union + THREAD_SIZE) 2ï¼‰æŠŠå¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨(SP_EL0)è®¾ç½®ä¸º0å·çº¿ç¨‹çš„ç»“æ„ä½“thread_infoçš„åœ°å€(init_task.thread_info) 3ï¼‰æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(VBAR_EL1)è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€(vectors) 4ï¼‰è®¡ç®—å†…æ ¸é•œåƒçš„èµ·å§‹è™šæ‹Ÿåœ°å€(kimage_vaddr)å’Œç‰©ç†åœ°å€çš„å·®å€¼ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡kimage_voffsetä¸­ 5ï¼‰ç”¨0åˆå§‹åŒ–å†…æ ¸çš„æœªåˆå§‹åŒ–æ•°æ®æ®µ 6ï¼‰è°ƒç”¨Cè¯­è¨€å‡½æ•°start_kernel \\\n1.2.2 Cè¯­è¨€éƒ¨åˆ† å†…æ ¸åˆå§‹åŒ–çš„Cè¯­è¨€éƒ¨åˆ†å…¥å£æ˜¯å‡½æ•°start_kernelï¼Œå‡½æ•°start_kernelé¦–å…ˆåˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼Œå³åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼Œç„¶åè°ƒç”¨å‡½æ•°rest_initã€‚å‡½æ•°rest_initçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰åˆ›å»º1å·çº¿ç¨‹ï¼Œå³initçº¿ç¨‹ï¼Œçº¿ç¨‹å‡½æ•°æ˜¯kernel_initã€‚ ï¼ˆ2ï¼‰åˆ›å»º2å·çº¿ç¨‹ï¼Œå³kthreaddçº¿ç¨‹ï¼Œè´Ÿè´£åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚ ï¼ˆ3ï¼‰0å·çº¿ç¨‹æœ€ç»ˆå˜æˆç©ºé—²çº¿ç¨‹ã€‚ \\\ninitçº¿ç¨‹ç»§ç»­åˆå§‹åŒ–ï¼Œæ‰§è¡Œçš„ä¸»è¦æ“ä½œå¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰smp_prepare_cpus()ï¼šåœ¨å¯åŠ¨ä»å¤„ç†å™¨ä»¥å‰æ‰§è¡Œå‡†å¤‡å·¥ä½œã€‚ ï¼ˆ2ï¼‰do_pre_smp_initcalls()ï¼šæ‰§è¡Œå¿…é¡»åœ¨åˆå§‹åŒ–SMPç³»ç»Ÿä»¥å‰æ‰§è¡Œçš„æ—©æœŸåˆå§‹åŒ–ï¼Œå³ä½¿ç”¨å®early_initcallæ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ã€‚ ï¼ˆ3ï¼‰smp_init()ï¼šåˆå§‹åŒ–SMPç³»ç»Ÿï¼Œå¯åŠ¨æ‰€æœ‰ä»å¤„ç†å™¨ã€‚ ï¼ˆ4ï¼‰do_initcalls()ï¼šæ‰§è¡Œçº§åˆ«0ï½7çš„åˆå§‹åŒ–ã€‚ ï¼ˆ5ï¼‰æ‰“å¼€æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶â€œ/dev/consoleâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2åˆ†åˆ«æ˜¯æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œéƒ½æ˜¯æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚ ï¼ˆ6ï¼‰prepare_namespace()ï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è£…è½½initç¨‹åºæ—¶éœ€è¦ä»å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¯»æ–‡ä»¶ã€‚ ï¼ˆ7ï¼‰free_initmem()ï¼šé‡Šæ”¾åˆå§‹åŒ–ä»£ç å’Œæ•°æ®å ç”¨çš„å†…å­˜ã€‚ ï¼ˆ8ï¼‰è£…è½½initç¨‹åºï¼ˆU-Bootç¨‹åºå¯ä»¥ä¼ é€’å†…æ ¸å‚æ•°â€œinit=â€ä»¥æŒ‡å®šinitç¨‹åºï¼‰ï¼Œä»å†…æ ¸çº¿ç¨‹è½¬æ¢æˆç”¨æˆ·ç©ºé—´çš„initè¿›ç¨‹ã€‚ \\\nçº§åˆ«0ï½7çš„åˆå§‹åŒ–ï¼Œæ˜¯æŒ‡ä½¿ç”¨ä»¥ä¸‹å®æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼š\n// include/linux/init.h #define pure_initcall(fn) __define_initcall(fn, 0) #define core_initcall(fn) __define_initcall(fn, 1) #define core_initcall_sync(fn) __define_initcall(fn, 1s) #define postcore_initcall(fn) __define_initcall(fn, 2) #define postcore_initcall_sync(fn) __define_initcall(fn, 2s) #define arch_initcall(fn) __define_initcall(fn, 3) #define arch_initcall_sync(fn) __define_initcall(fn, 3s) #define subsys_initcall(fn) __define_initcall(fn, 4) #define subsys_initcall_sync(fn) __define_initcall(fn, 4s) #define fs_initcall(fn) __define_initcall(fn, 5) #define fs_initcall_sync(fn) __define_initcall(fn, 5s) #define rootfs_initcall(fn) __define_initcall(fn, rootfs) #define device_initcall(fn) __define_initcall(fn, 6) #define device_initcall_sync(fn) __define_initcall(fn, 6s) #define late_initcall(fn) __define_initcall(fn, 7) #define late_initcall_sync(fn) __define_initcall(fn, 7s) 1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼ å¯¹ç§°å¤šå¤„ç†å™¨(Symmetirc Multi-Processor SMP) 3ç§å¼•å¯¼ä»å¤„ç†å™¨æ–¹æ³• \\\nè‡ªæ—‹è¡¨ ç”µæºçŠ¶æ€åè°ƒæ¥å£ ACPIåœè½¦åè®® 1.3 initè¿›ç¨‹ initè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç”¨æˆ·ç¨‹åºã€‚Linuxç³»ç»Ÿinitç¨‹åºæœ‰sysvinitã€busybox initã€upstartã€systemdå’Œprocdã€‚sysvinitæ˜¯Unixç³»ç»Ÿ5(System V)initç¨‹åºï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶/etc/initab\nç¬¬2ç«  è¿›ç¨‹ç®¡ç† 2.1 è¿›ç¨‹ Linuxå†…æ ¸æŠŠè¿›ç¨‹ç§°ä¸ºtaskï¼Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ è¿›ç¨‹æœ‰ä¸¤ç§ç‰¹æ®Šå½¢å¼ï¼šæ²¡æœ‰ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œå…±äº«ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚ task_structç»“æ„ä½“æ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸»è¦æˆå‘˜\nvolatile long state; // è¿›ç¨‹çŠ¶æ€ void *stack; // æŒ‡å‘å†…æ ¸æ ˆ pid_t pid; // å…¨å±€è¿›ç¨‹å· pid_t tgid // å…¨å±€çš„çº¿ç¨‹ç»„æ ‡è¯†ç¬¦ struct pid_link pid[PIDTYPE_MAX]; // è¿›ç¨‹å·ï¼Œè¿›ç¨‹ç»„æ ‡è¯†ç¬¦å’Œä¼šè¯æ ‡è¯†ç¬¦ struct task_struct _rcu *real_parent; // real_parentæŒ‡å‘çœŸå®çš„çˆ¶è¿›ç¨‹ struct task_struct _rcu *parent; // parentæŒ‡å‘çˆ¶è¿›ç¨‹ struct task_struct *group_leader; // æŒ‡å‘è¿›æ‘ç»„çš„ç»„é•¿ const struct cred _rcu *real_cred; // real_credæŒ‡å‘ä¸»é¢˜å’ŒçœŸå®å®¢ä½“è¯ä¹¦ const struct cred _rcu *cred; // credæŒ‡å‘å®¢ä½“è¯ä¹¦ char comm[TASK_COMM_LEN]; // è¿›ç¨‹å int prio, static_prio, nornal_prio; // è°ƒåº¦ç­–ç•¥ unsigned int rt_priority,prolicyï¼› // ä¼˜å…ˆçº§ cpumask_t cpus_allowed; // å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ struct mm_struct *mm, *active_mm; // æŒ‡å‘å†…å­˜æè¿°ç¬¦ï¼Œè¿›ç¨‹mmï¼Œå’Œactive_mmæŒ‡å‘åŒä¸€ä¸ªå†…å­˜æè¿°ç¬¦ï¼Œå†…æ ¸çº¿ç¨‹mmæ˜¯æŒ‡é’ˆï¼Œå½“å†…æ ¸çº¿ç¨‹è¿è¡Œæ—¶active_mmæŒ‡å‘ä»è¿›ç¨‹å€Ÿç”¨çš„å†…å­˜æè¿°ç¬¦ struct file_struct *files; // æ‰“å¼€æ–‡ä»¶è¡¨ struct nsproxy *nsproxy; // å‘½åç©ºé—´ struct signal_struct *signal; // ä¿¡å·å¤„ç† struct sigband_struct *sighand; sigset_t blocked, real_blocked; sigset_t saved_sigmask; struct sigpending pending; struct sysv_sem sysvsem; // UNIxç³»ç»Ÿ5ä¿¡å·é‡å’Œå…±äº«å†…å­˜ struct sysv_shm sysvshm; 2.2 å‘½åç©ºé—´ å’Œè™šæ‹Ÿæœºç›¸æ¯”ï¼Œå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„å†…æ ¸ï¼Œä½¿ç”¨å‘½åç©ºé—´éš”ç¦»èµ„æº,è™šæ‹Ÿæœºä»…ä»…æ˜¯é€šè¿‡å‘½åç©ºé—´éš”ç¦»ï¼Ÿ \\\nå‘½åç©ºé—´ éš”ç¦»èµ„æº æ§åˆ¶ç»„cgroup æ§åˆ¶ç»„æ ¹ç›®å½• è¿›ç¨‹é—´é€šä¿¡IPC UNIXç³»ç»Ÿ5è¿›ç¨‹é—´é€šä¿¡å’ŒPOSIxæ¶ˆæ¯é˜Ÿåˆ— network ç½‘ç»œåè®® æŒ‚è½½mount æŒ‚è½½ç‚¹ PID è¿›ç¨‹å· user ç”¨æˆ·æ ‡è¯†ç¬¦å’Œç»„æ ‡è¯†ç¬¦ UNIXåˆ†æ—¶ç³»ç»Ÿ(UTS) ä¸»æœºåå’Œç½‘ç»œä¿¡æ¯æœåŠ¡NISåŸŸå åˆ›å»ºæ–°çš„å‘½åç©ºé—´æ–¹æ³•ï¼š è°ƒç”¨cloneåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œä½¿ç”¨æ ‡å¿—ä½æ§åˆ¶å­è¿›ç¨‹æ˜¯å…±äº«çˆ¶è¿›ç¨‹çš„å‘½åç©ºé—´è¿˜æ˜¯åˆ›å»ºæ–°å‘½åç©ºé—´ è°ƒç”¨unshareåˆ›å»ºæ–°çš„å‘½åç©ºé—´ è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setnsï¼Œç»‘å®šä¸€ä¸ªå·²ç»å­˜åœ¨çš„å‘½åç©ºé—´\nè¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespace,è¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespaceã€‚\n2.3 è¿›ç¨‹æ ‡è¯†ç¬¦ æ ‡è¯†ç¬¦ è¿›ç¨‹æ ‡è¯†ç¬¦ å‘½åç©ºé—´ç»™è¿›ç¨‹åˆ†é…æ ‡è¯†ç¬¦ çº¿ç¨‹ç»„æ ‡è¯†ç¬¦ çº¿ç¨‹ç»„ä¸­çš„ä¸»è¿›ç¨‹ç§°ä¸ºç»„é•¿ï¼Œçº¿ç¨‹ç»„æ ‡è¯†ç¬¦å°±æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦\nç³»ç»Ÿè°ƒç”¨cloneä¼ å…¥æ ‡å¿—CLONE_THREADä»¥åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºä¸€ä¸ªçº¿ç¨‹ç»„ è¿›ç¨‹ç»„æ ‡è¯†ç¬¦ è¿›ç¨‹ç»„æ ‡è¯†ç¬¦æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦ã€‚\nè¿›ç¨‹å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setpgidåˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªè¿›ç¨‹ç»„ ä¼šè¯æ ‡è¯†ç¬¦ è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨setsidçš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ pidå­˜å‚¨å…¨å±€è¿›ç¨‹å·ï¼Œpids[PIDTYPE_PID].pidæŒ‡å‘ç»“æ„ä½“pidï¼Œpids[PIDTYPE_PGID].pidæŒ‡å‘è¿›ç¨‹ç»„ç»„é•¿çš„ç»“æ„ä½“pidï¼Œpids[PIDTYPE_SIG].pidæŒ‡å‘ä¼šè¯è¿›ç¨‹çš„ç»“æ„ä½“pid \\\nè¿›ç¨‹æ ‡è¯†ç¬¦ç»“æ„ä½“pidçš„æˆå‘˜ï¼Œcountæ˜¯å¼•ç”¨è®¡æ•°ï¼Œlevelè¿›ç¨‹å·å‘½åç©ºé—´çš„å±‚æ¬¡ï¼Œnumberså…ƒç´ ä¸ªæ•°æ˜¯levelçš„å€¼åŠ 1ï¼Œ\n2.4 è¿›ç¨‹å…³ç³» å¦‚æœå­è¿›ç¨‹è¢«æŸä¸ªè¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯è°ƒè¯•å™¨ï¼‰ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ptraceè·Ÿè¸ªï¼Œé‚£ä¹ˆæˆå‘˜parentæŒ‡å‘è·Ÿè¸ªè€…çš„è¿›ç¨‹æè¿°ç¬¦ï¼Œå¦åˆ™æˆå‘˜parentä¹ŸæŒ‡å‘çˆ¶è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ã€‚\n2.4 å¯åŠ¨ç¨‹åº ret = fork(); if (ret \u003e 0) { /* çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œ */ } else if (ret == 0) { /* å­è¿›ç¨‹è£…è½½ç¨‹åº */ ret = execve(filename, argv, envp); } else { /* åˆ›å»ºå­è¿›ç¨‹å¤±è´¥ */ } 2.4.1ã€€åˆ›å»ºæ–°è¿›ç¨‹ å†…æ ¸ä½¿ç”¨é™æ€æ•°æ®æ„é€ å‡º0å·å†…æ ¸çº¿ç¨‹ï¼Œ0å·å†…æ ¸çº¿ç¨‹åˆ†å‰ç”Ÿæˆ1å·å†…æ ¸çº¿ç¨‹å’Œ2å·å†…æ ¸çº¿ç¨‹ï¼ˆkthreaddçº¿ç¨‹ï¼‰ã€‚1å·å†…æ ¸çº¿ç¨‹å®Œæˆåˆå§‹åŒ–ä»¥åè£…è½½ç”¨æˆ·ç¨‹åºï¼Œå˜æˆ1å·è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯1å·è¿›ç¨‹æˆ–è€…å®ƒçš„å­å­™è¿›ç¨‹åˆ†å‰ç”Ÿæˆçš„ï¼›å…¶ä»–å†…æ ¸çº¿ç¨‹æ˜¯kthreaddçº¿ç¨‹åˆ†å‰ç”Ÿæˆçš„ ä¸¤ä¸ªä¸ªç³»ç»Ÿè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼š \\\nforkï¼šå­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œç”¨å†™æ—¶å¤åˆ¶ cloneï¼šå¯æ§åˆ¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«å“ªäº›èµ„æº vforkï¼šåˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ç”¨execveè£…è½½ç¨‹åº(å·²åºŸå¼ƒ) // æ•°å­—è¡¨ç¤ºå‚æ•°ä¸ªæ•° SYSCALL_DEFINE0(fork) // å®å±•å¼€ asmlinkageè¡¨ç¤ºCè¯­è¨€å‡½æ•°çœ‹è¢«æ±‡ç¼–ä»£ç è°ƒç”¨ asmlinkage long sys_fork(void) åˆ›å»ºè¿›ç¨‹çš„è¿›ç¨‹på’Œè¢«åˆ›å»ºè¿›ç¨‹cä¸‰ç§å…³ç³»\næ–°è¿›ç¨‹æ˜¯è¿›ç¨‹pçš„å­è¿›ç¨‹ cloneä¼ å…¥CLONE_PARENTï¼Œå…„å¼Ÿå…³ç³» cloneä¼ å…¥CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ 1. _do_forkå‡½æ•° // kernel/fork.c long _do_fork(unsigned long clone_flags, unsigned long stack_start, unsigned long stack_size, int __user *parent_tidptr, int __user *child_tidptr, unsigned long tls); // tls åˆ›å»ºçº¿ç¨‹ï¼Œclone_flagsä¸ºCLONE_SETTLSæ—¶ï¼ŒtlstlsæŒ‡å®šæ–°çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ è°ƒç”¨copy_processåˆ›å»ºæ–°è¿›ç¨‹ clone_flagsè®¾ç½®CLONE_PARENT_SETTIDï¼Œæ–°çº¿ç¨‹çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°å‚æ•°parent_tidptræŒ‡å®šçš„ä½ç½® wake_up_new_taskå”¤é†’æ–°è¿›ç¨‹\n2. copy_processå‡½æ•° ï¼ˆ1ï¼‰æ ‡å¿—ç»„åˆ CLONE_NEWNS \u0026 CLONE_FS æ–°è¿›ç¨‹å±äºæ–°æŒ‚è½½å‘½åç©ºé—´\nå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ CLONE_NEWUSER \u0026 CLONE_FS æ–°è¿›ç¨‹å±äºæ–°ç”¨æˆ·å‘½åç©ºé—´\nå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ CLONE_THREAD æœªè®¾ç½®CLONE_SIGHAND æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œ\nä½†ä¸å…±äº«ä¿¡å·å¤„ç†ç¨‹åº CLONE_SIGHAND æœªè®¾ç½®CLONE_VM æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·å¤„ç†ç¨‹åºï¼Œ\nä½†ä¸å…±äº«è™šæ‹Ÿå†…å­˜ ï¼ˆ2ï¼‰dup_task_structå‡½æ•° æœªæ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦åˆ†é…å†…å­˜ï¼Œå¤åˆ¶å½“å‰è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸ºæ–°è¿›ç¨‹åˆ†é…å†…æ ¸æ ˆ // include/linux/sched.h union thread_union { #ifndef CONFIG_ARCH_TASK_STRUCT_ON_STACK struct task_struct task; #endif #ifndef CONFIG_THREAD_INFO_IN_TASK struct thread_info thread_info; #endif unsigned long stack[THREAD_SIZE/sizeof(long)]; }; å†…æ ¸æ ˆä¸¤ç§å¸ƒå±€\nthread_infoåœ¨å†…æ ¸æ ˆé¡¶éƒ¨ï¼Œæˆå‘˜taskæŒ‡å‘è¿›ç¨‹æè¿°ç¬¦ thread_infoæœªå ç”¨å†…æ ¸æ ˆ ç¬¬äºŒç§å¸ƒå±€éœ€æ‰“å¼€CONFIG_THREAD_INFO_IN_TASKï¼ŒARM64ä½¿ç”¨ç¬¬äºŒç§å†…æ ¸æ ˆå¸ƒå±€ï¼Œthread_infoç»“æ„ä½“åœ°å€ä¸è¿›ç¨‹æè¿°ç¬¦åœ°å€ç›¸åŒã€‚è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼æ—¶ï¼ŒARM64æ¶æ„çš„å†…æ ¸ä½¿ç”¨ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0å­˜æ”¾å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“åœ°å€ï¼Œå¯åŒæ—¶å¾—åˆ°thread_infoåœ°å€å’Œè¿›ç¨‹æè¿°ç¬¦åœ°å€ å†…æ ¸æ ˆçš„é•¿åº¦æ—¶THREAD_SIZEï¼ŒARM64æ¶æ„å†…æ ¸æ ˆé•¿åº¦ä¸º16KB thread_infoå­˜æ”¾æ±‡ç¼–ä»£ç ç›´æ¥è®¿é—®çš„åº•å±‚æ•°æ®ï¼ŒARM64æ¶æ„å®šä¹‰ç»“æ„ä½“ // arch/arm64/include/asm/thread_info.h struct thread_info { unsigned long\tflags;\t/* low level flags åº•å±‚æ ‡å¿—ä½ */ mm_segment_t\taddr_limit;\t/* address limit åœ°å€é™åˆ¶ */ #ifdef CONFIG_ARM64_SW_TTBR0_PAN u64\tttbr0;\t/* saved TTBR0_EL1 ä¿å­˜çš„å¯„å­˜å™¨TTBR0_EL1 */ #endif u64\tpreempt_count;\t/* æŠ¢å è®¡æ•°å™¨ 0 =\u003e preemptible å¯æŠ¢å , \u003c0 =\u003e bugç¼ºé™· */ }; ï¼ˆ3ï¼‰copy_credså‡½æ•° è´Ÿè´£å¤åˆ¶æˆ–å…±äº«è¯ä¹¦ï¼Œè¯ä¹¦å­˜æ”¾è¿›ç¨‹çš„ç”¨æˆ·æ ‡è¯†ç¬¦ã€ç»„æ ‡è¯†ç¬¦å’Œè®¿é—®æƒé™ã€‚è®¾ç½®æ ‡å¿—CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ã€‚CLONE_NEWUSERï¼Œéœ€è¦ä¸ºæ–°è¿›ç¨‹åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿›ç¨‹è®¡æ•°å™¨åŠ 1\nï¼ˆ4ï¼‰æ£€æŸ¥çº¿ç¨‹æ•°é‡é™åˆ¶ å…¨å±€å˜é‡nr_threadså­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡ï¼Œmax_threadså­˜æ”¾å…è®¸åˆ›å»ºçš„çº¿ç¨‹æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼MAX_THREADS\nï¼ˆ5ï¼‰sched_forkå‡½æ•°\nä¸ºæ–°è¿›ç¨‹è®¾ç½®è°ƒåº¦å™¨ç›¸å…³çš„å‚æ•°\n// linux-5.10.102/kernel/sched/core.c ä¹¦ä¸­ä¸º4.xç‰ˆæœ¬ int sched_fork(unsigned long clone_flags, struct task_struct *p) { __sched_fork(clone_flags, p); // æ‰§è¡ŒåŸºæœ¬è®¾ç½® /* * We mark the process as NEW here. This guarantees that * nobody will actually run it, and a signal or other external * event cannot wake it up and insert it on the runqueue either. */ p-\u003estate = TASK_NEW; // æ–°è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºTASK_NEW /* * Make sure we do not leak PI boosting priority to the child. */ p-\u003eprio = current-\u003enormal_prio; // æ–°è¿›ç¨‹è°ƒåº¦ä¼˜å…ˆçº§è®¾ç½®ä¸ºå½“å‰è¿›ç¨‹æ­£å¸¸ä¼˜å…ˆçº§ uclamp_fork(p); /* * Revert to default priority/policy on fork if requested. */ if (unlikely(p-\u003esched_reset_on_fork)) { if (task_has_dl_policy(p) || task_has_rt_policy(p)) { // é™æœŸè¿›ç¨‹æˆ–å®æ—¶è¿›ç¨‹ p-\u003epolicy = SCHED_NORMAL; // è°ƒåº¦ç­–ç•¥ p-\u003estatic_prio = NICE_TO_PRIO(0); // niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120 p-\u003ert_priority = 0; } else if (PRIO_TO_NICE(p-\u003estatic_prio) \u003c 0) // æ™®é€šè¿›ç¨‹ p-\u003estatic_prio = NICE_TO_PRIO(0); // niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120 p-\u003eprio = p-\u003enormal_prio = p-\u003estatic_prio; set_load_weight(p, false); /* * We don't need the reset flag anymore after the fork. It has * fulfilled its duty: */ p-\u003esched_reset_on_fork = 0; } if (dl_prio(p-\u003eprio)) // è°ƒåº¦ä¼˜å…ˆçº§æ˜¯é™æœŸè°ƒåº¦ç´¯çš„ä¼˜å…ˆçº§ return -EAGAIN; // ä¸å…è®¸é™æœŸè¿›ç¨‹åˆ†å‰ç”Ÿæˆæ–°çš„é™æœŸè¿›ç¨‹ else if (rt_prio(p-\u003eprio)) // è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å®æ—¶è°ƒåº¦ç±»ä¼˜å…ˆçº§ p-\u003esched_class = \u0026rt_sched_class; // è°ƒåº¦ç±»è®¾ç½®ä¸ºå®æ—¶è°ƒåº¦ç±» else p-\u003esched_class = \u0026fair_sched_class; // è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å…¬å¹³è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§ï¼Œè°ƒåº¦ç±»è®¾ç½®ä¸ºå…¬å¹³è°ƒåº¦ç±» init_entity_runnable_average(\u0026p-\u003ese); #ifdef CONFIG_SCHED_INFO if (likely(sched_info_on())) memset(\u0026p-\u003esched_info, 0, sizeof(p-\u003esched_info)); #endif #if defined(CONFIG_SMP) p-\u003eon_cpu = 0; #endif init_task_preempt_count(p); #ifdef CONFIG_SMP plist_node_init(\u0026p-\u003epushable_tasks, MAX_PRIO); RB_CLEAR_NODE(\u0026p-\u003epushable_dl_tasks); #endif return 0; } ï¼ˆ6ï¼‰å¤åˆ¶æˆ–å…±äº«èµ„æº 1ï¼‰UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰å…±äº«UNIXç³»ç»Ÿçš„5ä¿¡å·é‡ï¼Œcopy_semundoå‡½æ•°\n// linux-4.14.295/ipc/sem.c int copy_semundo(unsigned long clone_flags, struct task_struct *tsk) { struct sem_undo_list *undo_list; int error; if (clone_flags \u0026 CLONE_SYSVSEM) { // CLONE_SYSTEMè¡¨ç¤ºUNIXç³»ç»Ÿ5ä¿¡å·é‡ error = get_undo_list(\u0026undo_list); if (error) return error; refcount_inc(\u0026undo_list-\u003erefcnt); // 5ä¿¡å·é‡çš„æ’¤é”€è¯·æ±‚é“¾è¡¨ï¼Œsem_undo_list è®¡æ•°+1 tsk-\u003esysvsem.undo_list = undo_list; } else tsk-\u003esysvsem.undo_list = NULL; // æ–°è¿›ç¨‹5ä¿¡å·é‡æ’¤é”€è¯·æ±‚é“¾è¡¨ä¸ºç©º return 0; } 2ï¼‰æ‰“å¼€æ–‡ä»¶å¤¹ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ç›´æ¥å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ï¼Œå‡½æ•°copy_fileså¤åˆ¶æˆ–å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨\n// linux-5.10.102/kernel/fork.c static int copy_files(unsigned long clone_flags, struct task_struct *tsk) { struct files_struct *oldf, *newf; int error = 0; /* * A background process may not have any files ... */ oldf = current-\u003efiles; if (!oldf) goto out; if (clone_flags \u0026 CLONE_FILES) { // CLONE_FIELSå…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ atomic_inc(\u0026oldf-\u003ecount); // files_struct è®¡æ•°åŠ 1 goto out; } newf = dup_fd(oldf, NR_OPEN_MAX, \u0026error); // æ–°è¿›ç¨‹æŠŠå½“å‰è¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶è¡¨å¤åˆ¶ä¸€ä»½ if (!newf) goto out; tsk-\u003efiles = newf; error = 0; out: return error; } 3ï¼‰æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ã€‚è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡å·åŒ…æ‹¬ï¼šæ ¹ç›®å½•ã€å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ¨¡å¼åˆ›å»ºæ©ç ã€‚åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ å‡½æ•°copy_fså¤åˆ¶æˆ–å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯\n// linux-5.10.102/kernel/fork.c static int copy_fs(unsigned long clone_flags, struct task_struct *tsk) { struct fs_struct *fs = current-\u003efs; if (clone_flags \u0026 CLONE_FS) { // CLONE_FSå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ /* tsk-\u003efs is already what we want */ spin_lock(\u0026fs-\u003elock); if (fs-\u003ein_exec) { spin_unlock(\u0026fs-\u003elock); return -EAGAIN; } fs-\u003eusers++; // fs_structå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ç»“æ„ä½“ åŠ 1 spin_unlock(\u0026fs-\u003elock); return 0; } tsk-\u003efs = copy_fs_struct(fs); // æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ if (!tsk-\u003efs) return -ENOMEM; return 0; } 4ï¼‰ä¿¡å·å¤„ç†ç¨‹åºï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«ä¿¡å·å¤„ç†ç¨‹åº å‡½æ•°copy_sighandå¤åˆ¶æˆ–å…±äº«ä¿¡å·å¤„ç†ç¨‹åº\n// static int copy_sighand(unsigned long clone_flags, struct task_struct *tsk) { struct sighand_struct *sig; if (clone_flags \u0026 CLONE_SIGHAND) { // CLONE_SIGHAND è¡¨ç¤ºå…±äº«ä¿¡å·å¤„ç†ç¨‹åº refcount_inc(\u0026current-\u003esighand-\u003ecount); // å¼•ç”¨è®¡æ•°åŠ 1 return 0; } // æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹ä¿¡å·å¤„ç†ç¨‹åº sig = kmem_cache_alloc(sighand_cachep, GFP_KERNEL); RCU_INIT_POINTER(tsk-\u003esighand, sig); if (!sig) return -ENOMEM; refcount_set(\u0026sig-\u003ecount, 1); spin_lock_irq(\u0026current-\u003esighand-\u003esiglock); memcpy(sig-\u003eaction, current-\u003esighand-\u003eaction, sizeof(sig-\u003eaction)); spin_unlock_irq(\u0026current-\u003esighand-\u003esiglock); /* Reset all signal handler not set to SIG_IGN to SIG_DFL. */ if (clone_flags \u0026 CLONE_CLEAR_SIGHAND) flush_signal_handlers(tsk, 0); return 0; } 5ï¼‰ä¿¡å·ç»“æ„ä½“ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«ä¿¡å·ç»“æ„ä½“ å‡½æ•°copy_signalå¤åˆ¶æˆ–å…±äº«ä¿¡å·ç»“æ„ä½“\n// linux-5.10.102/kernel/fork.c static int copy_signal(unsigned long clone_flags, struct task_struct *tsk) { struct signal_struct *sig; if (clone_flags \u0026 CLONE_THREAD) // CLONE_THREADè¡¨ç¤ºåˆ›å»ºçº¿ç¨‹ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·ç»“æ„ä½“signal_struct return 0; // ä¸ºæ–°è¿›ç¨‹åˆ†é…ç»“æ„ä½“ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹èµ„æºé™åˆ¶ sig = kmem_cache_zalloc(signal_cachep, GFP_KERNEL); tsk-\u003esignal = sig; if (!sig) return -ENOMEM; sig-\u003enr_threads = 1; atomic_set(\u0026sig-\u003elive, 1); refcount_set(\u0026sig-\u003esigcnt, 1); /* list_add(thread_node, thread_head) without INIT_LIST_HEAD() */ sig-\u003ethread_head = (struct list_head)LIST_HEAD_INIT(tsk-\u003ethread_node); tsk-\u003ethread_node = (struct list_head)LIST_HEAD_INIT(sig-\u003ethread_head); init_waitqueue_head(\u0026sig-\u003ewait_chldexit); sig-\u003ecurr_target = tsk; init_sigpending(\u0026sig-\u003eshared_pending); INIT_HLIST_HEAD(\u0026sig-\u003emultiprocess); seqlock_init(\u0026sig-\u003estats_lock); prev_cputime_init(\u0026sig-\u003eprev_cputime); #ifdef CONFIG_POSIX_TIMERS INIT_LIST_HEAD(\u0026sig-\u003eposix_timers); hrtimer_init(\u0026sig-\u003ereal_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL); sig-\u003ereal_timer.function = it_real_fn; #endif task_lock(current-\u003egroup_leader); memcpy(sig-\u003erlim, current-\u003esignal-\u003erlim, sizeof sig-\u003erlim); task_unlock(current-\u003egroup_leader); posix_cpu_timers_init_group(sig); tty_audit_fork(sig); sched_autogroup_fork(sig); sig-\u003eoom_score_adj = current-\u003esignal-\u003eoom_score_adj; sig-\u003eoom_score_adj_min = current-\u003esignal-\u003eoom_score_adj_min; mutex_init(\u0026sig-\u003ecred_guard_mutex); init_rwsem(\u0026sig-\u003eexec_update_lock); return 0; } 6ï¼‰è™šæ‹Ÿå†…å­˜ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«è™šæ‹Ÿå†…å­˜ \\ å‡½æ•°copy_mmå¤åˆ¶æˆ–å…±äº«è™šæ‹Ÿå†…å­˜\n// linux-5.10.102/kernel/freezer.c static int copy_mm(unsigned long clone_flags, struct task_struct *tsk) { struct mm_struct *mm, *oldmm; int retval; tsk-\u003emin_flt = tsk-\u003emaj_flt = 0; tsk-\u003envcsw = tsk-\u003enivcsw = 0; #ifdef CONFIG_DETECT_HUNG_TASK tsk-\u003elast_switch_count = tsk-\u003envcsw + tsk-\u003enivcsw; tsk-\u003elast_switch_time = 0; #endif tsk-\u003emm = NULL; tsk-\u003eactive_mm = NULL; /* * Are we cloning a kernel thread? * * We need to steal a active VM for that.. */ oldmm = current-\u003emm; if (!oldmm) return 0; /* initialize the new vmacache entries */ vmacache_flush(tsk); if (clone_flags \u0026 CLONE_VM) { // CLONE_VMè¡¨ç¤ºå…±äº«è™šæ‹Ÿå†…å­˜ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å†…å­˜æè¿°ç¬¦mm_struct mmget(oldmm); mm = oldmm; goto good_mm; } retval = -ENOMEM; // æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ mm = dup_mm(tsk, current-\u003emm); if (!mm) goto fail_nomem; good_mm: tsk-\u003emm = mm; tsk-\u003eactive_mm = mm; return 0; fail_nomem: return retval; } 7ï¼‰å‘½åç©ºé—´ å‡½æ•°copy_namespaceåˆ›å»ºæˆ–å…±äº«å‘½åç©ºé—´\n// linux-5.10.102/kernel/nsproxy.c int copy_namespaces(unsigned long flags, struct task_struct *tsk) { struct nsproxy *old_ns = tsk-\u003ensproxy; struct user_namespace *user_ns = task_cred_xxx(tsk, user_ns); struct nsproxy *new_ns; int ret; // å¦‚æœå…±äº«é™¤äº†ç”¨æˆ·ä»¥å¤–çš„æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´ï¼Œ // é‚£ä¹ˆæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å‘½åç©ºé—´ä»£ç†ç»“æ„ä½“nsproxyï¼ŒæŠŠè®¡æ•°åŠ 1 if (likely(!(flags \u0026 (CLONE_NEWNS | CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNET | CLONE_NEWCGROUP | CLONE_NEWTIME)))) { if (likely(old_ns-\u003etime_ns_for_children == old_ns-\u003etime_ns)) { get_nsproxy(old_ns); return 0; } } else if (!ns_capable(user_ns, CAP_SYS_ADMIN)) // è¿›ç¨‹æ²¡æœ‰ç³»ç»Ÿç®¡ç†æƒé™ï¼Œé‚£ä¹ˆä¸å…è®¸åˆ›å»ºæ–°çš„å‘½åç©ºé—´ return -EPERM; /* CLONE_NEWIPC must detach from the undolist: after switching * to a new ipc namespace, the semaphore arrays from the old * namespace are unreachable. In clone parlance, CLONE_SYSVSEM * means share undolist with parent, so we must forbid using * it along with CLONE_NEWIPC. */ // æ—¢è¦æ±‚åˆ›å»ºæ–°çš„è¿›ç¨‹é—´é€šä¿¡å‘½åç©ºé—´ï¼Œåˆè¦æ±‚å…±äº«UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼Œé‚£ä¹ˆè¿™ç§è¦æ±‚æ˜¯ä¸åˆç†çš„ if ((flags \u0026 (CLONE_NEWIPC | CLONE_SYSVSEM)) == (CLONE_NEWIPC | CLONE_SYSVSEM)) return -EINVAL; // åˆ›å»ºæ–°çš„å‘½åç©ºé—´ä»£ç†ï¼Œç„¶ååˆ›å»ºæˆ–è€…å…±äº«å‘½åç©ºé—´ new_ns = create_new_namespaces(flags, tsk, user_ns, tsk-\u003efs); if (IS_ERR(new_ns)) return PTR_ERR(new_ns); ret = timens_on_fork(new_ns, tsk); if (ret) { free_nsproxy(new_ns); return ret; } tsk-\u003ensproxy = new_ns; return 0; } 8ï¼‰I/Oä¸Šä¸‹æ–‡ å‡½æ•°copy_ioåˆ›å»ºæˆ–å…±äº«I/Oä¸Šä¸‹æ–‡\n// linux-5.10.102/kernel/fork.c static int copy_io(unsigned long clone_flags, struct task_struct *tsk) { #ifdef CONFIG_BLOCK struct io_context *ioc = current-\u003eio_context; struct io_context *new_ioc; if (!ioc) return 0; /* Share io context with parent, if CLONE_IO is set */ if (clone_flags \u0026 CLONE_IO) { // CLONE_IO å…±äº«I/Oä¸Šå°æ–‡ ioc_task_link(ioc); // è®¡æ•°nr_tasksåŠ 1 tsk-\u003eio_context = ioc; // å…±äº«I/Oä¸Šä¸‹æ–‡ç»“æ„ä½“io_context } else if (ioprio_valid(ioc-\u003eioprio)) { // åˆ›å»ºæ–°çš„I/Oä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹çš„I/Oä¼˜å…ˆçº§ new_ioc = get_task_io_context(tsk, GFP_KERNEL, NUMA_NO_NODE); if (unlikely(!new_ioc)) return -ENOMEM; new_ioc-\u003eioprio = ioc-\u003eioprio; put_io_context(new_ioc); } #endif return 0; } 9ï¼‰å¤åˆ¶å¯„å­˜å™¨å€¼ å‡½æ•°copy_thread_tlså¤åˆ¶å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨å€¼ï¼Œå¹¶ä¿®æ”¹ä¸€éƒ¨åˆ†å¯„å­˜å™¨å€¼ã€‚è¿›ç¨‹æœ‰ä¸¤å¤„ç”¨æ¥ä¿å­˜å¯„å­˜å™¨å€¼ï¼šä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼æ—¶ï¼ŒæŠŠç”¨æˆ·æ¨¡å¼çš„å„ç§å¯„å­˜å™¨ä¿å­˜åœ¨å†…æ ¸æ ˆåº•éƒ¨çš„ç»“æ„ä½“pt_regsä¸­ï¼›è¿›ç¨‹è°ƒåº¦å™¨è°ƒåº¦è¿›ç¨‹æ—¶ï¼Œåˆ‡æ¢å‡ºå»çš„è¿›ç¨‹æŠŠå¯„å­˜å™¨å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜threadä¸­ã€‚å› ä¸ºä¸åŒå¤„ç†å™¨æ¶æ„çš„å¯„å­˜å™¨ä¸åŒï¼Œæ‰€ä»¥å„ç§å¤„ç†å™¨æ¶æ„éœ€è¦è‡ªå·±å®šä¹‰ç»“æ„ä½“pt_regså’Œthread_struct\nARM64æ¶æ„copy_thread_tls-\u003ecopy_thread\n// linux-5.10.102/arch/arm64/kernel/process.c int copy_thread(unsigned long clone_flags, unsigned long stack_start, unsigned long stk_sz, struct task_struct *p, unsigned long tls) { struct pt_regs *childregs = task_pt_regs(p); // æ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextæ¸…é›¶ï¼Œåœ¨è°ƒåº¦è¿›ç¨‹æ—¶åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹ä½¿ç”¨è¿™ä¸ªæˆå‘˜ä¿å­˜é€šç”¨å¯„å­˜å™¨çš„å€¼ memset(\u0026p-\u003ethread.cpu_context, 0, sizeof(struct cpu_context)); /* In case p was allocated the same task_struct pointer as some * other recently-exited task, make sure p is disassociated from * any cpu that may have run that now-exited task recently. * Otherwise we could erroneously skip reloading the FPSIMD * registers for p. */ fpsimd_flush_task_state(p); ptrauth_thread_init_kernel(p); if (likely(!(p-\u003eflags \u0026 PF_KTHREAD))) { // ç”¨æˆ·è¿›ç¨‹ *childregs = *current_pt_regs(); childregs-\u003eregs[0] = 0; /* Read the current TLS pointer from tpidr_el0 as it may be * out-of-sync with the saved value. * ä»å¯„å­˜å™¨tpidr_el0è¯»å–å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ï¼Œ * å› ä¸ºå®ƒå¯èƒ½å’Œä¿å­˜çš„å€¼ä¸ä¸€è‡´ */ *task_user_tls(p) = read_sysreg(tpidr_el0); if (stack_start) { if (is_compat_thread(task_thread_info(p))) childregs-\u003ecompat_sp = stack_start; else childregs-\u003esp = stack_start; } /* If a TLS pointer was passed to clone, use it for the new thread. * å¦‚æœæŠŠçº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ä¼ ç»™ç³»ç»Ÿè°ƒç”¨cloneçš„ç¬¬4ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ–°çº¿ç¨‹å°†ä½¿ç”¨å®ƒ*/ if (clone_flags \u0026 CLONE_SETTLS) p-\u003ethread.uw.tp_value = tls; } else { // å†…æ ¸çº¿ç¨‹ memset(childregs, 0, sizeof(struct pt_regs)); childregs-\u003epstate = PSR_MODE_EL1h; if (IS_ENABLED(CONFIG_ARM64_UAO) \u0026\u0026 cpus_have_const_cap(ARM64_HAS_UAO)) childregs-\u003epstate |= PSR_UAO_BIT; spectre_v4_enable_task_mitigation(p); if (system_uses_irq_prio_masking()) childregs-\u003epmr_save = GIC_PRIO_IRQON; p-\u003ethread.cpu_context.x19 = stack_start; p-\u003ethread.cpu_context.x20 = stk_sz; } p-\u003ethread.cpu_context.pc = (unsigned long)ret_from_fork; p-\u003ethread.cpu_context.sp = (unsigned long)childregs; ptrace_hw_copy_thread(p); return 0; } ï¼ˆ7ï¼‰è®¾ç½®è¿›ç¨‹å·å’Œè¿›ç¨‹å…³ç³» static __latent_entropy struct task_struct *copy_process( struct pid *pid, int trace, int node, struct kernel_clone_args *args) { // ä¸ºæ–°è¿›ç¨‹åˆ†é…è¿›ç¨‹å· // pidç­‰äºinit_struct_pidçš„åœ°å€ï¼Œå†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œå¼•å¯¼å¤„ç†å™¨ä¸ºæ¯ä¸ªä»å¤„ç†å™¨åˆ†å‰ç”Ÿæˆä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼ˆå‚è€ƒå‡½æ•°idle_threads_initï¼‰ï¼Œæ‰€æœ‰å¤„ç†å™¨çš„ç©ºé—²çº¿ç¨‹ä½¿ç”¨è¿›ç¨‹å·0ï¼Œå…¨å±€å˜é‡init_struct_pidå­˜æ”¾ç©ºé—²çº¿ç¨‹çš„è¿›ç¨‹å· if (pid != \u0026init_struct_pid) { pid = alloc_pid(p-\u003ensproxy-\u003epid_ns_for_children); if (IS_ERR(pid)) { retval = PTR_ERR(pid); goto bad_fork_cleanup_thread; } } â€¦ // è®¾ç½®æ–°è¿›ç¨‹é€€å‡ºæ—¶å‘é€ç»™çˆ¶è¿›ç¨‹çš„ä¿¡å· p-\u003epid = pid_nr(pid); if (clone_flags \u0026 CLONE_THREAD) { p-\u003eexit_signal = -1; // æ–°çº¿ç¨‹é€€å‡ºæ—¶ä¸éœ€è¦å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹ p-\u003egroup_leader = current-\u003egroup_leader; // group_leaderæŒ‡å‘åŒä¸€ä¸ªç»„é•¿ p-\u003etgid = current-\u003etgid; // tgidå­˜æ”¾ç»„é•¿çš„è¿›ç¨‹å· } else { if (clone_flags \u0026 CLONE_PARENT) // CLONE_PARENT æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ˜¯å…„å¼Ÿå…³ç³» p-\u003eexit_signal = current-\u003egroup_leader-\u003eexit_signal; // æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalç­‰äºå½“å‰è¿›ç¨‹æ‰€å±çº¿ç¨‹ç»„çš„ç»„é•¿çš„æˆå‘˜exit_signal else // çˆ¶å­å…³ç³» p-\u003eexit_signal = (clone_flags \u0026 CSIGNAL); // æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalæ˜¯è°ƒç”¨è€…æŒ‡å®šçš„ä¿¡å· p-\u003egroup_leader = p; p-\u003etgid = p-\u003epid; } // æ§åˆ¶ç»„çš„è¿›ç¨‹æ•°æ§åˆ¶å™¨æ£€æŸ¥æ˜¯å¦å…è®¸åˆ›å»ºæ–°è¿›ç¨‹ï¼š // ä»å½“å‰è¿›ç¨‹æ‰€å±çš„æ§åˆ¶ç»„ä¸€ç›´åˆ°æ§åˆ¶ç»„å±‚çº§çš„æ ¹ï¼Œ // å¦‚æœå…¶ä¸­ä¸€ä¸ªæ§åˆ¶ç»„çš„è¿›ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºé™åˆ¶ï¼Œ // é‚£ä¹ˆä¸å…è®¸ä½¿ç”¨forkå’Œcloneåˆ›å»ºæ–°è¿›ç¨‹ cgroup_threadgroup_change_begin(current); retval = cgroup_can_fork(p); if (retval) goto bad_fork_free_pid; write_lock_irq(\u0026tasklist_lock); // ä¸ºæ–°è¿›ç¨‹è®¾ç½®çˆ¶è¿›ç¨‹ if (clone_flags \u0026 (CLONE_PARENT|CLONE_THREAD)) { // æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ‹¥æœ‰ç›¸åŒçš„çˆ¶è¿›ç¨‹ p-\u003ereal_parent = current-\u003ereal_parent; p-\u003eparent_exec_id = current-\u003eparent_exec_id; } else { p-\u003ereal_parent = current; // æ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯å½“å‰è¿›ç¨‹ p-\u003eparent_exec_id = current-\u003eself_exec_id; } â€¦ spin_lock(\u0026current-\u003esighand-\u003esiglock); â€¦ if (likely(p-\u003epid)) { â€¦ init_task_pid(p, PIDTYPE_PID, pid); if (thread_group_leader(p)) { // true æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„ init_task_pid(p, PIDTYPE_PGID, task_pgrp(current)); // æŒ‡å‘åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿çš„è¿›ç¨‹å·ç»“æ„ä½“ init_task_pid(p, PIDTYPE_SID, task_session(current)); // æŒ‡å‘åŒä¸€ä¸ªä¼šè¯çš„æ§åˆ¶è¿›ç¨‹çš„è¿›ç¨‹å·ç»“æ„ä½“ if (is_child_reaper(pid)) { ns_of_pid(pid)-\u003echild_reaper = p; p-\u003esignal-\u003eflags |= SIGNAL_UNKILLABLE; // 1å·è¿›ç¨‹æ˜¯ä¸èƒ½æ€æ­»çš„ } p-\u003esignal-\u003eleader_pid = pid; p-\u003esignal-\u003etty = tty_kref_get(current-\u003esignal-\u003etty); p-\u003esignal-\u003ehas_child_subreaper = p-\u003ereal_parent-\u003esignal-\u003e has_child_subreaper || p-\u003ereal_parent-\u003esignal-\u003eis_child_subreaper; list_add_tail(\u0026p-\u003esibling, \u0026p-\u003ereal_parent-\u003echildren); // æ–°è¿›ç¨‹æ·»åŠ åˆ°çˆ¶è¿›ç¨‹çš„å­è¿›ç¨‹é“¾è¡¨ // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹é“¾è¡¨ä¸­ï¼Œé“¾è¡¨èŠ‚ç‚¹æ˜¯æˆå‘˜tasksï¼Œ // å¤´èŠ‚ç‚¹æ˜¯ç©ºé—²çº¿ç¨‹çš„æˆå‘˜tasksï¼ˆinit_task.tasksï¼‰ list_add_tail_rcu(\u0026p-\u003etasks, \u0026init_task.tasks); attach_pid(p, PIDTYPE_PGID); // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹ç»„çš„è¿›ç¨‹é“¾è¡¨ attach_pid(p, PIDTYPE_SID); // æ–°è¿›ç¨‹æ·»åŠ åˆ°ä¼šè¯çš„è¿›ç¨‹é“¾è¡¨ __this_cpu_inc(process_counts); } else { // åˆ›å»ºçº¿ç¨‹ current-\u003esignal-\u003enr_threads++; // çº¿ç¨‹ç»„çš„çº¿ç¨‹è®¡æ•°å€¼åŠ 1 atomic_inc(\u0026current-\u003esignal-\u003elive); // åŸå­å˜é‡çº¿ç¨‹ç»„çš„ç¬¬2ä¸ªçº¿ç¨‹è®¡æ•°å€¼åŠ 1 atomic_inc(\u0026current-\u003esignal-\u003esigcnt); // ä¿¡å·ç»“æ„ä½“çš„å¼•ç”¨è®¡æ•°åŠ 1 list_add_tail_rcu(\u0026p-\u003ethread_group, \u0026p-\u003egroup_leader-\u003ethread_group); // çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„çº¿ç¨‹é“¾è¡¨ list_add_tail_rcu(\u0026p-\u003ethread_node, \u0026p-\u003esignal-\u003ethread_head); // çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„ç¬¬äºŒæ¡çº¿ç¨‹é“¾è¡¨ } attach_pid(p, PIDTYPE_PID); // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨ nr_threads++; // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨ } total_forks++; spin_unlock(\u0026current-\u003esighand-\u003esiglock); â€¦ write_unlock_irq(\u0026tasklist_lock); proc_fork_connector(p); cgroup_post_fork(p); cgroup_threadgroup_change_end(current); â€¦ return p; } 3.å”¤é†’æ–°è¿›ç¨‹ wake_up_new_taskå‡½æ•°å”¤é†’æ–°è¿›ç¨‹\n// linux-5.10.102/kernel/sched/core.c void wake_up_new_task(struct task_struct *p) { struct rq_flags rf; struct rq *rq; raw_spin_lock_irqsave(\u0026p-\u003epi_lock, rf.flags); p-\u003estate = TASK_RUNNING; // åˆ‡æ¢TASK_RUNNING #ifdef CONFIG_SMP /* Fork balancing, do it here and not earlier because: * - cpus_ptr can change in the fork path * - any previously selected CPU might disappear through hotplug * Use __set_task_cpu() to avoid calling sched_class::migrate_task_rq, * as we're not fully set-up yet.*/ p-\u003erecent_used_cpu = task_cpu(p); rseq_migrate(p); __set_task_cpu(p, select_task_rq(p, task_cpu(p), SD_BALANCE_FORK, 0)); // åœ¨SMPç³»ç»Ÿä¸Šï¼Œåˆ›å»ºæ–°è¿›ç¨‹æ˜¯æ‰§è¡Œè´Ÿè½½å‡è¡¡çš„ç»ä½³æ—¶æœºï¼Œä¸ºæ–°è¿›ç¨‹é€‰æ‹©ä¸€ä¸ªè´Ÿè½½æœ€è½»çš„å¤„ç†å™¨ #endif rq = __task_rq_lock(p, \u0026rf); // é”ä½è¿è¡Œé˜Ÿåˆ— update_rq_clock(rq); // æ›´æ–°è¿è¡Œé˜Ÿåˆ—çš„æ—¶é’Ÿ post_init_entity_util_avg(p); // æ ¹æ®å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼ï¼Œæ¨ç®—æ–°è¿›ç¨‹çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼ activate_task(rq, p, ENQUEUE_NOCLOCK); // æŠŠæ–°è¿›ç¨‹æ’å…¥è¿è¡Œé˜Ÿåˆ— trace_sched_wakeup_new(p); check_preempt_curr(rq, p, WF_FORK); // æ£€æŸ¥æ–°è¿›ç¨‹æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿›ç¨‹ #ifdef CONFIG_SMP if (p-\u003esched_class-\u003etask_woken) { // åœ¨SMPç³»ç»Ÿä¸Šï¼Œè°ƒç”¨è°ƒåº¦ç±»çš„task_wokenæ–¹æ³• /* Nothing relies on rq-\u003elock after this, so its fine to * drop it.*/ rq_unpin_lock(rq, \u0026rf); p-\u003esched_class-\u003etask_woken(rq, p); rq_repin_lock(rq, \u0026rf); } #endif task_rq_unlock(rq, p, \u0026rf); // é‡Šæ”¾è¿è¡Œé˜Ÿåˆ—çš„é” } 4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæ˜¯ä»å‡½æ•°ret_from_forkå¼€å§‹æ‰§è¡Œï¼ŒARM64çš„ret_from_forkå‡½æ•°\n// linux-5.10.102/arch/arm64/kernel/entry.S tsk .req x28 //å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€ SYM_CODE_START(ret_from_fork) bl\tschedule_tail // ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ cbz\tx19, 1f // not a kernel thread å¦‚æœå¯„å­˜å™¨x19çš„å€¼æ˜¯0ï¼Œè¯´æ˜å½“å‰è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ ‡å·1 mov\tx0, x20 // å†…æ ¸çº¿ç¨‹ï¼šx19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œx20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•° blr\tx19 // è°ƒç”¨çº¿ç¨‹å‡½æ•° 1:\tget_current_task tsk // ç”¨æˆ·è¿›ç¨‹ï¼šx28 = sp_el0 = å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€ b\tret_to_user // è¿”å›ç”¨æˆ·æ¨¡å¼ SYM_CODE_END(ret_from_fork) NOKPROBE(ret_from_fork) copy_threadå‡½æ•°ä¸­ï¼Œæ–°è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œå¯„å­˜å™¨x19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œå¯„å­˜å™¨x20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœæ–°è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œå¯„å­˜å™¨x19å€¼æ˜¯0 // linux-5.10.102/kernel/sched/core.c asmlinkage __visible void schedule_tail(struct task_struct *prev) __releases(rq-\u003elock) { struct rq *rq; /* New tasks start with FORK_PREEMPT_COUNT, see there and * finish_task_switch() for details. * * finish_task_switch() will drop rq-\u003elock() and lower preempt_count * and the preempt_enable() will end up enabling preemption (on * PREEMPT_COUNT kernels).*/ rq = finish_task_switch(prev); // ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ2.8.6 balance_callback(rq); // æ‰§è¡Œè¿è¡Œé˜Ÿåˆ—çš„æ‰€æœ‰è´Ÿè½½å‡è¡¡å›è°ƒå‡½æ•° preempt_enable(); // å¼€å¯å†…æ ¸æŠ¢å  if (current-\u003eset_child_tid) // pthreadåº“åœ¨è°ƒç”¨clone()åˆ›å»ºçº¿ç¨‹æ—¶è®¾ç½®äº†æ ‡å¿—ä½CLONE_CHILD_SETTIDï¼Œé‚£ä¹ˆæ–°è¿›ç¨‹æŠŠè‡ªå·±çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°æŒ‡å®šä½ç½® put_user(task_pid_vnr(current), current-\u003eset_child_tid); calculate_sigpending(); } 2.4.2 è£…è½½ç¨‹åº è°ƒåº¦å™¨è°ƒåº¦æ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹ä»å‡½æ•°ret_from_forkå¼€å§‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨forkè¿”å›ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å€¼0ã€‚ç„¶åæ–°è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨execveè£…è½½ç¨‹åºã€‚Linuxå†…æ ¸ç»ƒä¸ªè£…è½½ç¨‹åºç³»ç»Ÿè°ƒç”¨ï¼š \\\n// è·¯å¾„åæ˜¯ç›¸å¯¹æ—¶execveè§£é‡Šä¸ºç›¸å¯¹è°ƒç”¨è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½• int execve(const char *filename, char *const argv[], char *const envp[]); // è·¯å¾„åæ˜¯ç›¸å¯¹çš„ï¼Œexecveatè§£é‡Šä¸ºç›¸å¯¹æ–‡ä»¶æè¿°ç¬¦dirfdæŒ‡å‘çš„ç›®å½• // è·¯å¾„åæ—¶ç»å¯¹çš„ï¼Œexecveatå¿½ç•¥å‚æ•°dirfd int execveat(int dirfd, const char *pathname, char *const argv[], char *const envp[], int flags); å‚æ•°argvæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„å‚æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²çš„åœ°å€ï¼Œargv[0]åº”è¯¥æŒ‡å‘è¦è£…è½½çš„ç¨‹åºçš„åç§°ã€‚å‚æ•°envpæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„ç¯å¢ƒæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªç¯å¢ƒå­—ç¬¦ä¸²çš„åœ°å€ï¼Œç¯å¢ƒå­—ç¬¦ä¸²çš„å½¢å¼æ˜¯â€œé”®=å€¼\nä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½è°ƒç”¨å‡½æ•°do_execveat_common å‡½æ•°do_open_execatæ‰“å¼€å¯æ‰§è¡Œæ–‡ä»¶ã€‚ å‡½æ•°sched_execã€‚è£…è½½ç¨‹åºæ˜¯å®ç°å¤„ç†å™¨è´Ÿè½½å‡è¡¡çš„æœºä¼šï¼Œæ­¤æ—¶è¿›ç¨‹åœ¨å†…å­˜å’Œç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€å°‘çš„ã€‚é€‰æ‹©è´Ÿè½½æœ€è½»çš„å¤„ç†å™¨ï¼Œç„¶åå”¤é†’å½“å‰å¤„ç†å™¨ä¸Šçš„è¿ç§»çº¿ç¨‹ï¼Œå½“å‰è¿›ç¨‹ç¡çœ ç­‰å¾…è¿ç§»çº¿ç¨‹æŠŠè‡ªå·±è¿ç§»åˆ°ç›®æ ‡å¤„ç†å™¨ å‡½æ•°bprm_mm_initåˆ›å»ºæ–°çš„å†…å­˜æè¿°ç¬¦ï¼Œåˆ†é…é•¿åº¦ä¸ºä¸€é¡µçš„ä¸´æ—¶çš„ç”¨æˆ·æ ˆï¼Œè™šæ‹Ÿåœ°å€èŒƒå›´æ˜¯[STACK_TOP_MAXâˆ’é¡µé•¿åº¦ï¼ŒSTACK_TOP_MAX]ï¼Œbprm-\u003epæŒ‡å‘åœ¨æ ˆåº•ä¿ç•™ä¸€ä¸ªå­—é•¿ï¼ˆæŒ‡é’ˆé•¿åº¦ï¼‰åçš„ä½ç½® å‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»æ–‡ä»¶çš„å‰é¢128å­—èŠ‚åˆ°ç¼“å†²åŒºã€‚128å­—èŠ‚æ˜¯ä»€ä¹ˆï¼Ÿ \\ ä¾æ¬¡æŠŠæ–‡ä»¶åç§°ã€ç¯å¢ƒå­—ç¬¦ä¸²å’Œå‚æ•°å­—ç¬¦ä¸²å‹åˆ°ç”¨æˆ·æ ˆ å‡½æ•°exec_binprmè°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«æ­£åœ¨è£…è½½çš„ç¨‹åºä¸ºæ­¢\n1.äºŒè¿›åˆ¶æ ¼å¼ LinuxäºŒè¿›åˆ¶æ ¼å¼\n// linux-5.10.102/include/linux/binfmts.h struct linux_binfmt { struct list_head lh; struct module *module; int (*load_binary)(struct linux_binprm *); int (*load_shlib)(struct file *); int (*core_dump)(struct coredump_params *cprm); unsigned long min_coredump;\t/* minimal dump size */ } __randomize_layout; äºŒè¿›åˆ¶æ ¼å¼æä¾›3ä¸ªå‡½æ•° (1)load_binary åŠ è½½æ™®é€šç¨‹åº (2)load_shlib åŠ è½½å…±äº«åº“ (3)core_dump åœ¨è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œmin_coredumpæŒ‡å®šæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶çš„æœ€å°é•¿åº¦ äºŒè¿›åˆ¶æ ¼å¼ä½¿ç”¨register_binfmtå‘å†…æ ¸æ³¨å†Œ\n2.è£…è½½ELFç¨‹åº ELFæ–‡ä»¶,ELF(Executable and Linkable Format)å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼ linux-5.10.102/include/uapi/linux/elf.h\nç›®æ ‡æ–‡ä»¶(å¯é‡å®šä½æ–‡ä»¶)ï¼Œ.oï¼Œå¤šä¸ªæ¨¡æ¿æ–‡ä»¶é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ å¯æ‰§è¡Œæ–‡ä»¶ å…±äº«åº“ .so æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶(core dump file) ELFæ–‡ä»¶åˆ†æˆ4éƒ¨åˆ†ï¼šELFé¦–éƒ¨ã€ç¨‹åºé¦–éƒ¨è¡¨(programe header table)ã€èŠ‚(section)å’ŒèŠ‚é¦–éƒ¨è¡¨(section header table)ï¼ŒELFåªæœ‰é¦–éƒ¨çš„ä½ç½®æ˜¯å›ºå®šçš„ã€‚\nç¨‹åºé¦–éƒ¨è¡¨å°±æ˜¯æ®µè¡¨(segment table)ï¼Œæ®µ(segment)æ˜¯ä»è¿è¡Œè§’åº¦æè¿°ï¼ŒèŠ‚(section)æ˜¯ä»é“¾æ¥è§’åº¦æè¿°ã€‚ 64ä½ELFæ–‡ä»¶æ ¼å¼\nå‚è€ƒé“¾æ¥ï¼š ELF æ ¼å¼è¯¦è§£ https://blog.csdn.net/shanandqiu/article/details/115206426 ELFæ–‡ä»¶æ ¼å¼ç®€ä»‹ https://blog.csdn.net/GrayOnDream/article/details/124564129\n# æŸ¥çœ‹ELFé¦–éƒ¨ readelf -h # æŸ¥çœ‹ç¨‹åºé¦–éƒ¨è¡¨ readelf -l # æŸ¥çœ‹èŠ‚é¦–éƒ¨è¡¨ readelf -S ELFè§£æç¨‹åº linux-5.10.102/fs/binfmt_elf.c è§£æ64ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ— å…³ linux-5.10.102/fs/compat_binfmt_elf.c åœ¨64ä½å†…æ ¸ä¸­è§£æ32ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ—  \\\nè£…è½½ELFç¨‹åºå‡½æ•°load_elf_binary\n1ï¼‰æ£€æŸ¥ELFé¦–éƒ¨ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ï¼Œæ£€æŸ¥å¤„ç†å™¨æ¶æ„ 2ï¼‰è¯»å–ç¨‹åºé¦–éƒ¨è¡¨ 3ï¼‰ç¨‹åºé¦–éƒ¨è¡¨ä¸­æŸ¥æ‰¾è§£é‡Šå™¨æ®µï¼Œå¦‚ç¨‹åºéœ€è¦é“¾æ¥åŠ¨æ€åº“ï¼Œå­˜åœ¨è§£é‡Šå™¨æ®µï¼Œä»è§£é‡Šå™¨æ®µè¯»å–è§£é‡Šå™¨çš„æ–‡ä»¶åç§°ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–ELFé¦–éƒ¨ã€‚ 4ï¼‰æ£€æŸ¥è§£é‡Šå™¨çš„ELFé¦–éƒ¨ï¼Œè¯»å–è§£é‡Šå™¨çš„ç¨‹åºé¦–éƒ¨è¡¨ 5ï¼‰flush_old_execå‡½æ•°ç»ˆæ­¢çº¿ç¨‹ç»„ä¸­å…¶ä»–çº¿ç¨‹ï¼Œé‡Šæ”¾æ—§çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ 6ï¼‰setup_new_execå‡½æ•°è°ƒç”¨arch_pick_mmap_layoutè®¾ç½®å†…å­˜æ˜ å°„çš„å¸ƒå±€ï¼Œåœ¨å †å’Œæ ˆç›´æ¥æœ‰ä¸€ä¸ªå†…å­˜æ˜ å°„åŒºåŸŸ 7ï¼‰ä¹‹å‰è°ƒç”¨bprm_mm_initå‡½æ•°åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ ˆï¼Œè°ƒç”¨set_arg_pageså‡½æ•°æŠŠç”¨æˆ·æ ˆå®šä¸‹æ¥ï¼Œæ›´æ–°ç”¨æˆ·æ ˆæ ‡å¿—ä½å’Œè®¿é—®æƒé™ï¼ŒæŠŠç”¨æˆ·æ ˆç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®ï¼Œå¹¶æ‰©å¤§ç”¨æˆ·æ ˆ 8ï¼‰æŠŠå¯åŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ 9ï¼‰setbrkå‡½æ•°æŠŠåˆå§‹åŒ–æ•°æ®æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶è®¾ç½®å †çš„èµ·å§‹è™šæ‹Ÿåœ°å€ï¼Œè°ƒç”¨padzeroå‡½æ•°ç”¨é›¶å¡«å……æœªåˆå§‹åŒ–æ•°æ®æ®µ 10ï¼‰å¾—åˆ°ç¨‹åºå…¥å£ã€‚ç¨‹åºæœ‰è§£é‡Šå™¨æ®µï¼ŒåŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç¨‹åºå…¥å£åˆ‡æ¢ä¸ºè§£é‡Šå™¨ç¨‹åºå…¥å£ 11ï¼‰è°ƒç”¨create_elf_tablesä¾æ¬¡æŠŠä¼ é€’ELFè§£é‡Šå™¨ä¿¡æ¯çš„è¾…åŠ©å‘é‡ã€ç¯å¢ƒæŒ‡é’ˆæ•°ç»„envpã€å‚æ•°æŒ‡é’ˆæ•°ç»„argvå’Œå‚æ•°ä¸ªæ•°argcå‹åˆ°è¿›ç¨‹çš„ç”¨æˆ·æ ˆ 12ï¼‰è°ƒç”¨å‡½æ•°start_threadè®¾ç½®ç»“æ„ä½“pt_regsä¸­ç¨‹åºè®¡æ•°å™¨å’Œæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒARM64æ¶æ„å®šä¹‰çš„å‡½æ•°start_thread\n// linux-5.10.102/arch/arm64/include/asm/processor.h static inline void start_thread_common(struct pt_regs *regs, unsigned long pc) { memset(regs, 0, sizeof(*regs)); forget_syscall(regs); regs-\u003epc = pc; /* æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ */ } static inline void start_thread(struct pt_regs *regs, unsigned long pc, unsigned long sp) { start_thread_common(regs, pc); regs-\u003epstate = PSR_MODE_EL0t; /* æŠŠå¤„ç†å™¨çŠ¶æ€è®¾ç½®ä¸º0ï¼Œå…¶ä¸­å¼‚å¸¸çº§åˆ«æ˜¯0 */ spectre_v4_enable_task_mitigation(current); regs-\u003esp = sp; /*è®¾ç½®ç”¨æˆ·æ ˆæŒ‡é’ˆ */ } 3.è£…è½½è„šæœ¬ç¨‹åº è„šæœ¬ç¨‹åºå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯#!ï¼Œåé¢æ˜¯è§£é‡Šå™¨ç¨‹åºçš„åç§°å’Œå‚æ•°ã€‚è§£é‡Šå™¨ç”¨æ¥æ‰§è¡Œè„šæœ¬ç¨‹åº linux-5.10.102/fs/binfmt_script.cå‡½æ•°load_scriptè´Ÿè´£è£…è½½è„šæœ¬ç¨‹åº\n1ï¼‰æ£€æŸ¥å‰ä¸¤ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯è„šæœ¬ç¨‹åºçš„æ ‡è¯†ç¬¦ 2ï¼‰è§£æå¤„è§£é‡Šç¨‹åºçš„åç§°å’Œå‚æ•° 3ï¼‰ä»ç”¨æˆ·æ ˆåˆ é™¤ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¾æ¬¡æŠŠè„šæœ¬ç¨‹åºçš„æ–‡ä»¶åç§°ã€ä¼ ç»™è§£é‡Šç¨‹åºçš„å‚æ•°å’Œè§£é‡Šç¨‹åºçš„åç§°å‹åˆ°ç”¨æˆ·æ ˆ 4ï¼‰è°ƒç”¨opens_execæ‰“å¼€è§£é‡Šç¨‹åºæ–‡ä»¶ 5ï¼‰è°ƒç”¨å‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»å–è§£é‡Šç¨‹åºæ–‡ä»¶çš„å‰128å­—èŠ‚åˆ°ç¼“å†²åŒº 6ï¼‰è°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«è§£é‡Šç¨‹åºä¸ºæ­¢ \\\n2.6 è¿›ç¨‹é€€å‡º è¿›ç¨‹é€€å‡ºä¸¤ç§æƒ…å†µï¼šè¿›ç¨‹ä¸»åŠ¨é€€å‡ºå’Œç»ˆæ­¢è¿›ç¨‹ Linuxå†…æ ¸ä¸¤ä¸ªä¸»åŠ¨é€€å‡ºçš„ç³»ç»Ÿè°ƒç”¨ \\\n// çº¿ç¨‹é€€å‡º void exit(int status); // ä¸€ä¸ªçº¿ç¨‹ç»„æ‰€æœ‰çº¿ç¨‹é€€å‡º void exit_group(int status); glibcåº“å‡½æ•°exitã€_exitå’Œ_Exitç”¨æ¥ä½¿è¿›ç¨‹é€€å‡ºï¼Œåº“å‡½æ•°è°ƒç”¨ç³»ç»Ÿè°ƒç”¨exit_groupã€‚åº“å‡½æ•°exitä¼šæ‰§è¡Œè¿›ç¨‹ä½¿ç”¨çš„atexitå’Œos_exitæ³¨å†Œçš„å‡½æ•° ç»ˆæ­¢è¿›ç¨‹æ˜¯é€€å‡ºç»™è¿›ç¨‹å‘é€ä¿¡å·å®ç°çš„ï¼ŒLinuxè®·æ²³å‘é€ä¿¡å·çš„ç³»ç»Ÿè°ƒç”¨\n// // å‘é€ä¿¡å·ç»™è¿›ç¨‹æˆ–è¿›ç¨‹ç»„ int kill(pid_t pid, int sig); // å‘é€ä¿¡å·ç»™çº¿ç¨‹ å·²åºŸå¼ƒ int tkill(int tid, int sig); // å‘é€ä¿¡å·ç»™çº¿ç¨‹ int tgkill(int tgid, int tid, int sig); çˆ¶è¿›ç¨‹æ˜¯å¦å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹å‡ï¼Œ 1ï¼‰çˆ¶è¿›ç¨‹å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶é‡Šæ”¾å„ç§èµ„æºï¼Œç•™ç©ºè¿›ç¨‹æè¿°ç¬¦çš„åƒµå°¸è¿›ç¨‹ï¼Œå‘é€ä¿¡å·SIGCHLD(CHILDæ˜¯child)é€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æŸ¥è¯¢è¿›ç¨‹ç»ˆæ­¢åŸå› ä»å­è¿›ç¨‹æ”¶å›è¿›ç¨‹æè¿°ç¬¦ã€‚ 2ï¼‰çˆ¶è¿›ç¨‹ä¸å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œè¿›ç¨‹é€€å‡ºæ˜¯é‡Šæ”¾å„ç§èµ„æºï¼Œé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦ \\\n",
  "wordCount" : "14547",
  "inLanguage": "en",
  "datePublished": "2022-10-05T00:17:58+08:00",
  "dateModified": "2022-10-05T00:17:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "Zain"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "zain's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://liuz0123.gitee.io/zain/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://liuz0123.gitee.io/zain/" accesskey="h" title="Zain&#39;s Blog (Alt + H)">
            <img src="https://liuz0123.gitee.io/zain/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Zain&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://liuz0123.gitee.io/zain/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/links" title="ğŸ¤ é—²è¨€ä¿—è¯­">
                <span>ğŸ¤ é—²è¨€ä¿—è¯­</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://liuz0123.gitee.io/zain/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
            <h1 class="post-title">
                Linuxå†…æ ¸æ·±åº¦è§£æ
            </h1>
            <div class="post-meta">Create:&nbsp;<span title='2022-10-05 00:17:58 +0800 CST'>2022-10-05</span>&nbsp;|&nbsp;Update:&nbsp;2022-10-05&nbsp;|&nbsp;Words:&nbsp;14547&nbsp;|&nbsp;&nbsp;30 min&nbsp;|&nbsp;
&nbsp;Zain



                &nbsp;|&nbsp;tags: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://liuz0123.gitee.io/zain/tags/tech/">tech</a>
                    <a href="https://liuz0123.gitee.io/zain/tags/linux/">ã€linux</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| Viewers: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%86%85%e5%ae%b9%e6%8f%90%e7%ba%b2" aria-label="å†…å®¹æçº²">å†…å®¹æçº²</a></li>
                <li>
                    <a href="#%e7%ac%ac1%e7%ab%a0-%e5%86%85%e6%a0%b8%e5%bc%95%e5%af%bc%e5%92%8c%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#11-%e5%bc%95%e5%af%bc%e7%a8%8b%e5%ba%8f" aria-label="1.1 å¼•å¯¼ç¨‹åº">1.1 å¼•å¯¼ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#111-%e5%85%a5%e5%8f%a3_start" aria-label="1.1.1 å…¥å£_start">1.1.1 å…¥å£_start</a></li>
                <li>
                    <a href="#112-reset" aria-label="1.1.2 reset">1.1.2 <code>reset</code></a></li>
                <li>
                    <a href="#113-%e5%87%bd%e6%95%b0_main" aria-label="1.1.3 å‡½æ•°_main">1.1.3 å‡½æ•°_main</a></li>
                <li>
                    <a href="#114-%e5%87%bd%e6%95%b0run_main_loop" aria-label="1.1.4 å‡½æ•°run_main_loop">1.1.4 å‡½æ•°run_main_loop</a></li></ul>
                </li>
                <li>
                    <a href="#12-%e5%86%85%e6%a0%b8%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="1.2 å†…æ ¸åˆå§‹åŒ–">1.2 å†…æ ¸åˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#121-%e6%b1%87%e7%bc%96%e8%af%ad%e8%a8%80%e9%83%a8%e5%88%86" aria-label="1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†</a></li>
                <li>
                    <a href="#122-c%e8%af%ad%e8%a8%80%e9%83%a8%e5%88%86" aria-label="1.2.2 Cè¯­è¨€éƒ¨åˆ†">1.2.2 Cè¯­è¨€éƒ¨åˆ†</a></li>
                <li>
                    <a href="#123-smp%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%95%e5%af%bc" aria-label="1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼">1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼</a></li></ul>
                </li>
                <li>
                    <a href="#13-init%e8%bf%9b%e7%a8%8b" aria-label="1.3 initè¿›ç¨‹">1.3 initè¿›ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac2%e7%ab%a0-%e8%bf%9b%e7%a8%8b%e7%ae%a1%e7%90%86" aria-label="ç¬¬2ç«  è¿›ç¨‹ç®¡ç†">ç¬¬2ç«  è¿›ç¨‹ç®¡ç†</a><ul>
                        
                <li>
                    <a href="#21-%e8%bf%9b%e7%a8%8b" aria-label="2.1 è¿›ç¨‹">2.1 è¿›ç¨‹</a></li>
                <li>
                    <a href="#22-%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4" aria-label="2.2 å‘½åç©ºé—´">2.2 å‘½åç©ºé—´</a></li>
                <li>
                    <a href="#23-%e8%bf%9b%e7%a8%8b%e6%a0%87%e8%af%86%e7%ac%a6" aria-label="2.3 è¿›ç¨‹æ ‡è¯†ç¬¦">2.3 è¿›ç¨‹æ ‡è¯†ç¬¦</a></li>
                <li>
                    <a href="#24-%e8%bf%9b%e7%a8%8b%e5%85%b3%e7%b3%bb" aria-label="2.4 è¿›ç¨‹å…³ç³»">2.4 è¿›ç¨‹å…³ç³»</a></li>
                <li>
                    <a href="#24-%e5%90%af%e5%8a%a8%e7%a8%8b%e5%ba%8f" aria-label="2.4 å¯åŠ¨ç¨‹åº">2.4 å¯åŠ¨ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#241%e5%88%9b%e5%bb%ba%e6%96%b0%e8%bf%9b%e7%a8%8b" aria-label="2.4.1ã€€åˆ›å»ºæ–°è¿›ç¨‹">2.4.1ã€€åˆ›å»ºæ–°è¿›ç¨‹</a><ul>
                        
                <li>
                    <a href="#1-_do_fork%e5%87%bd%e6%95%b0" aria-label="1. _do_forkå‡½æ•°">1. _do_forkå‡½æ•°</a></li>
                <li>
                    <a href="#2-copy_process%e5%87%bd%e6%95%b0" aria-label="2. copy_processå‡½æ•°">2. copy_processå‡½æ•°</a></li>
                <li>
                    <a href="#3%e5%94%a4%e9%86%92%e6%96%b0%e8%bf%9b%e7%a8%8b" aria-label="3.å”¤é†’æ–°è¿›ç¨‹">3.å”¤é†’æ–°è¿›ç¨‹</a></li>
                <li>
                    <a href="#4%e6%96%b0%e8%bf%9b%e7%a8%8b%e7%ac%ac%e4%b8%80%e6%ac%a1%e8%bf%90%e8%a1%8c" aria-label="4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ">4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ</a></li></ul>
                </li>
                <li>
                    <a href="#242-%e8%a3%85%e8%bd%bd%e7%a8%8b%e5%ba%8f" aria-label="2.4.2 è£…è½½ç¨‹åº">2.4.2 è£…è½½ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#1%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%a0%bc%e5%bc%8f" aria-label="1.äºŒè¿›åˆ¶æ ¼å¼">1.äºŒè¿›åˆ¶æ ¼å¼</a></li>
                <li>
                    <a href="#2%e8%a3%85%e8%bd%bdelf%e7%a8%8b%e5%ba%8f" aria-label="2.è£…è½½ELFç¨‹åº">2.è£…è½½ELFç¨‹åº</a></li>
                <li>
                    <a href="#3%e8%a3%85%e8%bd%bd%e8%84%9a%e6%9c%ac%e7%a8%8b%e5%ba%8f" aria-label="3.è£…è½½è„šæœ¬ç¨‹åº">3.è£…è½½è„šæœ¬ç¨‹åº</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#26-%e8%bf%9b%e7%a8%8b%e9%80%80%e5%87%ba" aria-label="2.6 è¿›ç¨‹é€€å‡º">2.6 è¿›ç¨‹é€€å‡º</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="å†…å®¹æçº²">å†…å®¹æçº²<a hidden class="anchor" aria-hidden="true" href="#å†…å®¹æçº²">#</a></h1>
<ul>
<li>å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot</li>
<li>å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹</li>
<li>å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜</li>
<li>å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼</li>
<li>ä¿æŠ¤ä¸´ç•ŒåŒºçš„äº’æ–¥</li>
<li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</li>
</ul>
<h1 id="ç¬¬1ç« -å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1ç« -å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">#</a></h1>
<p>â€‚å¤„ç†å™¨ä¸Šç”µ-&gt;æ‰§è¡Œå¼•å¯¼ç¨‹åº-&gt;åŠ è½½å†…æ ¸åˆ°å†…å­˜-&gt;æ‰§è¡Œå†…æ ¸-&gt;å†…æ ¸åˆå§‹åŒ–-&gt;å¯åŠ¨ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹
â€ƒARM64å¤„ç†å™¨åˆ°ç‰©ç†åœ°å€0å–ç¬¬ä¸€æ¡æŒ‡ä»¤</p>
<h2 id="11-å¼•å¯¼ç¨‹åº">1.1 å¼•å¯¼ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#11-å¼•å¯¼ç¨‹åº">#</a></h2>
<h3 id="111-å…¥å£_start">1.1.1 å…¥å£_start<a hidden class="anchor" aria-hidden="true" href="#111-å…¥å£_start">#</a></h3>
<p>â€ƒARM64å¤„ç†å™¨U-Bootç¨‹åºæ‰§è¡Œè¿‡ç¨‹ï¼Œå…¥å£<a href="https://elixir.bootlin.com/u-boot/latest/source/arch/arm/cpu/armv8/start.S#L20"><code>u-boot/arch/arm/cpu/armv8/start.S</code></a>æ ‡è¯†<code>_start</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.globl	_start
</span></span><span style="display:flex;"><span>_start:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_LINUX_KERNEL_IMAGE_HEADER)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/boot0-linux-kernel-header.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/arch/boot0.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b	reset
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><h3 id="112-reset">1.1.2 <code>reset</code><a hidden class="anchor" aria-hidden="true" href="#112-reset">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>reset:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Allow the board to save important registers */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å…è®¸æ¿å¡ä¿å­˜é‡è¦çš„å¯„å­˜å™¨*/</span>
</span></span><span style="display:flex;"><span>	b	save_boot_params
</span></span><span style="display:flex;"><span>.globl	save_boot_params_ret
</span></span><span style="display:flex;"><span>save_boot_params_ret:
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SYS_RESET_SCTRL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl reset_sctrl   <span style="color:#75715e">// åˆå§‹åŒ–ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å¼‚å¸¸çº§åˆ«å¯èƒ½æ˜¯3ã€2æˆ–è€…1ï¼Œåˆå§‹çŠ¶æ€ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å°ç«¯å­—èŠ‚åºï¼Œç¦æ­¢MMUï¼Œç¦æ­¢æŒ‡ä»¤/æ•°æ®ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>    adr  x0, vectors
</span></span><span style="display:flex;"><span>    witch_el x1, <span style="color:#ae81ff">3f</span>, <span style="color:#ae81ff">2f</span>, <span style="color:#ae81ff">1f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>  msr  vbar_el3, x0    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«3ï¼Œå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL3è®¾ç½®ä½å¼‚å¸¸å‘é‡çš„èµ·å§‹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mrs  x0, scr_el3   <span style="color:#75715e">// è®¾ç½®å®‰å…¨é…ç½®å¯„å­˜å™¨SCR_EL3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    orr  x0, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>         <span style="color:#75715e">/* è®¾ç½®å¯„å­˜å™¨SCR_EL3çš„NSã€IRQã€FIQå’ŒEAå››ä¸ªä½ */</span>
</span></span><span style="display:flex;"><span>    msr  scr_el3, x0
</span></span><span style="display:flex;"><span>    msr  cptr_el3, xzr           <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef COUNTER_FREQUENCY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>COUNTER_FREQUENCY
</span></span><span style="display:flex;"><span>    msr  cntfrq_el0, x0          <span style="color:#75715e">/* åˆå§‹åŒ–å¯„å­˜å™¨CNTFRQ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    <span style="color:#ae81ff">0f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>  msr   vbar_el2, x0   		<span style="color:#75715e">// å¼‚å¸¸çº§åˆ«2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x33ff</span>
</span></span><span style="display:flex;"><span>    msr  cptr_el2, x0            <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */</span>
</span></span><span style="display:flex;"><span>    b    <span style="color:#ae81ff">0f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>  msr    vbar_el1, x0
</span></span><span style="display:flex;"><span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    msr  cpacr_el1, x0           <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* åº”ç”¨ARMå¤„ç†å™¨ç‰¹å®šçš„å‹˜è¯¯è¡¨*/</span>
</span></span><span style="display:flex;"><span>bl   apply_core_errata
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* å¤„ç†å™¨ç‰¹å®šçš„åˆå§‹åŒ–*/</span>
</span></span><span style="display:flex;"><span>bl   lowlevel_init    <span style="color:#75715e">// æ‰§è¡Œboard_init_f()æ‰€éœ€æœ€å°åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_ARMV8_SPIN_TABLE) &amp;&amp; !defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    branch_if_master x0, x1, master_cpu
</span></span><span style="display:flex;"><span>    b    spin_table_secondary_jump    <span style="color:#75715e">// arch/arm/cpu/armv8/spin_tabli.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">/* ç»å¯¹ä¸ä¼šè¿”å›*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(CONFIG_ARMV8_MULTIENTRY)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>branch_if_master x0, x1, master_cpu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* ä»å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>slave_cpu:
</span></span><span style="display:flex;"><span>    wfe
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä»å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œå®ƒè¢«å”¤é†’çš„æ—¶å€™ï¼Œä»åœ°å€CPU_RELEASE_ADDRè¯»å–å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x1, <span style="color:#f92672">=</span>CPU_RELEASE_ADDR 
</span></span><span style="display:flex;"><span>    ldr  x0, [x1]
</span></span><span style="display:flex;"><span>    cbz  x0, slave_cpu
</span></span><span style="display:flex;"><span>    br   x0               <span style="color:#75715e">/* è·³è½¬åˆ°æŒ‡å®šåœ°å€*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_ARMV8_MULTIENTRY */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>master_cpu:
</span></span><span style="display:flex;"><span>    bl   _main  <span style="color:#75715e">// ä¸»å¤„ç†å™¨æ‰§è¡Œå‡½æ•°
</span></span></span></code></pre></div><p>â€ƒU-Bootåˆ†ä¸ºSPLå’Œæ­£å¸¸çš„U-Bootç¨‹åºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦ç¼–è¯‘ä¸ºSPLï¼Œéœ€è¦å¼€å¯é…ç½®å®CONFIG_SPL_BUILDã€‚SPLæ˜¯â€œSecondary Program Loaderâ€çš„ç®€ç§°ï¼Œå³ç¬¬äºŒé˜¶æ®µç¨‹åºåŠ è½½å™¨ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯ç›¸å¯¹äºå¤„ç†å™¨é‡Œé¢çš„åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åºæ¥è¯´çš„ï¼Œå¤„ç†å™¨å¯åŠ¨æ—¶æœ€å…ˆæ‰§è¡Œçš„æ˜¯åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åº</p>
<h3 id="113-å‡½æ•°_main">1.1.3 å‡½æ•°_main<a hidden class="anchor" aria-hidden="true" href="#113-å‡½æ•°_main">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm/lib/crt0_64.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ENTRY(_main)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è®¾ç½®åˆå§‹çš„Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”è°ƒç”¨board_init_f(0)ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>(CONFIG_SPL_STACK)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>(CONFIG_SYS_INIT_SP_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bic  sp, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>   <span style="color:#75715e">/* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚*/</span>
</span></span><span style="display:flex;"><span>    mov  x0, sp
</span></span><span style="display:flex;"><span>    bl   board_init_f_alloc_reserve <span style="color:#75715e">// åœ¨æ ˆçš„é¡¶éƒ¨ä¸ºç»“æ„ä½“global_dataåˆ†é…ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  sp, x0
</span></span><span style="display:flex;"><span>    mov  x18, x0  <span style="color:#75715e">/* è®¾ç½®gd */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å‡½æ•°board_init_f_init_reserveï¼Œåˆå§‹åŒ–ç»“æ„ä½“global_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   board_init_f_init_reserve  
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    bl   board_init_f <span style="color:#75715e">// common/board_f.c æ‰§è¡Œæ•°ç»„init_sequence_fä¸­çš„æ¯ä¸ªå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if !defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">// è®¾ç½®ä¸­é—´ç¯å¢ƒï¼ˆæ–°çš„æ ˆæŒ‡é’ˆå’Œgdï¼‰ï¼Œç„¶åè°ƒç”¨å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">// relocate_code(addr_moni)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_START_ADDR_SP]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-&gt;start_addr_sp */</span>
</span></span><span style="display:flex;"><span>    bic  sp, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>             <span style="color:#75715e">/* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚ */</span>
</span></span><span style="display:flex;"><span>    ldr  x18, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_BD]       <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x18è®¾ç½®ä¸ºgd-&gt;bd */</span>
</span></span><span style="display:flex;"><span>    sub  x18, x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_SIZE       <span style="color:#75715e">/* æ–°çš„gdåœ¨bdçš„ä¸‹é¢ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    adr  lr, relocation_return
</span></span><span style="display:flex;"><span>    ldr  x9, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOC_OFF]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x9è®¾ç½®ä¸ºgd-&gt;reloc_off */</span>
</span></span><span style="display:flex;"><span>    add  lr, lr, x9    <span style="color:#75715e">/* åœ¨é‡å®šä½åæ–°çš„è¿”å›åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    ldr  x0, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOCADDR]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-&gt;relocaddr */</span>
</span></span><span style="display:flex;"><span>    b    relocate_code
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>relocation_return:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è®¾ç½®æœ€ç»ˆçš„å®Œæ•´ç¯å¢ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">/* ä»ç„¶è°ƒç”¨æ—§çš„ä¾‹ç¨‹ æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€*/</span>
</span></span><span style="display:flex;"><span>    bl   c_runtime_cpu_setup  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* !CONFIG_SPL_BUILD */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   spl_relocate_stack_gd    <span style="color:#75715e">/* å¯èƒ½è¿”å›ç©ºæŒ‡é’ˆ é‡æ–°å®šä½æ ˆ*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ‰§è¡Œâ€œsp = (x0 != NULL) ? x0 : spâ€ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// è§„é¿è¿™ä¸ªçº¦æŸï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¸¦æ¡ä»¶çš„movæŒ‡ä»¤ä¸èƒ½æŠŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  x1, sp
</span></span><span style="display:flex;"><span>    cmp  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    csel x0, x0, x1, ne
</span></span><span style="display:flex;"><span>    mov  sp, x0
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”¨0åˆå§‹åŒ–æœªåˆå§‹åŒ–æ•°æ®æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>__bss_start      <span style="color:#75715e">/* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/</span>
</span></span><span style="display:flex;"><span>    ldr  x1, <span style="color:#f92672">=</span>__bss_end        <span style="color:#75715e">/* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/</span>
</span></span><span style="display:flex;"><span>clear_loop:
</span></span><span style="display:flex;"><span>    str  xzr, [x0], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    cmp  x0, x1
</span></span><span style="display:flex;"><span>    b.lo clear_loop
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è°ƒç”¨å‡½æ•°board_init_r(gd_t *id, ulong dest_addr) */</span>
</span></span><span style="display:flex;"><span>    mov  x0, x18                     <span style="color:#75715e">/* gd_t */</span>
</span></span><span style="display:flex;"><span>    ldr  x1, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOCADDR]    <span style="color:#75715e">/* dest_addr */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* ç›¸å¯¹ç¨‹åºè®¡æ•°å™¨çš„è·³è½¬ common/board_r.c æ‰§è¡Œæ•°ç»„init_sequence_rä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œæœ€åä¸€ä¸ªå‡½æ•°æ˜¯run_main_loop */</span>
</span></span><span style="display:flex;"><span>    b    board_init_r   
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* ä¸ä¼šè¿è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºå‡½æ•°board_init_r()ä¸ä¼šè¿”å›*/</span>
</span></span><span style="display:flex;"><span>ENDPROC(_main)
</span></span></code></pre></div><h3 id="114-å‡½æ•°run_main_loop">1.1.4 å‡½æ•°run_main_loop<a hidden class="anchor" aria-hidden="true" href="#114-å‡½æ•°run_main_loop">#</a></h3>
<p>â€ƒæ•°ç»„<code>init_sequence_r</code>æœ€åä¸€ä¸ªå‡½æ•°<code>run_main_loop</code>ï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹ï¼›</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>run_main_loop
</span></span><span style="display:flex;"><span>    main_loop
</span></span><span style="display:flex;"><span>        bootdely_process <span style="color:#75715e"># è¯»å–ç¯å¢ƒå˜é‡bootdelay(å»¶è¿Ÿæ—¶é—´)å’Œbootcmd(ç¯å¢ƒå˜é‡)</span>
</span></span><span style="display:flex;"><span>        autoboot_command
</span></span><span style="display:flex;"><span>            abortboot    <span style="color:#75715e"># ç­‰å¾…ç”¨æˆ·æŒ‰é”®</span>
</span></span><span style="display:flex;"><span>            run_command_list  <span style="color:#75715e"># æœªç­‰å¾…åˆ°æŒ‰é”®ï¼Œè‡ªåŠ¨æ‰§è¡Œç¯å¢ƒå˜é‡bootcmd</span>
</span></span></code></pre></div><p>â€ƒ<code>bootm</code>å‘½ä»¤å¤„ç†å‡½æ•°<code>do_bootm</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>do_bootm
</span></span><span style="display:flex;"><span>    do_bootm_states
</span></span><span style="display:flex;"><span>        bootm_start   <span style="color:#75715e"># åˆå§‹åŒ–å…¨å±€å˜é‡bootm_header_timages</span>
</span></span><span style="display:flex;"><span>        bootm_find_os    <span style="color:#75715e"># æŠŠå†…æ ¸é•œåƒä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜</span>
</span></span><span style="display:flex;"><span>        bootm_find_other    <span style="color:#75715e"># ARM64 æ‰å¹³è®¾å¤‡æ ‘(Flattended Device Tree FDT)äºŒè¿›åˆ¶æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        bootm_load_os  <span style="color:#75715e"># è§£å‹ç—…åŠ è½½å†…æ ¸åˆ°æ­£ç¡®ä½ç½®</span>
</span></span><span style="display:flex;"><span>        bootm_os_get_boot_func  <span style="color:#75715e"># åœ¨æ“ä½œç³»ç»Ÿç±»å‹æ•°ç»„boot_osä¸­æŸ¥æ‰¾å¼•å¯¼å‡½æ•°ï¼Œlinuxå†…æ ¸å¼•å¯¼å‡½æ•°do_bootm_linux</span>
</span></span><span style="display:flex;"><span>        do_bootm_linux<span style="color:#f92672">(</span>flag<span style="color:#f92672">=</span>BOOTM_STATE_OS_PREP<span style="color:#f92672">)</span>  <span style="color:#75715e"># è°ƒç”¨boot_prep_linux</span>
</span></span><span style="display:flex;"><span>            boot_prep_linux  <span style="color:#75715e"># 1.åˆ†é…ä¸€å—å†…å­˜ï¼ŒæŠŠè®¾å¤‡æ•°äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ 2.ä¿®æ”¹æ‰å¹³è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        boot_selected_os  <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>            do_bootm_linux<span style="color:#f92672">(</span>flag<span style="color:#f92672">=</span>BOOTM_STATE_OS_GO<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                boot_jump_linux  <span style="color:#75715e"># è´Ÿè´£è·³è½¬åˆ°Linuxå†…æ ¸</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>boot_jum_linux
</span></span><span style="display:flex;"><span>    do_nonsec_virt_switch
</span></span><span style="display:flex;"><span>        smp_kick_all_cpus  <span style="color:#75715e"># CONFIG_GICV2æˆ–CONFIG_GICV3ï¼Œä¸­æ–­æ§åˆ¶å™¨ç‰ˆæœ¬2ï¼Œ3</span>
</span></span><span style="display:flex;"><span>        dcache_disable  <span style="color:#75715e"># ç¦ç”¨å¤„ç†å™¨çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†å•å…ƒ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ # å¼€å¯é…ç½®å® CONFIG_ARMV8_SWITCH_TO_EL1</span>
</span></span><span style="display:flex;"><span>    armv8_switch_to_el2
</span></span><span style="display:flex;"><span>        switch_to_el1
</span></span><span style="display:flex;"><span>            armv8_switch_to_el1
</span></span><span style="display:flex;"><span>                å†…æ ¸å…¥å£
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸</span>
</span></span><span style="display:flex;"><span>    armv8_switch_to_el2
</span></span><span style="display:flex;"><span>        å†…æ ¸å…¥å£
</span></span></code></pre></div><h2 id="12-å†…æ ¸åˆå§‹åŒ–">1.2 å†…æ ¸åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#12-å†…æ ¸åˆå§‹åŒ–">#</a></h2>
<p>â€ƒå†…æ ¸åˆå§‹åŒ–åˆ†ä¸ºæ±‡ç¼–è¯­è¨€éƒ¨åˆ†å’ŒCè¯­è¨€éƒ¨åˆ†</p>
<h3 id="121-æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#121-æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">#</a></h3>
<p>â€ƒARM64æ¶æ„å†…æ ¸å…¥å£<code>_head</code>ï¼Œç›´æ¥è·³è½¬åˆ°æ ‡å·<code>stext</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>_head:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_EFI   </span><span style="color:#75715e">// æä¾›UEFIè¿è¡Œæ—¶æ”¯æŒUEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æ˜¯ç»Ÿä¸€çš„å¯æ‰©å±•å›ºä»¶æ¥å£ï¼Œç”¨äºå–ä»£BIOS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    add  x13, x18, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x16</span>
</span></span><span style="display:flex;"><span>    b    stext
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    stext       <span style="color:#75715e">// è·³è½¬åˆ°å†…æ ¸èµ·å§‹ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .long0           <span style="color:#75715e">// ä¿ç•™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>â€‚<code>stext</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ENTRY(stext)
</span></span><span style="display:flex;"><span>    bl   preserve_boot_args  <span style="color:#75715e">// æŠŠå¼•å¯¼ç¨‹åºä¼ é€’çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_argsä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   el2_setup        <span style="color:#75715e">// é™çº§åˆ°å¼‚å¸¸çº§åˆ«1, å¯„å­˜å™¨w0å­˜æ”¾cpu_boot_mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    adrp x23, __PHYS_OFFSET
</span></span><span style="display:flex;"><span>    and  x23, x23, MIN_KIMG_ALIGN <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e">// KASLRåç§»ï¼Œé»˜è®¤å€¼æ˜¯0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   set_cpu_boot_mode_flag  <span style="color:#75715e">// __boot_cpu_mode[2] æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   __create_page_tables  <span style="color:#75715e">// åˆ›å»ºé¡µè¡¨æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ä¸‹é¢è°ƒç”¨è®¾ç½®å¤„ç†å™¨çš„ä»£ç ï¼Œè¯·çœ‹æ–‡ä»¶â€œarch/arm64/mm/proc.Sâ€ äº†è§£ç»†èŠ‚ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å·²ç»ä¸ºå¼€å¯å†…å­˜ç®¡ç†å•å…ƒåšå¥½å‡†å¤‡ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è½¬æ¢æ§åˆ¶å¯„å­˜å™¨å·²ç»è®¾ç½®å¥½ã€‚*/</span>
</span></span><span style="display:flex;"><span>    bl    __cpu_setup        <span style="color:#75715e">// åˆå§‹åŒ–å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    __primary_switch  <span style="color:#75715e">// ä¸»å¤„ç†å™¨å¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿›å…¥Cè¯­è¨€éƒ¨åˆ†å…¥å£å‡½æ•°start_kernel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ENDPROC(stext)
</span></span></code></pre></div><br>
<ol>
<li>å‡½æ•°el2_setup</li>
</ol>
<blockquote>
<p>a.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯1ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ã€‚   <br>
b.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯2ï¼Œé‚£ä¹ˆæ ¹æ®å¤„ç†å™¨æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼ˆVirtualization Host Extensionsï¼ŒVHEï¼‰ï¼Œå†³å®šæ˜¯å¦éœ€è¦é™çº§åˆ°å¼‚å¸¸çº§åˆ«1ã€‚    <br>
1ï¼‰å¦‚æœå¤„ç†å™¨æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ã€‚    \<br>
2ï¼‰å¦‚æœå¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆé™çº§åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸      \</p>
</blockquote>
<p>â€ƒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼ŒKVMï¼‰ï¼ŒKVMçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œå› æ­¤è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚       <br>
â€ƒå¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒKVMè™šæ‹Ÿæœºã€‚QEMUåˆ›å»ºä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå’ŒKVMçš„äº¤äº’è¿‡ç¨‹           \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ‰“å¼€KVMå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fd <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;/dev/kvm&#34;</span>, O_RDWR);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vmfd <span style="color:#f92672">=</span> ioctl(fd, KVM_CREATE_VM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// KVMä¸ºæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªkvm_vcpuç»“æ„ä½“ï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿå¤„ç†å™¨çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vcpu_fd <span style="color:#f92672">=</span> ioctl(vmfd, KVM_CREATE_VCPU, <span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>â€ƒä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹å¦‚ä¸‹ã€‚      <br>
â€ƒï¼ˆ1ï¼‰QEMUè¿›ç¨‹è°ƒç”¨â€œioctl(vcpu_fd, KVM_RUN, 0)â€ï¼Œé™·å…¥åˆ°å†…æ ¸ã€‚     <br>
â€ƒï¼ˆ2ï¼‰KVMæ‰§è¡Œå‘½ä»¤KVM_RUNï¼Œä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚           <br>
â€ƒï¼ˆ3ï¼‰KVMé¦–å…ˆæŠŠè°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨ä¿å­˜åœ¨kvm_vcpuç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠæ‰€æœ‰å¯„å­˜å™¨è®¾ç½®ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿçš„å¯„å­˜å™¨å€¼ï¼Œæœ€åä»å¼‚å¸¸çº§åˆ«2è¿”å›åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚           <br>
â€ƒä¸ºäº†æé«˜åˆ‡æ¢é€Ÿåº¦ï¼Œ<code>ARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸</code>ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦å…ˆä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2      \</p>
<br>
<ol start="2">
<li>å‡½æ•°__create_page_tables</li>
</ol>
<blockquote>
<p>1ï¼‰åˆ›å»ºæ’ç­‰æ˜ å°„ï¼Œè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€<code>__enable_mmu</code>å¼€å¯å†…å­˜ç®¡ç†å•å…ƒ        <br>
2ï¼‰ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„             \</p>
</blockquote>
<p>â€ƒæ˜ å°„ä»£ç èŠ‚<code>.idmap.text</code>,æ’ç­‰æ˜ å°„ä»£ç èŠ‚çš„èµ·å§‹åœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_startä¸­ï¼Œç»“æŸåœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_endä¸­ã€‚æ’ç­‰æ˜ å°„æ˜¯ä¸ºæ’ç­‰æ˜ å°„ä»£ç èŠ‚åˆ›å»ºçš„æ˜ å°„ï¼Œidmap_pg_diræ˜¯æ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•ï¼ˆå³ç¬¬ä¸€çº§é¡µè¡¨ï¼‰çš„èµ·å§‹åœ°å€ã€‚å†…æ ¸çš„é¡µè¡¨ä¸­ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ï¼Œå†…æ ¸é•œåƒçš„èµ·å§‹åœ°å€æ˜¯_textï¼Œç»“æŸåœ°å€æ˜¯_endï¼Œswapper_pg_diræ˜¯å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹åœ°å€</p>
<br>
<ol start="3">
<li>å‡½æ•°__primary_switch</li>
</ol>
<blockquote>
<p>1ï¼‰__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ            <br>
2ï¼‰__primary_switched      <br>
â€‚__enable_mmuæ‰§è¡Œæµç¨‹     <br>
â€ƒ1ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨0(TTBR0_EL1)è®¾ç½®ä¸ºæ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€     <br>
â€ƒ2ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨1(TTBR1_EL1)è®¾ç½®ä¸ºå†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€        <br>
â€ƒ3ï¼‰è®¾ç½®ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR_EL1)ï¼Œå¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼ŒåMMUæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€    <br>
â€‚__primary_switchæ‰§è¡Œæµç¨‹      <br>
â€ƒ1ï¼‰æŠŠå½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨è®¾ç½®ä¸º0å·çº¿ç¨‹å†…æ ¸æ ˆçš„é¡¶éƒ¨(init_thread_union + THREAD_SIZE)           <br>
â€ƒ2ï¼‰æŠŠå¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨(SP_EL0)è®¾ç½®ä¸º0å·çº¿ç¨‹çš„ç»“æ„ä½“<code>thread_info</code>çš„åœ°å€(init_task.thread_info)        <br>
â€ƒ3ï¼‰æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(VBAR_EL1)è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€(vectors)     <br>
â€ƒ4ï¼‰è®¡ç®—å†…æ ¸é•œåƒçš„èµ·å§‹è™šæ‹Ÿåœ°å€(kimage_vaddr)å’Œç‰©ç†åœ°å€çš„å·®å€¼ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡kimage_voffsetä¸­     <br>
â€ƒ5ï¼‰ç”¨0åˆå§‹åŒ–å†…æ ¸çš„æœªåˆå§‹åŒ–æ•°æ®æ®µ      <br>
â€ƒ6ï¼‰è°ƒç”¨Cè¯­è¨€å‡½æ•°<code>start_kernel</code>      \</p>
</blockquote>
<br>
<h3 id="122-cè¯­è¨€éƒ¨åˆ†">1.2.2 Cè¯­è¨€éƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#122-cè¯­è¨€éƒ¨åˆ†">#</a></h3>
<p>â€ƒå†…æ ¸åˆå§‹åŒ–çš„Cè¯­è¨€éƒ¨åˆ†å…¥å£æ˜¯å‡½æ•°<code>start_kernel</code>ï¼Œå‡½æ•°start_kernelé¦–å…ˆåˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼Œå³åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼Œç„¶åè°ƒç”¨å‡½æ•°<code>rest_init</code>ã€‚å‡½æ•°rest_initçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚   <br>
â€‚ï¼ˆ1ï¼‰åˆ›å»º1å·çº¿ç¨‹ï¼Œå³initçº¿ç¨‹ï¼Œçº¿ç¨‹å‡½æ•°æ˜¯kernel_initã€‚     <br>
â€‚ï¼ˆ2ï¼‰åˆ›å»º2å·çº¿ç¨‹ï¼Œå³kthreaddçº¿ç¨‹ï¼Œè´Ÿè´£åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚     <br>
â€‚ï¼ˆ3ï¼‰0å·çº¿ç¨‹æœ€ç»ˆå˜æˆç©ºé—²çº¿ç¨‹ã€‚    \</p>
<p>initçº¿ç¨‹ç»§ç»­åˆå§‹åŒ–ï¼Œæ‰§è¡Œçš„ä¸»è¦æ“ä½œå¦‚ä¸‹ã€‚    <br>
â€‚ï¼ˆ1ï¼‰smp_prepare_cpus()ï¼šåœ¨å¯åŠ¨ä»å¤„ç†å™¨ä»¥å‰æ‰§è¡Œå‡†å¤‡å·¥ä½œã€‚   <br>
â€‚ï¼ˆ2ï¼‰do_pre_smp_initcalls()ï¼šæ‰§è¡Œå¿…é¡»åœ¨åˆå§‹åŒ–SMPç³»ç»Ÿä»¥å‰æ‰§è¡Œçš„æ—©æœŸåˆå§‹åŒ–ï¼Œå³ä½¿ç”¨å®early_initcallæ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ã€‚   <br>
â€‚ï¼ˆ3ï¼‰smp_init()ï¼šåˆå§‹åŒ–SMPç³»ç»Ÿï¼Œå¯åŠ¨æ‰€æœ‰ä»å¤„ç†å™¨ã€‚   <br>
â€‚ï¼ˆ4ï¼‰do_initcalls()ï¼šæ‰§è¡Œçº§åˆ«0ï½7çš„åˆå§‹åŒ–ã€‚ <br>
â€‚ï¼ˆ5ï¼‰æ‰“å¼€æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶â€œ/dev/consoleâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2åˆ†åˆ«æ˜¯æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œéƒ½æ˜¯æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚   <br>
â€ƒï¼ˆ6ï¼‰prepare_namespace()ï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è£…è½½initç¨‹åºæ—¶éœ€è¦ä»å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¯»æ–‡ä»¶ã€‚   <br>
â€ƒï¼ˆ7ï¼‰free_initmem()ï¼šé‡Šæ”¾åˆå§‹åŒ–ä»£ç å’Œæ•°æ®å ç”¨çš„å†…å­˜ã€‚   <br>
â€ƒï¼ˆ8ï¼‰è£…è½½initç¨‹åºï¼ˆU-Bootç¨‹åºå¯ä»¥ä¼ é€’å†…æ ¸å‚æ•°â€œinit=â€ä»¥æŒ‡å®šinitç¨‹åºï¼‰ï¼Œä»å†…æ ¸çº¿ç¨‹è½¬æ¢æˆç”¨æˆ·ç©ºé—´çš„initè¿›ç¨‹ã€‚  \</p>
<p>â€‚çº§åˆ«0ï½7çš„åˆå§‹åŒ–ï¼Œæ˜¯æŒ‡ä½¿ç”¨ä»¥ä¸‹å®æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/init.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define pure_initcall(fn)           __define_initcall(fn, 0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define core_initcall(fn)           __define_initcall(fn, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define core_initcall_sync(fn)      __define_initcall(fn, 1s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define postcore_initcall(fn)       __define_initcall(fn, 2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define postcore_initcall_sync(fn)  __define_initcall(fn, 2s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_initcall(fn)           __define_initcall(fn, 3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_initcall_sync(fn)      __define_initcall(fn, 3s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define subsys_initcall(fn)         __define_initcall(fn, 4)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define subsys_initcall_sync(fn)    __define_initcall(fn, 4s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define fs_initcall(fn)             __define_initcall(fn, 5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define fs_initcall_sync(fn)        __define_initcall(fn, 5s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define rootfs_initcall(fn)         __define_initcall(fn, rootfs)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define device_initcall(fn)         __define_initcall(fn, 6)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define device_initcall_sync(fn)    __define_initcall(fn, 6s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define late_initcall(fn)           __define_initcall(fn, 7)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define late_initcall_sync(fn)      __define_initcall(fn, 7s)
</span></span></span></code></pre></div><h3 id="123-smpç³»ç»Ÿçš„å¼•å¯¼">1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼<a hidden class="anchor" aria-hidden="true" href="#123-smpç³»ç»Ÿçš„å¼•å¯¼">#</a></h3>
<p>â€‚å¯¹ç§°å¤šå¤„ç†å™¨(Symmetirc Multi-Processor SMP)       <br>
â€ƒ3ç§å¼•å¯¼ä»å¤„ç†å™¨æ–¹æ³•      \</p>
<ul>
<li>è‡ªæ—‹è¡¨</li>
<li>ç”µæºçŠ¶æ€åè°ƒæ¥å£</li>
<li>ACPIåœè½¦åè®®</li>
</ul>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/ARM64_SMP_spin_table.png" alt="ARM64æ¶æ„ä¸‹SMPç³»ç»Ÿçš„è‡ªæ—‹è¡¨å¼•å¯¼è¿‡ç¨‹"  />
</p>
<h2 id="13-initè¿›ç¨‹">1.3 initè¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#13-initè¿›ç¨‹">#</a></h2>
<p>â€ƒinitè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç”¨æˆ·ç¨‹åºã€‚Linuxç³»ç»Ÿinitç¨‹åºæœ‰<code>sysvinit</code>ã€busybox initã€upstartã€<code>systemd</code>å’Œprocdã€‚sysvinitæ˜¯Unixç³»ç»Ÿ5(System V)initç¨‹åºï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶<code>/etc/initab</code></p>
<br>
<h1 id="ç¬¬2ç« -è¿›ç¨‹ç®¡ç†">ç¬¬2ç«  è¿›ç¨‹ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2ç« -è¿›ç¨‹ç®¡ç†">#</a></h1>
<h2 id="21-è¿›ç¨‹">2.1 è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#21-è¿›ç¨‹">#</a></h2>
<p>â€ƒLinuxå†…æ ¸æŠŠè¿›ç¨‹ç§°ä¸ºtaskï¼Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´       <br>
â€ƒè¿›ç¨‹æœ‰ä¸¤ç§ç‰¹æ®Šå½¢å¼ï¼šæ²¡æœ‰ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œå…±äº«ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚     <br>
â€ƒtask_structç»“æ„ä½“æ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸»è¦æˆå‘˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> state;    <span style="color:#75715e">// è¿›ç¨‹çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>stack;            <span style="color:#75715e">// æŒ‡å‘å†…æ ¸æ ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pid_t pid;              <span style="color:#75715e">// å…¨å±€è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pid_t tgid              <span style="color:#75715e">// å…¨å±€çš„çº¿ç¨‹ç»„æ ‡è¯†ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> pid_link pid[PIDTYPE_MAX];   <span style="color:#75715e">// è¿›ç¨‹å·ï¼Œè¿›ç¨‹ç»„æ ‡è¯†ç¬¦å’Œä¼šè¯æ ‡è¯†ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct _rcu <span style="color:#f92672">*</span>real_parent;   <span style="color:#75715e">// real_parentæŒ‡å‘çœŸå®çš„çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct _rcu <span style="color:#f92672">*</span>parent;        <span style="color:#75715e">// parentæŒ‡å‘çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>group_leader;   <span style="color:#75715e">// æŒ‡å‘è¿›æ‘ç»„çš„ç»„é•¿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> cred _rcu <span style="color:#f92672">*</span>real_cred;  <span style="color:#75715e">// real_credæŒ‡å‘ä¸»é¢˜å’ŒçœŸå®å®¢ä½“è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> cred _rcu <span style="color:#f92672">*</span>cred;       <span style="color:#75715e">// credæŒ‡å‘å®¢ä½“è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> comm[TASK_COMM_LEN];           <span style="color:#75715e">// è¿›ç¨‹å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> prio, static_prio, nornal_prio; <span style="color:#75715e">// è°ƒåº¦ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> rt_priority,prolicy<span style="color:#960050;background-color:#1e0010">ï¼›</span>  <span style="color:#75715e">// ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>cpumask_t cpus_allowed;             <span style="color:#75715e">// å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#f92672">*</span>active_mm;   <span style="color:#75715e">// æŒ‡å‘å†…å­˜æè¿°ç¬¦ï¼Œè¿›ç¨‹mmï¼Œå’Œactive_mmæŒ‡å‘åŒä¸€ä¸ªå†…å­˜æè¿°ç¬¦ï¼Œå†…æ ¸çº¿ç¨‹mmæ˜¯æŒ‡é’ˆï¼Œå½“å†…æ ¸çº¿ç¨‹è¿è¡Œæ—¶active_mmæŒ‡å‘ä»è¿›ç¨‹å€Ÿç”¨çš„å†…å­˜æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> file_struct <span style="color:#f92672">*</span>files;          <span style="color:#75715e">// æ‰“å¼€æ–‡ä»¶è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>nsproxy;            <span style="color:#75715e">// å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> signal_struct <span style="color:#f92672">*</span>signal;       <span style="color:#75715e">// ä¿¡å·å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sigband_struct <span style="color:#f92672">*</span>sighand;
</span></span><span style="display:flex;"><span>sigset_t blocked, real_blocked;
</span></span><span style="display:flex;"><span>sigset_t saved_sigmask;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sigpending pending;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sysv_sem sysvsem;            <span style="color:#75715e">// UNIxç³»ç»Ÿ5ä¿¡å·é‡å’Œå…±äº«å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sysv_shm sysvshm;
</span></span></code></pre></div><h2 id="22-å‘½åç©ºé—´">2.2 å‘½åç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#22-å‘½åç©ºé—´">#</a></h2>
<p>â€ƒå’Œè™šæ‹Ÿæœºç›¸æ¯”ï¼Œå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„å†…æ ¸ï¼Œä½¿ç”¨å‘½åç©ºé—´éš”ç¦»èµ„æº,è™šæ‹Ÿæœºä»…ä»…æ˜¯é€šè¿‡å‘½åç©ºé—´éš”ç¦»ï¼Ÿ  \</p>
<table>
<thead>
<tr>
<th>å‘½åç©ºé—´</th>
<th>éš”ç¦»èµ„æº</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>æ§åˆ¶ç»„cgroup</td>
<td>æ§åˆ¶ç»„æ ¹ç›®å½•</td>
<td></td>
</tr>
<tr>
<td>è¿›ç¨‹é—´é€šä¿¡IPC</td>
<td>UNIXç³»ç»Ÿ5è¿›ç¨‹é—´é€šä¿¡å’ŒPOSIxæ¶ˆæ¯é˜Ÿåˆ—</td>
<td></td>
</tr>
<tr>
<td>network</td>
<td>ç½‘ç»œåè®®</td>
<td></td>
</tr>
<tr>
<td>æŒ‚è½½mount</td>
<td>æŒ‚è½½ç‚¹</td>
<td></td>
</tr>
<tr>
<td>PID</td>
<td>è¿›ç¨‹å·</td>
<td></td>
</tr>
<tr>
<td>user</td>
<td>ç”¨æˆ·æ ‡è¯†ç¬¦å’Œç»„æ ‡è¯†ç¬¦</td>
<td></td>
</tr>
<tr>
<td>UNIXåˆ†æ—¶ç³»ç»Ÿ(UTS)</td>
<td>ä¸»æœºåå’Œç½‘ç»œä¿¡æ¯æœåŠ¡NISåŸŸå</td>
<td></td>
</tr>
</tbody>
</table>
<p>â€‚åˆ›å»ºæ–°çš„å‘½åç©ºé—´æ–¹æ³•ï¼š   <br>
â€ƒè°ƒç”¨cloneåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œä½¿ç”¨æ ‡å¿—ä½æ§åˆ¶å­è¿›ç¨‹æ˜¯å…±äº«çˆ¶è¿›ç¨‹çš„å‘½åç©ºé—´è¿˜æ˜¯åˆ›å»ºæ–°å‘½åç©ºé—´   <br>
â€ƒè°ƒç”¨unshareåˆ›å»ºæ–°çš„å‘½åç©ºé—´    <br>
â€‚è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setnsï¼Œç»‘å®šä¸€ä¸ªå·²ç»å­˜åœ¨çš„å‘½åç©ºé—´</p>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/process_namespace.png" alt="è¿›ç¨‹çš„å‘½åç©ºé—´"  />
</p>
<p>â€ƒè¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespace,è¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespaceã€‚</p>
<h2 id="23-è¿›ç¨‹æ ‡è¯†ç¬¦">2.3 è¿›ç¨‹æ ‡è¯†ç¬¦<a hidden class="anchor" aria-hidden="true" href="#23-è¿›ç¨‹æ ‡è¯†ç¬¦">#</a></h2>
<table>
<thead>
<tr>
<th>æ ‡è¯†ç¬¦</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>è¿›ç¨‹æ ‡è¯†ç¬¦</td>
<td>å‘½åç©ºé—´ç»™è¿›ç¨‹åˆ†é…æ ‡è¯†ç¬¦</td>
<td></td>
</tr>
<tr>
<td>çº¿ç¨‹ç»„æ ‡è¯†ç¬¦</td>
<td>çº¿ç¨‹ç»„ä¸­çš„ä¸»è¿›ç¨‹ç§°ä¸ºç»„é•¿ï¼Œçº¿ç¨‹ç»„æ ‡è¯†ç¬¦å°±æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦<br>ç³»ç»Ÿè°ƒç”¨cloneä¼ å…¥æ ‡å¿—CLONE_THREADä»¥åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºä¸€ä¸ªçº¿ç¨‹ç»„</td>
<td></td>
</tr>
<tr>
<td>è¿›ç¨‹ç»„æ ‡è¯†ç¬¦</td>
<td>è¿›ç¨‹ç»„æ ‡è¯†ç¬¦æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦ã€‚<br>è¿›ç¨‹å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setpgidåˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªè¿›ç¨‹ç»„</td>
<td></td>
</tr>
<tr>
<td>ä¼šè¯æ ‡è¯†ç¬¦</td>
<td>è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨setsidçš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯</td>
<td></td>
</tr>
</tbody>
</table>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/pid_mark.png" alt="è¿›ç¨‹çš„å‘½åç©ºé—´"  />
</p>
<p>â€ƒpidå­˜å‚¨å…¨å±€è¿›ç¨‹å·ï¼Œpids[PIDTYPE_PID].pidæŒ‡å‘ç»“æ„ä½“pidï¼Œpids[PIDTYPE_PGID].pidæŒ‡å‘è¿›ç¨‹ç»„ç»„é•¿çš„ç»“æ„ä½“pidï¼Œpids[PIDTYPE_SIG].pidæŒ‡å‘ä¼šè¯è¿›ç¨‹çš„ç»“æ„ä½“pid    \</p>
<p>â€ƒè¿›ç¨‹æ ‡è¯†ç¬¦ç»“æ„ä½“pidçš„æˆå‘˜ï¼Œcountæ˜¯å¼•ç”¨è®¡æ•°ï¼Œlevelè¿›ç¨‹å·å‘½åç©ºé—´çš„å±‚æ¬¡ï¼Œnumberså…ƒç´ ä¸ªæ•°æ˜¯levelçš„å€¼åŠ 1ï¼Œ</p>
<h2 id="24-è¿›ç¨‹å…³ç³»">2.4 è¿›ç¨‹å…³ç³»<a hidden class="anchor" aria-hidden="true" href="#24-è¿›ç¨‹å…³ç³»">#</a></h2>
<p>â€ƒå¦‚æœå­è¿›ç¨‹è¢«æŸä¸ªè¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯è°ƒè¯•å™¨ï¼‰ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ptraceè·Ÿè¸ªï¼Œé‚£ä¹ˆæˆå‘˜parentæŒ‡å‘è·Ÿè¸ªè€…çš„è¿›ç¨‹æè¿°ç¬¦ï¼Œå¦åˆ™æˆå‘˜parentä¹ŸæŒ‡å‘çˆ¶è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ã€‚</p>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/process_relative.png" alt="è¿›ç¨‹çš„å‘½åç©ºé—´"  />
</p>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/tasks_table.png" alt="è¿›ç¨‹å’Œçº¿ç¨‹é“¾è¡¨"  />
</p>
<h2 id="24-å¯åŠ¨ç¨‹åº">2.4 å¯åŠ¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#24-å¯åŠ¨ç¨‹åº">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> fork();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/* çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œ */</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å­è¿›ç¨‹è£…è½½ç¨‹åº */</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> execve(filename, argv, envp);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/* åˆ›å»ºå­è¿›ç¨‹å¤±è´¥ */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="241åˆ›å»ºæ–°è¿›ç¨‹">2.4.1ã€€åˆ›å»ºæ–°è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#241åˆ›å»ºæ–°è¿›ç¨‹">#</a></h3>
<p>â€ƒå†…æ ¸ä½¿ç”¨é™æ€æ•°æ®æ„é€ å‡º0å·å†…æ ¸çº¿ç¨‹ï¼Œ0å·å†…æ ¸çº¿ç¨‹åˆ†å‰ç”Ÿæˆ1å·å†…æ ¸çº¿ç¨‹å’Œ2å·å†…æ ¸çº¿ç¨‹ï¼ˆkthreaddçº¿ç¨‹ï¼‰ã€‚1å·å†…æ ¸çº¿ç¨‹å®Œæˆåˆå§‹åŒ–ä»¥åè£…è½½ç”¨æˆ·ç¨‹åºï¼Œå˜æˆ1å·è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯1å·è¿›ç¨‹æˆ–è€…å®ƒçš„å­å­™è¿›ç¨‹åˆ†å‰ç”Ÿæˆçš„ï¼›å…¶ä»–å†…æ ¸çº¿ç¨‹æ˜¯kthreaddçº¿ç¨‹åˆ†å‰ç”Ÿæˆçš„
â€ƒä¸¤ä¸ªä¸ªç³»ç»Ÿè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼š    \</p>
<ul>
<li>forkï¼šå­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œç”¨å†™æ—¶å¤åˆ¶</li>
<li>cloneï¼šå¯æ§åˆ¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«å“ªäº›èµ„æº</li>
<li>vforkï¼šåˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ç”¨execveè£…è½½ç¨‹åº(å·²åºŸå¼ƒ)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ•°å­—è¡¨ç¤ºå‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SYSCALL_DEFINE0(fork)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®å±•å¼€ asmlinkageè¡¨ç¤ºCè¯­è¨€å‡½æ•°çœ‹è¢«æ±‡ç¼–ä»£ç è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage <span style="color:#66d9ef">long</span> sys_fork(<span style="color:#66d9ef">void</span>)
</span></span></code></pre></div><p>â€ƒåˆ›å»ºè¿›ç¨‹çš„è¿›ç¨‹på’Œè¢«åˆ›å»ºè¿›ç¨‹cä¸‰ç§å…³ç³»</p>
<ul>
<li>æ–°è¿›ç¨‹æ˜¯è¿›ç¨‹pçš„å­è¿›ç¨‹</li>
<li>cloneä¼ å…¥CLONE_PARENTï¼Œå…„å¼Ÿå…³ç³»</li>
<li>cloneä¼ å…¥CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„</li>
</ul>
<h4 id="1-_do_forkå‡½æ•°">1. _do_forkå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#1-_do_forkå‡½æ•°">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> <span style="color:#a6e22e">_do_fork</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack_start,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack_size,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> __user <span style="color:#f92672">*</span>parent_tidptr,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> __user <span style="color:#f92672">*</span>child_tidptr,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> tls);  <span style="color:#75715e">// tls åˆ›å»ºçº¿ç¨‹ï¼Œclone_flagsä¸ºCLONE_SETTLSæ—¶ï¼ŒtlstlsæŒ‡å®šæ–°çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€
</span></span></span></code></pre></div><p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/_do_fork.png" alt="å‡½æ•°_do_forkçš„æ‰§è¡Œæµç¨‹"  />
</p>
<p>â€ƒè°ƒç”¨copy_processåˆ›å»ºæ–°è¿›ç¨‹  <br>
â€ƒclone_flagsè®¾ç½®CLONE_PARENT_SETTIDï¼Œæ–°çº¿ç¨‹çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°å‚æ•°parent_tidptræŒ‡å®šçš„ä½ç½®   <br>
â€ƒwake_up_new_taskå”¤é†’æ–°è¿›ç¨‹</p>
<h4 id="2-copy_processå‡½æ•°">2. copy_processå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#2-copy_processå‡½æ•°">#</a></h4>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221030190536.png" alt="20221030190536"  />
</p>
<ul>
<li><strong>ï¼ˆ1ï¼‰æ ‡å¿—ç»„åˆ</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">CLONE_NEWNS &amp; CLONE_FS</td>
<td style="text-align:center">æ–°è¿›ç¨‹å±äºæ–°æŒ‚è½½å‘½åç©ºé—´<br>å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">CLONE_NEWUSER &amp; CLONE_FS</td>
<td style="text-align:center">æ–°è¿›ç¨‹å±äºæ–°ç”¨æˆ·å‘½åç©ºé—´<br>å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">CLONE_THREAD <br> æœªè®¾ç½®CLONE_SIGHAND</td>
<td style="text-align:center">æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œ<br>ä½†ä¸å…±äº«ä¿¡å·å¤„ç†ç¨‹åº</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">CLONE_SIGHAND <br> æœªè®¾ç½®CLONE_VM</td>
<td style="text-align:center">æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·å¤„ç†ç¨‹åºï¼Œ<br>ä½†ä¸å…±äº«è™šæ‹Ÿå†…å­˜</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>ï¼ˆ2ï¼‰dup_task_structå‡½æ•°</strong>
â€ƒæœªæ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦åˆ†é…å†…å­˜ï¼Œå¤åˆ¶å½“å‰è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸ºæ–°è¿›ç¨‹åˆ†é…å†…æ ¸æ ˆ</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221030192206.png" alt="20221030192206"  title="è¿›ç¨‹çš„å†…æ ¸æ ˆ"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">union</span> thread_union {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef CONFIG_ARCH_TASK_STRUCT_ON_STACK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> task_struct task;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef CONFIG_THREAD_INFO_IN_TASK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> thread_info thread_info;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack[THREAD_SIZE<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">long</span>)];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚å†…æ ¸æ ˆä¸¤ç§å¸ƒå±€</p>
<ul>
<li>
<ol>
<li>thread_infoåœ¨å†…æ ¸æ ˆé¡¶éƒ¨ï¼Œæˆå‘˜taskæŒ‡å‘è¿›ç¨‹æè¿°ç¬¦</li>
</ol>
</li>
<li>
<ol start="2">
<li>thread_infoæœªå ç”¨å†…æ ¸æ ˆ
â€ƒç¬¬äºŒç§å¸ƒå±€éœ€æ‰“å¼€CONFIG_THREAD_INFO_IN_TASKï¼ŒARM64ä½¿ç”¨ç¬¬äºŒç§å†…æ ¸æ ˆå¸ƒå±€ï¼Œthread_infoç»“æ„ä½“åœ°å€ä¸è¿›ç¨‹æè¿°ç¬¦åœ°å€ç›¸åŒã€‚è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼æ—¶ï¼ŒARM64æ¶æ„çš„å†…æ ¸ä½¿ç”¨ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0å­˜æ”¾å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“åœ°å€ï¼Œå¯åŒæ—¶å¾—åˆ°thread_infoåœ°å€å’Œè¿›ç¨‹æè¿°ç¬¦åœ°å€
â€ƒå†…æ ¸æ ˆçš„é•¿åº¦æ—¶<code>THREAD_SIZE</code>ï¼Œ<strong>ARM64æ¶æ„å†…æ ¸æ ˆé•¿åº¦ä¸º16KB</strong>
â€‚thread_infoå­˜æ”¾æ±‡ç¼–ä»£ç ç›´æ¥è®¿é—®çš„åº•å±‚æ•°æ®ï¼ŒARM64æ¶æ„å®šä¹‰ç»“æ„ä½“</li>
</ol>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/thread_info.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> thread_info {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>		flags;		<span style="color:#75715e">/* low level flags åº•å±‚æ ‡å¿—ä½ */</span>
</span></span><span style="display:flex;"><span>	mm_segment_t		addr_limit;	<span style="color:#75715e">/* address limit åœ°å€é™åˆ¶ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ARM64_SW_TTBR0_PAN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	u64			ttbr0;		<span style="color:#75715e">/* saved TTBR0_EL1 ä¿å­˜çš„å¯„å­˜å™¨TTBR0_EL1 */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    u64		preempt_count;	<span style="color:#75715e">/* æŠ¢å è®¡æ•°å™¨ 0 =&gt; preemptible å¯æŠ¢å , &lt;0 =&gt; bugç¼ºé™· */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>
<p><strong>ï¼ˆ3ï¼‰copy_credså‡½æ•°</strong>
â€ƒè´Ÿè´£å¤åˆ¶æˆ–å…±äº«è¯ä¹¦ï¼Œè¯ä¹¦å­˜æ”¾è¿›ç¨‹çš„ç”¨æˆ·æ ‡è¯†ç¬¦ã€ç»„æ ‡è¯†ç¬¦å’Œè®¿é—®æƒé™ã€‚è®¾ç½®æ ‡å¿—CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ã€‚CLONE_NEWUSERï¼Œéœ€è¦ä¸ºæ–°è¿›ç¨‹åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿›ç¨‹è®¡æ•°å™¨åŠ 1</p>
</li>
<li>
<p><strong>ï¼ˆ4ï¼‰æ£€æŸ¥çº¿ç¨‹æ•°é‡é™åˆ¶</strong>
â€ƒå…¨å±€å˜é‡nr_threadså­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡ï¼Œmax_threadså­˜æ”¾å…è®¸åˆ›å»ºçš„çº¿ç¨‹æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼MAX_THREADS</p>
</li>
<li>
<p><strong>ï¼ˆ5ï¼‰sched_forkå‡½æ•°</strong></p>
</li>
</ul>
<p>â€ƒä¸ºæ–°è¿›ç¨‹è®¾ç½®è°ƒåº¦å™¨ç›¸å…³çš„å‚æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c  ä¹¦ä¸­ä¸º4.xç‰ˆæœ¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sched_fork</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	__sched_fork(clone_flags, p);   <span style="color:#75715e">// æ‰§è¡ŒåŸºæœ¬è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * We mark the process as NEW here. This guarantees that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * nobody will actually run it, and a signal or other external
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * event cannot wake it up and insert it on the runqueue either.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> TASK_NEW;    <span style="color:#75715e">// æ–°è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºTASK_NEW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Make sure we do not leak PI boosting priority to the child.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>prio <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>normal_prio;  <span style="color:#75715e">// æ–°è¿›ç¨‹è°ƒåº¦ä¼˜å…ˆçº§è®¾ç½®ä¸ºå½“å‰è¿›ç¨‹æ­£å¸¸ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	uclamp_fork(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Revert to default priority/policy on fork if requested.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (unlikely(p<span style="color:#f92672">-&gt;</span>sched_reset_on_fork)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (task_has_dl_policy(p) <span style="color:#f92672">||</span> task_has_rt_policy(p)) { <span style="color:#75715e">// é™æœŸè¿›ç¨‹æˆ–å®æ—¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>policy <span style="color:#f92672">=</span> SCHED_NORMAL;  <span style="color:#75715e">// è°ƒåº¦ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>static_prio <span style="color:#f92672">=</span> NICE_TO_PRIO(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>rt_priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;  
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (PRIO_TO_NICE(p<span style="color:#f92672">-&gt;</span>static_prio) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// æ™®é€šè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>static_prio <span style="color:#f92672">=</span> NICE_TO_PRIO(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>prio <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>normal_prio <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>static_prio;
</span></span><span style="display:flex;"><span>		set_load_weight(p, false);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * We don&#39;t need the reset flag anymore after the fork. It has
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * fulfilled its duty:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 */</span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>sched_reset_on_fork <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (dl_prio(p<span style="color:#f92672">-&gt;</span>prio)) <span style="color:#75715e">// è°ƒåº¦ä¼˜å…ˆçº§æ˜¯é™æœŸè°ƒåº¦ç´¯çš„ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EAGAIN;  <span style="color:#75715e">// ä¸å…è®¸é™æœŸè¿›ç¨‹åˆ†å‰ç”Ÿæˆæ–°çš„é™æœŸè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (rt_prio(p<span style="color:#f92672">-&gt;</span>prio))  <span style="color:#75715e">// è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å®æ—¶è°ƒåº¦ç±»ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		p<span style="color:#f92672">-&gt;</span>sched_class <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>rt_sched_class; <span style="color:#75715e">// è°ƒåº¦ç±»è®¾ç½®ä¸ºå®æ—¶è°ƒåº¦ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>sched_class <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>fair_sched_class;  <span style="color:#75715e">// è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å…¬å¹³è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§ï¼Œè°ƒåº¦ç±»è®¾ç½®ä¸ºå…¬å¹³è°ƒåº¦ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	init_entity_runnable_average(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>se);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SCHED_INFO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (likely(sched_info_on()))
</span></span><span style="display:flex;"><span>		memset(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>sched_info, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>sched_info));
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_SMP)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	p<span style="color:#f92672">-&gt;</span>on_cpu <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	init_task_preempt_count(p);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	plist_node_init(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pushable_tasks, MAX_PRIO);
</span></span><span style="display:flex;"><span>	RB_CLEAR_NODE(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pushable_dl_tasks);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><strong>ï¼ˆ6ï¼‰å¤åˆ¶æˆ–å…±äº«èµ„æº</strong></li>
</ul>
<p>â€ƒ1ï¼‰UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰å…±äº«UNIXç³»ç»Ÿçš„5ä¿¡å·é‡ï¼Œcopy_semundoå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/ipc/sem.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_semundo</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sem_undo_list <span style="color:#f92672">*</span>undo_list;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> error;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_SYSVSEM) {  <span style="color:#75715e">// CLONE_SYSTEMè¡¨ç¤ºUNIXç³»ç»Ÿ5ä¿¡å·é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		error <span style="color:#f92672">=</span> get_undo_list(<span style="color:#f92672">&amp;</span>undo_list);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (error)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> error;
</span></span><span style="display:flex;"><span>		refcount_inc(<span style="color:#f92672">&amp;</span>undo_list<span style="color:#f92672">-&gt;</span>refcnt); <span style="color:#75715e">// 5ä¿¡å·é‡çš„æ’¤é”€è¯·æ±‚é“¾è¡¨ï¼Œsem_undo_list è®¡æ•°+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		tsk<span style="color:#f92672">-&gt;</span>sysvsem.undo_list <span style="color:#f92672">=</span> undo_list;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		tsk<span style="color:#f92672">-&gt;</span>sysvsem.undo_list <span style="color:#f92672">=</span> NULL; <span style="color:#75715e">// æ–°è¿›ç¨‹5ä¿¡å·é‡æ’¤é”€è¯·æ±‚é“¾è¡¨ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚2ï¼‰æ‰“å¼€æ–‡ä»¶å¤¹ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ç›´æ¥å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ï¼Œå‡½æ•°copy_fileså¤åˆ¶æˆ–å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_files</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> files_struct <span style="color:#f92672">*</span>oldf, <span style="color:#f92672">*</span>newf;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> error <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * A background process may not have any files ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	oldf <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>files;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>oldf)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_FILES) { <span style="color:#75715e">// CLONE_FIELSå…±äº«æ‰“å¼€æ–‡ä»¶è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		atomic_inc(<span style="color:#f92672">&amp;</span>oldf<span style="color:#f92672">-&gt;</span>count);  <span style="color:#75715e">// files_struct è®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	newf <span style="color:#f92672">=</span> dup_fd(oldf, NR_OPEN_MAX, <span style="color:#f92672">&amp;</span>error);  <span style="color:#75715e">// æ–°è¿›ç¨‹æŠŠå½“å‰è¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶è¡¨å¤åˆ¶ä¸€ä»½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>newf)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>files <span style="color:#f92672">=</span> newf;
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>out:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> error;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ3ï¼‰æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ã€‚è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡å·åŒ…æ‹¬ï¼šæ ¹ç›®å½•ã€å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ¨¡å¼åˆ›å»ºæ©ç ã€‚åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯     <br>
â€‚â€ƒå‡½æ•°copy_fså¤åˆ¶æˆ–å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_fs</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> fs_struct <span style="color:#f92672">*</span>fs <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>fs;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_FS) {  <span style="color:#75715e">// CLONE_FSå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">/* tsk-&gt;fs is already what we want */</span>
</span></span><span style="display:flex;"><span>		spin_lock(<span style="color:#f92672">&amp;</span>fs<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (fs<span style="color:#f92672">-&gt;</span>in_exec) {
</span></span><span style="display:flex;"><span>			spin_unlock(<span style="color:#f92672">&amp;</span>fs<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EAGAIN;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		fs<span style="color:#f92672">-&gt;</span>users<span style="color:#f92672">++</span>;  <span style="color:#75715e">// fs_structå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ç»“æ„ä½“ åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		spin_unlock(<span style="color:#f92672">&amp;</span>fs<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>fs <span style="color:#f92672">=</span> copy_fs_struct(fs);  <span style="color:#75715e">// æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>tsk<span style="color:#f92672">-&gt;</span>fs)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ4ï¼‰ä¿¡å·å¤„ç†ç¨‹åºï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«ä¿¡å·å¤„ç†ç¨‹åº <br>
â€‚â€ƒå‡½æ•°copy_sighandå¤åˆ¶æˆ–å…±äº«ä¿¡å·å¤„ç†ç¨‹åº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_sighand</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sighand_struct <span style="color:#f92672">*</span>sig;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_SIGHAND) {  <span style="color:#75715e">// CLONE_SIGHAND è¡¨ç¤ºå…±äº«ä¿¡å·å¤„ç†ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		refcount_inc(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>count); <span style="color:#75715e">// å¼•ç”¨è®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹ä¿¡å·å¤„ç†ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	sig <span style="color:#f92672">=</span> kmem_cache_alloc(sighand_cachep, GFP_KERNEL);
</span></span><span style="display:flex;"><span>	RCU_INIT_POINTER(tsk<span style="color:#f92672">-&gt;</span>sighand, sig);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>sig)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	refcount_set(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>count, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	spin_lock_irq(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>	memcpy(sig<span style="color:#f92672">-&gt;</span>action, current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>action, <span style="color:#66d9ef">sizeof</span>(sig<span style="color:#f92672">-&gt;</span>action));
</span></span><span style="display:flex;"><span>	spin_unlock_irq(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Reset all signal handler not set to SIG_IGN to SIG_DFL. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_CLEAR_SIGHAND)
</span></span><span style="display:flex;"><span>		flush_signal_handlers(tsk, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ5ï¼‰ä¿¡å·ç»“æ„ä½“ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«ä¿¡å·ç»“æ„ä½“   <br>
â€‚â€ƒå‡½æ•°copy_signalå¤åˆ¶æˆ–å…±äº«ä¿¡å·ç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_signal</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> signal_struct <span style="color:#f92672">*</span>sig;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_THREAD)  <span style="color:#75715e">// CLONE_THREADè¡¨ç¤ºåˆ›å»ºçº¿ç¨‹ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·ç»“æ„ä½“signal_struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ºæ–°è¿›ç¨‹åˆ†é…ç»“æ„ä½“ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹èµ„æºé™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	sig <span style="color:#f92672">=</span> kmem_cache_zalloc(signal_cachep, GFP_KERNEL);
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>signal <span style="color:#f92672">=</span> sig;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>sig)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>nr_threads <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	atomic_set(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>live, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	refcount_set(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>sigcnt, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* list_add(thread_node, thread_head) without INIT_LIST_HEAD() */</span>
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>thread_head <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> list_head)LIST_HEAD_INIT(tsk<span style="color:#f92672">-&gt;</span>thread_node);
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>thread_node <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> list_head)LIST_HEAD_INIT(sig<span style="color:#f92672">-&gt;</span>thread_head);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	init_waitqueue_head(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>wait_chldexit);
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>curr_target <span style="color:#f92672">=</span> tsk;
</span></span><span style="display:flex;"><span>	init_sigpending(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>shared_pending);
</span></span><span style="display:flex;"><span>	INIT_HLIST_HEAD(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>multiprocess);
</span></span><span style="display:flex;"><span>	seqlock_init(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>stats_lock);
</span></span><span style="display:flex;"><span>	prev_cputime_init(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>prev_cputime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_POSIX_TIMERS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	INIT_LIST_HEAD(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>posix_timers);
</span></span><span style="display:flex;"><span>	hrtimer_init(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>real_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>real_timer.function <span style="color:#f92672">=</span> it_real_fn;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	task_lock(current<span style="color:#f92672">-&gt;</span>group_leader);
</span></span><span style="display:flex;"><span>	memcpy(sig<span style="color:#f92672">-&gt;</span>rlim, current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>rlim, <span style="color:#66d9ef">sizeof</span> sig<span style="color:#f92672">-&gt;</span>rlim);
</span></span><span style="display:flex;"><span>	task_unlock(current<span style="color:#f92672">-&gt;</span>group_leader);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	posix_cpu_timers_init_group(sig);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tty_audit_fork(sig);
</span></span><span style="display:flex;"><span>	sched_autogroup_fork(sig);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>oom_score_adj <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>oom_score_adj;
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>oom_score_adj_min <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>oom_score_adj_min;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	mutex_init(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>cred_guard_mutex);
</span></span><span style="display:flex;"><span>	init_rwsem(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>exec_update_lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ6ï¼‰è™šæ‹Ÿå†…å­˜ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«è™šæ‹Ÿå†…å­˜  \
â€‚â€ƒå‡½æ•°copy_mmå¤åˆ¶æˆ–å…±äº«è™šæ‹Ÿå†…å­˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/freezer.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_mm</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#f92672">*</span>oldmm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> retval;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>min_flt <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>maj_flt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>nvcsw <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>nivcsw <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_DETECT_HUNG_TASK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	tsk<span style="color:#f92672">-&gt;</span>last_switch_count <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>nvcsw <span style="color:#f92672">+</span> tsk<span style="color:#f92672">-&gt;</span>nivcsw;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>last_switch_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Are we cloning a kernel thread?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * We need to steal a active VM for that..
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	oldmm <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>oldmm)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* initialize the new vmacache entries */</span>
</span></span><span style="display:flex;"><span>	vmacache_flush(tsk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_VM) {  <span style="color:#75715e">// CLONE_VMè¡¨ç¤ºå…±äº«è™šæ‹Ÿå†…å­˜ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å†…å­˜æè¿°ç¬¦mm_struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		mmget(oldmm);
</span></span><span style="display:flex;"><span>		mm <span style="color:#f92672">=</span> oldmm;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> good_mm;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	retval <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mm <span style="color:#f92672">=</span> dup_mm(tsk, current<span style="color:#f92672">-&gt;</span>mm);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mm)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> fail_nomem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>good_mm:
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>mm <span style="color:#f92672">=</span> mm;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fail_nomem:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> retval;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ7ï¼‰å‘½åç©ºé—´    <br>
â€‚â€ƒå‡½æ•°copy_namespaceåˆ›å»ºæˆ–å…±äº«å‘½åç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/nsproxy.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_namespaces</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>old_ns <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>nsproxy;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> user_namespace <span style="color:#f92672">*</span>user_ns <span style="color:#f92672">=</span> task_cred_xxx(tsk, user_ns);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>new_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœå…±äº«é™¤äº†ç”¨æˆ·ä»¥å¤–çš„æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é‚£ä¹ˆæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å‘½åç©ºé—´ä»£ç†ç»“æ„ä½“nsproxyï¼ŒæŠŠè®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (likely(<span style="color:#f92672">!</span>(flags <span style="color:#f92672">&amp;</span> (CLONE_NEWNS <span style="color:#f92672">|</span> CLONE_NEWUTS <span style="color:#f92672">|</span> CLONE_NEWIPC <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>			      CLONE_NEWPID <span style="color:#f92672">|</span> CLONE_NEWNET <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>			      CLONE_NEWCGROUP <span style="color:#f92672">|</span> CLONE_NEWTIME)))) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (likely(old_ns<span style="color:#f92672">-&gt;</span>time_ns_for_children <span style="color:#f92672">==</span> old_ns<span style="color:#f92672">-&gt;</span>time_ns)) {
</span></span><span style="display:flex;"><span>			get_nsproxy(old_ns);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ns_capable(user_ns, CAP_SYS_ADMIN)) 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿›ç¨‹æ²¡æœ‰ç³»ç»Ÿç®¡ç†æƒé™ï¼Œé‚£ä¹ˆä¸å…è®¸åˆ›å»ºæ–°çš„å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EPERM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* CLONE_NEWIPC must detach from the undolist: after switching
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * to a new ipc namespace, the semaphore arrays from the old
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * namespace are unreachable.  In clone parlance, CLONE_SYSVSEM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * means share undolist with parent, so we must forbid using
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * it along with CLONE_NEWIPC. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ—¢è¦æ±‚åˆ›å»ºæ–°çš„è¿›ç¨‹é—´é€šä¿¡å‘½åç©ºé—´ï¼Œåˆè¦æ±‚å…±äº«UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼Œé‚£ä¹ˆè¿™ç§è¦æ±‚æ˜¯ä¸åˆç†çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> ((flags <span style="color:#f92672">&amp;</span> (CLONE_NEWIPC <span style="color:#f92672">|</span> CLONE_SYSVSEM)) <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>		(CLONE_NEWIPC <span style="color:#f92672">|</span> CLONE_SYSVSEM)) 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ›å»ºæ–°çš„å‘½åç©ºé—´ä»£ç†ï¼Œç„¶ååˆ›å»ºæˆ–è€…å…±äº«å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	new_ns <span style="color:#f92672">=</span> create_new_namespaces(flags, tsk, user_ns, tsk<span style="color:#f92672">-&gt;</span>fs);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (IS_ERR(new_ns))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>  PTR_ERR(new_ns);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ret <span style="color:#f92672">=</span> timens_on_fork(new_ns, tsk);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (ret) {
</span></span><span style="display:flex;"><span>		free_nsproxy(new_ns);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>nsproxy <span style="color:#f92672">=</span> new_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ8ï¼‰I/Oä¸Šä¸‹æ–‡    <br>
â€‚â€ƒå‡½æ•°copy_ioåˆ›å»ºæˆ–å…±äº«I/Oä¸Šä¸‹æ–‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_io</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_BLOCK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> io_context <span style="color:#f92672">*</span>ioc <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>io_context;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> io_context <span style="color:#f92672">*</span>new_ioc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ioc)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Share io context with parent, if CLONE_IO is set */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_IO) {  <span style="color:#75715e">// CLONE_IO å…±äº«I/Oä¸Šå°æ–‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ioc_task_link(ioc);  <span style="color:#75715e">// è®¡æ•°nr_tasksåŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		tsk<span style="color:#f92672">-&gt;</span>io_context <span style="color:#f92672">=</span> ioc;  <span style="color:#75715e">// å…±äº«I/Oä¸Šä¸‹æ–‡ç»“æ„ä½“io_context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ioprio_valid(ioc<span style="color:#f92672">-&gt;</span>ioprio)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºæ–°çš„I/Oä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹çš„I/Oä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		new_ioc <span style="color:#f92672">=</span> get_task_io_context(tsk, GFP_KERNEL, NUMA_NO_NODE);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (unlikely(<span style="color:#f92672">!</span>new_ioc))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		new_ioc<span style="color:#f92672">-&gt;</span>ioprio <span style="color:#f92672">=</span> ioc<span style="color:#f92672">-&gt;</span>ioprio;
</span></span><span style="display:flex;"><span>		put_io_context(new_ioc);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ9ï¼‰å¤åˆ¶å¯„å­˜å™¨å€¼   <br>
â€‚â€ƒå‡½æ•°copy_thread_tlså¤åˆ¶å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨å€¼ï¼Œå¹¶ä¿®æ”¹ä¸€éƒ¨åˆ†å¯„å­˜å™¨å€¼ã€‚è¿›ç¨‹æœ‰ä¸¤å¤„ç”¨æ¥ä¿å­˜å¯„å­˜å™¨å€¼ï¼šä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼æ—¶ï¼ŒæŠŠç”¨æˆ·æ¨¡å¼çš„å„ç§å¯„å­˜å™¨ä¿å­˜åœ¨å†…æ ¸æ ˆåº•éƒ¨çš„ç»“æ„ä½“pt_regsä¸­ï¼›è¿›ç¨‹è°ƒåº¦å™¨è°ƒåº¦è¿›ç¨‹æ—¶ï¼Œåˆ‡æ¢å‡ºå»çš„è¿›ç¨‹æŠŠå¯„å­˜å™¨å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜threadä¸­ã€‚å› ä¸ºä¸åŒå¤„ç†å™¨æ¶æ„çš„å¯„å­˜å™¨ä¸åŒï¼Œæ‰€ä»¥å„ç§å¤„ç†å™¨æ¶æ„éœ€è¦è‡ªå·±å®šä¹‰ç»“æ„ä½“pt_regså’Œthread_struct</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221030211811.png" alt="20221030211811"  />
</p>
<p>â€‚â€ƒARM64æ¶æ„copy_thread_tls-&gt;copy_thread</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/kernel/process.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_thread</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack_start,
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stk_sz, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> tls)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>childregs <span style="color:#f92672">=</span> task_pt_regs(p);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextæ¸…é›¶ï¼Œåœ¨è°ƒåº¦è¿›ç¨‹æ—¶åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹ä½¿ç”¨è¿™ä¸ªæˆå‘˜ä¿å­˜é€šç”¨å¯„å­˜å™¨çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	memset(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> cpu_context));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* In case p was allocated the same task_struct pointer as some
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * other recently-exited task, make sure p is disassociated from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * any cpu that may have run that now-exited task recently.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Otherwise we could erroneously skip reloading the FPSIMD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * registers for p. */</span>
</span></span><span style="display:flex;"><span>	fpsimd_flush_task_state(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ptrauth_thread_init_kernel(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (likely(<span style="color:#f92672">!</span>(p<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> PF_KTHREAD))) {  <span style="color:#75715e">// ç”¨æˆ·è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">*</span>childregs <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>current_pt_regs();
</span></span><span style="display:flex;"><span>		childregs<span style="color:#f92672">-&gt;</span>regs[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Read the current TLS pointer from tpidr_el0 as it may be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * out-of-sync with the saved value.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * ä»å¯„å­˜å™¨tpidr_el0è¯»å–å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * å› ä¸ºå®ƒå¯èƒ½å’Œä¿å­˜çš„å€¼ä¸ä¸€è‡´ */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span>task_user_tls(p) <span style="color:#f92672">=</span> read_sysreg(tpidr_el0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (stack_start) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (is_compat_thread(task_thread_info(p)))
</span></span><span style="display:flex;"><span>				childregs<span style="color:#f92672">-&gt;</span>compat_sp <span style="color:#f92672">=</span> stack_start;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>				childregs<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> stack_start;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* If a TLS pointer was passed to clone, use it for the new thread. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * å¦‚æœæŠŠçº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ä¼ ç»™ç³»ç»Ÿè°ƒç”¨cloneçš„ç¬¬4ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ–°çº¿ç¨‹å°†ä½¿ç”¨å®ƒ*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_SETTLS)
</span></span><span style="display:flex;"><span>			p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.uw.tp_value <span style="color:#f92672">=</span> tls;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">// å†…æ ¸çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		memset(childregs, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> pt_regs));
</span></span><span style="display:flex;"><span>		childregs<span style="color:#f92672">-&gt;</span>pstate <span style="color:#f92672">=</span> PSR_MODE_EL1h;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (IS_ENABLED(CONFIG_ARM64_UAO) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    cpus_have_const_cap(ARM64_HAS_UAO))
</span></span><span style="display:flex;"><span>			childregs<span style="color:#f92672">-&gt;</span>pstate <span style="color:#f92672">|=</span> PSR_UAO_BIT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		spectre_v4_enable_task_mitigation(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (system_uses_irq_prio_masking())
</span></span><span style="display:flex;"><span>			childregs<span style="color:#f92672">-&gt;</span>pmr_save <span style="color:#f92672">=</span> GIC_PRIO_IRQON;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.x19 <span style="color:#f92672">=</span> stack_start;
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.x20 <span style="color:#f92672">=</span> stk_sz;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.pc <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)ret_from_fork;
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.sp <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)childregs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ptrace_hw_copy_thread(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><strong>ï¼ˆ7ï¼‰è®¾ç½®è¿›ç¨‹å·å’Œè¿›ç¨‹å…³ç³»</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> __latent_entropy <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span><span style="color:#a6e22e">copy_process</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">struct</span> pid <span style="color:#f92672">*</span>pid,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">int</span> trace,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">int</span> node,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">struct</span> kernel_clone_args <span style="color:#f92672">*</span>args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ºæ–°è¿›ç¨‹åˆ†é…è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// pidç­‰äºinit_struct_pidçš„åœ°å€ï¼Œå†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œå¼•å¯¼å¤„ç†å™¨ä¸ºæ¯ä¸ªä»å¤„ç†å™¨åˆ†å‰ç”Ÿæˆä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼ˆå‚è€ƒå‡½æ•°idle_threads_initï¼‰ï¼Œæ‰€æœ‰å¤„ç†å™¨çš„ç©ºé—²çº¿ç¨‹ä½¿ç”¨è¿›ç¨‹å·0ï¼Œå…¨å±€å˜é‡init_struct_pidå­˜æ”¾ç©ºé—²çº¿ç¨‹çš„è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>init_struct_pid) {
</span></span><span style="display:flex;"><span>        pid <span style="color:#f92672">=</span> alloc_pid(p<span style="color:#f92672">-&gt;</span>nsproxy<span style="color:#f92672">-&gt;</span>pid_ns_for_children);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (IS_ERR(pid)) {
</span></span><span style="display:flex;"><span>            retval <span style="color:#f92672">=</span> PTR_ERR(pid);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> bad_fork_cleanup_thread;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¾ç½®æ–°è¿›ç¨‹é€€å‡ºæ—¶å‘é€ç»™çˆ¶è¿›ç¨‹çš„ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> pid_nr(pid);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_THREAD) {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>exit_signal <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// æ–°çº¿ç¨‹é€€å‡ºæ—¶ä¸éœ€è¦å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>group_leader <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>group_leader;  <span style="color:#75715e">// group_leaderæŒ‡å‘åŒä¸€ä¸ªç»„é•¿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>tgid <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>tgid;  <span style="color:#75715e">// tgidå­˜æ”¾ç»„é•¿çš„è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_PARENT) <span style="color:#75715e">// CLONE_PARENT æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ˜¯å…„å¼Ÿå…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            p<span style="color:#f92672">-&gt;</span>exit_signal <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>group_leader<span style="color:#f92672">-&gt;</span>exit_signal;  <span style="color:#75715e">// æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalç­‰äºå½“å‰è¿›ç¨‹æ‰€å±çº¿ç¨‹ç»„çš„ç»„é•¿çš„æˆå‘˜exit_signal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#75715e">// çˆ¶å­å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            p<span style="color:#f92672">-&gt;</span>exit_signal <span style="color:#f92672">=</span> (clone_flags <span style="color:#f92672">&amp;</span> CSIGNAL); <span style="color:#75715e">// æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalæ˜¯è°ƒç”¨è€…æŒ‡å®šçš„ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>group_leader <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>tgid <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ§åˆ¶ç»„çš„è¿›ç¨‹æ•°æ§åˆ¶å™¨æ£€æŸ¥æ˜¯å¦å…è®¸åˆ›å»ºæ–°è¿›ç¨‹ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä»å½“å‰è¿›ç¨‹æ‰€å±çš„æ§åˆ¶ç»„ä¸€ç›´åˆ°æ§åˆ¶ç»„å±‚çº§çš„æ ¹ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¦‚æœå…¶ä¸­ä¸€ä¸ªæ§åˆ¶ç»„çš„è¿›ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºé™åˆ¶ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é‚£ä¹ˆä¸å…è®¸ä½¿ç”¨forkå’Œcloneåˆ›å»ºæ–°è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    cgroup_threadgroup_change_begin(current);
</span></span><span style="display:flex;"><span>    retval <span style="color:#f92672">=</span> cgroup_can_fork(p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (retval)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> bad_fork_free_pid;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    write_lock_irq(<span style="color:#f92672">&amp;</span>tasklist_lock);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ºæ–°è¿›ç¨‹è®¾ç½®çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> (CLONE_PARENT<span style="color:#f92672">|</span>CLONE_THREAD)) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ‹¥æœ‰ç›¸åŒçš„çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>real_parent <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>real_parent;  
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>parent_exec_id <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>parent_exec_id;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>real_parent <span style="color:#f92672">=</span> current;  <span style="color:#75715e">// æ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯å½“å‰è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>parent_exec_id <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>self_exec_id;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    spin_lock(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (likely(p<span style="color:#f92672">-&gt;</span>pid)) {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>        init_task_pid(p, PIDTYPE_PID, pid);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (thread_group_leader(p)) {  <span style="color:#75715e">// true æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            init_task_pid(p, PIDTYPE_PGID, task_pgrp(current));  <span style="color:#75715e">// æŒ‡å‘åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿çš„è¿›ç¨‹å·ç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            init_task_pid(p, PIDTYPE_SID, task_session(current));  <span style="color:#75715e">// æŒ‡å‘åŒä¸€ä¸ªä¼šè¯çš„æ§åˆ¶è¿›ç¨‹çš„è¿›ç¨‹å·ç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (is_child_reaper(pid)) {  
</span></span><span style="display:flex;"><span>                ns_of_pid(pid)<span style="color:#f92672">-&gt;</span>child_reaper <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>                p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">|=</span> SIGNAL_UNKILLABLE;  <span style="color:#75715e">// 1å·è¿›ç¨‹æ˜¯ä¸èƒ½æ€æ­»çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>leader_pid <span style="color:#f92672">=</span> pid;
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>tty <span style="color:#f92672">=</span> tty_kref_get(current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>tty);
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>has_child_subreaper <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>real_parent<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span> has_child_subreaper <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>                                p<span style="color:#f92672">-&gt;</span>real_parent<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>is_child_subreaper;
</span></span><span style="display:flex;"><span>            list_add_tail(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>sibling, <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>real_parent<span style="color:#f92672">-&gt;</span>children);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°çˆ¶è¿›ç¨‹çš„å­è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹é“¾è¡¨ä¸­ï¼Œé“¾è¡¨èŠ‚ç‚¹æ˜¯æˆå‘˜tasksï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// å¤´èŠ‚ç‚¹æ˜¯ç©ºé—²çº¿ç¨‹çš„æˆå‘˜tasksï¼ˆinit_task.tasksï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            list_add_tail_rcu(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>tasks, <span style="color:#f92672">&amp;</span>init_task.tasks);  
</span></span><span style="display:flex;"><span>            attach_pid(p, PIDTYPE_PGID);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹ç»„çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            attach_pid(p, PIDTYPE_SID);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°ä¼šè¯çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            __this_cpu_inc(process_counts);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">// åˆ›å»ºçº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>nr_threads<span style="color:#f92672">++</span>;  <span style="color:#75715e">// çº¿ç¨‹ç»„çš„çº¿ç¨‹è®¡æ•°å€¼åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            atomic_inc(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>live);  <span style="color:#75715e">// åŸå­å˜é‡çº¿ç¨‹ç»„çš„ç¬¬2ä¸ªçº¿ç¨‹è®¡æ•°å€¼åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            atomic_inc(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>sigcnt);  <span style="color:#75715e">// ä¿¡å·ç»“æ„ä½“çš„å¼•ç”¨è®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            list_add_tail_rcu(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>thread_group,    
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>group_leader<span style="color:#f92672">-&gt;</span>thread_group);  <span style="color:#75715e">// çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„çº¿ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            list_add_tail_rcu(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>thread_node,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>thread_head);  <span style="color:#75715e">// çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„ç¬¬äºŒæ¡çº¿ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        attach_pid(p, PIDTYPE_PID);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        nr_threads<span style="color:#f92672">++</span>;  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    total_forks<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    spin_unlock(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    write_unlock_irq(<span style="color:#f92672">&amp;</span>tasklist_lock);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    proc_fork_connector(p);
</span></span><span style="display:flex;"><span>    cgroup_post_fork(p);
</span></span><span style="display:flex;"><span>    cgroup_threadgroup_change_end(current);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3å”¤é†’æ–°è¿›ç¨‹">3.å”¤é†’æ–°è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#3å”¤é†’æ–°è¿›ç¨‹">#</a></h4>
<p>â€ƒwake_up_new_taskå‡½æ•°å”¤é†’æ–°è¿›ç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">wake_up_new_task</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq_flags rf;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	raw_spin_lock_irqsave(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pi_lock, rf.flags);
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> TASK_RUNNING;  <span style="color:#75715e">// åˆ‡æ¢TASK_RUNNING
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Fork balancing, do it here and not earlier because:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *  - cpus_ptr can change in the fork path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *  - any previously selected CPU might disappear through hotplug
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Use __set_task_cpu() to avoid calling sched_class::migrate_task_rq,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * as we&#39;re not fully set-up yet.*/</span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>recent_used_cpu <span style="color:#f92672">=</span> task_cpu(p);
</span></span><span style="display:flex;"><span>	rseq_migrate(p);
</span></span><span style="display:flex;"><span>	__set_task_cpu(p, select_task_rq(p, task_cpu(p), SD_BALANCE_FORK, <span style="color:#ae81ff">0</span>));  <span style="color:#75715e">// åœ¨SMPç³»ç»Ÿä¸Šï¼Œåˆ›å»ºæ–°è¿›ç¨‹æ˜¯æ‰§è¡Œè´Ÿè½½å‡è¡¡çš„ç»ä½³æ—¶æœºï¼Œä¸ºæ–°è¿›ç¨‹é€‰æ‹©ä¸€ä¸ªè´Ÿè½½æœ€è½»çš„å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	rq <span style="color:#f92672">=</span> __task_rq_lock(p, <span style="color:#f92672">&amp;</span>rf);  <span style="color:#75715e">// é”ä½è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	update_rq_clock(rq);  <span style="color:#75715e">// æ›´æ–°è¿è¡Œé˜Ÿåˆ—çš„æ—¶é’Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	post_init_entity_util_avg(p);  <span style="color:#75715e">// æ ¹æ®å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼ï¼Œæ¨ç®—æ–°è¿›ç¨‹çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	activate_task(rq, p, ENQUEUE_NOCLOCK); <span style="color:#75715e">// æŠŠæ–°è¿›ç¨‹æ’å…¥è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	trace_sched_wakeup_new(p);
</span></span><span style="display:flex;"><span>	check_preempt_curr(rq, p, WF_FORK);  <span style="color:#75715e">// æ£€æŸ¥æ–°è¿›ç¨‹æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span>task_woken) {  <span style="color:#75715e">// åœ¨SMPç³»ç»Ÿä¸Šï¼Œè°ƒç”¨è°ƒåº¦ç±»çš„task_wokenæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Nothing relies on rq-&gt;lock after this, so its fine to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * drop it.*/</span>
</span></span><span style="display:flex;"><span>		rq_unpin_lock(rq, <span style="color:#f92672">&amp;</span>rf);
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span>task_woken(rq, p);
</span></span><span style="display:flex;"><span>		rq_repin_lock(rq, <span style="color:#f92672">&amp;</span>rf);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	task_rq_unlock(rq, p, <span style="color:#f92672">&amp;</span>rf);  <span style="color:#75715e">// é‡Šæ”¾è¿è¡Œé˜Ÿåˆ—çš„é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="4æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ">4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ<a hidden class="anchor" aria-hidden="true" href="#4æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ">#</a></h4>
<p>â€ƒæ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæ˜¯ä»å‡½æ•°ret_from_forkå¼€å§‹æ‰§è¡Œï¼ŒARM64çš„ret_from_forkå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    tsk   .req   x28      <span style="color:#75715e">//å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SYM_CODE_START(ret_from_fork)
</span></span><span style="display:flex;"><span>	bl	schedule_tail  <span style="color:#75715e">// ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cbz	x19, <span style="color:#ae81ff">1f</span>  <span style="color:#75715e">// not a kernel thread å¦‚æœå¯„å­˜å™¨x19çš„å€¼æ˜¯0ï¼Œè¯´æ˜å½“å‰è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ ‡å·1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mov	x0, x20  <span style="color:#75715e">// å†…æ ¸çº¿ç¨‹ï¼šx19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œx20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	blr	x19  <span style="color:#75715e">// è°ƒç”¨çº¿ç¨‹å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>	get_current_task tsk  <span style="color:#75715e">// ç”¨æˆ·è¿›ç¨‹ï¼šx28 = sp_el0 = å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b	ret_to_user  <span style="color:#75715e">// è¿”å›ç”¨æˆ·æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>SYM_CODE_END(ret_from_fork)
</span></span><span style="display:flex;"><span>NOKPROBE(ret_from_fork)
</span></span></code></pre></div><p>â€‚â€ƒcopy_threadå‡½æ•°ä¸­ï¼Œæ–°è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œå¯„å­˜å™¨x19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œå¯„å­˜å™¨x20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœæ–°è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œå¯„å­˜å™¨x19å€¼æ˜¯0   <br>
â€‚â€ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage __visible <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">schedule_tail</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev)
</span></span><span style="display:flex;"><span>	__releases(rq<span style="color:#f92672">-&gt;</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* New tasks start with FORK_PREEMPT_COUNT, see there and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * finish_task_switch() for details.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * finish_task_switch() will drop rq-&gt;lock() and lower preempt_count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * and the preempt_enable() will end up enabling preemption (on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * PREEMPT_COUNT kernels).*/</span>
</span></span><span style="display:flex;"><span>	rq <span style="color:#f92672">=</span> finish_task_switch(prev);  <span style="color:#75715e">// ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ2.8.6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	balance_callback(rq);  <span style="color:#75715e">// æ‰§è¡Œè¿è¡Œé˜Ÿåˆ—çš„æ‰€æœ‰è´Ÿè½½å‡è¡¡å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	preempt_enable();  <span style="color:#75715e">// å¼€å¯å†…æ ¸æŠ¢å 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (current<span style="color:#f92672">-&gt;</span>set_child_tid)  <span style="color:#75715e">// pthreadåº“åœ¨è°ƒç”¨clone()åˆ›å»ºçº¿ç¨‹æ—¶è®¾ç½®äº†æ ‡å¿—ä½CLONE_CHILD_SETTIDï¼Œé‚£ä¹ˆæ–°è¿›ç¨‹æŠŠè‡ªå·±çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°æŒ‡å®šä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		put_user(task_pid_vnr(current), current<span style="color:#f92672">-&gt;</span>set_child_tid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	calculate_sigpending();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="242-è£…è½½ç¨‹åº">2.4.2 è£…è½½ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#242-è£…è½½ç¨‹åº">#</a></h3>
<p>â€‚è°ƒåº¦å™¨è°ƒåº¦æ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹ä»å‡½æ•°<code>ret_from_fork</code>å¼€å§‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨<code>fork</code>è¿”å›ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å€¼0ã€‚ç„¶åæ–°è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨<code>execve</code>è£…è½½ç¨‹åºã€‚Linuxå†…æ ¸ç»ƒä¸ªè£…è½½ç¨‹åºç³»ç»Ÿè°ƒç”¨ï¼š    \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// è·¯å¾„åæ˜¯ç›¸å¯¹æ—¶execveè§£é‡Šä¸ºç›¸å¯¹è°ƒç”¨è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">execve</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> argv[], <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> envp[]);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è·¯å¾„åæ˜¯ç›¸å¯¹çš„ï¼Œexecveatè§£é‡Šä¸ºç›¸å¯¹æ–‡ä»¶æè¿°ç¬¦dirfdæŒ‡å‘çš„ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// è·¯å¾„åæ—¶ç»å¯¹çš„ï¼Œexecveatå¿½ç•¥å‚æ•°dirfd
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">execveat</span>(<span style="color:#66d9ef">int</span> dirfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> argv[], <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> envp[], <span style="color:#66d9ef">int</span> flags);
</span></span></code></pre></div><p>â€‚â€ƒå‚æ•°argvæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„å‚æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²çš„åœ°å€ï¼Œargv[0]åº”è¯¥æŒ‡å‘è¦è£…è½½çš„ç¨‹åºçš„åç§°ã€‚å‚æ•°envpæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„ç¯å¢ƒæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªç¯å¢ƒå­—ç¬¦ä¸²çš„åœ°å€ï¼Œç¯å¢ƒå­—ç¬¦ä¸²çš„å½¢å¼æ˜¯â€œé”®=å€¼</p>
<p>â€ƒä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½è°ƒç”¨å‡½æ•°do_execveat_common
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221102001015.png" alt="20221102001015"  />
</p>
<p>â€‚â€ƒå‡½æ•°do_open_execatæ‰“å¼€å¯æ‰§è¡Œæ–‡ä»¶ã€‚   <br>
â€‚â€ƒå‡½æ•°sched_execã€‚è£…è½½ç¨‹åºæ˜¯å®ç°å¤„ç†å™¨è´Ÿè½½å‡è¡¡çš„æœºä¼šï¼Œæ­¤æ—¶è¿›ç¨‹åœ¨å†…å­˜å’Œç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€å°‘çš„ã€‚é€‰æ‹©è´Ÿè½½æœ€è½»çš„å¤„ç†å™¨ï¼Œç„¶åå”¤é†’å½“å‰å¤„ç†å™¨ä¸Šçš„è¿ç§»çº¿ç¨‹ï¼Œå½“å‰è¿›ç¨‹ç¡çœ ç­‰å¾…è¿ç§»çº¿ç¨‹æŠŠè‡ªå·±è¿ç§»åˆ°ç›®æ ‡å¤„ç†å™¨      <br>
â€‚â€ƒå‡½æ•°bprm_mm_initåˆ›å»ºæ–°çš„å†…å­˜æè¿°ç¬¦ï¼Œåˆ†é…é•¿åº¦ä¸ºä¸€é¡µçš„ä¸´æ—¶çš„ç”¨æˆ·æ ˆï¼Œè™šæ‹Ÿåœ°å€èŒƒå›´æ˜¯[STACK_TOP_MAXâˆ’é¡µé•¿åº¦ï¼ŒSTACK_TOP_MAX]ï¼Œbprm-&gt;pæŒ‡å‘åœ¨æ ˆåº•ä¿ç•™ä¸€ä¸ªå­—é•¿ï¼ˆæŒ‡é’ˆé•¿åº¦ï¼‰åçš„ä½ç½®           <br>
â€‚â€ƒå‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»æ–‡ä»¶çš„å‰é¢128å­—èŠ‚åˆ°ç¼“å†²åŒºã€‚128å­—èŠ‚æ˜¯ä»€ä¹ˆï¼Ÿ      \
â€‚â€ƒä¾æ¬¡æŠŠæ–‡ä»¶åç§°ã€ç¯å¢ƒå­—ç¬¦ä¸²å’Œå‚æ•°å­—ç¬¦ä¸²å‹åˆ°ç”¨æˆ·æ ˆ         <br>
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221102001840.png" alt="20221102001840"  />

â€‚â€ƒå‡½æ•°exec_binprmè°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«æ­£åœ¨è£…è½½çš„ç¨‹åºä¸ºæ­¢</p>
<h4 id="1äºŒè¿›åˆ¶æ ¼å¼">1.äºŒè¿›åˆ¶æ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#1äºŒè¿›åˆ¶æ ¼å¼">#</a></h4>
<p>â€‚LinuxäºŒè¿›åˆ¶æ ¼å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/include/linux/binfmts.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> linux_binfmt {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> list_head lh;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> module <span style="color:#f92672">*</span>module;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>load_binary)(<span style="color:#66d9ef">struct</span> linux_binprm <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>load_shlib)(<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>core_dump)(<span style="color:#66d9ef">struct</span> coredump_params <span style="color:#f92672">*</span>cprm);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> min_coredump;	<span style="color:#75715e">/* minimal dump size */</span>
</span></span><span style="display:flex;"><span>} __randomize_layout;
</span></span></code></pre></div><p>â€ƒäºŒè¿›åˆ¶æ ¼å¼æä¾›3ä¸ªå‡½æ•°        <br>
â€‚â€ƒ(1)load_binary åŠ è½½æ™®é€šç¨‹åº       <br>
â€‚â€ƒ(2)load_shlib åŠ è½½å…±äº«åº“     <br>
â€‚â€ƒ(3)core_dump åœ¨è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œmin_coredumpæŒ‡å®šæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶çš„æœ€å°é•¿åº¦     <br>
â€‚äºŒè¿›åˆ¶æ ¼å¼ä½¿ç”¨<code>register_binfmt</code>å‘å†…æ ¸æ³¨å†Œ</p>
<h4 id="2è£…è½½elfç¨‹åº">2.è£…è½½ELFç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#2è£…è½½elfç¨‹åº">#</a></h4>
<p>â€‚ELFæ–‡ä»¶,ELF(Executable and Linkable Format)å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼ <code>linux-5.10.102/include/uapi/linux/elf.h</code></p>
<ul>
<li>ç›®æ ‡æ–‡ä»¶(å¯é‡å®šä½æ–‡ä»¶)ï¼Œ<code>.o</code>ï¼Œå¤šä¸ªæ¨¡æ¿æ–‡ä»¶é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“</li>
<li>å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>å…±äº«åº“ <code>.so</code></li>
<li>æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶(core dump file)</li>
</ul>
<p>â€ƒELFæ–‡ä»¶åˆ†æˆ4éƒ¨åˆ†ï¼š<code>ELFé¦–éƒ¨ã€ç¨‹åºé¦–éƒ¨è¡¨(programe header table)ã€èŠ‚(section)å’ŒèŠ‚é¦–éƒ¨è¡¨(section header table)</code>ï¼ŒELFåªæœ‰é¦–éƒ¨çš„ä½ç½®æ˜¯å›ºå®šçš„ã€‚</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103105503.png" alt="20221103105503"  />
</p>
<p>â€‚â€ƒç¨‹åºé¦–éƒ¨è¡¨å°±æ˜¯æ®µè¡¨(segment table)ï¼Œ<code>æ®µ(segment)æ˜¯ä»è¿è¡Œè§’åº¦æè¿°</code>ï¼Œ<code>èŠ‚(section)æ˜¯ä»é“¾æ¥è§’åº¦æè¿°</code>ã€‚    <br>
â€ƒ64ä½ELFæ–‡ä»¶æ ¼å¼</p>
<p>å‚è€ƒé“¾æ¥ï¼š
ELF æ ¼å¼è¯¦è§£ <a href="https://blog.csdn.net/shanandqiu/article/details/115206426">https://blog.csdn.net/shanandqiu/article/details/115206426</a>     <br>
ELFæ–‡ä»¶æ ¼å¼ç®€ä»‹  <a href="https://blog.csdn.net/GrayOnDream/article/details/124564129">https://blog.csdn.net/GrayOnDream/article/details/124564129</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ELFé¦–éƒ¨</span>
</span></span><span style="display:flex;"><span>readelf -h &lt;ELFæ–‡ä»¶&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ç¨‹åºé¦–éƒ¨è¡¨</span>
</span></span><span style="display:flex;"><span>readelf -l &lt;ELFæ–‡ä»¶&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹èŠ‚é¦–éƒ¨è¡¨</span>
</span></span><span style="display:flex;"><span>readelf -S &lt;ELFæ–‡ä»¶&gt;
</span></span></code></pre></div><p>â€ƒELFè§£æç¨‹åº  <br>
â€‚â€ƒ<code>linux-5.10.102/fs/binfmt_elf.c</code> è§£æ64ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ— å…³ <br>
â€‚â€ƒ<code>linux-5.10.102/fs/compat_binfmt_elf.c</code>  åœ¨64ä½å†…æ ¸ä¸­è§£æ32ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ—    \</p>
<p>â€ƒè£…è½½ELFç¨‹åºå‡½æ•°<code>load_elf_binary</code></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103112822.png" alt="20221103112822"  />
</p>
<p>â€‚â€ƒ1ï¼‰æ£€æŸ¥ELFé¦–éƒ¨ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ï¼Œæ£€æŸ¥å¤„ç†å™¨æ¶æ„
â€‚â€ƒ2ï¼‰è¯»å–ç¨‹åºé¦–éƒ¨è¡¨
â€‚â€ƒ3ï¼‰ç¨‹åºé¦–éƒ¨è¡¨ä¸­æŸ¥æ‰¾è§£é‡Šå™¨æ®µï¼Œå¦‚ç¨‹åºéœ€è¦é“¾æ¥åŠ¨æ€åº“ï¼Œå­˜åœ¨è§£é‡Šå™¨æ®µï¼Œä»è§£é‡Šå™¨æ®µè¯»å–è§£é‡Šå™¨çš„æ–‡ä»¶åç§°ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–ELFé¦–éƒ¨ã€‚
â€‚â€ƒ4ï¼‰æ£€æŸ¥è§£é‡Šå™¨çš„ELFé¦–éƒ¨ï¼Œè¯»å–è§£é‡Šå™¨çš„ç¨‹åºé¦–éƒ¨è¡¨
â€‚â€ƒ5ï¼‰flush_old_execå‡½æ•°ç»ˆæ­¢çº¿ç¨‹ç»„ä¸­å…¶ä»–çº¿ç¨‹ï¼Œé‡Šæ”¾æ—§çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´
â€‚â€ƒ6ï¼‰setup_new_execå‡½æ•°è°ƒç”¨arch_pick_mmap_layoutè®¾ç½®å†…å­˜æ˜ å°„çš„å¸ƒå±€ï¼Œåœ¨å †å’Œæ ˆç›´æ¥æœ‰ä¸€ä¸ªå†…å­˜æ˜ å°„åŒºåŸŸ
â€‚â€ƒ7ï¼‰ä¹‹å‰è°ƒç”¨bprm_mm_initå‡½æ•°åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ ˆï¼Œè°ƒç”¨set_arg_pageså‡½æ•°æŠŠç”¨æˆ·æ ˆå®šä¸‹æ¥ï¼Œæ›´æ–°ç”¨æˆ·æ ˆæ ‡å¿—ä½å’Œè®¿é—®æƒé™ï¼ŒæŠŠç”¨æˆ·æ ˆç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®ï¼Œå¹¶æ‰©å¤§ç”¨æˆ·æ ˆ
â€‚â€ƒ8ï¼‰æŠŠå¯åŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´
â€‚â€ƒ9ï¼‰setbrkå‡½æ•°æŠŠåˆå§‹åŒ–æ•°æ®æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶è®¾ç½®å †çš„èµ·å§‹è™šæ‹Ÿåœ°å€ï¼Œè°ƒç”¨padzeroå‡½æ•°ç”¨é›¶å¡«å……æœªåˆå§‹åŒ–æ•°æ®æ®µ
â€‚â€ƒ10ï¼‰å¾—åˆ°ç¨‹åºå…¥å£ã€‚ç¨‹åºæœ‰è§£é‡Šå™¨æ®µï¼ŒåŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç¨‹åºå…¥å£åˆ‡æ¢ä¸ºè§£é‡Šå™¨ç¨‹åºå…¥å£
â€‚â€ƒ11ï¼‰è°ƒç”¨create_elf_tablesä¾æ¬¡æŠŠä¼ é€’ELFè§£é‡Šå™¨ä¿¡æ¯çš„è¾…åŠ©å‘é‡ã€ç¯å¢ƒæŒ‡é’ˆæ•°ç»„envpã€å‚æ•°æŒ‡é’ˆæ•°ç»„argvå’Œå‚æ•°ä¸ªæ•°argcå‹åˆ°è¿›ç¨‹çš„ç”¨æˆ·æ ˆ
â€‚â€ƒ12ï¼‰è°ƒç”¨å‡½æ•°start_threadè®¾ç½®ç»“æ„ä½“pt_regsä¸­ç¨‹åºè®¡æ•°å™¨å’Œæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒARM64æ¶æ„å®šä¹‰çš„å‡½æ•°start_thread</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/include/asm/processor.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start_thread_common</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	memset(regs, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>regs));
</span></span><span style="display:flex;"><span>	forget_syscall(regs);
</span></span><span style="display:flex;"><span>	regs<span style="color:#f92672">-&gt;</span>pc <span style="color:#f92672">=</span> pc; <span style="color:#75715e">/* æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start_thread</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pc,
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> sp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	start_thread_common(regs, pc);
</span></span><span style="display:flex;"><span>	regs<span style="color:#f92672">-&gt;</span>pstate <span style="color:#f92672">=</span> PSR_MODE_EL0t;  <span style="color:#75715e">/* æŠŠå¤„ç†å™¨çŠ¶æ€è®¾ç½®ä¸º0ï¼Œå…¶ä¸­å¼‚å¸¸çº§åˆ«æ˜¯0 */</span>
</span></span><span style="display:flex;"><span>	spectre_v4_enable_task_mitigation(current);
</span></span><span style="display:flex;"><span>	regs<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> sp;   <span style="color:#75715e">/*è®¾ç½®ç”¨æˆ·æ ˆæŒ‡é’ˆ */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3è£…è½½è„šæœ¬ç¨‹åº">3.è£…è½½è„šæœ¬ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#3è£…è½½è„šæœ¬ç¨‹åº">#</a></h4>
<p>â€‚è„šæœ¬ç¨‹åºå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯<code>#!</code>ï¼Œåé¢æ˜¯è§£é‡Šå™¨ç¨‹åºçš„åç§°å’Œå‚æ•°ã€‚è§£é‡Šå™¨ç”¨æ¥æ‰§è¡Œè„šæœ¬ç¨‹åº
â€ƒ<code>linux-5.10.102/fs/binfmt_script.c</code>å‡½æ•°<code>load_script</code>è´Ÿè´£è£…è½½è„šæœ¬ç¨‹åº</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103141127.png" alt="20221103141127"  />
</p>
<p>â€‚â€ƒ1ï¼‰æ£€æŸ¥å‰ä¸¤ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯è„šæœ¬ç¨‹åºçš„æ ‡è¯†ç¬¦    <br>
â€‚â€ƒ2ï¼‰è§£æå¤„è§£é‡Šç¨‹åºçš„åç§°å’Œå‚æ•°      <br>
â€‚â€ƒ3ï¼‰ä»ç”¨æˆ·æ ˆåˆ é™¤ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¾æ¬¡æŠŠè„šæœ¬ç¨‹åºçš„æ–‡ä»¶åç§°ã€ä¼ ç»™è§£é‡Šç¨‹åºçš„å‚æ•°å’Œè§£é‡Šç¨‹åºçš„åç§°å‹åˆ°ç”¨æˆ·æ ˆ      <br>
â€‚â€ƒ4ï¼‰è°ƒç”¨opens_execæ‰“å¼€è§£é‡Šç¨‹åºæ–‡ä»¶       <br>
â€‚â€ƒ5ï¼‰è°ƒç”¨å‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»å–è§£é‡Šç¨‹åºæ–‡ä»¶çš„å‰128å­—èŠ‚åˆ°ç¼“å†²åŒº        <br>
â€‚â€ƒ6ï¼‰è°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«è§£é‡Šç¨‹åºä¸ºæ­¢     \</p>
<h2 id="26-è¿›ç¨‹é€€å‡º">2.6 è¿›ç¨‹é€€å‡º<a hidden class="anchor" aria-hidden="true" href="#26-è¿›ç¨‹é€€å‡º">#</a></h2>
<p>â€‚è¿›ç¨‹é€€å‡ºä¸¤ç§æƒ…å†µï¼šè¿›ç¨‹ä¸»åŠ¨é€€å‡ºå’Œç»ˆæ­¢è¿›ç¨‹    <br>
â€‚Linuxå†…æ ¸ä¸¤ä¸ªä¸»åŠ¨é€€å‡ºçš„ç³»ç»Ÿè°ƒç”¨       \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// çº¿ç¨‹é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exit</span>(<span style="color:#66d9ef">int</span> status);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸€ä¸ªçº¿ç¨‹ç»„æ‰€æœ‰çº¿ç¨‹é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exit_group</span>(<span style="color:#66d9ef">int</span> status);
</span></span></code></pre></div><p>â€ƒglibcåº“å‡½æ•°exitã€_exitå’Œ_Exitç”¨æ¥ä½¿è¿›ç¨‹é€€å‡ºï¼Œåº“å‡½æ•°è°ƒç”¨ç³»ç»Ÿè°ƒç”¨exit_groupã€‚åº“å‡½æ•°exitä¼šæ‰§è¡Œè¿›ç¨‹ä½¿ç”¨çš„atexitå’Œos_exitæ³¨å†Œçš„å‡½æ•°        <br>
â€‚â€ƒç»ˆæ­¢è¿›ç¨‹æ˜¯é€€å‡ºç»™è¿›ç¨‹å‘é€ä¿¡å·å®ç°çš„ï¼ŒLinuxè®·æ²³å‘é€ä¿¡å·çš„ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‘é€ä¿¡å·ç»™è¿›ç¨‹æˆ–è¿›ç¨‹ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">kill</span>(pid_t pid, <span style="color:#66d9ef">int</span> sig);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‘é€ä¿¡å·ç»™çº¿ç¨‹  å·²åºŸå¼ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tkill</span>(<span style="color:#66d9ef">int</span> tid, <span style="color:#66d9ef">int</span> sig);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‘é€ä¿¡å·ç»™çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tgkill</span>(<span style="color:#66d9ef">int</span> tgid, <span style="color:#66d9ef">int</span> tid, <span style="color:#66d9ef">int</span> sig);
</span></span></code></pre></div><p>â€ƒçˆ¶è¿›ç¨‹æ˜¯å¦å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹å‡ï¼Œ
â€‚â€ƒ1ï¼‰çˆ¶è¿›ç¨‹å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶é‡Šæ”¾å„ç§èµ„æºï¼Œç•™ç©ºè¿›ç¨‹æè¿°ç¬¦çš„åƒµå°¸è¿›ç¨‹ï¼Œå‘é€ä¿¡å·SIGCHLD(CHILDæ˜¯child)é€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æŸ¥è¯¢è¿›ç¨‹ç»ˆæ­¢åŸå› ä»å­è¿›ç¨‹æ”¶å›è¿›ç¨‹æè¿°ç¬¦ã€‚    <br>
â€‚â€ƒ2ï¼‰çˆ¶è¿›ç¨‹ä¸å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œè¿›ç¨‹é€€å‡ºæ˜¯é‡Šæ”¾å„ç§èµ„æºï¼Œé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦ \</p>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://liuz0123.gitee.io/zain/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://liuz0123.gitee.io/zain/img/alipay.jpg" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://liuz0123.gitee.io/zain/posts/na/%E9%81%93%E6%AD%89/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>è¯·æ±‚å¨œçš„åŸè°…</span>
  </a>
  <a class="next" href="https://liuz0123.gitee.io/zain/posts/blog/git/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>git</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://twikoo.js.org/quick-start.html#%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou', 
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://liuz0123.gitee.io/zain/" style="color:#939393;">zain&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·ç”³è¯·ä¸­</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="å¡«è‡ªå·±çš„å…¬å®‰å›¾æ ‡é“¾æ¥" style="float:left;margin: 0px 5px 0px 0px;"/>
             å…¬ç½‘å®‰å¤‡
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
