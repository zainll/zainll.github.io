<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Linuxå†…æ ¸æ·±åº¦è§£æ | zain&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº">
<meta name="author" content="
&nbsp;Zain">
<link rel="canonical" href="https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/">
<link crossorigin="anonymous" href="/zain/assets/css/stylesheet.6bbe4903eaf247f5c3db656a51fd7b09d982ab42029edfdc123f359e2748dc03.css" integrity="sha256-a75JA&#43;ryR/XD22VqUf17CdmCq0ICnt/cEj81nidI3AM=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/zain/assets/js/highlight.acb54fd32bbc1982428b8850317e45d076b95012730a5936667e6bc21777692a.js" integrity="sha256-rLVP0yu8GYJCi4hQMX5F0Ha5UBJzClk2Zn5rwhd3aSo="
        onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="16x16" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="icon" type="image/png" sizes="32x32" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="apple-touch-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<link rel="mask-icon" href="https://liuz0123.gitee.io/zain/img/Q.gif">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="Linuxå†…æ ¸æ·±åº¦è§£æ" />
<meta property="og:description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-05T00:17:58&#43;08:00" />
<meta property="article:modified_time" content="2022-10-05T00:17:58&#43;08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linuxå†…æ ¸æ·±åº¦è§£æ"/>
<meta name="twitter:description" content="å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "ğŸ“šæ–‡ç« ",
      "item": "https://liuz0123.gitee.io/zain/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Linuxå†…æ ¸æ·±åº¦è§£æ",
      "item": "https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Linuxå†…æ ¸æ·±åº¦è§£æ",
  "name": "Linuxå†…æ ¸æ·±åº¦è§£æ",
  "description": "å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒº",
  "keywords": [
    ""
  ],
  "articleBody": "å†…å®¹æçº² å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹ å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜ å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼ ä¿æŠ¤ä¸´ç•ŒåŒºçš„äº’æ–¥ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ– å¤„ç†å™¨ä¸Šç”µ-\u003eæ‰§è¡Œå¼•å¯¼ç¨‹åº-\u003eåŠ è½½å†…æ ¸åˆ°å†…å­˜-\u003eæ‰§è¡Œå†…æ ¸-\u003eå†…æ ¸åˆå§‹åŒ–-\u003eå¯åŠ¨ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ ARM64å¤„ç†å™¨åˆ°ç‰©ç†åœ°å€0å–ç¬¬ä¸€æ¡æŒ‡ä»¤\n1.1 å¼•å¯¼ç¨‹åº 1.1.1 å…¥å£_start ARM64å¤„ç†å™¨U-Bootç¨‹åºæ‰§è¡Œè¿‡ç¨‹ï¼Œå…¥å£u-boot/arch/arm/cpu/armv8/start.Sæ ‡è¯†_start\n.globl\t_start _start: #if defined(CONFIG_LINUX_KERNEL_IMAGE_HEADER) #include #elif defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK) #include #else b\treset #endif 1.1.2 reset reset: /* Allow the board to save important registers */ /* å…è®¸æ¿å¡ä¿å­˜é‡è¦çš„å¯„å­˜å™¨*/ b\tsave_boot_params .globl\tsave_boot_params_ret save_boot_params_ret: #ifdef CONFIG_SYS_RESET_SCTRL bl reset_sctrl // åˆå§‹åŒ–ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨ #endif /* * å¼‚å¸¸çº§åˆ«å¯èƒ½æ˜¯3ã€2æˆ–è€…1ï¼Œåˆå§‹çŠ¶æ€ï¼š * å°ç«¯å­—èŠ‚åºï¼Œç¦æ­¢MMUï¼Œç¦æ­¢æŒ‡ä»¤/æ•°æ®ç¼“å­˜ */ adr x0, vectors witch_el x1, 3f, 2f, 1f 3: msr vbar_el3, x0 // å¼‚å¸¸çº§åˆ«3ï¼Œå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL3è®¾ç½®ä½å¼‚å¸¸å‘é‡çš„èµ·å§‹åœ°å€ mrs x0, scr_el3 // è®¾ç½®å®‰å…¨é…ç½®å¯„å­˜å™¨SCR_EL3 orr x0, x0, #0xf /* è®¾ç½®å¯„å­˜å™¨SCR_EL3çš„NSã€IRQã€FIQå’ŒEAå››ä¸ªä½ */ msr scr_el3, x0 msr cptr_el3, xzr /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½*/ #ifdef COUNTER_FREQUENCY ldr x0, =COUNTER_FREQUENCY msr cntfrq_el0, x0 /* åˆå§‹åŒ–å¯„å­˜å™¨CNTFRQ */ #endif b 0f 2: msr vbar_el2, x0 // å¼‚å¸¸çº§åˆ«2 mov x0, #0x33ff msr cptr_el2, x0 /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */ b 0f 1: msr vbar_el1, x0 mov x0, #3 \u003c\u003c 20 msr cpacr_el1, x0 /* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */ 0: â€¦ /* åº”ç”¨ARMå¤„ç†å™¨ç‰¹å®šçš„å‹˜è¯¯è¡¨*/ bl apply_core_errata /* å¤„ç†å™¨ç‰¹å®šçš„åˆå§‹åŒ–*/ bl lowlevel_init // æ‰§è¡Œboard_init_f()æ‰€éœ€æœ€å°åˆå§‹åŒ– #if defined(CONFIG_ARMV8_SPIN_TABLE) \u0026\u0026 !defined(CONFIG_SPL_BUILD) branch_if_master x0, x1, master_cpu b spin_table_secondary_jump // arch/arm/cpu/armv8/spin_tabli.c /* ç»å¯¹ä¸ä¼šè¿”å›*/ #elif defined(CONFIG_ARMV8_MULTIENTRY) branch_if_master x0, x1, master_cpu /* * ä»å¤„ç†å™¨ */ slave_cpu: wfe // ä»å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œå®ƒè¢«å”¤é†’çš„æ—¶å€™ï¼Œä»åœ°å€CPU_RELEASE_ADDRè¯»å–å‡½æ•° ldr x1, =CPU_RELEASE_ADDR ldr x0, [x1] cbz x0, slave_cpu br x0 /* è·³è½¬åˆ°æŒ‡å®šåœ°å€*/ #endif /* CONFIG_ARMV8_MULTIENTRY */ master_cpu: bl _main // ä¸»å¤„ç†å™¨æ‰§è¡Œå‡½æ•° U-Bootåˆ†ä¸ºSPLå’Œæ­£å¸¸çš„U-Bootç¨‹åºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦ç¼–è¯‘ä¸ºSPLï¼Œéœ€è¦å¼€å¯é…ç½®å®CONFIG_SPL_BUILDã€‚SPLæ˜¯â€œSecondary Program Loaderâ€çš„ç®€ç§°ï¼Œå³ç¬¬äºŒé˜¶æ®µç¨‹åºåŠ è½½å™¨ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯ç›¸å¯¹äºå¤„ç†å™¨é‡Œé¢çš„åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åºæ¥è¯´çš„ï¼Œå¤„ç†å™¨å¯åŠ¨æ—¶æœ€å…ˆæ‰§è¡Œçš„æ˜¯åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åº\n1.1.3 å‡½æ•°_main // arch/arm/lib/crt0_64.S ENTRY(_main) // è®¾ç½®åˆå§‹çš„Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”è°ƒç”¨board_init_f(0)ã€‚ #if defined(CONFIG_SPL_BUILD) \u0026\u0026 defined(CONFIG_SPL_STACK ldr x0, =(CONFIG_SPL_STACK) #else ldr x0, =(CONFIG_SYS_INIT_SP_ADDR) #endif bic sp, x0, #0xf /* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚*/ mov x0, sp bl board_init_f_alloc_reserve // åœ¨æ ˆçš„é¡¶éƒ¨ä¸ºç»“æ„ä½“global_dataåˆ†é…ç©ºé—´ mov sp, x0 mov x18, x0 /* è®¾ç½®gd */ // å‡½æ•°board_init_f_init_reserveï¼Œåˆå§‹åŒ–ç»“æ„ä½“global_data bl board_init_f_init_reserve mov x0, #0 bl board_init_f // common/board_f.c æ‰§è¡Œæ•°ç»„init_sequence_fä¸­çš„æ¯ä¸ªå‡½æ•° #if !defined(CONFIG_SPL_BUILD) // è®¾ç½®ä¸­é—´ç¯å¢ƒï¼ˆæ–°çš„æ ˆæŒ‡é’ˆå’Œgdï¼‰ï¼Œç„¶åè°ƒç”¨å‡½æ•° // relocate_code(addr_moni) ldr x0, [x18, #GD_START_ADDR_SP] /* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-\u003estart_addr_sp */ bic sp, x0, #0xf /* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚ */ ldr x18, [x18, #GD_BD] /* æŠŠå¯„å­˜å™¨x18è®¾ç½®ä¸ºgd-\u003ebd */ sub x18, x18, #GD_SIZE /* æ–°çš„gdåœ¨bdçš„ä¸‹é¢ */ adr lr, relocation_return ldr x9, [x18, #GD_RELOC_OFF] /* æŠŠå¯„å­˜å™¨x9è®¾ç½®ä¸ºgd-\u003ereloc_off */ add lr, lr, x9 /* åœ¨é‡å®šä½åæ–°çš„è¿”å›åœ°å€ */ ldr x0, [x18, #GD_RELOCADDR] /* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-\u003erelocaddr */ b relocate_code relocation_return: // è®¾ç½®æœ€ç»ˆçš„å®Œæ•´ç¯å¢ƒ /* ä»ç„¶è°ƒç”¨æ—§çš„ä¾‹ç¨‹ æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€*/ bl c_runtime_cpu_setup #endif /* !CONFIG_SPL_BUILD */ #if defined(CONFIG_SPL_BUILD) bl spl_relocate_stack_gd /* å¯èƒ½è¿”å›ç©ºæŒ‡é’ˆ é‡æ–°å®šä½æ ˆ*/ // æ‰§è¡Œâ€œsp = (x0 != NULL) ? x0 : spâ€ï¼Œ // è§„é¿è¿™ä¸ªçº¦æŸï¼š // å¸¦æ¡ä»¶çš„movæŒ‡ä»¤ä¸èƒ½æŠŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•° mov x1, sp cmp x0, #0 csel x0, x0, x1, ne mov sp, x0 #endif // ç”¨0åˆå§‹åŒ–æœªåˆå§‹åŒ–æ•°æ®æ®µ ldr x0, =__bss_start /* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/ ldr x1, =__bss_end /* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/ clear_loop: str xzr, [x0], #8 cmp x0, x1 b.lo clear_loop /* è°ƒç”¨å‡½æ•°board_init_r(gd_t *id, ulong dest_addr) */ mov x0, x18 /* gd_t */ ldr x1, [x18, #GD_RELOCADDR] /* dest_addr */ /* ç›¸å¯¹ç¨‹åºè®¡æ•°å™¨çš„è·³è½¬ common/board_r.c æ‰§è¡Œæ•°ç»„init_sequence_rä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œæœ€åä¸€ä¸ªå‡½æ•°æ˜¯run_main_loop */ b board_init_r /* ä¸ä¼šè¿è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºå‡½æ•°board_init_r()ä¸ä¼šè¿”å›*/ ENDPROC(_main) 1.1.4 å‡½æ•°run_main_loop æ•°ç»„init_sequence_ræœ€åä¸€ä¸ªå‡½æ•°run_main_loopï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹ï¼›\nrun_main_loop main_loop bootdely_process # è¯»å–ç¯å¢ƒå˜é‡bootdelay(å»¶è¿Ÿæ—¶é—´)å’Œbootcmd(ç¯å¢ƒå˜é‡) autoboot_command abortboot # ç­‰å¾…ç”¨æˆ·æŒ‰é”® run_command_list # æœªç­‰å¾…åˆ°æŒ‰é”®ï¼Œè‡ªåŠ¨æ‰§è¡Œç¯å¢ƒå˜é‡bootcmd bootmå‘½ä»¤å¤„ç†å‡½æ•°do_bootm\ndo_bootm do_bootm_states bootm_start # åˆå§‹åŒ–å…¨å±€å˜é‡bootm_header_timages bootm_find_os # æŠŠå†…æ ¸é•œåƒä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜ bootm_find_other # ARM64 æ‰å¹³è®¾å¤‡æ ‘(Flattended Device Tree FDT)äºŒè¿›åˆ¶æ–‡ä»¶ bootm_load_os # è§£å‹ç—…åŠ è½½å†…æ ¸åˆ°æ­£ç¡®ä½ç½® bootm_os_get_boot_func # åœ¨æ“ä½œç³»ç»Ÿç±»å‹æ•°ç»„boot_osä¸­æŸ¥æ‰¾å¼•å¯¼å‡½æ•°ï¼Œlinuxå†…æ ¸å¼•å¯¼å‡½æ•°do_bootm_linux do_bootm_linux(flag=BOOTM_STATE_OS_PREP) # è°ƒç”¨boot_prep_linux boot_prep_linux # 1.åˆ†é…ä¸€å—å†…å­˜ï¼ŒæŠŠè®¾å¤‡æ•°äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ 2.ä¿®æ”¹æ‰å¹³è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ boot_selected_os # do_bootm_linux(flag=BOOTM_STATE_OS_GO) boot_jump_linux # è´Ÿè´£è·³è½¬åˆ°Linuxå†…æ ¸ boot_jum_linux do_nonsec_virt_switch smp_kick_all_cpus # CONFIG_GICV2æˆ–CONFIG_GICV3ï¼Œä¸­æ–­æ§åˆ¶å™¨ç‰ˆæœ¬2ï¼Œ3 dcache_disable # ç¦ç”¨å¤„ç†å™¨çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†å•å…ƒ # åœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ # å¼€å¯é…ç½®å® CONFIG_ARMV8_SWITCH_TO_EL1 armv8_switch_to_el2 switch_to_el1 armv8_switch_to_el1 å†…æ ¸å…¥å£ # åœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ armv8_switch_to_el2 å†…æ ¸å…¥å£ 1.2 å†…æ ¸åˆå§‹åŒ– å†…æ ¸åˆå§‹åŒ–åˆ†ä¸ºæ±‡ç¼–è¯­è¨€éƒ¨åˆ†å’ŒCè¯­è¨€éƒ¨åˆ†\n1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ† ARM64æ¶æ„å†…æ ¸å…¥å£_headï¼Œç›´æ¥è·³è½¬åˆ°æ ‡å·stext\n// linux-4.14.295/arch/arm64/kernel/head.S _head: #ifdef CONFIG_EFI // æä¾›UEFIè¿è¡Œæ—¶æ”¯æŒUEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æ˜¯ç»Ÿä¸€çš„å¯æ‰©å±•å›ºä»¶æ¥å£ï¼Œç”¨äºå–ä»£BIOS add x13, x18, #0x16 b stext #else b stext // è·³è½¬åˆ°å†…æ ¸èµ·å§‹ä½ç½® .long0 // ä¿ç•™ #endif stext\n// linux-4.14.295/arch/arm64/kernel/head.S ENTRY(stext) bl preserve_boot_args // æŠŠå¼•å¯¼ç¨‹åºä¼ é€’çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_argsä¸­ bl el2_setup // é™çº§åˆ°å¼‚å¸¸çº§åˆ«1, å¯„å­˜å™¨w0å­˜æ”¾cpu_boot_mode adrp x23, __PHYS_OFFSET and x23, x23, MIN_KIMG_ALIGN - 1 // KASLRåç§»ï¼Œé»˜è®¤å€¼æ˜¯0 bl set_cpu_boot_mode_flag // __boot_cpu_mode[2] æ•°ç»„ bl __create_page_tables // åˆ›å»ºé¡µè¡¨æ˜ å°„ /* ä¸‹é¢è°ƒç”¨è®¾ç½®å¤„ç†å™¨çš„ä»£ç ï¼Œè¯·çœ‹æ–‡ä»¶â€œarch/arm64/mm/proc.Sâ€ äº†è§£ç»†èŠ‚ã€‚ * è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å·²ç»ä¸ºå¼€å¯å†…å­˜ç®¡ç†å•å…ƒåšå¥½å‡†å¤‡ï¼Œ * è½¬æ¢æ§åˆ¶å¯„å­˜å™¨å·²ç»è®¾ç½®å¥½ã€‚*/ bl __cpu_setup // åˆå§‹åŒ–å¤„ç†å™¨ b __primary_switch // ä¸»å¤„ç†å™¨å¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿›å…¥Cè¯­è¨€éƒ¨åˆ†å…¥å£å‡½æ•°start_kernel ENDPROC(stext) å‡½æ•°el2_setup a.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯1ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ã€‚ b.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯2ï¼Œé‚£ä¹ˆæ ¹æ®å¤„ç†å™¨æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼ˆVirtualization Host Extensionsï¼ŒVHEï¼‰ï¼Œå†³å®šæ˜¯å¦éœ€è¦é™çº§åˆ°å¼‚å¸¸çº§åˆ«1ã€‚ 1ï¼‰å¦‚æœå¤„ç†å™¨æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ã€‚ \\\n2ï¼‰å¦‚æœå¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆé™çº§åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ \\\nåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼ŒKVMï¼‰ï¼ŒKVMçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œå› æ­¤è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚ å¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒKVMè™šæ‹Ÿæœºã€‚QEMUåˆ›å»ºä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå’ŒKVMçš„äº¤äº’è¿‡ç¨‹ \\\n// æ‰“å¼€KVMå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚ fd = open(\"/dev/kvm\", O_RDWR); // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚ vmfd = ioctl(fd, KVM_CREATE_VM, 0); // KVMä¸ºæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªkvm_vcpuç»“æ„ä½“ï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿå¤„ç†å™¨çš„æ–‡ä»¶æè¿°ç¬¦ vcpu_fd = ioctl(vmfd, KVM_CREATE_VCPU, 0); ä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰QEMUè¿›ç¨‹è°ƒç”¨â€œioctl(vcpu_fd, KVM_RUN, 0)â€ï¼Œé™·å…¥åˆ°å†…æ ¸ã€‚ ï¼ˆ2ï¼‰KVMæ‰§è¡Œå‘½ä»¤KVM_RUNï¼Œä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚ ï¼ˆ3ï¼‰KVMé¦–å…ˆæŠŠè°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨ä¿å­˜åœ¨kvm_vcpuç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠæ‰€æœ‰å¯„å­˜å™¨è®¾ç½®ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿçš„å¯„å­˜å™¨å€¼ï¼Œæœ€åä»å¼‚å¸¸çº§åˆ«2è¿”å›åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚ ä¸ºäº†æé«˜åˆ‡æ¢é€Ÿåº¦ï¼ŒARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦å…ˆä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2 \\\nå‡½æ•°__create_page_tables 1ï¼‰åˆ›å»ºæ’ç­‰æ˜ å°„ï¼Œè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ 2ï¼‰ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ \\\næ˜ å°„ä»£ç èŠ‚.idmap.text,æ’ç­‰æ˜ å°„ä»£ç èŠ‚çš„èµ·å§‹åœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_startä¸­ï¼Œç»“æŸåœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_endä¸­ã€‚æ’ç­‰æ˜ å°„æ˜¯ä¸ºæ’ç­‰æ˜ å°„ä»£ç èŠ‚åˆ›å»ºçš„æ˜ å°„ï¼Œidmap_pg_diræ˜¯æ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•ï¼ˆå³ç¬¬ä¸€çº§é¡µè¡¨ï¼‰çš„èµ·å§‹åœ°å€ã€‚å†…æ ¸çš„é¡µè¡¨ä¸­ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ï¼Œå†…æ ¸é•œåƒçš„èµ·å§‹åœ°å€æ˜¯_textï¼Œç»“æŸåœ°å€æ˜¯_endï¼Œswapper_pg_diræ˜¯å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹åœ°å€\nå‡½æ•°__primary_switch 1ï¼‰__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ 2ï¼‰__primary_switched __enable_mmuæ‰§è¡Œæµç¨‹ 1ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨0(TTBR0_EL1)è®¾ç½®ä¸ºæ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€ 2ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨1(TTBR1_EL1)è®¾ç½®ä¸ºå†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€ 3ï¼‰è®¾ç½®ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR_EL1)ï¼Œå¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼ŒåMMUæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ __primary_switchæ‰§è¡Œæµç¨‹ 1ï¼‰æŠŠå½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨è®¾ç½®ä¸º0å·çº¿ç¨‹å†…æ ¸æ ˆçš„é¡¶éƒ¨(init_thread_union + THREAD_SIZE) 2ï¼‰æŠŠå¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨(SP_EL0)è®¾ç½®ä¸º0å·çº¿ç¨‹çš„ç»“æ„ä½“thread_infoçš„åœ°å€(init_task.thread_info) 3ï¼‰æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(VBAR_EL1)è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€(vectors) 4ï¼‰è®¡ç®—å†…æ ¸é•œåƒçš„èµ·å§‹è™šæ‹Ÿåœ°å€(kimage_vaddr)å’Œç‰©ç†åœ°å€çš„å·®å€¼ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡kimage_voffsetä¸­ 5ï¼‰ç”¨0åˆå§‹åŒ–å†…æ ¸çš„æœªåˆå§‹åŒ–æ•°æ®æ®µ 6ï¼‰è°ƒç”¨Cè¯­è¨€å‡½æ•°start_kernel \\\n1.2.2 Cè¯­è¨€éƒ¨åˆ† å†…æ ¸åˆå§‹åŒ–çš„Cè¯­è¨€éƒ¨åˆ†å…¥å£æ˜¯å‡½æ•°start_kernelï¼Œå‡½æ•°start_kernelé¦–å…ˆåˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼Œå³åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼Œç„¶åè°ƒç”¨å‡½æ•°rest_initã€‚å‡½æ•°rest_initçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰åˆ›å»º1å·çº¿ç¨‹ï¼Œå³initçº¿ç¨‹ï¼Œçº¿ç¨‹å‡½æ•°æ˜¯kernel_initã€‚ ï¼ˆ2ï¼‰åˆ›å»º2å·çº¿ç¨‹ï¼Œå³kthreaddçº¿ç¨‹ï¼Œè´Ÿè´£åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚ ï¼ˆ3ï¼‰0å·çº¿ç¨‹æœ€ç»ˆå˜æˆç©ºé—²çº¿ç¨‹ã€‚ \\\ninitçº¿ç¨‹ç»§ç»­åˆå§‹åŒ–ï¼Œæ‰§è¡Œçš„ä¸»è¦æ“ä½œå¦‚ä¸‹ã€‚ ï¼ˆ1ï¼‰smp_prepare_cpus()ï¼šåœ¨å¯åŠ¨ä»å¤„ç†å™¨ä»¥å‰æ‰§è¡Œå‡†å¤‡å·¥ä½œã€‚ ï¼ˆ2ï¼‰do_pre_smp_initcalls()ï¼šæ‰§è¡Œå¿…é¡»åœ¨åˆå§‹åŒ–SMPç³»ç»Ÿä»¥å‰æ‰§è¡Œçš„æ—©æœŸåˆå§‹åŒ–ï¼Œå³ä½¿ç”¨å®early_initcallæ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ã€‚ ï¼ˆ3ï¼‰smp_init()ï¼šåˆå§‹åŒ–SMPç³»ç»Ÿï¼Œå¯åŠ¨æ‰€æœ‰ä»å¤„ç†å™¨ã€‚ ï¼ˆ4ï¼‰do_initcalls()ï¼šæ‰§è¡Œçº§åˆ«0ï½7çš„åˆå§‹åŒ–ã€‚ ï¼ˆ5ï¼‰æ‰“å¼€æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶â€œ/dev/consoleâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2åˆ†åˆ«æ˜¯æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œéƒ½æ˜¯æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚ ï¼ˆ6ï¼‰prepare_namespace()ï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è£…è½½initç¨‹åºæ—¶éœ€è¦ä»å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¯»æ–‡ä»¶ã€‚ ï¼ˆ7ï¼‰free_initmem()ï¼šé‡Šæ”¾åˆå§‹åŒ–ä»£ç å’Œæ•°æ®å ç”¨çš„å†…å­˜ã€‚ ï¼ˆ8ï¼‰è£…è½½initç¨‹åºï¼ˆU-Bootç¨‹åºå¯ä»¥ä¼ é€’å†…æ ¸å‚æ•°â€œinit=â€ä»¥æŒ‡å®šinitç¨‹åºï¼‰ï¼Œä»å†…æ ¸çº¿ç¨‹è½¬æ¢æˆç”¨æˆ·ç©ºé—´çš„initè¿›ç¨‹ã€‚ \\\nçº§åˆ«0ï½7çš„åˆå§‹åŒ–ï¼Œæ˜¯æŒ‡ä½¿ç”¨ä»¥ä¸‹å®æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼š\n// include/linux/init.h #define pure_initcall(fn) __define_initcall(fn, 0) #define core_initcall(fn) __define_initcall(fn, 1) #define core_initcall_sync(fn) __define_initcall(fn, 1s) #define postcore_initcall(fn) __define_initcall(fn, 2) #define postcore_initcall_sync(fn) __define_initcall(fn, 2s) #define arch_initcall(fn) __define_initcall(fn, 3) #define arch_initcall_sync(fn) __define_initcall(fn, 3s) #define subsys_initcall(fn) __define_initcall(fn, 4) #define subsys_initcall_sync(fn) __define_initcall(fn, 4s) #define fs_initcall(fn) __define_initcall(fn, 5) #define fs_initcall_sync(fn) __define_initcall(fn, 5s) #define rootfs_initcall(fn) __define_initcall(fn, rootfs) #define device_initcall(fn) __define_initcall(fn, 6) #define device_initcall_sync(fn) __define_initcall(fn, 6s) #define late_initcall(fn) __define_initcall(fn, 7) #define late_initcall_sync(fn) __define_initcall(fn, 7s) 1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼ å¯¹ç§°å¤šå¤„ç†å™¨(Symmetirc Multi-Processor SMP) 3ç§å¼•å¯¼ä»å¤„ç†å™¨æ–¹æ³• \\\nè‡ªæ—‹è¡¨ ç”µæºçŠ¶æ€åè°ƒæ¥å£ ACPIåœè½¦åè®® 1.3 initè¿›ç¨‹ initè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç”¨æˆ·ç¨‹åºã€‚Linuxç³»ç»Ÿinitç¨‹åºæœ‰sysvinitã€busybox initã€upstartã€systemdå’Œprocdã€‚sysvinitæ˜¯Unixç³»ç»Ÿ5(System V)initç¨‹åºï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶/etc/initab\nç¬¬2ç«  è¿›ç¨‹ç®¡ç† 2.1 è¿›ç¨‹ Linuxå†…æ ¸æŠŠè¿›ç¨‹ç§°ä¸ºtaskï¼Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ è¿›ç¨‹æœ‰ä¸¤ç§ç‰¹æ®Šå½¢å¼ï¼šæ²¡æœ‰ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œå…±äº«ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚ task_structç»“æ„ä½“æ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸»è¦æˆå‘˜\nvolatile long state; // è¿›ç¨‹çŠ¶æ€ void *stack; // æŒ‡å‘å†…æ ¸æ ˆ pid_t pid; // å…¨å±€è¿›ç¨‹å· pid_t tgid // å…¨å±€çš„çº¿ç¨‹ç»„æ ‡è¯†ç¬¦ struct pid_link pid[PIDTYPE_MAX]; // è¿›ç¨‹å·ï¼Œè¿›ç¨‹ç»„æ ‡è¯†ç¬¦å’Œä¼šè¯æ ‡è¯†ç¬¦ struct task_struct _rcu *real_parent; // real_parentæŒ‡å‘çœŸå®çš„çˆ¶è¿›ç¨‹ struct task_struct _rcu *parent; // parentæŒ‡å‘çˆ¶è¿›ç¨‹ struct task_struct *group_leader; // æŒ‡å‘è¿›æ‘ç»„çš„ç»„é•¿ const struct cred _rcu *real_cred; // real_credæŒ‡å‘ä¸»é¢˜å’ŒçœŸå®å®¢ä½“è¯ä¹¦ const struct cred _rcu *cred; // credæŒ‡å‘å®¢ä½“è¯ä¹¦ char comm[TASK_COMM_LEN]; // è¿›ç¨‹å int prio, static_prio, nornal_prio; // è°ƒåº¦ç­–ç•¥ unsigned int rt_priority,prolicyï¼› // ä¼˜å…ˆçº§ cpumask_t cpus_allowed; // å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ struct mm_struct *mm, *active_mm; // æŒ‡å‘å†…å­˜æè¿°ç¬¦ï¼Œè¿›ç¨‹mmï¼Œå’Œactive_mmæŒ‡å‘åŒä¸€ä¸ªå†…å­˜æè¿°ç¬¦ï¼Œå†…æ ¸çº¿ç¨‹mmæ˜¯æŒ‡é’ˆï¼Œå½“å†…æ ¸çº¿ç¨‹è¿è¡Œæ—¶active_mmæŒ‡å‘ä»è¿›ç¨‹å€Ÿç”¨çš„å†…å­˜æè¿°ç¬¦ struct file_struct *files; // æ‰“å¼€æ–‡ä»¶è¡¨ struct nsproxy *nsproxy; // å‘½åç©ºé—´ struct signal_struct *signal; // ä¿¡å·å¤„ç† struct sigband_struct *sighand; sigset_t blocked, real_blocked; sigset_t saved_sigmask; struct sigpending pending; struct sysv_sem sysvsem; // UNIxç³»ç»Ÿ5ä¿¡å·é‡å’Œå…±äº«å†…å­˜ struct sysv_shm sysvshm; 2.2 å‘½åç©ºé—´ å’Œè™šæ‹Ÿæœºç›¸æ¯”ï¼Œå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„å†…æ ¸ï¼Œä½¿ç”¨å‘½åç©ºé—´éš”ç¦»èµ„æº,å®¹å™¨ä»…ä»…æ˜¯é€šè¿‡å‘½åç©ºé—´éš”ç¦»ï¼Ÿ \\\nå‘½åç©ºé—´ éš”ç¦»èµ„æº æ§åˆ¶ç»„cgroup æ§åˆ¶ç»„æ ¹ç›®å½• è¿›ç¨‹é—´é€šä¿¡IPC UNIXç³»ç»Ÿ5è¿›ç¨‹é—´é€šä¿¡å’ŒPOSIxæ¶ˆæ¯é˜Ÿåˆ— network ç½‘ç»œåè®® æŒ‚è½½mount æŒ‚è½½ç‚¹ PID è¿›ç¨‹å· user ç”¨æˆ·æ ‡è¯†ç¬¦å’Œç»„æ ‡è¯†ç¬¦ UNIXåˆ†æ—¶ç³»ç»Ÿ(UTS) ä¸»æœºåå’Œç½‘ç»œä¿¡æ¯æœåŠ¡NISåŸŸå åˆ›å»ºæ–°çš„å‘½åç©ºé—´æ–¹æ³•ï¼š è°ƒç”¨cloneåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œä½¿ç”¨æ ‡å¿—ä½æ§åˆ¶å­è¿›ç¨‹æ˜¯å…±äº«çˆ¶è¿›ç¨‹çš„å‘½åç©ºé—´è¿˜æ˜¯åˆ›å»ºæ–°å‘½åç©ºé—´ è°ƒç”¨unshareåˆ›å»ºæ–°çš„å‘½åç©ºé—´ è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setnsï¼Œç»‘å®šä¸€ä¸ªå·²ç»å­˜åœ¨çš„å‘½åç©ºé—´\nè¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespace,è¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespaceã€‚\n2.3 è¿›ç¨‹æ ‡è¯†ç¬¦ æ ‡è¯†ç¬¦ è¿›ç¨‹æ ‡è¯†ç¬¦ å‘½åç©ºé—´ç»™è¿›ç¨‹åˆ†é…æ ‡è¯†ç¬¦ çº¿ç¨‹ç»„æ ‡è¯†ç¬¦ çº¿ç¨‹ç»„ä¸­çš„ä¸»è¿›ç¨‹ç§°ä¸ºç»„é•¿ï¼Œçº¿ç¨‹ç»„æ ‡è¯†ç¬¦å°±æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦\nç³»ç»Ÿè°ƒç”¨cloneä¼ å…¥æ ‡å¿—CLONE_THREADä»¥åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºä¸€ä¸ªçº¿ç¨‹ç»„ è¿›ç¨‹ç»„æ ‡è¯†ç¬¦ è¿›ç¨‹ç»„æ ‡è¯†ç¬¦æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦ã€‚\nè¿›ç¨‹å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setpgidåˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªè¿›ç¨‹ç»„ ä¼šè¯æ ‡è¯†ç¬¦ è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨setsidçš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯ pidå­˜å‚¨å…¨å±€è¿›ç¨‹å·ï¼Œpids[PIDTYPE_PID].pidæŒ‡å‘ç»“æ„ä½“pidï¼Œpids[PIDTYPE_PGID].pidæŒ‡å‘è¿›ç¨‹ç»„ç»„é•¿çš„ç»“æ„ä½“pidï¼Œpids[PIDTYPE_SIG].pidæŒ‡å‘ä¼šè¯è¿›ç¨‹çš„ç»“æ„ä½“pid \\\nè¿›ç¨‹æ ‡è¯†ç¬¦ç»“æ„ä½“pidçš„æˆå‘˜ï¼Œcountæ˜¯å¼•ç”¨è®¡æ•°ï¼Œlevelè¿›ç¨‹å·å‘½åç©ºé—´çš„å±‚æ¬¡ï¼Œnumberså…ƒç´ ä¸ªæ•°æ˜¯levelçš„å€¼åŠ 1ï¼Œ\n2.4 è¿›ç¨‹å…³ç³» å¦‚æœå­è¿›ç¨‹è¢«æŸä¸ªè¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯è°ƒè¯•å™¨ï¼‰ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ptraceè·Ÿè¸ªï¼Œé‚£ä¹ˆæˆå‘˜parentæŒ‡å‘è·Ÿè¸ªè€…çš„è¿›ç¨‹æè¿°ç¬¦ï¼Œå¦åˆ™æˆå‘˜parentä¹ŸæŒ‡å‘çˆ¶è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ã€‚\n2.5 å¯åŠ¨ç¨‹åº ret = fork(); if (ret \u003e 0) { /* çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œ */ } else if (ret == 0) { /* å­è¿›ç¨‹è£…è½½ç¨‹åº */ ret = execve(filename, argv, envp); } else { /* åˆ›å»ºå­è¿›ç¨‹å¤±è´¥ */ } 2.5.1ã€€åˆ›å»ºæ–°è¿›ç¨‹ å†…æ ¸ä½¿ç”¨é™æ€æ•°æ®æ„é€ å‡º0å·å†…æ ¸çº¿ç¨‹ï¼Œ0å·å†…æ ¸çº¿ç¨‹åˆ†å‰ç”Ÿæˆ1å·å†…æ ¸çº¿ç¨‹å’Œ2å·å†…æ ¸çº¿ç¨‹ï¼ˆkthreaddçº¿ç¨‹ï¼‰ã€‚1å·å†…æ ¸çº¿ç¨‹å®Œæˆåˆå§‹åŒ–ä»¥åè£…è½½ç”¨æˆ·ç¨‹åºï¼Œå˜æˆ1å·è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯1å·è¿›ç¨‹æˆ–è€…å®ƒçš„å­å­™è¿›ç¨‹åˆ†å‰ç”Ÿæˆçš„ï¼›å…¶ä»–å†…æ ¸çº¿ç¨‹æ˜¯kthreaddçº¿ç¨‹åˆ†å‰ç”Ÿæˆçš„ ä¸¤ä¸ªä¸ªç³»ç»Ÿè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼š \\\nforkï¼šå­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œç”¨å†™æ—¶å¤åˆ¶ cloneï¼šå¯æ§åˆ¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«å“ªäº›èµ„æº vforkï¼šåˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ç”¨execveè£…è½½ç¨‹åº(å·²åºŸå¼ƒ) // æ•°å­—è¡¨ç¤ºå‚æ•°ä¸ªæ•° SYSCALL_DEFINE0(fork) // å®å±•å¼€ asmlinkageè¡¨ç¤ºCè¯­è¨€å‡½æ•°çœ‹è¢«æ±‡ç¼–ä»£ç è°ƒç”¨ asmlinkage long sys_fork(void) åˆ›å»ºè¿›ç¨‹çš„è¿›ç¨‹på’Œè¢«åˆ›å»ºè¿›ç¨‹cä¸‰ç§å…³ç³»\næ–°è¿›ç¨‹æ˜¯è¿›ç¨‹pçš„å­è¿›ç¨‹ cloneä¼ å…¥CLONE_PARENTï¼Œå…„å¼Ÿå…³ç³» cloneä¼ å…¥CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ 1. _do_forkå‡½æ•° // kernel/fork.c long _do_fork(unsigned long clone_flags, unsigned long stack_start, unsigned long stack_size, int __user *parent_tidptr, int __user *child_tidptr, unsigned long tls); // tls åˆ›å»ºçº¿ç¨‹ï¼Œclone_flagsä¸ºCLONE_SETTLSæ—¶ï¼ŒtlstlsæŒ‡å®šæ–°çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ è°ƒç”¨copy_processåˆ›å»ºæ–°è¿›ç¨‹ clone_flagsè®¾ç½®CLONE_PARENT_SETTIDï¼Œæ–°çº¿ç¨‹çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°å‚æ•°parent_tidptræŒ‡å®šçš„ä½ç½® wake_up_new_taskå”¤é†’æ–°è¿›ç¨‹\n2. copy_processå‡½æ•° ï¼ˆ1ï¼‰æ ‡å¿—ç»„åˆ CLONE_NEWNS \u0026 CLONE_FS æ–°è¿›ç¨‹å±äºæ–°æŒ‚è½½å‘½åç©ºé—´\nå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ CLONE_NEWUSER \u0026 CLONE_FS æ–°è¿›ç¨‹å±äºæ–°ç”¨æˆ·å‘½åç©ºé—´\nå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ CLONE_THREAD æœªè®¾ç½®CLONE_SIGHAND æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œ\nä½†ä¸å…±äº«ä¿¡å·å¤„ç†ç¨‹åº CLONE_SIGHAND æœªè®¾ç½®CLONE_VM æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·å¤„ç†ç¨‹åºï¼Œ\nä½†ä¸å…±äº«è™šæ‹Ÿå†…å­˜ ï¼ˆ2ï¼‰dup_task_structå‡½æ•° æœªæ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦åˆ†é…å†…å­˜ï¼Œå¤åˆ¶å½“å‰è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸ºæ–°è¿›ç¨‹åˆ†é…å†…æ ¸æ ˆ // include/linux/sched.h union thread_union { #ifndef CONFIG_ARCH_TASK_STRUCT_ON_STACK struct task_struct task; #endif #ifndef CONFIG_THREAD_INFO_IN_TASK struct thread_info thread_info; #endif unsigned long stack[THREAD_SIZE/sizeof(long)]; }; å†…æ ¸æ ˆä¸¤ç§å¸ƒå±€\nthread_infoåœ¨å†…æ ¸æ ˆé¡¶éƒ¨ï¼Œæˆå‘˜taskæŒ‡å‘è¿›ç¨‹æè¿°ç¬¦ thread_infoæœªå ç”¨å†…æ ¸æ ˆ ç¬¬äºŒç§å¸ƒå±€éœ€æ‰“å¼€CONFIG_THREAD_INFO_IN_TASKï¼ŒARM64ä½¿ç”¨ç¬¬äºŒç§å†…æ ¸æ ˆå¸ƒå±€ï¼Œthread_infoç»“æ„ä½“åœ°å€ä¸è¿›ç¨‹æè¿°ç¬¦åœ°å€ç›¸åŒã€‚è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼æ—¶ï¼ŒARM64æ¶æ„çš„å†…æ ¸ä½¿ç”¨ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0å­˜æ”¾å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“åœ°å€ï¼Œå¯åŒæ—¶å¾—åˆ°thread_infoåœ°å€å’Œè¿›ç¨‹æè¿°ç¬¦åœ°å€ å†…æ ¸æ ˆçš„é•¿åº¦æ—¶THREAD_SIZEï¼ŒARM64æ¶æ„å†…æ ¸æ ˆé•¿åº¦ä¸º16KB thread_infoå­˜æ”¾æ±‡ç¼–ä»£ç ç›´æ¥è®¿é—®çš„åº•å±‚æ•°æ®ï¼ŒARM64æ¶æ„å®šä¹‰ç»“æ„ä½“ // arch/arm64/include/asm/thread_info.h struct thread_info { unsigned long\tflags;\t/* low level flags åº•å±‚æ ‡å¿—ä½ */ mm_segment_t\taddr_limit;\t/* address limit åœ°å€é™åˆ¶ */ #ifdef CONFIG_ARM64_SW_TTBR0_PAN u64\tttbr0;\t/* saved TTBR0_EL1 ä¿å­˜çš„å¯„å­˜å™¨TTBR0_EL1 */ #endif u64\tpreempt_count;\t/* æŠ¢å è®¡æ•°å™¨ 0 =\u003e preemptible å¯æŠ¢å , \u003c0 =\u003e bugç¼ºé™· */ }; ï¼ˆ3ï¼‰copy_credså‡½æ•° è´Ÿè´£å¤åˆ¶æˆ–å…±äº«è¯ä¹¦ï¼Œè¯ä¹¦å­˜æ”¾è¿›ç¨‹çš„ç”¨æˆ·æ ‡è¯†ç¬¦ã€ç»„æ ‡è¯†ç¬¦å’Œè®¿é—®æƒé™ã€‚è®¾ç½®æ ‡å¿—CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ã€‚CLONE_NEWUSERï¼Œéœ€è¦ä¸ºæ–°è¿›ç¨‹åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿›ç¨‹è®¡æ•°å™¨åŠ 1\nï¼ˆ4ï¼‰æ£€æŸ¥çº¿ç¨‹æ•°é‡é™åˆ¶ å…¨å±€å˜é‡nr_threadså­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡ï¼Œmax_threadså­˜æ”¾å…è®¸åˆ›å»ºçš„çº¿ç¨‹æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼MAX_THREADS\nï¼ˆ5ï¼‰sched_forkå‡½æ•°\nä¸ºæ–°è¿›ç¨‹è®¾ç½®è°ƒåº¦å™¨ç›¸å…³çš„å‚æ•°\n// linux-5.10.102/kernel/sched/core.c ä¹¦ä¸­ä¸º4.xç‰ˆæœ¬ int sched_fork(unsigned long clone_flags, struct task_struct *p) { __sched_fork(clone_flags, p); // æ‰§è¡ŒåŸºæœ¬è®¾ç½® /* * We mark the process as NEW here. This guarantees that * nobody will actually run it, and a signal or other external * event cannot wake it up and insert it on the runqueue either. */ p-\u003estate = TASK_NEW; // æ–°è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºTASK_NEW /* * Make sure we do not leak PI boosting priority to the child. */ p-\u003eprio = current-\u003enormal_prio; // æ–°è¿›ç¨‹è°ƒåº¦ä¼˜å…ˆçº§è®¾ç½®ä¸ºå½“å‰è¿›ç¨‹æ­£å¸¸ä¼˜å…ˆçº§ uclamp_fork(p); /* * Revert to default priority/policy on fork if requested. */ if (unlikely(p-\u003esched_reset_on_fork)) { if (task_has_dl_policy(p) || task_has_rt_policy(p)) { // é™æœŸè¿›ç¨‹æˆ–å®æ—¶è¿›ç¨‹ p-\u003epolicy = SCHED_NORMAL; // è°ƒåº¦ç­–ç•¥ p-\u003estatic_prio = NICE_TO_PRIO(0); // niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120 p-\u003ert_priority = 0; } else if (PRIO_TO_NICE(p-\u003estatic_prio) \u003c 0) // æ™®é€šè¿›ç¨‹ p-\u003estatic_prio = NICE_TO_PRIO(0); // niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120 p-\u003eprio = p-\u003enormal_prio = p-\u003estatic_prio; set_load_weight(p, false); /* * We don't need the reset flag anymore after the fork. It has * fulfilled its duty: */ p-\u003esched_reset_on_fork = 0; } if (dl_prio(p-\u003eprio)) // è°ƒåº¦ä¼˜å…ˆçº§æ˜¯é™æœŸè°ƒåº¦ç´¯çš„ä¼˜å…ˆçº§ return -EAGAIN; // ä¸å…è®¸é™æœŸè¿›ç¨‹åˆ†å‰ç”Ÿæˆæ–°çš„é™æœŸè¿›ç¨‹ else if (rt_prio(p-\u003eprio)) // è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å®æ—¶è°ƒåº¦ç±»ä¼˜å…ˆçº§ p-\u003esched_class = \u0026rt_sched_class; // è°ƒåº¦ç±»è®¾ç½®ä¸ºå®æ—¶è°ƒåº¦ç±» else p-\u003esched_class = \u0026fair_sched_class; // è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å…¬å¹³è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§ï¼Œè°ƒåº¦ç±»è®¾ç½®ä¸ºå…¬å¹³è°ƒåº¦ç±» init_entity_runnable_average(\u0026p-\u003ese); #ifdef CONFIG_SCHED_INFO if (likely(sched_info_on())) memset(\u0026p-\u003esched_info, 0, sizeof(p-\u003esched_info)); #endif #if defined(CONFIG_SMP) p-\u003eon_cpu = 0; #endif init_task_preempt_count(p); #ifdef CONFIG_SMP plist_node_init(\u0026p-\u003epushable_tasks, MAX_PRIO); RB_CLEAR_NODE(\u0026p-\u003epushable_dl_tasks); #endif return 0; } ï¼ˆ6ï¼‰å¤åˆ¶æˆ–å…±äº«èµ„æº 1ï¼‰UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰å…±äº«UNIXç³»ç»Ÿçš„5ä¿¡å·é‡ï¼Œcopy_semundoå‡½æ•°\n// linux-4.14.295/ipc/sem.c int copy_semundo(unsigned long clone_flags, struct task_struct *tsk) { struct sem_undo_list *undo_list; int error; if (clone_flags \u0026 CLONE_SYSVSEM) { // CLONE_SYSTEMè¡¨ç¤ºUNIXç³»ç»Ÿ5ä¿¡å·é‡ error = get_undo_list(\u0026undo_list); if (error) return error; refcount_inc(\u0026undo_list-\u003erefcnt); // 5ä¿¡å·é‡çš„æ’¤é”€è¯·æ±‚é“¾è¡¨ï¼Œsem_undo_list è®¡æ•°+1 tsk-\u003esysvsem.undo_list = undo_list; } else tsk-\u003esysvsem.undo_list = NULL; // æ–°è¿›ç¨‹5ä¿¡å·é‡æ’¤é”€è¯·æ±‚é“¾è¡¨ä¸ºç©º return 0; } 2ï¼‰æ‰“å¼€æ–‡ä»¶å¤¹ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ç›´æ¥å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ï¼Œå‡½æ•°copy_fileså¤åˆ¶æˆ–å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨\n// linux-5.10.102/kernel/fork.c static int copy_files(unsigned long clone_flags, struct task_struct *tsk) { struct files_struct *oldf, *newf; int error = 0; /* * A background process may not have any files ... */ oldf = current-\u003efiles; if (!oldf) goto out; if (clone_flags \u0026 CLONE_FILES) { // CLONE_FIELSå…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ atomic_inc(\u0026oldf-\u003ecount); // files_struct è®¡æ•°åŠ 1 goto out; } newf = dup_fd(oldf, NR_OPEN_MAX, \u0026error); // æ–°è¿›ç¨‹æŠŠå½“å‰è¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶è¡¨å¤åˆ¶ä¸€ä»½ if (!newf) goto out; tsk-\u003efiles = newf; error = 0; out: return error; } 3ï¼‰æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ã€‚è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡å·åŒ…æ‹¬ï¼šæ ¹ç›®å½•ã€å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ¨¡å¼åˆ›å»ºæ©ç ã€‚åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ å‡½æ•°copy_fså¤åˆ¶æˆ–å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯\n// linux-5.10.102/kernel/fork.c static int copy_fs(unsigned long clone_flags, struct task_struct *tsk) { struct fs_struct *fs = current-\u003efs; if (clone_flags \u0026 CLONE_FS) { // CLONE_FSå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ /* tsk-\u003efs is already what we want */ spin_lock(\u0026fs-\u003elock); if (fs-\u003ein_exec) { spin_unlock(\u0026fs-\u003elock); return -EAGAIN; } fs-\u003eusers++; // fs_structå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ç»“æ„ä½“ åŠ 1 spin_unlock(\u0026fs-\u003elock); return 0; } tsk-\u003efs = copy_fs_struct(fs); // æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ if (!tsk-\u003efs) return -ENOMEM; return 0; } 4ï¼‰ä¿¡å·å¤„ç†ç¨‹åºï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«ä¿¡å·å¤„ç†ç¨‹åº å‡½æ•°copy_sighandå¤åˆ¶æˆ–å…±äº«ä¿¡å·å¤„ç†ç¨‹åº\n// static int copy_sighand(unsigned long clone_flags, struct task_struct *tsk) { struct sighand_struct *sig; if (clone_flags \u0026 CLONE_SIGHAND) { // CLONE_SIGHAND è¡¨ç¤ºå…±äº«ä¿¡å·å¤„ç†ç¨‹åº refcount_inc(\u0026current-\u003esighand-\u003ecount); // å¼•ç”¨è®¡æ•°åŠ 1 return 0; } // æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹ä¿¡å·å¤„ç†ç¨‹åº sig = kmem_cache_alloc(sighand_cachep, GFP_KERNEL); RCU_INIT_POINTER(tsk-\u003esighand, sig); if (!sig) return -ENOMEM; refcount_set(\u0026sig-\u003ecount, 1); spin_lock_irq(\u0026current-\u003esighand-\u003esiglock); memcpy(sig-\u003eaction, current-\u003esighand-\u003eaction, sizeof(sig-\u003eaction)); spin_unlock_irq(\u0026current-\u003esighand-\u003esiglock); /* Reset all signal handler not set to SIG_IGN to SIG_DFL. */ if (clone_flags \u0026 CLONE_CLEAR_SIGHAND) flush_signal_handlers(tsk, 0); return 0; } 5ï¼‰ä¿¡å·ç»“æ„ä½“ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«ä¿¡å·ç»“æ„ä½“ å‡½æ•°copy_signalå¤åˆ¶æˆ–å…±äº«ä¿¡å·ç»“æ„ä½“\n// linux-5.10.102/kernel/fork.c static int copy_signal(unsigned long clone_flags, struct task_struct *tsk) { struct signal_struct *sig; if (clone_flags \u0026 CLONE_THREAD) // CLONE_THREADè¡¨ç¤ºåˆ›å»ºçº¿ç¨‹ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·ç»“æ„ä½“signal_struct return 0; // ä¸ºæ–°è¿›ç¨‹åˆ†é…ç»“æ„ä½“ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹èµ„æºé™åˆ¶ sig = kmem_cache_zalloc(signal_cachep, GFP_KERNEL); tsk-\u003esignal = sig; if (!sig) return -ENOMEM; sig-\u003enr_threads = 1; atomic_set(\u0026sig-\u003elive, 1); refcount_set(\u0026sig-\u003esigcnt, 1); /* list_add(thread_node, thread_head) without INIT_LIST_HEAD() */ sig-\u003ethread_head = (struct list_head)LIST_HEAD_INIT(tsk-\u003ethread_node); tsk-\u003ethread_node = (struct list_head)LIST_HEAD_INIT(sig-\u003ethread_head); init_waitqueue_head(\u0026sig-\u003ewait_chldexit); sig-\u003ecurr_target = tsk; init_sigpending(\u0026sig-\u003eshared_pending); INIT_HLIST_HEAD(\u0026sig-\u003emultiprocess); seqlock_init(\u0026sig-\u003estats_lock); prev_cputime_init(\u0026sig-\u003eprev_cputime); #ifdef CONFIG_POSIX_TIMERS INIT_LIST_HEAD(\u0026sig-\u003eposix_timers); hrtimer_init(\u0026sig-\u003ereal_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL); sig-\u003ereal_timer.function = it_real_fn; #endif task_lock(current-\u003egroup_leader); memcpy(sig-\u003erlim, current-\u003esignal-\u003erlim, sizeof sig-\u003erlim); task_unlock(current-\u003egroup_leader); posix_cpu_timers_init_group(sig); tty_audit_fork(sig); sched_autogroup_fork(sig); sig-\u003eoom_score_adj = current-\u003esignal-\u003eoom_score_adj; sig-\u003eoom_score_adj_min = current-\u003esignal-\u003eoom_score_adj_min; mutex_init(\u0026sig-\u003ecred_guard_mutex); init_rwsem(\u0026sig-\u003eexec_update_lock); return 0; } 6ï¼‰è™šæ‹Ÿå†…å­˜ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«è™šæ‹Ÿå†…å­˜ \\ å‡½æ•°copy_mmå¤åˆ¶æˆ–å…±äº«è™šæ‹Ÿå†…å­˜\n// linux-5.10.102/kernel/freezer.c static int copy_mm(unsigned long clone_flags, struct task_struct *tsk) { struct mm_struct *mm, *oldmm; int retval; tsk-\u003emin_flt = tsk-\u003emaj_flt = 0; tsk-\u003envcsw = tsk-\u003enivcsw = 0; #ifdef CONFIG_DETECT_HUNG_TASK tsk-\u003elast_switch_count = tsk-\u003envcsw + tsk-\u003enivcsw; tsk-\u003elast_switch_time = 0; #endif tsk-\u003emm = NULL; tsk-\u003eactive_mm = NULL; /* * Are we cloning a kernel thread? * * We need to steal a active VM for that.. */ oldmm = current-\u003emm; if (!oldmm) return 0; /* initialize the new vmacache entries */ vmacache_flush(tsk); if (clone_flags \u0026 CLONE_VM) { // CLONE_VMè¡¨ç¤ºå…±äº«è™šæ‹Ÿå†…å­˜ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å†…å­˜æè¿°ç¬¦mm_struct mmget(oldmm); mm = oldmm; goto good_mm; } retval = -ENOMEM; // æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ mm = dup_mm(tsk, current-\u003emm); if (!mm) goto fail_nomem; good_mm: tsk-\u003emm = mm; tsk-\u003eactive_mm = mm; return 0; fail_nomem: return retval; } 7ï¼‰å‘½åç©ºé—´ å‡½æ•°copy_namespaceåˆ›å»ºæˆ–å…±äº«å‘½åç©ºé—´\n// linux-5.10.102/kernel/nsproxy.c int copy_namespaces(unsigned long flags, struct task_struct *tsk) { struct nsproxy *old_ns = tsk-\u003ensproxy; struct user_namespace *user_ns = task_cred_xxx(tsk, user_ns); struct nsproxy *new_ns; int ret; // å¦‚æœå…±äº«é™¤äº†ç”¨æˆ·ä»¥å¤–çš„æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´ï¼Œ // é‚£ä¹ˆæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å‘½åç©ºé—´ä»£ç†ç»“æ„ä½“nsproxyï¼ŒæŠŠè®¡æ•°åŠ 1 if (likely(!(flags \u0026 (CLONE_NEWNS | CLONE_NEWUTS | CLONE_NEWIPC | CLONE_NEWPID | CLONE_NEWNET | CLONE_NEWCGROUP | CLONE_NEWTIME)))) { if (likely(old_ns-\u003etime_ns_for_children == old_ns-\u003etime_ns)) { get_nsproxy(old_ns); return 0; } } else if (!ns_capable(user_ns, CAP_SYS_ADMIN)) // è¿›ç¨‹æ²¡æœ‰ç³»ç»Ÿç®¡ç†æƒé™ï¼Œé‚£ä¹ˆä¸å…è®¸åˆ›å»ºæ–°çš„å‘½åç©ºé—´ return -EPERM; /* CLONE_NEWIPC must detach from the undolist: after switching * to a new ipc namespace, the semaphore arrays from the old * namespace are unreachable. In clone parlance, CLONE_SYSVSEM * means share undolist with parent, so we must forbid using * it along with CLONE_NEWIPC. */ // æ—¢è¦æ±‚åˆ›å»ºæ–°çš„è¿›ç¨‹é—´é€šä¿¡å‘½åç©ºé—´ï¼Œåˆè¦æ±‚å…±äº«UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼Œé‚£ä¹ˆè¿™ç§è¦æ±‚æ˜¯ä¸åˆç†çš„ if ((flags \u0026 (CLONE_NEWIPC | CLONE_SYSVSEM)) == (CLONE_NEWIPC | CLONE_SYSVSEM)) return -EINVAL; // åˆ›å»ºæ–°çš„å‘½åç©ºé—´ä»£ç†ï¼Œç„¶ååˆ›å»ºæˆ–è€…å…±äº«å‘½åç©ºé—´ new_ns = create_new_namespaces(flags, tsk, user_ns, tsk-\u003efs); if (IS_ERR(new_ns)) return PTR_ERR(new_ns); ret = timens_on_fork(new_ns, tsk); if (ret) { free_nsproxy(new_ns); return ret; } tsk-\u003ensproxy = new_ns; return 0; } 8ï¼‰I/Oä¸Šä¸‹æ–‡ å‡½æ•°copy_ioåˆ›å»ºæˆ–å…±äº«I/Oä¸Šä¸‹æ–‡\n// linux-5.10.102/kernel/fork.c static int copy_io(unsigned long clone_flags, struct task_struct *tsk) { #ifdef CONFIG_BLOCK struct io_context *ioc = current-\u003eio_context; struct io_context *new_ioc; if (!ioc) return 0; /* Share io context with parent, if CLONE_IO is set */ if (clone_flags \u0026 CLONE_IO) { // CLONE_IO å…±äº«I/Oä¸Šå°æ–‡ ioc_task_link(ioc); // è®¡æ•°nr_tasksåŠ 1 tsk-\u003eio_context = ioc; // å…±äº«I/Oä¸Šä¸‹æ–‡ç»“æ„ä½“io_context } else if (ioprio_valid(ioc-\u003eioprio)) { // åˆ›å»ºæ–°çš„I/Oä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹çš„I/Oä¼˜å…ˆçº§ new_ioc = get_task_io_context(tsk, GFP_KERNEL, NUMA_NO_NODE); if (unlikely(!new_ioc)) return -ENOMEM; new_ioc-\u003eioprio = ioc-\u003eioprio; put_io_context(new_ioc); } #endif return 0; } 9ï¼‰å¤åˆ¶å¯„å­˜å™¨å€¼ å‡½æ•°copy_thread_tlså¤åˆ¶å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨å€¼ï¼Œå¹¶ä¿®æ”¹ä¸€éƒ¨åˆ†å¯„å­˜å™¨å€¼ã€‚è¿›ç¨‹æœ‰ä¸¤å¤„ç”¨æ¥ä¿å­˜å¯„å­˜å™¨å€¼ï¼šä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼æ—¶ï¼ŒæŠŠç”¨æˆ·æ¨¡å¼çš„å„ç§å¯„å­˜å™¨ä¿å­˜åœ¨å†…æ ¸æ ˆåº•éƒ¨çš„ç»“æ„ä½“pt_regsä¸­ï¼›è¿›ç¨‹è°ƒåº¦å™¨è°ƒåº¦è¿›ç¨‹æ—¶ï¼Œåˆ‡æ¢å‡ºå»çš„è¿›ç¨‹æŠŠå¯„å­˜å™¨å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜threadä¸­ã€‚å› ä¸ºä¸åŒå¤„ç†å™¨æ¶æ„çš„å¯„å­˜å™¨ä¸åŒï¼Œæ‰€ä»¥å„ç§å¤„ç†å™¨æ¶æ„éœ€è¦è‡ªå·±å®šä¹‰ç»“æ„ä½“pt_regså’Œthread_struct\nARM64æ¶æ„copy_thread_tls-\u003ecopy_thread\n// linux-5.10.102/arch/arm64/kernel/process.c int copy_thread(unsigned long clone_flags, unsigned long stack_start, unsigned long stk_sz, struct task_struct *p, unsigned long tls) { struct pt_regs *childregs = task_pt_regs(p); // æ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextæ¸…é›¶ï¼Œåœ¨è°ƒåº¦è¿›ç¨‹æ—¶åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹ä½¿ç”¨è¿™ä¸ªæˆå‘˜ä¿å­˜é€šç”¨å¯„å­˜å™¨çš„å€¼ memset(\u0026p-\u003ethread.cpu_context, 0, sizeof(struct cpu_context)); /* In case p was allocated the same task_struct pointer as some * other recently-exited task, make sure p is disassociated from * any cpu that may have run that now-exited task recently. * Otherwise we could erroneously skip reloading the FPSIMD * registers for p. */ fpsimd_flush_task_state(p); ptrauth_thread_init_kernel(p); if (likely(!(p-\u003eflags \u0026 PF_KTHREAD))) { // ç”¨æˆ·è¿›ç¨‹ *childregs = *current_pt_regs(); childregs-\u003eregs[0] = 0; /* Read the current TLS pointer from tpidr_el0 as it may be * out-of-sync with the saved value. * ä»å¯„å­˜å™¨tpidr_el0è¯»å–å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ï¼Œ * å› ä¸ºå®ƒå¯èƒ½å’Œä¿å­˜çš„å€¼ä¸ä¸€è‡´ */ *task_user_tls(p) = read_sysreg(tpidr_el0); if (stack_start) { if (is_compat_thread(task_thread_info(p))) childregs-\u003ecompat_sp = stack_start; else childregs-\u003esp = stack_start; } /* If a TLS pointer was passed to clone, use it for the new thread. * å¦‚æœæŠŠçº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ä¼ ç»™ç³»ç»Ÿè°ƒç”¨cloneçš„ç¬¬4ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ–°çº¿ç¨‹å°†ä½¿ç”¨å®ƒ*/ if (clone_flags \u0026 CLONE_SETTLS) p-\u003ethread.uw.tp_value = tls; } else { // å†…æ ¸çº¿ç¨‹ memset(childregs, 0, sizeof(struct pt_regs)); childregs-\u003epstate = PSR_MODE_EL1h; if (IS_ENABLED(CONFIG_ARM64_UAO) \u0026\u0026 cpus_have_const_cap(ARM64_HAS_UAO)) childregs-\u003epstate |= PSR_UAO_BIT; spectre_v4_enable_task_mitigation(p); if (system_uses_irq_prio_masking()) childregs-\u003epmr_save = GIC_PRIO_IRQON; p-\u003ethread.cpu_context.x19 = stack_start; p-\u003ethread.cpu_context.x20 = stk_sz; } p-\u003ethread.cpu_context.pc = (unsigned long)ret_from_fork; p-\u003ethread.cpu_context.sp = (unsigned long)childregs; ptrace_hw_copy_thread(p); return 0; } ï¼ˆ7ï¼‰è®¾ç½®è¿›ç¨‹å·å’Œè¿›ç¨‹å…³ç³» static __latent_entropy struct task_struct *copy_process( struct pid *pid, int trace, int node, struct kernel_clone_args *args) { // ä¸ºæ–°è¿›ç¨‹åˆ†é…è¿›ç¨‹å· // pidç­‰äºinit_struct_pidçš„åœ°å€ï¼Œå†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œå¼•å¯¼å¤„ç†å™¨ä¸ºæ¯ä¸ªä»å¤„ç†å™¨åˆ†å‰ç”Ÿæˆä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼ˆå‚è€ƒå‡½æ•°idle_threads_initï¼‰ï¼Œæ‰€æœ‰å¤„ç†å™¨çš„ç©ºé—²çº¿ç¨‹ä½¿ç”¨è¿›ç¨‹å·0ï¼Œå…¨å±€å˜é‡init_struct_pidå­˜æ”¾ç©ºé—²çº¿ç¨‹çš„è¿›ç¨‹å· if (pid != \u0026init_struct_pid) { pid = alloc_pid(p-\u003ensproxy-\u003epid_ns_for_children); if (IS_ERR(pid)) { retval = PTR_ERR(pid); goto bad_fork_cleanup_thread; } } â€¦ // è®¾ç½®æ–°è¿›ç¨‹é€€å‡ºæ—¶å‘é€ç»™çˆ¶è¿›ç¨‹çš„ä¿¡å· p-\u003epid = pid_nr(pid); if (clone_flags \u0026 CLONE_THREAD) { p-\u003eexit_signal = -1; // æ–°çº¿ç¨‹é€€å‡ºæ—¶ä¸éœ€è¦å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹ p-\u003egroup_leader = current-\u003egroup_leader; // group_leaderæŒ‡å‘åŒä¸€ä¸ªç»„é•¿ p-\u003etgid = current-\u003etgid; // tgidå­˜æ”¾ç»„é•¿çš„è¿›ç¨‹å· } else { if (clone_flags \u0026 CLONE_PARENT) // CLONE_PARENT æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ˜¯å…„å¼Ÿå…³ç³» p-\u003eexit_signal = current-\u003egroup_leader-\u003eexit_signal; // æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalç­‰äºå½“å‰è¿›ç¨‹æ‰€å±çº¿ç¨‹ç»„çš„ç»„é•¿çš„æˆå‘˜exit_signal else // çˆ¶å­å…³ç³» p-\u003eexit_signal = (clone_flags \u0026 CSIGNAL); // æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalæ˜¯è°ƒç”¨è€…æŒ‡å®šçš„ä¿¡å· p-\u003egroup_leader = p; p-\u003etgid = p-\u003epid; } // æ§åˆ¶ç»„çš„è¿›ç¨‹æ•°æ§åˆ¶å™¨æ£€æŸ¥æ˜¯å¦å…è®¸åˆ›å»ºæ–°è¿›ç¨‹ï¼š // ä»å½“å‰è¿›ç¨‹æ‰€å±çš„æ§åˆ¶ç»„ä¸€ç›´åˆ°æ§åˆ¶ç»„å±‚çº§çš„æ ¹ï¼Œ // å¦‚æœå…¶ä¸­ä¸€ä¸ªæ§åˆ¶ç»„çš„è¿›ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºé™åˆ¶ï¼Œ // é‚£ä¹ˆä¸å…è®¸ä½¿ç”¨forkå’Œcloneåˆ›å»ºæ–°è¿›ç¨‹ cgroup_threadgroup_change_begin(current); retval = cgroup_can_fork(p); if (retval) goto bad_fork_free_pid; write_lock_irq(\u0026tasklist_lock); // ä¸ºæ–°è¿›ç¨‹è®¾ç½®çˆ¶è¿›ç¨‹ if (clone_flags \u0026 (CLONE_PARENT|CLONE_THREAD)) { // æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ‹¥æœ‰ç›¸åŒçš„çˆ¶è¿›ç¨‹ p-\u003ereal_parent = current-\u003ereal_parent; p-\u003eparent_exec_id = current-\u003eparent_exec_id; } else { p-\u003ereal_parent = current; // æ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯å½“å‰è¿›ç¨‹ p-\u003eparent_exec_id = current-\u003eself_exec_id; } â€¦ spin_lock(\u0026current-\u003esighand-\u003esiglock); â€¦ if (likely(p-\u003epid)) { â€¦ init_task_pid(p, PIDTYPE_PID, pid); if (thread_group_leader(p)) { // true æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„ init_task_pid(p, PIDTYPE_PGID, task_pgrp(current)); // æŒ‡å‘åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿çš„è¿›ç¨‹å·ç»“æ„ä½“ init_task_pid(p, PIDTYPE_SID, task_session(current)); // æŒ‡å‘åŒä¸€ä¸ªä¼šè¯çš„æ§åˆ¶è¿›ç¨‹çš„è¿›ç¨‹å·ç»“æ„ä½“ if (is_child_reaper(pid)) { ns_of_pid(pid)-\u003echild_reaper = p; p-\u003esignal-\u003eflags |= SIGNAL_UNKILLABLE; // 1å·è¿›ç¨‹æ˜¯ä¸èƒ½æ€æ­»çš„ } p-\u003esignal-\u003eleader_pid = pid; p-\u003esignal-\u003etty = tty_kref_get(current-\u003esignal-\u003etty); p-\u003esignal-\u003ehas_child_subreaper = p-\u003ereal_parent-\u003esignal-\u003e has_child_subreaper || p-\u003ereal_parent-\u003esignal-\u003eis_child_subreaper; list_add_tail(\u0026p-\u003esibling, \u0026p-\u003ereal_parent-\u003echildren); // æ–°è¿›ç¨‹æ·»åŠ åˆ°çˆ¶è¿›ç¨‹çš„å­è¿›ç¨‹é“¾è¡¨ // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹é“¾è¡¨ä¸­ï¼Œé“¾è¡¨èŠ‚ç‚¹æ˜¯æˆå‘˜tasksï¼Œ // å¤´èŠ‚ç‚¹æ˜¯ç©ºé—²çº¿ç¨‹çš„æˆå‘˜tasksï¼ˆinit_task.tasksï¼‰ list_add_tail_rcu(\u0026p-\u003etasks, \u0026init_task.tasks); attach_pid(p, PIDTYPE_PGID); // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹ç»„çš„è¿›ç¨‹é“¾è¡¨ attach_pid(p, PIDTYPE_SID); // æ–°è¿›ç¨‹æ·»åŠ åˆ°ä¼šè¯çš„è¿›ç¨‹é“¾è¡¨ __this_cpu_inc(process_counts); } else { // åˆ›å»ºçº¿ç¨‹ current-\u003esignal-\u003enr_threads++; // çº¿ç¨‹ç»„çš„çº¿ç¨‹è®¡æ•°å€¼åŠ 1 atomic_inc(\u0026current-\u003esignal-\u003elive); // åŸå­å˜é‡çº¿ç¨‹ç»„çš„ç¬¬2ä¸ªçº¿ç¨‹è®¡æ•°å€¼åŠ 1 atomic_inc(\u0026current-\u003esignal-\u003esigcnt); // ä¿¡å·ç»“æ„ä½“çš„å¼•ç”¨è®¡æ•°åŠ 1 list_add_tail_rcu(\u0026p-\u003ethread_group, \u0026p-\u003egroup_leader-\u003ethread_group); // çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„çº¿ç¨‹é“¾è¡¨ list_add_tail_rcu(\u0026p-\u003ethread_node, \u0026p-\u003esignal-\u003ethread_head); // çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„ç¬¬äºŒæ¡çº¿ç¨‹é“¾è¡¨ } attach_pid(p, PIDTYPE_PID); // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨ nr_threads++; // æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨ } total_forks++; spin_unlock(\u0026current-\u003esighand-\u003esiglock); â€¦ write_unlock_irq(\u0026tasklist_lock); proc_fork_connector(p); cgroup_post_fork(p); cgroup_threadgroup_change_end(current); â€¦ return p; } 3.å”¤é†’æ–°è¿›ç¨‹ wake_up_new_taskå‡½æ•°å”¤é†’æ–°è¿›ç¨‹\n// linux-5.10.102/kernel/sched/core.c void wake_up_new_task(struct task_struct *p) { struct rq_flags rf; struct rq *rq; raw_spin_lock_irqsave(\u0026p-\u003epi_lock, rf.flags); p-\u003estate = TASK_RUNNING; // åˆ‡æ¢TASK_RUNNING #ifdef CONFIG_SMP /* Fork balancing, do it here and not earlier because: * - cpus_ptr can change in the fork path * - any previously selected CPU might disappear through hotplug * Use __set_task_cpu() to avoid calling sched_class::migrate_task_rq, * as we're not fully set-up yet.*/ p-\u003erecent_used_cpu = task_cpu(p); rseq_migrate(p); __set_task_cpu(p, select_task_rq(p, task_cpu(p), SD_BALANCE_FORK, 0)); // åœ¨SMPç³»ç»Ÿä¸Šï¼Œåˆ›å»ºæ–°è¿›ç¨‹æ˜¯æ‰§è¡Œè´Ÿè½½å‡è¡¡çš„ç»ä½³æ—¶æœºï¼Œä¸ºæ–°è¿›ç¨‹é€‰æ‹©ä¸€ä¸ªè´Ÿè½½æœ€è½»çš„å¤„ç†å™¨ #endif rq = __task_rq_lock(p, \u0026rf); // é”ä½è¿è¡Œé˜Ÿåˆ— update_rq_clock(rq); // æ›´æ–°è¿è¡Œé˜Ÿåˆ—çš„æ—¶é’Ÿ post_init_entity_util_avg(p); // æ ¹æ®å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼ï¼Œæ¨ç®—æ–°è¿›ç¨‹çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼ activate_task(rq, p, ENQUEUE_NOCLOCK); // æŠŠæ–°è¿›ç¨‹æ’å…¥è¿è¡Œé˜Ÿåˆ— trace_sched_wakeup_new(p); check_preempt_curr(rq, p, WF_FORK); // æ£€æŸ¥æ–°è¿›ç¨‹æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿›ç¨‹ #ifdef CONFIG_SMP if (p-\u003esched_class-\u003etask_woken) { // åœ¨SMPç³»ç»Ÿä¸Šï¼Œè°ƒç”¨è°ƒåº¦ç±»çš„task_wokenæ–¹æ³• /* Nothing relies on rq-\u003elock after this, so its fine to * drop it.*/ rq_unpin_lock(rq, \u0026rf); p-\u003esched_class-\u003etask_woken(rq, p); rq_repin_lock(rq, \u0026rf); } #endif task_rq_unlock(rq, p, \u0026rf); // é‡Šæ”¾è¿è¡Œé˜Ÿåˆ—çš„é” } 4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæ˜¯ä»å‡½æ•°ret_from_forkå¼€å§‹æ‰§è¡Œï¼ŒARM64çš„ret_from_forkå‡½æ•°\n// linux-5.10.102/arch/arm64/kernel/entry.S tsk .req x28 //å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€ SYM_CODE_START(ret_from_fork) bl\tschedule_tail // ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ cbz\tx19, 1f // not a kernel thread å¦‚æœå¯„å­˜å™¨x19çš„å€¼æ˜¯0ï¼Œè¯´æ˜å½“å‰è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ ‡å·1 mov\tx0, x20 // å†…æ ¸çº¿ç¨‹ï¼šx19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œx20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•° blr\tx19 // è°ƒç”¨çº¿ç¨‹å‡½æ•° 1:\tget_current_task tsk // ç”¨æˆ·è¿›ç¨‹ï¼šx28 = sp_el0 = å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€ b\tret_to_user // è¿”å›ç”¨æˆ·æ¨¡å¼ SYM_CODE_END(ret_from_fork) NOKPROBE(ret_from_fork) copy_threadå‡½æ•°ä¸­ï¼Œæ–°è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œå¯„å­˜å™¨x19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œå¯„å­˜å™¨x20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœæ–°è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œå¯„å­˜å™¨x19å€¼æ˜¯0 // linux-5.10.102/kernel/sched/core.c asmlinkage __visible void schedule_tail(struct task_struct *prev) __releases(rq-\u003elock) { struct rq *rq; /* New tasks start with FORK_PREEMPT_COUNT, see there and * finish_task_switch() for details. * * finish_task_switch() will drop rq-\u003elock() and lower preempt_count * and the preempt_enable() will end up enabling preemption (on * PREEMPT_COUNT kernels).*/ rq = finish_task_switch(prev); // ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ2.8.6 balance_callback(rq); // æ‰§è¡Œè¿è¡Œé˜Ÿåˆ—çš„æ‰€æœ‰è´Ÿè½½å‡è¡¡å›è°ƒå‡½æ•° preempt_enable(); // å¼€å¯å†…æ ¸æŠ¢å  if (current-\u003eset_child_tid) // pthreadåº“åœ¨è°ƒç”¨clone()åˆ›å»ºçº¿ç¨‹æ—¶è®¾ç½®äº†æ ‡å¿—ä½CLONE_CHILD_SETTIDï¼Œé‚£ä¹ˆæ–°è¿›ç¨‹æŠŠè‡ªå·±çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°æŒ‡å®šä½ç½® put_user(task_pid_vnr(current), current-\u003eset_child_tid); calculate_sigpending(); } 2.5.2 è£…è½½ç¨‹åº è°ƒåº¦å™¨è°ƒåº¦æ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹ä»å‡½æ•°ret_from_forkå¼€å§‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨forkè¿”å›ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å€¼0ã€‚ç„¶åæ–°è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨execveè£…è½½ç¨‹åºã€‚Linuxå†…æ ¸ç»ƒä¸ªè£…è½½ç¨‹åºç³»ç»Ÿè°ƒç”¨ï¼š \\\n// è·¯å¾„åæ˜¯ç›¸å¯¹æ—¶execveè§£é‡Šä¸ºç›¸å¯¹è°ƒç”¨è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½• int execve(const char *filename, char *const argv[], char *const envp[]); // è·¯å¾„åæ˜¯ç›¸å¯¹çš„ï¼Œexecveatè§£é‡Šä¸ºç›¸å¯¹æ–‡ä»¶æè¿°ç¬¦dirfdæŒ‡å‘çš„ç›®å½• // è·¯å¾„åæ—¶ç»å¯¹çš„ï¼Œexecveatå¿½ç•¥å‚æ•°dirfd int execveat(int dirfd, const char *pathname, char *const argv[], char *const envp[], int flags); å‚æ•°argvæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„å‚æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²çš„åœ°å€ï¼Œargv[0]åº”è¯¥æŒ‡å‘è¦è£…è½½çš„ç¨‹åºçš„åç§°ã€‚å‚æ•°envpæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„ç¯å¢ƒæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªç¯å¢ƒå­—ç¬¦ä¸²çš„åœ°å€ï¼Œç¯å¢ƒå­—ç¬¦ä¸²çš„å½¢å¼æ˜¯â€œé”®=å€¼\nä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½è°ƒç”¨å‡½æ•°do_execveat_common å‡½æ•°do_open_execatæ‰“å¼€å¯æ‰§è¡Œæ–‡ä»¶ã€‚ å‡½æ•°sched_execã€‚è£…è½½ç¨‹åºæ˜¯å®ç°å¤„ç†å™¨è´Ÿè½½å‡è¡¡çš„æœºä¼šï¼Œæ­¤æ—¶è¿›ç¨‹åœ¨å†…å­˜å’Œç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€å°‘çš„ã€‚é€‰æ‹©è´Ÿè½½æœ€è½»çš„å¤„ç†å™¨ï¼Œç„¶åå”¤é†’å½“å‰å¤„ç†å™¨ä¸Šçš„è¿ç§»çº¿ç¨‹ï¼Œå½“å‰è¿›ç¨‹ç¡çœ ç­‰å¾…è¿ç§»çº¿ç¨‹æŠŠè‡ªå·±è¿ç§»åˆ°ç›®æ ‡å¤„ç†å™¨ å‡½æ•°bprm_mm_initåˆ›å»ºæ–°çš„å†…å­˜æè¿°ç¬¦ï¼Œåˆ†é…é•¿åº¦ä¸ºä¸€é¡µçš„ä¸´æ—¶çš„ç”¨æˆ·æ ˆï¼Œè™šæ‹Ÿåœ°å€èŒƒå›´æ˜¯[STACK_TOP_MAXâˆ’é¡µé•¿åº¦ï¼ŒSTACK_TOP_MAX]ï¼Œbprm-\u003epæŒ‡å‘åœ¨æ ˆåº•ä¿ç•™ä¸€ä¸ªå­—é•¿ï¼ˆæŒ‡é’ˆé•¿åº¦ï¼‰åçš„ä½ç½® å‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»æ–‡ä»¶çš„å‰é¢128å­—èŠ‚åˆ°ç¼“å†²åŒºã€‚128å­—èŠ‚æ˜¯ä»€ä¹ˆï¼Ÿ \\ ä¾æ¬¡æŠŠæ–‡ä»¶åç§°ã€ç¯å¢ƒå­—ç¬¦ä¸²å’Œå‚æ•°å­—ç¬¦ä¸²å‹åˆ°ç”¨æˆ·æ ˆ å‡½æ•°exec_binprmè°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«æ­£åœ¨è£…è½½çš„ç¨‹åºä¸ºæ­¢\n1.äºŒè¿›åˆ¶æ ¼å¼ LinuxäºŒè¿›åˆ¶æ ¼å¼\n// linux-5.10.102/include/linux/binfmts.h struct linux_binfmt { struct list_head lh; struct module *module; int (*load_binary)(struct linux_binprm *); int (*load_shlib)(struct file *); int (*core_dump)(struct coredump_params *cprm); unsigned long min_coredump;\t/* minimal dump size */ } __randomize_layout; äºŒè¿›åˆ¶æ ¼å¼æä¾›3ä¸ªå‡½æ•° (1)load_binary åŠ è½½æ™®é€šç¨‹åº (2)load_shlib åŠ è½½å…±äº«åº“ (3)core_dump åœ¨è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œmin_coredumpæŒ‡å®šæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶çš„æœ€å°é•¿åº¦ äºŒè¿›åˆ¶æ ¼å¼ä½¿ç”¨register_binfmtå‘å†…æ ¸æ³¨å†Œ\n2.è£…è½½ELFç¨‹åº ELFæ–‡ä»¶,ELF(Executable and Linkable Format)å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼ linux-5.10.102/include/uapi/linux/elf.h\nç›®æ ‡æ–‡ä»¶(å¯é‡å®šä½æ–‡ä»¶)ï¼Œ.oï¼Œå¤šä¸ªæ¨¡æ¿æ–‡ä»¶é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ å¯æ‰§è¡Œæ–‡ä»¶ å…±äº«åº“ .so æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶(core dump file) ELFæ–‡ä»¶åˆ†æˆ4éƒ¨åˆ†ï¼šELFé¦–éƒ¨ã€ç¨‹åºé¦–éƒ¨è¡¨(programe header table)ã€èŠ‚(section)å’ŒèŠ‚é¦–éƒ¨è¡¨(section header table)ï¼ŒELFåªæœ‰é¦–éƒ¨çš„ä½ç½®æ˜¯å›ºå®šçš„ã€‚\nç¨‹åºé¦–éƒ¨è¡¨å°±æ˜¯æ®µè¡¨(segment table)ï¼Œæ®µ(segment)æ˜¯ä»è¿è¡Œè§’åº¦æè¿°ï¼ŒèŠ‚(section)æ˜¯ä»é“¾æ¥è§’åº¦æè¿°ã€‚ 64ä½ELFæ–‡ä»¶æ ¼å¼\nå‚è€ƒé“¾æ¥ï¼š ELF æ ¼å¼è¯¦è§£ https://blog.csdn.net/shanandqiu/article/details/115206426 ELFæ–‡ä»¶æ ¼å¼ç®€ä»‹ https://blog.csdn.net/GrayOnDream/article/details/124564129\n# æŸ¥çœ‹ELFé¦–éƒ¨ readelf -h # æŸ¥çœ‹ç¨‹åºé¦–éƒ¨è¡¨ readelf -l # æŸ¥çœ‹èŠ‚é¦–éƒ¨è¡¨ readelf -S ELFè§£æç¨‹åº linux-5.10.102/fs/binfmt_elf.c è§£æ64ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ— å…³ linux-5.10.102/fs/compat_binfmt_elf.c åœ¨64ä½å†…æ ¸ä¸­è§£æ32ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ—  \\\nè£…è½½ELFç¨‹åºå‡½æ•°load_elf_binary\n1ï¼‰æ£€æŸ¥ELFé¦–éƒ¨ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ï¼Œæ£€æŸ¥å¤„ç†å™¨æ¶æ„ 2ï¼‰è¯»å–ç¨‹åºé¦–éƒ¨è¡¨ 3ï¼‰ç¨‹åºé¦–éƒ¨è¡¨ä¸­æŸ¥æ‰¾è§£é‡Šå™¨æ®µï¼Œå¦‚ç¨‹åºéœ€è¦é“¾æ¥åŠ¨æ€åº“ï¼Œå­˜åœ¨è§£é‡Šå™¨æ®µï¼Œä»è§£é‡Šå™¨æ®µè¯»å–è§£é‡Šå™¨çš„æ–‡ä»¶åç§°ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–ELFé¦–éƒ¨ã€‚ 4ï¼‰æ£€æŸ¥è§£é‡Šå™¨çš„ELFé¦–éƒ¨ï¼Œè¯»å–è§£é‡Šå™¨çš„ç¨‹åºé¦–éƒ¨è¡¨ 5ï¼‰flush_old_execå‡½æ•°ç»ˆæ­¢çº¿ç¨‹ç»„ä¸­å…¶ä»–çº¿ç¨‹ï¼Œé‡Šæ”¾æ—§çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ 6ï¼‰setup_new_execå‡½æ•°è°ƒç”¨arch_pick_mmap_layoutè®¾ç½®å†…å­˜æ˜ å°„çš„å¸ƒå±€ï¼Œåœ¨å †å’Œæ ˆç›´æ¥æœ‰ä¸€ä¸ªå†…å­˜æ˜ å°„åŒºåŸŸ 7ï¼‰ä¹‹å‰è°ƒç”¨bprm_mm_initå‡½æ•°åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ ˆï¼Œè°ƒç”¨set_arg_pageså‡½æ•°æŠŠç”¨æˆ·æ ˆå®šä¸‹æ¥ï¼Œæ›´æ–°ç”¨æˆ·æ ˆæ ‡å¿—ä½å’Œè®¿é—®æƒé™ï¼ŒæŠŠç”¨æˆ·æ ˆç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®ï¼Œå¹¶æ‰©å¤§ç”¨æˆ·æ ˆ 8ï¼‰æŠŠå¯åŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ 9ï¼‰setbrkå‡½æ•°æŠŠåˆå§‹åŒ–æ•°æ®æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶è®¾ç½®å †çš„èµ·å§‹è™šæ‹Ÿåœ°å€ï¼Œè°ƒç”¨padzeroå‡½æ•°ç”¨é›¶å¡«å……æœªåˆå§‹åŒ–æ•°æ®æ®µ 10ï¼‰å¾—åˆ°ç¨‹åºå…¥å£ã€‚ç¨‹åºæœ‰è§£é‡Šå™¨æ®µï¼ŒåŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç¨‹åºå…¥å£åˆ‡æ¢ä¸ºè§£é‡Šå™¨ç¨‹åºå…¥å£ 11ï¼‰è°ƒç”¨create_elf_tablesä¾æ¬¡æŠŠä¼ é€’ELFè§£é‡Šå™¨ä¿¡æ¯çš„è¾…åŠ©å‘é‡ã€ç¯å¢ƒæŒ‡é’ˆæ•°ç»„envpã€å‚æ•°æŒ‡é’ˆæ•°ç»„argvå’Œå‚æ•°ä¸ªæ•°argcå‹åˆ°è¿›ç¨‹çš„ç”¨æˆ·æ ˆ 12ï¼‰è°ƒç”¨å‡½æ•°start_threadè®¾ç½®ç»“æ„ä½“pt_regsä¸­ç¨‹åºè®¡æ•°å™¨å’Œæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒARM64æ¶æ„å®šä¹‰çš„å‡½æ•°start_thread\n// linux-5.10.102/arch/arm64/include/asm/processor.h static inline void start_thread_common(struct pt_regs *regs, unsigned long pc) { memset(regs, 0, sizeof(*regs)); forget_syscall(regs); regs-\u003epc = pc; /* æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ */ } static inline void start_thread(struct pt_regs *regs, unsigned long pc, unsigned long sp) { start_thread_common(regs, pc); regs-\u003epstate = PSR_MODE_EL0t; /* æŠŠå¤„ç†å™¨çŠ¶æ€è®¾ç½®ä¸º0ï¼Œå…¶ä¸­å¼‚å¸¸çº§åˆ«æ˜¯0 */ spectre_v4_enable_task_mitigation(current); regs-\u003esp = sp; /*è®¾ç½®ç”¨æˆ·æ ˆæŒ‡é’ˆ */ } 3.è£…è½½è„šæœ¬ç¨‹åº è„šæœ¬ç¨‹åºå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯#!ï¼Œåé¢æ˜¯è§£é‡Šå™¨ç¨‹åºçš„åç§°å’Œå‚æ•°ã€‚è§£é‡Šå™¨ç”¨æ¥æ‰§è¡Œè„šæœ¬ç¨‹åº linux-5.10.102/fs/binfmt_script.cå‡½æ•°load_scriptè´Ÿè´£è£…è½½è„šæœ¬ç¨‹åº\n1ï¼‰æ£€æŸ¥å‰ä¸¤ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯è„šæœ¬ç¨‹åºçš„æ ‡è¯†ç¬¦ 2ï¼‰è§£æå¤„è§£é‡Šç¨‹åºçš„åç§°å’Œå‚æ•° 3ï¼‰ä»ç”¨æˆ·æ ˆåˆ é™¤ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¾æ¬¡æŠŠè„šæœ¬ç¨‹åºçš„æ–‡ä»¶åç§°ã€ä¼ ç»™è§£é‡Šç¨‹åºçš„å‚æ•°å’Œè§£é‡Šç¨‹åºçš„åç§°å‹åˆ°ç”¨æˆ·æ ˆ 4ï¼‰è°ƒç”¨opens_execæ‰“å¼€è§£é‡Šç¨‹åºæ–‡ä»¶ 5ï¼‰è°ƒç”¨å‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»å–è§£é‡Šç¨‹åºæ–‡ä»¶çš„å‰128å­—èŠ‚åˆ°ç¼“å†²åŒº 6ï¼‰è°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«è§£é‡Šç¨‹åºä¸ºæ­¢ \\\n2.6 è¿›ç¨‹é€€å‡º è¿›ç¨‹é€€å‡ºä¸¤ç§æƒ…å†µï¼šè¿›ç¨‹ä¸»åŠ¨é€€å‡ºå’Œç»ˆæ­¢è¿›ç¨‹ Linuxå†…æ ¸ä¸¤ä¸ªä¸»åŠ¨é€€å‡ºçš„ç³»ç»Ÿè°ƒç”¨ \\\n// çº¿ç¨‹é€€å‡º void exit(int status); // ä¸€ä¸ªçº¿ç¨‹ç»„æ‰€æœ‰çº¿ç¨‹é€€å‡º void exit_group(int status); glibcåº“å‡½æ•°exitã€_exitå’Œ_Exitç”¨æ¥ä½¿è¿›ç¨‹é€€å‡ºï¼Œåº“å‡½æ•°è°ƒç”¨ç³»ç»Ÿè°ƒç”¨exit_groupã€‚åº“å‡½æ•°exitä¼šæ‰§è¡Œè¿›ç¨‹ä½¿ç”¨çš„atexitå’Œos_exitæ³¨å†Œçš„å‡½æ•° ç»ˆæ­¢è¿›ç¨‹æ˜¯é€€å‡ºç»™è¿›ç¨‹å‘é€ä¿¡å·å®ç°çš„ï¼ŒLinuxè®·æ²³å‘é€ä¿¡å·çš„ç³»ç»Ÿè°ƒç”¨\n// // å‘é€ä¿¡å·ç»™è¿›ç¨‹æˆ–è¿›ç¨‹ç»„ int kill(pid_t pid, int sig); // å‘é€ä¿¡å·ç»™çº¿ç¨‹ å·²åºŸå¼ƒ int tkill(int tid, int sig); // å‘é€ä¿¡å·ç»™çº¿ç¨‹ int tgkill(int tgid, int tid, int sig); çˆ¶è¿›ç¨‹æ˜¯å¦å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹å‡ï¼Œ 1ï¼‰çˆ¶è¿›ç¨‹å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶é‡Šæ”¾å„ç§èµ„æºï¼Œç•™ç©ºè¿›ç¨‹æè¿°ç¬¦çš„åƒµå°¸è¿›ç¨‹ï¼Œå‘é€ä¿¡å·SIGCHLD(CHILDæ˜¯child)é€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æŸ¥è¯¢è¿›ç¨‹ç»ˆæ­¢åŸå› ä»å­è¿›ç¨‹æ”¶å›è¿›ç¨‹æè¿°ç¬¦ã€‚è¿›ç¨‹é»˜è®¤å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨sigactionå¯¹ä¿¡å·SIGHLDè®¾ç½®æ ‡å¿—SA_NOCLDWAIT(CLDæ˜¯child)ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶ä¸å˜æˆåƒµå°¸è¿›ç¨‹æˆ–è®¾ç½®å¿½ç•¥ä¿¡å·SIGCHLD 2ï¼‰çˆ¶è¿›ç¨‹ä¸å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œè¿›ç¨‹é€€å‡ºæ˜¯é‡Šæ”¾å„ç§èµ„æºï¼Œé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦ Linuxå†…æ ¸3ä¸ªç³»ç»Ÿè°ƒç”¨ç­‰å¾…å­è¿›ç¨‹çŠ¶æ€æ”¹å˜ï¼šå­è¿›ç¨‹ç»ˆæ­¢ã€ä¿¡å·SIGSTOPä½¿å­è¿›ç¨‹åœæ­¢æ‰§è¡Œæˆ–ä¿¡å·SIGCONTä½¿å­è¿›ç¨‹ç»§ç»­æ‰§è¡Œ\npid_t waitpid(pid_t pid, int *wstatus, int options); int waitid(idtype_t idtype, id_t id, siginfo_t *infop, int options); pit_t wiat4(pit_t pid, int *wstatus, int options, staruct usage *rusage); // åºŸå¼ƒ çˆ¶è¿›ç¨‹é€€å‡ºæ—¶ï¼Œç»™å­è¿›ç¨‹å¯»æ‰¾é¢†å…»è€… 1ï¼‰è¿›ç¨‹å±äºä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œä¸”è¿˜æœ‰å…¶ä»–çº¿ç¨‹ï¼Œé€‰æ‹©ä»»æ„å…¶ä»–çº¿ç¨‹ 2ï¼‰é€‰æ‹©æœ€äº²è¿‘çš„å……å½“\"æ›¿è¡¥é¢†å…»è€…\"çš„ç¥–å…ˆè¿›ç¨‹ï¼Œè¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨prtctl(PR_SET_CHILD_SUBREAPER)è®¾ç½®ä¸ºæ›¿æ¢é¢†å…»è€… 3ï¼‰é€‰æ‹©æ‰€å±è¿›ç¨‹å·å‘½åç©ºé—´çš„1å·è¿›ç¨‹ 2.6.1 çº¿ç¨‹ç»„é€€å‡º exit_group ç³»ç»Ÿè°ƒç”¨exit_groupæ‰§è¡Œæµç¨‹\nä¸€ä¸ªçº¿ç¨‹ç»„çš„ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œçº¿ç¨‹1è°ƒç”¨exit_groupä½¿çº¿ç¨‹ç»„é€€å‡ºï¼Œçº¿ç¨‹1æ‰§è¡Œæµç¨‹ï¼š 1ï¼‰æŠŠé€€å‡ºç ä¿å­˜åœ¨ç»“æ„ä½“æˆå‘˜group_exit_codeä¸­ï¼Œä¼ é€’ç»™çº¿ç¨‹2 2ï¼‰ç»™çº¿ç¨‹ç»„è®¾ç½®æ­£åœ¨é€€å‡ºæ ‡å¿— 3ï¼‰å‘çº¿ç¨‹2å‘é€æ€æ­»ä¿¡å·ï¼Œå”¤é†’çº¿ç¨‹2ï¼Œçº¿ç¨‹2å¤„ç†æ€æ­»ä¿¡å· 4ï¼‰çº¿ç¨‹1è°ƒç”¨å‡½æ•°do_exitä»¥é€€å‡º çº¿ç¨‹2é€€å‡ºçš„æ‰§è¡Œæµç¨‹ï¼Œå‡½æ•°do_group_exitæ‰§è¡Œæµç¨‹\nçº¿ç¨‹2å¯èƒ½å‘æŒ¥ç”¨æˆ·æ¨¡å¼3ç§æƒ…å†µ ï¼ˆ1ï¼‰æ‰§è¡Œå®Œç³»ç»Ÿè°ƒç”¨ ï¼ˆ2ï¼‰è¢«ä¸­æ–­æŠ¢å ï¼Œä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œå®Œ ï¼ˆ3ï¼‰æ‰§è¡ŒæŒ‡ä»¤æ˜¯ç”Ÿæˆå¼‚å¸¸ï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºæ‰§è¡Œå®Œ \\\ndo_exitå‡½æ•°æ‰§è¡Œæµç¨‹ ï¼ˆ1ï¼‰é‡Šæ”¾å„ç§èµ„æºï¼ŒæŠŠèµ„æºå¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œåˆ™é‡Šæ”¾æ•°æ®ç»“æ„ ï¼ˆ2ï¼‰è°ƒç”¨å‡½æ•°exit_notifyï¼Œä¸ºå­è¿›ç¨‹é€‰æ‹©é¢†å…»è€…ï¼Œç„¶åæŠŠè‡ªå·±æ­»è®¯é€šçŸ¥çˆ¶è¿›ç¨‹ ï¼ˆ3ï¼‰æŠŠè¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºæ­»äº¡(TASK_DEAD) ï¼ˆ4ï¼‰æœ€åä¸€æ¬¡è°ƒç”¨å‡½æ•°__scheduleä»¥è°ƒåº¦è¿›ç¨‹ æ­»äº¡è¿›ç¨‹è°ƒç”¨__scheduleæ—¶è¿›ç¨‹è°ƒåº¦å™¨å¤„ç†æµç¨‹\n// linux-5.10.102/kernel/sched/core.c __schedule() --\u003e context_switch() --\u003e finish_task_switch() static struct rq *finish_task_switch(struct task_struct *prev) __releases(rq-\u003elock) { â€¦ prev_state = prev-\u003estate; â€¦ if (unlikely(prev_state == TASK_DEAD)) { if (prev-\u003esched_class-\u003etask_dead) prev-\u003esched_class-\u003etask_dead(prev); // æ‰§è¡Œè°ƒåº¦ç±»task_dead â€¦ // å¦‚æœç»“æ„ä½“thread_infoæ”¾åœ¨è¿›ç¨‹æè¿°ç¬¦é‡Œé¢ï¼Œ // è€Œä¸æ˜¯æ”¾åœ¨å†…æ ¸æ ˆçš„é¡¶éƒ¨ï¼Œé‚£ä¹ˆé‡Šæ”¾è¿›ç¨‹çš„å†…æ ¸æ ˆ put_task_stack(prev); // è¿›ç¨‹æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œé‚£ä¹ˆé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦ put_task_struct(prev); } â€¦ } 2.6.2 ç»ˆæ­¢è¿›ç¨‹ ç³»ç»Ÿè°ƒç”¨killå‘çº¿ç¨‹ç»„æˆ–è¿›ç¨‹ç»„å‘é€ä¿¡å·linux-5.10.102/kernel/signal.cï¼Œæ‰§è¡Œæµç¨‹ å‡½æ•°__send_signalä¸»è¦ä»£ç \n// linux-5.10.102/kernel/signal.c static int __send_signal(int sig, struct siginfo *info, struct task_struct *t, int group, int from_ancestor_ns) { struct sigpending *pending; struct sigqueue *q; int override_rlimit; int ret = 0, result; â€¦ result = TRACE_SIGNAL_IGNORED; // ç›®æ ‡çº¿ç¨‹å¿½ç•¥ä¿¡å·,ä¸å‘é€ä¿¡å· if (!prepare_signal(sig, t, from_ancestor_ns || (info == SEND_SIG_FORCED))) goto ret; // ç¡®å®šæŠŠä¿¡å·æ·»åŠ åˆ°å“ªä¸ªä¿¡å·é˜Ÿåˆ—å’Œé›†åˆ pending = group ? \u0026t-\u003esignal-\u003eshared_pending : \u0026t-\u003epending; result = TRACE_SIGNAL_ALREADY_PENDING; // ä¼ ç»Ÿä¿¡å·ï¼Œå¹¶ä¸”ä¿¡å·é›†åˆå·²ç»åŒ…å«åŒä¸€ä¸ªä¿¡å·,ä¸å‘é€ if (legacy_queue(pending, sig)) goto ret; â€¦ // åˆ¤æ–­åˆ†é…ä¿¡å·é˜Ÿåˆ—èŠ‚ç‚¹æ—¶æ˜¯å¦å¯ä»¥å¿½ç•¥ä¿¡å·é˜Ÿåˆ—é•¿åº¦çš„é™åˆ¶ if (sig \u003c SIGRTMIN) override_rlimit = (is_si_special(info) || info-\u003esi_code \u003e= 0); else override_rlimit = 0; // åˆ†é…ä¸€ä¸ªä¿¡å·é˜Ÿåˆ—èŠ‚ç‚¹ q = __sigqueue_alloc(sig, t, GFP_ATOMIC | __GFP_NOTRACK_FALSE_POSITIVE, override_rlimit); if (q) { list_add_tail(\u0026q-\u003elist, \u0026pending-\u003elist); // æ·»åŠ åˆ°ä¿¡å·é˜Ÿåˆ—ä¸­ â€¦ } else if (!is_si_special(info)) { â€¦ } out_set: signalfd_notify(t, sig); sigaddset(\u0026pending-\u003esignal, sig); // ä¿¡å·æ·»åŠ åˆ°ä¿¡å·é›†åˆä¸­ // åœ¨çº¿ç¨‹ç»„ä¸­æŸ¥æ‰¾ä¸€ä¸ªæ²¡æœ‰å±è”½ä¿¡å·çš„çº¿ç¨‹ï¼Œå”¤é†’å®ƒï¼Œè®©å®ƒå¤„ç†ä¿¡å· complete_signal(sig, t, group); ret: â€¦ return ret; } 2.6.3 æŸ¥è¯¢å­è¿›ç¨‹ç»ˆæ­¢åŸå›  ç³»ç»Ÿè°ƒç”¨waitid\nint waitid(idtype_t idtype, id_t id, siginfo_t *infop, int options); pid_t waitpid(pid_t pid, int *wstatus, int options); å‚æ•° å‚æ•°å€¼ å«ä¹‰ idtype P_ALL ç­‰å¾…ä»»æ„å­è¿›ç¨‹ï¼Œå¿½ç•¥å‚æ•°id P_PID ç­‰å¾…è¿›ç¨‹å·ä¸ºidçš„å­è¿›ç¨‹ P_PGID ç­‰å¾…è¿›ç¨‹ç»„æ ‡è¯†ç¬¦æ˜¯idçš„ä»»æ„å­è¿›ç¨‹ options WEXITED ç­‰å¾…é€€å‡ºçš„å­è¿›ç¨‹ WSTOPPED ç­‰å¾…æ”¶åˆ°ä¿¡å·SIGSTOPå¹¶åœæ­¢æ‰§è¡Œçš„å­è¿›ç¨‹ WCONTINUED ç­‰å¾…æ”¶åˆ°ä¿¡å·SIGCONTå¹¶ç»§ç»­æ‰§è¡Œçš„å­è¿›ç¨‹ WNOHANG å¦‚æœæ²¡æœ‰å­è¿›ç¨‹é€€å‡ºï¼Œç«‹å³è¿”å› WNOWAIT è®©å­è¿›ç¨‹å¤„äºåƒµå°¸çŠ¶æ€ï¼Œä»¥åå¯ä»¥å†æ¬¡æŸ¥è¯¢çŠ¶æ€ä¿¡æ¯ do_waitå‡½æ•°æ‰§è¡Œæµç¨‹\n2.7 è¿›ç¨‹çŠ¶æ€ çŠ¶æ€ state å«ä¹‰ å°±ç»ªçŠ¶æ€ TASK_RUNNING æ­£åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦å™¨è°ƒåº¦ è¿è¡ŒçŠ¶æ€ TASK_RUNNING è¢«è°ƒåº¦å™¨é€‰ä¸­ï¼Œæ­£åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œ è½»åº¦ç¡çœ  TASK_INTERRUPTIBLE å¯ä¿¡å·æ‰“æ–­çš„ç¡çœ çŠ¶æ€ ä¸­åº¦ç¡çœ  TASK_KILLABLE åªèƒ½è¢«è‡´å‘½çš„ä¿¡å·æ‰“æ–­ æ·±åº¦ç¡çœ  TASK_UNINTERRUPTIBLE ä¸å¯æ‰“æ–­çš„ç¡çœ çŠ¶æ€ åƒµå°¸çŠ¶æ€ TASK_DEAD è¢«è°ƒåº¦å™¨é€‰ä¸­ï¼Œæ­£åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œ æ­»äº¡çŠ¶æ€ TASK_DEAD å¦‚æœçˆ¶è¿›ç¨‹ä¸å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œé‚£ä¹ˆå­è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨æ¶ˆäº¡ è¿›ç¨‹çŠ¶æ€å˜è¿ 2.8 è¿›ç¨‹è°ƒåº¦ 2.8.1 è°ƒåº¦ç­–ç•¥ Linuxå†…æ ¸æ”¯æŒçš„è°ƒåº¦ç­–ç•¥ ï¼ˆ1ï¼‰é™åˆ¶è¿›ç¨‹ä½¿ç”¨é™æœŸè°ƒåº¦ç­–ç•¥(SCHED_DEADLINE)ï¼Œ3ä¸ªå‚æ•°ï¼šè¿è¡Œæ—¶é—´runtimeï¼Œæˆªæ­¢æœŸé™deadlineå’Œå‘¨æœŸperiod ï¼ˆ2ï¼‰å®æ—¶è¿›ç¨‹æ”¯æŒä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼šå…ˆè¿›å…ˆå‡ºè°ƒåº¦(SCHED_FIFO)å’Œè½®æµè°ƒåº¦(SCHED_RR) ï¼ˆ3ï¼‰æ™®é€šè¿›ç¨‹ä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼šæ ‡å‡†è½®æµåˆ†æ—¶(SCHED_NORMAL)å’Œç©ºé—²(SCHED_BATCH)ï¼ŒLinuxå†…æ ¸å¼•å…¥å®Œå…¨å…¬å¹³è°ƒåº¦ç®—æ³•åï¼Œæ‰¹é‡è°ƒåº¦ç­–ç•¥åºŸå¼ƒã€‚ \\\n2.8.2 è¿›ç¨‹ä¼˜å…ˆçº§ é™æœŸè¿›ç¨‹çš„ä¼˜å…ˆçº§æ¯”å®æ—¶è¿›ç¨‹é«˜ï¼Œå®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§æ¯”æ™®é€šè¿›ç¨‹é«˜ã€‚ é™æœŸè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜¯âˆ’1ã€‚ å®æ—¶è¿›ç¨‹çš„å®æ—¶ä¼˜å…ˆçº§æ˜¯1ï½99ï¼Œä¼˜å…ˆçº§æ•°å€¼è¶Šå¤§ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚ æ™®é€šè¿›ç¨‹çš„é™æ€ä¼˜å…ˆçº§æ˜¯100ï½139ï¼Œä¼˜å…ˆçº§æ•°å€¼è¶Šå°ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ï¼Œå¯é€šè¿‡ä¿®æ”¹niceå€¼ï¼ˆå³ç›¸å¯¹ä¼˜å…ˆçº§ï¼Œå–å€¼èŒƒå›´æ˜¯âˆ’20ï½19ï¼‰æ”¹å˜æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§ç­‰äº120åŠ ä¸Šniceå€¼ task_structä¸­ï¼Œ4ä¸ªæˆå‘˜å’Œä¼˜å…ˆçº§æœ‰å…³ \\\ninclude/linux/sched.h struct task_struct { â€¦ int prio; int static_prio; int normal_prio; unsigned int rt_priority; â€¦ }; ä¼˜å…ˆçº§ é™æœŸè¿›ç¨‹ å®æ—¶è¿›ç¨‹ æ™®é€šè¿›ç¨‹ prio\nè°ƒåº¦ä¼˜å…ˆçº§(æ•°å€¼è¶Šå°ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜) å¤§å¤šæ•°prioç­‰äºnormal_prio static_prio\né™æ€ä¼˜å…ˆçº§ æ€»æ˜¯0 æ€»æ˜¯0 120 + niceå€¼æ•°å€¼è¶Šå°ï¼Œ\nè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ normal_prio\næ­£å¸¸ä¼˜å…ˆçº§(æ•°å€¼è¶Šå°ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜) -1 99 âˆ’ rt_priority static_prio å®æ—¶ä¼˜å…ˆçº§ æ€»æ˜¯0 å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ 2.8.3 è°ƒåº¦ç±» Linuxå†…æ ¸æŠ½è±¡ä¸€ä¸ªè°ƒåº¦ç±»sched_classï¼Œç›®å‰å®ç°5ç§è°ƒåº¦ç±»ï¼Œä¼˜å…ˆçº§ä»ä¸Šåˆ°ä¸‹ä»é«˜åˆ°ä½ï¼š\nè°ƒåº¦ç±» è°ƒåº¦ç­–ç•¥ è°ƒåº¦ç®—æ³• è°ƒåº¦å¯¹è±¡ åœæœºè°ƒåº¦ç±»\nstop_sched_class æ—  æ—  åœæœºè¿›ç¨‹ é™æœŸè°ƒåº¦ç±»\ndl_sched_class SCHED_DEADLINE æœ€æ—©æœŸé™ä¼˜å…ˆ é™æœŸè¿›ç¨‹ å®æ—¶è°ƒåº¦ç±»\nrt_sched_class SCHED_FIFO\nSCHED_RR å…ˆè¿›å…ˆå‡º\nè½®æµè°ƒåº¦ å®æ—¶è¿›ç¨‹ å…¬å¹³è°ƒåº¦ç±»\ncfs_sched_class SCHED_NORMAL\nSCHED_IDIE å®Œå…¨å…¬å¹³è°ƒåº¦ç®—æ³• æ™®é€šè¿›ç¨‹ ç©ºé—²è°ƒåº¦ç±»\nidle_sched_class æ—  æ—  æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„ç©ºé—²çº¿ç¨‹ è¯¦ç»†ä¿¡æ¯å‚è€ƒä¹¦ç±\n2.8.4 è¿è¡Œé˜Ÿåˆ— æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼Œç»“æ„ä½“rqï¼Œå®šä¹‰å…¨å±€å˜é‡\n// linux-5.10.102/kernel/sched/cpuacct.c DEFINE_PER_CPU_SHARED_ALIGNED(struct rq, runqueues); // linux-5.10.102/kernel/sched/sched.h struct rq { // è¿è¡Œé˜Ÿåˆ— ... struct cfs_rq\tcfs; // å…¬å¹³è¿è¡Œé˜Ÿåˆ— struct rt_rq\trt; // å®æ—¶è¿è¡Œé˜Ÿåˆ— struct dl_rq\tdl; // é™æœŸè¿è¡Œé˜Ÿåˆ— ... struct task_struct\t*idle; // ç©ºé—²çº¿ç¨‹ struct task_struct\t*stop; // è¿ç§»çº¿ç¨‹ }; 2.8.5 ä»»åŠ¡åˆ†ç»„ 1.ä»»åŠ¡åˆ†ç»„æ–¹å¼ ä»»åŠ¡åˆ†ç»„æ–¹å¼ æ§åˆ¶å® é…ç½®æ–¹å¼ è‡ªåŠ¨ç»„ CONFIG_SCHED_AUTOGROUP /proc/sys/kernel/sched_autogroup_enabled è¿è¡Œè¿‡ç¨‹ä¸­å¼€å¯å…³é—­ï¼Œé»˜è®¤å€¼1\næºæ–‡ä»¶kernel/sched/auto_group.c CPUæ§åˆ¶ç»„ç‰ˆæœ¬1 CONFIG_CGROUPS\nCONFIG_CGROUP_SCHED mount -t tmpfs cgroup_root /sys/fs/cgroup\nmkdir /sys/fs/cgroup/cpu\nmount -t cgroup -o cpu none /sys/fs/cgroup/cpu\ncd /sys/fs/cgroup/cpu\nmkdir multimedia # åˆ›å»º\"multimedia\"ä»»åŠ¡ç»„\nmkdir browser # åˆ›å»º\"browser\"ä»»åŠ¡ç»„\necho 2048 \u003e multimedia/cpu.shares\necho 1024 \u003e browser/cpu.shares\necho \u003c pid1\u003e \u003e browser/tasks echo \u003c pid2\u003e \u003e multimedia/tasks\necho \u003c pid1\u003e \u003e browser/cgroup.procs\necho \u003c pid2\u003e \u003e multimedia/cgroup.procs cgroupç‰ˆæœ¬2 mount -t tmpfs cgroup_root /sys/fs/cgroup\nmount -t cgroup2 none /sys/fs/cgroup\ncd /sys/fs/cgroup echo \"+cpu\" \u003e cgroup.subtree_control\nmkdir multimedia # åˆ›å»º\"multimedia\"ä»»åŠ¡ç»„ mkdir browser # åˆ›å»º\"browser\"ä»»åŠ¡ç»„\necho 2048 \u003e multimedia/cpu.weight\necho 1024 \u003e browser/cpu.weight\necho \u003c pid1\u003e \u003e browser/cgroup.procs\necho \u003c pid2\u003e \u003e multimedia/cgroup.procs echo threaded \u003e browser/cgroup.type echo \u003c pid1\u003e \u003e browser/cgroup.threads echo threaded \u003e multimedia/cgroup.type echo \u003c pid2\u003e \u003e multimedia/cgroup.threads 2. æ•°æ®ç»“æ„ task_group,é»˜è®¤ä»»åŠ¡ç»„æ˜¯æ›´ä»»åŠ¡ç»„(å…¨å±€å˜é‡root_task_group)\næˆå‘˜ è¯´æ˜ const struct sched_class *sched_class è°ƒåº¦ç±» struct sched_entity se å…¬å¹³è°ƒåº¦å®ä½“ struct sched_dl_entity dl é™æœŸè°ƒåº¦å®ä½“ ä»»åŠ¡ç»„åœ¨æ¯ä¸ªå¤„ç†å™¨ä¸Šæœ‰å…¬å¹³è°ƒåº¦å®ä½“ã€å…¬å¹³è¿è¡Œé˜Ÿåˆ—ã€å®æ—¶è°ƒåº¦å®ä½“å’Œå®æ—¶è¿è¡Œé˜Ÿåˆ—ï¼Œæ ¹ä»»åŠ¡ç»„æ¯”è¾ƒç‰¹æ®Šï¼šæ²¡æœ‰å…¬å¹³è°ƒåº¦å®ä½“å’Œå®æ—¶è°ƒåº¦å®ä½“\næ¯ä¸ªå¤„ç†å™¨ä¸Šï¼Œè®¡ç®—ä»»åŠ¡ç»„çš„å…¬å¹³è°ƒåº¦å®ä½“çš„æƒé‡çš„æ–¹æ³•å¦‚ä¸‹ï¼ˆå‚è€ƒæºæ–‡ä»¶â€œkernel/ sched/fair.câ€ä¸­çš„å‡½æ•°update_cfs_shares\n2.8.6 è°ƒåº¦è¿›ç¨‹ è°ƒåº¦è¿›ç¨‹çš„æ ¸å¿ƒå‡½æ•°æ˜¯__schedule()\nkernel/sched/core.c // preemptæ˜¯å¦æŠ¢å ï¼ŒtrueæŠ¢å è°ƒåº¦ï¼Œfalseä¸»åŠ¨è°ƒåº¦ static void __sched notrace __schedule(bool preempt) { 1. è°ƒç”¨pick_next_taské€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ 2. è°ƒç”¨context_switchåˆ‡æ¢è¿›ç¨‹ } 1.é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ å‡½æ•°pick_next_task // linux-5.10.102/kernel/sched/core.c static inline struct task_struct * pick_next_task(struct rq *rq, struct task_struct *prev, struct rq_flags *rf) { const struct sched_class *class; struct task_struct *p; /* Optimization: we know that if all tasks are in the fair class we can * call that function directly, but only if the @prev task wasn't of a * higher scheduling class, because otherwise those loose the * opportunity to pull in more work from other CPUs.*/ // ä¼˜åŒ–ï¼šå¦‚æœæ‰€æœ‰è¿›ç¨‹å±äºå…¬å¹³è°ƒåº¦ç±» // ç›´æ¥è°ƒç”¨å…¬å¹³è°ƒåº¦ç±»çš„pick_next_taskæ–¹æ³• if (likely(prev-\u003esched_class \u003c= \u0026fair_sched_class \u0026\u0026 rq-\u003enr_running == rq-\u003ecfs.h_nr_running)) { p = pick_next_task_fair(rq, prev, rf); if (unlikely(p == RETRY_TASK)) goto restart; /* Assumes fair_sched_class-\u003enext == idle_sched_class */ // å‡å®šå…¬å¹³è°ƒåº¦ç±»çš„ä¸‹ä¸€ä¸ªè°ƒåº¦ç±»æ˜¯ç©ºé—²è°ƒåº¦ç±» if (!p) { put_prev_task(rq, prev); p = pick_next_task_idle(rq); } return p; } restart: put_prev_task_balance(rq, prev, rf); for_each_class(class) { p = class-\u003epick_next_task(rq); if (p) return p; } /* The idle class should always have a runnable task: */ // ç©ºé—²è°ƒåº¦ç±»åº”è¯¥æ€»æ˜¯æœ‰ä¸€ä¸ªè¿è¡Œçš„è¿›ç¨‹ BUG(); } å¾…è¡¥å……\n2.åˆ‡æ¢è¿›ç¨‹ context_switch 1ï¼‰switch_mm_irqs_offè´Ÿè´£åˆ‡æ¢è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ 2ï¼‰switch_toåˆ‡æ¢å¤„ç†å™¨çš„å¯„å­˜å™¨\n// linux-5.10.102/kernel/sched/core.c static __always_inline struct rq * context_switch(struct rq *rq, struct task_struct *prev, struct task_struct *next, struct rq_flags *rf) { prepare_task_switch(rq, prev, next); // å‡†å¤‡å·¥ä½œï¼Œè°ƒç”¨prepare_arch_switch /* For paravirt, this is coupled with an exit in switch_to to * combine the page table reload and the switch backend into * one hypercall. */ // å¼€å§‹ä¸Šä¸‹æ–‡åˆ‡æ¢ arch_start_context_switch(prev); /* * kernel -\u003e kernel lazy + transfer active * user -\u003e kernel lazy + mmgrab() active * * kernel -\u003e user switch + mmdrop() active * user -\u003e user switch */ if (!next-\u003emm) { // to kernel // é€šçŸ¥å¤„ç†å™¨æ¶æ„ä¸éœ€è¦åˆ‡æ¢ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ŒåŠ é€Ÿè¿›ç¨‹åˆ‡æ¢çš„æŠ€æœ¯ç§°ä¸ºæƒ°æ€§TLB enter_lazy_tlb(prev-\u003eactive_mm, next); next-\u003eactive_mm = prev-\u003eactive_mm; if (prev-\u003emm) // from user åˆ‡æ¢è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ mmgrab(prev-\u003eactive_mm); else prev-\u003eactive_mm = NULL; } else { // to user membarrier_switch_mm(rq, prev-\u003eactive_mm, next-\u003emm); /* * sys_membarrier() requires an smp_mb() between setting * rq-\u003ecurr / membarrier_switch_mm() and returning to userspace. * * The below provides this either through switch_mm(), or in * case 'prev-\u003eactive_mm == next-\u003emm' through * finish_task_switch()'s mmdrop(). */ switch_mm_irqs_off(prev-\u003eactive_mm, next-\u003emm, next); if (!prev-\u003emm) { // from kernel /* will mmdrop() in finish_task_switch(). */ rq-\u003eprev_mm = prev-\u003eactive_mm; prev-\u003eactive_mm = NULL; } } rq-\u003eclock_update_flags \u0026= ~(RQCF_ACT_SKIP|RQCF_REQ_SKIP); prepare_lock_switch(rq, next, rf); /* Here we just switch the register state and the stack. */ // åªåˆ‡æ¢å¯„å­˜å™¨çŠ¶æ€å’Œæ ˆ switch_to(prev, next, prev); barrier(); return finish_task_switch(prev); } ï¼ˆ1ï¼‰åˆ‡æ¢ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚\n// ARM64æ¶æ„ä½¿ç”¨switch_mm_irqs_off include/linux/mmu_context.h #ifndef switch_mm_irqs_off #define switch_mm_irqs_off switch_mm #endif switch_mmå‡½æ•°\n// linux-5.10.102/arch/arm64/include/asm/mmu_context.h static inline void switch_mm(struct mm_struct *prev, struct mm_struct *next, struct task_struct *tsk) { if (prev != next) __switch_mm(next); /* Update the saved TTBR0_EL1 of the scheduled-in task as the previous * value may have not been initialised yet (activate_mm caller) or the * ASID has changed since the last run (following the context switch * of another thread of the same process).*/ /* æ›´æ–°è°ƒå…¥è¿›ç¨‹ä¿å­˜çš„å¯„å­˜å™¨TTBR0_EL1å€¼ï¼Œ * å› ä¸ºå¯èƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼ˆè°ƒç”¨è€…æ˜¯å‡½æ•°activate_mmï¼‰ï¼Œ * æˆ–è€…ASIDè‡ªä»ä¸Šæ¬¡è¿è¡Œä»¥æ¥å·²ç»æ”¹å˜ï¼ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹ç»„çš„å¦ä¸€ä¸ªçº¿ç¨‹åˆ‡æ¢ä¸Šä¸‹æ–‡ä»¥åï¼‰ * é¿å…æŠŠä¿ç•™çš„å¯„å­˜å™¨TTBR0_EL1å€¼è®¾ç½®ä¸ºswapper_pg_dirï¼ˆinit_mmï¼›ä¾‹å¦‚é€šè¿‡å‡½æ•°idle_task_exitï¼‰*/ update_saved_ttbr0(tsk, next); } static inline void __switch_mm(struct mm_struct *next) { /*init_mm.pgd does not contain any user mappings and it is always * active for kernel addresses in TTBR1. Just set the reserved TTBR0.*/ /*init_mm.pgdæ²¡æœ‰åŒ…å«ä»»ä½•ç”¨æˆ·è™šæ‹Ÿåœ°å€çš„æ˜ å°„ï¼Œå¯¹äºTTBR1çš„å†…æ ¸è™šæ‹Ÿåœ°å€æ€»æ˜¯æœ‰æ•ˆçš„ã€‚ * åªè®¾ç½®ä¿ç•™çš„TTBR0 */ if (next == \u0026init_mm) { cpu_set_reserved_ttbr0(); return; } // ä¸ºè¿›ç¨‹åˆ†é…åœ°å€ç©ºé—´æ ‡è¯†ç¬¦ check_and_switch_context(next); } å¾…è¡¥å……\nï¼ˆ2ï¼‰åˆ‡æ¢å¯„å­˜å™¨\n// linux-5.10.102/include/asm-generic/switch_to.h #define switch_to(prev, next, last)\t\\ do {\t\\ ((last) = __switch_to((prev), (next)));\t\\ } while (0) å‡½æ•°__switch_to\n__notrace_funcgraph struct task_struct *__switch_to(struct task_struct *prev, struct task_struct *next) { struct task_struct *last; fpsimd_thread_switch(next); // åˆ‡æ¢æµ®ç‚¹å¯„å­˜å™¨ tls_thread_switch(next); // åˆ‡æ¢æœ¬åœ°å­˜å‚¨ç›¸å…³çš„å¯„å­˜å™¨ hw_breakpoint_thread_switch(next); // åˆ‡æ¢åŠäº‹å¯„å­˜å™¨ contextidr_thread_switch(next); // æŠŠä¸Šä¸‹æ–‡æ ‡è¯†ç¬¦å¯„å­˜å™¨CONTEXTIDR_EL1è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªè¿›ç¨‹å· entry_task_switch(next); // ä½¿ç”¨å¤„ç†å™¨å˜é‡__entry_taskè®°å½•ä¸‹ä¸€ä¸ªè¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ uao_thread_switch(next); // æ ¹æ®ä¸‹ä¸€ä¸ªè¿›ç¨‹å¯è®¿é—®çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šé™æ¢å¤ç”¨æˆ·è®¿é—®è¦†ç›–ï¼ˆUser Access Overrideï¼ŒUAOï¼‰çŠ¶æ€ ssbs_thread_switch(next); // erratum_1418040_thread_switch(next); /* Complete any pending TLB or cache maintenance on this CPU in case * the thread migrates to a different CPU. * This full barrier is also required by the membarrier system * call.*/ // åœ¨è¿™ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œå®Œå‰é¢çš„æ‰€æœ‰é¡µè¡¨ç¼“å­˜æˆ–è€…ç¼“å­˜ç»´æŠ¤æ“ä½œ // ä»¥é˜²çº¿ç¨‹è¿ç§»åˆ°å…¶ä»–å¤„ç†å™¨ // æ•°æ®åŒæ­¥å±éšœï¼Œç¡®ä¿å±éšœå‰é¢çš„ç¼“å­˜ç»´æŠ¤æ“ä½œå’Œé¡µè¡¨ç¼“å­˜ç»´æŠ¤æ“ä½œæ‰§è¡Œå®Œ dsb(ish); /* MTE thread switching must happen after the DSB above to ensure that * any asynchronous tag check faults have been logged in the TFSR*_EL1 * registers.*/ mte_thread_switch(next); /* the actual thread switch */ // å®é™…çº¿ç¨‹åˆ‡æ¢ åˆ‡æ¢é€šç”¨å¯„å­˜å™¨ last = cpu_switch_to(prev, next); return last; } 1ï¼‰åˆ‡æ¢æµ®ç‚¹å¯„å­˜å™¨ï¼Œå‡½æ•°fpsimd_thread_switchè´Ÿè´£åˆ‡æ¢æµ®ç‚¹ï¼Œå†…æ ¸ä¸å…è®¸ä½¿ç”¨æµ®ç‚¹æ•°ï¼Œåªæœ‰ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨æµ®ç‚¹æ•°,åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹æŠŠæµ®ç‚¹å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.fpsimd_stateä¸­ã€‚ARM64æ¶æ„å®ç°çš„linux-5.10.102/arch/arm64/kernel/fpsimd.cå‡½æ•°fpsimd_thread_switch \\ 2ï¼‰åˆ‡æ¢é€šç”¨å¯„å­˜å™¨ï¼Œ\nè¢«è°ƒç”¨å‡½æ•°è´Ÿè´£ä¿å­˜çš„å¯„å­˜å™¨x19ï½x28 å¯„å­˜å™¨x29ï¼Œå³å¸§æŒ‡é’ˆï¼ˆFrame Pointerï¼ŒFPï¼‰å¯„å­˜å™¨ æ ˆæŒ‡é’ˆï¼ˆStack Pointerï¼ŒSPï¼‰å¯„å­˜å™¨ å¯„å­˜å™¨x30ï¼Œå³é“¾æ¥å¯„å­˜å™¨ï¼ˆLink Registerï¼ŒLRï¼‰ï¼Œå®ƒå­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€ ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0ï¼Œå†…æ ¸ä½¿ç”¨å®ƒå­˜æ”¾å½“å‰è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„ç¬¬ä¸€ä¸ªæˆå‘˜thread_infoçš„åœ°å€ cpu_switch_toæœ‰ä¸¤ä¸ªå‚æ•°ï¼šå¯„å­˜å™¨x0å­˜æ”¾ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ï¼Œå¯„å­˜å™¨x1å­˜æ”¾ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€\n// linux-5.10.102/arch/arm64/kernel/entry.S SYM_FUNC_START(cpu_switch_to) mov\tx10, #THREAD_CPU_CONTEXT // cpu_switch_toæœ‰ä¸¤ä¸ªå‚æ•°ï¼šå¯„å­˜å™¨x0å­˜æ”¾ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ï¼Œå¯„å­˜å™¨x1å­˜æ”¾ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ add\tx8, x0, x10 // x8å­˜æ”¾ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextçš„åœ°å€ mov\tx9, sp // x9ä¿å­˜æ ˆæŒ‡é’ˆ stp\tx19, x20, [x8], #16\t// store callee-saved registers stp\tx21, x22, [x8], #16 // æŠŠä¸Šä¸€ä¸ªè¿›ç¨‹çš„å¯„å­˜å™¨x19ï½x28ã€x29ã€SPå’ŒLR stp\tx23, x24, [x8], #16 // ä¿å­˜åˆ°ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextä¸­ stp\tx25, x26, [x8], #16 // stp\tx27, x28, [x8], #16 stp\tx29, x9, [x8], #16 str\tlr, [x8] // LRå­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€ add\tx8, x1, x10 // x8å­˜æ”¾ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextçš„åœ°å€ ldp\tx19, x20, [x8], #16\t// restore callee-saved registers ldp\tx21, x22, [x8], #16 // ä½¿ç”¨ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context ldp\tx23, x24, [x8], #16 // ä¿å­˜çš„å€¼æ¢å¤ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„å¯„å­˜å™¨x19ï½x28ã€x29ã€SPå’ŒLR ldp\tx25, x26, [x8], #16 ldp\tx27, x28, [x8], #16 ldp\tx29, x9, [x8], #16 ldr\tlr, [x8] mov\tsp, x9 msr\tsp_el0, x1 // ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„ç¬¬ä¸€ä¸ªæˆå‘˜thread_infoçš„åœ°å€ ptrauth_keys_install_kernel x1, x8, x9, x10 scs_save x0, x8 // å‡½æ•°è¿”å›ï¼Œè¿”å›å€¼æ˜¯å¯„å­˜å™¨x0çš„å€¼ï¼šä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ scs_load x1, x8 ret SYM_FUNC_END(cpu_switch_to) NOKPROBE(cpu_switch_to) cpu_switch_toåˆ‡æ¢é€šç”¨å¯„å­˜å™¨çš„è¿‡ç¨‹ï¼Œä»è¿›ç¨‹prevåˆ‡æ¢åˆ°è¿›ç¨‹nextã€‚è¿›ç¨‹prevæŠŠé€šç”¨å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextä¸­ï¼Œç„¶åè¿›ç¨‹nextä»è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextæ¢å¤é€šç”¨å¯„å­˜å™¨çš„å€¼ï¼Œä½¿ç”¨ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0å­˜æ”¾è¿›ç¨‹nextçš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread_infoçš„åœ°å€ \\\nARM64æ¶æ„åˆ‡æ¢é€šç”¨å¯„å­˜å™¨ é“¾æ¥å¯„å­˜å™¨å­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå‡½æ•°cpu_switch_toæŠŠé“¾æ¥å¯„å­˜å™¨è®¾ç½®ä¸ºè¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context.pcï¼Œè¿›ç¨‹è¢«è°ƒåº¦åä»è¿”å›åœ°å€å¼€å§‹æ‰§è¡Œ è¿›ç¨‹çš„è¿”å›åœ°å€åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µ:\nåˆ›å»ºçš„æ–°è¿›ç¨‹ï¼Œå‡½æ•°copy_threadæŠŠè¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context.pcè®¾ç½®ä¸ºå‡½æ•°ret_from_forkçš„åœ°å€ å…¶ä»–æƒ…å†µï¼Œè¿”å›åœ°å€æ˜¯å‡½æ•°context_switchä¸­è°ƒç”¨å‡½æ•°cpu_switch_toä¹‹åçš„ä¸€è¡Œä»£ç ï¼šâ€œlast = å‡½æ•°cpu_switch_toçš„è¿”å›å€¼â€ï¼Œè¿”å›åœ°å€è®°å½•åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context.pcä¸­ ï¼ˆ3ï¼‰æ¸…ç†å·¥ä½œ å‡½æ•°finish_task_switchåœ¨ä»è¿›ç¨‹prevåˆ‡æ¢åˆ°è¿›ç¨‹nextåä¸ºè¿›ç¨‹prevæ‰§è¡Œæ¸…ç†å·¥ä½œ\n// kernel/sched/core.c static struct rq *finish_task_switch(struct task_struct *prev) __releases(rq-\u003elock) { struct rq *rq = this_rq(); // rqæ˜¯å½“å‰å¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ— struct mm_struct *mm = rq-\u003eprev_mm; long prev_state; /* The previous task will have left us with a preempt_count of 2 * because it left us after: *\tschedule() *\tpreempt_disable();\t// 1 *\t__schedule() *\traw_spin_lock_irq(\u0026rq-\u003elock)\t// 2 * Also, see FORK_PREEMPT_COUNT.*/ if (WARN_ONCE(preempt_count() != 2*PREEMPT_DISABLE_OFFSET, \"corrupted preempt_count: %s/%d/0x%x\\n\", current-\u003ecomm, current-\u003epid, preempt_count())) preempt_count_set(FORK_PREEMPT_COUNT); rq-\u003eprev_mm = NULL; /* A task struct has one reference for the use as \"current\". * If a task dies, then it sets TASK_DEAD in tsk-\u003estate and calls * schedule one last time. The schedule call will never return, and * the scheduled task must drop that reference. * * We must observe prev-\u003estate before clearing prev-\u003eon_cpu (in * finish_task), otherwise a concurrent wakeup can get prev * running on another CPU and we could rave with its RUNNING -\u003e DEAD * transition, resulting in a double drop.*/ prev_state = prev-\u003estate; vtime_task_switch(prev); // è®¡ç®—è¿›ç¨‹prevçš„æ—¶é—´ç»Ÿè®¡ perf_event_task_sched_in(prev, current); finish_task(prev); // æŠŠprev-\u003eon_cpuè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºè¿›ç¨‹prevæ²¡æœ‰åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œï¼›ç„¶åé‡Šæ”¾è¿è¡Œé˜Ÿåˆ—çš„é”ï¼Œå¼€å¯ç¡¬ä¸­æ–­ finish_lock_switch(rq); finish_arch_post_lock_switch(); // æ‰§è¡Œå¤„ç†å™¨æ¶æ„ç‰¹å®šçš„æ¸…ç†å·¥ä½œ,ARM64ä¸ºç©º kcov_finish_switch(current); fire_sched_in_preempt_notifiers(current); /* When switching through a kernel thread, the loop in * membarrier_{private,global}_expedited() may have observed that * kernel thread and not issued an IPI. It is therefore possible to * schedule between user-\u003ekernel-\u003euser threads without passing though * switch_mm(). Membarrier requires a barrier after storing to * rq-\u003ecurr, before returning to userspace, so provide them here: * * - a full memory barrier for {PRIVATE,GLOBAL}_EXPEDITED, implicitly * provided by mmdrop(), * - a sync_core for SYNC_CORE.*/ if (mm) { membarrier_mm_sync_core_before_usermode(mm); mmdrop(mm); } if (unlikely(prev_state == TASK_DEAD)) { // è¿›ç¨‹ä¸»åŠ¨é€€å‡ºæˆ–è€…è¢«ç»ˆæ­¢ if (prev-\u003esched_class-\u003etask_dead) prev-\u003esched_class-\u003etask_dead(prev); // æ‰€å±è°ƒåº¦ç±»çš„task_deadæ–¹æ³• /* * Remove function-return probe instances associated with this * task and put them back on the free list.*/ kprobe_flush_task(prev); /* Task is done with its stack. */ /*é‡Šæ”¾è¿›ç¨‹çš„å†…æ ¸æ ˆ */ put_task_stack(prev); // æŠŠè¿›ç¨‹æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œé‚£ä¹ˆé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦ put_task_struct_rcu_user(prev); } tick_nohz_task_switch(); return rq; } 2.8.7 è°ƒåº¦æ—¶æœº è°ƒåº¦è¿›ç¨‹çš„æ—¶æœº: ï¼ˆ1ï¼‰è¿›ç¨‹ä¸»åŠ¨è°ƒç”¨schedule()å‡½æ•° ï¼ˆ2ï¼‰å‘¨æœŸæ€§åœ°è°ƒåº¦ï¼ŒæŠ¢å å½“å‰è¿›ç¨‹ï¼Œå¼ºè¿«å½“å‰è¿›ç¨‹è®©å‡ºå¤„ç†å™¨ ï¼ˆ3ï¼‰å”¤é†’è¿›ç¨‹çš„æ—¶å€™ï¼Œè¢«å”¤é†’çš„è¿›ç¨‹å¯èƒ½æŠ¢å å½“å‰è¿›ç¨‹ ï¼ˆ4ï¼‰åˆ›å»ºæ–°è¿›ç¨‹çš„æ—¶å€™ï¼Œæ–°è¿›ç¨‹å¯èƒ½æŠ¢å å½“å‰è¿›ç¨‹ã€‚\n1.ä¸»åŠ¨è°ƒåº¦ å†…æ ¸ä¸­3ç§ä¸»åŠ¨è°ƒåº¦æ–¹å¼ï¼š ï¼ˆ1ï¼‰ç›´æ¥è°ƒç”¨schedule()å‡½æ•°æ¥è°ƒåº¦è¿›ç¨‹ ï¼ˆ2ï¼‰è°ƒç”¨æœ‰æ¡ä»¶é‡è°ƒåº¦å‡½æ•°cond_resched()ã€‚éæŠ¢å å¼å†…æ ¸ä¸­ï¼Œå‡½æ•°cond_resched()åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦è®¾ç½®äº†éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œå°±è°ƒåº¦è¿›ç¨‹ï¼›æŠ¢å å¼å†…æ ¸ä¸­ï¼Œcond_resched()ä¸ºç©º ï¼ˆ3ï¼‰å¦‚æœéœ€è¦ç­‰å¾…æŸä¸ªèµ„æºï¼Œä¾‹å¦‚äº’æ–¥é”æˆ–ä¿¡å·é‡ï¼Œé‚£ä¹ˆæŠŠè¿›ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸ºç¡çœ çŠ¶æ€ï¼Œç„¶åè°ƒç”¨schedule()å‡½æ•°ä»¥è°ƒåº¦è¿›ç¨‹\n2.å‘¨æœŸè°ƒåº¦ å‘¨æœŸè°ƒåº¦çš„å‡½æ•°æ˜¯scheduler_tick()ï¼Œå®ƒè°ƒç”¨å½“å‰è¿›ç¨‹æ‰€å±è°ƒåº¦ç±»çš„task_tickæ–¹æ³•ã€‚ ï¼ˆ1ï¼‰é™æœŸè°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦ task_tick â€“\u003e task_tick_dl â€“\u003e update_curr_dl\n// kernel/sched/deadline.c static void update_curr_dl(struct rq *rq) { struct task_struct *curr = rq-\u003ecurr; struct sched_dl_entity *dl_se = \u0026curr-\u003edl; u64 delta_exec, scaled_delta_exec; ... delta_exec = now - curr-\u003ese.exec_start; if (unlikely((s64)delta_exec \u003c= 0)) { if (unlikely(dl_se-\u003edl_yielded)) goto throttle; return; } ... dl_se-\u003eruntime -= scaled_delta_exec; // è®¡ç®—é™æœŸè¿›ç¨‹çš„å‰©ä½™è¿è¡Œæ—¶é—´ throttle: // // å¦‚æœé™æœŸè¿›ç¨‹ç”¨å®Œäº†è¿è¡Œæ—¶é—´æˆ–è€…ä¸»åŠ¨è®©å‡ºå¤„ç†å™¨ if (dl_runtime_exceeded(dl_se) || dl_se-\u003edl_yielded) { dl_se-\u003edl_throttled = 1; // è®¾ç½®èŠ‚æµæ ‡å¿— /* If requested, inform the user about runtime overruns. */ if (dl_runtime_exceeded(dl_se) \u0026\u0026 (dl_se-\u003eflags \u0026 SCHED_FLAG_DL_OVERRUN)) dl_se-\u003edl_overrun = 1; __dequeue_task_dl(rq, curr, 0); if (unlikely(is_dl_boosted(dl_se) || !start_dl_timer(curr))) enqueue_task_dl(rq, curr, ENQUEUE_REPLENISH); if (!is_leftmost(curr, \u0026rq-\u003edl)) resched_curr(rq); } ... } ï¼ˆ2ï¼‰å®æ—¶è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦ \\\nå®æ—¶è°ƒåº¦ç±»çš„task_tickæ–¹æ³•æ˜¯å‡½æ•°task_tick_rt\n// linux-5.10.102/kernel/sched/rt.c static void task_tick_rt(struct rq *rq, struct task_struct *p, int queued) { struct sched_rt_entity *rt_se = \u0026p-\u003ert; ... if (p-\u003epolicy != SCHED_RR) // è°ƒåº¦ç­–ç•¥ä¸æ˜¯è½®æµè°ƒåº¦ return; // æŠŠæ—¶é—´ç‰‡å‡ä¸€ï¼Œå¦‚æœæ²¡ç”¨å®Œæ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆè¿”å› if (--p-\u003ert.time_slice) return; // ç”¨å®Œäº†æ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆé‡æ–°åˆ†é…æ—¶é—´ç‰‡ p-\u003ert.time_slice = sched_rr_timeslice; /* Requeue to the end of queue if we (and all of our ancestors) are not * the only element on the queue */ for_each_sched_rt_entity(rt_se) { if (rt_se-\u003erun_list.prev != rt_se-\u003erun_list.next) { requeue_task_rt(rq, p, 0); resched_curr(rq); return; } } } ï¼ˆ3ï¼‰å…¬å¹³è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦ å…¬å¹³è°ƒåº¦ç±»çš„task_tickæ–¹æ³•æ˜¯å‡½æ•°task_tick_fair\n// kernel/sched/fair.c static void task_tick_fair(struct rq *rq, struct task_struct *curr, int queued) { struct cfs_rq *cfs_rq; struct sched_entity *se = \u0026curr-\u003ese; for_each_sched_entity(se) { cfs_rq = cfs_rq_of(se); entity_tick(cfs_rq, se, queued); } ... } // kernel/sched/fair.c static void entity_tick(struct cfs_rq *cfs_rq, struct sched_entity *curr, int queued) { ... if (cfs_rq-\u003enr_running \u003e 1) // å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹æ•°é‡è¶…è¿‡1 check_preempt_tick(cfs_rq, curr); } // kernel/sched/fair.c static void check_preempt_tick(struct cfs_rq *cfs_rq, struct sched_entity *curr) { unsigned long ideal_runtime, delta_exec; struct sched_entity *se; s64 delta; ideal_runtime = sched_slice(cfs_rq, curr); delta_exec = curr-\u003esum_exec_runtime - curr-\u003eprev_sum_exec_runtime; if (delta_exec \u003e ideal_runtime) { resched_curr(rq_of(cfs_rq)); /* The current task ran long enough, ensure it doesn't get * re-elected due to buddy favours.*/ clear_buddies(cfs_rq, curr); return; } /* Ensure that a task that missed wakeup preemption by a * narrow margin doesn't have to wait for a full slice. * This also mitigates buddy induced latencies under load.*/ if (delta_exec \u003c sysctl_sched_min_granularity) return; se = __pick_first_entity(cfs_rq); delta = curr-\u003evruntime - se-\u003evruntime; if (delta \u003c 0) return; if (delta \u003e ideal_runtime) resched_curr(rq_of(cfs_rq)); } ï¼ˆ4ï¼‰ä¸­æ–­è¿”å›æ—¶è°ƒåº¦ã€‚ ARM64æ¶æ„çš„ä¸­æ–­å¤„ç†ç¨‹åºçš„å…¥å£æ˜¯e10_irqï¼Œä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œå®Œä»¥åï¼Œè·³è½¬åˆ°æ ‡å·ret_to_userä»¥è¿”å›ç”¨æˆ·æ¨¡å¼ã€‚æ ‡å·ret_to_useråˆ¤æ–­å½“å‰è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread_info.flagsæœ‰æ²¡æœ‰è®¾ç½®æ ‡å¿—ä½é›†åˆ_TIF_WORK_MASKä¸­çš„ä»»ä½•ä¸€ä¸ªæ ‡å¿—ä½ï¼Œå¦‚æœè®¾ç½®äº†å…¶ä¸­ä¸€ä¸ªæ ‡å¿—ä½ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ ‡å·work_pendingï¼Œæ ‡å·work_pendingè°ƒç”¨å‡½æ•°do_notify_resume\n// arch/arm64/kernel/entry.S 5.10.102 ä»£ç ä¸­æ²¡æœ‰ï¼Ÿ ret_to_user: disable_irq // ç¦æ­¢ä¸­æ–­ ldr x1, [tsk, #TSK_TI_FLAGS] and x2, x1, #_TIF_WORK_MASK cbnz x2, work_pending finish_ret_to_user: enable_step_tsk x1, x2 kernel_exit 0 ENDPROC(ret_to_user) work_pending: mov x0, sp /* * å¯„å­˜å™¨x0å­˜æ”¾ç¬¬ä¸€ä¸ªå‚æ•°regs * å¯„å­˜å™¨x1å­˜æ”¾ç¬¬äºŒä¸ªå‚æ•°task_struct.thread_info.flags */ bl do_notify_resume #ifdef CONFIG_TRACE_IRQFLAGS bl trace_hardirqs_on // åœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œæ—¶å¼€å¯ä¸­æ–­ #endif ldr x1, [tsk, #TSK_TI_FLAGS] // é‡æ–°æ£€æŸ¥å•æ­¥æ‰§è¡Œ b finish_ret_to_user å‡½æ•°do_notify_resumeåˆ¤æ–­å½“å‰è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread_info.flagsæœ‰æ²¡æœ‰è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—ä½_TIF_NEED_RESCHEDï¼Œå¦‚æœè®¾ç½®äº†ï¼Œé‚£ä¹ˆè°ƒç”¨å‡½æ•°schedule()ä»¥è°ƒåº¦è¿›ç¨‹ã€‚\n// arch/arm64/kernel/signal.c asmlinkage void do_notify_resume(struct pt_regs *regs, unsigned int thread_flags) { ... do { if (thread_flags \u0026 _TIF_NEED_RESCHED) { schedule(); } else { â€¦ } local_irq_disable(); thread_flags = READ_ONCE(current_thread_info()-\u003eflags); } while (thread_flags \u0026 _TIF_WORK_MASK); } 3.å”¤é†’è¿›ç¨‹æ—¶æŠ¢å  å”¤é†’è¿›ç¨‹çš„æ—¶å€™ï¼Œè¢«å”¤é†’çš„è¿›ç¨‹å¯èƒ½æŠ¢å å½“å‰è¿›ç¨‹\nå”¤é†’è¿›ç¨‹æ—¶æŠ¢å  ï¼ˆ1ï¼‰å¦‚æœè¢«å”¤é†’çš„è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºç›¸åŒçš„è°ƒåº¦ç±»ï¼Œé‚£ä¹ˆè°ƒç”¨è°ƒåº¦ç±»çš„check_preempt_curræ–¹æ³•ä»¥æ£€æŸ¥æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿›ç¨‹ ï¼ˆ2ï¼‰å¦‚æœè¢«å”¤é†’çš„è¿›ç¨‹æ‰€å±è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§é«˜äºå½“å‰è¿›ç¨‹æ‰€å±è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—\nè°ƒåº¦ç±» check_preempt_curræ–¹æ³•æ˜¯å‡½æ•° ç®—æ³• åœæœºè°ƒåº¦ç±» check_preempt_curr_stop ç©ºå‡½æ•° é™æœŸè°ƒåº¦ç±» check_preempt_curr_dl å¦‚æœè¢«å”¤é†’çš„è¿›ç¨‹çš„ç»å¯¹æˆªæ­¢æœŸé™æ¯”å½“å‰è¿›ç¨‹çš„ç»å¯¹æˆªæ­¢æœŸé™å°ï¼Œé‚£ä¹ˆç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿— å®æ—¶è°ƒåº¦ç±» check_preempt_curr_rt ä¼˜å…ˆçº§æ¯”å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§é«˜ï¼Œé‚£ä¹ˆç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿— å…¬å¹³è°ƒåº¦ç±» check_preempt_wakeup ç©ºé—²è°ƒåº¦ç±» check_preempt_curr_idle æ— æ¡ä»¶æŠ¢å ï¼Œç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿— check_preempt_wakeupå‡½æ•°\n// linux-5.10.102/kernel/sched/fair.c static void check_preempt_wakeup(struct rq *rq, struct task_struct *p, int wake_flags) { // å½“å‰è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯SCHED_IDLEï¼Œè¢«å”¤é†’çš„è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯SCHED_NORMALæˆ–è€…SCHED_BATCHï¼Œé‚£ä¹ˆå…è®¸æŠ¢å ï¼Œç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿— struct task_struct *curr = rq-\u003ecurr; struct sched_entity *se = \u0026curr-\u003ese, *pse = \u0026p-\u003ese; ... if (unlikely(task_has_idle_policy(curr)) \u0026\u0026 likely(!task_has_idle_policy(p))) goto preempt; if (unlikely(p-\u003epolicy != SCHED_NORMAL) || !sched_feat(WAKEUP_PREEMPTION)) return; // ä¸ºå½“å‰è¿›ç¨‹å’Œè¢«å”¤é†’çš„è¿›ç¨‹æ‰¾åˆ°ä¸¤ä¸ªå…„å¼Ÿè°ƒåº¦å®ä½“ find_matching_se(\u0026se, \u0026pse); update_curr(cfs_rq_of(se)); BUG_ON(!pse); if (wakeup_preempt_entity(se, pse) == 1) { // åˆ¤æ–­æ˜¯å¦å¯ä»¥æŠ¢å  // å…è®¸æŠ¢å ï¼Œç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿— ... goto preempt; } return; preempt: resched_curr(rq); ... } static int wakeup_preempt_entity(struct sched_entity *curr, struct sched_entity *se) { s64 gran, vdiff = curr-\u003evruntime - se-\u003evruntime; if (vdiff \u003c= 0) return -1; gran = wakeup_gran(se); if (vdiff \u003e gran) return 1; return 0; } 4.åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŠ¢å  ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨forkã€cloneå’Œ vforkåˆ›å»ºæ–°è¿›ç¨‹ä½¿ï¼Œæ–°è¿›ç¨‹å¯æŠ¢å å½“å‰è¿›ç¨‹ï¼›ä½¿ç”¨éŸ©å¼kernel_threadåˆ›å»ºæ–°çš„å†…æ ¸çº¿ç¨‹æ˜¯ï¼Œæ–°å†…æ ¸çº¿ç¨‹å¯æŠ¢å å½“å‰è¿›ç¨‹ 5.å†…æ ¸æŠ¢å  å†…æ ¸æŠ¢å æ˜¯æŒ‡å½“è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„æ—¶å€™å¯ä»¥è¢«å…¶ä»–è¿›ç¨‹æŠ¢å ï¼Œéœ€è¦æ‰“å¼€é…ç½®å®CONFIG_PREEMPTã€‚æŠ¢å å¼å†…æ ¸å’ŒéæŠ¢å å¼å†…æ ¸ã€‚è¿›ç¨‹tthread_infoç»“æ„ä½“ä¸€ä¸ªç±»å‹ä¸ºintçš„æˆå‘˜preempt_countä¸ºæŠ¢å è®¡æ•°å™¨ã€‚\nå¾…è¡¥å……\n6.é«˜ç²¾åº¦è°ƒåº¦æ—¶é’Ÿ é«˜ç²¾åº¦æ—¶é’Ÿçš„ç²¾åº¦æ˜¯çº³ç§’,éœ€è¦é€šè¿‡é…ç½®å®å¯ç”¨ã€‚\n2.8.8 å¸¦å®½ç®¡ç† è°ƒåº¦ç±»ç®¡ç†è¿›ç¨‹å ç”¨çš„å¤„ç†å™¨å¸¦å®½çš„æ–¹æ³•\n1.é™æœŸè°ƒåº¦ç±»çš„å¸¦æ¡†ç®¡ç† æ¯ä¸ªé™æœŸè¿›ç¨‹æœ‰è‡ªå·±çš„å¸¦å®½ï¼Œå†…æ ¸æŠŠé™æœŸè¿›ç¨‹çš„è¿è¡Œæ—¶é—´ç»Ÿè®¡åˆ°æ ¹å®æ—¶ä»»åŠ¡ç»„çš„è¿è¡Œæ—¶é—´é‡Œé¢äº†ï¼Œé™æœŸè¿›ç¨‹å…±äº«å®æ—¶è¿›ç¨‹çš„å¸¦å®½\n// kernel/sched/deadline.c static void update_curr_dl(struct rq *rq) { â€¦ if (rt_bandwidth_enabled()) { struct rt_rq *rt_rq = \u0026rq-\u003ert; raw_spin_lock(\u0026rt_rq-\u003ert_runtime_lock); if (sched_rt_bandwidth_account(rt_rq)) rt_rq-\u003ert_time += delta_exec; raw_spin_unlock(\u0026rt_rq-\u003ert_runtime_lock); } } 2.å®æ—¶è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç† æŒ‡å®šå®æ—¶è¿›ç¨‹çš„å¸¦å®½æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ ï¼ˆ1ï¼‰æŒ‡å®šå…¨å±€å¸¦å®½ï¼šå¸¦å®½åŒ…å«çš„ä¸¤ä¸ªå‚æ•°æ˜¯å‘¨æœŸå’Œè¿è¡Œæ—¶é—´ï¼Œå³æŒ‡å®šåœ¨æ¯ä¸ªå‘¨æœŸå†…æ‰€æœ‰å®æ—¶è¿›ç¨‹çš„è¿è¡Œæ—¶é—´æ€»å’Œã€‚ é»˜è®¤çš„å‘¨æœŸæ˜¯1ç§’ï¼Œé»˜è®¤çš„è¿è¡Œæ—¶é—´æ˜¯0.95ç§’ã€‚å¯ä»¥å€ŸåŠ©æ–‡ä»¶â€œ/proc/sys/kernel/sched_rt_period_usâ€è®¾ç½®å‘¨æœŸï¼Œå€ŸåŠ©æ–‡ä»¶â€œ/proc/sys/kernel/sched_rt_runtime_usâ€è®¾ç½®è¿è¡Œæ—¶é—´ é…ç½®å®CONFIG_RT_GROUP_SCHEDï¼Œå³æ”¯æŒå®æ—¶ä»»åŠ¡ç»„ï¼Œé‚£ä¹ˆå…¨å±€å¸¦å®½æŒ‡å®šäº†æ‰€æœ‰å®æ—¶ä»»åŠ¡ç»„çš„æ€»å¸¦å®½ ï¼ˆ2ï¼‰æŒ‡å®šæ¯ä¸ªå®æ—¶ä»»åŠ¡ç»„çš„å¸¦å®½ï¼šåœ¨æ¯ä¸ªæŒ‡å®šçš„å‘¨æœŸï¼Œå…è®¸ä¸€ä¸ªå®æ—¶ä»»åŠ¡ç»„æœ€å¤šæ‰§è¡Œé•¿æ—¶é—´ã€‚å½“å®æ—¶ä»»åŠ¡ç»„åœ¨ä¸€ä¸ªå‘¨æœŸç”¨å®Œäº†å¸¦å®½æ—¶ï¼Œè¿™ä¸ªä»»åŠ¡ç»„å°†ä¼šè¢«èŠ‚æµï¼Œä¸å…è®¸ç»§ç»­è¿è¡Œï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸã€‚å¯ä»¥ä½¿ç”¨cgroupè®¾ç½®ä¸€ä¸ªå®æ—¶ä»»åŠ¡ç»„çš„å‘¨æœŸå’Œè¿è¡Œæ—¶é—´ï¼Œcgroupç‰ˆæœ¬1çš„é…ç½®æ–¹æ³•å¦‚ä¸‹\ncgroupç‰ˆæœ¬1çš„é…ç½®æ–¹æ³• 1ï¼‰cpu.rt_period_usï¼šå‘¨æœŸï¼Œé»˜è®¤å€¼æ˜¯1ç§’ã€‚ 2ï¼‰cpu.rt_runtime_usï¼šè¿è¡Œæ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯0ï¼ŒæŠŠè¿è¡Œæ—¶é—´è®¾ç½®ä¸ºéé›¶å€¼ä»¥åæ‰å…è®¸æŠŠå®æ—¶è¿›ç¨‹åŠ å…¥ä»»åŠ¡ç»„ï¼Œè®¾ç½®ä¸ºâˆ’1è¡¨ç¤ºæ²¡æœ‰å¸¦å®½é™åˆ¶ã€‚ cgroupç‰ˆæœ¬1çš„é…ç½®ç¤ºä¾‹å¦‚ä¸‹ã€‚ 1ï¼‰æŒ‚è½½cgroupæ–‡ä»¶ç³»ç»Ÿï¼ŒæŠŠCPUæ§åˆ¶å™¨å…³è”åˆ°æ§åˆ¶ç»„å±‚çº§æ ‘ã€‚ mount -t cgroup -o cpu none /sys/fs/cgroup/cpu 2ï¼‰åˆ›å»ºä¸€ä¸ªä»»åŠ¡ç»„ã€‚ cd /sys/fs/cgroup/cpu mkdir browser # åˆ›å»º\"browser\"ä»»åŠ¡ç»„ 3ï¼‰æŠŠå®æ—¶è¿è¡Œæ—¶é—´è®¾ç½®ä¸º10æ¯«ç§’ã€‚ echo 10000 \u003e browser/cpu.rt_runtime_us 4ï¼‰æŠŠä¸€ä¸ªå®æ—¶è¿›ç¨‹åŠ å…¥ä»»åŠ¡ç»„ã€‚ echo \u003e browser/cgroup.procs cgroupç‰ˆæœ¬2ä»å†…æ ¸4.15ç‰ˆæœ¬å¼€å§‹æ”¯æŒCPUæ§åˆ¶å™¨ï¼Œæš‚æ—¶ä¸æ”¯æŒå®æ—¶è¿›ç¨‹ã€‚\nä¸€ä¸ªå¤„ç†å™¨ç”¨å®Œäº†å®æ—¶è¿è¡Œæ—¶é—´ï¼Œå¯ä»¥ä»å…¶ä»–å¤„ç†å™¨å€Ÿç”¨å®æ—¶è¿è¡Œæ—¶é—´ï¼Œç§°ä¸ºå®æ—¶è¿è¡Œæ—¶é—´å…±äº«ï¼Œå¯¹åº”è°ƒåº¦ç‰¹æ€§RT_RUNTIME_SHAREï¼Œé»˜è®¤å¼€å¯ã€‚\nkernel/sched/features.h SCHED_FEAT(RT_RUNTIME_SHARE, true) å®æ—¶ä»»åŠ¡ç»„çš„å¸¦å®½å­˜æ”¾åœ¨ç»“æ„ä½“task_groupçš„æˆå‘˜rt_bandwidthä¸­ï¼š\n// kernel/sched/sched.h struct task_group { â€¦ #ifdef CONFIG_RT_GROUP_SCHED â€¦ struct rt_bandwidth rt_bandwidth; #endif â€¦ }; èŠ‚æµ\nä¹¦ä¸­è¯¦ç»†è§£é‡Š\n3.å…¬å¹³è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç† ä½¿ç”¨å‘¨æœŸå’Œé™é¢æŒ‡å®šä¸€ä¸ªå…¬å¹³ä»»åŠ¡ç»„çš„å¸¦å®½ ä½¿ç”¨cgroupè®¾ç½®ä¸€ä¸ªå…¬å¹³ä»»åŠ¡ç»„çš„å‘¨æœŸå’Œé™é¢ï¼Œcgroupç‰ˆæœ¬1çš„é…ç½® \\\ncgroupç‰ˆæœ¬1çš„é…ç½®æ–¹æ³• cgroupç‰ˆæœ¬2çš„é…ç½®ç¤ºä¾‹ \\ cgroupç‰ˆæœ¬2çš„é…ç½®æ–¹æ³• ï¼ˆ1ï¼‰èŠ‚æµï¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ï¼Œè°ƒåº¦å™¨ä¼šæ£€æŸ¥å…¬å¹³è¿è¡Œé˜Ÿåˆ—æ˜¯å¦ç”¨å®Œè¿è¡Œæ—¶é—´ã€‚ 1ï¼‰put_prev_task_fairï¼šè°ƒåº¦å™¨æŠŠå½“å‰æ­£åœ¨è¿è¡Œçš„æ™®é€šè¿›ç¨‹æ”¾å›å…¬å¹³è¿è¡Œé˜Ÿåˆ—ã€‚ 2ï¼‰pick_next_task_fairï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å±äºå…¬å¹³è°ƒåº¦ç±»ï¼Œè°ƒåº¦å™¨é€‰æ‹©ä¸‹ä¸€ä¸ªæ™®é€šè¿›ç¨‹ã€‚\nï¼ˆ2ï¼‰å‘¨æœŸå®šæ—¶å™¨ï¼šåœ¨æ¯ä¸ªå‘¨æœŸçš„å¼€å§‹ï¼Œé‡æ–°å¡«å……ä»»åŠ¡ç»„çš„å¸¦å®½ï¼ŒæŠŠå¸¦å®½åˆ†é…ç»™èŠ‚æµçš„å…¬å¹³è¿è¡Œé˜Ÿåˆ—ã€‚å‘¨æœŸå®šæ—¶å™¨çš„å¤„ç†å‡½æ•°æ˜¯sched_cfs_period_timerï¼Œå®ƒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°do_sched_cfs_period_timer\n// kernel/sched/fair.c static int do_sched_cfs_period_timer(struct cfs_bandwidth *cfs_b, int overrun) { â€¦ throttled = !list_empty(\u0026cfs_b-\u003ethrottled_cfs_rq); â€¦ __refill_cfs_bandwidth_runtime(cfs_b); // æ–°å¡«å……ä»»åŠ¡ç»„çš„å¸¦å®½ if (!throttled) { cfs_b-\u003eidle = 1; return 0; } â€¦ while (throttled \u0026\u0026 cfs_b-\u003eruntime \u003e 0) { runtime = cfs_b-\u003eruntime; raw_spin_unlock(\u0026cfs_b-\u003elock); // æŠŠä»»åŠ¡ç»„çš„å¯ç”¨è¿è¡Œæ—¶é—´åˆ†é…ç»™èŠ‚æµçš„å…¬å¹³è¿è¡Œé˜Ÿåˆ— runtime = distribute_cfs_runtime(cfs_b, runtime, runtime_expires); raw_spin_lock(\u0026cfs_b-\u003elock); throttled = !list_empty(\u0026cfs_b-\u003ethrottled_cfs_rq); cfs_b-\u003eruntime -= min(runtime, cfs_b-\u003eruntime); } â€¦ } å‡½æ•°__refill_cfs_bandwidth_runtimeè´Ÿè´£é‡æ–°å¡«å……ä»»åŠ¡ç»„çš„å¸¦å®½ï¼šâ€œæŠŠå¯ç”¨è¿è¡Œæ—¶é—´è®¾ç½®æˆé™é¢ï¼ŒæŠŠè¿è¡Œæ—¶é—´çš„åˆ°æœŸæ—¶é—´è®¾ç½®æˆå½“å‰æ—¶é—´åŠ ä¸Š1ä¸ªå‘¨æœŸâ€\n// kernel/sched/fair.c void __refill_cfs_bandwidth_runtime(struct cfs_bandwidth *cfs_b) { u64 now; if (cfs_b-\u003equota == RUNTIME_INF) return; now = sched_clock_cpu(smp_processor_id()); cfs_b-\u003eruntime = cfs_b-\u003equota; cfs_b-\u003eruntime_expires = now + ktime_to_ns(cfs_b-\u003eperiod); } å‡½æ•°distribute_cfs_runtimeè´Ÿè´£æŠŠä»»åŠ¡ç»„çš„å¯ç”¨è¿è¡Œæ—¶é—´åˆ†é…ç»™èŠ‚æµçš„å…¬å¹³è¿è¡Œé˜Ÿåˆ—\nstatic void distribute_cfs_runtime(struct cfs_bandwidth *cfs_b) { struct cfs_rq *cfs_rq; u64 runtime, remaining = 1; rcu_read_lock(); list_for_each_entry_rcu(cfs_rq, \u0026cfs_b-\u003ethrottled_cfs_rq, throttled_list) { struct rq *rq = rq_of(cfs_rq); struct rq_flags rf; rq_lock_irqsave(rq, \u0026rf); if (!cfs_rq_throttled(cfs_rq)) goto next; /* By the above check, this should never be true */ SCHED_WARN_ON(cfs_rq-\u003eruntime_remaining \u003e 0); raw_spin_lock(\u0026cfs_b-\u003elock); /* cfs_rq-\u003eruntime_remainingæ˜¯å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„å‰©ä½™è¿è¡Œæ—¶é—´ */ runtime = -cfs_rq-\u003eruntime_remaining + 1; if (runtime \u003e cfs_b-\u003eruntime) runtime = cfs_b-\u003eruntime; cfs_b-\u003eruntime -= runtime; remaining = cfs_b-\u003eruntime; raw_spin_unlock(\u0026cfs_b-\u003elock); cfs_rq-\u003eruntime_remaining += runtime; /* we check whether we're throttled above */ /* ä¸Šé¢æ£€æŸ¥è¿‡æ˜¯å¦è¢«èŠ‚æµ */ if (cfs_rq-\u003eruntime_remaining \u003e 0) unthrottle_cfs_rq(cfs_rq); next: rq_unlock_irqrestore(rq, \u0026rf); if (!remaining) break; } rcu_read_unlock(); } ï¼ˆ3ï¼‰å–æœ‰ä½™è¡¥ä¸è¶³ï¼š\n2.9 SMPè°ƒåº¦ SMPç³»ç»Ÿè¿›ç¨‹è°ƒåº¦å™¨ç‰¹æ€§: ï¼ˆ1ï¼‰ä½¿æ¯ä¸ªå¤„ç†å™¨è´Ÿè½½å°½å¯èƒ½å‡è¡¡ ï¼ˆ2ï¼‰è®¾ç½®è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§(affinity)ï¼Œå³å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šæ‰§è¡Œ ï¼ˆ3ï¼‰è¿›ç¨‹ä»ä¸€ä¸ªå¤„ç†å™¨è¿ç§»åˆ°å¦ä¸€ä¸ªå¤„ç†å™¨\n2.9.1 è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§ è¿›ç¨‹æè¿°ç¬¦å¢åŠ ä¸¤ä¸ªæˆå‘˜\n// include/linux/sched.h struct task_struct { â€¦ int nr_cpus_allowed; // ä¿å­˜å…è®¸çš„å¤„ç†å™¨æ©ç  cpumask_t cpus_allowed;\t// ä¿å­˜å…è®¸çš„å¤„ç†å™¨æ•°é‡ â€¦ }; 1.åº”ç”¨ç¼–ç¨‹æ¥å£ å†…æ ¸ç³»ç»Ÿè°ƒç”¨\n// sched_setaffinityç”¨æ¥è®¾ç½®è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§æ©ç  int sched_setaffinity(pid_t pid, size_t cpusetsize, cpu_set_t *mask); // sched_getaffinityç”¨æ¥è·å–è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§æ©ç  int sched_getaffinity(pid_t pid, size_t cpusetsize, cpu_set_t *mask); å†…æ ¸çº¿ç¨‹å‡½æ•°è®¾ç½®å¤„ç†å™¨äº²å’Œæ€§æ©ç \n// kthread_bindç”¨æ¥æŠŠä¸€ä¸ªåˆšåˆšåˆ›å»ºçš„å†…æ ¸çº¿ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªå¤„ç†å™¨ void kthread_bind(struct task_struct *p, unsigned int cpu); // set_cpus_allowed_ptrç”¨æ¥è®¾ç½®å†…æ ¸çº¿ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§æ©ç  int set_cpus_allowed_ptr(struct task_struct *p, const struct cpumask *new_mask); 2.ä½¿ç”¨cpuseté…ç½® cpusetåœ¨å•ç‹¬ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨cpusetä¼ªæ–‡ä»¶ç³»ç»Ÿé…ç½®ï¼Œé…ç½®æ–¹æ³•\n2.9.2 å¯¹è°ƒåº¦å™¨çš„æ‰©å±• SMPç³»ç»Ÿä¸Šï¼Œè°ƒåº¦ç±»å¢åŠ æ–¹æ³•\n// kernel/sched/sched.h struct sched_class { â€¦ #ifdef CONFIG_SMP // ä¸ºè¿›ç¨‹é€‰æ‹©è¿è¡Œé˜Ÿåˆ— int (*select_task_rq)(struct task_struct *p, int task_cpu, int sd_flag, int flags); // åœ¨è¿›ç¨‹è¢«è¿ç§»åˆ°æ–°çš„å¤„ç†å™¨ä¹‹å‰è°ƒç”¨ void (*migrate_task_rq)(struct task_struct *p); // ç”¨æ¥åœ¨è¿›ç¨‹è¢«å”¤é†’ä»¥åè°ƒç”¨ void (*task_woken) (struct rq *this_rq, struct task_struct *task); // è®¾ç½®å¤„ç†å™¨äº²å’Œæ€§çš„æ—¶å€™æ‰§è¡Œè°ƒåº¦ç±»çš„ç‰¹æ®Šå¤„ç† void (*set_cpus_allowed)(struct task_struct *p, const struct cpumask *newmask); #endif â€¦ }; è¿›ç¨‹åœ¨å†…å­˜å’Œç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€å°‘çš„ï¼Œæ˜¯æœ‰ä»·å€¼çš„å®ç°è´Ÿè½½å‡è¡¡çš„æœºä¼šï¼š1ï¼‰åˆ›å»ºæ–°è¿›ç¨‹ï¼Œ2ï¼‰è°ƒç”¨execveè£…è½½ç¨‹åº\nåˆ›å»ºæ–°è¿›ç¨‹æ—¶è´Ÿè½½å‡è¡¡ è£…è½½ç¨‹åºæ—¶è´Ÿè½½å‡è¡¡ 2.9.3 é™æœŸè°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡ 2.9.4 å®æ—¶è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡ 2.9.5 å…¬å¹³è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡ 2.9.6 è¿ç§»çº¿ç¨‹ æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè¿ç§»çº¿ç¨‹ï¼Œçº¿ç¨‹åç§°æ˜¯â€œmigration/â€ï¼Œå±äºåœæœºè°ƒåº¦ç±»ï¼Œå¯ä»¥æŠ¢å æ‰€æœ‰å…¶ä»–è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹ä¸å¯ä»¥æŠ¢å å®ƒã€‚è¿ç§»çº¿ç¨‹æœ‰ä¸¤ä¸ªä½œç”¨ ï¼ˆ1ï¼‰è°ƒåº¦å™¨å‘å‡ºè¿ç§»è¯·æ±‚ï¼Œè¿ç§»çº¿ç¨‹å¤„ç†è¿ç§»è¯·æ±‚ï¼ŒæŠŠè¿›ç¨‹è¿ç§»åˆ°ç›®æ ‡å¤„ç†å™¨ã€‚ ï¼ˆ2ï¼‰æ‰§è¡Œä¸»åŠ¨è´Ÿè½½å‡è¡¡ã€‚\n2.9.7 éš”ç¦»å¤„ç†å™¨ 2.10 è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®‰å…¨ ç¬¬3ç«  å†…å­˜ç®¡ç† 3.1 å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¶æ„ ç”¨æˆ·ç©ºé—´ã€å†…æ ¸ç©ºé—´å’Œç¡¬ä»¶3ä¸ªå±‚é¢ 1.ç”¨æˆ·ç©ºé—´ åº”ç”¨ç¨‹åºä½¿ç”¨malloc()ç”³è¯·å†…å­˜ï¼Œä½¿ç”¨free()é‡Šæ”¾å†…å­˜ã€‚ malloc()å’Œfree()æ˜¯glibcåº“çš„å†…å­˜åˆ†é…å™¨ptmallocæä¾›çš„æ¥å£ï¼Œptmallocä½¿ç”¨ç³»ç»Ÿè°ƒç”¨brkæˆ–mmapå‘å†…æ ¸ä»¥é¡µä¸ºå•ä½ç”³è¯·å†…å­˜ï¼Œç„¶ååˆ’åˆ†æˆå°å†…å­˜å—åˆ†é…ç»™åº”ç”¨ç¨‹åº ç”¨æˆ·ç©ºé—´çš„å†…å­˜åˆ†é…å™¨ï¼Œé™¤äº†glibcåº“çš„ptmallocï¼Œè¿˜æœ‰è°·æ­Œçš„tcmallocå’ŒFreeBSDçš„jemalloc\n2.å†…æ ¸ç©ºé—´ ï¼ˆ1ï¼‰å†…æ ¸ç©ºé—´çš„åŸºæœ¬åŠŸèƒ½ è™šæ‹Ÿå†…å­˜ç®¡ç†è´Ÿè´£ä»è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†é…è™šæ‹Ÿé¡µï¼Œsys_brkç”¨æ¥æ‰©å¤§æˆ–æ”¶ç¼©å †ï¼Œsys_mmapç”¨æ¥åœ¨å†…å­˜æ˜ å°„åŒºåŸŸåˆ†é…è™šæ‹Ÿé¡µï¼Œsys_munmapç”¨æ¥é‡Šæ”¾è™šæ‹Ÿé¡µ å†…æ ¸ä½¿ç”¨å»¶è¿Ÿåˆ†é…ç‰©ç†å†…å­˜çš„ç­–ç•¥ï¼Œè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿé¡µçš„æ—¶å€™ï¼Œè§¦å‘é¡µé”™è¯¯å¼‚å¸¸ï¼Œé¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºä»é¡µåˆ†é…å™¨ç”³è¯·ç‰©ç†é¡µï¼Œåœ¨è¿›ç¨‹çš„é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ é¡µåˆ†é…å™¨è´Ÿè´£åˆ†é…ç‰©ç†é¡µï¼Œå½“å‰ä½¿ç”¨çš„é¡µåˆ†é…å™¨æ˜¯ä¼™ä¼´åˆ†é…å™¨ã€‚ å†…æ ¸ç©ºé—´æä¾›äº†æŠŠé¡µåˆ’åˆ†æˆå°å†…å­˜å—åˆ†é…çš„å—åˆ†é…å™¨ï¼Œæä¾›åˆ†é…å†…å­˜çš„æ¥å£kmalloc()å’Œé‡Šæ”¾å†…å­˜çš„æ¥å£kfree()ï¼Œæ”¯æŒ3ç§å—åˆ†é…å™¨ï¼šSLABåˆ†é…å™¨ã€SLUBåˆ†é…å™¨å’ŒSLOBåˆ†é…å™¨ã€‚ \\\nï¼ˆ2ï¼‰å†…æ ¸ç©ºé—´çš„æ‰©å±•åŠŸèƒ½ã€‚ \\\nä¸è¿ç»­é¡µåˆ†é…å™¨æä¾›äº†åˆ†é…å†…å­˜çš„æ¥å£vmallocå’Œé‡Šæ”¾å†…å­˜çš„æ¥å£vfree è¿ç»­å†…å­˜åˆ†é…å™¨ï¼ˆContiguous Memory Allocatorï¼ŒCMAï¼‰ç”¨æ¥ç»™é©±åŠ¨ç¨‹åºé¢„ç•™ä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œå½“é©±åŠ¨ç¨‹åºä¸ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ç»™è¿›ç¨‹ä½¿ç”¨ï¼›å½“é©±åŠ¨ç¨‹åºéœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼ŒæŠŠè¿›ç¨‹å ç”¨çš„å†…å­˜é€šè¿‡å›æ”¶æˆ–è¿ç§»çš„æ–¹å¼è®©å‡ºæ¥ï¼Œç»™é©±åŠ¨ç¨‹åºä½¿ç”¨ \\\n3.ç¡¬ä»¶å±‚é¢ å¤„ç†å™¨åŒ…å«ä¸€ä¸ªç§°ä¸ºå†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰çš„éƒ¨ä»¶ï¼Œè´Ÿè´£æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ å†…å­˜ç®¡ç†å•å…ƒåŒ…å«ä¸€ä¸ªç§°ä¸ºé¡µè¡¨ç¼“å­˜ï¼ˆTranslation Lookaside Bufferï¼ŒTLBï¼‰çš„éƒ¨ä»¶ï¼Œä¿å­˜æœ€è¿‘ä½¿ç”¨è¿‡çš„é¡µè¡¨æ˜ å°„ï¼Œé¿å…æ¯æ¬¡æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€éƒ½éœ€è¦æŸ¥è¯¢å†…å­˜ä¸­çš„é¡µè¡¨ \\\n3.2 è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€ 3.2.1 è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ† ARM64å¤„ç†å™¨ä¸æ”¯æŒå®Œå…¨çš„64ä½è™šæ‹Ÿåœ°å€ï¼ŒARMv8.2 æ ‡å‡†çš„å¤§è™šæ‹Ÿåœ°å€(Large Virtual Addressï¼ŒLVA)æ”¯æŒï¼Œå¹¶ä¸”é¡µé•¿åº¦æ˜¯64KBï¼Œé‚£ä¹ˆè™šæ‹Ÿåœ°å€çš„æœ€å¤§å®½åº¦æ˜¯52ä½ å¯ä»¥ä¸ºè™šæ‹Ÿåœ°å€é…ç½®æ¯”æœ€å¤§å®½åº¦å°çš„å®½åº¦ï¼Œå¹¶ä¸”å¯ä»¥ä¸ºå†…æ ¸è™šæ‹Ÿåœ°å€å’Œç”¨æˆ·è™šæ‹Ÿåœ°å€é…ç½®ä¸åŒçš„å®½åº¦ã€‚è½¬æ¢æ§åˆ¶å¯„å­˜å™¨ï¼ˆTranslation Control Registerï¼‰TCR_EL1çš„å­—æ®µT0SZå®šä¹‰äº†å¿…é¡»æ˜¯å…¨0çš„æœ€é«˜ä½çš„æ•°é‡ï¼Œå­—æ®µT1SZå®šä¹‰äº†å¿…é¡»æ˜¯å…¨1çš„æœ€é«˜ä½çš„æ•°é‡ï¼Œç”¨æˆ·è™šæ‹Ÿåœ°å€çš„å®½åº¦æ˜¯ï¼ˆ64-TCR_EL1.T0SZï¼‰ï¼Œå†…æ ¸è™šæ‹Ÿåœ°å€çš„å®½åº¦æ˜¯ï¼ˆ64-TCR_EL1.T1SZï¼‰ \\\né¡µé•¿åº¦ è™šæ‹Ÿåœ°å€å®½åº¦ 4KB 39 16KB 47 64KB 42 å¯é€‰æ‹©48ä½è™šæ‹Ÿåœ°å€ 3.2.2 ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€ è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€æ˜¯0ï¼Œé•¿åº¦æ˜¯TASK_SIZEï¼ŒARM64æ¶æ„ä¸‹TASK_SIZEä¸‹ ï¼ˆ1ï¼‰32ä½ç”¨æˆ·ç©ºé—´ç¨‹åºï¼šTASK_SIZEå€¼æ˜¯TASK_SIZE_32ï¼Œå³0x100000000ï¼Œ4GB ï¼ˆ2ï¼‰64ä½ç”¨æˆ·ç©ºé—´ç¨‹åºï¼šTASK_SIZEå€¼æ˜¯TASK_SIZE_64ï¼Œå³ 2^VA_BITSï¼ŒVA_BITSæ˜¯ç¼–è¯‘å†…æ ¸æ—¶é€‰æ‹©çš„è™šæ‹Ÿåœ°å€ä½æ•°ã€‚ \\\n//arch/arm64/include/asm/memory.h linux4.x #define VA_BITS (CONFIG_ARM64_VA_BITS) #define TASK_SIZE_64 (UL(1) \u003c\u003c VA_BITS) #ifdef CONFIG_COMPAT /* æ”¯æŒæ‰§è¡Œ32ä½ç”¨æˆ·ç©ºé—´ç¨‹åº */ #define TASK_SIZE_32 UL(0x100000000) /* test_thread_flag(TIF_32BIT)åˆ¤æ–­ç”¨æˆ·ç©ºé—´ç¨‹åºæ˜¯ä¸æ˜¯32ä½ */ #define TASK_SIZE (test_thread_flag(TIF_32BIT) ? \\ TASK_SIZE_32 : TASK_SIZE_64) #define TASK_SIZE_OF(tsk) (test_tsk_thread_flag(tsk, TIF_32BIT) ? \\ TASK_SIZE_32 : TASK_SIZE_64) #else #define TASK_SIZE TASK_SIZE_64 #endif /* CONFIG_COMPAT */ // linux-5.10.102/arch/arm64/include/asm/memory.h #define VA_BITS\t(CONFIG_ARM64_VA_BITS) #define _PAGE_OFFSET(va)\t(-(UL(1) \u003c\u003c (va))) #define PAGE_OFFSET\t(_PAGE_OFFSET(VA_BITS)) #define KIMAGE_VADDR\t(MODULES_END) #define BPF_JIT_REGION_START\t(KASAN_SHADOW_END) #define BPF_JIT_REGION_SIZE\t(SZ_128M) #define BPF_JIT_REGION_END\t(BPF_JIT_REGION_START + BPF_JIT_REGION_SIZE) #define MODULES_END\t(MODULES_VADDR + MODULES_VSIZE) #define MODULES_VADDR\t(BPF_JIT_REGION_END) #define MODULES_VSIZE\t(SZ_128M) #define VMEMMAP_START\t(-VMEMMAP_SIZE - SZ_2M) #define VMEMMAP_END\t(VMEMMAP_START + VMEMMAP_SIZE) #define PCI_IO_END\t(VMEMMAP_START - SZ_2M) #define PCI_IO_START\t(PCI_IO_END - PCI_IO_SIZE) #define FIXADDR_TOP\t(PCI_IO_START - SZ_2M) è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´åŒ…å«ï¼š ï¼ˆ1ï¼‰ä»£ç æ®µã€æ•°æ®æ®µå’Œæœªåˆå§‹åŒ–æ•°æ®æ®µ ï¼ˆ2ï¼‰åŠ¨æ€åº“ä»£ç æ®µã€æ•°æ®æ®µå’Œåˆå§‹åŒ–æ•°æ®æ®µ ï¼ˆ3ï¼‰å­˜æ”¾åŠ¨æ€ç”Ÿæˆçš„æ•°æ®çš„å † ï¼ˆ4ï¼‰å­˜æ”¾å±€éƒ¨å˜é‡å’Œå®ç°å‡½æ•°è°ƒç”¨çš„æ ˆ ï¼ˆ5ï¼‰å­˜æ”¾åœ¨æ ˆåº•éƒ¨çš„ç¯å¢ƒå˜é‡å’Œå‚æ•°å­—ç¬¦ä¸² ï¼ˆ6ï¼‰æŠŠæ–‡ä»¶åŒºé—´æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…å­˜æ˜ å°„åŒºåŸŸ å†…æ ¸ä½¿ç”¨å†…å­˜æè¿°ç¬¦mm_structæè¿°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…å­˜æè¿°ç¬¦ä¸»è¦æˆå‘˜\natomic_t mm_users; // å…±äº«åŒä¸€ä¸ªç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´è¿›ç¨‹çš„æ•°é‡ï¼Œå³çº¿ç¨‹ç»„åŒ…å«çš„è¿›ç¨‹çš„æ•°é‡ atomic_t mm_count; // å†…å­˜æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•° struct vm_area_struct *mmap; // è™šæ‹Ÿå†…å­˜åŒºåŸŸé“¾è¡¨ struct rb_root mm_rb; // è™šæ‹Ÿå†…å­˜åŒºåŸŸçº¢é»‘æ ‘ unsigned long(*get_unmapped_area)(struct file *filp, unsigned long addr, unsigned long len, unsigned long pgoff, unsigned long flags); // åœ¨å†…å­˜æ˜ å°„åŒºåŸŸæ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰æ˜ å°„çš„åŒºåŸŸ pgd_t *pgd; // æŒ‡å‘é¡µå…¨å±€ç›®å½•ï¼Œå³ç¬¬ä¸€çº§é¡µè¡¨ unsigned long mmap_base; // å†…å­˜æ˜ å°„åŒºçš„èµ·å§‹åœ°å€ unsigned long task_size; // ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„é•¿åº¦ unsigned long start_code, end_code; // ä»£ç æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ unsigned long start_data, end_data; // æ•°æ®æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ unsigned long start_brk, brk; // å †çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ unsigned long start_stack; // æ ˆçš„èµ·å§‹åœ°å€ unsigned long arg_start, arg_end; // å‚æ•°å­—ç¬¦ä¸²èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ unsigned long env_start, env_end; // ç¯å¢ƒå˜é‡çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€ struct mm_struct *mm; // è¿›ç¨‹mmæŒ‡å‘ä¸€ä¸ªå†…å­˜æè¿°ç¬¦ï¼Œå†…æ ¸çº¿ç¨‹mmä¸ºç©ºæŒ‡é’ˆ struct mm_structã€€*active_mm; // è¿›ç¨‹çš„active_mmå’Œmmæ€»æ˜¯æŒ‡å‘åŒä¸€ä¸ªå†…å­˜æè¿°ç¬¦ // å†…æ ¸çº¿ç¨‹çš„active_mmåœ¨æ²¡æœ‰è¿è¡Œæ—¶æ˜¯ç©ºæŒ‡é’ˆï¼Œåœ¨è¿è¡Œæ—¶æŒ‡å‘ä»ä¸Šä¸€ä¸ªè¿›ç¨‹å€Ÿç”¨çš„å†…å­˜æè¿°ç¬¦ è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–ï¼š ï¼ˆ1ï¼‰è¿›ç¨‹æè¿°ç¬¦æˆå‘˜personalityæ˜¯å¦è®¾ç½®ADDR_NO_RANDOMIZE ï¼ˆ2ï¼‰å…¨å±€å˜é‡randomize_va_spceï¼š0è¡¨ç¤ºå…³é—­è™šæ‹Ÿåœ°å€ç©ºé—´éšæœºåŒ–ï¼Œ1è¡¨ç¤ºå†…å­˜æ˜ å°„åŒºå’Œæ ˆèµ·å§‹åœ°å€éšæœºåŒ–ï¼Œ2è¡¨ç¤ºå†…å­˜æ˜ å°„åŒºã€æ ˆå’Œå †èµ·å§‹åœ°å€éšæœºåŒ–ï¼Œæ–‡ä»¶/proc/sys/kernel/randomize_va_spaceä¿®æ”¹ \\\næ ˆå‘ä¸‹å¢é•¿ï¼Œèµ·å§‹åœ°å€STACK_TOPï¼Œ\n// arch/arm64/include/asm/processor.h #define STACK_TOP_MAX TASK_SIZE_64 #ifdef CONFIG_COMPAT /* æ”¯æŒæ‰§è¡Œ32ä½ç”¨æˆ·ç©ºé—´ç¨‹åº */ #define AARCH32_VECTORS_BASE 0xffff0000 #define STACK_TOP (test_thread_flag(TIF_32BIT) ? \\ AARCH32_VECTORS_BASE : STACK_TOP_MAX) #else #define STACK_TOP STACK_TOP_MAX #endif /* CONFIG_COMPAT */ å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€æ˜¯å†…å­˜æè¿°ç¬¦çš„æˆå‘˜ mmap_base\nç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä¸¤ç§å¸ƒå±€ æ–°å¸ƒå±€ï¼šå†…å­˜æ˜ å°„åŒºåŸŸè‡ªé¡¶å‘ä¸‹å¢é•¿ï¼Œèµ·å§‹åœ°å€æ˜¯(STACK_TOP âˆ’ æ ˆçš„æœ€å¤§é•¿åº¦ âˆ’ é—´éš™)ï¼Œé»˜è®¤å¯ç”¨å†…å­˜æ˜ å°„åŒºåŸŸéšæœºåŒ–ï¼Œéœ€è¦æŠŠèµ·å§‹åœ°å€å‡å»ä¸€ä¸ªéšæœºå€¼ \\\nè¿›ç¨‹è°ƒç”¨execveä»¥è£…è½½ELFæ–‡ä»¶çš„æ—¶å€™ï¼Œå‡½æ•°load_elf_binaryå°†ä¼šåˆ›å»ºè¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ \\\nå‡½æ•°arch_pick_mmap_layoutè´Ÿè´£é€‰æ‹©å†…å­˜æ˜ å°„åŒºåŸŸçš„å¸ƒå±€ã€‚ARM64æ¶æ„å®šä¹‰çš„å‡½æ•°arch_pick_mmap_layout\n// linux-5.10.102/mm/util.c void arch_pick_mmap_layout(struct mm_struct *mm, struct rlimit *rlim_stack) { unsigned long random_factor = 0UL; if (current-\u003eflags \u0026 PF_RANDOMIZE) random_factor = arch_mmap_rnd(); if (mmap_is_legacy(rlim_stack)) { // è‡ªåº•å‘ä¸Š mm-\u003emmap_base = TASK_UNMAPPED_BASE + random_factor; mm-\u003eget_unmapped_area = arch_get_unmapped_area; // } else { // è‡ªé¡¶å‘ä¸‹ mm-\u003emmap_base = mmap_base(random_factor, rlim_stack); mm-\u003eget_unmapped_area = arch_get_unmapped_area_topdown; } } static int mmap_is_legacy(struct rlimit *rlim_stack) { if (current-\u003epersonality \u0026 ADDR_COMPAT_LAYOUT) return 1; if (rlim_stack-\u003erlim_cur == RLIM_INFINITY) return 1; return sysctl_legacy_va_layout; } å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€çš„è®¡ç®—\n// linux-5.10.102/arch/arm64/include/asm/efi.h #ifdef CONFIG_COMPAT #define STACK_RND_MASK\t(test_thread_flag(TIF_32BIT) ? \\ 0x7ff \u003e\u003e (PAGE_SHIFT - 12) : \\ 0x3ffff \u003e\u003e (PAGE_SHIFT - 12)) #else #define STACK_RND_MASK\t(0x3ffff \u003e\u003e (PAGE_SHIFT - 12)) #endif // arch/arm64/mm/mmap.c #define MIN_GAP (SZ_128M + ((STACK_RND_MASK \u003c\u003c PAGE_SHIFT) + 1)) #define MAX_GAP (STACK_TOP/6*5) static unsigned long mmap_base(unsigned long rnd) { unsigned long gap = rlimit(RLIMIT_STACK); if (gap \u003c MIN_GAP) gap = MIN_GAP; else if (gap \u003e MAX_GAP) gap = MAX_GAP; return PAGE_ALIGN(STACK_TOP - gap - rnd); } å‡½æ•°load_elf_binaryï¼šå‡½æ•°setup_arg_pagesæŠŠæ ˆé¡¶è®¾ç½®ä¸ºSTACK_TOPå‡å»éšæœºå€¼ï¼Œç„¶åæŠŠç¯å¢ƒå˜é‡å’Œå‚æ•°ä»ä¸´æ—¶æ ˆç§»åˆ°æœ€ç»ˆçš„ç”¨æˆ·æ ˆï¼›å‡½æ•°set_brkè®¾ç½®å †çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœå¯ç”¨å †éšæœºåŒ–ï¼ŒæŠŠå †çš„èµ·å§‹åœ°å€åŠ ä¸Šéšæœºå€¼\n// fs/binfmt_elf.c static int load_elf_binary(struct linux_binprm *bprm) { â€¦ retval = setup_arg_pages(bprm, randomize_stack_top(STACK_TOP), executable_stack); â€¦ retval = set_brk(elf_bss, elf_brk, bss_prot); â€¦ if ((current-\u003eflags \u0026 PF_RANDOMIZE) \u0026\u0026 (randomize_va_space \u003e 1)) { current-\u003emm-\u003ebrk = current-\u003emm-\u003estart_brk = arch_randomize_brk(current-\u003emm); } â€¦ } 3.2.3 å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€ ARM64å¤„ç†å™¨æ¶æ„å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€ (1)å…ˆè¡Œæ˜ å°„åŒºèŒƒå›´[PAGE_OFFSET, 2^64-1]ï¼Œèµ·å§‹åœ°å€PAGE_OFFSET = (OxFFFF FFFF FFFF FFFF Â« (VA_BITS-1))ï¼Œé•¿åº¦ä¸ºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€åŠï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯çº¿æ€§å…³ç³» \\ è™šæ‹Ÿåœ°å€ = ((ç‰©ç†åœ°å€-PHYS_OFFSET)+PAGE_OFFSET)ï¼ŒPHY_OFFSETæ˜¯å†…å­˜èµ·å§‹ç‰©ç†åœ°å€ (2)vmemmap åŒºåŸŸçš„èŒƒå›´æ˜¯[VMEMMAP_START, PAGE_OFFSET)ï¼Œé•¿åº¦æ˜¯VMEMMAP_SIZE =ï¼ˆçº¿æ€§æ˜ å°„åŒºåŸŸçš„é•¿åº¦ / é¡µé•¿åº¦ * pageç»“æ„ä½“çš„é•¿åº¦ä¸Šé™ï¼‰ (3)PCI I/OåŒºåŸŸçš„èŒƒå›´æ˜¯[PCI_IO_START, PCI_IO_END)ï¼Œé•¿åº¦æ˜¯16MBï¼Œç»“æŸåœ°å€æ˜¯PCI_IO_END = (VMEMMAP_START âˆ’ 2MB)ã€‚å¤–å›´ç»„ä»¶äº’è”ï¼ˆPeripheral Component Interconnectï¼ŒPCIï¼‰æ˜¯ä¸€ç§æ€»çº¿æ ‡å‡†ï¼ŒPCI I/OåŒºåŸŸæ˜¯PCIè®¾å¤‡çš„I/Oåœ°å€ç©ºé—´ (4)å®šæ˜ å°„åŒºåŸŸçš„èŒƒå›´æ˜¯[FIXADDR_START, FIXADDR_TOP)ï¼Œé•¿åº¦æ˜¯FIXADDR_SIZEï¼Œç»“æŸåœ°å€æ˜¯FIXADDR_TOP = (PCI_IO_START âˆ’ 2MB) (5)vmallocåŒºåŸŸçš„èŒƒå›´æ˜¯[VMALLOC_START, VMALLOC_ENDï¼‰ï¼Œèµ·å§‹åœ°å€æ˜¯VMALLOC_STARTï¼Œç­‰äºå†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€ï¼Œç»“æŸåœ°å€æ˜¯VMALLOC_END = (PAGE_OFFSET âˆ’ PUD_SIZE âˆ’ VMEMMAP_SIZE âˆ’ 64KB)ï¼Œå…¶ä¸­PUD_SIZEæ˜¯é¡µä¸Šçº§ç›®å½•è¡¨é¡¹æ˜ å°„çš„åœ°å€ç©ºé—´çš„é•¿åº¦ vmallocåŒºåŸŸæ˜¯å‡½æ•°vmallocä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…æ ¸é•œåƒåœ¨vmallocåŒºåŸŸï¼Œèµ·å§‹è™šæ‹Ÿåœ°å€æ˜¯(KIMAGE_VADDR + TEXT_OFFSET) ï¼Œå…¶ä¸­KIMAGE_VADDRæ˜¯å†…æ ¸é•œåƒçš„è™šæ‹Ÿåœ°å€çš„åŸºå‡†å€¼ï¼Œç­‰äºå†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€MODULES_ENDï¼›TEXT_OFFSETæ˜¯å†…å­˜ä¸­çš„å†…æ ¸é•œåƒç›¸å¯¹å†…å­˜èµ·å§‹ä½ç½®çš„åç§» (6)å†…æ ¸æ¨¡å—åŒºåŸŸçš„èŒƒå›´æ˜¯[MODULES_VADDR, MODULES_END)ï¼Œé•¿åº¦æ˜¯128MBï¼Œèµ·å§‹åœ°å€æ˜¯MODULES_VADDR =ï¼ˆå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ + KASANå½±å­åŒºåŸŸçš„é•¿åº¦ï¼‰ã€‚å†…æ ¸æ¨¡å—åŒºåŸŸæ˜¯å†…æ ¸æ¨¡å—ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ (7)KASANå½±å­åŒºåŸŸçš„èµ·å§‹åœ°å€æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œé•¿åº¦æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´é•¿åº¦çš„1/8ã€‚å†…æ ¸åœ°å€æ¶ˆæ¯’å‰‚ï¼ˆKernel Address SANitizerï¼ŒKASANï¼‰æ˜¯ä¸€ä¸ªåŠ¨æ€çš„å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…· \\\n3.3 ç‰©ç†åœ°å€ç©ºé—´ å¤„ç†å™¨é€šè¿‡å¤–å›´è®¾å¤‡æ§åˆ¶å™¨çš„å¯„å­˜å™¨è®¿é—®å¤–å›´è®¾å¤‡ï¼Œå¯„å­˜å™¨åˆ†ä¸ºæ§åˆ¶å¯„å­˜å™¨ã€çŠ¶æ€å¯„å­˜å™¨å’Œæ•°æ®å¯„å­˜å™¨ä¸‰å¤§ç±»ï¼Œå¤–å›´è®¾å¤‡çš„å¯„å­˜å™¨é€šå¸¸è¢«è¿ç»­åœ°ç¼–å€ã€‚å¤„ç†å™¨å¯¹å¤–å›´è®¾å¤‡å¯„å­˜å™¨çš„ç¼–å€æ–¹å¼æœ‰ä¸¤ç§ï¼š ï¼ˆ1ï¼‰I/Oæ˜ å°„æ–¹å¼(I/O-mapped) ï¼ˆ2ï¼‰å†…å­˜æ˜ å°„æ–¹å¼(memroy-mapped)ï¼šç²¾ç®€æŒ‡ä»¤é›†çš„å¤„ç†å™¨é€šå¸¸åªå®ç°ä¸€ä¸ªç‰©ç†åœ°å€ç©ºé—´ï¼Œå¤–å›´è®¾å¤‡å’Œç‰©ç†å†…å­˜ä½¿ç”¨ç»Ÿä¸€çš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œå¤„ç†å™¨å¯ä»¥åƒè®¿é—®ä¸€ä¸ªå†…å­˜å•å…ƒé‚£æ ·è®¿é—®å¤–å›´è®¾å¤‡ï¼Œä¸éœ€è¦æä¾›ä¸“é—¨çš„I/OæŒ‡ä»¤ \\\nç¨‹åºé€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®å¤–è®¾å¯„å­˜å™¨ï¼Œå†…æ ¸å‡½æ•°æŠŠå¤–è®¾å¯„å­˜å™¨ç‰©ç†åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´\n// ioremap()æŠŠå¤–è®¾å¯„å­˜å™¨ç‰©ç†åœ°å€æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ void* ioremap(unsigned long phys_addr, unsigned long size, unsigned long flags); // io_remap_pfn_range()å‡½æ•°æŠŠå¤–è®¾å¯„å­˜å™¨çš„ç‰©ç†åœ°å€æ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ int io_remap_pfn_range(struct vm_area_struct *vma, unsigned long addr,unsigned long pfn, unsigned long size, pgprot_t prot); // iounmap()åˆ é™¤å‡½æ•°ioremap()åˆ›å»ºæ˜ å°„ void iounmap(void *addr); ARM64æ¶æ„ä¸¤ç§å†…å­˜ç±»å‹ï¼š ï¼ˆ1ï¼‰æ­£å¸¸å†…å­˜(Normal Memory)ï¼šåŒ…æ‹¬ç‰©ç†å†…å­˜å’Œåªè¯»å­˜å‚¨å™¨(ROM)ï¼Œå…±äº«å±æ€§å’Œå¯ç¼“å­˜ ï¼ˆ2ï¼‰è®¾å¤‡å†…å­˜(Device Memory)ï¼šæŒ‡åˆ†é…ç»™å¤–å›´è®¾å¤‡å¯„å­˜å™¨çš„ç‰©ç†åœ°å€åŒºåŸŸï¼Œå¤–éƒ¨å…±äº«ï¼Œä¸å¯ç¼“å­˜ ARM64æ¶æ„3ç§å±æ€§æŠŠè®¾å¤‡åˆ†ä¸º4ç§ç±»å‹: ï¼ˆ1ï¼‰Device-nGnRnE ï¼ˆ2ï¼‰Device-nGnREã€‚ ï¼ˆ3ï¼‰Device-nGREã€‚ ï¼ˆ4ï¼‰Device-GRE \\\nå¯„å­˜å™¨TCR_EL1ï¼ˆTranslation Control Register for Exception Level 1ï¼Œå¼‚å¸¸çº§åˆ«1çš„è½¬æ¢æ§åˆ¶å¯„å­˜å™¨ï¼‰çš„å­—æ®µIPSï¼ˆIntermediate Physical Address Sizeï¼Œä¸­é—´ç‰©ç†åœ°å€é•¿åº¦ï¼‰æ§åˆ¶ç‰©ç†åœ°å€çš„å®½åº¦ï¼ŒIPSå­—æ®µçš„é•¿åº¦æ˜¯3ä½\n3.4ã€€å†…å­˜æ˜ å°„ è¿›ç¨‹åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­åˆ›å»ºæ˜ å°„ï¼š ï¼ˆ1ï¼‰æ–‡ä»¶æ˜ å°„ï¼ŒæŠŠæ–‡ä»¶ä¸€ä¸ªåŒºé—´æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ•°æ®æºæ˜¯å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ï¼Œæ–‡ä»¶é¡µ ï¼ˆ2ï¼‰åŒ¿åæ˜ å°„ï¼ŒæŠŠç‰©ç†å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ— æ•°æ®æºï¼ŒåŒ¿åé¡µ ä¿®æ”¹å¯¹å…¶ä»–è¿›ç¨‹å¯è§å’Œé‡Šæ”¾ä¼ é€’åº•å±‚æ–‡ä»¶ï¼Œå†…å­˜æ˜ å°„åˆ†ä¸ºå…±äº«æ˜ å°„å’Œç§æœ‰æ˜ å°„ã€‚ \u0026enspï¼›ï¼ˆ1ï¼‰å…±äº«æ˜ å°„ï¼šä¿®æ”¹æ•°æ®æ—¶æ˜ å°„ç›¸åŒåŒºåŸŸçš„å…¶ä»–è¿›ç¨‹å¯ä»¥çœ‹è§ï¼Œå¦‚æœæ˜¯æ–‡ä»¶æ”¯æŒçš„æ˜ å°„ï¼Œä¿®æ”¹ä¼šä¼ é€’åˆ°åº•å±‚æ–‡ä»¶ã€‚ ï¼ˆ2ï¼‰ç§æœ‰æ˜ å°„ï¼šç¬¬ä¸€æ¬¡ä¿®æ”¹æ•°æ®æ—¶ä¼šä»æ•°æ®æºå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬ï¼Œç„¶åä¿®æ”¹å‰¯æœ¬ï¼Œå…¶ä»–è¿›ç¨‹çœ‹ä¸è§ï¼Œä¸å½±å“æ•°æ®æº ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨å…±äº«çš„æ–‡ä»¶æ˜ å°„å®ç°å…±äº«å†…å­˜ï¼Œè¿›ç¨‹é—´é€šä¿¡ï¼Ÿã€‚åŒ¿åæ˜ å°„é€šå¸¸æ˜¯ç§æœ‰æ˜ å°„ï¼Œå…±äº«çš„åŒ¿åæ˜ å°„åªå¯èƒ½å‡ºç°åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´ã€‚ è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä»£ç æ®µå’Œæ•°æ®æ®µæ˜¯ç§æœ‰çš„æ–‡ä»¶æ˜ å°„ï¼Œæœªåˆå§‹åŒ–æ•°æ®æ®µã€å †å’Œæ ˆæ˜¯ç§æœ‰çš„åŒ¿åæ˜ å°„ å†…å­˜æ˜ å°„çš„åŸç†ã€‚ ï¼ˆ1ï¼‰åˆ›å»ºå†…å­˜æ˜ å°„çš„æ—¶å€™ï¼Œåœ¨è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸã€‚ ï¼ˆ2ï¼‰Linuxå†…æ ¸é‡‡ç”¨å»¶è¿Ÿåˆ†é…ç‰©ç†å†…å­˜çš„ç­–ç•¥ï¼Œåœ¨è¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿé¡µçš„æ—¶å€™ï¼Œäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ã€‚å¦‚æœæ˜¯æ–‡ä»¶æ˜ å°„ï¼Œé‚£ä¹ˆåˆ†é…ç‰©ç†é¡µï¼ŒæŠŠæ–‡ä»¶æŒ‡å®šåŒºé—´çš„æ•°æ®è¯»åˆ°ç‰©ç†é¡µä¸­ï¼Œç„¶ååœ¨é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µï¼›å¦‚æœæ˜¯åŒ¿åæ˜ å°„ï¼Œé‚£ä¹ˆåˆ†é…ç‰©ç†é¡µï¼Œç„¶ååœ¨é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ\n3.4.1 åº”ç”¨ç¼–ç¨‹æ¥å£ ç³»ç»Ÿè°ƒç”¨\n// 1.mmap()åˆ›å»ºå†…å­˜æ˜ å°„ void *mmap(void *addr, size_t length, int prot, int flags, in fd, off_t offset); // 2. mremap()æ‰©å¤§æˆ–ç¼©å°å†…å­˜æ˜ å°„ï¼Œå¯ç§»åŠ¨ void *mreemap(void *old_address, size_t old_size, size_t new_size, int flags, ... /*void *new_address */); // 3. munmap() åˆ é™¤å†…å­˜å°åˆ· int munmap(void *addr, size_t length); // 4. brk() è®¾ç½®å †ä¸Šç•Œ int brk(void *addr); // 6. mprotect()è®¾ç½®è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„è®¿é—®æƒé™ int mprotect(void *addr, size_t len, int prot); // 7. madvise ç®±å†…æ ¸ä½“æœ¯å†…å­˜ä½¿ç”¨å»ºè®®ï¼Œé…åˆå†…æ ¸é¢„è¯»å’Œç¼“å­˜ int madvise(void *addr, size_t length, int advice); å†…æ ¸ç©ºé—´å‡½æ•°\n// 1. remap_pfn_rangeæŠŠå†…å­˜çš„ç‰©ç†é¡µæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå®ç°è¿›ç¨‹å’Œå†…æ ¸å…±äº«å†…å­˜ int remap_pfn_range(struct vm_area_struct *vma, unsigned long addr,unsigned long pfn,unsigned long size, pgprot_t prot); // 2.io_remap_pfn_rangeæŠŠå¤–è®¾å¯„å­˜å™¨çš„ç‰©ç†åœ°å€æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿›ç¨‹å¯ä»¥ç›´æ¥è®¿é—®å¤–è®¾å¯„å­˜å™¨ int io_remap_pfn_range(struct vm_area_struct *vma, unsigned long addr,unsigned long pfn, unsigned long size, pgprot_t prot); åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨Cæ ‡å‡†åº“æä¾›çš„å‡½æ•°malloc()ç”³è¯·å†…å­˜ã€‚glibcåº“çš„å†…å­˜åˆ†é…å™¨ptmallocä½¿ç”¨brkæˆ–mmapå‘å†…æ ¸ä»¥é¡µä¸ºå•ä½ç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œç„¶åæŠŠé¡µåˆ’åˆ†æˆå°å†…å­˜å—åˆ†é…ç»™åº”ç”¨ç¨‹åºã€‚é»˜è®¤çš„é˜ˆå€¼æ˜¯128KBï¼Œå¦‚æœåº”ç”¨ç¨‹åºç”³è¯·çš„å†…å­˜é•¿åº¦å°äºé˜ˆå€¼ï¼Œptmallocåˆ†é…å™¨ä½¿ç”¨brkå‘å†…æ ¸ç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œå¦åˆ™ptmallocåˆ†é…å™¨ä½¿ç”¨mmapå‘å†…æ ¸ç”³è¯·è™šæ‹Ÿå†…å­˜ \\\nåº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨mmapå‘å†…æ ¸ç”³è¯·è™šæ‹Ÿå†…å­˜ ç³»ç»Ÿè°ƒç”¨mmap() ç³»ç»Ÿè°ƒç”¨mprotect() ç³»ç»Ÿè°ƒç”¨madvise()\n3.4.2 æ•°æ®ç»“æ„ 1. è™šæ‹Ÿå†…å­˜åŒºåŸŸ å†…æ ¸ä½¿ç”¨ç»“æ„ä½“vm_area_structæè¿°è™šæ‹Ÿå†…å­˜åŒºåŸŸ\nstruct vm_area_struct { /* The first cache line has the info for VMA tree walking. */ /* Our start address within vm_mm. */ unsigned long vm_start;\t// èµ·å§‹åœ°å€ /* The first byte after our end address within vm_mm. */ unsigned long vm_end; // ç»“æŸåœ°å€ /* linked list of VM areas per task, sorted by address */ // è™šæ‹Ÿå†…å­˜åŒºåŸŸé“¾è¡¨ï¼ŒæŒ‰èµ·å§‹åœ°å€æ’åº struct vm_area_struct *vm_next, *vm_prev; // çº¢é»‘æ ‘èŠ‚ç‚¹ struct rb_node vm_rb; /* Largest free memory gap in bytes to the left of this VMA. * Either between this VMA and vma-\u003evm_prev, or between one of the * VMAs below us in the VMA rbtree and its -\u003evm_prev. This helps * get_unmapped_area find a free area of the right size.*/ unsigned long rb_subtree_gap; /* Second cache line starts here. */ // æŒ‡å‘å†…å­˜æè¿°ç¬¦ï¼Œå³è™šæ‹Ÿå†…å­˜åŒºåŸŸæ‰€å±çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ struct mm_struct *vm_mm;\t/* The address space we belong to. */ /* Access permissions of this VMA. * See vmf_insert_mixed_prot() for discussion.*/ // ä¿æŠ¤ä½ï¼Œå³è®¿é—®æƒé™ pgprot_t vm_page_prot; unsigned long vm_flags;\t/* Flags, see mm.h. */ /* For areas with an address space and backing store, * linkage into the address_space-\u003ei_mmap interval tree.*/ // ä¸ºäº†æ”¯æŒæŸ¥è¯¢ä¸€ä¸ªæ–‡ä»¶åŒºé—´è¢«æ˜ å°„åˆ°å“ªäº›è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œ // æŠŠä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°çš„æ‰€æœ‰è™šæ‹Ÿå†…å­˜åŒºåŸŸåŠ å…¥è¯¥æ–‡ä»¶çš„åœ°å€ç©ºé—´ç»“æ„ä½“ // address_spaceçš„æˆå‘˜i_mmapæŒ‡å‘çš„åŒºé—´æ ‘ struct { struct rb_node rb; unsigned long rb_subtree_last; } shared; /* file's MAP_PRIVATE vma can be in both i_mmap tree and anon_vma * list, after a COW of one of the file pages.\tA MAP_SHARED vma * can only be in the i_mmap tree. An anonymous MAP_PRIVATE, stack * or brk vma (with NULL file) can only be in an anon_vma list.*/ // æŠŠè™šæ‹Ÿå†…å­˜åŒºåŸŸå…³è”çš„æ‰€æœ‰anon_vmaå®ä¾‹ä¸²è”èµ·æ¥ã€‚ // ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸä¼šå…³è”åˆ°çˆ¶è¿›ç¨‹çš„anon_vmaå®ä¾‹å’Œè‡ªå·±çš„anon_vmaå®ä¾‹ struct list_head anon_vma_chain; /* Serialized by mmap_lock \u0026 * page_table_lock */ // æŒ‡å‘ä¸€ä¸ªanon_vmaå®ä¾‹ï¼Œç»“æ„ä½“anon_vmaç”¨æ¥ç»„ç»‡åŒ¿åé¡µ // è¢«æ˜ å°„åˆ°çš„æ‰€æœ‰è™šæ‹Ÿåœ°å€ç©ºé—´ struct anon_vma *anon_vma;\t/* Serialized by page_table_lock */ /* Function pointers to deal with this struct. */ // è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆ const struct vm_operations_struct *vm_ops; /* Information about our backing store: */ // æ–‡ä»¶åç§»ï¼Œå•ä½æ˜¯é¡µ unsigned long vm_pgoff;\t/* Offset (within vm_file) in PAGE_SIZE units */ // æ–‡ä»¶ï¼Œå¦‚æœæ˜¯ç§æœ‰çš„åŒ¿åæ˜ å°„ï¼Œè¯¥æˆå‘˜æ˜¯ç©ºæŒ‡é’ˆ struct file * vm_file;\t/* File we map to (can be NULL). */ void * vm_private_data;\t/* was vm_pte (shared mem) */ #ifdef CONFIG_SWAP atomic_long_t swap_readahead_info; #endif #ifndef CONFIG_MMU struct vm_region *vm_region;\t/* NOMMU mapping region */ #endif #ifdef CONFIG_NUMA struct mempolicy *vm_policy;\t/* NUMA policy for the VMA */ #endif struct vm_userfaultfd_ctx vm_userfaultfd_ctx; } __randomize_layout; æ–‡ä»¶æ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ ï¼ˆ1ï¼‰æˆå‘˜vm_fileæŒ‡å‘æ–‡ä»¶çš„ä¸€ä¸ªæ‰“å¼€å®ä¾‹ï¼ˆfileï¼‰ã€‚ç´¢å¼•èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ï¼Œæè¿°æ–‡ä»¶çš„å±æ€§ã€‚ ï¼ˆ2ï¼‰æˆå‘˜vm_pgoffå­˜æ”¾æ–‡ä»¶çš„ä»¥é¡µä¸ºå•ä½çš„åç§»ã€‚ ï¼ˆ3ï¼‰æˆå‘˜vm_opsæŒ‡å‘è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆï¼Œåˆ›å»ºæ–‡ä»¶æ˜ å°„çš„æ—¶å€™è°ƒç”¨æ–‡ä»¶æ“ä½œé›†åˆä¸­çš„mmapæ–¹æ³•ï¼ˆfile-\u003ef_op-\u003emmapï¼‰ä»¥æ³¨å†Œè™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆã€‚ä¾‹å¦‚ï¼šå‡è®¾æ–‡ä»¶å±äºEXT4æ–‡ä»¶ç³»ç»Ÿï¼Œæ–‡ä»¶æ“ä½œé›†åˆä¸­çš„mmapæ–¹æ³•æ˜¯å‡½æ•°ext4_file_mmapï¼Œè¯¥å‡½æ•°æŠŠè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æˆå‘˜vm_opsè®¾ç½®ä¸ºext4_file_vm_ops\nå…±äº«åŒ¿åæ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ ï¼ˆ1ï¼‰æˆå‘˜vm_fileæŒ‡å‘æ–‡ä»¶çš„ä¸€ä¸ªæ‰“å¼€å®ä¾‹ï¼ˆfileï¼‰ã€‚ ï¼ˆ2ï¼‰æˆå‘˜vm_pgoffå­˜æ”¾æ–‡ä»¶çš„ä»¥é¡µä¸ºå•ä½çš„åç§»ã€‚ ï¼ˆ3ï¼‰æˆå‘˜vm_opsæŒ‡å‘å…±äº«å†…å­˜çš„è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆshmem_vm_opsã€‚\nç§æœ‰åŒ¿åæ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ ï¼ˆ1ï¼‰é¡µä¿æŠ¤ä½ï¼ˆvm_area_struct.vm_page_protï¼‰ï¼šæè¿°è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„è®¿é—®æƒé™ã€‚å†…æ ¸å®šä¹‰äº†ä¸€ä¸ªä¿æŠ¤ä½æ˜ å°„æ•°ç»„ï¼ŒæŠŠVM_READã€VM_WRITEã€VM_EXECå’ŒVM_SHAREDè¿™4ä¸ªæ ‡å¿—è½¬æ¢æˆä¿æŠ¤ä½ç»„åˆ Pä»£è¡¨ç§æœ‰ï¼ˆPrivateï¼‰ï¼ŒSä»£è¡¨å…±äº«ï¼ˆSharedï¼‰ï¼Œåé¢çš„3ä¸ªæ•°å­—åˆ†åˆ«è¡¨ç¤ºå¯è¯»ã€å¯å†™å’Œå¯æ‰§è¡Œï¼Œä¾‹å¦‚__P000è¡¨ç¤ºç§æœ‰ã€ä¸å¯è¯»ã€ä¸å¯å†™å’Œä¸å¯æ‰§è¡Œï¼Œ__S111è¡¨ç¤ºå…±äº«ã€å¯è¯»ã€å¯å†™å’Œå¯æ‰§è¡Œ\n// mm/mmap.c pgprot_t protection_map[16] = { __P000, __P001, __P010, __P011, __P100, __P101, __P110, __P111, __S000, __S001, __S010, __S011, __S100, __S101, __S110, __S111 }; pgprot_t vm_get_page_prot(unsigned long vm_flags) { return __pgprot(pgprot_val(protection_map[vm_flags \u0026 (VM_READ|VM_WRITE|VM_EXEC|VM_SHARED)]) | pgprot_val(arch_vm_get_page_prot(vm_flags))); } // include/linux/mman.h #ifndef arch_vm_get_page_prot #define arch_vm_get_page_prot(vm_flags) __pgprot(0) #endif è™šæ‹Ÿå†…å­˜åŒºåŸŸæ ‡å¿—ï¼šç»“æ„ä½“vm_area_structçš„æˆå‘˜vm_flagså­˜æ”¾è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ ‡å¿—ï¼Œå¤´æ–‡ä»¶â€œinclude/linux/mm.hâ€å®šä¹‰äº†å„ç§æ ‡å¿— VM_READã€VM_WRITEã€VM_EXECã€VM_SHAREDã€VM_GROWSDOWNã€VM_DONTEXPANDã€VM_ACCOUNTã€VM_NORESERVEã€VM_HUGETLBã€VM_ARCH_1ã€VM_ARCH_2ã€VM_HUGEPAGEã€VM_MERGEABLE\nè™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆï¼ˆvm_operations_structï¼‰ï¼šå®šä¹‰äº†è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„å„ç§æ“ä½œæ–¹æ³•\n// include/linux/mm.h struct vm_operations_struct { // åœ¨åˆ›å»ºè™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨openæ–¹æ³•ï¼Œé€šå¸¸ä¸ä½¿ç”¨ï¼Œè®¾ç½®ä¸ºç©ºæŒ‡é’ˆ void (*open)(struct vm_area_struct * area); // åœ¨åˆ é™¤è™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨closeæ–¹æ³•ï¼Œé€šå¸¸ä¸ä½¿ç”¨ï¼Œè®¾ç½®ä¸ºç©ºæŒ‡é’ˆ void (*close)(struct vm_area_struct * area); // ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨mremapç§»åŠ¨è™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨mremapæ–¹æ³• int (*mremap)(struct vm_area_struct * area); // ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨mremapç§»åŠ¨è™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨mremapæ–¹æ³• int (*fault)(struct vm_fault *vmf); // huge_faultæ–¹æ³•é’ˆå¯¹ä½¿ç”¨é€æ˜å·¨å‹é¡µçš„æ–‡ä»¶æ˜ å°„ int (*huge_fault)(struct vm_fault *vmf, enum page_entry_size pe_size); // è¯»æ–‡ä»¶æ˜ å°„çš„è™šæ‹Ÿé¡µæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µï¼Œç”Ÿæˆç¼ºé¡µå¼‚å¸¸ void (*map_pages)(struct vm_fault *vmf, pgoff_t start_pgoff, pgoff_t end_pgoff); /* é€šçŸ¥ä»¥å‰çš„åªè¯»é¡µå³å°†å˜æˆå¯å†™ï¼Œ * å¦‚æœè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå°†ä¼šå‘é€ä¿¡å·SIGBUSç»™è¿›ç¨‹*/ int (*page_mkwrite)(struct vm_fault *vmf); /* ä½¿ç”¨VM_PFNMAPæˆ–è€…VM_MIXEDMAPæ—¶è°ƒç”¨ï¼ŒåŠŸèƒ½å’Œpage_mkwriteç›¸åŒ*/ int (*pfn_mkwrite)(struct vm_fault *vmf); â€¦ } 2.é“¾è¡¨å’Œæ ‘ è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„é“¾è¡¨å’Œæ ‘ (1)åŒå‘é“¾è¡¨ï¼Œmm_struct.mmapæŒ‡å‘ç¬¬ä¸€ä¸ªvm_area_structå®ä¾‹ (2)çº¢é»‘æ ‘ï¼Œmm_struct.mm_rbæŒ‡å‘çº¢é»‘æ ‘çš„æ ¹ \\\n3.4.3 åˆ›å»ºå†…å­˜æ˜ å°„ Cæ ‡å‡†åº“å°è£…äº†å‡½æ•°mmapç”¨æ¥åˆ›å»ºå†…å­˜æ˜ å°„\nasmlinkage long sys_mmap(unsigned long addr, unsigned long len, unsigned long prot, unsigned long flags, unsigned long fd, off_t off); asmlinkage long sys_mmap2(unsigned long addr, unsigned long len, unsigned long prot, unsigned long flags, unsigned long fd, off_t off); ARM64æ¶æ„åªå®ç°ç³»ç»Ÿè°ƒç”¨mmap\nç³»ç»Ÿè°ƒç”¨sys_mmapæ‰§è¡Œæµç¨‹ do_mmapçš„æ‰§è¡Œæµç¨‹ å¾…è¡¥å……\n3.4.4 è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥ è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ï¼Œæ˜¯æŒ‡æ‰€æœ‰è¿›ç¨‹æäº¤çš„è™šæ‹Ÿå†…å­˜çš„æ€»å’Œè¶…è¿‡ç‰©ç†å†…å­˜çš„å®¹é‡ï¼Œå†…å­˜ç®¡ç†å­ç³»ç»Ÿæ”¯æŒ3ç§è™šæ‹Ÿå†…å­˜è¿‡é‡ ï¼ˆ1ï¼‰OVERCOMMIT_GUESS(0)ï¼šçŒœæµ‹ï¼Œä¼°ç®—å¯ç”¨å†…å­˜çš„æ•°é‡ï¼Œå› ä¸ºæ²¡æ³•å‡†ç¡®è®¡ç®—å¯ç”¨å†…å­˜çš„æ•°é‡ï¼Œæ‰€ä»¥è¯´æ˜¯çŒœæµ‹ã€‚ ï¼ˆ2ï¼‰OVERCOMMIT_ALWAYS(1)ï¼šæ€»æ˜¯å…è®¸è¿‡é‡æäº¤ã€‚ ï¼ˆ3ï¼‰OVERCOMMIT_NEVER(2)ï¼šä¸å…è®¸è¿‡é‡æäº¤ã€‚ /proc/sys/vm/overcommit_memoryä¿®æ”¹ç­–ç•¥ åœ¨åˆ›å»ºæ–°çš„å†…å­˜æ˜ å°„æ—¶ï¼Œè°ƒç”¨å‡½æ•°__vm_enough_memoryæ ¹æ®è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥åˆ¤æ–­å†…å­˜æ˜¯å¦è¶³å¤Ÿ\n3.4.5 åˆ é™¤å†…å­˜æ˜ å°„ ç³»ç»Ÿè°ƒç”¨munmapç”¨æ¥åˆ é™¤å†…å­˜æ˜ å°„ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼šèµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œmm/mmap.cä¸­çš„å‡½æ•°do_munmap\nç³»ç»Ÿè°ƒç”¨munmapæ‰§è¡Œæµç¨‹ 3.5 ç‰©ç†å†…å­˜ç»„ç»‡ 3.5.1 ä½“ç³»ç»“æ„ å¤šå¤„ç†å™¨ç³»ç»Ÿä¸¤ç§ä½“ç³»ç»“æ„ï¼š (1)éä¸€è‡´å†…å­˜è®¿é—®(Non-Uniform Memory Access NUMA)ï¼šå†…å­˜ä¸ºå¤šä¸ªå†…å­˜èŠ‚ç‚¹å¤šå¤„ç†å™¨ç³»ç»Ÿ (2)å¯¹ç§°å¤šå¤„ç†å™¨(Symmetric Multi-Process SMP)ï¼šä¸€ç›´å†…å­˜è®¿é—®(UMA)\n3.5.2 å†…å­˜æ¨¡å‹ å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ”¯æŒ3ç§å†…å­˜æ¨¡å‹ (1)å¹³å¦å†…å­˜(Flat Memory)ï¼šå†…å­˜ç‰©ç†åœ°å€ç©ºé—´æ˜¯è¿ç»­çš„ (2)ä¸è¿ç»­å†…å­˜(Discontiguous Memory)ï¼šå†…å­˜ç‰©ç†åœ°å€ç©ºé—´å­˜åœ¨ç©ºæ´ (3)ç³»æ•°å†…å­˜(Sparse Memory)ï¼šå†…å­˜ç‰©ç†åœ°å€ç©ºé—´å­˜åœ¨ç©ºæ´\n3.5.3 ä¸‰çº§ç»“æ„ å†…å­˜ç®¡ç†å­ç³»ç»Ÿä½¿ç”¨èŠ‚ç‚¹(node)ã€åŒºåŸŸ(zone)å’Œé¡µ(page)ä¸‰çº§ç»“æ„æè¿°ç‰©ç†å†…å­˜ã€‚ \\\n1.å†…å­˜èŠ‚ç‚¹ å†…å­˜èŠ‚ç‚¹ä¸¤ç§æƒ…å†µï¼š ï¼ˆ1ï¼‰NUMAç³»ç»Ÿå†…å­˜èŠ‚ç‚¹ ï¼ˆ2ï¼‰å…·æœ‰ä¸è¿ç»­å†…å­˜çš„UMAç³»ç»Ÿ å†…å­˜èŠ‚ç‚¹ä½¿ç”¨pglist_dataç»“æ„ä½“æè¿°å†…å­˜å¸ƒå±€ï¼Œå†…æ ¸å®šä¹‰å®NODE_DATA(nid)ï¼Œè·å–èŠ‚ç‚¹çš„pglist_dataå®ä¾‹ã€‚å¹³å¦å†…å­˜æ¨¡å‹ï¼Œåªæœ‰ä¸€ä¸ªpglist_dataå®ä¾‹contig_page_data\nå†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹ pglist_dataç»“æ„ä¸»è¦æˆå‘˜ï¼š\n// include/linux/mmzone.h typedef struct pglist_data { struct zone node_zones[MAX_NR_ZONES]; /* å†…å­˜åŒºåŸŸæ•°ç»„ */ struct zonelist node_zonelists[MAX_ZONELISTS]; /* å¤‡ç”¨åŒºåŸŸåˆ—è¡¨ */ int nr_zones; /* è¯¥èŠ‚ç‚¹åŒ…å«çš„å†…å­˜åŒºåŸŸæ•°é‡ */ #ifdef CONFIG_FLAT_NODE_MEM_MAP /* é™¤äº†ç¨€ç–å†…å­˜æ¨¡å‹ä»¥å¤– */ struct page *node_mem_map; /* é¡µæè¿°ç¬¦æ•°ç»„ */ #ifdef CONFIG_PAGE_EXTENSION struct page_ext *node_page_ext; /* é¡µçš„æ‰©å±•å±æ€§ */ #endif #endif â€¦ unsigned long node_start_pfn; /* è¯¥èŠ‚ç‚¹çš„èµ·å§‹ç‰©ç†é¡µå· */ unsigned long node_present_pages; /* ç‰©ç†é¡µæ€»æ•° */ unsigned long node_spanned_pages; /* ç‰©ç†é¡µèŒƒå›´çš„æ€»é•¿åº¦ï¼ŒåŒ…æ‹¬ç©ºæ´ */ int node_id; /* èŠ‚ç‚¹æ ‡è¯†ç¬¦ */ â€¦ } pg_data_t; 2.å†…å­˜åŒºåŸŸ å†…æ ¸å®šä¹‰å†…å­˜èŠ‚ç‚¹åŒºåŸŸ\n// include/linux/mmzone.h enum zone_type { #ifdef CONFIG_ZONE_DMA ZONE_DMA, // ç›´æ¥å†…å­˜è®¿é—®åŒºåŸŸ #endif #ifdef CONFIG_ZONE_DMA32 ZONE_DMA32, #endif // å†…æ ¸è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯çº¿æ€§æ˜ å°„çš„å…³ç³»ï¼Œå³è™šæ‹Ÿåœ°å€ =ï¼ˆç‰©ç†åœ°å€ + å¸¸é‡ï¼‰ ZONE_NORMAL, // ç›´æ¥æ˜ å°„åŒºåŸŸ #ifdef CONFIG_HIGHMEM ZONE_HIGHMEM, // é«˜ç«¯å†…å­˜åŒºåŸŸ #endif ZONE_MOVABLE, // å¯ç§»åŠ¨åŒºåŸŸ #ifdef CONFIG_ZONE_DEVICE ZONE_DEVICE, // è®¾å¤‡åŒºåŸŸ #endif __MAX_NR_ZONES }; æ¯ä¸ªå†…å­˜åŒºåŸŸç”¨ä¸€ä¸ªzoneç»“æ„ä½“æè¿°\n// include/linux/mmzone.h struct zone { unsigned long watermark[NR_WMARK]; /* é¡µåˆ†é…å™¨ä½¿ç”¨çš„æ°´çº¿ */ â€¦ long lowmem_reserve[MAX_NR_ZONES]; /* é¡µåˆ†é…å™¨ä½¿ç”¨ï¼Œå½“å‰åŒºåŸŸä¿ç•™å¤šå°‘é¡µä¸èƒ½å€Ÿç»™ é«˜çš„åŒºåŸŸç±»å‹ */ â€¦ struct pglist_data *zone_pgdat; /* æŒ‡å‘å†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹ */ struct per_cpu_pageset __percpu *pageset; /* æ¯å¤„ç†å™¨é¡µé›†åˆ */ â€¦ unsigned long zone_start_pfn; /* å½“å‰åŒºåŸŸçš„èµ·å§‹ç‰©ç†é¡µå· */ unsigned long managed_pages; /* ä¼™ä¼´åˆ†é…å™¨ç®¡ç†çš„ç‰©ç†é¡µçš„æ•°é‡ */ unsigned long spanned_pages; /* å½“å‰åŒºåŸŸè·¨è¶Šçš„æ€»é¡µæ•°ï¼ŒåŒ…æ‹¬ç©ºæ´ */ unsigned long present_pages; /* å½“å‰åŒºåŸŸå­˜åœ¨çš„ç‰©ç†é¡µçš„æ•°é‡ï¼Œä¸åŒ…æ‹¬ç©ºæ´ */ const char *name; /* åŒºåŸŸåç§° */ â€¦ struct free_area free_area[MAX_ORDER]; /* ä¸åŒé•¿åº¦çš„ç©ºé—²åŒºåŸŸ */ â€¦ } 3.ç‰©ç†é¡µ æ¯ä¸ªç‰©ç†é¡µå¯¹åº”ä¸€ä¸ªpageç»“æ„ä½“ï¼Œç§°ä¸ºé¡µæè¿°ç¬¦ï¼Œå†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹çš„æˆå‘˜node_mem_mapæŒ‡å‘è¯¥å†…å­˜èŠ‚ç‚¹åŒ…å«çš„æ‰€æœ‰ç‰©ç†é¡µçš„é¡µæè¿°ç¬¦æ³¨å†Œçš„æ•°ç»„ã€‚ ç»“æ„ä½“pageæˆå‘˜flagså¸ƒå±€ | [SECTION] | [NODE] | ZONE | [LAST_CPUPID] | â€¦ | FLAGS | SECTIONæ˜¯ç¨€ç–å†…å­˜æ¨¡å‹ä¸­çš„æ®µç¼–å·ï¼ŒNODEæ˜¯èŠ‚ç‚¹ç¼–å·ï¼ŒZONEæ˜¯åŒºåŸŸç±»å‹ï¼ŒFLAGSæ˜¯æ ‡å¿—ä½ å¤´æ–‡ä»¶include/linux/mm_types.hå®šä¹‰äº†pageç»“æ„ä½“\n// include/linux/mm.h // å¾—åˆ°ç‰©ç†é¡µæ‰€å±çš„å†…å­˜èŠ‚ç‚¹çš„ç¼–å· static inline int page_to_nid(const struct page *page) { return (page-\u003eflags \u003e\u003e NODES_PGSHIFT) \u0026 NODES_MASK; } // å¾—åˆ°ç‰©ç†é¡µæ‰€å±çš„å†…å­˜åŒºåŸŸçš„ç±»å‹ static inline enum zone_type page_zonenum(const struct page *page) { return (page-\u003eflags \u003e\u003e ZONES_PGSHIFT) \u0026 ZONES_MASK; } 3.6 å¼•å¯¼å†…å­˜åˆ†é…å™¨ åœ¨å†…æ ¸åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­éœ€è¦åˆ†é…å†…å­˜ï¼Œå†…æ ¸æä¾›äº†ä¸´æ—¶çš„å¼•å¯¼å†…å­˜åˆ†é…å™¨ï¼Œåœ¨é¡µåˆ†é…å™¨å’Œå—åˆ†é…å™¨åˆå§‹åŒ–å®Œæ¯•åï¼ŒæŠŠç©ºé—²çš„ç‰©ç†é¡µäº¤ç»™é¡µåˆ†é…å™¨ç®¡ç†ï¼Œä¸¢å¼ƒå¼•å¯¼å†…å­˜åˆ†é…å™¨ï¼Œå¼€å¯é…ç½®å®CONFIG_NO_BOOTMEMï¼Œmemblockå°±ä¼šå–ä»£bootmemã€‚ 3.6.1 bootmemåˆ†é…å™¨ 3.6.2 memblockåˆ†é…å™¨ 1.æ•°æ®ç»“æ„ memblockåˆ†é…å™¨æ•°æ®ç»“æ„\n// include/linux/memblock.h struct memblock { bool bottom_up; /* è¡¨ç¤ºåˆ†é…å†…å­˜çš„æ–¹å¼ æ˜¯ä»ä¸‹å‘ä¸Šçš„æ–¹å‘ï¼Ÿ */ phys_addr_t current_limit; // å¯åˆ†é…å†…å­˜çš„æœ€å¤§ç‰©ç†åœ°å€ struct memblock_type memory; // å­˜ç±»å‹ï¼ˆåŒ…æ‹¬å·²åˆ†é…çš„å†…å­˜å’Œæœªåˆ†é…çš„å†…å­˜ï¼‰ struct memblock_type reserved; // é¢„ç•™ç±»å‹ï¼ˆå·²åˆ†é…çš„å†…å­˜ï¼‰ #ifdef CONFIG_HAVE_MEMBLOCK_PHYS_MAP struct memblock_type physmem; // ç‰©ç†å†…å­˜ç±»å‹ #endif }; å†…å­˜å—ç±»å‹çš„æ•°æ®ç»“æ„\n// include/linux/memblock.h struct memblock_type { unsigned long cnt; /* å†…å­˜å—åŒºåŸŸæ•°é‡ */ unsigned long max; /* å·²åˆ†é…æ•°ç»„çš„å¤§å° */ phys_addr_t total_size; /* å†…å­˜å—åŒºåŸŸçš„æ€»é•¿åº¦ æ‰€æœ‰åŒºåŸŸçš„é•¿åº¦ */ struct memblock_region *regions; // æŒ‡å‘å†…å­˜å—åŒºåŸŸæ•°ç»„ char *name; // å­˜å—ç±»å‹çš„åç§° }; å†…å­˜å—åŒºåŸŸçš„æ•°æ®ç»“æ„\n// include/linux/memblock.h struct memblock_region { phys_addr_t base; // èµ·å§‹ç‰©ç†åœ°å€ phys_addr_t size; // é•¿åº¦ unsigned long flags; // æ ‡å¿— MEMBLOCK_NONEæˆ–å…¶ä»–æ ‡å¿— #ifdef CONFIG_HAVE_MEMBLOCK_NODE_MAP int nid; // èŠ‚ç‚¹ç¼–å· #endif }; /* memblockæ ‡å¿—ä½çš„å®šä¹‰. */ enum { MEMBLOCK_NONE = 0x0, /* æ— ç‰¹æ®Šè¦æ±‚ */ MEMBLOCK_HOTPLUG = 0x1, /* å¯çƒ­æ’æ‹”åŒºåŸŸ */ MEMBLOCK_MIRROR = 0x2, /* é•œåƒåŒºåŸŸ */ MEMBLOCK_NOMAP = 0x4, /* ä¸æ·»åŠ åˆ°å†…æ ¸ç›´æ¥æ˜ å°„ */ }; 2.åˆå§‹åŒ– æºæ–‡ä»¶â€œmm/memblock.câ€å®šä¹‰äº†å…¨å±€å˜é‡memblockï¼ŒæŠŠæˆå‘˜bottom_upåˆå§‹åŒ–ä¸ºå‡ï¼Œè¡¨ç¤ºä»é«˜åœ°å€å‘ä¸‹åˆ†é…ã€‚ ARM64å†…æ ¸åˆå§‹åŒ–memblockåˆ†é…å™¨çš„è¿‡ç¨‹æ˜¯ï¼š ï¼ˆ1ï¼‰è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹â€œ/memoryâ€ï¼ŒæŠŠæ‰€æœ‰ç‰©ç†å†…å­˜èŒƒå›´æ·»åŠ åˆ°memblock. memoryï¼Œå…·ä½“è¿‡ç¨‹å‚è€ƒ3.6.3èŠ‚ã€‚ ï¼ˆ2ï¼‰åœ¨å‡½æ•°arm64_memblock_initä¸­åˆå§‹åŒ–memblockã€‚ arm64_memblock_initä¸»è¦æµç¨‹ï¼š\nstart_kernel() â€“\u003e setup_arch() â€“\u003e arm64_memblock_init()\n// arch/arm64/mm/init.c void __init arm64_memblock_init(void) { const s64 linear_region_size = -(s64)PAGE_OFFSET; // è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä¸­èŠ‚ç‚¹â€œ/chosenâ€çš„å±æ€§â€œlinux,usable-memory-rangeâ€ï¼Œ // å¾—åˆ°å¯ç”¨å†…å­˜çš„èŒƒå›´ï¼ŒæŠŠè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„ç‰©ç†å†…å­˜èŒƒå›´ä»memblock.memoryä¸­åˆ é™¤ã€‚ fdt_enforce_memory_region(); // å±€å˜é‡memstart_addrè®°å½•å†…å­˜çš„èµ·å§‹ç‰©ç†åœ°å€ memstart_addr = round_down(memblock_start_of_DRAM(), ARM64_MEMSTART_ALIGN); // æŠŠçº¿æ€§æ˜ å°„åŒºåŸŸä¸èƒ½è¦†ç›–çš„ç‰©ç†å†…å­˜èŒƒå›´ä»memblock.memoryä¸­åˆ é™¤ memblock_remove(max_t(u64, memstart_addr + linear_region_size, __pa_symbol(_end)), ULLONG_MAX); if (memstart_addr + linear_region_size \u003c memblock_end_of_DRAM()) { /* ç¡®ä¿memstart_addrä¸¥æ ¼å¯¹é½ */ memstart_addr = round_up(memblock_end_of_DRAM() - linear_region_size, ARM64_MEMSTART_ALIGN); memblock_remove(0, memstart_addr); } if (memory_limit != (phys_addr_t)ULLONG_MAX) { memblock_mem_limit_remove_map(memory_limit); memblock_add(__pa_symbol(_text), (u64)(_end - _text)); } â€¦ // æŠŠå†…æ ¸é•œåƒå ç”¨çš„ç‰©ç†å†…å­˜èŒƒå›´æ·»åŠ åˆ°memblock.reserved memblock_reserve(__pa_symbol(_text), _end - _text); â€¦ // ä»è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å†…å­˜ä¿ç•™åŒºåŸŸå’ŒèŠ‚ç‚¹â€œ/reserved-memoryâ€ // è¯»å–ä¿ç•™çš„ç‰©ç†å†…å­˜èŒƒå›´ï¼Œæ·»åŠ åˆ°memblock.reservedä¸­ early_init_fdt_scan_reserved_mem(); â€¦ } 3.ç¼–ç¨‹æ¥å£ memblockåˆ†é…å™¨æ¥å£\n// æ·»åŠ æ–°çš„å†…å­˜å—åŒºåŸŸåˆ°memblock.memoryä¸­ memblock_add // åˆ é™¤å†…å­˜å—åŒºåŸŸ memblock_remove // åˆ†é…å†…å­˜ memblock_alloc // é‡Šæ”¾å†…å­˜ memblock_free 4.ç®—æ³• memblockåˆ†é…å™¨æŠŠæ‰€æœ‰å†…å­˜æ·»åŠ åˆ°memblock.memoryä¸­ï¼ŒæŠŠåˆ†é…å‡ºå»çš„å†…å­˜å—æ·»åŠ åˆ°memblock.reservedä¸­ å‡½æ•°memblock_allocè´Ÿè´£åˆ†é…å†…å­˜ï¼Œä¸»è¦ä¸ºå‡½æ•°memblock_alloc_range_nid (1)memblock_find_in_range_nodeå‡½æ•°memblock_find_in_range_node (2)memblock_reserveå‡½æ•°æŠŠåˆ†é…å‡ºå»çš„å†…å­˜å—åŒºåŸŸæ·»åŠ åˆ°memblock.reservedä¸­ \\\n3.6.3 ç‰©ç†å†…å­˜ä¿¡æ¯ å†…æ ¸åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¼•å¯¼å†…å­˜åˆ†é…å™¨è´Ÿè´£åˆ†é…å†…å­˜ã€‚ARM64æ¶æ„ä½¿ç”¨æ‰å¹³è®¾å¤‡æ ‘ï¼ˆFlattened Device Treeï¼ŒFDTï¼‰æè¿°æ¿å¡çš„ç¡¬ä»¶ä¿¡æ¯ã€‚é©±åŠ¨å¼€å‘è€…ç¼–å†™è®¾å¤‡æ ‘æºæ–‡ä»¶ï¼ˆDevice Tree Sourceï¼ŒDTSï¼‰ï¼Œå­˜æ”¾åœ¨ç›®å½•â€œarch/arm64/boot/dtsâ€ä¸‹ï¼Œç„¶åä½¿ç”¨è®¾å¤‡æ ‘ç¼–è¯‘å™¨ï¼ˆDevice Tree Compilerï¼ŒDTCï¼‰æŠŠè®¾å¤‡æ ‘æºæ–‡ä»¶è½¬æ¢æˆè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆDevice Tree Blobï¼ŒDTBï¼‰ï¼Œæ¥ç€æŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶å†™åˆ°å­˜å‚¨è®¾å¤‡ä¸Šã€‚è®¾å¤‡å¯åŠ¨æ—¶ï¼Œå¼•å¯¼ç¨‹åºæŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜ä¸­ï¼Œå¼•å¯¼å†…æ ¸çš„æ—¶å€™æŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶çš„èµ·å§‹åœ°å€ä¼ ç»™å†…æ ¸ï¼Œå†…æ ¸è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶åå¾—åˆ°ç¡¬ä»¶ä¿¡æ¯ \\\nè®¾å¤‡æ ‘æºæ–‡ä»¶.dts,æè¿°ç‰©ç†å†…å­˜å¸ƒå±€\n/ { // â€œ/â€æ ¹èŠ‚ç‚¹ #address-cells = \u003c2\u003e; // åœ°å€çš„å•å…ƒæ•°é‡ #size-cells = \u003c2\u003e; // ä¸€ä¸ªé•¿åº¦çš„å•å…ƒæ•°é‡ memory@80000000 { // æè¿°ç‰©ç†å†…å­˜å¸ƒå±€ device_type = \"memory\"; // è®¾å¤‡ç±»å‹ // ç‰©ç†å†…å­˜èŒƒå›´ reg = \u003c0x00000000 0x80000000 0 0x80000000\u003e, \u003c0x00000008 0x80000000 0 0x80000000\u003e; }; }; å†…æ ¸åœ¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨å‡½æ•°early_init_dt_scan_nodesä»¥è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»è€Œå¾—åˆ°ç‰©ç†å†…å­˜ä¿¡æ¯ \\\nstart_kernel() â€“\u003e setup_arch() â€“\u003e setup_machine_fdt() â€“\u003e early_init_dt_scan_nodes()\n// drivers/of/fdt.c void __init early_init_dt_scan_nodes(void) { â€¦ /* åˆå§‹åŒ–size-cellså’Œaddress-cellsä¿¡æ¯ */ // early_init_dt_scan_rootï¼Œè§£ææ ¹èŠ‚ç‚¹çš„å±æ€§â€œ#address-cellsâ€å¾—åˆ°åœ°å€çš„å•å…ƒæ•°é‡ï¼Œ // ä¿å­˜åœ¨å…¨å±€å˜é‡dt_root_addr_cellsä¸­ï¼›è§£ææ ¹èŠ‚ç‚¹çš„å±æ€§â€œ#size-cellsâ€å¾—åˆ° // é•¿åº¦çš„å•å…ƒæ•°é‡ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡dt_root_size_cellsä¸­ of_scan_flat_dt(early_init_dt_scan_root, NULL); /* è°ƒç”¨å‡½æ•°early_init_dt_add_memory_archè®¾ç½®å†…å­˜ */ of_scan_flat_dt(early_init_dt_scan_memory, NULL); } early_init_dt_scan_memoryè§£æmemoryèŠ‚ç‚¹\n// drivers/of/fdt.c int __init early_init_dt_scan_memory(unsigned long node, const char *uname, int depth, void *data) { // è§£æèŠ‚ç‚¹çš„å±æ€§â€œdevice_typeâ€ const char *type = of_get_flat_dt_prop(node, \"device_type\", NULL); const __be32 *reg, *endp; int l; â€¦ /* åªæ‰«æ \"memory\" èŠ‚ç‚¹ */ if (type == NULL) { /* å¦‚æœæ²¡æœ‰å±æ€§â€œdevice_typeâ€ï¼Œåˆ¤æ–­èŠ‚ç‚¹åç§°æ˜¯ä¸æ˜¯â€œmemory@0â€*/ if (!IS_ENABLED(CONFIG_PPC32) || depth != 1 || strcmp(uname, \"memory@0\") != 0) return 0; } else if (strcmp(type, \"memory\") != 0) // æè¿°ç‰©ç†å†…å­˜ä¿¡æ¯ return 0; reg = of_get_flat_dt_prop(node, \"linux,usable-memory\", \u0026l); if (reg == NULL) reg = of_get_flat_dt_prop(node, \"reg\", \u0026l); if (reg == NULL) return 0; endp = reg + (l / sizeof(__be32)); â€¦ while ((endp - reg) \u003e= (dt_root_addr_cells + dt_root_size_cells)) { u64 base, size; base = dt_mem_next_cell(dt_root_addr_cells, \u0026reg); size = dt_mem_next_cell(dt_root_size_cells, \u0026reg); if (size == 0) continue; â€¦ early_init_dt_add_memory_arch(base, size); â€¦ } return 0; } è§£æå‡ºæ¯å—å†…å­˜çš„èµ·å§‹åœ°å€å’Œå¤§å°åï¼Œè°ƒç”¨å‡½æ•°early_init_dt_add_memory_arch\n// drivers/of/fdt.c void __init __weak early_init_dt_add_memory_arch(u64 base, u64 size) { const u64 phys_offset = MIN_MEMBLOCK_ADDR; if (!PAGE_ALIGNED(base)) { if (size \u003c PAGE_SIZE - (base \u0026 ~PAGE_MASK)) { pr_warn(\"Ignoring memory block 0x%llx - 0x%llx\\n\", base, base + size); return; } size -= PAGE_SIZE - (base \u0026 ~PAGE_MASK); base = PAGE_ALIGN(base); } size \u0026= PAGE_MASK; if (base \u003e MAX_MEMBLOCK_ADDR) { pr_warning(\"Ignoring memory block 0x%llx - 0x%llx\\n\", base, base + size); return; } if (base + size - 1 \u003e MAX_MEMBLOCK_ADDR) { pr_warning(\"Ignoring memory range 0x%llx - 0x%llx\\n\", ((u64)MAX_MEMBLOCK_ADDR) + 1, base + size); size = MAX_MEMBLOCK_ADDR - base + 1; } if (base + size \u003c phys_offset) { pr_warning(\"Ignoring memory block 0x%llx - 0x%llx\\n\", base, base + size); return; } if (base \u003c phys_offset) { pr_warning(\"Ignoring memory range 0x%llx - 0x%llx\\n\", base, phys_offset); size -= phys_offset - base; base = phys_offset; } // æŠŠç‰©ç†å†…å­˜èŒƒå›´æ·»åŠ åˆ°memblock.memory memblock_add(base, size); } 3.7 ä¼™ä¼´åˆ†é…å™¨ å†…æ ¸åˆå§‹åŒ–å®Œæ¯•åï¼Œä½¿ç”¨é¡µåˆ†é…å™¨ç®¡ç†ç‰©ç†é¡µï¼Œå½“å‰ä½¿ç”¨çš„é¡µåˆ†é…å™¨æ˜¯ä¼™ä¼´åˆ†é…å™¨buddy allocato\n3.7.1 åŸºæœ¬çš„ä¼™ä¼´åˆ†é…å™¨ è¿ç»­çš„ç‰©ç†é¡µç§°ä¸ºé¡µå—ï¼ˆpage blockï¼‰ã€‚é˜¶ï¼ˆorderï¼‰æ˜¯ä¼™ä¼´åˆ†é…å™¨çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯é¡µçš„æ•°é‡å•ä½ï¼Œ2nä¸ªè¿ç»­é¡µç§°ä¸ºné˜¶é¡µå—ã€‚æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„ä¸¤ä¸ªné˜¶é¡µå—ç§°ä¸ºä¼™ä¼´ï¼ˆbuddyï¼‰ ä¼™ä¼´åˆ†é…å™¨åˆ†é…å’Œé‡Šæ”¾ç‰©ç†é¡µçš„æ•°é‡å•ä½æ˜¯é˜¶\n3.7.2 åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨ 1.æ•°æ®ç»“æ„ åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨ä¸“æ³¨äºæŸä¸ªå†…å­˜èŠ‚ç‚¹çš„æŸä¸ªåŒºåŸŸã€‚å†…å­˜åŒºåŸŸçš„ç»“æ„ä½“æˆå‘˜free_areaç”¨æ¥ç»´æŠ¤ç©ºé—²é¡µå—ï¼Œæ•°ç»„ä¸‹æ ‡å¯¹åº”é¡µå—çš„é˜¶æ•°ã€‚ç»“æ„ä½“free_areaçš„æˆå‘˜free_listæ˜¯ç©ºé—²é¡µå—çš„é“¾è¡¨nr_freeæ˜¯ç©ºé—²é¡µå—çš„æ•°é‡ã€‚å†…å­˜åŒºåŸŸçš„ç»“æ„ä½“æˆå‘˜managed_pagesæ˜¯ä¼™ä¼´åˆ†é…å™¨ç®¡ç†çš„ç‰©ç†é¡µçš„æ•°é‡ï¼Œä¸åŒ…æ‹¬å¼•å¯¼å†…å­˜åˆ†é…å™¨åˆ†é…çš„ç‰©ç†é¡µ\ninclude/linux/mmzone.h struct zone { â€¦ /* ä¸åŒé•¿åº¦çš„ç©ºé—²åŒºåŸŸ */ struct free_area free_area[MAX_ORDER]; // MAX_ORDERæ˜¯æœ€å¤§é˜¶æ•° â€¦ unsigned long managed_pages; â€¦ } ____cacheline_internodealigned_in_smp; struct free_area { struct list_head free_list[MIGRATE_TYPES]; unsigned long nr_free; }; // include/linux/mmzone.h /* ç©ºé—²å†…å­˜ç®¡ç†-åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨ */ #ifndef CONFIG_FORCE_MAX_ZONEORDER #define MAX_ORDER 11 #else #define MAX_ORDER CONFIG_FORCE_MAX_ZONEORDER #endif 2ï¼æ ¹æ®åˆ†é…æ ‡å¿—å¾—åˆ°é¦–é€‰åŒºåŸŸç±»å‹ 3. å¤‡ç”¨åŒºåŸŸåˆ—è¡¨ 4ï¼åŒºåŸŸæ°´çº¿ 5ï¼é˜²æ­¢è¿‡åº¦å€Ÿç”¨ 3.7.3ã€€æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„ 3.7.4ã€€æ¯å¤„ç†å™¨é¡µé›†åˆ å†…æ ¸é’ˆå¯¹åˆ†é…å•é¡µåšäº†æ€§èƒ½ä¼˜åŒ–ï¼Œä¸ºäº†å‡å°‘å¤„ç†å™¨ä¹‹é—´çš„é”ç«äº‰ï¼Œåœ¨å†…å­˜åŒºåŸŸå¢åŠ  1ä¸ªæ¯å¤„ç†å™¨é¡µé›†åˆã€‚\ninclude/linux/mmzone.h struct zone { â€¦ struct per_cpu_pageset __percpu *pageset; /* åœ¨æ¯ä¸ªå¤„ç†å™¨ä¸Šæœ‰ä¸€ä¸ªé¡µé›†åˆ */ â€¦ } ____cacheline_internodealigned_in_smp; struct per_cpu_pageset { struct per_cpu_pages pcp; â€¦ }; struct per_cpu_pages { int count; /* é“¾è¡¨é‡Œé¢é¡µçš„æ•°é‡ */ int high; /* å¦‚æœé¡µçš„æ•°é‡è¾¾åˆ°é«˜æ°´çº¿ï¼Œéœ€è¦è¿”è¿˜ç»™ä¼™ä¼´åˆ†é…å™¨ */ int batch; /* æ‰¹é‡æ·»åŠ æˆ–åˆ é™¤çš„é¡µæ•°é‡ */ struct list_head lists[MIGRATE_PCPTYPES]; /* æ¯ç§è¿ç§»ç±»å‹ä¸€ä¸ªé¡µé“¾è¡¨ */ }; 3.7.5ã€€åˆ†é…é¡µ 1ï¼åˆ†é…æ¥å£ é¡µåˆ†é…å™¨åˆ†é…é¡µæ¥å£\n// æ±‚åˆ†é…ä¸€ä¸ªé˜¶æ•°ä¸ºorderçš„é¡µå—ï¼Œè¿”å›ä¸€ä¸ªpageå®ä¾‹ alloc_pages(gfp_mask, order) // åœ¨é˜¶æ•°ä¸º0æƒ…å†µä¸‹çš„ç®€åŒ–å½¢å¼ï¼Œåªåˆ†é…ä¸€é¡µ alloc_page(gfp_mask) // åªèƒ½ä»ä½ç«¯å†…å­˜åŒºåŸŸåˆ†é…é¡µï¼Œå¹¶ä¸”è¿”å›è™šæ‹Ÿåœ°å€ __get_free_pages(gfp_mask, order) // åœ¨é˜¶æ•°ä¸º0æƒ…å†µä¸‹çš„ç®€åŒ–å½¢å¼ï¼Œåªåˆ†é…ä¸€é¡µ __get_free_page(gfp_mask) // å‚æ•°gfp_maskè®¾ç½®äº†æ ‡å¿—ä½__GFP_ZEROä¸”é˜¶æ•°ä¸º0æƒ…å†µä¸‹çš„ç®€åŒ–å½¢å¼ï¼Œåªåˆ†é…ä¸€é¡µï¼Œå¹¶ä¸”ç”¨é›¶åˆå§‹åŒ– get_zeroed_page(gfp_mask) 2ï¼åˆ†é…æ ‡å¿—ä½ åˆ†é…é¡µçš„å‡½æ•°éƒ½å¸¦ä¸€ä¸ªåˆ†é…æ ‡å¿—ä½å‚æ•°ï¼Œåˆ†é…æ ‡å¿—ä½åˆ†ä¸ºä»¥ä¸‹5ç±» (1)åŒºåŸŸä¿®é¥°ç¬¦\n(2)é¡µç§»åŠ¨æ€§å’Œä½ç½®æç¤º\n(3)æ°´çº¿ä¿®é¥°ç¬¦\n(4)å›æ”¶ä¿®é¥°ç¬¦\n(5)è¡ŒåŠ¨ä¿®é¥°ç¬¦\n3ï¼å¤åˆé¡µ å¦‚æœè®¾ç½®äº†æ ‡å¿—ä½__GFP_COMPå¹¶ä¸”åˆ†é…äº†ä¸€ä¸ªé˜¶æ•°å¤§äº0çš„é¡µå—ï¼Œé¡µåˆ†é…å™¨ä¼šæŠŠé¡µå—ç»„æˆå¤åˆé¡µï¼ˆcompound pageï¼‰ã€‚å¤åˆé¡µæœ€å¸¸è§çš„ç”¨å¤„æ˜¯åˆ›å»ºå·¨å‹é¡µã€‚ å¤åˆé¡µçš„ç¬¬ä¸€é¡µå«é¦–é¡µï¼ˆhead pageï¼‰ï¼Œå…¶ä»–é¡µéƒ½å«å°¾é¡µï¼ˆtail pageï¼‰\nå¤åˆé¡µçš„ç»“æ„ 4ï¼å¯¹é«˜é˜¶åŸå­åˆ†é…çš„ä¼˜åŒ–å¤„ç† 5ï¼æ ¸å¿ƒå‡½æ•°çš„å®ç° 3.7.6ã€€é‡Šæ”¾é¡µ é¡µåˆ†é…å™¨æä¾›äº†ä»¥ä¸‹é‡Šæ”¾é¡µçš„æ¥å£ ï¼ˆ1ï¼‰void __free_pages(struct page *page, unsigned int order)ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„pageå®ä¾‹çš„åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é˜¶æ•° ï¼ˆ2ï¼‰void free_pages(unsigned long addr, unsigned int order)ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„èµ·å§‹å†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é˜¶æ•° \\\n3.8ã€€å—åˆ†é…å™¨ Linuxå†…æ ¸æä¾›äº†å—åˆ†é…å™¨ï¼Œå¤„ç†å°å—å†…å­˜åˆ†é…é—®é¢˜ï¼Œæœ€æ—©ä¸ºSLABåˆ†é…å™¨ã€‚å¤§é‡ç‰©ç†å†…å­˜çš„å¤§å‹è®¡ç®—æœºä¸ŠSLUBåˆ†é…å™¨ï¼Œå°å†…å­˜çš„åµŒå…¥å¼è®¾å¤‡ä¸ŠSLOB \\\n3.8.1 ç¼–ç¨‹æ¥å£ 3ç§å—åˆ†é…å™¨æä¾›äº†ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ï¼Œå—åˆ†é…å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºäº†ä¸€äº›é€šç”¨çš„å†…å­˜ç¼“å­˜ï¼Œä»æ™®é€šåŒºåŸŸåˆ†é…é¡µçš„å†…å­˜ç¼“å­˜çš„åç§°æ˜¯kmalloc-ï¼ŒDMAåŒºåŸŸåˆ†é…é¡µçš„å†…å­˜ç¼“å­˜çš„åç§°æ˜¯dma-kmalloc-ï¼Œæ‰§è¡Œå‘½ä»¤cat /proc/slabinfoå¯ä»¥çœ‹åˆ°è¿™äº›é€šç”¨çš„å†…å­˜ç¼“å­˜ \\\n// åˆ†é…å†…å­˜ void *kmalloc(size_t size, gfp_t flags); // é‡æ–°åˆ†é…å†…å­˜ void *krealloc(const void *p, size_t new_size, gfp_t flags); // é‡Šæ”¾å†…å­˜ void kfree(const void *objp); åˆ›å»ºä¸“ç”¨çš„å†…å­˜ç¼“å­˜\n// åˆ›å»ºå†…å­˜ç¼“å­˜ struct kmem_cache *kmem_cache_create(const char *name, size_t size, size_t align, unsigned long flags, void (*ctor)(void *)); // ä»æŒ‡å®šçš„å†…å­˜ç¼“å­˜åˆ†é…å¯¹è±¡ void *kmem_cache_alloc(struct kmem_cache *cachep, gfp_t flags); // é‡Šæ”¾å¯¹è±¡ void kmem_cache_free(struct kmem_cache *cachep, void *objp); // é”€æ¯å†…å­˜ç¼“å­˜ void kmem_cache_destroy(struct kmem_cache *s); 3.8.2 SLABåˆ†é…å™¨ 1.æ•°æ®ç»“æ„ å†…å­˜ç¼“å­˜çš„æ•°æ®ç»“æ„ ï¼ˆ1ï¼‰æ¯ä¸ªå†…å­˜ç¼“å­˜å¯¹åº”ä¸€ä¸ªkmem_cacheå®ä¾‹ \\\nï¼ˆ2ï¼‰æ¯ä¸ªå†…å­˜èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªkmem_cache_nodeå®ä¾‹\npageç»“æ„ä½“çš„æˆå‘˜ 1)flagsè®¾ç½®æ ‡å¿—ä½PG_slabï¼Œè¡¨ç¤ºé¡µå±äºSLABåˆ†é…å™¨ 2)s_memå­˜æ”¾slabç¬¬ä¸€ä¸ªå¯¹è±¡çš„åœ°å€ 3)activeè¡¨ç¤ºå·²åˆ†é…å¯¹è±¡çš„æ•°é‡ 4)lruä½œä¸ºé“¾è¡¨èŠ‚ç‚¹åŠ å…¥å…¶ä¸­ä¸€æ¡slabé“¾è¡¨ 5)slab_cacheæŒ‡å‘kmem_cacheå®ä¾‹ 6)freelistæŒ‡å‘ç©ºé—²å¯¹è±¡é“¾è¡¨ \\\nï¼ˆ3ï¼‰kmem_cacheå®ä¾‹çš„æˆå‘˜cpu_slabæŒ‡å‘array_cacheå®ä¾‹ï¼Œ\n2.ç©ºé—²å¯¹è±¡é“¾è¡¨ æ¯ä¸ªslabéœ€è¦ä¸€ä¸ªç©ºé—²å¯¹è±¡é“¾è¡¨ï¼Œä»è€ŒæŠŠæ‰€æœ‰ç©ºé—²å¯¹è±¡é“¾æ¥èµ·æ¥ï¼Œç©ºé—²å¯¹è±¡é“¾è¡¨æ˜¯ç”¨æ•°ç»„å®ç°çš„ï¼Œpage-\u003efreelistæŒ‡å‘ç©ºé—²å¯¹è±¡é“¾è¡¨\nä½¿ç”¨å¯¹è±¡å­˜æ”¾ç©ºé—²å¯¹è±¡é“¾è¡¨-åˆå§‹çŠ¶æ€ ä½¿ç”¨å¯¹è±¡å­˜æ”¾ç©ºé—²å¯¹è±¡é“¾è¡¨-åˆ†é…æœ€åä¸€ä¸ªç©ºé—²å¯¹è±¡ ç©ºé—²å¯¹è±¡é“¾è¡¨åœ¨slabå¤–é¢ 3.è®¡ç®—slabé•¿åº¦ å‡½æ•°calculate_slab_orderè´Ÿè´£è®¡ç®—slabé•¿åº¦ï¼Œä»0é˜¶åˆ°kmalloc()å‡½æ•°æ”¯æŒçš„æœ€å¤§é˜¶æ•°ï¼ˆKMALLOC_MAX_ORDERï¼‰\n4.ç€è‰² 5ï¼æ¯å¤„ç†å™¨æ•°ç»„ç¼“å­˜ å†…å­˜ç¼“å­˜ä¸ºæ¯ä¸ªå¤„ç†å™¨åˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„ç¼“å­˜ï¼ˆç»“æ„ä½“array_cacheï¼‰ã€‚é‡Šæ”¾å¯¹è±¡æ—¶ï¼ŒæŠŠå¯¹è±¡å­˜æ”¾åˆ°å½“å‰å¤„ç†å™¨å¯¹åº”çš„æ•°ç»„ç¼“å­˜ä¸­\næ¯å¤„ç†å™¨æ•°ç»„ç¼“å†² 6ï¼å¯¹NUMAçš„æ”¯æŒ SLABåˆ†é…å™¨æ”¯æŒNUMA 7ï¼å†…å­˜ç¼“å­˜åˆå¹¶ å‡å°‘å†…å­˜å¼€é”€å’Œå¢åŠ å¯¹è±¡çš„ç¼“å­˜çƒ­åº¦ï¼Œå—åˆ†é…å™¨ä¼šåˆå¹¶ç›¸ä¼¼çš„å†…å­˜ç¼“å­˜\n8.å›æ”¶å†…å­˜ æ‰€æœ‰å¯¹è±¡ç©ºé—²çš„slabï¼Œæ²¡æœ‰ç«‹å³é‡Šæ”¾ï¼Œè€Œæ˜¯æ”¾åœ¨ç©ºé—²slabé“¾è¡¨ä¸­ã€‚åªæœ‰å†…å­˜èŠ‚ç‚¹ä¸Šç©ºé—²å¯¹è±¡çš„æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œæ‰å¼€å§‹å›æ”¶ç©ºé—²slabï¼Œç›´åˆ°ç©ºé—²å¯¹è±¡çš„æ•°é‡å°äºæˆ–ç­‰äºé™åˆ¶ ç»“æ„ä½“kmem_cache_nodeçš„æˆå‘˜slabs_freeæ˜¯ç©ºé—²slabé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œæˆå‘˜free_objectsæ˜¯ç©ºé—²å¯¹è±¡çš„æ•°é‡ï¼Œæˆå‘˜free_limitæ˜¯ç©ºé—²å¯¹è±¡çš„æ•°é‡é™åˆ¶ \\\nå›æ”¶ç©ºé—²slab 3.8.3ã€€SLUBåˆ†é…å™¨ 1ï¼æ•°æ®ç»“æ„ SLUBåˆ†é…å™¨å†…å­˜ç¼“å­˜çš„æ•°æ®ç»“æ„ 2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨ ç©ºé—²å¯¹è±¡é“¾è¡¨çš„åˆå§‹çŠ¶æ€ åˆ†é…ä¸€ä¸ªå¯¹è±¡ä»¥åçš„ç©ºé—²å¯¹è±¡é“¾è¡¨ 3ï¼è®¡ç®—slabé•¿åº¦ SLUBåˆ†é…å™¨åœ¨åˆ›å»ºå†…å­˜ç¼“å­˜çš„æ—¶å€™è®¡ç®—äº†ä¸¤ç§slabé•¿åº¦ï¼šæœ€ä¼˜slabå’Œæœ€å°slab\n4ï¼æ¯å¤„ç†å™¨slabç¼“å­˜ SLUBåˆ†é…å™¨çš„æ¯å¤„ç†å™¨slabç¼“å­˜ 5ï¼å¯¹NUMAçš„æ”¯æŒ ï¼ˆ1ï¼‰å†…å­˜ç¼“å­˜é’ˆå¯¹æ¯ä¸ªå†…å­˜èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªkmem_cache_nodeå®ä¾‹ ï¼ˆ2ï¼‰åˆ†é…å¯¹è±¡æ—¶ï¼Œå¦‚æœå½“å‰å¤„ç†å™¨çš„slabç¼“å­˜æ˜¯ç©ºçš„ï¼Œéœ€è¦é‡å¡«å½“å‰å¤„ç†å™¨çš„slabç¼“å­˜ \\\n6.å›æ”¶å†…å­˜ å¯¹äºæ‰€æœ‰å¯¹è±¡ç©ºé—²çš„slabï¼Œå¦‚æœå†…å­˜èŠ‚ç‚¹çš„éƒ¨åˆ†ç©ºé—²slabçš„æ•°é‡å¤§äºæˆ–ç­‰äºæœ€å°éƒ¨åˆ†ç©ºé—²slabæ•°é‡ï¼Œé‚£ä¹ˆç›´æ¥é‡Šæ”¾ï¼Œå¦åˆ™æ”¾åœ¨éƒ¨åˆ†ç©ºé—²slabé“¾è¡¨çš„å°¾éƒ¨\n7.è°ƒè¯• 3.8.4ã€€SLOBåˆ†é…å™¨ 1ï¼æ•°æ®ç»“æ„ SLOBåˆ†é…å™¨å†…å­˜ç¼“å­˜çš„æ•°æ®ç»“æ„ 2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨ ç©ºé—²å¯¹è±¡é“¾è¡¨çš„åˆå§‹çŠ¶æ€ åˆ†é…ä¸€ä¸ªå¯¹è±¡ä»¥åçš„ç©ºé—²å¯¹è±¡é“¾è¡¨ 3ï¼åˆ†é…å¯¹è±¡ åˆ†é…å¯¹è±¡æ—¶ï¼Œæ ¹æ®å¯¹è±¡é•¿åº¦é€‰æ‹©ä¸åŒçš„ç­–ç•¥\n3.9ã€€ä¸è¿ç»­é¡µåˆ†é…å™¨ 3.9.1ã€€ç¼–ç¨‹æ¥å£ ä¸è¿ç»­é¡µåˆ†é…å™¨æä¾›äº†ä»¥ä¸‹ç¼–ç¨‹æ¥å£\n// vmallocå‡½æ•°ï¼šåˆ†é…ä¸è¿ç»­çš„ç‰©ç†é¡µå¹¶ä¸”æŠŠç‰©ç†é¡µæ˜ å°„åˆ°è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ void *vmalloc(unsigned long size); // vfreeå‡½æ•°ï¼šé‡Šæ”¾vmallocåˆ†é…çš„ç‰©ç†é¡µå’Œè™šæ‹Ÿåœ°å€ç©ºé—´ void vfree(const void *addr); // vmapå‡½æ•°ï¼šæŠŠå·²ç»åˆ†é…çš„ä¸è¿ç»­ç‰©ç†é¡µæ˜ å°„åˆ°è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´ // pagesæ˜¯pageæŒ‡é’ˆæ•°ç»„ï¼Œcountæ˜¯pageæŒ‡é’ˆæ•°ç»„å¤§å°ï¼Œflagsæ ‡å¿—ä½ï¼Œproté¡µä¿æŠ¤ä½ void *vmap(struct page **pages, unsigned int count, unsigned long flags, pgprot_t prot); // vunmapå‡½æ•°ï¼šé‡Šæ”¾ä½¿ç”¨vmapåˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´ void vunmap(const void *addr); // kvmallocå‡½æ•°ï¼šå…ˆå°è¯•ä½¿ç”¨kmallocåˆ†é…å†…å­˜å—ï¼Œå¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆä½¿ç”¨vmallocå‡½æ•°åˆ†é…ä¸è¿ç»­çš„ç‰©ç†é¡µ void *kvmalloc(size_t size, gfp_t flags); // kvfreeå‡½æ•°ï¼šå¦‚æœå†…å­˜å—æ˜¯ä½¿ç”¨vmallocåˆ†é…çš„ï¼Œé‚£ä¹ˆä½¿ç”¨vfreeé‡Šæ”¾ï¼Œå¦åˆ™ä½¿ç”¨kfreeé‡Šæ”¾ void kvfree(const void *addr); 3.9.2ã€€æ•°æ®ç»“æ„ ä¸è¿ç»­é¡µåˆ†é…å™¨çš„æ•°æ®ç»“æ„ ä½¿ç”¨vmapå‡½æ•°åˆ†é…è™šæ‹Ÿå†…å­˜åŒºåŸŸ 3.9.3ã€€æŠ€æœ¯åŸç† vmallocè™šæ‹Ÿåœ°å€ç©ºé—´çš„èŒƒå›´æ˜¯[VMALLOC_START, VMALLOC_END)\n// arch/arm64/include/asm/pgtable.h #define VMALLOC_START (MODULES_END) #define VMALLOC_END (PAGE_OFFSET - PUD_SIZE - VMEMMAP_SIZE - SZ_64K) MODULES_ENDæ˜¯å†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€ï¼ŒPAGE_OFFSETæ˜¯çº¿æ€§æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼ŒPUD_SIZEæ˜¯ä¸€ä¸ªé¡µä¸Šå±‚ç›®å½•è¡¨é¡¹æ˜ å°„çš„åœ°å€ç©ºé—´é•¿åº¦ï¼ŒVMEMMAP_SIZEæ˜¯vmemmapåŒºåŸŸçš„é•¿åº¦ã€‚ vmallocè™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ç­‰äºå†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€ã€‚ vmallocè™šæ‹Ÿåœ°å€ç©ºé—´çš„ç»“æŸåœ°å€ç­‰äºï¼ˆçº¿æ€§æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€âˆ’ä¸€ä¸ªé¡µä¸Šå±‚ç›®å½•è¡¨é¡¹æ˜ å°„çš„åœ°å€ç©ºé—´é•¿åº¦âˆ’vmemmapåŒºåŸŸçš„é•¿åº¦âˆ’64KBï¼‰ å‡½æ•°vmallocçš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸º3æ­¥ ï¼ˆ1ï¼‰åˆ†é…è™šæ‹Ÿå†…å­˜åŒºåŸŸ åˆ†é…vm_structå®ä¾‹å’Œvmap_areaå®ä¾‹ ï¼ˆ2ï¼‰ åˆ†é…ç‰©ç†é¡µ vm_structå®ä¾‹çš„æˆå‘˜nr_pageså­˜æ”¾é¡µæ•°nï¼›åˆ†é…pageæŒ‡é’ˆæ•°ç»„ ï¼ˆ3ï¼‰åœ¨å†…æ ¸çš„é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ å†…æ ¸çš„é¡µè¡¨å°±æ˜¯0å·å†…æ ¸çº¿ç¨‹çš„é¡µè¡¨ã€‚0å·å†…æ ¸çº¿ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦æ˜¯å…¨å±€å˜é‡init_taskï¼Œæˆå‘˜active_mmæŒ‡å‘å…¨å±€å˜é‡init_mmï¼Œinit_mmçš„æˆå‘˜pgdæŒ‡å‘é¡µå…¨å±€ç›®å½•swapper_pg_dir\n3.10ã€€æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨ å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯å¤„ç†å™¨å˜é‡ä¸ºæ¯ä¸ªå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªå˜é‡çš„å‰¯æœ¬\n3.10.1ã€€ç¼–ç¨‹æ¥å£ æ¯å¤„ç†å™¨å˜é‡åˆ†ä¸ºé™æ€å’ŒåŠ¨æ€ä¸¤ç§\n1.é™æ€æ¯å¤„ç†å™¨å˜é‡ å®â€œDEFINE_PER_CPU(type, name)â€å®šä¹‰æ™®é€šçš„é™æ€æ¯å¤„ç†å™¨å˜é‡ï¼Œä½¿ç”¨å®â€œDECLARE_PER_CPU(type, name)â€å£°æ˜æ™®é€šçš„é™æ€æ¯å¤„ç†å™¨å˜é‡\n// å®â€œDEFINE_PER_CPU(type, name)â€å±•å¼€ // é™æ€æ¯å¤„ç†å™¨å˜é‡å­˜æ”¾åœ¨â€œ.data..percpuâ€ __attribute__((section(\".data..percpu\"))) __typeof__(type) name 2ï¼åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡ ä¸ºåŠ¨æ€æ¯å¤„ç†å™¨å˜é‡åˆ†é…å†…å­˜çš„å‡½æ•°\n// __alloc_percpu_gfpä¸ºåŠ¨æ€æ¯å¤„ç†å™¨å˜é‡åˆ†é…å†…å­˜ void __percpu *__alloc_percpu_gfp(size_t size, size_t align, gfp_t gfp); // å®alloc_percpu_gfp(type, gfp)æ˜¯å‡½æ•°__alloc_percpu_gfpçš„ç®€åŒ–å½¢å¼ // å®alloc_percpu_gfp(type, gfp)æ˜¯å‡½æ•°__alloc_percpu_gfpçš„ç®€åŒ–å½¢å¼ void __percpu *__alloc_percpu(size_t size, size_t align); // free_percpué‡Šæ”¾åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡çš„å†…å­˜ void free_percpu(void __percpu *__pdata); 3ï¼è®¿é—®æ¯å¤„ç†å™¨å˜é‡ å®â€œthis_cpu_ptr(ptr)â€ç”¨æ¥å¾—åˆ°å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„åœ°å€ï¼Œå®â€œget_cpu_var(var)â€ç”¨æ¥å¾—åˆ°å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„å€¼\n// å®this_cpu_ptr(ptr)å±•å¼€ unsigned long __ptr; __ptr = (unsigned long) (ptr); (typeof(ptr)) (__ptr + per_cpu_offset(raw_smp_processor_id())); å®â€œper_cpu_ptr(ptr, cpu)â€ç”¨æ¥å¾—åˆ°æŒ‡å®šå¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„åœ°å€ï¼Œå®â€œper_cpu(var, cpu)â€ç”¨æ¥å¾—åˆ°æŒ‡å®šå¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„å€¼ã€‚ å®â€œget_cpu_ptr(var)â€ç¦æ­¢å†…æ ¸æŠ¢å å¹¶ä¸”è¿”å›å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„åœ°å€ï¼Œå®â€œput_cpu_ptr(var)â€å¼€å¯å†…æ ¸æŠ¢å ï¼Œè¿™ä¸¤ä¸ªå®æˆå¯¹ä½¿ç”¨ å®â€œget_cpu_var(var)â€ç¦æ­¢å†…æ ¸æŠ¢å å¹¶ä¸”è¿”å›å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„å€¼ï¼Œå®â€œput_cpu_var(var)â€å¼€å¯å†…æ ¸æŠ¢å ï¼Œè¿™ä¸¤ä¸ªå®æˆå¯¹ä½¿ç”¨ \\\n3.10.2ã€€æŠ€æœ¯åŸç† æ¯å¤„ç†å™¨åŒºåŸŸæ˜¯æŒ‰å—ï¼ˆchunkï¼‰åˆ†é…çš„ åˆ†é…å—çš„æ–¹å¼æœ‰ä¸¤ç§: (1)åˆ†é…å—çš„æ–¹å¼æœ‰ä¸¤ç§ (2)åˆ†é…å—çš„æ–¹å¼æœ‰ä¸¤ç§ \\\nåŸºäºvmallocåŒºåŸŸçš„æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨ æ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªpcpu_chunkå®ä¾‹\nåŸºäºå†…æ ¸å†…å­˜çš„æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨ 3.11ã€€é¡µè¡¨ 3.11.1ã€€ç»Ÿä¸€çš„é¡µè¡¨æ¡†æ¶ é¡µè¡¨ç”¨æ¥æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µï¼Œå¹¶ä¸”å­˜æ”¾é¡µçš„ä¿æŠ¤ä½ï¼Œå³è®¿é—®æƒé™ Linux 4.11ç‰ˆæœ¬ä»¥å‰ï¼ŒLinuxå†…æ ¸æŠŠé¡µè¡¨åˆ†ä¸º4çº§ (1)é¡µå…¨å±€ç›®å½•(Page Global Directory PGD) (2)é¡µä¸Šå±‚ç›®å½•(Page Upper DIrectory PUD) (3)é¡µä¸­é—´ç›®å½•(Page Middle Directory PMD) (4)ç›´æ¥é¡µè¡¨(Page Table PT) 4.11ç‰ˆæœ¬æŠŠé¡µè¡¨æ‰©å±•åˆ°äº”çº§ï¼Œåœ¨é¡µå…¨å±€ç›®å½•å’Œé¡µä¸Šå±‚ç›®å½•ä¹‹é—´å¢åŠ äº†é¡µå››çº§ç›®å½•(Page 4th Directoryï¼ŒP4D) \\\nå†…æ ¸ä¹Ÿæœ‰ä¸€ä¸ªé¡µè¡¨ï¼Œ0å·å†…æ ¸çº¿ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦init_taskçš„æˆå‘˜active_mmæŒ‡å‘å†…å­˜æè¿°ç¬¦init_mmï¼Œå†…å­˜æè¿°ç¬¦init_mmçš„æˆå‘˜pgdæŒ‡å‘å†…æ ¸çš„é¡µå…¨å±€ç›®å½•swapper_pg_dir è™šæ‹Ÿåœ°å€è¢«åˆ†è§£ä¸º6ä¸ªéƒ¨åˆ†ï¼šé¡µå…¨å±€ç›®å½•ç´¢å¼•ã€é¡µå››çº§ç›®å½•ç´¢å¼•ã€é¡µä¸Šå±‚ç›®å½•ç´¢å¼•ã€é¡µä¸­é—´ç›®å½•ç´¢å¼•ã€ç›´æ¥é¡µè¡¨ç´¢å¼•å’Œé¡µå†…åç§» \\\n3.11.2ã€€ARM64å¤„ç†å™¨çš„é¡µè¡¨ ARM64å¤„ç†å™¨æŠŠé¡µè¡¨ç§°ä¸ºè½¬æ¢è¡¨(translation table)ï¼Œæœ€å¤š4çº§ã€‚ARM64å¤„ç†å™¨æ”¯æŒ3 ç§é¡µé•¿åº¦ï¼š4KBã€16KBå’Œ64KBã€‚ ã€ é¡µé•¿åº¦æ˜¯4KBï¼šä½¿ç”¨4çº§è½¬æ¢è¡¨ï¼Œè½¬æ¢è¡¨å’Œå†…æ ¸çš„é¡µè¡¨æœ¯è¯­çš„å¯¹åº”å…³ç³»æ˜¯ï¼š0çº§è½¬æ¢è¡¨å¯¹åº”é¡µå…¨å±€ç›®å½•ï¼Œ1çº§è½¬æ¢è¡¨å¯¹åº”é¡µä¸Šå±‚ç›®å½•ï¼Œ2çº§è½¬æ¢è¡¨å¯¹åº”é¡µä¸­é—´ç›®å½•ï¼Œ3çº§è½¬æ¢è¡¨å¯¹åº”ç›´æ¥é¡µè¡¨ \\\n3.12ã€€é¡µè¡¨ç¼“å­˜ å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰è´Ÿè´£æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ã€‚ TLBï¼ˆTranslation Lookaside Bufferï¼‰çš„é«˜é€Ÿç¼“å­˜ï¼ŒTLBç›´è¯‘ä¸ºè½¬æ¢åå¤‡ç¼“å†²åŒºï¼Œæ„è¯‘ä¸ºé¡µè¡¨ç¼“å­˜ï¼Œç¼“å­˜æœ€è¿‘ä½¿ç”¨è¿‡çš„é¡µè¡¨é¡¹ã€‚ä¸¤çº§é¡µè¡¨ç¼“å­˜ï¼šç¬¬ä¸€çº§TLBåˆ†ä¸ºæŒ‡ä»¤TLBå’Œæ•°æ®TLBï¼Œå¥½å¤„æ˜¯å–æŒ‡ä»¤å’Œå–æ•°æ®å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼›ç¬¬äºŒçº§TLBæ˜¯ç»Ÿä¸€TLBï¼ˆUnified TLBï¼‰ï¼Œå³æŒ‡ä»¤å’Œæ•°æ®å…±ç”¨çš„TLB\n3.12.1ã€€TLBè¡¨é¡¹æ ¼å¼ ARM64å¤„ç†å™¨çš„æ¯æ¡TLBè¡¨é¡¹ä¸ä»…åŒ…å«è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ï¼Œä¹ŸåŒ…å«å±æ€§ï¼šå†…å­˜ç±»å‹ã€ç¼“å­˜ç­–ç•¥ã€è®¿é—®æƒé™ã€åœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼ˆAddress Space Identifierï¼ŒASIDï¼‰å’Œè™šæ‹Ÿæœºæ ‡è¯†ç¬¦ï¼ˆVirtual Machine Identifierï¼ŒVMIDï¼‰ã€‚åœ°å€ç©ºé—´æ ‡è¯†ç¬¦åŒºåˆ†ä¸åŒè¿›ç¨‹çš„é¡µè¡¨é¡¹ï¼Œè™šæ‹Ÿæœºæ ‡è¯†ç¬¦åŒºåˆ†ä¸åŒè™šæ‹Ÿæœºçš„é¡µè¡¨é¡¹ \\\n3.12.2ã€€TLBç®¡ç† é¡µè¡¨æ”¹å˜ä»¥åå†²åˆ·TLBçš„å‡½æ•°\n// ä½¿æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ void flush_tlb_all(void); // ä½¿æŒ‡å®šç”¨æˆ·åœ°å€ç©ºé—´çš„æŸä¸ªèŒƒå›´çš„TLBè¡¨é¡¹å¤±æ•ˆ // å‚æ•°vmaæ˜¯è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œstartæ˜¯èµ·å§‹åœ°å€ï¼Œendæ˜¯ç»“æŸåœ°å€ï¼ˆä¸åŒ…æ‹¬ï¼‰ void flush_tlb_range(struct vm_area_struct *vma, unsigned long start, unsigned long end); // ä½¿æŒ‡å®šç”¨æˆ·åœ°å€ç©ºé—´é‡Œé¢çš„æŒ‡å®šè™šæ‹Ÿé¡µçš„TLBè¡¨é¡¹å¤±æ•ˆ // å‚æ•°vmaæ˜¯è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œuaddræ˜¯ä¸€ä¸ªè™šæ‹Ÿé¡µä¸­çš„ä»»æ„è™šæ‹Ÿåœ°å€ void flush_tlb_page(struct vm_area_struct *vma, unsigned long uaddr); // ä½¿å†…æ ¸çš„æŸä¸ªè™šæ‹Ÿåœ°å€èŒƒå›´çš„TLBè¡¨é¡¹å¤±æ•ˆ // å‚æ•°startæ˜¯èµ·å§‹åœ°å€ï¼Œendæ˜¯ç»“æŸåœ°å€ï¼ˆä¸åŒ…æ‹¬ï¼‰ void flush_tlb_kernel_range(unsigned long start, unsigned long end); // ä¿®æ”¹é¡µè¡¨é¡¹ä»¥åæŠŠé¡µè¡¨é¡¹è®¾ç½®åˆ°é¡µè¡¨ç¼“å­˜ // ç”±è½¯ä»¶ç®¡ç†é¡µè¡¨ç¼“å­˜çš„å¤„ç†å™¨å¿…é¡»å®ç°è¯¥å‡½æ•°ï¼Œä¾‹å¦‚MIPSå¤„ç†å™¨ // ARM64å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒå¯ä»¥è®¿é—®å†…å­˜ä¸­çš„é¡µè¡¨ï¼ŒæŠŠé¡µè¡¨é¡¹å¤åˆ¶åˆ°é¡µè¡¨ç¼“å­˜ï¼Œæ‰€ä»¥ARM64æ¶æ„çš„å‡½æ•°update_mmu_cacheä»€ä¹ˆéƒ½ä¸ç”¨åš void update_mmu_cache(struct vm_area_struct *vma, unsigned long address, pte_t *ptep); // å†…æ ¸æŠŠè¿›ç¨‹ä»ä¸€ä¸ªå¤„ç†å™¨è¿ç§»åˆ°å¦ä¸€ä¸ªå¤„ç†å™¨ä»¥åï¼Œè°ƒç”¨è¯¥å‡½æ•°ä»¥æ›´æ–°é¡µè¡¨ç¼“å­˜æˆ–ä¸Šä¸‹æ–‡ç‰¹å®šä¿¡æ¯ void tlb_migrate_finish(struct mm_struct *mm); ARM64æ¶æ„æ²¡æœ‰æä¾›å†™TLBçš„æŒ‡ä»¤ã€‚ ARM64æ¶æ„æä¾›äº†ä¸€æ¡TLBå¤±æ•ˆæŒ‡ä»¤\nTLBI \u003ctype\u003e\u003clevel\u003e{IS} {, \u003cXt\u003e} ARM64å†…æ ¸flush_tlb_allå‡½æ•°\n// arch/arm64/include/asm/tlbflush.h static inline void flush_tlb_all(void) {\t// dsbæ•°æ®åŒæ­¥å±éšœ dsb(ishst); // ishstä¸­çš„ishè¡¨ç¤ºå…±äº«åŸŸæ˜¯å†…éƒ¨å…±äº« __tlbi(vmalle1is); // ä½¿æ‰€æœ‰æ ¸ä¸ŠåŒ¹é…å½“å‰VMIDã€é˜¶æ®µ1å’Œå¼‚å¸¸çº§åˆ«1çš„æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ dsb(ish); // ishè¡¨ç¤ºæ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤å¯¹æ‰€æœ‰æ ¸èµ·ä½œç”¨ isb(); // æŒ‡ä»¤åŒæ­¥å±éšœ } // å®å±•å¼€ static inline void flush_tlb_all(void) { // dsbç¡®ä¿å±éšœå‰é¢çš„å­˜å‚¨æŒ‡ä»¤æ‰§è¡Œå®Œ // ishstä¸­çš„ishè¡¨ç¤ºå…±äº«åŸŸæ˜¯å†…éƒ¨å…±äº« // stè¡¨ç¤ºå­˜å‚¨ï¼ˆstoreï¼‰ï¼Œishstè¡¨ç¤ºæ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤å¯¹æ‰€æœ‰æ ¸çš„å­˜å‚¨æŒ‡ä»¤èµ·ä½œç”¨ asm volatile(\"dsb ishst\" : : : \"memory\"); // ä½¿æ‰€æœ‰æ ¸ä¸ŠåŒ¹é…å½“å‰VMIDã€é˜¶æ®µ1å’Œå¼‚å¸¸çº§åˆ«1çš„æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ asm (\"tlbi vmalle1is\" : :); // ç¡®ä¿å‰é¢çš„TLBå¤±æ•ˆæŒ‡ä»¤æ‰§è¡Œå®Œã€‚ishè¡¨ç¤ºæ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤å¯¹æ‰€æœ‰æ ¸èµ·ä½œç”¨ asm volatile(\"dsb ish\" : : : \"memory\"); // isbæ˜¯æŒ‡ä»¤åŒæ­¥å±éšœ,å†²åˆ·å¤„ç†å™¨çš„æµæ°´çº¿ï¼Œé‡æ–°è¯»å–å±éšœæŒ‡ä»¤åé¢çš„æ‰€æœ‰æŒ‡ä»¤ asm volatile(\"isb\" : : : \"memory\"); } ARM64å†…æ ¸å®ç°äº†å‡½æ•°local_flush_tlb_allï¼Œç”¨æ¥ä½¿å½“å‰æ ¸çš„æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ\n// arch/arm64/include/asm/tlbflush.h static inline void local_flush_tlb_all(void) { dsb(nshst); __tlbi(vmalle1); // ä»…ä»…ä½¿å½“å‰æ ¸çš„TLBè¡¨é¡¹å¤±æ•ˆ dsb(nsh); // nshæ˜¯éå…±äº«,æ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤ä»…ä»…åœ¨å½“å‰æ ¸èµ·ä½œç”¨ isb(); } 3.12.3ã€€åœ°å€ç©ºé—´æ ‡è¯†ç¬¦ ARM64å¤„ç†å™¨çš„é¡µè¡¨ç¼“å­˜ä½¿ç”¨éå…¨å±€(not globalï¼ŒnG)ä½åŒºåˆ†å†…æ ¸å’Œè¿›ç¨‹çš„é¡µè¡¨é¡¹(nGä½ä¸º0è¡¨ç¤ºå†…æ ¸çš„é¡µè¡¨é¡¹)ï¼Œä½¿ç”¨åœ°å€ç©ºé—´æ ‡è¯†ç¬¦(Address Space Identifierï¼ŒASID)åŒºåˆ†ä¸åŒè¿›ç¨‹çš„é¡µè¡¨é¡¹ ARM64å¤„ç†å™¨çš„ASIDé•¿åº¦8ä½æˆ–è€…16ä½ï¼Œå¯„å­˜å™¨ID_AA64MMFR0_EL1æ®µASIDBitså­˜æ”¾å¤„ç†å™¨æ”¯æŒçš„ASIDé•¿åº¦ã€‚16ä½ASIDä½¿ç”¨å¯„å­˜å™¨TCR_EL1çš„AS(ASID Size)ä½æ§åˆ¶å®é™…ä½¿ç”¨çš„ASIDé•¿åº¦ï¼ŒAS 0ä¸º8ä½ASIDï¼ŒAS 1ä¸º16ä½ASID å¯„å­˜å™¨TCR_EL1çš„A1ä½å†³å®šä½¿ç”¨å“ªä¸ªå¯„å­˜å™¨å­˜æ”¾å½“å‰è¿›ç¨‹çš„ASID,å¯„å­˜å™¨TTBR0_EL1 ç”¨æˆ·0æˆ–TTBR1_EL1å†…æ ¸ï¼Ÿå­˜æ”¾å½“å‰è¿›ç¨‹ASID å†…å­˜æè¿°ç¬¦çš„æˆå‘˜contextå­˜æ”¾æ¶æ„ç‰¹å®šçš„å†…å­˜ç®¡ç†ä¸Šä¸‹æ–‡ï¼Œæ•°æ®ç±»å‹æ˜¯ç»“æ„ä½“mm_context_tï¼ŒARM64æ¶æ„å®šä¹‰çš„ç»“æ„ä½“ // arch/arm64/include/asm/mmu.h typedef struct { atomic64_t id; // æˆå‘˜idå­˜æ”¾å†…æ ¸ç»™è¿›ç¨‹åˆ†é…çš„è½¯ä»¶ASID â€¦ } mm_context_t; å…¨å±€å˜é‡asid_bitsä¿å­˜ASIDé•¿åº¦ï¼Œå…¨å±€å˜é‡asid_generationçš„é«˜56ä½ä¿å­˜å…¨å±€ASIDç‰ˆæœ¬å·ï¼Œä½å›¾asid_mapè®°å½•å“ªäº›ASIDè¢«åˆ†é… å½“å…¨å±€ASIDç‰ˆæœ¬å·åŠ 1æ—¶ï¼Œæ¯ä¸ªå¤„ç†å™¨éœ€è¦æ¸…ç©ºé¡µè¡¨ç¼“å­˜ï¼Œä½å›¾tlb_flush_pendingä¿å­˜éœ€è¦æ¸…ç©ºé¡µè¡¨ç¼“å­˜çš„å¤„ç†å™¨é›†åˆ // arch/arm64/mm/context.c static u32 asid_bits; static atomic64_t asid_generation; static unsigned long *asid_map; static DEFINE_PER_CPU(atomic64_t, active_asids); static DEFINE_PER_CPU(u64, reserved_asids); static cpumask_t tlb_flush_pending; è¿›ç¨‹è¢«è°ƒåº¦æ—¶ï¼Œå‡½æ•°check_and_switch_contextè´Ÿè´£æ£€æŸ¥æ˜¯å¦éœ€è¦ç»™è¿›ç¨‹é‡æ–°åˆ†é…ASID __schedule() -\u003e context_switch() -\u003e switch_mm_irqs_off() -\u003e switch_mm() -\u003e check_and_switch_context()\n// arch/arm64/mm/context.c void check_and_switch_context(struct mm_struct *mm, unsigned int cpu) { unsigned long flags; u64 asid; asid = atomic64_read(\u0026mm-\u003econtext.id); if (!((asid ^ atomic64_read(\u0026asid_generation)) \u003e\u003e asid_bits) \u0026\u0026 atomic64_xchg_relaxed(\u0026per_cpu(active_asids, cpu), asid)) goto switch_mm_fastpath; raw_spin_lock_irqsave(\u0026cpu_asid_lock, flags); asid = atomic64_read(\u0026mm-\u003econtext.id); if ((asid ^ atomic64_read(\u0026asid_generation)) \u003e\u003e asid_bits) { asid = new_context(mm, cpu); atomic64_set(\u0026mm-\u003econtext.id, asid); } if (cpumask_test_and_clear_cpu(cpu, \u0026tlb_flush_pending)) local_flush_tlb_all(); atomic64_set(\u0026per_cpu(active_asids, cpu), asid); raw_spin_unlock_irqrestore(\u0026cpu_asid_lock, flags); switch_mm_fastpath: if (!system_uses_ttbr0_pan()) cpu_switch_mm(mm-\u003epgd, mm); } å‡½æ•°new_contextè´Ÿè´£åˆ†é…ASID\n// arch/arm64/mm/context.c static u64 new_context(struct mm_struct *mm, unsigned int cpu) { static u32 cur_idx = 1; u64 asid = atomic64_read(\u0026mm-\u003econtext.id); u64 generation = atomic64_read(\u0026asid_generation); if (asid != 0) { u64 newasid = generation | (asid \u0026 ~ASID_MASK); if (check_update_reserved_asid(asid, newasid)) return newasid; asid \u0026= ~ASID_MASK; if (!__test_and_set_bit(asid, asid_map)) return newasid; } asid = find_next_zero_bit(asid_map, NUM_USER_ASIDS, cur_idx); if (asid != NUM_USER_ASIDS) goto set_asid; generation = atomic64_add_return_relaxed(ASID_FIRST_VERSION, \u0026asid_generation); flush_context(cpu); asid = find_next_zero_bit(asid_map, NUM_USER_ASIDS, 1); set_asid: __set_bit(asid, asid_map); cur_idx = asid; return asid | generation; } å‡½æ•°flush_contextè´Ÿè´£é‡æ–°åˆå§‹åŒ–ASIDåˆ†é…çŠ¶æ€\n// arch/arm64/mm/context.c static void flush_context(unsigned int cpu) { int i; u64 asid; bitmap_clear(asid_map, 0, NUM_USER_ASIDS); â€¦ smp_wmb(); for_each_possible_cpu(i) { asid = atomic64_xchg_relaxed(\u0026per_cpu(active_asids, i), 0); if (asid == 0) asid = per_cpu(reserved_asids, i); __set_bit(asid \u0026 ~ASID_MASK, asid_map); per_cpu(reserved_asids, i) = asid; } cpumask_setall(\u0026tlb_flush_pending); } 3.12.4ã€€è™šæ‹Ÿæœºæ ‡è¯†ç¬¦ è™šæ‹Ÿæœºé‡Œé¢è¿è¡Œçš„å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€åˆ†ä¸¤ä¸ªé˜¶æ®µï¼š ç¬¬ 1 é˜¶æ®µæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆä¸­é—´ç‰©ç†åœ°å€ ç¬¬ 2 é˜¶æ®µæŠŠä¸­é—´ç‰©ç†åœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ ç¬¬ 1 é˜¶æ®µè½¬æ¢ç”±å®¢æˆ·æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ§åˆ¶ï¼Œå’Œéè™šæ‹ŸåŒ–çš„è½¬æ¢è¿‡ç¨‹ç›¸åŒã€‚ç¬¬ 2 é˜¶æ®µè½¬æ¢ç”±è™šæ‹Ÿæœºç›‘æ§å™¨æ§åˆ¶ï¼Œè™šæ‹Ÿæœºç›‘æ§å™¨ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºç»´æŠ¤ä¸€ä¸ªè½¬æ¢è¡¨ï¼Œåˆ†é…ä¸€ä¸ªè™šæ‹Ÿæœºæ ‡è¯†ç¬¦(Virtual Machine Identifierï¼ŒVMID)ï¼Œå¯„å­˜å™¨VTTBR_EL2(è™šæ‹ŸåŒ–è½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨ï¼ŒVirtualization Translation Table Base Register)å­˜æ”¾å½“å‰è™šæ‹Ÿæœºçš„é˜¶æ®µ2è½¬æ¢è¡¨çš„ç‰©ç†åœ°å€\n3.13ã€€å·¨å‹é¡µ ä½¿ç”¨é•¿åº¦ä¸º2MBç”šè‡³æ›´å¤§çš„å·¨å‹é¡µï¼Œå¯ä»¥å¤§å¹…å‡å°‘TLBæœªå‘½ä¸­å’Œç¼ºé¡µå¼‚å¸¸çš„æ•°é‡ï¼Œå¤§å¹…æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½ (1)ä½¿ç”¨hugetlbfsä¼ªæ–‡ä»¶ç³»ç»Ÿå®ç°å·¨å‹é¡µ (2)é€æ˜å·¨å‹é¡µ 3.13.1ã€€å¤„ç†å™¨å¯¹å·¨å‹é¡µçš„æ”¯æŒ ARM64å¤„ç†å™¨æ”¯æŒå·¨å‹é¡µçš„æ–¹å¼æœ‰ä¸¤ç§ (1)é€šè¿‡å—æè¿°ç¬¦æ”¯æŒ (2)é€šè¿‡é¡µ/å—æè¿°ç¬¦çš„è¿ç»­ä½æ”¯æŒ é¡µé•¿åº¦ä¸º4KBæ—¶é€šè¿‡å—æè¿°ç¬¦æ”¯æŒå·¨å‹é¡µ é¡µé•¿åº¦ä¸º4KBæ—¶é€šè¿‡é¡µ/å—æè¿°ç¬¦çš„è¿ç»­ä½æ”¯æŒå·¨å‹é¡µ 3.13.2ã€€æ ‡å‡†å·¨å‹é¡µ ç¼–è¯‘å†…æ ¸æ—¶éœ€è¦æ‰“å¼€é…ç½®å®CONFIG_HUGETLBFSå’ŒCONFIG_HUGETLB_PAGE æ–‡ä»¶â€œ/proc/sys/vm/nr_hugepagesâ€æŒ‡å®šå·¨å‹é¡µæ± ä¸­æ°¸ä¹…å·¨å‹é¡µçš„æ•°é‡ â€”â€”â€”â€”â€”â€”â€“ å¾…è¡¥å…… â€”â€”â€”â€”â€”â€”â€”â€“\n3.13.3ã€€é€æ˜å·¨å‹é¡µ (1)åˆ†é…é€æ˜å·¨å‹é¡µ å‡½æ•°handle_mm_faultæ˜¯é¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ ¸å¿ƒå‡½æ•°ï¼Œå¦‚æœè§¦å‘å¼‚å¸¸çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸä½¿ç”¨æ™®é€šé¡µæˆ–é€æ˜å·¨å‹é¡µï¼ŒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°__handle_mm_fault é€æ˜å·¨å‹é¡µçš„é¡µé”™è¯¯å¼‚å¸¸å¤„ç† å‡½æ•°create_huge_pmdè´Ÿè´£åˆ†é…é¡µä¸­é—´ç›®å½•çº§åˆ«çš„å·¨å‹é¡µ 3.14ã€€é¡µé”™è¯¯å¼‚å¸¸å¤„ç† è™šæ‹Ÿé¡µæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µï¼Œæˆ–è€…æ²¡æœ‰è®¿é—®æƒé™ï¼Œå¤„ç†å™¨å°†ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ ç¼ºé¡µå¼‚å¸¸,è™šæ‹Ÿé¡µæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µ (1)è®¿é—®ç”¨æˆ·æ ˆçš„æ—¶å€™ï¼Œè¶…å‡ºäº†å½“å‰ç”¨æˆ·æ ˆçš„èŒƒå›´ï¼Œéœ€è¦æ‰©å¤§ç”¨æˆ·æ ˆ (2)è¿›ç¨‹ç”³è¯·è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œé€šå¸¸æ²¡æœ‰åˆ†é…ç‰©ç†é¡µï¼Œè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è§¦å‘é¡µé”™è¯¯å¼‚å¸¸ (3)å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œå†…æ ¸æŠŠè¿›ç¨‹çš„åŒ¿åé¡µæ¢å‡ºåˆ°äº¤æ¢åŒº (4)ä¸€ä¸ªæ–‡ä»¶é¡µè¢«æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…å­˜ä¸è¶³çš„æ—¶å€™ (5)ç¨‹åºé”™è¯¯ï¼Œè®¿é—®æ²¡æœ‰åˆ†é…ç»™è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ æ²¡æœ‰è®¿é—®æƒé™ï¼Œä¸¤ç§æƒ…å†µ (1)å†™æ—¶å¤åˆ¶(Copy on Writeï¼ŒCoW) é¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºæˆåŠŸåœ°æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ (2)ç¨‹åºé”™è¯¯ï¼Œå‘é€æ®µè¿æ³•(SIGSEGV)ä¿¡å·ä»¥æ€æ­»è¿›ç¨‹ 3.14.1ã€€å¤„ç†å™¨æ¶æ„ç‰¹å®šéƒ¨åˆ† 1.ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ ARM64å¤„ç†å™¨åœ¨å–æŒ‡ä»¤æˆ–æ•°æ®ï¼Œéœ€æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ï¼Œåˆ†ä¸¤ç§æƒ…å†µ (1)è™šæ‹Ÿåœ°å€çš„é«˜16ä½ä¸æ˜¯å…¨1æˆ–å…¨0ï¼Œæ˜¯éæ³•åœ°å€ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ (2)è™šæ‹Ÿåœ°å€çš„é«˜16ä½æ˜¯å…¨1æˆ–å…¨0ï¼Œå†…å­˜ç®¡ç†å•å…ƒæ ¹æ®å…³é”®å­—{åœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼Œè™šæ‹Ÿåœ°å€}æŸ¥æ‰¾TLB å¯„å­˜å™¨TTBR1_EL1å­˜æ”¾å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€ï¼Œå¯„å­˜å™¨TTBR0_EL1å­˜æ”¾è¿›ç¨‹çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€ å‘½ä¸­äº†TLBè¡¨é¡¹ï¼Œä»TLBè¡¨é¡¹è¯»å–è®¿é—®æƒé™ï¼Œæ£€æŸ¥è®¿é—®æƒé™ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ æ²¡æœ‰å‘½ä¸­TLBè¡¨é¡¹ï¼Œå†…å­˜ç®¡ç†å•å…ƒå°†ä¼šæŸ¥è¯¢å†…å­˜ä¸­çš„é¡µè¡¨ï¼Œç§°ä¸ºè½¬æ¢è¡¨éå†ï¼ˆtranslation table walkï¼‰ï¼Œåˆ†ä¸¤ç§æƒ…å†µ ï¼ˆ1ï¼‰è™šæ‹Ÿåœ°å€çš„é«˜16ä½å…¨éƒ¨æ˜¯1ï¼Œæ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ï¼ŒæŸ¥è¯¢å†…æ ¸çš„é¡µè¡¨ï¼Œä»å¯„å­˜å™¨TTBR1_EL1å–å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€ ï¼ˆ2ï¼‰è™šæ‹Ÿåœ°å€çš„é«˜16ä½å…¨éƒ¨æ˜¯0ï¼Œç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼ŒæŸ¥è¯¢è¿›ç¨‹çš„é¡µè¡¨ï¼Œä»å¯„å­˜å™¨TTBR0_EL1å–è¿›ç¨‹çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€ 2.å¤„ç†é¡µé”™è¯¯å¼‚å¸¸ ARM64æ¶æ„çš„å†…æ ¸å¼‚å¸¸å‘é‡è¡¨ï¼Œèµ·å§‹åœ°å€æ˜¯vectorsï¼ˆæºæ–‡ä»¶arch/arm64/ kernel/entry.Sï¼‰ï¼Œæ¯ä¸ªå¼‚å¸¸å‘é‡çš„é•¿åº¦æ˜¯128å­—èŠ‚ï¼Œåœ¨Linuxå†…æ ¸ä¸­æ¯ä¸ªå¼‚å¸¸å‘é‡åªæœ‰ä¸€æ¡æŒ‡ä»¤ï¼šè·³è½¬åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚å¼‚å¸¸å‘é‡è¡¨çš„è™šæ‹Ÿåœ°å€å­˜æ”¾åœ¨å¼‚å¸¸çº§åˆ«1çš„å‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(Vector Base Address Register for Exception Level 1ï¼ŒVBAR_EL1)ä¸­\nARM64å¤„ç†å™¨å¤„ç†é¡µé”™è¯¯å¼‚å¸¸ (1)å¼‚å¸¸ç±»å‹æ˜¯å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå¼‚å¸¸å‘é‡çš„åç§»æ˜¯0x200ï¼Œå¼‚å¸¸å‘é‡è·³è½¬åˆ°å‡½æ•°el1_sync (2)å¼‚å¸¸ç±»å‹æ˜¯64ä½ç”¨æˆ·ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå¼‚å¸¸å‘é‡çš„åç§»æ˜¯0x400ï¼Œå¼‚å¸¸å‘é‡è·³è½¬åˆ°å‡½æ•°el0_sync (3)å¼‚å¸¸ç±»å‹æ˜¯32ä½ç”¨æˆ·ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå¼‚å¸¸å‘é‡çš„åç§»æ˜¯0x600ï¼Œå¼‚å¸¸å‘é‡è·³è½¬åˆ°å‡½æ•°el0_sync_compat å‡½æ•°el0_syncæ ¹æ®å¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨çš„å¼‚å¸¸ç±»åˆ«å­—æ®µå¤„ç† (1)å¼‚å¸¸ç±»åˆ«æ˜¯å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„æ•°æ®ä¸­æ­¢(data abort)ï¼Œå³åœ¨å¼‚å¸¸çº§åˆ«0è®¿é—®æ•°æ®æ—¶ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_da (2)å¼‚å¸¸ç±»åˆ«æ˜¯å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„æŒ‡ä»¤ä¸­æ­¢(instruction abort)ï¼Œå³åœ¨å¼‚å¸¸çº§åˆ«0å–æŒ‡ä»¤æ—¶ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_ia ARM64å¤„ç†å™¨ï¼Œå¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨(ESR_EL1ï¼ŒException Syndrome Register for Exception Level 1)ç”¨æ¥å­˜æ”¾å¼‚å¸¸çš„ç—‡çŠ¶ä¿¡æ¯ ECï¼šå¼‚å¸¸ç±»åˆ«(Exception Class)ï¼ŒæŒ‡ç¤ºå¼•èµ·å¼‚å¸¸çš„åŸå›  ISSï¼šæŒ‡ä»¤ç‰¹å®šç—‡çŠ¶ ï¼ˆ1ï¼‰do_mem_abortå‡½æ•° do_mem_abortå‡½æ•°æ ¹æ®å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨çš„æŒ‡ä»¤ç‰¹å®šç—‡çŠ¶å­—æ®µçš„æŒ‡ä»¤é”™è¯¯çŠ¶æ€ç ï¼Œè°ƒç”¨æ•°ç»„fault_infoä¸­å¤„ç†å‡½æ•° æŒ‡ä»¤é”™è¯¯çŠ¶æ€ç å’Œå¤„ç†å‡½æ•°çš„å¯¹åº”å…³ç³»\næŒ‡ä»¤é”™è¯¯çŠ¶æ€ç  è¯´ã€€æ˜ å¤„ ç† å‡½ æ•° 4 0çº§è½¬æ¢é”™è¯¯ do_translation_fault 5 1çº§è½¬æ¢é”™è¯¯ do_translation_fault 6 2çº§è½¬æ¢é”™è¯¯ do_translation_fault 7 3çº§è½¬æ¢é”™è¯¯ do_page_fault 9 1çº§è®¿é—®æ ‡å¿—é”™è¯¯ do_page_fault 10 2çº§è®¿é—®æ ‡å¿—é”™è¯¯ do_page_fault 11 3çº§è®¿é—®æ ‡å¿—é”™è¯¯ do_page_fault 13 1çº§æƒé™é”™è¯¯ do_page_fault 14 2çº§æƒé™é”™è¯¯ do_page_fault 15 3çº§æƒé™é”™è¯¯ do_page_fault 33 å¯¹é½é”™è¯¯ do_alignment_fault å…¶ä»– å…¶ä»–é”™è¯¯ do_bad ï¼ˆ2ï¼‰do_translation_faultå‡½æ•° do_translation_faultå¤„ç†åœ¨0çº§ã€1çº§æˆ–2çº§è½¬æ¢è¡¨ä¸­åŒ¹é…çš„è¡¨é¡¹æ˜¯æ— æ•ˆæè¿°ç¬¦\n// arch/arm64/mm/fault.c // addrè§¦å‘å¼‚å¸¸çš„è™šæ‹Ÿåœ°å€ esrå¼‚å¸¸ç—‡çŠ¶çŠ¶æ€å¯„å­˜å™¨å€¼ regsæŒ‡å‘å†…æ ¸æ ˆä¸­ä¿å­˜çš„è¢«æ‰“æ–­çš„è¿›ç¨‹çš„å¯„å­˜å™¨é›†åˆ static int __kprobes do_translation_fault(unsigned long addr, unsigned int esr, struct pt_regs *regs) { if (addr \u003c TASK_SIZE) return do_page_fault(addr, esr, regs); // è™šæ‹Ÿåœ°å€æ˜¯ç”¨æˆ·è™šæ‹Ÿåœ°å€ // å¼‚å¸¸è™šæ‹Ÿåœ°å€æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€æˆ–ä¸è§„èŒƒåœ°å€ do_bad_area(addr, esr, regs); return 0; } do_bad_area\n// arch/arm64/mm/fault.c static void do_bad_area(unsigned long addr, unsigned int esr, struct pt_regs *regs) { struct task_struct *tsk = current; struct mm_struct *mm = tsk-\u003eactive_mm; const struct fault_info *inf; if (user_mode(regs)) { inf = esr_to_fault_info(esr); // å¼‚å¸¸æ˜¯åœ¨ç”¨æˆ·æ¨¡å¼ __do_user_fault(tsk, addr, esr, inf-\u003esig, inf-\u003ecode, regs); // å‘é€ä¿¡å·ä»¥æ€æ­»è¿›ç¨‹ } else __do_kernel_fault(mm, addr, esr, regs); // å¼‚å¸¸æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸‹ç”Ÿæˆ } ï¼ˆ3ï¼‰å‡½æ•°do_page_fault\nå‡½æ•°do_page_faultçš„æ‰§è¡Œæµ // arch/arm64/mm/fault.c linux4.x static int __kprobes do_page_fault(unsigned long addr, unsigned int esr, struct pt_regs *regs) { struct task_struct *tsk; struct mm_struct *mm; int fault, sig, code; unsigned long vm_flags = VM_READ | VM_WRITE; unsigned int mm_flags = FAULT_FLAG_ALLOW_RETRY | FAULT_FLAG_KILLABLE; â€¦ tsk = current; mm = tsk-\u003emm; // ç¦æ­¢æ‰§è¡Œé¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œæˆ–è€…å¤„äºåŸå­ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…å½“å‰è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ if (faulthandler_disabled() || !mm) goto no_context; if (user_mode(regs)) mm_flags |= FAULT_FLAG_USER; if (is_el0_instruction_abort(esr)) { vm_flags = VM_EXEC; } else if ((esr \u0026 ESR_ELx_WNR) \u0026\u0026 !(esr \u0026 ESR_ELx_CM)) { vm_flags = VM_WRITE; mm_flags |= FAULT_FLAG_WRITE; } if (addr \u003c USER_DS \u0026\u0026 is_permission_fault(esr, regs, addr)) { /* å¦‚æœä»å¼‚å¸¸çº§åˆ«0è¿›å…¥ï¼Œregs-\u003eorig_addr_limitå¯èƒ½æ˜¯0 */ if (regs-\u003eorig_addr_limit == KERNEL_DS) die(\"Accessing user space memory with fs=KERNEL_DS\", regs, esr); if (is_el1_instruction_abort(esr)) die(\"Attempting to execute userspace memory\", regs, esr); if (!search_exception_tables(regs-\u003epc)) die(\"Accessing user space memory outside uaccess.h routines\", regs, esr); } if (!down_read_trylock(\u0026mm-\u003emmap_sem)) { if (!user_mode(regs) \u0026\u0026 !search_exception_tables(regs-\u003epc)) goto no_context; retry: down_read(\u0026mm-\u003emmap_sem); } else { might_sleep(); â€¦ } fault = __do_page_fault(mm, addr, mm_flags, vm_flags, tsk); if ((fault \u0026 VM_FAULT_RETRY) \u0026\u0026 fatal_signal_pending(current)) return 0; â€¦ if (mm_flags \u0026 FAULT_FLAG_ALLOW_RETRY) { if (fault \u0026 VM_FAULT_MAJOR) { tsk-\u003emaj_flt++; â€¦ } else { tsk-\u003emin_flt++; â€¦ } if (fault \u0026 VM_FAULT_RETRY) { mm_flags \u0026= ~FAULT_FLAG_ALLOW_RETRY; mm_flags |= FAULT_FLAG_TRIED; goto retry; } } up_read(\u0026mm-\u003emmap_sem); if (likely(!(fault \u0026 (VM_FAULT_ERROR | VM_FAULT_BADMAP | VM_FAULT_BADACCESS)))) return 0; if (!user_mode(regs)) goto no_context; if (fault \u0026 VM_FAULT_OOM) { pagefault_out_of_memory(); return 0; } if (fault \u0026 VM_FAULT_SIGBUS) { sig = SIGBUS; code = BUS_ADRERR; } else { sig = SIGSEGV; code = fault == VM_FAULT_BADACCESS ? SEGV_ACCERR : SEGV_MAPERR; } __do_user_fault(tsk, addr, esr, sig, code, regs); return 0; no_context: __do_kernel_fault(mm, addr, esr, regs); return 0; } åŸå­ä¸Šä¸‹æ–‡ï¼šæ‰§è¡Œç¡¬ä¸­æ–­ã€æ‰§è¡Œè½¯ä¸­æ–­ã€ç¦æ­¢ç¡¬ä¸­æ–­ã€ç¦æ­¢è½¯ä¸­æ–­å’Œç¦æ­¢å†…æ ¸æŠ¢å è¿™äº”ç§æƒ…å†µä¸å…è®¸ç¡çœ ï¼Œç§°ä¸ºåŸå­ä¸Šä¸‹æ–‡ å‡½æ•°__do_page_faultçš„æ‰§è¡Œæµç¨‹ // arch/arm64/mm/fault.c static int __do_page_fault(struct mm_struct *mm, unsigned long addr, unsigned int mm_flags, unsigned long vm_flags, struct task_struct *tsk) { struct vm_area_struct *vma; int fault; vma = find_vma(mm, addr); fault = VM_FAULT_BADMAP; if (unlikely(!vma)) goto out; if (unlikely(vma-\u003evm_start \u003e addr)) goto check_stack; good_area: if (!(vma-\u003evm_flags \u0026 vm_flags)) { fault = VM_FAULT_BADACCESS; goto out; } return handle_mm_fault(vma, addr \u0026 PAGE_MASK, mm_flags); check_stack: if (vma-\u003evm_flags \u0026 VM_GROWSDOWN \u0026\u0026 !expand_stack(vma, addr)) goto good_area; out: return fault; } 3.14.2ã€€ç”¨æˆ·ç©ºé—´é¡µé”™è¯¯å¼‚å¸¸ å‡½æ•°handle_mm_faultå¤„ç†ç”¨æˆ·ç©ºé—´çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œä¸¤ç§æƒ…å†µï¼š (1)è¿›ç¨‹åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ (2)è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ã€‚è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨ä¼ å…¥ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œè¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒº // mm/memory.c int handle_mm_fault(struct vm_area_struct *vma, unsigned long address, unsigned int flags) { â€¦ if (unlikely(is_vm_hugetlb_page(vma))) ret = hugetlb_fault(vma-\u003evm_mm, vma, address, flags); else ret = __handle_mm_fault(vma, address, flags); â€¦ } å·¨å‹é¡µå‡½æ•°hugetlb_faultï¼Œæ™®é€šé¡µ__handle_mm_fault\n// mm/memory.c static int __handle_mm_fault(struct vm_area_struct *vma, unsigned long address, unsigned int flags) { struct vm_fault vmf = { .vma = vma, .address = address \u0026 PAGE_MASK, .flags = flags, .pgoff = linear_page_index(vma, address), .gfp_mask = __get_fault_gfp_mask(vma), }; struct mm_struct *mm = vma-\u003evm_mm; pgd_t *pgd; p4d_t *p4d; int ret; // åœ¨é¡µå…¨å±€ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹ pgd = pgd_offset(mm, address); p4d = p4d_alloc(mm, pgd, address); // åœ¨é¡µå››çº§ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹ if (!p4d) return VM_FAULT_OOM; // åœ¨é¡µä¸Šå±‚ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹ vmf.pud = pud_alloc(mm, p4d, address); if (!vmf.pud) return VM_FAULT_OOM; â€¦ // åœ¨é¡µä¸­é—´ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹ vmf.pmd = pmd_alloc(mm, vmf.pud, address); if (!vmf.pmd) return VM_FAULT_OOM; â€¦ // åˆ°è¾¾ç›´æ¥é¡µè¡¨ return handle_pte_fault(\u0026vmf); } // mm/memory.c static int handle_pte_fault(struct vm_fault *vmf) { pte_t entry; // ç›´æ¥é¡µè¡¨ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹ if (unlikely(pmd_none(*vmf-\u003epmd))) { vmf-\u003epte = NULL; } else { â€¦ vmf-\u003epte = pte_offset_map(vmf-\u003epmd, vmf-\u003eaddress); vmf-\u003eorig_pte = *vmf-\u003epte; barrier(); if (pte_none(vmf-\u003eorig_pte)) { pte_unmap(vmf-\u003epte); vmf-\u003epte = NULL; } } // é¡µè¡¨é¡¹ä¸å­˜åœ¨ if (!vmf-\u003epte) { if (vma_is_anonymous(vmf-\u003evma)) return do_anonymous_page(vmf); else return do_fault(vmf); } // é¡µè¡¨é¡¹å­˜åœ¨ï¼Œä½†æ˜¯é¡µä¸åœ¨ç‰©ç†å†…å­˜ if (!pte_present(vmf-\u003eorig_pte)) return do_swap_page(vmf); â€¦ vmf-\u003eptl = pte_lockptr(vmf-\u003evma-\u003evm_mm, vmf-\u003epmd); // è·å–é¡µè¡¨é”çš„åœ°å€ spin_lock(vmf-\u003eptl); // é”ä½é¡µè¡¨ entry = vmf-\u003eorig_pte; if (unlikely(!pte_same(*vmf-\u003epte, entry))) // é‡æ–°è¯»å–é¡µè¡¨é¡¹çš„å€¼ goto unlock; if (vmf-\u003eflags \u0026 FAULT_FLAG_WRITE) { if (!pte_write(entry)) return do_wp_page(vmf); // æ‰§è¡Œå†™æ—¶å¤åˆ¶ entry = pte_mkdirty(entry); // é¡µè¡¨é¡¹æœ‰å†™æƒé™ } entry = pte_mkyoung(entry); // è®¾ç½®é¡µè¡¨é¡¹çš„è®¿é—®æ ‡å¿—ä½ if (ptep_set_access_flags(vmf-\u003evma, vmf-\u003eaddress, vmf-\u003epte, entry, vmf-\u003eflags \u0026 FAULT_FLAG_WRITE)) { // è®¾ç½®é¡µè¡¨é¡¹ update_mmu_cache(vmf-\u003evma, vmf-\u003eaddress, vmf-\u003epte); // æ›´æ–°å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒçš„é¡µè¡¨ç¼“å­˜ } else { if (vmf-\u003eflags \u0026 FAULT_FLAG_WRITE) flush_tlb_fix_spurious_fault(vmf-\u003evma, vmf-\u003eaddress); } unlock: // é‡Šæ”¾é¡µè¡¨çš„é” pte_unmap_unlock(vmf-\u003epte, vmf-\u003eptl); return 0; } 1ï¼åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸ å‡½æ•°do_anonymous_pageå¤„ç†ç§æœ‰åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸\n// mm/memory.c static int do_anonymous_page(struct vm_fault *vmf) { struct vm_area_struct *vma = vmf-\u003evma; â€¦ struct page *page; pte_t entry; /* æ²¡æœ‰â€œ-\u003evm_opsâ€çš„æ–‡ä»¶æ˜ å°„ï¼Ÿ */ if (vma-\u003evm_flags \u0026 VM_SHARED) return VM_FAULT_SIGBUS; // ç›´æ¥é¡µè¡¨ä¸å­˜åœ¨ï¼Œåˆ†é…é¡µè¡¨ if (pte_alloc(vma-\u003evm_mm, vmf-\u003epmd, vmf-\u003eaddress)) return VM_FAULT_OOM; â€¦ /* å¦‚æœæ˜¯è¯»æ“ä½œï¼Œæ˜ å°„åˆ°é›¶é¡µ */ if (!(vmf-\u003eflags \u0026 FAULT_FLAG_WRITE) \u0026\u0026 !mm_forbids_zeropage(vma-\u003evm_mm)) { entry = pte_mkspecial(pfn_pte(my_zero_pfn(vmf-\u003eaddress), vma-\u003evm_page_prot)); vmf-\u003epte = pte_offset_map_lock(vma-\u003evm_mm, vmf-\u003epmd, vmf-\u003eaddress, \u0026vmf-\u003eptl); if (!pte_none(*vmf-\u003epte)) goto unlock; â€¦ goto setpte; } /* åˆ†é…æˆ‘ä»¬è‡ªå·±çš„ç§æœ‰é¡µ */ if (unlikely(anon_vma_prepare(vma))) goto oom; page = alloc_zeroed_user_highpage_movable(vma, vmf-\u003eaddress); if (!page) goto oom; â€¦ __SetPageUptodate(page); entry = mk_pte(page, vma-\u003evm_page_prot); if (vma-\u003evm_flags \u0026 VM_WRITE) entry = pte_mkwrite(pte_mkdirty(entry)); vmf-\u003epte = pte_offset_map_lock(vma-\u003evm_mm, vmf-\u003epmd, vmf-\u003eaddress, \u0026vmf-\u003eptl); if (!pte_none(*vmf-\u003epte)) goto release; â€¦ inc_mm_counter_fast(vma-\u003evm_mm, MM_ANONPAGES); page_add_new_anon_rmap(page, vma, vmf-\u003eaddress, false); â€¦ lru_cache_add_active_or_unevictable(page, vma); setpte: set_pte_at(vma-\u003evm_mm, vmf-\u003eaddress, vmf-\u003epte, entry); /* ä¸éœ€è¦ä»é¡µè¡¨ç¼“å­˜åˆ é™¤é¡µè¡¨é¡¹ï¼Œå› ä¸ºä»¥å‰è™šæ‹Ÿé¡µæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µ */ update_mmu_cache(vma, vmf-\u003eaddress, vmf-\u003epte); unlock: pte_unmap_unlock(vmf-\u003epte, vmf-\u003eptl); return 0; release: â€¦ put_page(page); goto unlock; oom_free_page: put_page(page); oom: return VM_FAULT_OOM; } 2ï¼æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸ è§¦å‘æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸: (1)å¯åŠ¨ç¨‹åºæ—¶ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è§¦å‘æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸ (2)è¿›ç¨‹ä½¿ç”¨mmapåˆ›å»ºæ–‡ä»¶æ˜ å°„ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è§¦å‘æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸ å‡½æ•°do_faultå¤„ç†æ–‡ä»¶é¡µå’Œå…±äº«åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸ // mm/memory.c static int do_fault(struct vm_fault *vmf) { struct vm_area_struct *vma = vmf-\u003evma; int ret; /* è¿™ä¸ªvm_area_structç»“æ„ä½“åœ¨æ‰§è¡Œmmap()çš„æ—¶å€™æ²¡æœ‰å®Œå…¨å¡«å……ï¼Œæˆ–è€…ç¼ºå°‘æ ‡å¿—ä½VM_DONTEXPANDã€‚ */ if (!vma-\u003evm_ops-\u003efault) ret = VM_FAULT_SIGBUS; else if (!(vmf-\u003eflags \u0026 FAULT_FLAG_WRITE)) // ç¼ºé¡µå¼‚å¸¸æ˜¯ç”±è¯»æ–‡ä»¶é¡µè§¦å‘ ret = do_read_fault(vmf); // å¤„ç†è¯»æ–‡ä»¶é¡µé”™è¯¯ else if (!(vma-\u003evm_flags \u0026 VM_SHARED)) // ç¼ºé¡µå¼‚å¸¸æ˜¯ç”±å†™ç§æœ‰æ–‡ä»¶é¡µè§¦å‘ ret = do_cow_fault(vmf); // å†™ç§æœ‰æ–‡ä»¶é¡µé”™è¯¯, æ‰§è¡Œå†™æ—¶å¤åˆ¶ else // ç¼ºé¡µå¼‚å¸¸æ˜¯ç”±å†™å…±äº«æ–‡ä»¶é¡µè§¦å‘ ret = do_shared_fault(vmf); // å¤„ç†å†™å…±äº«æ–‡ä»¶é¡µé”™è¯¯ â€¦ return ret; } ï¼ˆ1ï¼‰å¤„ç†è¯»æ–‡ä»¶é¡µé”™è¯¯ // mm/memory.c static int do_read_fault(struct vm_fault *vmf) { struct vm_area_struct *vma = vmf-\u003evma; int ret = 0; // å…¨å±€å˜é‡fault_around_bytesæ§åˆ¶æ€»é•¿åº¦ï¼Œé»˜è®¤å€¼æ˜¯64KBã€‚å¦‚æœé¡µé•¿åº¦æ˜¯4KBï¼Œå°±ä¸€æ¬¡è¯»å–16é¡µ if (vma-\u003evm_ops-\u003emap_pages \u0026\u0026 fault_around_bytes \u003e\u003e PAGE_SHIFT \u003e 1) { ret = do_fault_around(vmf); if (ret) return ret; } // æ–‡ä»¶é¡µè¯»åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­ ret = __do_fault(vmf); if (unlikely(ret \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY))) return ret; // è™šæ‹Ÿé¡µæ˜ å°„åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­çš„ç‰©ç†é¡µ ret |= finish_fault(vmf); unlock_page(vmf-\u003epage); if (unlikely(ret \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY))) put_page(vmf-\u003epage); return ret; } å‡½æ•°finish_faultè´Ÿè´£è®¾ç½®é¡µè¡¨é¡¹ï¼ŒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°alloc_set_pte\nå‡½æ•°finish_faultçš„æ‰§è¡Œæµç¨‹ // mm/memory.c int alloc_set_pte(struct vm_fault *vmf, struct mem_cgroup *memcg, struct page *page) { struct vm_area_struct *vma = vmf-\u003evma; bool write = vmf-\u003eflags \u0026 FAULT_FLAG_WRITE; pte_t entry; int ret; â€¦ if (!vmf-\u003epte) { // ç›´æ¥é¡µè¡¨ä¸å­˜åœ¨ï¼Œåˆ†é…ç›´æ¥é¡µè¡¨ ret = pte_alloc_one_map(vmf); if (ret) return ret; } /* é”ä½é¡µè¡¨åé‡æ–°æ£€æŸ¥ */ if (unlikely(!pte_none(*vmf-\u003epte))) return VM_FAULT_NOPAGE; // ç›´æ¥é¡µè¡¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ†é…ç›´æ¥é¡µè¡¨ flush_icache_page(vma, page); entry = mk_pte(page, vma-\u003evm_page_prot); // ä½¿ç”¨é¡µå¸§å·å’Œè®¿é—®æƒé™ç”Ÿæˆé¡µè¡¨é¡¹çš„å€¼ if (write) // å†™è®¿é—®ï¼Œè®¾ç½®é¡µè¡¨é¡¹çš„è„æ ‡å¿—ä½å’Œå†™æƒé™ä½ entry = maybe_mkwrite(pte_mkdirty(entry), vma); /* å†™æ—¶å¤åˆ¶çš„é¡µ */ if (write \u0026\u0026 !(vma-\u003evm_flags \u0026 VM_SHARED)) { inc_mm_counter_fast(vma-\u003evm_mm, MM_ANONPAGES); page_add_new_anon_rmap(page, vma, vmf-\u003eaddress, false); â€¦ lru_cache_add_active_or_unevictable(page, vma); } else { inc_mm_counter_fast(vma-\u003evm_mm, mm_counter_file(page)); page_add_file_rmap(page, false); } set_pte_at(vma-\u003evm_mm, vmf-\u003eaddress, vmf-\u003epte, entry); /* ä¸éœ€è¦ä½¿æ— æ•ˆï¼šä¸€ä¸ªä¸å­˜åœ¨çš„é¡µä¸ä¼šè¢«ç¼“å­˜ */ update_mmu_cache(vma, vmf-\u003eaddress, vmf-\u003epte); return 0; } // mm/memory.c static int do_cow_fault(struct vm_fault *vmf) { struct vm_area_struct *vma = vmf-\u003evma; int ret; if (unlikely(anon_vma_prepare(vma))) return VM_FAULT_OOM; // å…³è”ä¸€ä¸ªanon_vmaå®ä¾‹åˆ°è™šæ‹Ÿå†…å­˜åŒºåŸŸ vmf-\u003ecow_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, vmf-\u003eaddress); if (!vmf-\u003ecow_page) return VM_FAULT_OOM; â€¦ ret = __do_fault(vmf); // æŠŠæ–‡ä»¶é¡µè¯»åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ if (unlikely(ret \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY))) goto uncharge_out; if (ret \u0026 VM_FAULT_DONE_COW) return ret; // æŠŠæ–‡ä»¶çš„é¡µç¼“å­˜ä¸­ç‰©ç†é¡µçš„æ•°æ®å¤åˆ¶åˆ°å‰¯æœ¬ç‰©ç†é¡µ copy_user_highpage(vmf-\u003ecow_page, vmf-\u003epage, vmf-\u003eaddress, vma); __SetPageUptodate(vmf-\u003ecow_page); // è®¾ç½®å‰¯æœ¬é¡µæè¿°ç¬¦çš„æ ‡å¿—ä½PG_uptodateï¼Œè¡¨ç¤ºç‰©ç†é¡µåŒ…å«æœ‰æ•ˆçš„æ•°æ® // è®¾ç½®é¡µè¡¨é¡¹ï¼ŒæŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°å‰¯æœ¬ç‰©ç†é¡µ ret |= finish_fault(vmf); unlock_page(vmf-\u003epage); put_page(vmf-\u003epage); if (unlikely(ret \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY))) goto uncharge_out; return ret; uncharge_out: â€¦ put_page(vmf-\u003ecow_page); return ret; } // mm/memory.c static int do_shared_fault(struct vm_fault *vmf) { struct vm_area_struct *vma = vmf-\u003evma; int ret, tmp; // æŠŠæ–‡ä»¶é¡µè¯»åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­ ret = __do_fault(vmf); if (unlikely(ret \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY))) return ret; if (vma-\u003evm_ops-\u003epage_mkwrite) { unlock_page(vmf-\u003epage); tmp = do_page_mkwrite(vmf); if (unlikely(!tmp || (tmp \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE)))) { put_page(vmf-\u003epage); return tmp; } } // è®¾ç½®é¡µè¡¨é¡¹ï¼ŒæŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­çš„ç‰©ç†é¡µ ret |= finish_fault(vmf); if (unlikely(ret \u0026 (VM_FAULT_ERROR | VM_FAULT_NOPAGE | VM_FAULT_RETRY))) { unlock_page(vmf-\u003epage); put_page(vmf-\u003epage); return ret; } // è®¾ç½®é¡µçš„è„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºé¡µçš„æ•°æ®è¢«ä¿®æ”¹ fault_dirty_shared_page(vma, vmf-\u003epage); return ret; } 3ï¼å†™æ—¶å¤åˆ¶ ä¸¤ç§æƒ…å†µä¼šæ‰§è¡Œå†™æ—¶å¤åˆ¶(Copy on Writeï¼ŒCoW) (1)è¿›ç¨‹åˆ†å‰ç”Ÿæˆå­è¿›ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…å¤åˆ¶ç‰©ç†é¡µï¼Œå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ä»¥åªè¯»æ–¹å¼å…±äº«æ‰€æœ‰ç§æœ‰çš„åŒ¿åé¡µå’Œæ–‡ä»¶é¡µ (2)è¿›ç¨‹åˆ›å»ºç§æœ‰çš„æ–‡ä»¶æ˜ å°„ï¼Œç„¶åè¯»è®¿é—®ï¼Œè§¦å‘é¡µé”™è¯¯å¼‚å¸¸ å‡½æ•°do_wp_pageå¤„ç†å†™æ—¶å¤åˆ¶\nå‡½æ•°wp_page_copyæ‰§è¡Œå†™æ—¶å¤åˆ¶\n// mm/memory.c static int wp_page_copy(struct vm_fault *vmf) { struct vm_area_struct *vma = vmf-\u003evma; struct mm_struct *mm = vma-\u003evm_mm; struct page *old_page = vmf-\u003epage; struct page *new_page = NULL; pte_t entry; int page_copied = 0; const unsigned long mmun_start = vmf-\u003eaddress \u0026 PAGE_MASK; const unsigned long mmun_end = mmun_start + PAGE_SIZE; struct mem_cgroup *memcg; // å…³è”ä¸€ä¸ªanon_vmaå®ä¾‹åˆ°è™šæ‹Ÿå†…å­˜åŒºåŸŸ if (unlikely(anon_vma_prepare(vma))) goto oom; if (is_zero_pfn(pte_pfn(vmf-\u003eorig_pte))) { // æ˜¯é›¶é¡µï¼Œåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åç”¨é›¶åˆå§‹åŒ– new_page = alloc_zeroed_user_highpage_movable(vma,vmf-\u003eaddress); if (!new_page) goto oom; } else { // ä¸æ˜¯é›¶é¡µï¼Œåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åæŠŠæ•°æ®å¤åˆ¶åˆ°æ–°çš„ç‰©ç†é¡µ new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, vmf-\u003eaddress); if (!new_page) goto oom; cow_user_page(new_page, old_page, vmf-\u003eaddress, vma); } â€¦ // ä¸æ˜¯é›¶é¡µï¼Œé‚£ä¹ˆåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åæŠŠæ•°æ®å¤åˆ¶åˆ°æ–°çš„ç‰©ç†é¡µ __SetPageUptodate(new_page); // mmu_notifier_invalidate_range_start(mm, mmun_start, mmun_end); vmf-\u003epte = pte_offset_map_lock(mm, vmf-\u003epmd, vmf-\u003eaddress, \u0026vmf-\u003eptl); // é”ä½é¡µè¡¨ if (likely(pte_same(*vmf-\u003epte, vmf-\u003eorig_pte))) { â€¦ flush_cache_page(vma, vmf-\u003eaddress, pte_pfn(vmf-\u003eorig_pte)); // ä»ç¼“å­˜ä¸­å†²åˆ·é¡µ // ä½¿ç”¨æ–°çš„ç‰©ç†é¡µå’Œè®¿é—®æƒé™ç”Ÿæˆé¡µè¡¨é¡¹çš„å€¼ entry = mk_pte(new_page, vma-\u003evm_page_prot); entry = maybe_mkwrite(pte_mkdirty(entry), vma); // æŠŠé¡µè¡¨é¡¹æ¸…é™¤ï¼Œå¹¶ä¸”å†²åˆ·é¡µè¡¨ç¼“å­˜ ptep_clear_flush_notify(vma, vmf-\u003eaddress, vmf-\u003epte); // å»ºç«‹æ–°ç‰©ç†é¡µåˆ°è™šæ‹Ÿé¡µçš„åå‘æ˜ å°„ page_add_new_anon_rmap(new_page, vma, vmf-\u003eaddress, false); â€¦ // æŠŠç‰©ç†é¡µæ·»åŠ åˆ°æ´»åŠ¨LRUé“¾è¡¨æˆ–ä¸å¯å›æ”¶LRUé“¾è¡¨ä¸­ï¼Œé¡µå›æ”¶ç®—æ³•éœ€è¦ä»LRUé“¾è¡¨ä¸­é€‰æ‹©éœ€è¦å›æ”¶çš„ç‰©ç†é¡µ lru_cache_add_active_or_unevictable(new_page, vma); // ä¿®æ”¹é¡µè¡¨é¡¹ set_pte_at_notify(mm, vmf-\u003eaddress, vmf-\u003epte, entry); // æ›´æ–°é¡µè¡¨ç¼“å­˜ update_mmu_cache(vma, vmf-\u003eaddress, vmf-\u003epte); if (old_page) { // åˆ é™¤æ—§ç‰©ç†é¡µåˆ°è™šæ‹Ÿé¡µçš„åå‘æ˜ å°„ page_remove_rmap(old_page, false); } /* é‡Šæ”¾æ—§çš„ç‰©ç†é¡µ */ new_page = old_page; page_copied = 1; } else { â€¦ } if (new_page) put_page(new_page); // é‡Šæ”¾é¡µè¡¨çš„é” pte_unmap_unlock(vmf-\u003epte, vmf-\u003eptl); mmu_notifier_invalidate_range_end(mm, mmun_start, mmun_end); if (old_page) { if (page_copied \u0026\u0026 (vma-\u003evm_flags \u0026 VM_LOCKED)) { lock_page(old_page); if (PageMlocked(old_page)) munlock_vma_page(old_page); unlock_page(old_page); } put_page(old_page); } return page_copied ? VM_FAULT_WRITE : 0; oom_free_new: put_page(new_page); oom: if (old_page) put_page(old_page); return VM_FAULT_OOM; } 3.14.3ã€€å†…æ ¸æ¨¡å¼é¡µé”™è¯¯å¼‚å¸¸ å†…æ ¸ä½¿ç”¨çº¿æ€§æ˜ å°„åŒºåŸŸçš„è™šæ‹Ÿåœ°å€ï¼Œåœ¨å†…å­˜ç®¡ç†å­ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶æŠŠè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨vmalloc()å‡½æ•°ä»vmallocåŒºåŸŸåˆ†é…è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œvmalloc()å‡½æ•°ä¼šåˆ†é…å¹¶ä¸”æ˜ å°„åˆ°ç‰©ç†é¡µ æœ‰äº›ç³»ç»Ÿè°ƒç”¨ä¼šä¼ å…¥ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œå†…æ ¸å¿…é¡»ä½¿ç”¨å¤´æ–‡ä»¶â€œuaccess.hâ€å®šä¹‰çš„ä¸“ç”¨å‡½æ•°è®¿é—®ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œä¸“ç”¨å‡½æ•°åœ¨å¼‚å¸¸è¡¨ä¸­æ·»åŠ äº†å¯èƒ½è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤åœ°å€å’Œå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„åœ°å€ã€‚å¦‚æœè®¿é—®ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºæ—¶ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ï¼Œé¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºå‘ç°ç”¨æˆ·è™šæ‹Ÿåœ°å€æ²¡æœ‰è¢«åˆ†é…ç»™è¿›ç¨‹ï¼Œå°±åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾æŒ‡ä»¤åœ°å€å¯¹åº”çš„å¼‚å¸¸ä¿®æ­£ç¨‹åºï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œä½¿ç”¨å¼‚å¸¸ä¿®æ­£ç¨‹åºä¿®æ­£å¼‚å¸¸ï¼Œé¿å…å†…æ ¸å´©æºƒ åœ¨å†…æ ¸æ¨¡å¼ä¸‹æ‰§è¡Œæ—¶è§¦å‘é¡µé”™è¯¯å¼‚å¸¸ï¼ŒARM64æ¶æ„å†…æ ¸çš„å¤„ç†æµç¨‹ï¼Œ3ç§å¤„ç†æ–¹å¼ (1)ä¸å…è®¸å†…æ ¸æ‰§è¡Œç”¨æˆ·ç©ºé—´æ²»ç–—ï¼Œå†…æ ¸æ¨¡å¼æ‰§è¡Œç”¨æˆ·æ€æŒ‡ä»¤ï¼Œå†…æ ¸å´©æºƒ (2)å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œå…ˆä½¿ç”¨å‡½æ•°__do_page_faultå¤„ç†ï¼Œå¤„ç†å¤±è´¥ä½¿ç”¨__do_kernel_faultå¤„ç† (3)å…¶ä»–æƒ…å†µ __do_kernel_faultå¤„ç† 1.å‡½æ•°__do_kernel_fault è®¿é—®æ•°æ®ç”Ÿæˆçš„å¼‚å¸¸ï¼Œå‡½æ•°__do_kernel_faultå°è¯•åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾å¼‚å¸¸ä¿®æ­£ç¨‹åº æ‰¾åˆ°å¼‚å¸¸ä¿®æ­£ç¨‹åºï¼ŒæŠŠä¿å­˜åœ¨å†…æ ¸æ ˆä¸­çš„å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨(ELR_EL1ï¼ŒException Link Register for Exception Level 1)çš„å€¼ä¿®æ”¹ä¸ºå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„è™šæ‹Ÿåœ°å€ã€‚å½“å¼‚å¸¸å¤„ç†ç¨‹åºè¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®æˆå¼‚å¸¸é“¾æ¥å¯„å­˜å™¨çš„å€¼ï¼Œæ‰§è¡Œå¼‚å¸¸ä¿®æ­£ç¨‹åº å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¼‚å¸¸ä¿®æ­£ç¨‹åºï¼Œå†…æ ¸å´©æºƒ å‡½æ•°__do_kernel_fault\n// arch/arm64/mm/fault.c static void __do_kernel_fault(struct mm_struct *mm, unsigned long addr, unsigned int esr, struct pt_regs *regs) { const char *msg; // å¦‚æœå¼‚å¸¸æ˜¯ç”±è®¿é—®æ•°æ®ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾å¼‚å¸¸ä¿®å¤ç¨‹åº if (!is_el1_instruction_abort(esr) \u0026\u0026 fixup_exception(regs)) return; // æ¸…é™¤ä»»ä½•å¯èƒ½é˜»æ­¢åœ¨ç»ˆç«¯æ‰“å°ä¿¡æ¯çš„è‡ªæ—‹é” bust_spinlocks(1); if (is_permission_fault(esr, regs, addr)) { if (esr \u0026 ESR_ELx_WNR) msg = \"write to read-only memory\"; else msg = \"read from unreadable memory\"; } else if (addr \u003c PAGE_SIZE) { msg = \"NULL pointer dereference\"; } else { msg = \"paging request\"; } // æ‰“å°è§¦å‘é¡µé”™è¯¯å¼‚å¸¸çš„åŸå›  pr_alert(\"Unable to handle kernel %s at virtual address %08lx\\n\", msg, addr); // æ‰“å°é¡µè¡¨ä¿¡æ¯ show_pte(mm, addr); die(\"Oops\", regs, esr); // è°ƒç”¨å‡½æ•°die()ä»¥æ‰“å°å¯„å­˜å™¨ä¿¡æ¯ bust_spinlocks(0); // åœæ­¢æ¸…é™¤ä»»ä½•å¯èƒ½é˜»æ­¢æ‰“å°ä¿¡æ¯çš„è‡ªæ—‹é” do_exit(SIGKILL); // ç»ˆæ­¢å½“å‰è¿›ç¨‹ } å‡½æ•°fixup_exceptionæ ¹æ®æŒ‡ä»¤åœ°å€åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾ï¼Œç„¶åæŠŠä¿å­˜åœ¨å†…æ ¸æ ˆä¸­çš„å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨çš„å€¼ä¿®æ”¹ä¸ºå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„è™šæ‹Ÿåœ°å€\n// arch/arm64/mm/extable.c int fixup_exception(struct pt_regs *regs) { const struct exception_table_entry *fixup; fixup = search_exception_tables(instruction_pointer(regs)); if (fixup) regs-\u003epc = (unsigned long)\u0026fixup-\u003efixup + fixup-\u003efixup; return fixup != NULL; } å¼‚å¸¸è¡¨é¡¹ä¸­å­˜å‚¨çš„æŒ‡ä»¤åœ°å€æ˜¯ç›¸å¯¹åœ°å€ï¼šfixup-\u003einsn =ï¼ˆæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ âˆ’ \u0026fixup-\u003einsnï¼‰ å¼‚å¸¸è¡¨é¡¹ä¸­å­˜å‚¨çš„å¼‚å¸¸ä¿®æ­£ç¨‹åºçš„åœ°å€æ˜¯ç›¸å¯¹åœ°å€ï¼šfixup-\u003efixup =ï¼ˆå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„è™šæ‹Ÿåœ°å€ âˆ’ \u0026fixup-\u003efixupï¼‰ regs-\u003epcæ˜¯ä¿å­˜åœ¨å†…æ ¸æ ˆä¸­çš„å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨çš„å€¼ å‡½æ•°search_exception_tablesæ ¹æ®æŒ‡ä»¤åœ°å€åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾è¡¨é¡¹\n// kernel/extable.c const struct exception_table_entry *search_exception_tables(unsigned long addr) { const struct exception_table_entry *e; // åœ¨å†…æ ¸çš„å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾ e = search_extable(__start___ex_table, __stop___ex_table-1, addr); if (!e) // åœ¨å†…æ ¸çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œæ ¹æ®è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å†…æ ¸æ¨¡å—ï¼Œ e = search_module_extables(addr); // åœ¨å†…æ ¸æ¨¡å—çš„å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾ return e; } 2.å¼‚å¸¸è¡¨ è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„æ—¶å€™ï¼Œè®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€æ—¶ï¼Œåº”ç”¨ç¨‹åºé€šå¸¸æ˜¯ä¸å¯ä¿¡ä»»çš„ï¼Œä¸èƒ½ä¿è¯ä¼ å…¥çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€æ˜¯åˆæ³•çš„ï¼Œé‡‡å–æªæ–½ä¿æŠ¤å†…æ ¸ã€‚ä½¿ç”¨å¼‚å¸¸è¡¨ï¼Œæ¯æ¡è¡¨é¡¹æœ‰ä¸¤ä¸ªå­—æ®µ (1)è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ (2)å¼‚å¸¸ä¿®æ­£ç¨‹åºçš„èµ·å§‹è™šæ‹Ÿåœ°å€ å¼‚å¸¸è¡¨é¡¹å®šä¹‰\n// arch/arm64/include/asm/extable.h struct exception_table_entry { int insn, fixup; }; å†…æ ¸æœ‰ä¸€å¼ å¼‚å¸¸è¡¨ï¼Œå…¨å±€å˜é‡__start___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨çš„èµ·å§‹åœ°å€ï¼Œ__stop___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨çš„ç»“æŸåœ°å€ è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼Œåªå…è®¸ä½¿ç”¨å¤´æ–‡ä»¶â€œuaccess.hâ€å£°æ˜çš„å‡½æ•°ï¼Œä»¥å‡½æ•°get_userä¸ºä¾‹ï¼Œå‡½æ•°get_userä»ç”¨æˆ·ç©ºé—´è¯»å–Cè¯­è¨€æ ‡å‡†ç±»å‹çš„æ•°æ®ï¼ŒARM64æ¶æ„å®ç° // arch/arm64/include/asm/uaccess.h #define get_user(x, ptr) \\ ({ \\ __typeof__(*(ptr)) __user *__p = (ptr); \\ might_fault(); \\ access_ok(VERIFY_READ, __p, sizeof(*__p)) ? \\ __get_user((x), __p) : \\ ((x) = 0, -EFAULT); \\ }) åœ¨64ä½å†…æ ¸ä¸­é•¿æ•´æ•°çš„é•¿åº¦æ˜¯8å­—èŠ‚ï¼ŒæŠŠâ€œ__get_user((x), __p)â€å±•å¼€\nasm volatile( \\ \"1: ldr %x1, [%2]\\n\", \\ \"2:\\n\" \\ \" .section .fixup, \\\"ax\\\"\\n\" \\ \" .align 2\\n\" \\ \"3: mov %w0, %3\\n\" \\ \" mov %1, #0\\n\" \\ \" b 2b\\n\" \\ \" .previous\\n\" \\ \" .pushsection __ex_table, \\\"a\\\"\\n\" \\ \" .align 3\\n\" \\ \" .long (1b - .), (3b - .)\\n\" \\ \" .popsection\\n\" : \"+r\" (err), \"=\u0026r\" (x) \\ : \"r\" (__p), \"i\" (-EFAULT)) é“¾æ¥è„šæœ¬\n// arch/arm64/kernel/vmlinux.lds.S â€¦ . = ALIGN(SEGMENT_ALIGN); _etext = .; /* ä»£ç æ®µçš„ç»“æŸåœ°å€ */ RO_DATA(PAGE_SIZE) /* ä»è¿™é‡Œåˆ° */ EXCEPTION_TABLE(8) /* __init_beginå°†è¢«æ ‡è®°ä¸ºåªè¯»å’Œä¸å¯æ‰§è¡Œ */ NOTES â€¦ // å®EXCEPTION_TABLEçš„å®šä¹‰ // include/asm-generic/vmlinux.lds.h // å¼‚å¸¸è¡¨ #define EXCEPTION_TABLE(align) \\ . = ALIGN(align); \\ __ex_table : AT(ADDR(__ex_table) - LOAD_OFFSET) { \\ VMLINUX_SYMBOL(__start___ex_table) = .; \\ KEEP(*(__ex_table)) \\ VMLINUX_SYMBOL(__stop___ex_table) = .; \\ } å†…æ ¸çš„å…¨å±€å˜é‡__start___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨èŠ‚ï¼ˆ__ex_tableï¼‰çš„èµ·å§‹åœ°å€ï¼Œ__stop___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨èŠ‚çš„ç»“æŸåœ°å€ 3.15ã€€åç¢ç‰‡æŠ€æœ¯ åç¢ç‰‡æŠ€æœ¯ (1)2.6.23ç‰ˆæœ¬å¼•å…¥äº†è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ (2)3.5ç‰ˆæœ¬å†…å­˜ç¢ç‰‡æ•´ç†æŠ€æœ¯ (3).6.24ç‰ˆæœ¬å¼•å…¥äº†æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„çš„æŠ€æœ¯ (4).6.35ç‰ˆæœ¬å¼•å…¥äº†å†…å­˜ç¢ç‰‡æ•´ç†æŠ€æœ¯ 3.15.1ã€€è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ å¯ç§»åŠ¨åŒºåŸŸ(ZONE_MOVABLE)æ˜¯ä¸€ä¸ªä¼ªå†…å­˜åŒºåŸŸï¼šæŠŠç‰©ç†å†…å­˜åˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼Œä¸€ä¸ªåŒºåŸŸç”¨äºåˆ†é…ä¸å¯ç§»åŠ¨çš„é¡µï¼Œå¦ä¸€ä¸ªåŒºåŸŸç”¨äºåˆ†é…å¯ç§»åŠ¨çš„é¡µ\n3.15.2ã€€å†…å­˜ç¢ç‰‡æ•´ç† å†…å­˜ç¢ç‰‡æ•´ç†(memory compactionï¼Œæ„è¯‘ä¸ºâ€œå†…å­˜ç¢ç‰‡æ•´ç†â€)ï¼šä»å†…å­˜åŒºåŸŸçš„åº•éƒ¨æ‰«æå·²åˆ†é…çš„å¯ç§»åŠ¨é¡µï¼Œä»å†…å­˜åŒºåŸŸçš„é¡¶éƒ¨æ‰«æç©ºé—²é¡µï¼ŒæŠŠåº•éƒ¨çš„å¯ç§»åŠ¨é¡µç§»åˆ°é¡¶éƒ¨çš„ç©ºé—²é¡µï¼Œåœ¨åº•éƒ¨å½¢æˆè¿ç»­çš„ç©ºé—²é¡µ 1.ä½¿ç”¨æ–¹æ³• å†…å­˜ç¢ç‰‡æ•´ç†åŠŸèƒ½ï¼Œå¿…é¡»å¼€å¯é…ç½®æ–‡ä»¶â€œmm/Kconfigâ€å®šä¹‰çš„é…ç½®å®CONFIG_COMPACTIONï¼Œé»˜è®¤å¼€å¯\n3.16ã€€é¡µå›æ”¶ ç”³è¯·åˆ†é…é¡µçš„æ—¶å€™ï¼Œé¡µåˆ†é…å™¨é¦–å…ˆå°è¯•ä½¿ç”¨ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœä½¿ç”¨ä½æ°´çº¿åˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜è½»å¾®ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šå”¤é†’å†…å­˜èŠ‚ç‚¹çš„é¡µå›æ”¶å†…æ ¸çº¿ç¨‹ï¼Œå¼‚æ­¥å›æ”¶é¡µï¼Œç„¶åå°è¯•ä½¿ç”¨æœ€ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœä½¿ç”¨æœ€ä½æ°´çº¿åˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜ä¸¥é‡ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šç›´æ¥å›æ”¶é¡µ å†…æ ¸ä½¿ç”¨LRUï¼ˆLeast Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•é€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç‰©ç†é¡µ\n3.16.1ã€€æ•°æ®ç»“æ„ 1ï¼LRUé“¾è¡¨ é¡µå›æ”¶ç®—æ³•ä½¿ç”¨LRUç®—æ³•é€‰æ‹©å›æ”¶çš„é¡µã€‚æ¯ä¸ªå†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹æœ‰ä¸€ä¸ªæˆå‘˜lruvecï¼Œç§°ä¸ºLRUå‘é‡ï¼ŒLRUå‘é‡åŒ…å«5æ¡LRUé“¾è¡¨ å¾…è¡¥å……\n3.16.2ã€€å‘èµ·é¡µå›æ”¶ ç”³è¯·åˆ†é…é¡µçš„æ—¶å€™ï¼Œé¡µåˆ†é…å™¨é¦–å…ˆå°è¯•ä½¿ç”¨ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœä½¿ç”¨ä½æ°´çº¿åˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜è½»å¾®ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šå”¤é†’æ‰€æœ‰ç¬¦åˆåˆ†é…æ¡ä»¶çš„å†…å­˜èŠ‚ç‚¹çš„é¡µå›æ”¶çº¿ç¨‹ï¼Œå¼‚æ­¥å›æ”¶é¡µï¼Œç„¶åå°è¯•ä½¿ç”¨æœ€ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜ä¸¥é‡ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šç›´æ¥å›æ”¶é¡µã€‚å¦‚æœç›´æ¥å›æ”¶é¡µå¤±è´¥ï¼Œé‚£ä¹ˆåˆ¤æ–­æ˜¯å¦åº”è¯¥é‡æ–°å°è¯•å›æ”¶é¡µ 3.16.3ã€€è®¡ç®—æ‰«æçš„é¡µæ•° 3.16.4ã€€æ”¶ç¼©æ´»åŠ¨é¡µé“¾è¡¨ 3.16.5ã€€å›æ”¶ä¸æ´»åŠ¨é¡µ 3.16.6ã€€é¡µäº¤æ¢ 3.16.7ã€€å›æ”¶slabç¼“å­˜ 3.17ã€€å†…å­˜è€—å°½æ€æ‰‹ å½“å†…å­˜ä¸¥é‡ä¸è¶³çš„æ—¶å€™ï¼Œé¡µåˆ†é…å™¨åœ¨å¤šæ¬¡å°è¯•ç›´æ¥é¡µå›æ”¶å¤±è´¥ä»¥åï¼Œå°±ä¼šè°ƒç”¨å†…å­˜è€—å°½æ€æ‰‹ï¼ˆOOM killerï¼ŒOOMæ˜¯â€œOut of Memoryâ€çš„ç¼©å†™ï¼‰ï¼Œé€‰æ‹©è¿›ç¨‹æ€æ­»ï¼Œé‡Šæ”¾å†…å­˜\nflowchart LR __alloc_pages_showpath[Hard edge] --\u003e|Link text| __alloc_pages_may_oom(Round edge) __alloc_pages_may_oom --\u003e out_of_memeory{Decision} 3.17.1ã€€ä½¿ç”¨æ–¹æ³• 3.17.2ã€€æŠ€æœ¯åŸç† 3.18ã€€å†…å­˜èµ„æºæ§åˆ¶å™¨ æ§åˆ¶ç»„(cgroup)çš„å†…å­˜èµ„æºæ§åˆ¶å™¨ç”¨æ¥æ§åˆ¶ä¸€ç»„è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨é‡ï¼Œå¯ç”¨å†…å­˜èµ„æºæ§åˆ¶å™¨çš„æ§åˆ¶ç»„ç®€ç§°å†…å­˜æ§åˆ¶ç»„ï¼ˆmemcgï¼‰ã€‚æ§åˆ¶ç»„æŠŠå„ç§èµ„æºæ§åˆ¶å™¨ç§°ä¸ºå­ç³»ç»Ÿï¼Œå†…å­˜èµ„æºæ§åˆ¶å™¨ä¹Ÿç§°ä¸ºå†…å­˜å­ç³»ç»Ÿ\n3.18.1ã€€ä½¿ç”¨æ–¹æ³• 3.18.2ã€€æŠ€æœ¯åŸç† 3.19ã€€å¤„ç†å™¨ç¼“å­˜ å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´å¢åŠ äº†ç¼“å­˜ã€‚ç¼“å­˜å’Œå†…å­˜çš„åŒºåˆ« (1)ç¼“å­˜æ˜¯é™æ€éšæœºè®¿é—®å­˜å‚¨å™¨(Static Random Access Memoryï¼ŒSRAM) (2)å†…å­˜æ˜¯åŠ¨æ€éšæœºè®¿é—®å­˜å‚¨å™¨(Dynamic Random Access Memoryï¼ŒDRAM) ä¸€çº§ç¼“å­˜åˆ†ä¸ºä¸€çº§æŒ‡ä»¤ç¼“å­˜(i-cacheï¼Œinstruction cache)å’Œä¸€çº§æ•°æ®æ•°æ®(d-cacheï¼Œdata cache)ã€‚äºŒçº§ç¼“å­˜æ˜¯æŒ‡ä»¤å’Œæ•°æ®å…±äº«çš„ç»Ÿä¸€ç¼“å­˜(unified cache) 3.19.1ã€€ç¼“å­˜ç»“æ„ 32KBå››è·¯ç»„ç›¸è¿ç¼“å­˜(32KB 4-way set associative cache) ç¼“å­˜çš„ç»“æ„ ç¼“å­˜ç”±å¤šä¸ªå®¹é‡ç›¸åŒçš„å­ç¼“å­˜å¹¶è”ç»„æˆï¼Œæ¯ä¸ªå­ç¼“å­˜ç§°ä¸ºè·¯(Way)ï¼Œå››è·¯è¡¨ç¤º4ä¸ªå­ç¼“å­˜å¹¶è”\nARM64å¤„ç†å™¨çš„æŒ‡ä»¤ç¼“å­˜æœ‰3ç§ç±»å‹ (1)PIPTç¼“å­˜ ï¼š ç‰©ç†åœ°å€ç”Ÿæˆç´¢å¼•å’Œæ ‡ç­¾çš„ç¼“å­˜\n(2)VPIPTï¼ˆVMID-aware PIPTï¼‰ç¼“å­˜ (3)VIPTï¼šè™šæ‹Ÿåœ°å€ç”Ÿæˆç´¢å¼•ã€ä»ç‰©ç†åœ°å€ç”Ÿæˆæ ‡ç­¾\n3.19.2ã€€ç¼“å­˜ç­–ç•¥ ç¼“å­˜åˆ†é…æœ‰ä¸¤ç§ç­–ç•¥ (1)å†™åˆ†é…(write allocation) (2)è¯»åˆ†é…(read allocation) ç¼“å­˜æ›´æ–°æœ‰ä¸¤ç§ç­–ç•¥ (1)å†™å›(write back) (2)å†™é€(write-through) 3.19.3 ç¼“å­˜ç»´æŠ¤ 3.ARM64å¤„ç†å™¨ç¼“å­˜ç»´æŠ¤ ARM64å¤„ç†å™¨æ”¯æŒ3ç§ç¼“å­˜æ“ä½œã€‚ ï¼ˆ1ï¼‰ä½¿ç¼“å­˜è¡Œå¤±æ•ˆï¼ˆinvalidateï¼‰ï¼šæ¸…é™¤ç¼“å­˜è¡Œçš„æœ‰æ•ˆä½ã€‚ ï¼ˆ2ï¼‰æ¸…ç†ï¼ˆcleanï¼‰ç¼“å­˜è¡Œï¼šé¦–å…ˆæŠŠæ ‡è®°ä¸ºè„çš„ç¼“å­˜è¡Œé‡Œé¢çš„æ•°æ®å†™åˆ°ä¸‹ä¸€çº§ç¼“å­˜æˆ–å†…å­˜ï¼Œç„¶åæ¸…é™¤ç¼“å­˜è¡Œçš„æœ‰æ•ˆä½ã€‚åªé€‚ç”¨äºä½¿ç”¨å†™å›ç­–ç•¥çš„æ•°æ®ç¼“å­˜ã€‚ ï¼ˆ3ï¼‰æ¸…é›¶ï¼ˆzeroï¼‰ï¼šæŠŠç¼“å­˜é‡Œé¢çš„ä¸€ä¸ªå†…å­˜å—æ¸…é›¶ï¼Œä¸éœ€è¦å…ˆä»å†…å­˜è¯»æ•°æ®åˆ°ç¼“å­˜ä¸­ã€‚åªé€‚ç”¨äºæ•°æ®ç¼“å­˜ 3.19.4ã€€SMPç¼“å­˜ä¸€è‡´æ€§ åŸç”Ÿçš„MESIåè®®æœ‰4ç§çŠ¶æ€ã€‚MESIæ˜¯4ç§çŠ¶æ€çš„é¦–å­—æ¯ç¼©å†™ï¼Œç¼“å­˜è¡Œçš„4ç§çŠ¶æ€\n3.20 è¿ç»­å†…å­˜åˆ†é…å™¨ è¿ç»­å†…å­˜åˆ†é…å™¨ï¼ˆContiguous Memory Allocatorï¼ŒCMAï¼‰:ä¿ç•™ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸï¼Œå½“è®¾å¤‡é©±åŠ¨ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œå†…æ ¸çš„å…¶ä»–æ¨¡å—å¯ä»¥ä½¿ç”¨\n3.21 userfaultfd userfaultfdï¼ˆç”¨æˆ·é¡µé”™è¯¯æ–‡ä»¶æè¿°ç¬¦ï¼‰ç”¨æ¥æ‹¦æˆªå’Œå¤„ç†ç”¨æˆ·ç©ºé—´çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œå†…æ ¸é€šè¿‡æ–‡ä»¶æè¿°ç¬¦å°†é¡µé”™è¯¯å¼‚å¸¸çš„ä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ï¼Œç„¶åç”±ç”¨æˆ·ç©ºé—´å†³å®šè¦å¾€è™šæ‹Ÿé¡µå†™å…¥çš„æ•°æ®ã€‚ä¼ ç»Ÿçš„é¡µé”™è¯¯å¼‚å¸¸ç”±å†…æ ¸ç‹¬è‡ªå¤„ç†ï¼Œç°åœ¨æ”¹ä¸ºç”±å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¸€èµ·æ§åˆ¶ã€‚ userfaultfdæ˜¯ä¸ºäº†è§£å†³QEMU/KVMè™šæ‹ŸæœºåŠ¨æ€è¿ç§»çš„é—®é¢˜è€Œå‡ºç°çš„ã€‚æ‰€è°“åŠ¨æ€è¿ç§»ï¼Œå°±æ˜¯å°†è™šæ‹Ÿæœºä»ä¸€ç«¯è¿ç§»åˆ°å¦ä¸€ç«¯ï¼Œè€Œåœ¨è¿ç§»çš„è¿‡ç¨‹ä¸­è™šæ‹Ÿæœºèƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ï¼Œæœ‰ä¸¤ç§å®ç°æ–¹æ¡ˆ\n3.22 å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·KASAN å†…æ ¸åœ°å€æ¶ˆæ¯’å‰‚ï¼ˆKernel Address SANitizerï¼ŒKASANï¼‰æ˜¯ä¸€ä¸ªåŠ¨æ€çš„å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·ï¼Œä¸ºå‘ç°â€œé‡Šæ”¾åä½¿ç”¨â€å’Œâ€œè¶Šç•Œè®¿é—®â€è¿™ä¸¤ç±»ç¼ºé™·æä¾›äº†å¿«é€Ÿå’Œç»¼åˆçš„è§£å†³æ–¹æ¡ˆ KASANä½¿ç”¨ç¼–è¯‘æ—¶æ’æ¡©ï¼ˆcompile-time instrumentationï¼‰æ£€æŸ¥æ¯ä¸ªå†…å­˜è®¿é—®\nç¬¬4ç«  ä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨ 4.1 ARM64å¼‚å¸¸å¤„ç† 4.1.1 å¼‚å¸¸çº§åˆ« ARM64å¤„ç†å™¨4ä¸ªå¼‚å¸¸çº§åˆ«ï¼š0~3\nARM64å¤„ç†å™¨çš„å¼‚å¸¸çº§åˆ« è™šæ‹Ÿæœºé‡Œé¢è¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œè¿è¡Œè™šæ‹Ÿæœºçš„æ“ä½œç³»ç»Ÿç§°ä¸ºå®¿ä¸»æ“ä½œç³»ç»Ÿ(host OS)ï¼Œè™šæ‹Ÿæœºé‡Œé¢çš„æ“ä½œç³»ç»Ÿç§°ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿ(guest OS) å¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº(Kernel-based Virtual Machineï¼ŒKVM)ã€‚KVMç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œè™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚ ARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦ä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚ ARM64æ¶æ„çš„å®‰å…¨æ‰©å±•å®šä¹‰äº†ä¸¤ç§å®‰å…¨çŠ¶æ€ï¼šæ­£å¸¸ä¸–ç•Œå’Œå®‰å…¨ä¸–ç•Œã€‚é€šè¿‡å¼‚å¸¸çº§åˆ«3çš„å®‰å…¨ç›‘æ§å™¨åˆ‡æ¢\n4.1.2 å¼‚å¸¸åˆ†ç±» ARM64ä½“ç³»ç»“æ„ä¸­ï¼Œå¼‚å¸¸åˆ†ä¸ºåŒæ­¥å¼‚å¸¸å’Œå¼‚æ­¥å¼‚å¸¸ åŒæ­¥å¼‚å¸¸åŒ…æ‹¬ï¼š (1)ç³»ç»Ÿè°ƒç”¨ï¼Œå¼‚å¸¸çº§åˆ«0ä½¿ç”¨svc(Supervisor Call)æŒ‡ä»¤é™·å…¥å¼‚å¸¸çº§åˆ«1ï¼Œå¼‚å¸¸çº§åˆ«1ä½¿ç”¨hvc(Hypervisor Call)æŒ‡ä»¤é™·å…¥å¼‚å¸¸çº§åˆ«2ï¼Œå¼‚å¸¸çº§åˆ«2ä½¿ç”¨smc(Secure Monitor Call)æŒ‡ä»¤é™·å…¥å¼‚å¸¸çº§åˆ«3 (2)æ•°æ®ä¸­æ­¢ï¼Œå³è®¿é—®æ•°æ®æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œæ— æ˜ å°„ï¼Œæ— å†™æƒé™ (3)æŒ‡ä»¤ä¸­æ­¢ï¼Œå–æŒ‡ä»¤æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œæ— æ˜ å°„ï¼Œæ— æ‰§è¡Œæƒé™ (4)æ ˆæŒ‡é’ˆæˆ–æŒ‡ä»¤åœ°å€æ²¡æœ‰å¯¹é½ (5)æ²¡æœ‰å®šä¹‰çš„æŒ‡ä»¤ (6)è°ƒè¯•å¼‚å¸¸ å¼‚æ­¥å¼‚å¸¸åŒ…æ‹¬: (1)ä¸­æ–­(normal priority interruptï¼ŒIRQ)ï¼Œå³æ™®é€šä¼˜å…ˆçº§çš„ä¸­æ–­ã€‚ (2)å¿«é€Ÿä¸­æ–­(fast interrupt FIQ)ï¼Œé«˜ä¼˜å…ˆçº§ä¸­æ–­ (3)ç³»ç»Ÿé”™è¯¯(System Error SError)ï¼Œç¡¬ä»¶é”™è¯¯è§¦å‘çš„å¼‚å¸¸ 4.1.3 å¼‚å¸¸å‘é‡è¡¨ å­˜å‚¨å¼‚å¸¸å¤„ç†ç¨‹åºçš„å†…å­˜ä½ç½®ç§°ä¸ºå¼‚å¸¸å‘é‡ï¼ŒARM64å¤„ç†å™¨çš„å¼‚å¸¸çº§åˆ«1ã€2å’Œ3ï¼Œæ¯ä¸ªå¼‚å¸¸çº§åˆ«éƒ½æœ‰è‡ªå·±çš„å¼‚å¸¸å‘é‡è¡¨ï¼Œå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€å­˜æ”¾åœ¨å¯„å­˜å™¨VBAR_ELn(å‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨ï¼ŒVector Based Address Register)ä¸­ åœ°å€ å¼‚å¸¸ç±»å‹ å«ä¹‰ VBAR_ELn + 0x000 åŒæ­¥å¼‚å¸¸ å½“å‰å¼‚å¸¸çº§åˆ«ç”Ÿæˆçš„å¼‚å¸¸ï¼Œä½¿ç”¨å¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0 + 0x080 ä¸­æ–­ + 0x100 å¿«é€Ÿä¸­æ–­ + 0x180 ç³»ç»Ÿé”™è¯¯ + 0x200 åŒæ­¥å¼‚å¸¸ å½“å‰å¼‚å¸¸çº§åˆ«ç”Ÿæˆçš„å¼‚å¸¸ï¼Œä½¿ç”¨å½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_ELn + 0x280 ä¸­æ–­ + 0x300 å¿«é€Ÿä¸­æ–­ + 0x380 ç³»ç»Ÿé”™è¯¯ + 0x400 åŒæ­¥å¼‚å¸¸ 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«ï¼ˆnâˆ’1ï¼‰ç”Ÿæˆçš„å¼‚å¸¸ + 0x480 ä¸­æ–­ + 0x500 å¿«é€Ÿä¸­æ–­ + 0x580 ç³»ç»Ÿé”™è¯¯ + 0x600 åŒæ­¥å¼‚å¸¸ 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«ï¼ˆnâˆ’1ï¼‰ç”Ÿæˆçš„å¼‚å¸¸ + 0x680 ä¸­æ–­ + 0x700 å¿«é€Ÿä¸­æ–­ + 0x780 ç³»ç»Ÿé”™è¯¯ ARM64æ¶æ„å†…æ ¸å®šä¹‰çš„å¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨ // ach/arm64/kernel/entry.S .align 11 ENTRY(vectors) ventry el1_sync_invalid // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0 ventry el1_irq_invalid // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0 ventry el1_fiq_invalid // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0 ventry el1_error_invalid // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0 ventry el1_sync // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1 ventry el1_irq // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1 ventry el1_fiq_invalid // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1 ventry el1_error_invalid // å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1 ventry el0_sync // 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ ventry el0_irq // 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ä¸­æ–­ ventry el0_fiq_invalid // 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ ventry el0_error_invalid// 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ #ifdef CONFIG_COMPAT /* è¡¨ç¤ºæ”¯æŒæ‰§è¡Œ32ä½ç¨‹åº */ ventry el0_sync_compat // 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ ventry el0_irq_compat // 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ä¸­æ–­ ventry el0_fiq_invalid_compat // 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ ventry el0_error_invalid_compat// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ #else ventry el0_sync_invalid // 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ ventry el0_irq_invalid // 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ä¸­æ–­ ventry el0_fiq_invalid // 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ ventry el0_error_invalid// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ #endif END(vectors) ventryæ˜¯ä¸€ä¸ªå®ï¼Œå‚æ•°æ˜¯è·³è½¬æ ‡å·ï¼Œå³å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ ‡å·\n// arch/arm64/include/asm/assembler.h .macro ventry label .align 7 b \\label .endm // ventry el1_syncå±•å¼€ .align 7 b el1_sync å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ0å·å¤„ç†å™¨ç§°ä¸ºå¼•å¯¼å¤„ç†å™¨ï¼Œå…¶ä»–å¤„ç†å™¨ç§°ä¸ºä»å¤„ç†å™¨ã€‚å¼•å¯¼å¤„ç†å™¨åœ¨å‡½æ•°__primary_switched()ä¸­æŠŠå¯„å­˜å™¨VBAR_EL1è®¾ç½®ä¸ºå¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€ _head() -\u003e stext() -\u003e __primary_switch() -\u003e __primary_switched() // arch/arm64/kernel/head.S __primary_switched: â€¦ adr_l x8, vectors msr vbar_el1, x8 // æŠŠå¯„å­˜å™¨VBAR_EL1è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€ isb â€¦ b start_kernel ENDPROC(__primary_switched) ä»å¤„ç†å™¨åœ¨å‡½æ•°__secondary_switched()ä¸­æŠŠå¯„å­˜å™¨VBAR_EL1è®¾ç½®ä¸ºå¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€\nsecondary_entry() -\u003e secondary_startup() -\u003e __secondary_switched() // arch/arm64/kernel/head.S __secondary_switched: adr_l x5, vectors msr vbar_el1, x5 isb â€¦ b secondary_start_kernel ENDPROC(__secondary_switched) 4.1.4 å¼‚å¸¸å¤„ç† å¤„ç†å™¨å–å‡ºå¼‚å¸¸å¤„ç†çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ‰§è¡Œçš„æ“ä½œ (1)æŠŠå½“å‰çš„å¤„ç†å™¨çŠ¶æ€ï¼ˆProcessor Stateï¼ŒPSTATEï¼‰ä¿å­˜åœ¨å¯„å­˜å™¨SPSR_EL1ï¼ˆä¿å­˜ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼ŒSaved Program Status Registerï¼‰ä¸­ (2)æŠŠè¿”å›åœ°å€ä¿å­˜åœ¨å¯„å­˜å™¨ELR_EL1ï¼ˆå¼‚å¸¸é“¾æ¥å¯„å­˜å™¨ï¼ŒException Link Registerï¼‰ä¸­ ç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆè¿”å›åœ°å€æ˜¯ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤åé¢çš„æŒ‡ä»¤ é™¤ç³»ç»Ÿè°ƒç”¨å¤–çš„åŒæ­¥å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿”å›åœ°å€æ˜¯ç”Ÿæˆå¼‚å¸¸çš„æŒ‡ä»¤ å¼‚æ­¥å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿”å›åœ°å€æ˜¯æ²¡æœ‰æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤ (3)æŠŠå¤„ç†å™¨çŠ¶æ€çš„DAIFè¿™4ä¸ªå¼‚å¸¸æ©ç ä½éƒ½è®¾ç½®ä¸º1ï¼Œç¦æ­¢è¿™4ç§å¼‚å¸¸ï¼ŒDæ˜¯è°ƒè¯•æ©ç ä½ï¼ˆDebug mask bitï¼‰ï¼ŒAæ˜¯ç³»ç»Ÿé”™è¯¯æ©ç ä½ï¼ˆSError mask bitï¼‰ï¼ŒIæ˜¯ä¸­æ–­æ©ç ä½ï¼ˆIRQ mask bitï¼‰ï¼ŒFæ˜¯å¿«é€Ÿä¸­æ–­æ©ç ä½ï¼ˆFIQ mask bitï¼‰ (4)åŒæ­¥å¼‚å¸¸æˆ–ç³»ç»Ÿé”™è¯¯å¼‚å¸¸ï¼ŒæŠŠç”Ÿæˆå¼‚å¸¸çš„åŸå› ä¿å­˜åœ¨å¯„å­˜å™¨ESR_EL1ï¼ˆå¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨ï¼ŒException Syndrome Registerï¼‰ä¸­ (5)åŒæ­¥å¼‚å¸¸ï¼ŒæŠŠé”™è¯¯åœ°å€ä¿å­˜åœ¨å¯„å­˜å™¨FAR_EL1ï¼ˆé”™è¯¯åœ°å€å¯„å­˜å™¨ï¼ŒFault Address Registerï¼‰ä¸­ (6)å¤„ç†å™¨å¤„äºç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰ï¼Œé‚£ä¹ˆæŠŠå¼‚å¸¸çº§åˆ«æå‡åˆ°1 (7)æ ¹æ®å‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL1ã€å¼‚å¸¸ç±»å‹å’Œç”Ÿæˆå¼‚å¸¸çš„å¼‚å¸¸çº§åˆ«è®¡ç®—å‡ºå¼‚å¸¸å‘é‡çš„è™šæ‹Ÿåœ°å€ï¼Œæ‰§è¡Œå¼‚å¸¸å‘é‡ å¯¹äº64ä½åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰ä¸‹ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå…¥å£æ˜¯el0_sync\n// arch/arm64/kernel/entry.S el0_sync: kernel_entry 0 // æŠŠæ‰€æœ‰é€šç”¨å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆ mrs x25, esr_el1 // è¯»å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨ lsr x24, x25, #ESR_ELx_EC_SHIFT // å¼‚å¸¸ç±»åˆ« cmp x24, #ESR_ELx_EC_SVC64 // 64ä½ç³»ç»Ÿè°ƒç”¨ b.eq el0_svc // ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨å‡½æ•°el0_svc cmp x24, #ESR_ELx_EC_DABT_LOW // å¼‚å¸¸çº§åˆ«0çš„æ•°æ®ä¸­æ­¢ b.eq el0_da // è®¿é—®æ•°æ®æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_da cmp x24, #ESR_ELx_EC_IABT_LOW // å¼‚å¸¸çº§åˆ«0çš„æŒ‡ä»¤ä¸­æ­¢ b.eq el0_ia // å–æŒ‡ä»¤æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_ia cmp x24, #ESR_ELx_EC_FP_ASIMD // è®¿é—®æµ®ç‚¹æˆ–è€…é«˜çº§SIMD b.eq el0_fpsimd_acc // è®¿é—®æµ®ç‚¹æˆ–é«˜çº§SIMDï¼Œè°ƒç”¨å‡½æ•°el0_fpsimd_acc cmp x24, #ESR_ELx_EC_FP_EXC64 // æµ®ç‚¹æˆ–è€…é«˜çº§SIMDå¼‚å¸¸ b.eq el0_fpsimd_exc // æµ®ç‚¹æˆ–é«˜çº§SIMDå¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_fpsimd_exc cmp x24, #ESR_ELx_EC_SYS64 // å¯é…ç½®é™·å…¥ b.eq el0_sys // å¯é…ç½®é™·å…¥ï¼Œè°ƒç”¨å‡½æ•°el0_sys cmp x24, #ESR_ELx_EC_SP_ALIGN // æ ˆå¯¹é½å¼‚å¸¸ b.eq el0_sp_pc cmp x24, #ESR_ELx_EC_PC_ALIGN // æŒ‡ä»¤åœ°å€å¯¹é½å¼‚å¸¸ b.eq el0_sp_pc cmp x24, #ESR_ELx_EC_UNKNOWN // å¼‚å¸¸çº§åˆ«0çš„æœªçŸ¥å¼‚å¸¸ b.eq el0_undef cmp x24, #ESR_ELx_EC_BREAKPT_LOW // å¼‚å¸¸çº§åˆ«0çš„è°ƒè¯•å¼‚å¸¸ b.ge el0_dbg b el0_inv å¯é…ç½®é™·å…¥ï¼Œè°ƒç”¨å‡½æ•°el0_sys\n// arch/arm64/kernel/entry.S el1_sync: kernel_entry 1 mrs x1, esr_el1 // è¯»å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨ lsr x24, x1, #ESR_ELx_EC_SHIFT // å¼‚å¸¸ç±»åˆ« cmp x24, #ESR_ELx_EC_DABT_CUR // å¼‚å¸¸çº§åˆ«1çš„æ•°æ®ä¸­æ­¢ b.eq el1_da cmp x24, #ESR_ELx_EC_IABT_CUR // å¼‚å¸¸çº§åˆ«1çš„æŒ‡ä»¤ä¸­æ­¢ b.eq el1_ia cmp x24, #ESR_ELx_EC_SYS64 // å¯é…ç½®é™·å…¥ b.eq el1_undef cmp x24, #ESR_ELx_EC_SP_ALIGN // æ ˆå¯¹é½å¼‚å¸¸ b.eq el1_sp_pc cmp x24, #ESR_ELx_EC_PC_ALIGN // æŒ‡ä»¤åœ°å€å¯¹é½å¼‚å¸¸ b.eq el1_sp_pc cmp x24, #ESR_ELx_EC_UNKNOWN // å¼‚å¸¸çº§åˆ«1çš„æœªçŸ¥å¼‚å¸¸ b.eq el1_undef cmp x24, #ESR_ELx_EC_BREAKPT_CUR // å¼‚å¸¸çº§åˆ«1çš„è°ƒè¯•å¼‚å¸¸ b.ge el1_dbg b el1_inv ä»¥64ä½åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰ä¸‹è®¿é—®æ•°æ®æ—¶ç”Ÿæˆçš„é¡µé”™è¯¯å¼‚å¸¸ä¸ºä¾‹ï¼Œå¤„ç†å‡½æ•°æ˜¯el0_da\n// arch/arm64/kernel/entry.S el0_da: mrs x26, far_el1 // è·å–æ•°æ®çš„è™šæ‹Ÿåœ°å€ï¼Œå­˜æ”¾åœ¨å¯„å­˜å™¨x26 enable_dbg_and_irq // msr daifclr, #(8 | 2) å¼€å¯è°ƒè¯•å¼‚å¸¸å’Œä¸­æ–­ â€¦ clear_address_tag x0, x26 mov x1, x25 mov x2, sp bl do_mem_abort // è°ƒç”¨Cè¯­è¨€å‡½æ•° b ret_to_user å†…æ ¸æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«1ï¼‰ä¸‹è®¿é—®æ•°æ®æ—¶ç”Ÿæˆçš„é¡µé”™è¯¯å¼‚å¸¸ä¸ºä¾‹è¯´æ˜ï¼Œå¤„ç†å‡½æ•°æ˜¯el1_da\n// arch/arm64/kernel/entry.S el1_da: mrs x3, far_el1 enable_dbg tbnz x23, #7, 1f enable_irq 1: clear_address_tag x0, x3 mov x2, sp // ç»“æ„ä½“ pt_regs bl do_mem_abort disable_irq kernel_exit 1 å¼‚å¸¸å¤„ç†ç¨‹åºæ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œè°ƒç”¨kernel_exitè¿”å›ã€‚kernel_exitæ˜¯ä¸€ä¸ªå®ï¼Œå‚æ•°elæ˜¯è¿”å›çš„å¼‚å¸¸çº§åˆ«ï¼Œ0è¡¨ç¤ºè¿”å›å¼‚å¸¸çº§åˆ«0ï¼Œ1è¡¨ç¤ºè¿”å›å¼‚å¸¸çº§åˆ«1\n// arch/arm64/kernel/entry.S .macro kernel_exit, el â€¦ ldp x21, x22, [sp, #S_PC] //åŠ è½½ä¿å­˜çš„å¯„å­˜å™¨ELR_EL1å’ŒSPSR_EL1çš„å€¼ â€¦ .if \\el == 0 /* å¦‚æœè¿”å›ç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰*/ ldr x23, [sp, #S_SP] msr sp_el0, x23 /* æ¢å¤å¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ */ â€¦ .endif msr elr_el1, x21 msr spsr_el1, x22 ldp x0, x1, [sp, #16 * 0] ldp x2, x3, [sp, #16 * 1] ldp x4, x5, [sp, #16 * 2] ldp x6, x7, [sp, #16 * 3] ldp x8, x9, [sp, #16 * 4] ldp x10, x11, [sp, #16 * 5] ldp x12, x13, [sp, #16 * 6] ldp x14, x15, [sp, #16 * 7] ldp x16, x17, [sp, #16 * 8] ldp x18, x19, [sp, #16 * 9] ldp x20, x21, [sp, #16 * 10] ldp x22, x23, [sp, #16 * 11] ldp x24, x25, [sp, #16 * 12] ldp x26, x27, [sp, #16 * 13] ldp x28, x29, [sp, #16 * 14] ldr lr, [sp, #S_LR] add sp, sp, #S_FRAME_SIZE eret .endm æ‰§è¡ŒæŒ‡ä»¤eretçš„æ—¶å€™ï¼Œå¤„ç†å™¨è‡ªåŠ¨ä½¿ç”¨å¯„å­˜å™¨SPSR_EL1ä¿å­˜çš„å€¼æ¢å¤å¤„ç†å™¨çŠ¶æ€ï¼Œä½¿ç”¨å¯„å­˜å™¨ELR_EL1ä¿å­˜çš„è¿”å›åœ°å€æ¢å¤ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counterï¼ŒPCï¼‰\n4.2 ä¸­æ–­ ä¸­æ–­æ˜¯å¤–å›´è®¾å¤‡é€šçŸ¥å¤„ç†å™¨çš„ä¸€ç§æœºåˆ¶\n4.2.1ã€€ä¸­æ–­æ§åˆ¶å™¨ ARMæ ‡å‡†çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œç§°ä¸ºé€šç”¨ä¸­æ–­æ§åˆ¶å™¨ï¼ˆGeneric Interrupt Controllerï¼ŒGICï¼‰ è½¯ä»¶ GIC v2æ§åˆ¶å™¨æœ‰ä¸¤ä¸ªä¸»è¦çš„åŠŸèƒ½å— 1ï¼‰åˆ†å‘å™¨ï¼ˆDistributorï¼‰ 2ï¼‰å¤„ç†å™¨æ¥å£ï¼ˆCPU Interfaceï¼‰ ä¸­æ–­æœ‰ä»¥ä¸‹4ç§ç±»å‹:SGIã€PPIã€SPIã€LPI SGI è½¯ä»¶ç”Ÿæˆçš„ä¸­æ–­ 0~15 PPI ç§æœ‰å¤–è®¾ä¸­æ–­ 16~31 SPI å…±äº«å¤–è®¾ä¸­æ–­ 32~1020 LPI å±€éƒ¨ç‰¹ç‚¹å¤–è®¾ä¸­æ–­\nè¾¹æ²¿è§¦å‘ã€ç”µå¹³è§¦å‘ ä¸­æ–­æœ‰ä»¥ä¸‹4ç§çŠ¶æ€ã€‚ ï¼ˆ1ï¼‰Inactiveï¼šä¸­æ–­æºæ²¡æœ‰å‘é€ä¸­æ–­ã€‚\nï¼ˆ2ï¼‰Pendingï¼šä¸­æ–­æºå·²ç»å‘é€ä¸­æ–­ï¼Œç­‰å¾…å¤„ç†å™¨å¤„ç†ã€‚\nï¼ˆ3ï¼‰Activeï¼šå¤„ç†å™¨å·²ç»ç¡®è®¤ä¸­æ–­ï¼Œæ­£åœ¨å¤„ç†ã€‚ ï¼ˆ4ï¼‰Active and pendingï¼šå¤„ç†å™¨æ­£åœ¨å¤„ç†ä¸­æ–­ï¼Œç›¸åŒçš„ä¸­æ–­æºåˆå‘é€äº†ä¸€ä¸ªä¸­æ–­ã€‚ GIC v2æ§åˆ¶å™¨æè¿°ç¬¦\n// drivers/irqchip/irq-gic.c static struct irq_chip gic_chip = { .irq_mask = gic_mask_irq, .irq_unmask = gic_unmask_irq, .irq_eoi = gic_eoi_irq, .irq_set_type = gic_set_type, .irq_get_irqchip_state = gic_irq_get_irqchip_state, .irq_set_irqchip_state = gic_irq_set_irqchip_state, .flags = IRQCHIP_SET_TYPE_MASKED | IRQCHIP_SKIP_SET_WAKE | IRQCHIP_MASK_ON_SUSPEND, }; 4.2.2ã€€ä¸­æ–­åŸŸ æ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨æœ¬åœ°çš„ç¡¬ä»¶ä¸­æ–­å·æ˜ å°„åˆ°å…¨å±€å”¯ä¸€çš„Linuxä¸­æ–­å·ï¼ˆä¹Ÿç§°ä¸ºè™šæ‹Ÿä¸­æ–­å·ï¼‰ï¼Œå†…æ ¸å®šä¹‰äº†ä¸­æ–­åŸŸirq_domainï¼Œæ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨æœ‰è‡ªå·±çš„ä¸­æ–­åŸŸ 1ï¼åˆ›å»ºä¸­æ–­åŸŸ ä¸­æ–­æ§åˆ¶å™¨çš„é©±åŠ¨ç¨‹åºä½¿ç”¨åˆ†é…å‡½æ•°irq_domain_add_*()åˆ›å»ºå’Œæ³¨å†Œä¸­æ–­åŸŸï¼Œè°ƒç”¨è€…ç»™åˆ†é…å‡½æ•°æä¾›irq_domain_opsç»“æ„ä½“ï¼Œåˆ†é…å‡½æ•°åœ¨æ‰§è¡ŒæˆåŠŸçš„æ—¶å€™è¿”å›irq_domainçš„æŒ‡é’ˆ\nåˆ†é…ä¸»è¦ä¸ºå‡½æ•°__irq_domain_add()ã€‚å‡½æ•°__irq_domain_add()çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ï¼šåˆ†é…ä¸€ä¸ªirq_domainç»“æ„ä½“ï¼Œåˆå§‹åŒ–æˆå‘˜ï¼Œç„¶åæŠŠä¸­æ–­åŸŸæ·»åŠ åˆ°å…¨å±€é“¾è¡¨irq_domain_listä¸­ 2ï¼åˆ›å»ºæ˜ å°„ å‘ä¸­æ–­åŸŸæ·»åŠ ç¡¬ä»¶ä¸­æ–­å·åˆ°Linuxä¸­æ–­å·çš„æ˜ å°„ï¼Œå†…æ ¸æä¾›äº†å‡½æ•°irq_create_mapping\nunsigned int irq_create_mapping(struct irq_domain *domain, irq_hw_number_t hwirq); 3ï¼æŸ¥æ‰¾æ˜ å°„ ä¸­æ–­å¤„ç†ç¨‹åºéœ€è¦æ ¹æ®ç¡¬ä»¶ä¸­æ–­å·æŸ¥æ‰¾Linuxä¸­æ–­å·ï¼Œå†…æ ¸æä¾›äº†å‡½æ•°irq_find_mappingï¼š\nunsigned int irq_find_mapping(struct irq_domain *domain, irq_hw_number_t hwirq); è¾“å…¥å‚æ•°æ˜¯ä¸­æ–­åŸŸå’Œç¡¬ä»¶ä¸­æ–­å·ï¼Œè¿”å›Linuxä¸­æ–­å·\n4.2.3ã€€ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ– ARM64æ¶æ„ä½¿ç”¨æ‰å¹³è®¾å¤‡æ ‘ï¼ˆFlattened Device Treeï¼ŒFDTï¼‰æè¿°æ¿å¡çš„ç¡¬ä»¶ä¿¡æ¯ã€‚ç¼–å†™è®¾å¤‡æ ‘æºæ–‡ä»¶ï¼ˆDevice Tree Sourceï¼ŒDTSï¼‰ï¼Œå­˜æ”¾åœ¨ç›®å½•â€œarch/arm64/boot/dtsâ€ä¸‹ï¼Œç„¶åä½¿ç”¨è®¾å¤‡æ ‘ç¼–è¯‘å™¨ï¼ˆDevice Tree Compilerï¼ŒDTCï¼‰æŠŠè®¾å¤‡æ ‘æºæ–‡ä»¶è½¬æ¢æˆè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆDevice Tree Blobï¼ŒDTBï¼‰ï¼Œæœ€åæŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶å†™åˆ°å­˜å‚¨è®¾å¤‡ä¸Š\n1ï¼è®¾å¤‡æ ‘æºæ–‡ä»¶ 3.åˆå§‹åŒ– å‡½æ•°irqchip_init â€“\u003e of_irq_init â€“\u003e __irqchip_of_table start_kernel() -\u003e init_IRQ() -\u003e irqchip_init() -\u003e of_irq_init() -\u003e gic_of_init() -\u003e __gic_init_bases() -\u003e __irqchip_of_table() 4.2.4ã€€Linuxä¸­æ–­å¤„ç† å‘ä¸­æ–­åŸŸæ·»åŠ ç¡¬ä»¶ä¸­æ–­å·åˆ°Linuxä¸­æ–­å·çš„æ˜ å°„æ—¶ï¼Œå†…æ ¸åˆ†é…ä¸€ä¸ªLinuxä¸­æ–­å·å’Œä¸€ä¸ªä¸­æ–­æè¿°ç¬¦irq_desc ä¸­æ–­æè¿°ç¬¦æœ‰ä¸¤ä¸ªå±‚æ¬¡çš„ä¸­æ–­å¤„ç†å‡½æ•°\nå­˜å‚¨Linuxä¸­æ–­å·åˆ°ä¸­æ–­æè¿°ç¬¦çš„æ˜ å°„å…³ç³» (1)ä¸­æ–­ç¼–å·æ˜¯ç¨€ç–çš„ï¼ˆå³ä¸è¿ç»­ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨åŸºæ•°æ ‘ï¼ˆradix treeï¼‰å­˜å‚¨ (2)ä¸­æ–­ç¼–å·æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆä½¿ç”¨æ•°ç»„å­˜å‚¨\n// kernel/irq/irqdesc.c #ifdef CONFIG_SPARSE_IRQ static RADIX_TREE(irq_desc_tree, GFP_KERNEL); #else struct irq_desc irq_desc[NR_IRQS] __cacheline_aligned_in_smp = { [0 ... NR_IRQS-1] = { .handle_irq = handle_bad_irq, .depth = 1, .lock = __RAW_SPIN_LOCK_UNLOCKED(irq_desc-\u003elock), } }; #endif handle_irq() -\u003e gic_irq_domain_map() // ç¡¬ä»¶ä¸­æ–­å·å°äº32 -\u003e handle_percpu_devid_irq() // ä¸­æ–­å·å¤§äºæˆ–ç­‰äº32 -\u003e handle_fasteoi_irq() irq_create_mapping() -\u003e irq_domain_associate() -\u003e domain-\u003eops-\u003emap() // drivers/irqchip/irq-gic.c static int gic_irq_domain_map(struct irq_domain *d, unsigned int irq, irq_hw_number_t hw) { struct gic_chip_data *gic = d-\u003ehost_data; if (hw \u003c 32) { irq_set_percpu_devid(irq); irq_domain_set_info(d, irq, hw, \u0026gic-\u003echip, d-\u003ehost_data, handle_percpu_devid_irq, NULL, NULL); irq_set_status_flags(irq, IRQ_NOAUTOEN); } else { irq_domain_set_info(d, irq, hw, \u0026gic-\u003echip, d-\u003ehost_data, handle_fasteoi_irq, NULL, NULL); irq_set_probe(irq); } return 0; } Linuxä¸­æ–­å¤„ç†æµç¨‹ // arch/arm64/kernel/entry.S .align 6 el0_irq: kernel_entry 0 el0_irq_naked: enable_dbg â€¦ irq_handler â€¦ b ret_to_user ENDPROC(el0_irq) .macro irq_handler ldr_l x1, handle_arch_irq mov x0, sp irq_stack_entry blr x1 irq_stack_exit .endm å‡½æ•°handle_irq_eventï¼Œæ‰§è¡Œè®¾å¤‡é©±åŠ¨ç¨‹åºæ³¨å†Œçš„å¤„ç†å‡½æ•°\n// handle_irq_event() -\u003e handle_irq_event_percpu() -\u003e __handle_irq_event_percpu() kernel/irq/handle.c irqreturn_t __handle_irq_event_percpu(struct irq_desc *desc, unsigned int *flags) { irqreturn_t retval = IRQ_NONE; unsigned int irq = desc-\u003eirq_data.irq; struct irqaction *action; for_each_action_of_desc(desc, action) { irqreturn_t res; â€¦ res = action-\u003ehandler(irq, action-\u003edev_id); â€¦ switch (res) { case IRQ_WAKE_THREAD: â€¦ __irq_wake_thread(desc, action); /*ç»§ç»­å¾€ä¸‹èµ°ï¼ŒæŠŠâ€œaction-\u003eflagsâ€ä½œä¸ºç”Ÿæˆéšæœºæ•°çš„ä¸€ä¸ªå› å­ */ case IRQ_HANDLED: *flags |= action-\u003eflags; break; default: break; } retval |= res; } return retval; } 4.2.5ã€€ä¸­æ–­çº¿ç¨‹åŒ– å†…æ ¸æä¾›çš„å‡½æ•°request_threaded_irq()ç”¨æ¥æ³¨å†Œçº¿ç¨‹åŒ–çš„ä¸­æ–­\nint request_threaded_irq(unsigned int irq, irq_handler_t handler, irq_handler_t thread_fn, unsigned long flags, const char *name, void *dev); æ¯ä¸ªä¸­æ–­å¤„ç†æè¿°ç¬¦ï¼ˆirqactionï¼‰å¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œæˆå‘˜threadæŒ‡å‘å†…æ ¸çº¿ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ï¼Œæˆå‘˜thread_fnæŒ‡å‘çº¿ç¨‹å¤„ç†å‡½æ•°\n// include/linux/interrupt.h struct irqaction { â€¦ irq_handler_t thread_fn; struct task_struct *thread; â€¦ } ____cacheline_internodealigned_in_smp; ä¸­æ–­å¤„ç†çº¿ç¨‹æ˜¯ä¼˜å…ˆçº§ä¸º50ã€è°ƒåº¦ç­–ç•¥æ˜¯SCHED_FIFOçš„å®æ—¶å†…æ ¸çº¿ç¨‹ï¼Œåç§°æ˜¯â€œirq/â€åé¢è·Ÿç€Linuxä¸­æ–­å·ï¼Œçº¿ç¨‹å¤„ç†å‡½æ•°æ˜¯irq_thread()\nrequest_threaded_irq() -\u003e __setup_irq() -\u003e setup_irq_thread() // kernel/irq/manage.c static int setup_irq_thread(struct irqaction *new, unsigned int irq, bool secondary) { struct task_struct *t; struct sched_param param = { .sched_priority = MAX_USER_RT_PRIO/2, }; if (!secondary) { t = kthread_create(irq_thread, new, \"irq/%d-%s\", irq, new-\u003ename); } else { t = kthread_create(irq_thread, new, \"irq/%d-s-%s\", irq, new-\u003ename); param.sched_priority -= 1; } â€¦ sched_setscheduler_nocheck(t, SCHED_FIFO, \u0026param); â€¦ } handle_fasteoi_irq() -\u003e handle_irq_event() -\u003e handle_irq_event_percpu() -\u003e __handle_irq_event_percpu() // kernel/irq/handle.c irqreturn_t __handle_irq_event_percpu(struct irq_desc *desc, unsigned int *flags) { irqreturn_t retval = IRQ_NONE; unsigned int irq = desc-\u003eirq_data.irq; struct irqaction *action; for_each_action_of_desc(desc, action) { irqreturn_t res; â€¦ res = action-\u003ehandler(irq, action-\u003edev_id); â€¦ switch (res) { case IRQ_WAKE_THREAD: â€¦ __irq_wake_thread(desc, action); /*ç»§ç»­å¾€ä¸‹èµ°ï¼ŒæŠŠâ€œaction-\u003eflagsâ€ä½œä¸ºç”Ÿæˆéšæœºæ•°çš„ä¸€ä¸ªå› å­*/ case IRQ_HANDLED: *flags |= action-\u003eflags; break; default: break; } retval |= res; } return retval; } ä¸­æ–­å¤„ç†çº¿ç¨‹çš„å¤„ç†å‡½æ•°æ˜¯irq_thread()ï¼Œè°ƒç”¨å‡½æ•°irq_thread_fn()ï¼Œç„¶åå‡½æ•°irq_thread_fn()è°ƒç”¨æ³¨å†Œçš„çº¿ç¨‹å¤„ç†å‡½æ•°\n// kernel/irq/manage.c static int irq_thread(void *data) { struct callback_head on_exit_work; struct irqaction *action = data; struct irq_desc *desc = irq_to_desc(action-\u003eirq); irqreturn_t (*handler_fn)(struct irq_desc *desc, struct irqaction *action); if (force_irqthreads \u0026\u0026 test_bit(IRQTF_FORCED_THREAD, \u0026action-\u003ethread_flags)) handler_fn = irq_forced_thread_fn; else handler_fn = irq_thread_fn; â€¦ while (!irq_wait_for_interrupt(action)) { irqreturn_t action_ret; â€¦ action_ret = handler_fn(desc, action); â€¦ } â€¦ return 0; } static irqreturn_t irq_thread_fn(struct irq_desc *desc, struct irqaction *action) { irqreturn_t ret; ret = action-\u003ethread_fn(action-\u003eirq, action-\u003edev_id); irq_finalize_oneshot(desc, action); return ret; } 4.2.6ã€€ç¦æ­¢/å¼€å¯ä¸­æ–­ è½¯ä»¶å¯ä»¥ç¦æ­¢ä¸­æ–­ï¼Œä½¿å¤„ç†å™¨ä¸å“åº”æ‰€æœ‰ä¸­æ–­è¯·æ±‚ï¼Œä½†æ˜¯ä¸å¯å±è”½ä¸­æ–­ï¼ˆNon Maskable Interruptï¼ŒNMIï¼‰æ˜¯ä¸ªä¾‹å¤–ï¼Œæ¥å£ï¼š (1)local_irq_disable() (2)local_irq_save(flags) å…ˆæŠŠä¸­æ–­çŠ¶æ€ä¿å­˜åœ¨å‚æ•°flagsä¸­ï¼Œç„¶åç¦æ­¢ä¸­æ–­ å¼€å¯ä¸­æ–­çš„æ¥å£ (1)local_irq_enable() (2)local_irq_restore(flags) æ¢å¤æœ¬åœ°å¤„ç†å™¨çš„ä¸­æ–­çŠ¶æ€ ARM64æ¶æ„ç¦æ­¢ä¸­æ–­çš„å‡½æ•°local_irq_disable()\nlocal_irq_disable() -\u003e raw_local_irq_disable() -\u003e arch_local_irq_disable() // arch/arm64/include/asm/irqflags.h // ä¸­æ–­æ©ç ä½è®¾ç½®æˆ1 static inline void arch_local_irq_disable(void) { asm volatile( \"msr daifset, #2 // arch_local_irq_disable\" : : : \"memory\"); } ARM64æ¶æ„å¼€å¯ä¸­æ–­çš„å‡½æ•°local_irq_enable()\nlocal_irq_enable() -\u003e raw_local_irq_enable() -\u003e arch_local_irq_enable() // arch/arm64/include/asm/irqflags.h // ä¸­æ–­æ©ç ä½è®¾ç½®æˆ0 static inline void arch_local_irq_enable(void) { asm volatile( \"msr daifclr, #2 // arch_local_irq_enable\" : : : \"memory\"); } 4.2.7ã€€ç¦æ­¢/å¼€å¯å•ä¸ªä¸­æ–­ // ç¦æ­¢å•ä¸ªä¸­æ–­çš„å‡½æ•° void disable_irq(unsigned int irq); // å¼€å¯å•ä¸ªä¸­æ–­çš„å‡½æ•° void enable_irq(unsigned int irq); 4.2.8ã€€ä¸­æ–­äº²å’Œæ€§ è®¾ç½®ä¸­æ–­äº²å’Œæ€§ï¼Œå…è®¸ä¸­æ–­æ§åˆ¶å™¨æŠŠæŸä¸ªä¸­æ–­è½¬å‘ç»™å“ªäº›å¤„ç†å™¨ï¼Œæœ‰ä¸¤ç§é…ç½®æ–¹æ³• (1)å†™æ–‡ä»¶â€œ/proc/irq/IRQ#/smp_affinityâ€ï¼Œå‚æ•°æ˜¯ä½æ©ç  (2)æ–‡ä»¶â€œ/proc/irq/IRQ#/smp_affinity_listâ€ï¼Œå‚æ•°æ˜¯å¤„ç†å™¨åˆ—è¡¨ 4.2.9ã€€å¤„ç†å™¨é—´ä¸­æ–­ å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªå¤„ç†å™¨å¯ä»¥å‘å…¶ä»–å¤„ç†å™¨å‘é€ä¸­æ–­ å¤„ç†å¤„ç†å™¨é—´ä¸­æ–­çš„æ‰§è¡Œæµç¨‹\nå¤„ç†å¤„ç†å™¨é—´ä¸­æ–­ 4.3ã€€ä¸­æ–­ä¸‹åŠéƒ¨ ä¸­æ–­å¤„ç†ç¨‹åºåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸ŠåŠéƒ¨ï¼ˆtop halfï¼Œthï¼‰åœ¨å…³é—­ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œåªåšå¯¹æ—¶é—´éå¸¸æ•æ„Ÿã€ä¸ç¡¬ä»¶ç›¸å…³æˆ–è€…ä¸èƒ½è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­çš„å·¥ä½œï¼›ä¸‹åŠéƒ¨ï¼ˆbottom halfï¼Œbhï¼‰åœ¨å¼€å¯ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œå¯ä»¥è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­ ä¸ŠåŠéƒ¨ç§°ä¸ºç¡¬ä¸­æ–­ï¼ˆhardirqï¼‰ï¼Œä¸‹åŠéƒ¨æœ‰3ç§ï¼šè½¯ä¸­æ–­ï¼ˆsoftirqï¼‰ã€å°ä»»åŠ¡ï¼ˆtaskletï¼‰å’Œå·¥ä½œé˜Ÿåˆ—ï¼ˆworkqueueï¼‰ 4.3.1ã€€è½¯ä¸­æ–­ å†…æ ¸å®šä¹‰äº†ä¸€å¼ è½¯ä¸­æ–­å‘é‡è¡¨ï¼Œæ¯ç§è½¯ä¸­æ–­æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œå¯¹åº”ä¸€ä¸ªsoftirq_actionå®ä¾‹ï¼Œsoftirq_actionå®ä¾‹çš„æˆå‘˜actionæ˜¯å¤„ç†å‡½æ•°\n// kernel/softirq.c static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp; // include/linux/interrupt.h struct softirq_action { void (*action)(struct softirq_action *); }; 1ï¼è½¯ä¸­æ–­çš„ç§ç±» å†…æ ¸å®šä¹‰äº†10ç§è½¯ä¸­æ–­\n// include/linux/interrupt.h enum { HI_SOFTIRQ=0, // é«˜ä¼˜å…ˆçº§çš„å°ä»»åŠ¡ TIMER_SOFTIRQ, // å®šæ—¶å™¨è½¯ä¸­æ–­ NET_TX_SOFTIRQ, // ç½‘ç»œæ ˆå‘é€æŠ¥æ–‡çš„è½¯ä¸­æ–­ NET_RX_SOFTIRQ, // ç½‘ç»œæ ˆæ¥æ”¶æŠ¥æ–‡çš„è½¯ä¸­æ–­ BLOCK_SOFTIRQ, // å—è®¾å¤‡è½¯ä¸­æ–­ IRQ_POLL_SOFTIRQ, // æ”¯æŒI/Oè½®è¯¢çš„å—è®¾å¤‡è½¯ä¸­æ–­ TASKLET_SOFTIRQ, // ä½ä¼˜å…ˆçº§çš„å°ä»»åŠ¡ SCHED_SOFTIRQ, // è°ƒåº¦è½¯ä¸­æ–­ HRTIMER_SOFTIRQ, /* æ²¡æœ‰ä½¿ç”¨ï¼Œä½†æ˜¯ä¿ç•™ï¼Œå› ä¸ºæœ‰äº›å·¥å…·ä¾èµ–è¿™ä¸ªç¼–å· */ RCU_SOFTIRQ, /* RCUè½¯ä¸­æ–­åº”è¯¥æ€»æ˜¯æœ€åä¸€ä¸ªè½¯ä¸­æ–­ */ NR_SOFTIRQS }; 2ï¼æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•° open_softirq()ç”¨æ¥æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ï¼Œåœ¨è½¯ä¸­æ–­å‘é‡è¡¨ä¸­ä¸ºæŒ‡å®šçš„è½¯ä¸­æ–­ç¼–å·è®¾ç½®å¤„ç†å‡½æ•°\n// kernel/softirq.c void open_softirq(int nr, void (*action)(struct softirq_action *)) { softirq_vec[nr].action = action; } 3ï¼è§¦å‘è½¯ä¸­æ–­ å‡½æ•°raise_softirqç”¨æ¥è§¦å‘è½¯ä¸­æ–­ï¼Œå‚æ•°æ˜¯è½¯ä¸­æ–­ç¼–å·ã€‚\nvoid raise_softirq(unsigned int nr); raise_softirq() -\u003e raise_softirq_irqoff() -\u003e __raise_softirq_irqoff() // kernel/softirq.c void __raise_softirq_irqoff(unsigned int nr) { or_softirq_pending(1UL \u003c\u003c nr); } // å®or_softirq_pendingå±•å¼€ irq_stat[smp_processor_id()].__softirq_pending |= (1UL \u003c\u003c nr); 4.æ‰§è¡Œè½¯ä¸­æ–­ ä¸­æ–­å¤„ç†ç¨‹åºçš„ååŠéƒ¨åˆ†ï¼Œè°ƒç”¨å‡½æ•°irq_exit()ä»¥é€€å‡ºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œå¤„ç†è½¯ä¸­æ–­\n// kernel/softirq.c void irq_exit(void) { â€¦ preempt_count_sub(HARDIRQ_OFFSET); if (!in_interrupt() \u0026\u0026 local_softirq_pending()) invoke_softirq(); â€¦ } // kernel/softirq.c static inline void invoke_softirq(void) { if (ksoftirqd_running()) return; if (!force_irqthreads) { __do_softirq(); } else { wakeup_softirqd(); } } å‡½æ•°__do_softirqæ˜¯æ‰§è¡Œè½¯ä¸­æ–­çš„æ ¸å¿ƒå‡½æ•°\n// kernel/softirq.c #define MAX_SOFTIRQ_TIME msecs_to_jiffies(2) #define MAX_SOFTIRQ_RESTART 10 asmlinkage __visible void __softirq_entry __do_softirq(void) { unsigned long end = jiffies + MAX_SOFTIRQ_TIME; unsigned long old_flags = current-\u003eflags; int max_restart = MAX_SOFTIRQ_RESTART; struct softirq_action *h; bool in_hardirq; __u32 pending; int softirq_bit; â€¦ pending = local_softirq_pending(); â€¦ __local_bh_disable_ip(_RET_IP_, SOFTIRQ_OFFSET); â€¦ restart: set_softirq_pending(0); local_irq_enable(); h = softirq_vec; while ((softirq_bit = ffs(pending))) { â€¦ h += softirq_bit - 1; â€¦ h-\u003eaction(h); â€¦ h++; pending \u003e\u003e= softirq_bit; } â€¦ local_irq_disable(); pending = local_softirq_pending(); if (pending) { if (time_before(jiffies, end) \u0026\u0026 !need_resched() \u0026\u0026 --max_restart) goto restart; wakeup_softirqd(); } â€¦ __local_bh_enable(SOFTIRQ_OFFSET); â€¦ } 5ï¼æŠ¢å è®¡æ•°å™¨ è¿›ç¨‹çš„thread_infoç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨ï¼šint preempt_countï¼Œå®ƒç”¨æ¥è¡¨ç¤ºå½“å‰è¿›ç¨‹èƒ½ä¸èƒ½è¢«æŠ¢å ,å¯é€šè¿‡æŠ¢å è®¡æ•°å™¨åˆ¤æ–­å¤„åœ¨ä»€ä¹ˆåœºæ™¯ // nclude/linux/preempt.h #define in_irq() (hardirq_count()) // æ­£åœ¨æ‰§è¡Œç¡¬ä¸­æ–­ #define in_softirq() (softirq_count()) // ç¦æ­¢è½¯ä¸­æ–­å’Œæ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­ #define in_interrupt() (irq_count()) // æ­£åœ¨æ‰§è¡Œä¸å¯å±è”½ä¸­æ–­ #define in_serving_softirq() (softirq_count() \u0026 SOFTIRQ_OFFSET) // æ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­ #define in_nmi() (preempt_count() \u0026 NMI_MASK) // ä¸å¯å±è”½ä¸­æ–­åœºæ™¯ #define in_task() (!(preempt_count() \u0026 \\ (NMI_MASK | HARDIRQ_MASK | SOFTIRQ_OFFSET))) // è¿›ç¨‹ä¸Šä¸‹æ–‡ #define hardirq_count() (preempt_count() \u0026 HARDIRQ_MASK) #define softirq_count() (preempt_count() \u0026 SOFTIRQ_MASK) #define irq_count() (preempt_count() \u0026 (HARDIRQ_MASK | SOFTIRQ_MASK \\ | NMI_MASK)) 6ï¼ç¦æ­¢/å¼€å¯è½¯ä¸­æ–­ ç¦æ­¢è½¯ä¸­æ–­çš„å‡½æ•°æ˜¯local_bh_disable()\ninclude/linux/bottom_half.h static inline void local_bh_disable(void) { __local_bh_disable_ip(_THIS_IP_, SOFTIRQ_DISABLE_OFFSET); } static __always_inline void __local_bh_disable_ip(unsigned long ip, unsigned int cnt) { preempt_count_add(cnt); barrier(); } include/linux/preempt.h #define SOFTIRQ_DISABLE_OFFSET (2 * SOFTIRQ_OFFSET) // å¼€å¯è½¯ä¸­æ–­ local_bh_enable() 4.3.2 å°ä»»åŠ¡ tasklet å°ä»»åŠ¡ï¼ˆtaskletï¼‰æ˜¯åŸºäºè½¯ä¸­æ–­å®ç°\n1.æ•°æ®ç»“æ„ // include/linux/interrupt.h struct tasklet_struct { struct tasklet_struct *next; unsigned long state; atomic_t count; void (*func)(unsigned long); unsigned long data; }; 2ï¼ç¼–ç¨‹æ¥å£ 3ï¼æŠ€æœ¯åŸç† 4.3.3ã€€å·¥ä½œé˜Ÿåˆ— 4.4ã€€ç³»ç»Ÿè°ƒç”¨ ç³»ç»Ÿè°ƒç”¨æ˜¯å†…æ ¸ç»™ç”¨æˆ·ç¨‹åºæä¾›çš„ç¼–ç¨‹æ¥å£ã€‚ç”¨æˆ·ç¨‹åºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œé€šå¸¸ä½¿ç”¨glibcåº“é’ˆå¯¹å•ä¸ªç³»ç»Ÿè°ƒç”¨å°è£…çš„å‡½æ•°ã€‚glibcåº“æ²¡æœ‰é’ˆå¯¹æŸä¸ªç³»ç»Ÿè°ƒç”¨å°è£…å‡½æ•°ï¼Œç”¨æˆ·ç¨‹åºå¯é€šç”¨çš„å°è£…å‡½æ•°syscall() #define _GNU_SOURCE #include #include /* å®šä¹‰ SYS_xxx */ long syscall(long number, ...); // numberç³»ç»Ÿè°ƒç”¨å· // è¿”å›å€¼ 0æˆåŠŸï¼Œ-1é”™è¯¯ï¼Œé”™è¯¯å·åœ¨errno åº”ç”¨ç¨‹åºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨fork()åˆ›å»ºå­è¿›ç¨‹ï¼Œæœ‰ä¸¤ç§è°ƒç”¨æ–¹æ³•\nret = fork(); ret = syscall(SYS_fork); ARM64å¤„ç†å™¨æä¾›çš„ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤æ˜¯svc (1)64ä½åº”ç”¨ç¨‹åºä½¿ç”¨å¯„å­˜å™¨x8ä¼ é€’ç³»ç»Ÿè°ƒç”¨å· (2)å¯„å­˜å™¨x0ï½x6æœ€å¤šå¯ä»¥ä¼ é€’7ä¸ªå‚æ•° (3)ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œä½¿ç”¨å¯„å­˜å™¨x0å­˜æ”¾è¿”å›å€¼ 4.4.1 å®šä¹‰ç³»ç»Ÿè°ƒç”¨ Linuxå†…æ ¸ä½¿ç”¨å®SYSCALL_DEFINEå®šä¹‰ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ›å»ºå­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨fork // kernel/fork.c SYSCALL_DEFINE0(fork) { #ifdef CONFIG_MMU return _do_fork(SIGCHLD, 0, 0, NULL, NULL, 0); #else /* å¦‚æœå¤„ç†å™¨æ²¡æœ‰å†…å­˜ç®¡ç†å•å…ƒï¼Œé‚£ä¹ˆä¸æ”¯æŒ */ return -EINVAL; #endif } // SYSCALL_DEFINE0(fork) å±•å¼€ asmlinkage long sys_fork(void) // asmlinkage è¡¨ç¤ºCè¯­è¨€å‡½æ•°å¯ä»¥è¢«æ±‡ç¼–ä»£ç è°ƒç”¨ ARM64æ¶æ„å®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨è¡¨sys_call_table\n// arch/arm64/kernel/sys.c #undef __SYSCALL #define __SYSCALL(nr, sym) [nr] = sym, void * const sys_call_table[__NR_syscalls] __aligned(4096) = { [0 ... __NR_syscalls - 1] = sys_ni_syscall, #include }; ARM64æ¶æ„ï¼Œå¤´æ–‡ä»¶â€œasm/unistd.hâ€æ˜¯â€œarch/arm64/include/asm/unistd.hâ€ã€‚\n// arch/arm64/include/asm/unistd.h #include // arch/arm64/include/uapi/asm/unistd.h #include // include/asm-generic/unistd.h #include // include/uapi/asm-generic/unistd.h #define __NR_io_setup 0 /* ç³»ç»Ÿè°ƒç”¨å·0 */ __SC_COMP(__NR_io_setup, sys_io_setup, compat_sys_io_setup) /* [0] = sys_io_setup, */ â€¦ #define __NR_fork 1079 /* ç³»ç»Ÿè°ƒç”¨å·1079 */ #ifdef CONFIG_MMU __SYSCALL(__NR_fork, sys_fork) /* [1079] = sys_fork, */ #else __SYSCALL(__NR_fork, sys_ni_syscall) #endif /* CONFIG_MMU */ #undef __NR_syscalls #define __NR_syscalls (__NR_fork+1) 4.4.2 æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ ARM64å¤„ç†å™¨æŠŠç³»ç»Ÿè°ƒç”¨åˆ’åˆ†åˆ°åŒæ­¥å¼‚å¸¸ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨çš„å…¥å£ï¼Œ64ä½åº”ç”¨ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤svcï¼Œç³»ç»Ÿè°ƒç”¨å…¥å£ el0_sync\n// arch/arm64/kernel.c .align 6 el0_sync: kernel_entry 0 mrs x25, esr_el1 // è¯»å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨ lsr x24, x25, #ESR_ELx_EC_SHIFT // å¼‚å¸¸ç±»åˆ« cmp x24, #ESR_ELx_EC_SVC64 // 64ä½ç³»ç»Ÿè°ƒç”¨ b.eq el0_svc â€¦ el0_svcè´Ÿè´£æ‰§è¡Œç³»ç»Ÿè°ƒç”¨\n// arch/arm64/kernel.c /* * è¿™äº›æ˜¯ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºä½¿ç”¨çš„å¯„å­˜å™¨ï¼Œ * å…è®¸æˆ‘ä»¬ç†è®ºä¸Šæœ€å¤šä¼ é€’7ä¸ªå‚æ•°ç»™ä¸€ä¸ªå‡½æ•° â€“ x0ï½x6 * * x7ä¿ç•™ï¼Œç”¨äº32ä½æ¨¡å¼çš„ç³»ç»Ÿè°ƒç”¨å· */ sc_nr .req x25 // ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡ scno .req x26 // ç³»ç»Ÿè°ƒç”¨å· stbl .req x27 // ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€ tsk .req x28 // å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€ .align 6 el0_svc: adrp stbl, sys_call_table // åŠ è½½ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€ uxtw scno, w8 // å¯„å­˜å™¨w8é‡Œé¢çš„ç³»ç»Ÿè°ƒç”¨å· mov sc_nr, #__NR_syscalls el0_svc_naked: // 32ä½ç³»ç»Ÿè°ƒç”¨çš„å…¥å£ stp x0, scno, [sp, #S_ORIG_X0] // ä¿å­˜åŸæ¥çš„x0å’Œç³»ç»Ÿè°ƒç”¨å· enable_dbg_and_irq ct_user_exit 1 // ptraceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè·³è½¬åˆ°__sys_traceå¤„ç† ldr x16, [tsk, #TSK_TI_FLAGS] // æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨é’©å­ tst x16, #_TIF_SYSCALL_WORK b.ne __sys_trace cmp scno, sc_nr // æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨å·æ˜¯å¦è¶…è¿‡ä¸Šé™ b.hs ni_sys ldr x16, [stbl, scno, lsl #3] // ç³»ç»Ÿè°ƒç”¨è¡¨è¡¨é¡¹çš„åœ°å€ blr x16 // è°ƒç”¨sys_*å‡½æ•° b ret_fast_syscall ni_sys: mov x0, sp bl do_ni_syscall b ret_fast_syscall ENDPROC(el0_svc) ret_fast_syscallä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´\n// arch/arm64/kernel.c ret_fast_syscall: disable_irq str x0, [sp, #S_X0] /* DEFINE(S_X0, offsetof(struct pt_regs, regs[0])); */ ldr x1, [tsk, #TSK_TI_FLAGS] and x2, x1, #_TIF_SYSCALL_WORK cbnz x2, ret_fast_syscall_trace and x2, x1, #_TIF_WORK_MASK cbnz x2, work_pending enable_step_tsk x1, x2 kernel_exit 0 ret_fast_syscall_trace: enable_irq // å¼€å¯ä¸­æ–­ b __sys_trace_return_skipped // æˆ‘ä»¬å·²ç»ä¿å­˜äº†x0 work_pending: mov x0, sp // 'regs' bl do_notify_resume #ifdef CONFIG_TRACE_IRQFLAGS bl trace_hardirqs_on // åœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œæ—¶å¼€å¯ä¸­æ–­ #endif ldr x1, [tsk, #TSK_TI_FLAGS] // é‡æ–°æ£€æŸ¥å•æ­¥æ‰§è¡Œ b finish_ret_to_user ret_to_user: â€¦ finish_ret_to_user: enable_step_tsk x1, x2 kernel_exit 0 ENDPROC(ret_to_user) work_pendingè°ƒç”¨å‡½æ•°do_notify_resume\n// arch/arm64/kernel/signal.c asmlinkage void do_notify_resume(struct pt_regs *regs, unsigned int thread_flags) { â€¦ do { if (thread_flags \u0026 _TIF_NEED_RESCHED) { schedule(); } else { local_irq_enable(); if (thread_flags \u0026 _TIF_UPROBE) uprobe_notify_resume(regs); if (thread_flags \u0026 _TIF_SIGPENDING) do_signal(regs); if (thread_flags \u0026 _TIF_NOTIFY_RESUME) { clear_thread_flag(TIF_NOTIFY_RESUME); tracehook_notify_resume(regs); } if (thread_flags \u0026 _TIF_FOREIGN_FPSTATE) fpsimd_restore_current_state(); } local_irq_disable(); thread_flags = READ_ONCE(current_thread_info()-\u003eflags); } while (thread_flags \u0026 _TIF_WORK_MASK); } ç¬¬5ç«  å†…æ ¸äº’æ–¥æŠ€æœ¯ ä¸´ç•ŒåŒºçš„æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿æˆ–è€…å¯èƒ½ç¡çœ äº’æ–¥æŠ€æœ¯ (1)ä¿¡å·é‡ (2)è¯»å†™ä¿¡å·é‡ (3)äº’æ–¥é” (4)å®æ—¶äº’æ–¥é” ä¸´ç•ŒåŒºçš„æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œå¹¶ä¸”ä¸ä¼šç¡çœ  äº’æ–¥æŠ€æœ¯ (1)åŸå­å˜é‡ (2)è‡ªæ—‹é” (3)è¯»å†™é” (4)é¡ºåºé” è¿›ç¨‹äº’æ–¥æŠ€æœ¯ (1)ç¦æ­¢å†…æ ¸æŠ¢å  (2)ç¦æ­¢è½¯ä¸­æ–­ (3)ç¦æ­¢ç¡¬ä¸­æ–­ å…ä½¿ç”¨é”çš„äº’æ–¥æŠ€æœ¯ (1)æ¯å¤„ç†å™¨å˜é‡ (2)æ¯å¤„ç†å™¨è®¡æ•°å™¨ (3)å†…å­˜å±éšœ (4)è¯»-å¤åˆ¶æ›´æ–°(Read-Copy Update RCU) (5)å¯ç¡çœ RCU å†…æ ¸æä¾›äº†æ­»é”æ£€æµ‹å·¥å…·lockdep 5.1 ä¿¡å·é‡ ä¿¡å·é‡å…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¿¡å·é‡çš„è®¡æ•°å€¼è®¾ç½®ä¸º1ï¼Œå³äºŒå€¼ä¿¡å·é‡ï¼Œè¿™ç§ä¿¡å·é‡ç§°ä¸ºäº’æ–¥ä¿¡å·é‡ï¼Œé€‚åˆä¿æŠ¤æ¯”è¾ƒé•¿çš„ä¸´ç•ŒåŒº å†…æ ¸ä½¿ç”¨çš„ä¿¡å·é‡å®šä¹‰\n// include/linux/semaphore.h struct semaphore { raw_spinlock_t lock; // è‡ªæ—‹é”ï¼Œä¿æŠ¤ä¿¡å·é‡å…¶ä»–æˆå‘˜ unsigned int count; // è®¡æ•°å€¼ï¼Œå…è®¸å¤šå°‘ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒº struct list_head wait_list; // ç­‰å¾…è¿›å…¥ä¸´ç•ŒåŒºè¿›ç¨‹é“¾è¡¨ }; // è·å–ä¿¡å·é‡ void down(struct semaphore *sem); int down_interruptible(struct semaphore *sem); int down_killable(struct semaphore *sem); int down_trylock(struct semaphore *sem); int down_timeout(struct semaphore *sem, long jiffies); // é‡Šæ”¾ä¿¡å·é‡å‡½æ•° void up(struct semaphore *sem); 5.2 è¯»å†™ä¿¡å·é‡ è¯»å†™ä¿¡å·é‡,é€‚åˆåœ¨ä»¥è¯»ä¸ºä¸»\n// include/linux/rwsem.h struct rw_semaphore { atomic_long_t count; struct list_head wait_list; raw_spinlock_t wait_lock; struct task_struct *owner; â€¦ }; åˆå§‹åŒ–ï¼Œä½¿ç”¨\n// åˆå§‹åŒ–é™æ€è¯»å†™ä¿¡å·é‡ DECLARE_RWSEM(name); // è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–è¯»å†™ä¿¡å·é‡ init_rwsem(sem); // ç”³è¯·è¯»é” void down_read(struct rw_semaphore *sem)ï¼› int down_read_trylock(struct rw_semaphore *sem)ï¼› // é‡Šæ”¾è¯»é” void up_read(struct rw_semaphore *sem); // ç”³è¯·å†™é” void down_write(struct rw_semaphore *sem); int down_write_killable(struct rw_semaphore *sem); int down_write_trylock(struct rw_semaphore *sem); // å†™é”é™çº§ä¸ºè¯»é” void downgrade_write(struct rw_semaphore *sem); // é‡Šæ”¾å†™é” void up_write(struct rw_semaphore *sem); 5.3 äº’æ–¥é” äº’æ–¥é”åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œé€‚åˆä¿æŠ¤æ¯”è¾ƒé•¿çš„ä¸´ç•ŒåŒº\n// include/linux/mutex.h struct mutex { atomic_long_t owner; spinlock_t wait_lock; #ifdef CONFIG_MUTEX_SPIN_ON_OWNER struct optimistic_spin_queue osq; #endif struct list_head wait_list; â€¦ }; ä½¿ç”¨äº’æ–¥é”\n// åˆå§‹åŒ–é™æ€äº’æ–¥é” DEFINE_MUTEX(mutexname); // è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–äº’æ–¥é” mutex_init(mutex); // ç”³è¯·äº’æ–¥é” void mutex_lock(struct mutex *lock); int mutex_lock_interruptible(struct mutex *lock); int mutex_lock_killable(struct mutex *lock); int mutex_trylock(struct mutex *lock); // é‡Šæ”¾äº’æ–¥é” void mutex_unlock(struct mutex *lock); 5.4 å®æ—¶äº’æ–¥é” å®æ—¶äº’æ–¥é”æ˜¯å¯¹äº’æ–¥é”çš„æ”¹è¿›ï¼Œå®ç°äº†ä¼˜å…ˆçº§ç»§æ‰¿(priority inheritance)ï¼Œè§£å†³äº†ä¼˜å…ˆçº§åè½¬(priority inversion)é—®é¢˜\n// include/linux/rtmutex.h struct rt_mutex { raw_spinlock_t wait_lock; struct rb_root waiters; struct rb_node *waiters_leftmost; struct task_struct *owner; â€¦ }; åˆå§‹åŒ–ï¼Œä½¿ç”¨\n// åˆå§‹åŒ–é™æ€å®æ—¶äº’æ–¥é” DEFINE_RT_MUTEX(mutexname); // è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–å®æ—¶äº’æ–¥é” rt_mutex_init(mutex); // ç”³è¯·å®æ—¶äº’æ–¥é” void rt_mutex_lock(struct rt_mutex *lock); int rt_mutex_lock_interruptible(struct rt_mutex *lock); int rt_mutex_timed_lock(struct rt_mutex *lock, struct hrtimer_sleeper *timeout); int rt_mutex_trylock(struct rt_mutex *lock); // é‡Šæ”¾å®æ—¶äº’æ–¥é” void rt_mutex_unlock(struct rt_mutex *lock); 5.5 åŸå­å˜é‡ åŸå­å˜é‡ç”¨æ¥å®ç°å¯¹æ•´æ•°çš„äº’æ–¥è®¿é—®ï¼Œé€šå¸¸ç”¨æ¥å®ç°è®¡æ•°å™¨ å†…æ ¸å®šä¹‰äº†3ç§åŸå­å˜é‡\n// æ•´æ•°åŸå­å˜é‡ï¼Œæ•°æ®ç±»å‹æ˜¯atomic_t // include/linux/types.h typedef struct { int counter; } atomic_t; // é•¿æ•´æ•°åŸå­å˜é‡ï¼Œæ•°æ®ç±»å‹æ˜¯atomic_long_t // 64ä½æ•´æ•°åŸå­å˜é‡ï¼Œæ•°æ®ç±»å‹æ˜¯atomic64_t åŸå­å˜é‡ä½¿ç”¨æ–¹æ³•\n// åˆå§‹åŒ–é™æ€åŸå­å˜é‡ atomic_t \u003cname\u003e = ATOMINC_INIT(n); // åŠ¨æ€åˆå§‹åŒ–åŸå­å˜é‡ atomic_set(v, i); // è¯»å–åŸå­å˜é‡ atomic_read(v) // åŸå­å˜é‡åŠ iï¼Œå¹¶è¿”å› atomic_add_return(i, v) // åŸå­å˜é‡våŠ i atomic_add(i, v) // åŸå­å˜é‡åŠ 1 atomic_inc(v) // åŸå­å˜é‡vå‡i atomic_sub(i, v) // åŸå­å˜é‡å‡1 atomic_dec(v) ARM64å¤„ç†å™¨çš„åŸå­å˜é‡å®ç° ARM64å¤„ç†å™¨åŸå­å˜é‡æŒ‡ä»¤æ”¯æŒ (1)ç‹¬å åŠ è½½æŒ‡ä»¤ldxr (load Exclusive Register) (2)ç‹¬å å­˜å‚¨æŒ‡ä»¤stxr (Store Exclusive Register) // ç‹¬å åŠ è½½æŒ‡ä»¤åŠ è½½32ä½æ•°æ® ldxr \u003cWt\u003e, [\u003cXn|SP\u003e{,#0}] // ç‹¬å å­˜å‚¨æŒ‡ä»¤å­˜å‚¨32ä½æ•°æ® stxr \u003cWs\u003e, \u003cWt\u003e, [\u003cXn|SP\u003e{,#0}] // åŸå­åŠ æ³•æŒ‡ä»¤staddæ“ä½œ32ä½æ•°æ® stadd \u003cWs\u003e, [\u003cXn|SP\u003e] å‡½æ•°atomic_add(i, v)å®ç°\n// arch/arm64/include/asm/atomic_ll_sc.h static inline void atomic_add(int i, atomic_t *v) { unsigned long tmp; int result; asm volatile(\"// atomic_add \\n\" \\ \" prfm pstl1strm, %2\\n\" \\ \"1: ldxr %w0, %2\\n\" \\ \" \" add \" %w0, %w0, %w3\\n\" \\ \" stxr %w1, %w0, %2\\n\" \\ \" cbnz %w1, 1b\" \\ : \"=\u0026r\" (result), \"=\u0026r\" (tmp), \"+Q\" (v-\u003ecounter) \\ : \"Ir\" (i)); } åŸå­åŠ æ³•æŒ‡ä»¤staddå®ç°çš„å‡½æ•°atomic_add(i, v)\n// arch/arm64/include/asm/atomic_lse.h static inline void atomic_add(int i, atomic_t *v) { register int w0 asm (\"w0\") = i; register atomic_t *x1 asm (\"x1\") = v; asm volatile(\" stadd %w[i], %[v]\\n\" \\ : [i] \"+r\" (w0), [v] \"+Q\" (v-\u003ecounter) \\ : \"r\" (x1) \\ : ); } 5.6 è‡ªæ—‹é” è‡ªæ—‹é”ç”¨äºå¤„ç†å™¨ä¹‹é—´çš„äº’æ–¥ï¼Œé€‚åˆä¿æŠ¤å¾ˆçŸ­çš„ä¸´ç•ŒåŒºï¼Œä¸å…è®¸åœ¨ä¸´ç•ŒåŒºç¡çœ \n// include/linux/spinlock_types.h typedef struct spinlock { union { struct raw_spinlock rlock; â€¦ }; } spinlock_t; typedef struct raw_spinlock { arch_spinlock_t raw_lock; â€¦ } raw_spinlock_t; Linuxå†…æ ¸æœ‰ä¸€ä¸ªå®æ—¶å†…æ ¸åˆ†æ”¯ï¼ˆå¼€å¯é…ç½®å®CONFIG_PREEMPT_RTï¼‰æ¥æ”¯æŒç¡¬å®æ—¶ç‰¹æ€§ï¼Œå†…æ ¸ä¸»çº¿åªæ”¯æŒè½¯å®æ—¶ æ•°æ®ç±»å‹arch_spinlock_tï¼ŒARM64æ¶æ„çš„å®šä¹‰\n// arch/arm64/include/asm/spinlock_types.h typedef struct { #ifdef __AARCH64EB__ /* å¤§ç«¯å­—èŠ‚åºï¼ˆé«˜ä½å­˜æ”¾åœ¨ä½åœ°å€ï¼‰ */ u16 next; u16 owner; #else /* å°ç«¯å­—èŠ‚åºï¼ˆä½ä½å­˜æ”¾åœ¨ä½åœ°å€ï¼‰ */ u16 owner; u16 next; #endif } __aligned(4) arch_spinlock_t; è‡ªæ—‹é”ä½¿ç”¨\n// åˆå§‹åŒ–è‡ªæ—‹é” DEFINE_SPINLOCK(x); // è¿è¡Œæ—¶åˆå§‹åŒ–è‡ªæ—‹é” spin_lock_init(x); // ç”³è¯·è‡ªæ—‹é” void spin_lock(spinlock_t *lock); void spin_lock_bh(spinlock_t *lock); void spin_lock_irq(spinlock_t *lock); spin_lock_irqsave(lock, flags); int spin_trylock(spinlock_t *lock); // é‡Šæ”¾è‡ªæ—‹é” void spin_unlock(spinlock_t *lock); void spin_unlock_bh(spinlock_t *lock); void spin_unlock_irq(spinlock_t *lock); void spin_unlock_irqrestore(spinlock_t *lock, unsigned long flags); åŸå§‹è‡ªæ—‹é”\n// åˆå§‹åŒ–åŸå§‹è‡ªæ—‹é” DEFINE_RAW_SPINLOCK(x); // è¿è¡Œæ—¶åˆå§‹åŒ–åŸå§‹è‡ªæ—‹é” raw_spin_lock_init (x); // ç”³è¯·åŸå§‹è‡ªæ—‹é” raw_spin_lock(lock) raw_spin_lock_bh(lock) raw_spin_lock_irq(lock) raw_spin_lock_irqsave(lock, flags) raw_spin_trylock(lock) // é‡Šæ”¾åŸå§‹è‡ªæ—‹é” raw_spin_unlock(lock) raw_spin_unlock_bh(lock) raw_spin_unlock_irq(lock) raw_spin_unlock_irqrestore(lock, flags) å‡½æ•°spin_lock()è´Ÿè´£ç”³è¯·è‡ªæ—‹é”\n// spin_lock() -\u003e raw_spin_lock() -\u003e _raw_spin_lock() -\u003e __raw_spin_lock() -\u003e do_raw_spin_lock() -\u003e arch_spin_lock() arch/arm64/include/asm/spinlock.h static inline void arch_spin_lock(arch_spinlock_t *lock) { unsigned int tmp; arch_spinlock_t lockval, newval; asm volatile( ARM64_LSE_ATOMIC_INSN( /* LL/SC */ \" prfm pstl1strm, %3\\n\" \"1: ldaxr %w0, %3\\n\" \" add %w1, %w0, %w5\\n\" \" stxr %w2, %w1, %3\\n\" \" cbnz %w2, 1b\\n\", /* å¤§ç³»ç»Ÿæ‰©å±•çš„åŸå­æŒ‡ä»¤ */ \" mov %w2, %w5\\n\" \" ldadda %w2, %w0, %3\\n\" __nops(3) ) /* æˆ‘ä»¬å¾—åˆ°é”äº†å—ï¼Ÿ*/ \" eor %w1, %w0, %w0, ror #16\\n\" \" cbz %w1, 3f\\n\" \" sevl\\n\" \"2: wfe\\n\" \" ldaxrh %w2, %4\\n\" \" eor %w1, %w2, %w0, lsr #16\\n\" \" cbnz %w1, 2b\\n\" /* å¾—åˆ°é”ï¼Œä¸´ç•ŒåŒºä»è¿™é‡Œå¼€å§‹*/ \"3:\" : \"=\u0026r\" (lockval), \"=\u0026r\" (newval), \"=\u0026r\" (tmp), \"+Q\" (*lock) : \"Q\" (lock-\u003eowner), \"I\" (1 \u003c\u003c TICKET_SHIFT) : \"memory\"); } 5.7 è¯»å†™è‡ªæ—‹é” è¯»å†™è‡ªæ—‹é”(é€šå¸¸ç®€ç§°è¯»å†™é”)æ˜¯è‡ªæ—‹é”çš„æ”¹è¿›ï¼ŒåŒºåˆ†è¯»è€…å’Œå†™è€…ï¼Œå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œè¯»è€…å’Œå†™è€…äº’æ–¥ï¼Œå†™è€…å’Œå†™è€…äº’æ–¥ // include/linux/rwlock_types.h typedef struct { arch_rwlock_t raw_lock; â€¦ } rwlock_t; // arch/arm64/include/asm/spinlock_types.h typedef struct { volatile unsigned int lock; } arch_rwlock_t; 5.8 é¡ºåºé” é¡ºåºé”åŒºåˆ†è¯»è€…å’Œå†™è€…\n5.8.1ã€€å®Œæ•´ç‰ˆçš„é¡ºåºé” é¡ºåºé”åŒºåˆ†è¯»è€…å’Œå†™è€…\n// include/linux/seqlock.h typedef struct { struct seqcount seqcount; // åºåˆ—å· spinlock_t lock; // è‡ªæ—‹é” } seqlock_t; 5.8.2ã€€åªæä¾›åºåˆ—å·çš„é¡ºåºé” 5.9ã€€ç¦æ­¢å†…æ ¸æŠ¢å  æ¯ä¸ªè¿›ç¨‹çš„thread_infoç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨ï¼šâ€œint preempt_countâ€ï¼Œå…¶ä¸­ç¬¬0ï½7ä½æ˜¯æŠ¢å è®¡æ•°ï¼Œç¬¬8ï½15ä½æ˜¯è½¯ä¸­æ–­è®¡æ•°ï¼Œç¬¬16ï½19ä½æ˜¯ç¡¬ä¸­æ–­è®¡æ•°ï¼Œç¬¬20ä½æ˜¯ä¸å¯å±è”½ä¸­æ–­è®¡æ•° // ç¦æ­¢å†…æ ¸æŠ¢å çš„ç¼–ç¨‹æ¥å£ preempt_disable() // å¼€å¯å†…æ ¸æŠ¢å çš„ç¼–ç¨‹æ¥å£ preempt_enable() ç”³è¯·è‡ªæ—‹é”çš„å‡½æ•°åŒ…å«äº†ç¦æ­¢å†…æ ¸æŠ¢å \nspin_lock() -\u003e raw_spin_lock() -\u003e _raw_spin_lock() -\u003e __raw_spin_lock() // include/linux/spinlock_api_smp.h static inline void __raw_spin_lock(raw_spinlock_t *lock) { preempt_disable(); â€¦ LOCK_CONTENDED(lock, do_raw_spin_trylock, do_raw_spin_lock); } é‡Šæ”¾è‡ªæ—‹é”çš„å‡½æ•°åŒ…å«äº†å¼€å¯å†…æ ¸æŠ¢å \nspin_unlock() -\u003e raw_spin_unlock() -\u003e _raw_spin_unlock() -\u003e __raw_spin_unlock() // include/linux/spinlock_api_smp.h static inline void __raw_spin_unlock(raw_spinlock_t *lock) { â€¦ do_raw_spin_unlock(lock); preempt_enable(); } 5.10ã€€è¿›ç¨‹å’Œè½¯ä¸­æ–­äº’æ–¥ æ¯ä¸ªè¿›ç¨‹çš„thread_infoç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨â€œint preempt_countâ€ï¼Œå…¶ä¸­ç¬¬8ï½15ä½æ˜¯è½¯ä¸­æ–­è®¡æ•° // ç¦æ­¢è½¯ä¸­æ–­çš„æ¥å£ local_bh_disable() // å¼€å¯è½¯ä¸­æ–­çš„æ¥å£ local_bh_enable() 5.11ã€€è¿›ç¨‹å’Œç¡¬ä¸­æ–­äº’æ–¥ è¿›ç¨‹å’Œç¡¬ä¸­æ–­å¯èƒ½è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè¿›ç¨‹å’Œç¡¬ä¸­æ–­éœ€è¦äº’æ–¥ï¼Œè¿›ç¨‹éœ€è¦ç¦æ­¢ç¡¬ä¸­æ–­ // ç¦æ­¢ç¡¬ä¸­æ–­çš„æ¥å£ local_irq_disable() local_irq_save(flags) // å¼€å¯ç¡¬ä¸­æ–­æ¥å£ local_irq_enable() local_irq_restore(flags) 5.12ã€€æ¯å¤„ç†å™¨å˜é‡ å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯å¤„ç†å™¨å˜é‡ä¸ºæ¯ä¸ªå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªå˜é‡çš„å‰¯æœ¬ æ¯å¤„ç†å™¨å˜é‡åˆ†ä¸ºé™æ€å’ŒåŠ¨æ€ä¸¤ç§ 5.12.1ã€€é™æ€æ¯å¤„ç†å™¨å˜é‡ 5.12.2ã€€åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡ 5.12.3ã€€è®¿é—®æ¯å¤„ç†å™¨å˜é‡ 5.13ã€€æ¯å¤„ç†å™¨è®¡æ•°å™¨ åŸå­å˜é‡ä½œä¸ºè®¡æ•°å™¨\n// include/linux/percpu_counter.h struct percpu_counter { raw_spinlock_t lock; s64 count; â€¦ s32 __percpu *counters; }; 5.14ã€€å†…å­˜å±éšœ å†…å­˜å±éšœï¼ˆmemory barrierï¼‰æ˜¯ä¸€ç§ä¿è¯å†…å­˜è®¿é—®é¡ºåºçš„æ–¹æ³•ï¼Œè§£å†³å†…å­˜è®¿é—®ä¹±åºé—®é¢˜ (1) (2) (3) å†…æ ¸æ”¯æŒ3ç§å†…å­˜å±éšœ (1)ç¼–è¯‘å™¨å±éšœ (2)å¤„ç†å™¨å†…å­˜å±éšœ (3)å†…å­˜æ˜ å°„I/O (Memory Mapping I/O MMIO)å†™å±éšœ 5.14.1ã€€ç¼–è¯‘å™¨å±éšœ ç¼–è¯‘å™¨å±éšœ\nbarrier(); /// GCCç¼–è¯‘å™¨å®šä¹‰çš„å®â€œbarrier() // include/linux/compiler-gcc.h #define barrier() __asm__ __volatile__(\"\": : :\"memory\") 5.14.2ã€€å¤„ç†å™¨å†…å­˜å±éšœ å¤„ç†å™¨å†…å­˜å±éšœç”¨æ¥è§£å†³å¤„ç†å™¨ä¹‹é—´çš„å†…å­˜è®¿é—®ä¹±åºé—®é¢˜å’Œå¤„ç†å™¨è®¿é—®å¤–å›´è®¾å¤‡çš„ä¹±åºé—®é¢˜ å†…å­˜å±éšœç±»å‹ å¼ºåˆ¶æ€§å†…å­˜å±éšœ SMPå†…å­˜å±éšœ é€šç”¨å†…å­˜å±éšœ mb() smp_mb() å†™å†…å­˜å±éšœ wmb() smp_wmb() è¯»å†…å­˜å±éšœ rmb() smp_rmb() æ•°æ®ä¾èµ–å±éšœ read_barrier_depends() smp_read_barrier_depends() 5.14.3 MMIOå†™å±éšœ // å†…æ ¸ä¸ºå†…å­˜æ˜ å°„I/Oå†™æ“ä½œæä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„å±éšœ mmiowb(); 5.14.4ã€€éšå«å†…å­˜å±éšœ å†…æ ¸çš„æœ‰äº›å‡½æ•°éšå«å†…å­˜å±éšœ ï¼ˆ1ï¼‰è·å–å’Œé‡Šæ”¾å‡½æ•°ã€‚ ï¼ˆ2ï¼‰ä¸­æ–­ç¦æ­¢å‡½æ•°ã€‚ 5.14.5ã€€ARM64å¤„ç†å™¨å†…å­˜å±éšœ ARM64å¤„ç†å™¨æä¾›äº†3ç§å†…å­˜å±éšœ (1)æŒ‡ä»¤åŒæ­¥å±éšœ(Instruction Synchronization Barrier ISB),æŒ‡ä»¤æ˜¯isb (2)æ•°æ®å†…å­˜å±éšœ(Data Memory Barrier DMB)ï¼ŒæŒ‡ä»¤æ˜¯dmb (3)æ•°æ®åŒæ­¥å±éšœ(Data Synchronization Barrier DSb)ï¼ŒæŒ‡ä»¤æ˜¯dsb 5.15ã€€RCU RCU(Read-Copy Update)è¯»-å¤åˆ¶æ›´æ–° 5.15.2ã€€æŠ€æœ¯åŸç† 5.16ã€€å¯ç¡çœ RCU 5.17ã€€æ­»é”æ£€æµ‹å·¥å…·lockdep æ­»é”æœ‰ä»¥ä¸‹4ç§æƒ…å†µ 1ï¼‰è¿›ç¨‹é‡å¤ç”³è¯·åŒä¸€ä¸ªé”ï¼Œç§°ä¸ºAAæ­»é” 2ï¼‰è¿›ç¨‹ç”³è¯·è‡ªæ—‹é”æ—¶æ²¡æœ‰ç¦æ­¢ç¡¬ä¸­æ–­ï¼Œè¿›ç¨‹è·å–è‡ªæ—‹é”ä»¥åï¼Œç¡¬ä¸­æ–­æŠ¢å ï¼Œç”³è¯·åŒä¸€ä¸ªè‡ªæ—‹é” 3ï¼‰ä¸¤ä¸ªè¿›ç¨‹éƒ½è¦è·å–é”L1å’ŒL2ï¼Œè¿›ç¨‹1æŒæœ‰é”L1ï¼Œå†å»è·å–é”L2ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™è¿›ç¨‹2æŒæœ‰é”L2å¹¶ä¸”æ­£åœ¨å°è¯•è·å–é”L1ï¼Œé‚£ä¹ˆè¿›ç¨‹1å’Œè¿›ç¨‹2å°±ä¼šæ­»é”ï¼Œç§°ä¸ºAB-BAæ­»é” 4ï¼‰åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿›ç¨‹1æŒæœ‰é”L1ï¼Œå†å»è·å–é”L2ï¼Œåœ¨å¦ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿›ç¨‹2æŒæœ‰é”L2ï¼Œç¡¬ä¸­æ–­æŠ¢å è¿›ç¨‹2ä»¥åè·å–é”L1 5.17.1ã€€ä½¿ç”¨æ–¹æ³• æ­»é”æ£€æµ‹å·¥å…·lockdepçš„é…ç½®å®\n5.17.2ã€€æŠ€æœ¯åŸç† ç¬¬6ç«  æ–‡ä»¶ç³»ç»Ÿ 6.1ã€€æ¦‚è¿° Linuxç³»ç»Ÿä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ Linuxæ–‡ä»¶ç³»ç»Ÿçš„æ¶æ„ 6.1.1ã€€ç”¨æˆ·ç©ºé—´å±‚é¢ åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨å†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶\n// æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ mount // å¸è½½ç›®å½•ä¸‹æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿ umount // æ‰“å¼€æ–‡ä»¶ open // å…³é—­æ–‡ä»¶ close // å†™æ–‡ä»¶ write // è®¾ç½®æ–‡ä»¶åç§» lseek // æ–‡ä»¶ä¿®æ”¹è¿‡çš„å±æ€§å’Œæ•°æ®ç«‹å³å†™åˆ°å­˜å‚¨è®¾å¤‡ fsync glibcåº“å°è£…çš„æ ‡å‡†I/Oæµå‡½æ•°è®¿é—®æ–‡ä»¶\n// æ‰“å¼€æµ fopen // å…³é—­æµ fclose // è¯»æµ fread // å†™æµ fwrite // è®¾ç½®æ–‡ä»¶åç§» fseek // å†²åˆ·æµ fflush 6.1.2ã€€ç¡¬ä»¶å±‚é¢ å¤–éƒ¨å­˜å‚¨è®¾å¤‡åˆ†ä¸ºå—è®¾å¤‡ã€é—ªå­˜å’ŒNVDIMMè®¾å¤‡3ç±» é—ªå­˜æŒ‰å­˜å‚¨ç»“æ„åˆ†ä¸ºNANDé—ªå­˜å’ŒNORé—ªå­˜ 6.1.3ã€€å†…æ ¸ç©ºé—´å±‚é¢ ä½¿ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå®ç°èƒ½å¤Ÿå…±å­˜ï¼Œå†…æ ¸å®ç°äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œç§°ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVirtual File Systemï¼ŒVFSï¼‰ï¼Œä¹Ÿç§°ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢ï¼ˆVirtual Filesystem Switchï¼ŒVFSï¼‰ æ–‡ä»¶ç³»ç»Ÿåˆ†ä¸ºä»¥ä¸‹4ç§ ",
  "wordCount" : "65650",
  "inLanguage": "en",
  "datePublished": "2022-10-05T00:17:58+08:00",
  "dateModified": "2022-10-05T00:17:58+08:00",
  "author":[{
    "@type": "Person",
    "name": "Zain"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://liuz0123.gitee.io/zain/posts/tech/linux%E5%86%85%E6%A0%B8%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "zain's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://liuz0123.gitee.io/zain/img/Q.gif"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>



<script async src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://liuz0123.gitee.io/zain/" accesskey="h" title="Zain&#39;s Blog (Alt + H)">
            <img src="https://liuz0123.gitee.io/zain/img/Q.gif" alt="logo" aria-label="logo"
                 height="35">Zain&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://liuz0123.gitee.io/zain/search" title="ğŸ” æœç´¢ (Alt &#43; /)" accesskey=/>
                <span>ğŸ” æœç´¢</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/" title="ğŸ  ä¸»é¡µ">
                <span>ğŸ  ä¸»é¡µ</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/posts" title="ğŸ“š æ–‡ç« ">
                <span>ğŸ“š æ–‡ç« </span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/tags" title="ğŸ§© æ ‡ç­¾">
                <span>ğŸ§© æ ‡ç­¾</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/archives/" title="â± æ—¶é—´è½´">
                <span>â± æ—¶é—´è½´</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/about" title="ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº">
                <span>ğŸ™‹ğŸ»â€â™‚ï¸ å…³äº</span>
                </a>
            </li>
            <li>
                <a href="https://liuz0123.gitee.io/zain/links" title="ğŸ¤ é—²è¨€ä¿—è¯­">
                <span>ğŸ¤ é—²è¨€ä¿—è¯­</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://liuz0123.gitee.io/zain/">ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/">ğŸ“šæ–‡ç« </a>&nbsp;Â»&nbsp;<a href="https://liuz0123.gitee.io/zain/posts/tech/">ğŸ‘¨ğŸ»â€ğŸ’» æŠ€æœ¯</a></div>
            <h1 class="post-title">
                Linuxå†…æ ¸æ·±åº¦è§£æ
            </h1>
            <div class="post-meta">Create:&nbsp;<span title='2022-10-05 00:17:58 +0800 CST'>2022-10-05</span>&nbsp;|&nbsp;Update:&nbsp;2022-10-05&nbsp;|&nbsp;Words:&nbsp;65650&nbsp;|&nbsp;&nbsp;132 min&nbsp;|&nbsp;
&nbsp;Zain



                &nbsp;|&nbsp;tags: &nbsp;
                <ul class="post-tags-meta">
                    <a href="https://liuz0123.gitee.io/zain/tags/tech/">tech</a>
                    <a href="https://liuz0123.gitee.io/zain/tags/linux/">ã€linux</a>
                </ul>

                
                <span id="busuanzi_container_page_pv">
                &nbsp;| Viewers: <span id="busuanzi_value_page_pv"></span>
            </span>

</div>
        </header> 
        <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">æ–‡ç« ç›®å½•</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%86%85%e5%ae%b9%e6%8f%90%e7%ba%b2" aria-label="å†…å®¹æçº²">å†…å®¹æçº²</a></li>
                <li>
                    <a href="#%e7%ac%ac1%e7%ab%a0-%e5%86%85%e6%a0%b8%e5%bc%95%e5%af%bc%e5%92%8c%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#11-%e5%bc%95%e5%af%bc%e7%a8%8b%e5%ba%8f" aria-label="1.1 å¼•å¯¼ç¨‹åº">1.1 å¼•å¯¼ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#111-%e5%85%a5%e5%8f%a3_start" aria-label="1.1.1 å…¥å£_start">1.1.1 å…¥å£_start</a></li>
                <li>
                    <a href="#112-reset" aria-label="1.1.2 reset">1.1.2 <code>reset</code></a></li>
                <li>
                    <a href="#113-%e5%87%bd%e6%95%b0_main" aria-label="1.1.3 å‡½æ•°_main">1.1.3 å‡½æ•°_main</a></li>
                <li>
                    <a href="#114-%e5%87%bd%e6%95%b0run_main_loop" aria-label="1.1.4 å‡½æ•°run_main_loop">1.1.4 å‡½æ•°run_main_loop</a></li></ul>
                </li>
                <li>
                    <a href="#12-%e5%86%85%e6%a0%b8%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="1.2 å†…æ ¸åˆå§‹åŒ–">1.2 å†…æ ¸åˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#121-%e6%b1%87%e7%bc%96%e8%af%ad%e8%a8%80%e9%83%a8%e5%88%86" aria-label="1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†</a></li>
                <li>
                    <a href="#122-c%e8%af%ad%e8%a8%80%e9%83%a8%e5%88%86" aria-label="1.2.2 Cè¯­è¨€éƒ¨åˆ†">1.2.2 Cè¯­è¨€éƒ¨åˆ†</a></li>
                <li>
                    <a href="#123-smp%e7%b3%bb%e7%bb%9f%e7%9a%84%e5%bc%95%e5%af%bc" aria-label="1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼">1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼</a></li></ul>
                </li>
                <li>
                    <a href="#13-init%e8%bf%9b%e7%a8%8b" aria-label="1.3 initè¿›ç¨‹">1.3 initè¿›ç¨‹</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac2%e7%ab%a0-%e8%bf%9b%e7%a8%8b%e7%ae%a1%e7%90%86" aria-label="ç¬¬2ç«  è¿›ç¨‹ç®¡ç†">ç¬¬2ç«  è¿›ç¨‹ç®¡ç†</a><ul>
                        
                <li>
                    <a href="#21-%e8%bf%9b%e7%a8%8b" aria-label="2.1 è¿›ç¨‹">2.1 è¿›ç¨‹</a></li>
                <li>
                    <a href="#22-%e5%91%bd%e5%90%8d%e7%a9%ba%e9%97%b4" aria-label="2.2 å‘½åç©ºé—´">2.2 å‘½åç©ºé—´</a></li>
                <li>
                    <a href="#23-%e8%bf%9b%e7%a8%8b%e6%a0%87%e8%af%86%e7%ac%a6" aria-label="2.3 è¿›ç¨‹æ ‡è¯†ç¬¦">2.3 è¿›ç¨‹æ ‡è¯†ç¬¦</a></li>
                <li>
                    <a href="#24-%e8%bf%9b%e7%a8%8b%e5%85%b3%e7%b3%bb" aria-label="2.4 è¿›ç¨‹å…³ç³»">2.4 è¿›ç¨‹å…³ç³»</a></li>
                <li>
                    <a href="#25-%e5%90%af%e5%8a%a8%e7%a8%8b%e5%ba%8f" aria-label="2.5 å¯åŠ¨ç¨‹åº">2.5 å¯åŠ¨ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#251%e5%88%9b%e5%bb%ba%e6%96%b0%e8%bf%9b%e7%a8%8b" aria-label="2.5.1ã€€åˆ›å»ºæ–°è¿›ç¨‹">2.5.1ã€€åˆ›å»ºæ–°è¿›ç¨‹</a><ul>
                        
                <li>
                    <a href="#1-_do_fork%e5%87%bd%e6%95%b0" aria-label="1. _do_forkå‡½æ•°">1. _do_forkå‡½æ•°</a></li>
                <li>
                    <a href="#2-copy_process%e5%87%bd%e6%95%b0" aria-label="2. copy_processå‡½æ•°">2. copy_processå‡½æ•°</a></li>
                <li>
                    <a href="#3%e5%94%a4%e9%86%92%e6%96%b0%e8%bf%9b%e7%a8%8b" aria-label="3.å”¤é†’æ–°è¿›ç¨‹">3.å”¤é†’æ–°è¿›ç¨‹</a></li>
                <li>
                    <a href="#4%e6%96%b0%e8%bf%9b%e7%a8%8b%e7%ac%ac%e4%b8%80%e6%ac%a1%e8%bf%90%e8%a1%8c" aria-label="4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ">4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ</a></li></ul>
                </li>
                <li>
                    <a href="#252-%e8%a3%85%e8%bd%bd%e7%a8%8b%e5%ba%8f" aria-label="2.5.2 è£…è½½ç¨‹åº">2.5.2 è£…è½½ç¨‹åº</a><ul>
                        
                <li>
                    <a href="#1%e4%ba%8c%e8%bf%9b%e5%88%b6%e6%a0%bc%e5%bc%8f" aria-label="1.äºŒè¿›åˆ¶æ ¼å¼">1.äºŒè¿›åˆ¶æ ¼å¼</a></li>
                <li>
                    <a href="#2%e8%a3%85%e8%bd%bdelf%e7%a8%8b%e5%ba%8f" aria-label="2.è£…è½½ELFç¨‹åº">2.è£…è½½ELFç¨‹åº</a></li>
                <li>
                    <a href="#3%e8%a3%85%e8%bd%bd%e8%84%9a%e6%9c%ac%e7%a8%8b%e5%ba%8f" aria-label="3.è£…è½½è„šæœ¬ç¨‹åº">3.è£…è½½è„šæœ¬ç¨‹åº</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#26-%e8%bf%9b%e7%a8%8b%e9%80%80%e5%87%ba" aria-label="2.6 è¿›ç¨‹é€€å‡º">2.6 è¿›ç¨‹é€€å‡º</a><ul>
                        
                <li>
                    <a href="#261-%e7%ba%bf%e7%a8%8b%e7%bb%84%e9%80%80%e5%87%ba-exit_group" aria-label="2.6.1 çº¿ç¨‹ç»„é€€å‡º exit_group">2.6.1 çº¿ç¨‹ç»„é€€å‡º exit_group</a></li>
                <li>
                    <a href="#262-%e7%bb%88%e6%ad%a2%e8%bf%9b%e7%a8%8b" aria-label="2.6.2 ç»ˆæ­¢è¿›ç¨‹">2.6.2 ç»ˆæ­¢è¿›ç¨‹</a></li>
                <li>
                    <a href="#263-%e6%9f%a5%e8%af%a2%e5%ad%90%e8%bf%9b%e7%a8%8b%e7%bb%88%e6%ad%a2%e5%8e%9f%e5%9b%a0" aria-label="2.6.3 æŸ¥è¯¢å­è¿›ç¨‹ç»ˆæ­¢åŸå› ">2.6.3 æŸ¥è¯¢å­è¿›ç¨‹ç»ˆæ­¢åŸå› </a></li></ul>
                </li>
                <li>
                    <a href="#27-%e8%bf%9b%e7%a8%8b%e7%8a%b6%e6%80%81" aria-label="2.7 è¿›ç¨‹çŠ¶æ€">2.7 è¿›ç¨‹çŠ¶æ€</a></li>
                <li>
                    <a href="#28-%e8%bf%9b%e7%a8%8b%e8%b0%83%e5%ba%a6" aria-label="2.8 è¿›ç¨‹è°ƒåº¦">2.8 è¿›ç¨‹è°ƒåº¦</a><ul>
                        
                <li>
                    <a href="#281-%e8%b0%83%e5%ba%a6%e7%ad%96%e7%95%a5" aria-label="2.8.1 è°ƒåº¦ç­–ç•¥">2.8.1 è°ƒåº¦ç­–ç•¥</a></li>
                <li>
                    <a href="#282-%e8%bf%9b%e7%a8%8b%e4%bc%98%e5%85%88%e7%ba%a7" aria-label="2.8.2 è¿›ç¨‹ä¼˜å…ˆçº§">2.8.2 è¿›ç¨‹ä¼˜å…ˆçº§</a></li>
                <li>
                    <a href="#283-%e8%b0%83%e5%ba%a6%e7%b1%bb" aria-label="2.8.3 è°ƒåº¦ç±»">2.8.3 è°ƒåº¦ç±»</a></li>
                <li>
                    <a href="#284-%e8%bf%90%e8%a1%8c%e9%98%9f%e5%88%97" aria-label="2.8.4 è¿è¡Œé˜Ÿåˆ—">2.8.4 è¿è¡Œé˜Ÿåˆ—</a></li>
                <li>
                    <a href="#285-%e4%bb%bb%e5%8a%a1%e5%88%86%e7%bb%84" aria-label="2.8.5 ä»»åŠ¡åˆ†ç»„">2.8.5 ä»»åŠ¡åˆ†ç»„</a><ul>
                        
                <li>
                    <a href="#1%e4%bb%bb%e5%8a%a1%e5%88%86%e7%bb%84%e6%96%b9%e5%bc%8f" aria-label="1.ä»»åŠ¡åˆ†ç»„æ–¹å¼">1.ä»»åŠ¡åˆ†ç»„æ–¹å¼</a></li>
                <li>
                    <a href="#2-%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="2. æ•°æ®ç»“æ„">2. æ•°æ®ç»“æ„</a></li></ul>
                </li>
                <li>
                    <a href="#286-%e8%b0%83%e5%ba%a6%e8%bf%9b%e7%a8%8b" aria-label="2.8.6 è°ƒåº¦è¿›ç¨‹">2.8.6 è°ƒåº¦è¿›ç¨‹</a><ul>
                        
                <li>
                    <a href="#1%e9%80%89%e6%8b%a9%e4%b8%8b%e4%b8%80%e4%b8%aa%e8%bf%9b%e7%a8%8b-%e5%87%bd%e6%95%b0pick_next_task" aria-label="1.é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ å‡½æ•°pick_next_task">1.é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ å‡½æ•°pick_next_task</a></li>
                <li>
                    <a href="#2%e5%88%87%e6%8d%a2%e8%bf%9b%e7%a8%8b-context_switch" aria-label="2.åˆ‡æ¢è¿›ç¨‹ context_switch">2.åˆ‡æ¢è¿›ç¨‹ context_switch</a></li></ul>
                </li>
                <li>
                    <a href="#287-%e8%b0%83%e5%ba%a6%e6%97%b6%e6%9c%ba" aria-label="2.8.7 è°ƒåº¦æ—¶æœº">2.8.7 è°ƒåº¦æ—¶æœº</a><ul>
                        
                <li>
                    <a href="#1%e4%b8%bb%e5%8a%a8%e8%b0%83%e5%ba%a6" aria-label="1.ä¸»åŠ¨è°ƒåº¦">1.ä¸»åŠ¨è°ƒåº¦</a></li>
                <li>
                    <a href="#2%e5%91%a8%e6%9c%9f%e8%b0%83%e5%ba%a6" aria-label="2.å‘¨æœŸè°ƒåº¦">2.å‘¨æœŸè°ƒåº¦</a></li>
                <li>
                    <a href="#3%e5%94%a4%e9%86%92%e8%bf%9b%e7%a8%8b%e6%97%b6%e6%8a%a2%e5%8d%a0" aria-label="3.å”¤é†’è¿›ç¨‹æ—¶æŠ¢å ">3.å”¤é†’è¿›ç¨‹æ—¶æŠ¢å </a></li>
                <li>
                    <a href="#4%e5%88%9b%e5%bb%ba%e6%96%b0%e8%bf%9b%e7%a8%8b%e6%97%b6%e6%8a%a2%e5%8d%a0" aria-label="4.åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŠ¢å ">4.åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŠ¢å </a></li>
                <li>
                    <a href="#5%e5%86%85%e6%a0%b8%e6%8a%a2%e5%8d%a0" aria-label="5.å†…æ ¸æŠ¢å ">5.å†…æ ¸æŠ¢å </a></li>
                <li>
                    <a href="#6%e9%ab%98%e7%b2%be%e5%ba%a6%e8%b0%83%e5%ba%a6%e6%97%b6%e9%92%9f" aria-label="6.é«˜ç²¾åº¦è°ƒåº¦æ—¶é’Ÿ">6.é«˜ç²¾åº¦è°ƒåº¦æ—¶é’Ÿ</a></li></ul>
                </li>
                <li>
                    <a href="#288-%e5%b8%a6%e5%ae%bd%e7%ae%a1%e7%90%86" aria-label="2.8.8 å¸¦å®½ç®¡ç†">2.8.8 å¸¦å®½ç®¡ç†</a><ul>
                        
                <li>
                    <a href="#1%e9%99%90%e6%9c%9f%e8%b0%83%e5%ba%a6%e7%b1%bb%e7%9a%84%e5%b8%a6%e6%a1%86%e7%ae%a1%e7%90%86" aria-label="1.é™æœŸè°ƒåº¦ç±»çš„å¸¦æ¡†ç®¡ç†">1.é™æœŸè°ƒåº¦ç±»çš„å¸¦æ¡†ç®¡ç†</a></li>
                <li>
                    <a href="#2%e5%ae%9e%e6%97%b6%e8%b0%83%e5%ba%a6%e7%b1%bb%e7%9a%84%e5%b8%a6%e5%ae%bd%e7%ae%a1%e7%90%86" aria-label="2.å®æ—¶è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†">2.å®æ—¶è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†</a></li>
                <li>
                    <a href="#3%e5%85%ac%e5%b9%b3%e8%b0%83%e5%ba%a6%e7%b1%bb%e7%9a%84%e5%b8%a6%e5%ae%bd%e7%ae%a1%e7%90%86" aria-label="3.å…¬å¹³è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†">3.å…¬å¹³è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#29-smp%e8%b0%83%e5%ba%a6" aria-label="2.9 SMPè°ƒåº¦">2.9 SMPè°ƒåº¦</a><ul>
                        
                <li>
                    <a href="#291-%e8%bf%9b%e7%a8%8b%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8%e4%ba%b2%e5%92%8c%e6%80%a7" aria-label="2.9.1 è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§">2.9.1 è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§</a><ul>
                        
                <li>
                    <a href="#1%e5%ba%94%e7%94%a8%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="1.åº”ç”¨ç¼–ç¨‹æ¥å£">1.åº”ç”¨ç¼–ç¨‹æ¥å£</a></li>
                <li>
                    <a href="#2%e4%bd%bf%e7%94%a8cpuset%e9%85%8d%e7%bd%ae" aria-label="2.ä½¿ç”¨cpuseté…ç½®">2.ä½¿ç”¨cpuseté…ç½®</a></li></ul>
                </li>
                <li>
                    <a href="#292-%e5%af%b9%e8%b0%83%e5%ba%a6%e5%99%a8%e7%9a%84%e6%89%a9%e5%b1%95" aria-label="2.9.2 å¯¹è°ƒåº¦å™¨çš„æ‰©å±•">2.9.2 å¯¹è°ƒåº¦å™¨çš„æ‰©å±•</a></li>
                <li>
                    <a href="#293-%e9%99%90%e6%9c%9f%e8%b0%83%e5%ba%a6%e7%b1%bb%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="2.9.3 é™æœŸè°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">2.9.3 é™æœŸè°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡</a></li>
                <li>
                    <a href="#294-%e5%ae%9e%e6%97%b6%e8%b0%83%e5%ba%a6%e7%b1%bb%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="2.9.4 å®æ—¶è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">2.9.4 å®æ—¶è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡</a></li>
                <li>
                    <a href="#295-%e5%85%ac%e5%b9%b3%e8%b0%83%e5%ba%a6%e7%b1%bb%e7%9a%84%e5%a4%84%e7%90%86%e5%99%a8%e8%b4%9f%e8%bd%bd%e5%9d%87%e8%a1%a1" aria-label="2.9.5 å…¬å¹³è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">2.9.5 å…¬å¹³è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡</a></li>
                <li>
                    <a href="#296-%e8%bf%81%e7%a7%bb%e7%ba%bf%e7%a8%8b" aria-label="2.9.6 è¿ç§»çº¿ç¨‹">2.9.6 è¿ç§»çº¿ç¨‹</a></li>
                <li>
                    <a href="#297-%e9%9a%94%e7%a6%bb%e5%a4%84%e7%90%86%e5%99%a8" aria-label="2.9.7 éš”ç¦»å¤„ç†å™¨">2.9.7 éš”ç¦»å¤„ç†å™¨</a></li></ul>
                </li>
                <li>
                    <a href="#210-%e8%bf%9b%e7%a8%8b%e7%9a%84%e4%b8%8a%e4%b8%8b%e6%96%87%e5%ae%89%e5%85%a8" aria-label="2.10 è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®‰å…¨">2.10 è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®‰å…¨</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac3%e7%ab%a0-%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86" aria-label="ç¬¬3ç«  å†…å­˜ç®¡ç†">ç¬¬3ç«  å†…å­˜ç®¡ç†</a><ul>
                        
                <li>
                    <a href="#31-%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86%e5%ad%90%e7%b3%bb%e7%bb%9f%e6%9e%b6%e6%9e%84" aria-label="3.1 å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¶æ„">3.1 å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¶æ„</a><ul>
                        <ul>
                        
                <li>
                    <a href="#1%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4" aria-label="1.ç”¨æˆ·ç©ºé—´">1.ç”¨æˆ·ç©ºé—´</a></li>
                <li>
                    <a href="#2%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4" aria-label="2.å†…æ ¸ç©ºé—´">2.å†…æ ¸ç©ºé—´</a></li>
                <li>
                    <a href="#3%e7%a1%ac%e4%bb%b6%e5%b1%82%e9%9d%a2" aria-label="3.ç¡¬ä»¶å±‚é¢">3.ç¡¬ä»¶å±‚é¢</a></li></ul>
                    </ul>
                </li>
                <li>
                    <a href="#32-%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e5%b8%83%e5%b1%80" aria-label="3.2 è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€">3.2 è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€</a><ul>
                        
                <li>
                    <a href="#321-%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e5%88%92%e5%88%86" aria-label="3.2.1 è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†">3.2.1 è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†</a></li>
                <li>
                    <a href="#322-%e7%94%a8%e6%88%b7%e8%99%9a%e6%8b%9f%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e5%b8%83%e5%b1%80" aria-label="3.2.2 ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€">3.2.2 ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€</a></li>
                <li>
                    <a href="#323-%e5%86%85%e6%a0%b8%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e5%b8%83%e5%b1%80" aria-label="3.2.3 å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€">3.2.3 å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€</a></li></ul>
                </li>
                <li>
                    <a href="#33-%e7%89%a9%e7%90%86%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4" aria-label="3.3 ç‰©ç†åœ°å€ç©ºé—´">3.3 ç‰©ç†åœ°å€ç©ºé—´</a></li>
                <li>
                    <a href="#34%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84" aria-label="3.4ã€€å†…å­˜æ˜ å°„">3.4ã€€å†…å­˜æ˜ å°„</a><ul>
                        <ul>
                        
                <li>
                    <a href="#341-%e5%ba%94%e7%94%a8%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="3.4.1 åº”ç”¨ç¼–ç¨‹æ¥å£">3.4.1 åº”ç”¨ç¼–ç¨‹æ¥å£</a></li></ul>
                    
                <li>
                    <a href="#342-%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="3.4.2 æ•°æ®ç»“æ„">3.4.2 æ•°æ®ç»“æ„</a><ul>
                        
                <li>
                    <a href="#1-%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98%e5%8c%ba%e5%9f%9f" aria-label="1. è™šæ‹Ÿå†…å­˜åŒºåŸŸ">1. è™šæ‹Ÿå†…å­˜åŒºåŸŸ</a></li>
                <li>
                    <a href="#2%e9%93%be%e8%a1%a8%e5%92%8c%e6%a0%91" aria-label="2.é“¾è¡¨å’Œæ ‘">2.é“¾è¡¨å’Œæ ‘</a></li></ul>
                </li>
                <li>
                    <a href="#343-%e5%88%9b%e5%bb%ba%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84" aria-label="3.4.3 åˆ›å»ºå†…å­˜æ˜ å°„">3.4.3 åˆ›å»ºå†…å­˜æ˜ å°„</a></li>
                <li>
                    <a href="#344-%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98%e8%bf%87%e9%87%8f%e6%8f%90%e4%ba%a4%e7%ad%96%e7%95%a5" aria-label="3.4.4 è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥">3.4.4 è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥</a></li>
                <li>
                    <a href="#345-%e5%88%a0%e9%99%a4%e5%86%85%e5%ad%98%e6%98%a0%e5%b0%84" aria-label="3.4.5 åˆ é™¤å†…å­˜æ˜ å°„">3.4.5 åˆ é™¤å†…å­˜æ˜ å°„</a></li></ul>
                </li>
                <li>
                    <a href="#35-%e7%89%a9%e7%90%86%e5%86%85%e5%ad%98%e7%bb%84%e7%bb%87" aria-label="3.5 ç‰©ç†å†…å­˜ç»„ç»‡">3.5 ç‰©ç†å†…å­˜ç»„ç»‡</a><ul>
                        
                <li>
                    <a href="#351-%e4%bd%93%e7%b3%bb%e7%bb%93%e6%9e%84" aria-label="3.5.1 ä½“ç³»ç»“æ„">3.5.1 ä½“ç³»ç»“æ„</a></li>
                <li>
                    <a href="#352-%e5%86%85%e5%ad%98%e6%a8%a1%e5%9e%8b" aria-label="3.5.2 å†…å­˜æ¨¡å‹">3.5.2 å†…å­˜æ¨¡å‹</a></li>
                <li>
                    <a href="#353-%e4%b8%89%e7%ba%a7%e7%bb%93%e6%9e%84" aria-label="3.5.3 ä¸‰çº§ç»“æ„">3.5.3 ä¸‰çº§ç»“æ„</a><ul>
                        
                <li>
                    <a href="#1%e5%86%85%e5%ad%98%e8%8a%82%e7%82%b9" aria-label="1.å†…å­˜èŠ‚ç‚¹">1.å†…å­˜èŠ‚ç‚¹</a></li>
                <li>
                    <a href="#2%e5%86%85%e5%ad%98%e5%8c%ba%e5%9f%9f" aria-label="2.å†…å­˜åŒºåŸŸ">2.å†…å­˜åŒºåŸŸ</a></li>
                <li>
                    <a href="#3%e7%89%a9%e7%90%86%e9%a1%b5" aria-label="3.ç‰©ç†é¡µ">3.ç‰©ç†é¡µ</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#36-%e5%bc%95%e5%af%bc%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.6 å¼•å¯¼å†…å­˜åˆ†é…å™¨">3.6 å¼•å¯¼å†…å­˜åˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#361-bootmem%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.6.1 bootmemåˆ†é…å™¨">3.6.1 bootmemåˆ†é…å™¨</a></li>
                <li>
                    <a href="#362-memblock%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.6.2 memblockåˆ†é…å™¨">3.6.2 memblockåˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#1%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="1.æ•°æ®ç»“æ„">1.æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#2%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="2.åˆå§‹åŒ–">2.åˆå§‹åŒ–</a></li>
                <li>
                    <a href="#3%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="3.ç¼–ç¨‹æ¥å£">3.ç¼–ç¨‹æ¥å£</a></li>
                <li>
                    <a href="#4%e7%ae%97%e6%b3%95" aria-label="4.ç®—æ³•">4.ç®—æ³•</a></li></ul>
                </li>
                <li>
                    <a href="#363-%e7%89%a9%e7%90%86%e5%86%85%e5%ad%98%e4%bf%a1%e6%81%af" aria-label="3.6.3 ç‰©ç†å†…å­˜ä¿¡æ¯">3.6.3 ç‰©ç†å†…å­˜ä¿¡æ¯</a></li></ul>
                </li>
                <li>
                    <a href="#37-%e4%bc%99%e4%bc%b4%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.7 ä¼™ä¼´åˆ†é…å™¨">3.7 ä¼™ä¼´åˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#371-%e5%9f%ba%e6%9c%ac%e7%9a%84%e4%bc%99%e4%bc%b4%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.7.1 åŸºæœ¬çš„ä¼™ä¼´åˆ†é…å™¨">3.7.1 åŸºæœ¬çš„ä¼™ä¼´åˆ†é…å™¨</a></li>
                <li>
                    <a href="#372-%e5%88%86%e5%8c%ba%e7%9a%84%e4%bc%99%e4%bc%b4%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.7.2 åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨">3.7.2 åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#1%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84-1" aria-label="1.æ•°æ®ç»“æ„">1.æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#2%e6%a0%b9%e6%8d%ae%e5%88%86%e9%85%8d%e6%a0%87%e5%bf%97%e5%be%97%e5%88%b0%e9%a6%96%e9%80%89%e5%8c%ba%e5%9f%9f%e7%b1%bb%e5%9e%8b" aria-label="2ï¼æ ¹æ®åˆ†é…æ ‡å¿—å¾—åˆ°é¦–é€‰åŒºåŸŸç±»å‹">2ï¼æ ¹æ®åˆ†é…æ ‡å¿—å¾—åˆ°é¦–é€‰åŒºåŸŸç±»å‹</a></li>
                <li>
                    <a href="#3-%e5%a4%87%e7%94%a8%e5%8c%ba%e5%9f%9f%e5%88%97%e8%a1%a8" aria-label="3. å¤‡ç”¨åŒºåŸŸåˆ—è¡¨">3. å¤‡ç”¨åŒºåŸŸåˆ—è¡¨</a></li>
                <li>
                    <a href="#4%e5%8c%ba%e5%9f%9f%e6%b0%b4%e7%ba%bf" aria-label="4ï¼åŒºåŸŸæ°´çº¿">4ï¼åŒºåŸŸæ°´çº¿</a></li>
                <li>
                    <a href="#5%e9%98%b2%e6%ad%a2%e8%bf%87%e5%ba%a6%e5%80%9f%e7%94%a8" aria-label="5ï¼é˜²æ­¢è¿‡åº¦å€Ÿç”¨">5ï¼é˜²æ­¢è¿‡åº¦å€Ÿç”¨</a></li></ul>
                </li>
                <li>
                    <a href="#373%e6%a0%b9%e6%8d%ae%e5%8f%af%e7%a7%bb%e5%8a%a8%e6%80%a7%e5%88%86%e7%bb%84" aria-label="3.7.3ã€€æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„">3.7.3ã€€æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„</a></li>
                <li>
                    <a href="#374%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e9%a1%b5%e9%9b%86%e5%90%88" aria-label="3.7.4ã€€æ¯å¤„ç†å™¨é¡µé›†åˆ">3.7.4ã€€æ¯å¤„ç†å™¨é¡µé›†åˆ</a></li>
                <li>
                    <a href="#375%e5%88%86%e9%85%8d%e9%a1%b5" aria-label="3.7.5ã€€åˆ†é…é¡µ">3.7.5ã€€åˆ†é…é¡µ</a><ul>
                        
                <li>
                    <a href="#1%e5%88%86%e9%85%8d%e6%8e%a5%e5%8f%a3" aria-label="1ï¼åˆ†é…æ¥å£">1ï¼åˆ†é…æ¥å£</a></li>
                <li>
                    <a href="#2%e5%88%86%e9%85%8d%e6%a0%87%e5%bf%97%e4%bd%8d" aria-label="2ï¼åˆ†é…æ ‡å¿—ä½">2ï¼åˆ†é…æ ‡å¿—ä½</a></li>
                <li>
                    <a href="#3%e5%a4%8d%e5%90%88%e9%a1%b5" aria-label="3ï¼å¤åˆé¡µ">3ï¼å¤åˆé¡µ</a></li>
                <li>
                    <a href="#4%e5%af%b9%e9%ab%98%e9%98%b6%e5%8e%9f%e5%ad%90%e5%88%86%e9%85%8d%e7%9a%84%e4%bc%98%e5%8c%96%e5%a4%84%e7%90%86" aria-label="4ï¼å¯¹é«˜é˜¶åŸå­åˆ†é…çš„ä¼˜åŒ–å¤„ç†">4ï¼å¯¹é«˜é˜¶åŸå­åˆ†é…çš„ä¼˜åŒ–å¤„ç†</a></li>
                <li>
                    <a href="#5%e6%a0%b8%e5%bf%83%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%9e%e7%8e%b0" aria-label="5ï¼æ ¸å¿ƒå‡½æ•°çš„å®ç°">5ï¼æ ¸å¿ƒå‡½æ•°çš„å®ç°</a></li></ul>
                </li>
                <li>
                    <a href="#376%e9%87%8a%e6%94%be%e9%a1%b5" aria-label="3.7.6ã€€é‡Šæ”¾é¡µ">3.7.6ã€€é‡Šæ”¾é¡µ</a></li></ul>
                </li>
                <li>
                    <a href="#38%e5%9d%97%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.8ã€€å—åˆ†é…å™¨">3.8ã€€å—åˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#381-%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="3.8.1 ç¼–ç¨‹æ¥å£">3.8.1 ç¼–ç¨‹æ¥å£</a></li>
                <li>
                    <a href="#382-slab%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.8.2 SLABåˆ†é…å™¨">3.8.2 SLABåˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#1%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84-2" aria-label="1.æ•°æ®ç»“æ„">1.æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#2%e7%a9%ba%e9%97%b2%e5%af%b9%e8%b1%a1%e9%93%be%e8%a1%a8" aria-label="2.ç©ºé—²å¯¹è±¡é“¾è¡¨">2.ç©ºé—²å¯¹è±¡é“¾è¡¨</a></li>
                <li>
                    <a href="#3%e8%ae%a1%e7%ae%97slab%e9%95%bf%e5%ba%a6" aria-label="3.è®¡ç®—slabé•¿åº¦">3.è®¡ç®—slabé•¿åº¦</a></li>
                <li>
                    <a href="#4%e7%9d%80%e8%89%b2" aria-label="4.ç€è‰²">4.ç€è‰²</a></li>
                <li>
                    <a href="#5%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e6%95%b0%e7%bb%84%e7%bc%93%e5%ad%98" aria-label="5ï¼æ¯å¤„ç†å™¨æ•°ç»„ç¼“å­˜">5ï¼æ¯å¤„ç†å™¨æ•°ç»„ç¼“å­˜</a></li>
                <li>
                    <a href="#6%e5%af%b9numa%e7%9a%84%e6%94%af%e6%8c%81" aria-label="6ï¼å¯¹NUMAçš„æ”¯æŒ">6ï¼å¯¹NUMAçš„æ”¯æŒ</a></li>
                <li>
                    <a href="#7%e5%86%85%e5%ad%98%e7%bc%93%e5%ad%98%e5%90%88%e5%b9%b6" aria-label="7ï¼å†…å­˜ç¼“å­˜åˆå¹¶">7ï¼å†…å­˜ç¼“å­˜åˆå¹¶</a></li>
                <li>
                    <a href="#8%e5%9b%9e%e6%94%b6%e5%86%85%e5%ad%98" aria-label="8.å›æ”¶å†…å­˜">8.å›æ”¶å†…å­˜</a></li></ul>
                </li>
                <li>
                    <a href="#383slub%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.8.3ã€€SLUBåˆ†é…å™¨">3.8.3ã€€SLUBåˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#1%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84-3" aria-label="1ï¼æ•°æ®ç»“æ„">1ï¼æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#2%e7%a9%ba%e9%97%b2%e5%af%b9%e8%b1%a1%e9%93%be%e8%a1%a8-1" aria-label="2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨">2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨</a></li>
                <li>
                    <a href="#3%e8%ae%a1%e7%ae%97slab%e9%95%bf%e5%ba%a6-1" aria-label="3ï¼è®¡ç®—slabé•¿åº¦">3ï¼è®¡ç®—slabé•¿åº¦</a></li>
                <li>
                    <a href="#4%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8slab%e7%bc%93%e5%ad%98" aria-label="4ï¼æ¯å¤„ç†å™¨slabç¼“å­˜">4ï¼æ¯å¤„ç†å™¨slabç¼“å­˜</a></li>
                <li>
                    <a href="#5%e5%af%b9numa%e7%9a%84%e6%94%af%e6%8c%81" aria-label="5ï¼å¯¹NUMAçš„æ”¯æŒ">5ï¼å¯¹NUMAçš„æ”¯æŒ</a></li>
                <li>
                    <a href="#6%e5%9b%9e%e6%94%b6%e5%86%85%e5%ad%98" aria-label="6.å›æ”¶å†…å­˜">6.å›æ”¶å†…å­˜</a></li>
                <li>
                    <a href="#7%e8%b0%83%e8%af%95" aria-label="7.è°ƒè¯•">7.è°ƒè¯•</a></li></ul>
                </li>
                <li>
                    <a href="#384slob%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.8.4ã€€SLOBåˆ†é…å™¨">3.8.4ã€€SLOBåˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#1%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84-4" aria-label="1ï¼æ•°æ®ç»“æ„">1ï¼æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#2%e7%a9%ba%e9%97%b2%e5%af%b9%e8%b1%a1%e9%93%be%e8%a1%a8-2" aria-label="2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨">2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨</a></li>
                <li>
                    <a href="#3%e5%88%86%e9%85%8d%e5%af%b9%e8%b1%a1" aria-label="3ï¼åˆ†é…å¯¹è±¡">3ï¼åˆ†é…å¯¹è±¡</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#39%e4%b8%8d%e8%bf%9e%e7%bb%ad%e9%a1%b5%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.9ã€€ä¸è¿ç»­é¡µåˆ†é…å™¨">3.9ã€€ä¸è¿ç»­é¡µåˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#391%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="3.9.1ã€€ç¼–ç¨‹æ¥å£">3.9.1ã€€ç¼–ç¨‹æ¥å£</a></li>
                <li>
                    <a href="#392%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="3.9.2ã€€æ•°æ®ç»“æ„">3.9.2ã€€æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#393%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="3.9.3ã€€æŠ€æœ¯åŸç†">3.9.3ã€€æŠ€æœ¯åŸç†</a></li></ul>
                </li>
                <li>
                    <a href="#310%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.10ã€€æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨">3.10ã€€æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨</a><ul>
                        
                <li>
                    <a href="#3101%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="3.10.1ã€€ç¼–ç¨‹æ¥å£">3.10.1ã€€ç¼–ç¨‹æ¥å£</a><ul>
                        
                <li>
                    <a href="#1%e9%9d%99%e6%80%81%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="1.é™æ€æ¯å¤„ç†å™¨å˜é‡">1.é™æ€æ¯å¤„ç†å™¨å˜é‡</a></li>
                <li>
                    <a href="#2%e5%8a%a8%e6%80%81%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="2ï¼åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡">2ï¼åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡</a></li>
                <li>
                    <a href="#3%e8%ae%bf%e9%97%ae%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="3ï¼è®¿é—®æ¯å¤„ç†å™¨å˜é‡">3ï¼è®¿é—®æ¯å¤„ç†å™¨å˜é‡</a></li></ul>
                </li>
                <li>
                    <a href="#3102%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="3.10.2ã€€æŠ€æœ¯åŸç†">3.10.2ã€€æŠ€æœ¯åŸç†</a></li></ul>
                </li>
                <li>
                    <a href="#311%e9%a1%b5%e8%a1%a8" aria-label="3.11ã€€é¡µè¡¨">3.11ã€€é¡µè¡¨</a><ul>
                        
                <li>
                    <a href="#3111%e7%bb%9f%e4%b8%80%e7%9a%84%e9%a1%b5%e8%a1%a8%e6%a1%86%e6%9e%b6" aria-label="3.11.1ã€€ç»Ÿä¸€çš„é¡µè¡¨æ¡†æ¶">3.11.1ã€€ç»Ÿä¸€çš„é¡µè¡¨æ¡†æ¶</a></li>
                <li>
                    <a href="#3112arm64%e5%a4%84%e7%90%86%e5%99%a8%e7%9a%84%e9%a1%b5%e8%a1%a8" aria-label="3.11.2ã€€ARM64å¤„ç†å™¨çš„é¡µè¡¨">3.11.2ã€€ARM64å¤„ç†å™¨çš„é¡µè¡¨</a></li></ul>
                </li>
                <li>
                    <a href="#312%e9%a1%b5%e8%a1%a8%e7%bc%93%e5%ad%98" aria-label="3.12ã€€é¡µè¡¨ç¼“å­˜">3.12ã€€é¡µè¡¨ç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#3121tlb%e8%a1%a8%e9%a1%b9%e6%a0%bc%e5%bc%8f" aria-label="3.12.1ã€€TLBè¡¨é¡¹æ ¼å¼">3.12.1ã€€TLBè¡¨é¡¹æ ¼å¼</a></li>
                <li>
                    <a href="#3122tlb%e7%ae%a1%e7%90%86" aria-label="3.12.2ã€€TLBç®¡ç†">3.12.2ã€€TLBç®¡ç†</a></li>
                <li>
                    <a href="#3123%e5%9c%b0%e5%9d%80%e7%a9%ba%e9%97%b4%e6%a0%87%e8%af%86%e7%ac%a6" aria-label="3.12.3ã€€åœ°å€ç©ºé—´æ ‡è¯†ç¬¦">3.12.3ã€€åœ°å€ç©ºé—´æ ‡è¯†ç¬¦</a></li>
                <li>
                    <a href="#3124%e8%99%9a%e6%8b%9f%e6%9c%ba%e6%a0%87%e8%af%86%e7%ac%a6" aria-label="3.12.4ã€€è™šæ‹Ÿæœºæ ‡è¯†ç¬¦">3.12.4ã€€<strong>è™šæ‹Ÿæœºæ ‡è¯†ç¬¦</strong></a></li></ul>
                </li>
                <li>
                    <a href="#313%e5%b7%a8%e5%9e%8b%e9%a1%b5" aria-label="3.13ã€€å·¨å‹é¡µ">3.13ã€€å·¨å‹é¡µ</a><ul>
                        
                <li>
                    <a href="#3131%e5%a4%84%e7%90%86%e5%99%a8%e5%af%b9%e5%b7%a8%e5%9e%8b%e9%a1%b5%e7%9a%84%e6%94%af%e6%8c%81" aria-label="3.13.1ã€€å¤„ç†å™¨å¯¹å·¨å‹é¡µçš„æ”¯æŒ">3.13.1ã€€å¤„ç†å™¨å¯¹å·¨å‹é¡µçš„æ”¯æŒ</a></li>
                <li>
                    <a href="#3132%e6%a0%87%e5%87%86%e5%b7%a8%e5%9e%8b%e9%a1%b5" aria-label="3.13.2ã€€æ ‡å‡†å·¨å‹é¡µ">3.13.2ã€€æ ‡å‡†å·¨å‹é¡µ</a></li>
                <li>
                    <a href="#3133%e9%80%8f%e6%98%8e%e5%b7%a8%e5%9e%8b%e9%a1%b5" aria-label="3.13.3ã€€é€æ˜å·¨å‹é¡µ">3.13.3ã€€é€æ˜å·¨å‹é¡µ</a></li></ul>
                </li>
                <li>
                    <a href="#314%e9%a1%b5%e9%94%99%e8%af%af%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="3.14ã€€é¡µé”™è¯¯å¼‚å¸¸å¤„ç†">3.14ã€€é¡µé”™è¯¯å¼‚å¸¸å¤„ç†</a><ul>
                        
                <li>
                    <a href="#3141%e5%a4%84%e7%90%86%e5%99%a8%e6%9e%b6%e6%9e%84%e7%89%b9%e5%ae%9a%e9%83%a8%e5%88%86" aria-label="3.14.1ã€€å¤„ç†å™¨æ¶æ„ç‰¹å®šéƒ¨åˆ†">3.14.1ã€€å¤„ç†å™¨æ¶æ„ç‰¹å®šéƒ¨åˆ†</a><ul>
                        
                <li>
                    <a href="#1%e7%94%9f%e6%88%90%e9%a1%b5%e9%94%99%e8%af%af%e5%bc%82%e5%b8%b8" aria-label="1.ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸">1.ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸</a></li>
                <li>
                    <a href="#2%e5%a4%84%e7%90%86%e9%a1%b5%e9%94%99%e8%af%af%e5%bc%82%e5%b8%b8" aria-label="2.å¤„ç†é¡µé”™è¯¯å¼‚å¸¸">2.å¤„ç†é¡µé”™è¯¯å¼‚å¸¸</a></li></ul>
                </li>
                <li>
                    <a href="#3142%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e9%a1%b5%e9%94%99%e8%af%af%e5%bc%82%e5%b8%b8" aria-label="3.14.2ã€€ç”¨æˆ·ç©ºé—´é¡µé”™è¯¯å¼‚å¸¸">3.14.2ã€€ç”¨æˆ·ç©ºé—´é¡µé”™è¯¯å¼‚å¸¸</a><ul>
                        
                <li>
                    <a href="#1%e5%8c%bf%e5%90%8d%e9%a1%b5%e7%9a%84%e7%bc%ba%e9%a1%b5%e5%bc%82%e5%b8%b8" aria-label="1ï¼åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸">1ï¼åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸</a></li>
                <li>
                    <a href="#2%e6%96%87%e4%bb%b6%e9%a1%b5%e7%9a%84%e7%bc%ba%e9%a1%b5%e5%bc%82%e5%b8%b8" aria-label="2ï¼æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸">2ï¼æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸</a></li>
                <li>
                    <a href="#3%e5%86%99%e6%97%b6%e5%a4%8d%e5%88%b6" aria-label="3ï¼å†™æ—¶å¤åˆ¶">3ï¼å†™æ—¶å¤åˆ¶</a></li></ul>
                </li>
                <li>
                    <a href="#3143%e5%86%85%e6%a0%b8%e6%a8%a1%e5%bc%8f%e9%a1%b5%e9%94%99%e8%af%af%e5%bc%82%e5%b8%b8" aria-label="3.14.3ã€€å†…æ ¸æ¨¡å¼é¡µé”™è¯¯å¼‚å¸¸">3.14.3ã€€å†…æ ¸æ¨¡å¼é¡µé”™è¯¯å¼‚å¸¸</a><ul>
                        
                <li>
                    <a href="#1%e5%87%bd%e6%95%b0__do_kernel_fault" aria-label="1.å‡½æ•°__do_kernel_fault">1.å‡½æ•°__do_kernel_fault</a></li>
                <li>
                    <a href="#2%e5%bc%82%e5%b8%b8%e8%a1%a8" aria-label="2.å¼‚å¸¸è¡¨">2.å¼‚å¸¸è¡¨</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#315%e5%8f%8d%e7%a2%8e%e7%89%87%e6%8a%80%e6%9c%af" aria-label="3.15ã€€åç¢ç‰‡æŠ€æœ¯">3.15ã€€åç¢ç‰‡æŠ€æœ¯</a><ul>
                        
                <li>
                    <a href="#3151%e8%99%9a%e6%8b%9f%e5%8f%af%e7%a7%bb%e5%8a%a8%e5%8c%ba%e5%9f%9f" aria-label="3.15.1ã€€è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ">3.15.1ã€€è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ</a></li>
                <li>
                    <a href="#3152%e5%86%85%e5%ad%98%e7%a2%8e%e7%89%87%e6%95%b4%e7%90%86" aria-label="3.15.2ã€€å†…å­˜ç¢ç‰‡æ•´ç†">3.15.2ã€€å†…å­˜ç¢ç‰‡æ•´ç†</a><ul>
                        
                <li>
                    <a href="#1%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="1.ä½¿ç”¨æ–¹æ³•">1.ä½¿ç”¨æ–¹æ³•</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#316%e9%a1%b5%e5%9b%9e%e6%94%b6" aria-label="3.16ã€€é¡µå›æ”¶">3.16ã€€é¡µå›æ”¶</a><ul>
                        
                <li>
                    <a href="#3161%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="3.16.1ã€€æ•°æ®ç»“æ„">3.16.1ã€€æ•°æ®ç»“æ„</a><ul>
                        
                <li>
                    <a href="#1lru%e9%93%be%e8%a1%a8" aria-label="1ï¼LRUé“¾è¡¨">1ï¼LRUé“¾è¡¨</a></li></ul>
                </li>
                <li>
                    <a href="#3162%e5%8f%91%e8%b5%b7%e9%a1%b5%e5%9b%9e%e6%94%b6" aria-label="3.16.2ã€€å‘èµ·é¡µå›æ”¶">3.16.2ã€€å‘èµ·é¡µå›æ”¶</a></li>
                <li>
                    <a href="#3163%e8%ae%a1%e7%ae%97%e6%89%ab%e6%8f%8f%e7%9a%84%e9%a1%b5%e6%95%b0" aria-label="3.16.3ã€€è®¡ç®—æ‰«æçš„é¡µæ•°">3.16.3ã€€è®¡ç®—æ‰«æçš„é¡µæ•°</a></li>
                <li>
                    <a href="#3164%e6%94%b6%e7%bc%a9%e6%b4%bb%e5%8a%a8%e9%a1%b5%e9%93%be%e8%a1%a8" aria-label="3.16.4ã€€æ”¶ç¼©æ´»åŠ¨é¡µé“¾è¡¨">3.16.4ã€€æ”¶ç¼©æ´»åŠ¨é¡µé“¾è¡¨</a></li>
                <li>
                    <a href="#3165%e5%9b%9e%e6%94%b6%e4%b8%8d%e6%b4%bb%e5%8a%a8%e9%a1%b5" aria-label="3.16.5ã€€å›æ”¶ä¸æ´»åŠ¨é¡µ">3.16.5ã€€å›æ”¶ä¸æ´»åŠ¨é¡µ</a></li>
                <li>
                    <a href="#3166%e9%a1%b5%e4%ba%a4%e6%8d%a2" aria-label="3.16.6ã€€é¡µäº¤æ¢">3.16.6ã€€é¡µäº¤æ¢</a></li>
                <li>
                    <a href="#3167%e5%9b%9e%e6%94%b6slab%e7%bc%93%e5%ad%98" aria-label="3.16.7ã€€å›æ”¶slabç¼“å­˜">3.16.7ã€€å›æ”¶slabç¼“å­˜</a></li></ul>
                </li>
                <li>
                    <a href="#317%e5%86%85%e5%ad%98%e8%80%97%e5%b0%bd%e6%9d%80%e6%89%8b" aria-label="3.17ã€€å†…å­˜è€—å°½æ€æ‰‹">3.17ã€€å†…å­˜è€—å°½æ€æ‰‹</a><ul>
                        
                <li>
                    <a href="#3171%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="3.17.1ã€€ä½¿ç”¨æ–¹æ³•">3.17.1ã€€ä½¿ç”¨æ–¹æ³•</a></li>
                <li>
                    <a href="#3172%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="3.17.2ã€€æŠ€æœ¯åŸç†">3.17.2ã€€æŠ€æœ¯åŸç†</a></li></ul>
                </li>
                <li>
                    <a href="#318%e5%86%85%e5%ad%98%e8%b5%84%e6%ba%90%e6%8e%a7%e5%88%b6%e5%99%a8" aria-label="3.18ã€€å†…å­˜èµ„æºæ§åˆ¶å™¨">3.18ã€€å†…å­˜èµ„æºæ§åˆ¶å™¨</a><ul>
                        
                <li>
                    <a href="#3181%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="3.18.1ã€€ä½¿ç”¨æ–¹æ³•">3.18.1ã€€ä½¿ç”¨æ–¹æ³•</a></li>
                <li>
                    <a href="#3182%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="3.18.2ã€€æŠ€æœ¯åŸç†">3.18.2ã€€æŠ€æœ¯åŸç†</a></li></ul>
                </li>
                <li>
                    <a href="#319%e5%a4%84%e7%90%86%e5%99%a8%e7%bc%93%e5%ad%98" aria-label="3.19ã€€å¤„ç†å™¨ç¼“å­˜">3.19ã€€å¤„ç†å™¨ç¼“å­˜</a><ul>
                        
                <li>
                    <a href="#3191%e7%bc%93%e5%ad%98%e7%bb%93%e6%9e%84" aria-label="3.19.1ã€€ç¼“å­˜ç»“æ„">3.19.1ã€€ç¼“å­˜ç»“æ„</a></li>
                <li>
                    <a href="#3192%e7%bc%93%e5%ad%98%e7%ad%96%e7%95%a5" aria-label="3.19.2ã€€ç¼“å­˜ç­–ç•¥">3.19.2ã€€ç¼“å­˜ç­–ç•¥</a></li>
                <li>
                    <a href="#3193-%e7%bc%93%e5%ad%98%e7%bb%b4%e6%8a%a4" aria-label="3.19.3 ç¼“å­˜ç»´æŠ¤">3.19.3 ç¼“å­˜ç»´æŠ¤</a><ul>
                        
                <li>
                    <a href="#3arm64%e5%a4%84%e7%90%86%e5%99%a8%e7%bc%93%e5%ad%98%e7%bb%b4%e6%8a%a4" aria-label="3.ARM64å¤„ç†å™¨ç¼“å­˜ç»´æŠ¤">3.ARM64å¤„ç†å™¨ç¼“å­˜ç»´æŠ¤</a></li></ul>
                </li>
                <li>
                    <a href="#3194smp%e7%bc%93%e5%ad%98%e4%b8%80%e8%87%b4%e6%80%a7" aria-label="3.19.4ã€€SMPç¼“å­˜ä¸€è‡´æ€§">3.19.4ã€€SMPç¼“å­˜ä¸€è‡´æ€§</a></li></ul>
                </li>
                <li>
                    <a href="#320-%e8%bf%9e%e7%bb%ad%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d%e5%99%a8" aria-label="3.20 è¿ç»­å†…å­˜åˆ†é…å™¨">3.20 è¿ç»­å†…å­˜åˆ†é…å™¨</a></li>
                <li>
                    <a href="#321-userfaultfd" aria-label="3.21 userfaultfd">3.21 userfaultfd</a></li>
                <li>
                    <a href="#322-%e5%86%85%e5%ad%98%e9%94%99%e8%af%af%e6%a3%80%e6%b5%8b%e5%b7%a5%e5%85%b7kasan" aria-label="3.22 å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·KASAN">3.22 å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·KASAN</a></li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac4%e7%ab%a0-%e4%b8%ad%e6%96%ad%e5%bc%82%e5%b8%b8%e5%92%8c%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="ç¬¬4ç«  ä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨">ç¬¬4ç«  ä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨</a><ul>
                        
                <li>
                    <a href="#41-arm64%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="4.1 ARM64å¼‚å¸¸å¤„ç†">4.1 ARM64å¼‚å¸¸å¤„ç†</a><ul>
                        
                <li>
                    <a href="#411-%e5%bc%82%e5%b8%b8%e7%ba%a7%e5%88%ab" aria-label="4.1.1 å¼‚å¸¸çº§åˆ«">4.1.1 å¼‚å¸¸çº§åˆ«</a></li>
                <li>
                    <a href="#412-%e5%bc%82%e5%b8%b8%e5%88%86%e7%b1%bb" aria-label="4.1.2 å¼‚å¸¸åˆ†ç±»">4.1.2 å¼‚å¸¸åˆ†ç±»</a></li>
                <li>
                    <a href="#413-%e5%bc%82%e5%b8%b8%e5%90%91%e9%87%8f%e8%a1%a8" aria-label="4.1.3 å¼‚å¸¸å‘é‡è¡¨">4.1.3 å¼‚å¸¸å‘é‡è¡¨</a></li>
                <li>
                    <a href="#414-%e5%bc%82%e5%b8%b8%e5%a4%84%e7%90%86" aria-label="4.1.4 å¼‚å¸¸å¤„ç†">4.1.4 å¼‚å¸¸å¤„ç†</a></li></ul>
                </li>
                <li>
                    <a href="#42-%e4%b8%ad%e6%96%ad" aria-label="4.2 ä¸­æ–­">4.2 ä¸­æ–­</a><ul>
                        
                <li>
                    <a href="#421%e4%b8%ad%e6%96%ad%e6%8e%a7%e5%88%b6%e5%99%a8" aria-label="4.2.1ã€€ä¸­æ–­æ§åˆ¶å™¨">4.2.1ã€€ä¸­æ–­æ§åˆ¶å™¨</a></li>
                <li>
                    <a href="#422%e4%b8%ad%e6%96%ad%e5%9f%9f" aria-label="4.2.2ã€€ä¸­æ–­åŸŸ">4.2.2ã€€ä¸­æ–­åŸŸ</a><ul>
                        
                <li>
                    <a href="#1%e5%88%9b%e5%bb%ba%e4%b8%ad%e6%96%ad%e5%9f%9f" aria-label="1ï¼åˆ›å»ºä¸­æ–­åŸŸ">1ï¼åˆ›å»ºä¸­æ–­åŸŸ</a></li>
                <li>
                    <a href="#2%e5%88%9b%e5%bb%ba%e6%98%a0%e5%b0%84" aria-label="2ï¼åˆ›å»ºæ˜ å°„">2ï¼åˆ›å»ºæ˜ å°„</a></li>
                <li>
                    <a href="#3%e6%9f%a5%e6%89%be%e6%98%a0%e5%b0%84" aria-label="3ï¼æŸ¥æ‰¾æ˜ å°„">3ï¼æŸ¥æ‰¾æ˜ å°„</a></li></ul>
                </li>
                <li>
                    <a href="#423%e4%b8%ad%e6%96%ad%e6%8e%a7%e5%88%b6%e5%99%a8%e9%a9%b1%e5%8a%a8%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="4.2.3ã€€ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–">4.2.3ã€€ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–</a><ul>
                        
                <li>
                    <a href="#1%e8%ae%be%e5%a4%87%e6%a0%91%e6%ba%90%e6%96%87%e4%bb%b6" aria-label="1ï¼è®¾å¤‡æ ‘æºæ–‡ä»¶">1ï¼è®¾å¤‡æ ‘æºæ–‡ä»¶</a></li>
                <li>
                    <a href="#3%e5%88%9d%e5%a7%8b%e5%8c%96" aria-label="3.åˆå§‹åŒ–">3.åˆå§‹åŒ–</a></li></ul>
                </li>
                <li>
                    <a href="#424linux%e4%b8%ad%e6%96%ad%e5%a4%84%e7%90%86" aria-label="4.2.4ã€€Linuxä¸­æ–­å¤„ç†">4.2.4ã€€Linuxä¸­æ–­å¤„ç†</a></li>
                <li>
                    <a href="#425%e4%b8%ad%e6%96%ad%e7%ba%bf%e7%a8%8b%e5%8c%96" aria-label="4.2.5ã€€ä¸­æ–­çº¿ç¨‹åŒ–">4.2.5ã€€ä¸­æ–­çº¿ç¨‹åŒ–</a></li>
                <li>
                    <a href="#426%e7%a6%81%e6%ad%a2%e5%bc%80%e5%90%af%e4%b8%ad%e6%96%ad" aria-label="4.2.6ã€€ç¦æ­¢/å¼€å¯ä¸­æ–­">4.2.6ã€€ç¦æ­¢/å¼€å¯ä¸­æ–­</a></li>
                <li>
                    <a href="#427%e7%a6%81%e6%ad%a2%e5%bc%80%e5%90%af%e5%8d%95%e4%b8%aa%e4%b8%ad%e6%96%ad" aria-label="4.2.7ã€€ç¦æ­¢/å¼€å¯å•ä¸ªä¸­æ–­">4.2.7ã€€ç¦æ­¢/å¼€å¯å•ä¸ªä¸­æ–­</a></li>
                <li>
                    <a href="#428%e4%b8%ad%e6%96%ad%e4%ba%b2%e5%92%8c%e6%80%a7" aria-label="4.2.8ã€€ä¸­æ–­äº²å’Œæ€§">4.2.8ã€€ä¸­æ–­äº²å’Œæ€§</a></li>
                <li>
                    <a href="#429%e5%a4%84%e7%90%86%e5%99%a8%e9%97%b4%e4%b8%ad%e6%96%ad" aria-label="4.2.9ã€€å¤„ç†å™¨é—´ä¸­æ–­">4.2.9ã€€å¤„ç†å™¨é—´ä¸­æ–­</a></li></ul>
                </li>
                <li>
                    <a href="#43%e4%b8%ad%e6%96%ad%e4%b8%8b%e5%8d%8a%e9%83%a8" aria-label="4.3ã€€ä¸­æ–­ä¸‹åŠéƒ¨">4.3ã€€ä¸­æ–­ä¸‹åŠéƒ¨</a><ul>
                        
                <li>
                    <a href="#431%e8%bd%af%e4%b8%ad%e6%96%ad" aria-label="4.3.1ã€€è½¯ä¸­æ–­">4.3.1ã€€è½¯ä¸­æ–­</a><ul>
                        
                <li>
                    <a href="#1%e8%bd%af%e4%b8%ad%e6%96%ad%e7%9a%84%e7%a7%8d%e7%b1%bb" aria-label="1ï¼è½¯ä¸­æ–­çš„ç§ç±»">1ï¼è½¯ä¸­æ–­çš„ç§ç±»</a></li>
                <li>
                    <a href="#2%e6%b3%a8%e5%86%8c%e8%bd%af%e4%b8%ad%e6%96%ad%e7%9a%84%e5%a4%84%e7%90%86%e5%87%bd%e6%95%b0" aria-label="2ï¼æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°">2ï¼æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°</a></li>
                <li>
                    <a href="#3%e8%a7%a6%e5%8f%91%e8%bd%af%e4%b8%ad%e6%96%ad" aria-label="3ï¼è§¦å‘è½¯ä¸­æ–­">3ï¼è§¦å‘è½¯ä¸­æ–­</a></li>
                <li>
                    <a href="#4%e6%89%a7%e8%a1%8c%e8%bd%af%e4%b8%ad%e6%96%ad" aria-label="4.æ‰§è¡Œè½¯ä¸­æ–­">4.æ‰§è¡Œè½¯ä¸­æ–­</a></li>
                <li>
                    <a href="#5%e6%8a%a2%e5%8d%a0%e8%ae%a1%e6%95%b0%e5%99%a8" aria-label="5ï¼æŠ¢å è®¡æ•°å™¨">5ï¼æŠ¢å è®¡æ•°å™¨</a></li>
                <li>
                    <a href="#6%e7%a6%81%e6%ad%a2%e5%bc%80%e5%90%af%e8%bd%af%e4%b8%ad%e6%96%ad" aria-label="6ï¼ç¦æ­¢/å¼€å¯è½¯ä¸­æ–­">6ï¼ç¦æ­¢/å¼€å¯è½¯ä¸­æ–­</a></li></ul>
                </li>
                <li>
                    <a href="#432-%e5%b0%8f%e4%bb%bb%e5%8a%a1-tasklet" aria-label="4.3.2 å°ä»»åŠ¡ tasklet">4.3.2 å°ä»»åŠ¡ tasklet</a><ul>
                        
                <li>
                    <a href="#1%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84-5" aria-label="1.æ•°æ®ç»“æ„">1.æ•°æ®ç»“æ„</a></li>
                <li>
                    <a href="#2%e7%bc%96%e7%a8%8b%e6%8e%a5%e5%8f%a3" aria-label="2ï¼ç¼–ç¨‹æ¥å£">2ï¼ç¼–ç¨‹æ¥å£</a></li>
                <li>
                    <a href="#3%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="3ï¼æŠ€æœ¯åŸç†">3ï¼æŠ€æœ¯åŸç†</a></li></ul>
                </li>
                <li>
                    <a href="#433%e5%b7%a5%e4%bd%9c%e9%98%9f%e5%88%97" aria-label="4.3.3ã€€å·¥ä½œé˜Ÿåˆ—">4.3.3ã€€å·¥ä½œé˜Ÿåˆ—</a></li></ul>
                </li>
                <li>
                    <a href="#44%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="4.4ã€€ç³»ç»Ÿè°ƒç”¨">4.4ã€€ç³»ç»Ÿè°ƒç”¨</a><ul>
                        
                <li>
                    <a href="#441-%e5%ae%9a%e4%b9%89%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="4.4.1 å®šä¹‰ç³»ç»Ÿè°ƒç”¨">4.4.1 å®šä¹‰ç³»ç»Ÿè°ƒç”¨</a></li>
                <li>
                    <a href="#442-%e6%89%a7%e8%a1%8c%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" aria-label="4.4.2 æ‰§è¡Œç³»ç»Ÿè°ƒç”¨">4.4.2 æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac5%e7%ab%a0-%e5%86%85%e6%a0%b8%e4%ba%92%e6%96%a5%e6%8a%80%e6%9c%af" aria-label="ç¬¬5ç«  å†…æ ¸äº’æ–¥æŠ€æœ¯">ç¬¬5ç«  å†…æ ¸äº’æ–¥æŠ€æœ¯</a><ul>
                        
                <li>
                    <a href="#51-%e4%bf%a1%e5%8f%b7%e9%87%8f" aria-label="5.1 ä¿¡å·é‡">5.1 ä¿¡å·é‡</a></li>
                <li>
                    <a href="#52-%e8%af%bb%e5%86%99%e4%bf%a1%e5%8f%b7%e9%87%8f" aria-label="5.2 è¯»å†™ä¿¡å·é‡">5.2 è¯»å†™ä¿¡å·é‡</a></li>
                <li>
                    <a href="#53-%e4%ba%92%e6%96%a5%e9%94%81" aria-label="5.3 äº’æ–¥é”">5.3 äº’æ–¥é”</a></li>
                <li>
                    <a href="#54-%e5%ae%9e%e6%97%b6%e4%ba%92%e6%96%a5%e9%94%81" aria-label="5.4 å®æ—¶äº’æ–¥é”">5.4 å®æ—¶äº’æ–¥é”</a></li>
                <li>
                    <a href="#55-%e5%8e%9f%e5%ad%90%e5%8f%98%e9%87%8f" aria-label="5.5 åŸå­å˜é‡">5.5 åŸå­å˜é‡</a><ul>
                        
                <li>
                    <a href="#arm64%e5%a4%84%e7%90%86%e5%99%a8%e7%9a%84%e5%8e%9f%e5%ad%90%e5%8f%98%e9%87%8f%e5%ae%9e%e7%8e%b0" aria-label="ARM64å¤„ç†å™¨çš„åŸå­å˜é‡å®ç°">ARM64å¤„ç†å™¨çš„åŸå­å˜é‡å®ç°</a></li></ul>
                </li>
                <li>
                    <a href="#56-%e8%87%aa%e6%97%8b%e9%94%81" aria-label="5.6 è‡ªæ—‹é”">5.6 è‡ªæ—‹é”</a></li>
                <li>
                    <a href="#57-%e8%af%bb%e5%86%99%e8%87%aa%e6%97%8b%e9%94%81" aria-label="5.7 è¯»å†™è‡ªæ—‹é”">5.7 è¯»å†™è‡ªæ—‹é”</a></li>
                <li>
                    <a href="#58-%e9%a1%ba%e5%ba%8f%e9%94%81" aria-label="5.8 é¡ºåºé”">5.8 é¡ºåºé”</a><ul>
                        
                <li>
                    <a href="#581%e5%ae%8c%e6%95%b4%e7%89%88%e7%9a%84%e9%a1%ba%e5%ba%8f%e9%94%81" aria-label="5.8.1ã€€å®Œæ•´ç‰ˆçš„é¡ºåºé”">5.8.1ã€€å®Œæ•´ç‰ˆçš„é¡ºåºé”</a></li>
                <li>
                    <a href="#582%e5%8f%aa%e6%8f%90%e4%be%9b%e5%ba%8f%e5%88%97%e5%8f%b7%e7%9a%84%e9%a1%ba%e5%ba%8f%e9%94%81" aria-label="5.8.2ã€€åªæä¾›åºåˆ—å·çš„é¡ºåºé”">5.8.2ã€€åªæä¾›åºåˆ—å·çš„é¡ºåºé”</a></li></ul>
                </li>
                <li>
                    <a href="#59%e7%a6%81%e6%ad%a2%e5%86%85%e6%a0%b8%e6%8a%a2%e5%8d%a0" aria-label="5.9ã€€ç¦æ­¢å†…æ ¸æŠ¢å ">5.9ã€€ç¦æ­¢å†…æ ¸æŠ¢å </a></li>
                <li>
                    <a href="#510%e8%bf%9b%e7%a8%8b%e5%92%8c%e8%bd%af%e4%b8%ad%e6%96%ad%e4%ba%92%e6%96%a5" aria-label="5.10ã€€è¿›ç¨‹å’Œè½¯ä¸­æ–­äº’æ–¥">5.10ã€€è¿›ç¨‹å’Œè½¯ä¸­æ–­äº’æ–¥</a></li>
                <li>
                    <a href="#511%e8%bf%9b%e7%a8%8b%e5%92%8c%e7%a1%ac%e4%b8%ad%e6%96%ad%e4%ba%92%e6%96%a5" aria-label="5.11ã€€è¿›ç¨‹å’Œç¡¬ä¸­æ–­äº’æ–¥">5.11ã€€è¿›ç¨‹å’Œç¡¬ä¸­æ–­äº’æ–¥</a></li>
                <li>
                    <a href="#512%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="5.12ã€€æ¯å¤„ç†å™¨å˜é‡">5.12ã€€æ¯å¤„ç†å™¨å˜é‡</a><ul>
                        
                <li>
                    <a href="#5121%e9%9d%99%e6%80%81%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="5.12.1ã€€é™æ€æ¯å¤„ç†å™¨å˜é‡">5.12.1ã€€é™æ€æ¯å¤„ç†å™¨å˜é‡</a></li>
                <li>
                    <a href="#5122%e5%8a%a8%e6%80%81%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="5.12.2ã€€åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡">5.12.2ã€€åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡</a></li>
                <li>
                    <a href="#5123%e8%ae%bf%e9%97%ae%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e5%8f%98%e9%87%8f" aria-label="5.12.3ã€€è®¿é—®æ¯å¤„ç†å™¨å˜é‡">5.12.3ã€€è®¿é—®æ¯å¤„ç†å™¨å˜é‡</a></li></ul>
                </li>
                <li>
                    <a href="#513%e6%af%8f%e5%a4%84%e7%90%86%e5%99%a8%e8%ae%a1%e6%95%b0%e5%99%a8" aria-label="5.13ã€€æ¯å¤„ç†å™¨è®¡æ•°å™¨">5.13ã€€æ¯å¤„ç†å™¨è®¡æ•°å™¨</a></li>
                <li>
                    <a href="#514%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c" aria-label="5.14ã€€å†…å­˜å±éšœ">5.14ã€€å†…å­˜å±éšœ</a><ul>
                        
                <li>
                    <a href="#5141%e7%bc%96%e8%af%91%e5%99%a8%e5%b1%8f%e9%9a%9c" aria-label="5.14.1ã€€ç¼–è¯‘å™¨å±éšœ">5.14.1ã€€ç¼–è¯‘å™¨å±éšœ</a></li>
                <li>
                    <a href="#5142%e5%a4%84%e7%90%86%e5%99%a8%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c" aria-label="5.14.2ã€€å¤„ç†å™¨å†…å­˜å±éšœ">5.14.2ã€€å¤„ç†å™¨å†…å­˜å±éšœ</a></li>
                <li>
                    <a href="#5143-mmio%e5%86%99%e5%b1%8f%e9%9a%9c" aria-label="5.14.3 MMIOå†™å±éšœ">5.14.3 MMIOå†™å±éšœ</a></li>
                <li>
                    <a href="#5144%e9%9a%90%e5%90%ab%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c" aria-label="5.14.4ã€€éšå«å†…å­˜å±éšœ">5.14.4ã€€éšå«å†…å­˜å±éšœ</a></li>
                <li>
                    <a href="#5145arm64%e5%a4%84%e7%90%86%e5%99%a8%e5%86%85%e5%ad%98%e5%b1%8f%e9%9a%9c" aria-label="5.14.5ã€€ARM64å¤„ç†å™¨å†…å­˜å±éšœ">5.14.5ã€€ARM64å¤„ç†å™¨å†…å­˜å±éšœ</a></li></ul>
                </li>
                <li>
                    <a href="#515rcu" aria-label="5.15ã€€RCU">5.15ã€€RCU</a><ul>
                        
                <li>
                    <a href="#5152%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="5.15.2ã€€æŠ€æœ¯åŸç†">5.15.2ã€€æŠ€æœ¯åŸç†</a></li></ul>
                </li>
                <li>
                    <a href="#516%e5%8f%af%e7%9d%a1%e7%9c%a0rcu" aria-label="5.16ã€€å¯ç¡çœ RCU">5.16ã€€å¯ç¡çœ RCU</a></li>
                <li>
                    <a href="#517%e6%ad%bb%e9%94%81%e6%a3%80%e6%b5%8b%e5%b7%a5%e5%85%b7lockdep" aria-label="5.17ã€€æ­»é”æ£€æµ‹å·¥å…·lockdep">5.17ã€€æ­»é”æ£€æµ‹å·¥å…·lockdep</a><ul>
                        
                <li>
                    <a href="#5171%e4%bd%bf%e7%94%a8%e6%96%b9%e6%b3%95" aria-label="5.17.1ã€€ä½¿ç”¨æ–¹æ³•">5.17.1ã€€ä½¿ç”¨æ–¹æ³•</a></li>
                <li>
                    <a href="#5172%e6%8a%80%e6%9c%af%e5%8e%9f%e7%90%86" aria-label="5.17.2ã€€æŠ€æœ¯åŸç†">5.17.2ã€€æŠ€æœ¯åŸç†</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#%e7%ac%ac6%e7%ab%a0-%e6%96%87%e4%bb%b6%e7%b3%bb%e7%bb%9f" aria-label="ç¬¬6ç«  æ–‡ä»¶ç³»ç»Ÿ">ç¬¬6ç«  æ–‡ä»¶ç³»ç»Ÿ</a><ul>
                        
                <li>
                    <a href="#61%e6%a6%82%e8%bf%b0" aria-label="6.1ã€€æ¦‚è¿°">6.1ã€€æ¦‚è¿°</a><ul>
                        
                <li>
                    <a href="#611%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4%e5%b1%82%e9%9d%a2" aria-label="6.1.1ã€€ç”¨æˆ·ç©ºé—´å±‚é¢">6.1.1ã€€ç”¨æˆ·ç©ºé—´å±‚é¢</a></li>
                <li>
                    <a href="#612%e7%a1%ac%e4%bb%b6%e5%b1%82%e9%9d%a2" aria-label="6.1.2ã€€ç¡¬ä»¶å±‚é¢">6.1.2ã€€ç¡¬ä»¶å±‚é¢</a></li>
                <li>
                    <a href="#613%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4%e5%b1%82%e9%9d%a2" aria-label="6.1.3ã€€å†…æ ¸ç©ºé—´å±‚é¢">6.1.3ã€€å†…æ ¸ç©ºé—´å±‚é¢</a>
                </li>
            </ul>
            </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        activeElement = Array.from(elements).find((element) => {
            if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                return element;
            }
        }) || activeElement

        elements.forEach(element => {
            const id = encodeURI(element.getAttribute('id')).toLowerCase();
            if (element === activeElement){
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
            } else {
                document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
            }
        })
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;

        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        
        <div class="post-content"><h1 id="å†…å®¹æçº²">å†…å®¹æçº²<a hidden class="anchor" aria-hidden="true" href="#å†…å®¹æçº²">#</a></h1>
<ul>
<li>å†…æ ¸çš„å¼•å¯¼è¿‡ç¨‹U-Boot</li>
<li>å†…æ ¸ç®¡ç†å’Œè°ƒåº¦è¿›ç¨‹</li>
<li>å†…æ ¸ç®¡ç†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜</li>
<li>å†…æ ¸å¤„ç†å¼‚å¸¸å’Œä¸­æ–­çš„æŠ€æœ¯åŸç†ï¼Œä»¥åŠç³»ç»Ÿè°ƒç”¨çš„å®ç°æ–¹å¼</li>
<li>ä¿æŠ¤ä¸´ç•ŒåŒºçš„äº’æ–¥</li>
<li>è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</li>
</ul>
<h1 id="ç¬¬1ç« -å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">ç¬¬1ç«  å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#ç¬¬1ç« -å†…æ ¸å¼•å¯¼å’Œåˆå§‹åŒ–">#</a></h1>
<p>â€‚å¤„ç†å™¨ä¸Šç”µ-&gt;æ‰§è¡Œå¼•å¯¼ç¨‹åº-&gt;åŠ è½½å†…æ ¸åˆ°å†…å­˜-&gt;æ‰§è¡Œå†…æ ¸-&gt;å†…æ ¸åˆå§‹åŒ–-&gt;å¯åŠ¨ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹
â€ƒARM64å¤„ç†å™¨åˆ°ç‰©ç†åœ°å€0å–ç¬¬ä¸€æ¡æŒ‡ä»¤</p>
<h2 id="11-å¼•å¯¼ç¨‹åº">1.1 å¼•å¯¼ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#11-å¼•å¯¼ç¨‹åº">#</a></h2>
<h3 id="111-å…¥å£_start">1.1.1 å…¥å£_start<a hidden class="anchor" aria-hidden="true" href="#111-å…¥å£_start">#</a></h3>
<p>â€ƒARM64å¤„ç†å™¨U-Bootç¨‹åºæ‰§è¡Œè¿‡ç¨‹ï¼Œå…¥å£<a href="https://elixir.bootlin.com/u-boot/latest/source/arch/arm/cpu/armv8/start.S#L20"><code>u-boot/arch/arm/cpu/armv8/start.S</code></a>æ ‡è¯†<code>_start</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>.globl	_start
</span></span><span style="display:flex;"><span>_start:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_LINUX_KERNEL_IMAGE_HEADER)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/boot0-linux-kernel-header.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(CONFIG_ENABLE_ARM_SOC_BOOT0_HOOK)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/arch/boot0.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b	reset
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><h3 id="112-reset">1.1.2 <code>reset</code><a hidden class="anchor" aria-hidden="true" href="#112-reset">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>reset:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Allow the board to save important registers */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å…è®¸æ¿å¡ä¿å­˜é‡è¦çš„å¯„å­˜å™¨*/</span>
</span></span><span style="display:flex;"><span>	b	save_boot_params
</span></span><span style="display:flex;"><span>.globl	save_boot_params_ret
</span></span><span style="display:flex;"><span>save_boot_params_ret:
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SYS_RESET_SCTRL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl reset_sctrl   <span style="color:#75715e">// åˆå§‹åŒ–ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å¼‚å¸¸çº§åˆ«å¯èƒ½æ˜¯3ã€2æˆ–è€…1ï¼Œåˆå§‹çŠ¶æ€ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å°ç«¯å­—èŠ‚åºï¼Œç¦æ­¢MMUï¼Œç¦æ­¢æŒ‡ä»¤/æ•°æ®ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>    adr  x0, vectors
</span></span><span style="display:flex;"><span>    witch_el x1, <span style="color:#ae81ff">3f</span>, <span style="color:#ae81ff">2f</span>, <span style="color:#ae81ff">1f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>  msr  vbar_el3, x0    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«3ï¼Œå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL3è®¾ç½®ä½å¼‚å¸¸å‘é‡çš„èµ·å§‹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mrs  x0, scr_el3   <span style="color:#75715e">// è®¾ç½®å®‰å…¨é…ç½®å¯„å­˜å™¨SCR_EL3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    orr  x0, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>         <span style="color:#75715e">/* è®¾ç½®å¯„å­˜å™¨SCR_EL3çš„NSã€IRQã€FIQå’ŒEAå››ä¸ªä½ */</span>
</span></span><span style="display:flex;"><span>    msr  scr_el3, x0
</span></span><span style="display:flex;"><span>    msr  cptr_el3, xzr           <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef COUNTER_FREQUENCY
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>COUNTER_FREQUENCY
</span></span><span style="display:flex;"><span>    msr  cntfrq_el0, x0          <span style="color:#75715e">/* åˆå§‹åŒ–å¯„å­˜å™¨CNTFRQ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    <span style="color:#ae81ff">0f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>  msr   vbar_el2, x0   		<span style="color:#75715e">// å¼‚å¸¸çº§åˆ«2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x33ff</span>
</span></span><span style="display:flex;"><span>    msr  cptr_el2, x0            <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */</span>
</span></span><span style="display:flex;"><span>    b    <span style="color:#ae81ff">0f</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>  msr    vbar_el1, x0
</span></span><span style="display:flex;"><span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">3</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>    msr  cpacr_el1, x0           <span style="color:#75715e">/* å¯ç”¨æµ®ç‚¹å’ŒSIMDåŠŸèƒ½ */</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* åº”ç”¨ARMå¤„ç†å™¨ç‰¹å®šçš„å‹˜è¯¯è¡¨*/</span>
</span></span><span style="display:flex;"><span>bl   apply_core_errata
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* å¤„ç†å™¨ç‰¹å®šçš„åˆå§‹åŒ–*/</span>
</span></span><span style="display:flex;"><span>bl   lowlevel_init    <span style="color:#75715e">// æ‰§è¡Œboard_init_f()æ‰€éœ€æœ€å°åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_ARMV8_SPIN_TABLE) &amp;&amp; !defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    branch_if_master x0, x1, master_cpu
</span></span><span style="display:flex;"><span>    b    spin_table_secondary_jump    <span style="color:#75715e">// arch/arm/cpu/armv8/spin_tabli.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">/* ç»å¯¹ä¸ä¼šè¿”å›*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#elif defined(CONFIG_ARMV8_MULTIENTRY)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>branch_if_master x0, x1, master_cpu
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">* ä»å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>slave_cpu:
</span></span><span style="display:flex;"><span>    wfe
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä»å¤„ç†å™¨è¿›å…¥ä½åŠŸè€—çŠ¶æ€ï¼Œå®ƒè¢«å”¤é†’çš„æ—¶å€™ï¼Œä»åœ°å€CPU_RELEASE_ADDRè¯»å–å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x1, <span style="color:#f92672">=</span>CPU_RELEASE_ADDR 
</span></span><span style="display:flex;"><span>    ldr  x0, [x1]
</span></span><span style="display:flex;"><span>    cbz  x0, slave_cpu
</span></span><span style="display:flex;"><span>    br   x0               <span style="color:#75715e">/* è·³è½¬åˆ°æŒ‡å®šåœ°å€*/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_ARMV8_MULTIENTRY */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>master_cpu:
</span></span><span style="display:flex;"><span>    bl   _main  <span style="color:#75715e">// ä¸»å¤„ç†å™¨æ‰§è¡Œå‡½æ•°
</span></span></span></code></pre></div><p>â€ƒU-Bootåˆ†ä¸ºSPLå’Œæ­£å¸¸çš„U-Bootç¨‹åºä¸¤ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæƒ³è¦ç¼–è¯‘ä¸ºSPLï¼Œéœ€è¦å¼€å¯é…ç½®å®CONFIG_SPL_BUILDã€‚SPLæ˜¯â€œSecondary Program Loaderâ€çš„ç®€ç§°ï¼Œå³ç¬¬äºŒé˜¶æ®µç¨‹åºåŠ è½½å™¨ï¼Œç¬¬äºŒé˜¶æ®µæ˜¯ç›¸å¯¹äºå¤„ç†å™¨é‡Œé¢çš„åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åºæ¥è¯´çš„ï¼Œå¤„ç†å™¨å¯åŠ¨æ—¶æœ€å…ˆæ‰§è¡Œçš„æ˜¯åªè¯»å­˜å‚¨å™¨ä¸­çš„å›ºåŒ–ç¨‹åº</p>
<h3 id="113-å‡½æ•°_main">1.1.3 å‡½æ•°_main<a hidden class="anchor" aria-hidden="true" href="#113-å‡½æ•°_main">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm/lib/crt0_64.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ENTRY</span>(_main)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è®¾ç½®åˆå§‹çš„Cè¯­è¨€è¿è¡Œç¯å¢ƒï¼Œå¹¶ä¸”è°ƒç”¨board_init_f(0)ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#if defined(CONFIG_SPL_BUILD) &amp;&amp; defined(CONFIG_SPL_STACK 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>(CONFIG_SPL_STACK)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>(CONFIG_SYS_INIT_SP_ADDR)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bic  sp, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>   <span style="color:#75715e">/* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚*/</span>
</span></span><span style="display:flex;"><span>    mov  x0, sp
</span></span><span style="display:flex;"><span>    bl   board_init_f_alloc_reserve <span style="color:#75715e">// åœ¨æ ˆçš„é¡¶éƒ¨ä¸ºç»“æ„ä½“global_dataåˆ†é…ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  sp, x0
</span></span><span style="display:flex;"><span>    mov  x18, x0  <span style="color:#75715e">/* è®¾ç½®gd */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å‡½æ•°board_init_f_init_reserveï¼Œåˆå§‹åŒ–ç»“æ„ä½“global_data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   board_init_f_init_reserve  
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    mov  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    bl   board_init_f <span style="color:#75715e">// common/board_f.c æ‰§è¡Œæ•°ç»„init_sequence_fä¸­çš„æ¯ä¸ªå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if !defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">// è®¾ç½®ä¸­é—´ç¯å¢ƒï¼ˆæ–°çš„æ ˆæŒ‡é’ˆå’Œgdï¼‰ï¼Œç„¶åè°ƒç”¨å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">// relocate_code(addr_moni)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_START_ADDR_SP]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-&gt;start_addr_sp */</span>
</span></span><span style="display:flex;"><span>    bic  sp, x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0xf</span>             <span style="color:#75715e">/* ä¸ºäº†ç¬¦åˆåº”ç”¨äºŒè¿›åˆ¶æ¥å£è§„èŒƒï¼Œå¯¹é½åˆ°16å­—èŠ‚ */</span>
</span></span><span style="display:flex;"><span>    ldr  x18, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_BD]       <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x18è®¾ç½®ä¸ºgd-&gt;bd */</span>
</span></span><span style="display:flex;"><span>    sub  x18, x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_SIZE       <span style="color:#75715e">/* æ–°çš„gdåœ¨bdçš„ä¸‹é¢ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    adr  lr, relocation_return
</span></span><span style="display:flex;"><span>    ldr  x9, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOC_OFF]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x9è®¾ç½®ä¸ºgd-&gt;reloc_off */</span>
</span></span><span style="display:flex;"><span>    add  lr, lr, x9    <span style="color:#75715e">/* åœ¨é‡å®šä½åæ–°çš„è¿”å›åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    ldr  x0, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOCADDR]    <span style="color:#75715e">/* æŠŠå¯„å­˜å™¨x0è®¾ç½®ä¸ºgd-&gt;relocaddr */</span>
</span></span><span style="display:flex;"><span>    b    relocate_code
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>relocation_return:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è®¾ç½®æœ€ç»ˆçš„å®Œæ•´ç¯å¢ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#75715e">/* ä»ç„¶è°ƒç”¨æ—§çš„ä¾‹ç¨‹ æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€*/</span>
</span></span><span style="display:flex;"><span>    bl   c_runtime_cpu_setup  
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* !CONFIG_SPL_BUILD */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_SPL_BUILD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   spl_relocate_stack_gd    <span style="color:#75715e">/* å¯èƒ½è¿”å›ç©ºæŒ‡é’ˆ é‡æ–°å®šä½æ ˆ*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ‰§è¡Œâ€œsp = (x0 != NULL) ? x0 : spâ€ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// è§„é¿è¿™ä¸ªçº¦æŸï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¸¦æ¡ä»¶çš„movæŒ‡ä»¤ä¸èƒ½æŠŠæ ˆæŒ‡é’ˆå¯„å­˜å™¨ä½œä¸ºæ“ä½œæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mov  x1, sp
</span></span><span style="display:flex;"><span>    cmp  x0, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    csel x0, x0, x1, ne
</span></span><span style="display:flex;"><span>    mov  sp, x0
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”¨0åˆå§‹åŒ–æœªåˆå§‹åŒ–æ•°æ®æ®µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ldr  x0, <span style="color:#f92672">=</span>__bss_start      <span style="color:#75715e">/* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/</span>
</span></span><span style="display:flex;"><span>    ldr  x1, <span style="color:#f92672">=</span>__bss_end        <span style="color:#75715e">/* è¿™æ˜¯è‡ªåŠ¨é‡å®šä½*/</span>
</span></span><span style="display:flex;"><span>clear_loop:
</span></span><span style="display:flex;"><span>    str  xzr, [x0], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>    cmp  x0, x1
</span></span><span style="display:flex;"><span>    b.lo clear_loop
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* è°ƒç”¨å‡½æ•°board_init_r(gd_t *id, ulong dest_addr) */</span>
</span></span><span style="display:flex;"><span>    mov  x0, x18                     <span style="color:#75715e">/* gd_t */</span>
</span></span><span style="display:flex;"><span>    ldr  x1, [x18, <span style="color:#960050;background-color:#1e0010">#</span>GD_RELOCADDR]    <span style="color:#75715e">/* dest_addr */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* ç›¸å¯¹ç¨‹åºè®¡æ•°å™¨çš„è·³è½¬ common/board_r.c æ‰§è¡Œæ•°ç»„init_sequence_rä¸­çš„æ¯ä¸ªå‡½æ•°ï¼Œæœ€åä¸€ä¸ªå‡½æ•°æ˜¯run_main_loop */</span>
</span></span><span style="display:flex;"><span>    b    board_init_r   
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span> <span style="color:#75715e">/* ä¸ä¼šè¿è¡Œåˆ°è¿™é‡Œï¼Œå› ä¸ºå‡½æ•°board_init_r()ä¸ä¼šè¿”å›*/</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENDPROC</span>(_main)
</span></span></code></pre></div><h3 id="114-å‡½æ•°run_main_loop">1.1.4 å‡½æ•°run_main_loop<a hidden class="anchor" aria-hidden="true" href="#114-å‡½æ•°run_main_loop">#</a></h3>
<p>â€ƒæ•°ç»„<code>init_sequence_r</code>æœ€åä¸€ä¸ªå‡½æ•°<code>run_main_loop</code>ï¼Œå‡½æ•°æ‰§è¡Œæµç¨‹ï¼›</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>run_main_loop
</span></span><span style="display:flex;"><span>    main_loop
</span></span><span style="display:flex;"><span>        bootdely_process <span style="color:#75715e"># è¯»å–ç¯å¢ƒå˜é‡bootdelay(å»¶è¿Ÿæ—¶é—´)å’Œbootcmd(ç¯å¢ƒå˜é‡)</span>
</span></span><span style="display:flex;"><span>        autoboot_command
</span></span><span style="display:flex;"><span>            abortboot    <span style="color:#75715e"># ç­‰å¾…ç”¨æˆ·æŒ‰é”®</span>
</span></span><span style="display:flex;"><span>            run_command_list  <span style="color:#75715e"># æœªç­‰å¾…åˆ°æŒ‰é”®ï¼Œè‡ªåŠ¨æ‰§è¡Œç¯å¢ƒå˜é‡bootcmd</span>
</span></span></code></pre></div><p>â€ƒ<code>bootm</code>å‘½ä»¤å¤„ç†å‡½æ•°<code>do_bootm</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>do_bootm
</span></span><span style="display:flex;"><span>    do_bootm_states
</span></span><span style="display:flex;"><span>        bootm_start   <span style="color:#75715e"># åˆå§‹åŒ–å…¨å±€å˜é‡bootm_header_timages</span>
</span></span><span style="display:flex;"><span>        bootm_find_os    <span style="color:#75715e"># æŠŠå†…æ ¸é•œåƒä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜</span>
</span></span><span style="display:flex;"><span>        bootm_find_other    <span style="color:#75715e"># ARM64 æ‰å¹³è®¾å¤‡æ ‘(Flattended Device Tree FDT)äºŒè¿›åˆ¶æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        bootm_load_os  <span style="color:#75715e"># è§£å‹ç—…åŠ è½½å†…æ ¸åˆ°æ­£ç¡®ä½ç½®</span>
</span></span><span style="display:flex;"><span>        bootm_os_get_boot_func  <span style="color:#75715e"># åœ¨æ“ä½œç³»ç»Ÿç±»å‹æ•°ç»„boot_osä¸­æŸ¥æ‰¾å¼•å¯¼å‡½æ•°ï¼Œlinuxå†…æ ¸å¼•å¯¼å‡½æ•°do_bootm_linux</span>
</span></span><span style="display:flex;"><span>        do_bootm_linux<span style="color:#f92672">(</span>flag<span style="color:#f92672">=</span>BOOTM_STATE_OS_PREP<span style="color:#f92672">)</span>  <span style="color:#75715e"># è°ƒç”¨boot_prep_linux</span>
</span></span><span style="display:flex;"><span>            boot_prep_linux  <span style="color:#75715e"># 1.åˆ†é…ä¸€å—å†…å­˜ï¼ŒæŠŠè®¾å¤‡æ•°äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶ 2.ä¿®æ”¹æ‰å¹³è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶</span>
</span></span><span style="display:flex;"><span>        boot_selected_os  <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>            do_bootm_linux<span style="color:#f92672">(</span>flag<span style="color:#f92672">=</span>BOOTM_STATE_OS_GO<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                boot_jump_linux  <span style="color:#75715e"># è´Ÿè´£è·³è½¬åˆ°Linuxå†…æ ¸</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>boot_jum_linux
</span></span><span style="display:flex;"><span>    do_nonsec_virt_switch
</span></span><span style="display:flex;"><span>        smp_kick_all_cpus  <span style="color:#75715e"># CONFIG_GICV2æˆ–CONFIG_GICV3ï¼Œä¸­æ–­æ§åˆ¶å™¨ç‰ˆæœ¬2ï¼Œ3</span>
</span></span><span style="display:flex;"><span>        dcache_disable  <span style="color:#75715e"># ç¦ç”¨å¤„ç†å™¨çš„ç¼“å­˜å’Œå†…å­˜ç®¡ç†å•å…ƒ</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ # å¼€å¯é…ç½®å® CONFIG_ARMV8_SWITCH_TO_EL1</span>
</span></span><span style="display:flex;"><span>    armv8_switch_to_el2
</span></span><span style="display:flex;"><span>        switch_to_el1
</span></span><span style="display:flex;"><span>            armv8_switch_to_el1
</span></span><span style="display:flex;"><span>                å†…æ ¸å…¥å£
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># åœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸</span>
</span></span><span style="display:flex;"><span>    armv8_switch_to_el2
</span></span><span style="display:flex;"><span>        å†…æ ¸å…¥å£
</span></span></code></pre></div><h2 id="12-å†…æ ¸åˆå§‹åŒ–">1.2 å†…æ ¸åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#12-å†…æ ¸åˆå§‹åŒ–">#</a></h2>
<p>â€ƒå†…æ ¸åˆå§‹åŒ–åˆ†ä¸ºæ±‡ç¼–è¯­è¨€éƒ¨åˆ†å’ŒCè¯­è¨€éƒ¨åˆ†</p>
<h3 id="121-æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">1.2.1 æ±‡ç¼–è¯­è¨€éƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#121-æ±‡ç¼–è¯­è¨€éƒ¨åˆ†">#</a></h3>
<p>â€ƒARM64æ¶æ„å†…æ ¸å…¥å£<code>_head</code>ï¼Œç›´æ¥è·³è½¬åˆ°æ ‡å·<code>stext</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>_head:
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_EFI   </span><span style="color:#75715e">// æä¾›UEFIè¿è¡Œæ—¶æ”¯æŒUEFIï¼ˆUnified Extensible Firmware Interfaceï¼‰æ˜¯ç»Ÿä¸€çš„å¯æ‰©å±•å›ºä»¶æ¥å£ï¼Œç”¨äºå–ä»£BIOS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    add  x13, x18, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0x16</span>
</span></span><span style="display:flex;"><span>    b    stext
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    stext       <span style="color:#75715e">// è·³è½¬åˆ°å†…æ ¸èµ·å§‹ä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .long0           <span style="color:#75715e">// ä¿ç•™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>â€‚<code>stext</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ENTRY</span>(stext)
</span></span><span style="display:flex;"><span>    bl   preserve_boot_args  <span style="color:#75715e">// æŠŠå¼•å¯¼ç¨‹åºä¼ é€’çš„4ä¸ªå‚æ•°ä¿å­˜åœ¨å…¨å±€æ•°ç»„boot_argsä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   el2_setup        <span style="color:#75715e">// é™çº§åˆ°å¼‚å¸¸çº§åˆ«1, å¯„å­˜å™¨w0å­˜æ”¾cpu_boot_mode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    adrp x23, __PHYS_OFFSET
</span></span><span style="display:flex;"><span>    and  x23, x23, MIN_KIMG_ALIGN <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>    <span style="color:#75715e">// KASLRåç§»ï¼Œé»˜è®¤å€¼æ˜¯0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   set_cpu_boot_mode_flag  <span style="color:#75715e">// __boot_cpu_mode[2] æ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    bl   __create_page_tables  <span style="color:#75715e">// åˆ›å»ºé¡µè¡¨æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ä¸‹é¢è°ƒç”¨è®¾ç½®å¤„ç†å™¨çš„ä»£ç ï¼Œè¯·çœ‹æ–‡ä»¶â€œarch/arm64/mm/proc.Sâ€ äº†è§£ç»†èŠ‚ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨å·²ç»ä¸ºå¼€å¯å†…å­˜ç®¡ç†å•å…ƒåšå¥½å‡†å¤‡ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * è½¬æ¢æ§åˆ¶å¯„å­˜å™¨å·²ç»è®¾ç½®å¥½ã€‚*/</span>
</span></span><span style="display:flex;"><span>    bl    __cpu_setup        <span style="color:#75715e">// åˆå§‹åŒ–å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    b    __primary_switch  <span style="color:#75715e">// ä¸»å¤„ç†å™¨å¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼Œè¿›å…¥Cè¯­è¨€éƒ¨åˆ†å…¥å£å‡½æ•°start_kernel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ENDPROC</span>(stext)
</span></span></code></pre></div><br>
<ol>
<li>å‡½æ•°el2_setup</li>
</ol>
<blockquote>
<p>a.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯1ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸ã€‚   <br>
b.å¦‚æœå¼‚å¸¸çº§åˆ«æ˜¯2ï¼Œé‚£ä¹ˆæ ¹æ®å¤„ç†å™¨æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼ˆVirtualization Host Extensionsï¼ŒVHEï¼‰ï¼Œå†³å®šæ˜¯å¦éœ€è¦é™çº§åˆ°å¼‚å¸¸çº§åˆ«1ã€‚    <br>
1ï¼‰å¦‚æœå¤„ç†å™¨æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå†…æ ¸ã€‚    \<br>
2ï¼‰å¦‚æœå¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œé‚£ä¹ˆé™çº§åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1æ‰§è¡Œå†…æ ¸      \</p>
</blockquote>
<p>â€ƒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœºï¼ˆKernel-based Virtual Machineï¼ŒKVMï¼‰ï¼ŒKVMçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œå› æ­¤è™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚       <br>
â€ƒå¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒKVMè™šæ‹Ÿæœºã€‚QEMUåˆ›å»ºä¸€ä¸ªKVMè™šæ‹Ÿæœºï¼Œå’ŒKVMçš„äº¤äº’è¿‡ç¨‹           \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ‰“å¼€KVMå­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/dev/kvm&#34;</span>, O_RDWR);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿæœºçš„æ–‡ä»¶æè¿°ç¬¦ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vmfd <span style="color:#f92672">=</span> <span style="color:#a6e22e">ioctl</span>(fd, KVM_CREATE_VM, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// KVMä¸ºæ¯ä¸ªè™šæ‹Ÿå¤„ç†å™¨åˆ›å»ºä¸€ä¸ªkvm_vcpuç»“æ„ä½“ï¼ŒQEMUè¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå…³è”åˆ°è™šæ‹Ÿå¤„ç†å™¨çš„æ–‡ä»¶æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>vcpu_fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">ioctl</span>(vmfd, KVM_CREATE_VCPU, <span style="color:#ae81ff">0</span>);
</span></span></code></pre></div><p>â€ƒä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è¿‡ç¨‹å¦‚ä¸‹ã€‚      <br>
â€ƒï¼ˆ1ï¼‰QEMUè¿›ç¨‹è°ƒç”¨â€œioctl(vcpu_fd, KVM_RUN, 0)â€ï¼Œé™·å…¥åˆ°å†…æ ¸ã€‚     <br>
â€ƒï¼ˆ2ï¼‰KVMæ‰§è¡Œå‘½ä»¤KVM_RUNï¼Œä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚           <br>
â€ƒï¼ˆ3ï¼‰KVMé¦–å…ˆæŠŠè°ƒç”¨è¿›ç¨‹çš„æ‰€æœ‰å¯„å­˜å™¨ä¿å­˜åœ¨kvm_vcpuç»“æ„ä½“ä¸­ï¼Œç„¶åæŠŠæ‰€æœ‰å¯„å­˜å™¨è®¾ç½®ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿçš„å¯„å­˜å™¨å€¼ï¼Œæœ€åä»å¼‚å¸¸çº§åˆ«2è¿”å›åˆ°å¼‚å¸¸çº§åˆ«1ï¼Œæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿã€‚           <br>
â€ƒä¸ºäº†æé«˜åˆ‡æ¢é€Ÿåº¦ï¼Œ<code>ARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸</code>ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦å…ˆä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2      \</p>
<br>
<ol start="2">
<li>å‡½æ•°__create_page_tables</li>
</ol>
<blockquote>
<p>1ï¼‰åˆ›å»ºæ’ç­‰æ˜ å°„ï¼Œè™šæ‹Ÿåœ°å€=ç‰©ç†åœ°å€<code>__enable_mmu</code>å¼€å¯å†…å­˜ç®¡ç†å•å…ƒ        <br>
2ï¼‰ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„             \</p>
</blockquote>
<p>â€ƒæ˜ å°„ä»£ç èŠ‚<code>.idmap.text</code>,æ’ç­‰æ˜ å°„ä»£ç èŠ‚çš„èµ·å§‹åœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_startä¸­ï¼Œç»“æŸåœ°å€å­˜æ”¾åœ¨å…¨å±€å˜é‡__idmap_text_endä¸­ã€‚æ’ç­‰æ˜ å°„æ˜¯ä¸ºæ’ç­‰æ˜ å°„ä»£ç èŠ‚åˆ›å»ºçš„æ˜ å°„ï¼Œidmap_pg_diræ˜¯æ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•ï¼ˆå³ç¬¬ä¸€çº§é¡µè¡¨ï¼‰çš„èµ·å§‹åœ°å€ã€‚å†…æ ¸çš„é¡µè¡¨ä¸­ä¸ºå†…æ ¸é•œåƒåˆ›å»ºæ˜ å°„ï¼Œå†…æ ¸é•œåƒçš„èµ·å§‹åœ°å€æ˜¯_textï¼Œç»“æŸåœ°å€æ˜¯_endï¼Œswapper_pg_diræ˜¯å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹åœ°å€</p>
<br>
<ol start="3">
<li>å‡½æ•°__primary_switch</li>
</ol>
<blockquote>
<p>1ï¼‰__enable_mmuå¼€å¯å†…å­˜ç®¡ç†å•å…ƒ            <br>
2ï¼‰__primary_switched      <br>
â€‚__enable_mmuæ‰§è¡Œæµç¨‹     <br>
â€ƒ1ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨0(TTBR0_EL1)è®¾ç½®ä¸ºæ’ç­‰æ˜ å°„çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€     <br>
â€ƒ2ï¼‰æŠŠè½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨1(TTBR1_EL1)è®¾ç½®ä¸ºå†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„èµ·å§‹ç‰©ç†åœ°å€        <br>
â€ƒ3ï¼‰è®¾ç½®ç³»ç»Ÿæ§åˆ¶å¯„å­˜å™¨(SCTLR_EL1)ï¼Œå¼€å¯å†…å­˜ç®¡ç†å•å…ƒï¼ŒåMMUæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€    <br>
â€‚__primary_switchæ‰§è¡Œæµç¨‹      <br>
â€ƒ1ï¼‰æŠŠå½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨è®¾ç½®ä¸º0å·çº¿ç¨‹å†…æ ¸æ ˆçš„é¡¶éƒ¨(init_thread_union + THREAD_SIZE)           <br>
â€ƒ2ï¼‰æŠŠå¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨(SP_EL0)è®¾ç½®ä¸º0å·çº¿ç¨‹çš„ç»“æ„ä½“<code>thread_info</code>çš„åœ°å€(init_task.thread_info)        <br>
â€ƒ3ï¼‰æŠŠå‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(VBAR_EL1)è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹åœ°å€(vectors)     <br>
â€ƒ4ï¼‰è®¡ç®—å†…æ ¸é•œåƒçš„èµ·å§‹è™šæ‹Ÿåœ°å€(kimage_vaddr)å’Œç‰©ç†åœ°å€çš„å·®å€¼ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡kimage_voffsetä¸­     <br>
â€ƒ5ï¼‰ç”¨0åˆå§‹åŒ–å†…æ ¸çš„æœªåˆå§‹åŒ–æ•°æ®æ®µ      <br>
â€ƒ6ï¼‰è°ƒç”¨Cè¯­è¨€å‡½æ•°<code>start_kernel</code>      \</p>
</blockquote>
<br>
<h3 id="122-cè¯­è¨€éƒ¨åˆ†">1.2.2 Cè¯­è¨€éƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#122-cè¯­è¨€éƒ¨åˆ†">#</a></h3>
<p>â€ƒå†…æ ¸åˆå§‹åŒ–çš„Cè¯­è¨€éƒ¨åˆ†å…¥å£æ˜¯å‡½æ•°<code>start_kernel</code>ï¼Œå‡½æ•°start_kernelé¦–å…ˆåˆå§‹åŒ–åŸºç¡€è®¾æ–½ï¼Œå³åˆå§‹åŒ–å†…æ ¸çš„å„ä¸ªå­ç³»ç»Ÿï¼Œç„¶åè°ƒç”¨å‡½æ•°<code>rest_init</code>ã€‚å‡½æ•°rest_initçš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ã€‚   <br>
â€‚ï¼ˆ1ï¼‰åˆ›å»º1å·çº¿ç¨‹ï¼Œå³initçº¿ç¨‹ï¼Œçº¿ç¨‹å‡½æ•°æ˜¯kernel_initã€‚     <br>
â€‚ï¼ˆ2ï¼‰åˆ›å»º2å·çº¿ç¨‹ï¼Œå³kthreaddçº¿ç¨‹ï¼Œè´Ÿè´£åˆ›å»ºå†…æ ¸çº¿ç¨‹ã€‚     <br>
â€‚ï¼ˆ3ï¼‰0å·çº¿ç¨‹æœ€ç»ˆå˜æˆç©ºé—²çº¿ç¨‹ã€‚    \</p>
<p>initçº¿ç¨‹ç»§ç»­åˆå§‹åŒ–ï¼Œæ‰§è¡Œçš„ä¸»è¦æ“ä½œå¦‚ä¸‹ã€‚    <br>
â€‚ï¼ˆ1ï¼‰smp_prepare_cpus()ï¼šåœ¨å¯åŠ¨ä»å¤„ç†å™¨ä»¥å‰æ‰§è¡Œå‡†å¤‡å·¥ä½œã€‚   <br>
â€‚ï¼ˆ2ï¼‰do_pre_smp_initcalls()ï¼šæ‰§è¡Œå¿…é¡»åœ¨åˆå§‹åŒ–SMPç³»ç»Ÿä»¥å‰æ‰§è¡Œçš„æ—©æœŸåˆå§‹åŒ–ï¼Œå³ä½¿ç”¨å®early_initcallæ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ã€‚   <br>
â€‚ï¼ˆ3ï¼‰smp_init()ï¼šåˆå§‹åŒ–SMPç³»ç»Ÿï¼Œå¯åŠ¨æ‰€æœ‰ä»å¤„ç†å™¨ã€‚   <br>
â€‚ï¼ˆ4ï¼‰do_initcalls()ï¼šæ‰§è¡Œçº§åˆ«0ï½7çš„åˆå§‹åŒ–ã€‚ <br>
â€‚ï¼ˆ5ï¼‰æ‰“å¼€æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶â€œ/dev/consoleâ€ï¼Œæ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2åˆ†åˆ«æ˜¯æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ï¼Œéƒ½æ˜¯æ§åˆ¶å°çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶ã€‚   <br>
â€ƒï¼ˆ6ï¼‰prepare_namespace()ï¼šæŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåé¢è£…è½½initç¨‹åºæ—¶éœ€è¦ä»å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¯»æ–‡ä»¶ã€‚   <br>
â€ƒï¼ˆ7ï¼‰free_initmem()ï¼šé‡Šæ”¾åˆå§‹åŒ–ä»£ç å’Œæ•°æ®å ç”¨çš„å†…å­˜ã€‚   <br>
â€ƒï¼ˆ8ï¼‰è£…è½½initç¨‹åºï¼ˆU-Bootç¨‹åºå¯ä»¥ä¼ é€’å†…æ ¸å‚æ•°â€œinit=â€ä»¥æŒ‡å®šinitç¨‹åºï¼‰ï¼Œä»å†…æ ¸çº¿ç¨‹è½¬æ¢æˆç”¨æˆ·ç©ºé—´çš„initè¿›ç¨‹ã€‚  \</p>
<p>â€‚çº§åˆ«0ï½7çš„åˆå§‹åŒ–ï¼Œæ˜¯æŒ‡ä½¿ç”¨ä»¥ä¸‹å®æ³¨å†Œçš„åˆå§‹åŒ–å‡½æ•°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/init.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define pure_initcall(fn)           __define_initcall(fn, 0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define core_initcall(fn)           __define_initcall(fn, 1)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define core_initcall_sync(fn)      __define_initcall(fn, 1s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define postcore_initcall(fn)       __define_initcall(fn, 2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define postcore_initcall_sync(fn)  __define_initcall(fn, 2s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_initcall(fn)           __define_initcall(fn, 3)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_initcall_sync(fn)      __define_initcall(fn, 3s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define subsys_initcall(fn)         __define_initcall(fn, 4)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define subsys_initcall_sync(fn)    __define_initcall(fn, 4s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define fs_initcall(fn)             __define_initcall(fn, 5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define fs_initcall_sync(fn)        __define_initcall(fn, 5s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define rootfs_initcall(fn)         __define_initcall(fn, rootfs)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define device_initcall(fn)         __define_initcall(fn, 6)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define device_initcall_sync(fn)    __define_initcall(fn, 6s)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define late_initcall(fn)           __define_initcall(fn, 7)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define late_initcall_sync(fn)      __define_initcall(fn, 7s)
</span></span></span></code></pre></div><h3 id="123-smpç³»ç»Ÿçš„å¼•å¯¼">1.2.3 SMPç³»ç»Ÿçš„å¼•å¯¼<a hidden class="anchor" aria-hidden="true" href="#123-smpç³»ç»Ÿçš„å¼•å¯¼">#</a></h3>
<p>â€‚å¯¹ç§°å¤šå¤„ç†å™¨(Symmetirc Multi-Processor SMP)       <br>
â€ƒ3ç§å¼•å¯¼ä»å¤„ç†å™¨æ–¹æ³•      \</p>
<ul>
<li>è‡ªæ—‹è¡¨</li>
<li>ç”µæºçŠ¶æ€åè°ƒæ¥å£</li>
<li>ACPIåœè½¦åè®®</li>
</ul>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/ARM64_SMP_spin_table.png" alt="ARM64æ¶æ„ä¸‹SMPç³»ç»Ÿçš„è‡ªæ—‹è¡¨å¼•å¯¼è¿‡ç¨‹"  />
</p>
<h2 id="13-initè¿›ç¨‹">1.3 initè¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#13-initè¿›ç¨‹">#</a></h2>
<p>â€ƒinitè¿›ç¨‹æ˜¯ç”¨æˆ·ç©ºé—´ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨ç”¨æˆ·ç¨‹åºã€‚Linuxç³»ç»Ÿinitç¨‹åºæœ‰<code>sysvinit</code>ã€busybox initã€upstartã€<code>systemd</code>å’Œprocdã€‚sysvinitæ˜¯Unixç³»ç»Ÿ5(System V)initç¨‹åºï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶<code>/etc/initab</code></p>
<br>
<h1 id="ç¬¬2ç« -è¿›ç¨‹ç®¡ç†">ç¬¬2ç«  è¿›ç¨‹ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬2ç« -è¿›ç¨‹ç®¡ç†">#</a></h1>
<h2 id="21-è¿›ç¨‹">2.1 è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#21-è¿›ç¨‹">#</a></h2>
<p>â€ƒLinuxå†…æ ¸æŠŠè¿›ç¨‹ç§°ä¸ºtaskï¼Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†ä¸ºç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ï¼Œæ‰€æœ‰è¿›ç¨‹å…±äº«å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´       <br>
â€ƒè¿›ç¨‹æœ‰ä¸¤ç§ç‰¹æ®Šå½¢å¼ï¼šæ²¡æœ‰ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºå†…æ ¸çº¿ç¨‹ï¼Œå…±äº«ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„è¿›ç¨‹ç§°ä¸ºç”¨æˆ·çº¿ç¨‹ã€‚     <br>
â€ƒtask_structç»“æ„ä½“æ˜¯è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸»è¦æˆå‘˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> state;    <span style="color:#75715e">// è¿›ç¨‹çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>stack;            <span style="color:#75715e">// æŒ‡å‘å†…æ ¸æ ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pid_t</span> pid;              <span style="color:#75715e">// å…¨å±€è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pid_t</span> tgid              <span style="color:#75715e">// å…¨å±€çš„çº¿ç¨‹ç»„æ ‡è¯†ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> pid_link pid[PIDTYPE_MAX];   <span style="color:#75715e">// è¿›ç¨‹å·ï¼Œè¿›ç¨‹ç»„æ ‡è¯†ç¬¦å’Œä¼šè¯æ ‡è¯†ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct _rcu <span style="color:#f92672">*</span>real_parent;   <span style="color:#75715e">// real_parentæŒ‡å‘çœŸå®çš„çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct _rcu <span style="color:#f92672">*</span>parent;        <span style="color:#75715e">// parentæŒ‡å‘çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>group_leader;   <span style="color:#75715e">// æŒ‡å‘è¿›æ‘ç»„çš„ç»„é•¿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> cred _rcu <span style="color:#f92672">*</span>real_cred;  <span style="color:#75715e">// real_credæŒ‡å‘ä¸»é¢˜å’ŒçœŸå®å®¢ä½“è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> cred _rcu <span style="color:#f92672">*</span>cred;       <span style="color:#75715e">// credæŒ‡å‘å®¢ä½“è¯ä¹¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> comm[TASK_COMM_LEN];           <span style="color:#75715e">// è¿›ç¨‹å
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> prio, static_prio, nornal_prio; <span style="color:#75715e">// è°ƒåº¦ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> rt_priority,prolicy<span style="color:#960050;background-color:#1e0010">ï¼›</span>  <span style="color:#75715e">// ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">cpumask_t</span> cpus_allowed;             <span style="color:#75715e">// å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šè¿è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#f92672">*</span>active_mm;   <span style="color:#75715e">// æŒ‡å‘å†…å­˜æè¿°ç¬¦ï¼Œè¿›ç¨‹mmï¼Œå’Œactive_mmæŒ‡å‘åŒä¸€ä¸ªå†…å­˜æè¿°ç¬¦ï¼Œå†…æ ¸çº¿ç¨‹mmæ˜¯æŒ‡é’ˆï¼Œå½“å†…æ ¸çº¿ç¨‹è¿è¡Œæ—¶active_mmæŒ‡å‘ä»è¿›ç¨‹å€Ÿç”¨çš„å†…å­˜æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> file_struct <span style="color:#f92672">*</span>files;          <span style="color:#75715e">// æ‰“å¼€æ–‡ä»¶è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>nsproxy;            <span style="color:#75715e">// å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> signal_struct <span style="color:#f92672">*</span>signal;       <span style="color:#75715e">// ä¿¡å·å¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sigband_struct <span style="color:#f92672">*</span>sighand;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">sigset_t</span> blocked, real_blocked;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">sigset_t</span> saved_sigmask;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sigpending pending;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sysv_sem sysvsem;            <span style="color:#75715e">// UNIxç³»ç»Ÿ5ä¿¡å·é‡å’Œå…±äº«å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sysv_shm sysvshm;
</span></span></code></pre></div><h2 id="22-å‘½åç©ºé—´">2.2 å‘½åç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#22-å‘½åç©ºé—´">#</a></h2>
<p>â€ƒå’Œè™šæ‹Ÿæœºç›¸æ¯”ï¼Œå®¹å™¨æ˜¯ä¸€ç§è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„å†…æ ¸ï¼Œä½¿ç”¨å‘½åç©ºé—´éš”ç¦»èµ„æº,å®¹å™¨ä»…ä»…æ˜¯é€šè¿‡å‘½åç©ºé—´éš”ç¦»ï¼Ÿ  \</p>
<table>
<thead>
<tr>
<th>å‘½åç©ºé—´</th>
<th>éš”ç¦»èµ„æº</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>æ§åˆ¶ç»„cgroup</td>
<td>æ§åˆ¶ç»„æ ¹ç›®å½•</td>
<td></td>
</tr>
<tr>
<td>è¿›ç¨‹é—´é€šä¿¡IPC</td>
<td>UNIXç³»ç»Ÿ5è¿›ç¨‹é—´é€šä¿¡å’ŒPOSIxæ¶ˆæ¯é˜Ÿåˆ—</td>
<td></td>
</tr>
<tr>
<td>network</td>
<td>ç½‘ç»œåè®®</td>
<td></td>
</tr>
<tr>
<td>æŒ‚è½½mount</td>
<td>æŒ‚è½½ç‚¹</td>
<td></td>
</tr>
<tr>
<td>PID</td>
<td>è¿›ç¨‹å·</td>
<td></td>
</tr>
<tr>
<td>user</td>
<td>ç”¨æˆ·æ ‡è¯†ç¬¦å’Œç»„æ ‡è¯†ç¬¦</td>
<td></td>
</tr>
<tr>
<td>UNIXåˆ†æ—¶ç³»ç»Ÿ(UTS)</td>
<td>ä¸»æœºåå’Œç½‘ç»œä¿¡æ¯æœåŠ¡NISåŸŸå</td>
<td></td>
</tr>
</tbody>
</table>
<p>â€‚åˆ›å»ºæ–°çš„å‘½åç©ºé—´æ–¹æ³•ï¼š   <br>
â€ƒè°ƒç”¨cloneåˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œä½¿ç”¨æ ‡å¿—ä½æ§åˆ¶å­è¿›ç¨‹æ˜¯å…±äº«çˆ¶è¿›ç¨‹çš„å‘½åç©ºé—´è¿˜æ˜¯åˆ›å»ºæ–°å‘½åç©ºé—´   <br>
â€ƒè°ƒç”¨unshareåˆ›å»ºæ–°çš„å‘½åç©ºé—´    <br>
â€‚è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setnsï¼Œç»‘å®šä¸€ä¸ªå·²ç»å­˜åœ¨çš„å‘½åç©ºé—´</p>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/process_namespace.png" alt="è¿›ç¨‹çš„å‘½åç©ºé—´"  />
</p>
<p>â€ƒè¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespace,è¿›ç¨‹å·å‘½åç©ºé—´ç”¨æ¥éš”ç¦»è¿›ç¨‹å·ï¼Œå¯¹åº”çš„ç»“æ„ä½“æ˜¯pid_namespaceã€‚</p>
<h2 id="23-è¿›ç¨‹æ ‡è¯†ç¬¦">2.3 è¿›ç¨‹æ ‡è¯†ç¬¦<a hidden class="anchor" aria-hidden="true" href="#23-è¿›ç¨‹æ ‡è¯†ç¬¦">#</a></h2>
<table>
<thead>
<tr>
<th>æ ‡è¯†ç¬¦</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>è¿›ç¨‹æ ‡è¯†ç¬¦</td>
<td>å‘½åç©ºé—´ç»™è¿›ç¨‹åˆ†é…æ ‡è¯†ç¬¦</td>
<td></td>
</tr>
<tr>
<td>çº¿ç¨‹ç»„æ ‡è¯†ç¬¦</td>
<td>çº¿ç¨‹ç»„ä¸­çš„ä¸»è¿›ç¨‹ç§°ä¸ºç»„é•¿ï¼Œçº¿ç¨‹ç»„æ ‡è¯†ç¬¦å°±æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦<br>ç³»ç»Ÿè°ƒç”¨cloneä¼ å…¥æ ‡å¿—CLONE_THREADä»¥åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºä¸€ä¸ªçº¿ç¨‹ç»„</td>
<td></td>
</tr>
<tr>
<td>è¿›ç¨‹ç»„æ ‡è¯†ç¬¦</td>
<td>è¿›ç¨‹ç»„æ ‡è¯†ç¬¦æ˜¯ç»„é•¿çš„è¿›ç¨‹æ ‡è¯†ç¬¦ã€‚<br>è¿›ç¨‹å¯ä»¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨setpgidåˆ›å»ºæˆ–è€…åŠ å…¥ä¸€ä¸ªè¿›ç¨‹ç»„</td>
<td></td>
</tr>
<tr>
<td>ä¼šè¯æ ‡è¯†ç¬¦</td>
<td>è¿›ç¨‹è°ƒç”¨ç³»ç»Ÿè°ƒç”¨setsidçš„æ—¶å€™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ä¼šè¯</td>
<td></td>
</tr>
</tbody>
</table>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/pid_mark.png" alt="è¿›ç¨‹çš„å‘½åç©ºé—´"  />
</p>
<p>â€ƒpidå­˜å‚¨å…¨å±€è¿›ç¨‹å·ï¼Œpids[PIDTYPE_PID].pidæŒ‡å‘ç»“æ„ä½“pidï¼Œpids[PIDTYPE_PGID].pidæŒ‡å‘è¿›ç¨‹ç»„ç»„é•¿çš„ç»“æ„ä½“pidï¼Œpids[PIDTYPE_SIG].pidæŒ‡å‘ä¼šè¯è¿›ç¨‹çš„ç»“æ„ä½“pid    \</p>
<p>â€ƒè¿›ç¨‹æ ‡è¯†ç¬¦ç»“æ„ä½“pidçš„æˆå‘˜ï¼Œcountæ˜¯å¼•ç”¨è®¡æ•°ï¼Œlevelè¿›ç¨‹å·å‘½åç©ºé—´çš„å±‚æ¬¡ï¼Œnumberså…ƒç´ ä¸ªæ•°æ˜¯levelçš„å€¼åŠ 1ï¼Œ</p>
<h2 id="24-è¿›ç¨‹å…³ç³»">2.4 è¿›ç¨‹å…³ç³»<a hidden class="anchor" aria-hidden="true" href="#24-è¿›ç¨‹å…³ç³»">#</a></h2>
<p>â€ƒå¦‚æœå­è¿›ç¨‹è¢«æŸä¸ªè¿›ç¨‹ï¼ˆé€šå¸¸æ˜¯è°ƒè¯•å™¨ï¼‰ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ptraceè·Ÿè¸ªï¼Œé‚£ä¹ˆæˆå‘˜parentæŒ‡å‘è·Ÿè¸ªè€…çš„è¿›ç¨‹æè¿°ç¬¦ï¼Œå¦åˆ™æˆå‘˜parentä¹ŸæŒ‡å‘çˆ¶è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ã€‚</p>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/process_relative.png" alt="è¿›ç¨‹çš„å‘½åç©ºé—´"  />
</p>
<p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/tasks_table.png" alt="è¿›ç¨‹å’Œçº¿ç¨‹é“¾è¡¨"  />
</p>
<h2 id="25-å¯åŠ¨ç¨‹åº">2.5 å¯åŠ¨ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#25-å¯åŠ¨ç¨‹åº">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/* çˆ¶è¿›ç¨‹ç»§ç»­æ‰§è¡Œ */</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å­è¿›ç¨‹è£…è½½ç¨‹åº */</span>
</span></span><span style="display:flex;"><span>    ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">execve</span>(filename, argv, envp);
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">/* åˆ›å»ºå­è¿›ç¨‹å¤±è´¥ */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="251åˆ›å»ºæ–°è¿›ç¨‹">2.5.1ã€€åˆ›å»ºæ–°è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#251åˆ›å»ºæ–°è¿›ç¨‹">#</a></h3>
<p>â€ƒå†…æ ¸ä½¿ç”¨é™æ€æ•°æ®æ„é€ å‡º0å·å†…æ ¸çº¿ç¨‹ï¼Œ0å·å†…æ ¸çº¿ç¨‹åˆ†å‰ç”Ÿæˆ1å·å†…æ ¸çº¿ç¨‹å’Œ2å·å†…æ ¸çº¿ç¨‹ï¼ˆkthreaddçº¿ç¨‹ï¼‰ã€‚1å·å†…æ ¸çº¿ç¨‹å®Œæˆåˆå§‹åŒ–ä»¥åè£…è½½ç”¨æˆ·ç¨‹åºï¼Œå˜æˆ1å·è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯1å·è¿›ç¨‹æˆ–è€…å®ƒçš„å­å­™è¿›ç¨‹åˆ†å‰ç”Ÿæˆçš„ï¼›å…¶ä»–å†…æ ¸çº¿ç¨‹æ˜¯kthreaddçº¿ç¨‹åˆ†å‰ç”Ÿæˆçš„
â€ƒä¸¤ä¸ªä¸ªç³»ç»Ÿè°ƒç”¨åˆ›å»ºè¿›ç¨‹ï¼š    \</p>
<ul>
<li>forkï¼šå­è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹çš„å‰¯æœ¬ï¼Œç”¨å†™æ—¶å¤åˆ¶</li>
<li>cloneï¼šå¯æ§åˆ¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å…±äº«å“ªäº›èµ„æº</li>
<li>vforkï¼šåˆ›å»ºå­è¿›ç¨‹ï¼Œå­è¿›ç¨‹ç”¨execveè£…è½½ç¨‹åº(å·²åºŸå¼ƒ)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ•°å­—è¡¨ç¤ºå‚æ•°ä¸ªæ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">SYSCALL_DEFINE0</span>(fork)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®å±•å¼€ asmlinkageè¡¨ç¤ºCè¯­è¨€å‡½æ•°çœ‹è¢«æ±‡ç¼–ä»£ç è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sys_fork</span>(<span style="color:#66d9ef">void</span>)
</span></span></code></pre></div><p>â€ƒåˆ›å»ºè¿›ç¨‹çš„è¿›ç¨‹på’Œè¢«åˆ›å»ºè¿›ç¨‹cä¸‰ç§å…³ç³»</p>
<ul>
<li>æ–°è¿›ç¨‹æ˜¯è¿›ç¨‹pçš„å­è¿›ç¨‹</li>
<li>cloneä¼ å…¥CLONE_PARENTï¼Œå…„å¼Ÿå…³ç³»</li>
<li>cloneä¼ å…¥CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„</li>
</ul>
<h4 id="1-_do_forkå‡½æ•°">1. _do_forkå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#1-_do_forkå‡½æ•°">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">long</span> <span style="color:#a6e22e">_do_fork</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack_start,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack_size,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> __user <span style="color:#f92672">*</span>parent_tidptr,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> __user <span style="color:#f92672">*</span>child_tidptr,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> tls);  <span style="color:#75715e">// tls åˆ›å»ºçº¿ç¨‹ï¼Œclone_flagsä¸ºCLONE_SETTLSæ—¶ï¼ŒtlstlsæŒ‡å®šæ–°çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€
</span></span></span></code></pre></div><p><img loading="lazy" src="https://liuz0123.gitee.io/zain/img/_do_fork.png" alt="å‡½æ•°_do_forkçš„æ‰§è¡Œæµç¨‹"  />
</p>
<p>â€ƒè°ƒç”¨copy_processåˆ›å»ºæ–°è¿›ç¨‹  <br>
â€ƒclone_flagsè®¾ç½®CLONE_PARENT_SETTIDï¼Œæ–°çº¿ç¨‹çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°å‚æ•°parent_tidptræŒ‡å®šçš„ä½ç½®   <br>
â€ƒwake_up_new_taskå”¤é†’æ–°è¿›ç¨‹</p>
<h4 id="2-copy_processå‡½æ•°">2. copy_processå‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#2-copy_processå‡½æ•°">#</a></h4>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221030190536.png" alt="20221030190536"  />
</p>
<ul>
<li><strong>ï¼ˆ1ï¼‰æ ‡å¿—ç»„åˆ</strong></li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">CLONE_NEWNS &amp; CLONE_FS</td>
<td style="text-align:center">æ–°è¿›ç¨‹å±äºæ–°æŒ‚è½½å‘½åç©ºé—´<br>å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">CLONE_NEWUSER &amp; CLONE_FS</td>
<td style="text-align:center">æ–°è¿›ç¨‹å±äºæ–°ç”¨æˆ·å‘½åç©ºé—´<br>å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">CLONE_THREAD <br> æœªè®¾ç½®CLONE_SIGHAND</td>
<td style="text-align:center">æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œ<br>ä½†ä¸å…±äº«ä¿¡å·å¤„ç†ç¨‹åº</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">CLONE_SIGHAND <br> æœªè®¾ç½®CLONE_VM</td>
<td style="text-align:center">æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·å¤„ç†ç¨‹åºï¼Œ<br>ä½†ä¸å…±äº«è™šæ‹Ÿå†…å­˜</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li><strong>ï¼ˆ2ï¼‰dup_task_structå‡½æ•°</strong>
â€ƒæœªæ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦åˆ†é…å†…å­˜ï¼Œå¤åˆ¶å½“å‰è¿›ç¨‹æè¿°ç¬¦ï¼Œä¸ºæ–°è¿›ç¨‹åˆ†é…å†…æ ¸æ ˆ</li>
</ul>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221030192206.png" alt="20221030192206"  title="è¿›ç¨‹çš„å†…æ ¸æ ˆ"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">union</span> thread_union {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef CONFIG_ARCH_TASK_STRUCT_ON_STACK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> task_struct task;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef CONFIG_THREAD_INFO_IN_TASK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> thread_info thread_info;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack[THREAD_SIZE<span style="color:#f92672">/</span><span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">long</span>)];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚å†…æ ¸æ ˆä¸¤ç§å¸ƒå±€</p>
<ul>
<li>
<ol>
<li>thread_infoåœ¨å†…æ ¸æ ˆé¡¶éƒ¨ï¼Œæˆå‘˜taskæŒ‡å‘è¿›ç¨‹æè¿°ç¬¦</li>
</ol>
</li>
<li>
<ol start="2">
<li>thread_infoæœªå ç”¨å†…æ ¸æ ˆ
â€ƒç¬¬äºŒç§å¸ƒå±€éœ€æ‰“å¼€CONFIG_THREAD_INFO_IN_TASKï¼ŒARM64ä½¿ç”¨ç¬¬äºŒç§å†…æ ¸æ ˆå¸ƒå±€ï¼Œthread_infoç»“æ„ä½“åœ°å€ä¸è¿›ç¨‹æè¿°ç¬¦åœ°å€ç›¸åŒã€‚è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼æ—¶ï¼ŒARM64æ¶æ„çš„å†…æ ¸ä½¿ç”¨ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0å­˜æ”¾å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“åœ°å€ï¼Œå¯åŒæ—¶å¾—åˆ°thread_infoåœ°å€å’Œè¿›ç¨‹æè¿°ç¬¦åœ°å€
â€ƒå†…æ ¸æ ˆçš„é•¿åº¦æ—¶<code>THREAD_SIZE</code>ï¼Œ<strong>ARM64æ¶æ„å†…æ ¸æ ˆé•¿åº¦ä¸º16KB</strong>
â€‚thread_infoå­˜æ”¾æ±‡ç¼–ä»£ç ç›´æ¥è®¿é—®çš„åº•å±‚æ•°æ®ï¼ŒARM64æ¶æ„å®šä¹‰ç»“æ„ä½“</li>
</ol>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/thread_info.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> thread_info {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>		flags;		<span style="color:#75715e">/* low level flags åº•å±‚æ ‡å¿—ä½ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">mm_segment_t</span>		addr_limit;	<span style="color:#75715e">/* address limit åœ°å€é™åˆ¶ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ARM64_SW_TTBR0_PAN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	u64			ttbr0;		<span style="color:#75715e">/* saved TTBR0_EL1 ä¿å­˜çš„å¯„å­˜å™¨TTBR0_EL1 */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    u64		preempt_count;	<span style="color:#75715e">/* æŠ¢å è®¡æ•°å™¨ 0 =&gt; preemptible å¯æŠ¢å , &lt;0 =&gt; bugç¼ºé™· */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>
<p><strong>ï¼ˆ3ï¼‰copy_credså‡½æ•°</strong>
â€ƒè´Ÿè´£å¤åˆ¶æˆ–å…±äº«è¯ä¹¦ï¼Œè¯ä¹¦å­˜æ”¾è¿›ç¨‹çš„ç”¨æˆ·æ ‡è¯†ç¬¦ã€ç»„æ ‡è¯†ç¬¦å’Œè®¿é—®æƒé™ã€‚è®¾ç½®æ ‡å¿—CLONE_THREADï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„ã€‚CLONE_NEWUSERï¼Œéœ€è¦ä¸ºæ–°è¿›ç¨‹åˆ›å»ºæ–°çš„ç”¨æˆ·å‘½åç©ºé—´ã€‚è¿›ç¨‹è®¡æ•°å™¨åŠ 1</p>
</li>
<li>
<p><strong>ï¼ˆ4ï¼‰æ£€æŸ¥çº¿ç¨‹æ•°é‡é™åˆ¶</strong>
â€ƒå…¨å±€å˜é‡nr_threadså­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡ï¼Œmax_threadså­˜æ”¾å…è®¸åˆ›å»ºçš„çº¿ç¨‹æœ€å¤§æ•°é‡ï¼Œé»˜è®¤å€¼MAX_THREADS</p>
</li>
<li>
<p><strong>ï¼ˆ5ï¼‰sched_forkå‡½æ•°</strong></p>
</li>
</ul>
<p>â€ƒä¸ºæ–°è¿›ç¨‹è®¾ç½®è°ƒåº¦å™¨ç›¸å…³çš„å‚æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c  ä¹¦ä¸­ä¸º4.xç‰ˆæœ¬
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sched_fork</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__sched_fork</span>(clone_flags, p);   <span style="color:#75715e">// æ‰§è¡ŒåŸºæœ¬è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * We mark the process as NEW here. This guarantees that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * nobody will actually run it, and a signal or other external
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * event cannot wake it up and insert it on the runqueue either.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> TASK_NEW;    <span style="color:#75715e">// æ–°è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºTASK_NEW
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Make sure we do not leak PI boosting priority to the child.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>prio <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>normal_prio;  <span style="color:#75715e">// æ–°è¿›ç¨‹è°ƒåº¦ä¼˜å…ˆçº§è®¾ç½®ä¸ºå½“å‰è¿›ç¨‹æ­£å¸¸ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">uclamp_fork</span>(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Revert to default priority/policy on fork if requested.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(p<span style="color:#f92672">-&gt;</span>sched_reset_on_fork)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">task_has_dl_policy</span>(p) <span style="color:#f92672">||</span> <span style="color:#a6e22e">task_has_rt_policy</span>(p)) { <span style="color:#75715e">// é™æœŸè¿›ç¨‹æˆ–å®æ—¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>policy <span style="color:#f92672">=</span> SCHED_NORMAL;  <span style="color:#75715e">// è°ƒåº¦ç­–ç•¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>static_prio <span style="color:#f92672">=</span> <span style="color:#a6e22e">NICE_TO_PRIO</span>(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>rt_priority <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;  
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">PRIO_TO_NICE</span>(p<span style="color:#f92672">-&gt;</span>static_prio) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// æ™®é€šè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			p<span style="color:#f92672">-&gt;</span>static_prio <span style="color:#f92672">=</span> <span style="color:#a6e22e">NICE_TO_PRIO</span>(<span style="color:#ae81ff">0</span>); <span style="color:#75715e">// niceå€¼é»˜è®¤å€¼0ï¼Œé™æ€ä¼˜å…ˆçº§120
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>prio <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>normal_prio <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>static_prio;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">set_load_weight</span>(p, false);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * We don&#39;t need the reset flag anymore after the fork. It has
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * fulfilled its duty:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 */</span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>sched_reset_on_fork <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">dl_prio</span>(p<span style="color:#f92672">-&gt;</span>prio)) <span style="color:#75715e">// è°ƒåº¦ä¼˜å…ˆçº§æ˜¯é™æœŸè°ƒåº¦ç´¯çš„ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EAGAIN;  <span style="color:#75715e">// ä¸å…è®¸é™æœŸè¿›ç¨‹åˆ†å‰ç”Ÿæˆæ–°çš„é™æœŸè¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rt_prio</span>(p<span style="color:#f92672">-&gt;</span>prio))  <span style="color:#75715e">// è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å®æ—¶è°ƒåº¦ç±»ä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		p<span style="color:#f92672">-&gt;</span>sched_class <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>rt_sched_class; <span style="color:#75715e">// è°ƒåº¦ç±»è®¾ç½®ä¸ºå®æ—¶è°ƒåº¦ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>sched_class <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>fair_sched_class;  <span style="color:#75715e">// è°ƒåº¦ä¼˜å…ˆçº§æ˜¯å…¬å¹³è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§ï¼Œè°ƒåº¦ç±»è®¾ç½®ä¸ºå…¬å¹³è°ƒåº¦ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init_entity_runnable_average</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>se);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SCHED_INFO
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(<span style="color:#a6e22e">sched_info_on</span>()))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>sched_info, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(p<span style="color:#f92672">-&gt;</span>sched_info));
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#if defined(CONFIG_SMP)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	p<span style="color:#f92672">-&gt;</span>on_cpu <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">init_task_preempt_count</span>(p);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">plist_node_init</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pushable_tasks, MAX_PRIO);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RB_CLEAR_NODE</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pushable_dl_tasks);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><strong>ï¼ˆ6ï¼‰å¤åˆ¶æˆ–å…±äº«èµ„æº</strong></li>
</ul>
<p>â€ƒ1ï¼‰UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰å…±äº«UNIXç³»ç»Ÿçš„5ä¿¡å·é‡ï¼Œcopy_semundoå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-4.14.295/ipc/sem.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_semundo</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sem_undo_list <span style="color:#f92672">*</span>undo_list;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> error;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_SYSVSEM) {  <span style="color:#75715e">// CLONE_SYSTEMè¡¨ç¤ºUNIXç³»ç»Ÿ5ä¿¡å·é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		error <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_undo_list</span>(<span style="color:#f92672">&amp;</span>undo_list);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (error)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> error;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">refcount_inc</span>(<span style="color:#f92672">&amp;</span>undo_list<span style="color:#f92672">-&gt;</span>refcnt); <span style="color:#75715e">// 5ä¿¡å·é‡çš„æ’¤é”€è¯·æ±‚é“¾è¡¨ï¼Œsem_undo_list è®¡æ•°+1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		tsk<span style="color:#f92672">-&gt;</span>sysvsem.undo_list <span style="color:#f92672">=</span> undo_list;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		tsk<span style="color:#f92672">-&gt;</span>sysvsem.undo_list <span style="color:#f92672">=</span> NULL; <span style="color:#75715e">// æ–°è¿›ç¨‹5ä¿¡å·é‡æ’¤é”€è¯·æ±‚é“¾è¡¨ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚2ï¼‰æ‰“å¼€æ–‡ä»¶å¤¹ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ç›´æ¥å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨ï¼Œå‡½æ•°copy_fileså¤åˆ¶æˆ–å…±äº«æ‰“å¼€æ–‡ä»¶è¡¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_files</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> files_struct <span style="color:#f92672">*</span>oldf, <span style="color:#f92672">*</span>newf;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> error <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * A background process may not have any files ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	oldf <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>files;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>oldf)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_FILES) { <span style="color:#75715e">// CLONE_FIELSå…±äº«æ‰“å¼€æ–‡ä»¶è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">atomic_inc</span>(<span style="color:#f92672">&amp;</span>oldf<span style="color:#f92672">-&gt;</span>count);  <span style="color:#75715e">// files_struct è®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	newf <span style="color:#f92672">=</span> <span style="color:#a6e22e">dup_fd</span>(oldf, NR_OPEN_MAX, <span style="color:#f92672">&amp;</span>error);  <span style="color:#75715e">// æ–°è¿›ç¨‹æŠŠå½“å‰è¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶è¡¨å¤åˆ¶ä¸€ä»½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>newf)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>files <span style="color:#f92672">=</span> newf;
</span></span><span style="display:flex;"><span>	error <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>out:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> error;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ3ï¼‰æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ã€‚è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡å·åŒ…æ‹¬ï¼šæ ¹ç›®å½•ã€å½“å‰å·¥ä½œç›®å½•å’Œæ–‡ä»¶æ¨¡å¼åˆ›å»ºæ©ç ã€‚åŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯     <br>
â€‚â€ƒå‡½æ•°copy_fså¤åˆ¶æˆ–å…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_fs</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> fs_struct <span style="color:#f92672">*</span>fs <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>fs;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_FS) {  <span style="color:#75715e">// CLONE_FSå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">/* tsk-&gt;fs is already what we want */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">spin_lock</span>(<span style="color:#f92672">&amp;</span>fs<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (fs<span style="color:#f92672">-&gt;</span>in_exec) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">spin_unlock</span>(<span style="color:#f92672">&amp;</span>fs<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EAGAIN;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		fs<span style="color:#f92672">-&gt;</span>users<span style="color:#f92672">++</span>;  <span style="color:#75715e">// fs_structå…±äº«æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯ç»“æ„ä½“ åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">spin_unlock</span>(<span style="color:#f92672">&amp;</span>fs<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>fs <span style="color:#f92672">=</span> <span style="color:#a6e22e">copy_fs_struct</span>(fs);  <span style="color:#75715e">// æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>tsk<span style="color:#f92672">-&gt;</span>fs)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ4ï¼‰ä¿¡å·å¤„ç†ç¨‹åºï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çº¿ç¨‹ä¹‹é—´æ‰ä¼šå…±äº«ä¿¡å·å¤„ç†ç¨‹åº <br>
â€‚â€ƒå‡½æ•°copy_sighandå¤åˆ¶æˆ–å…±äº«ä¿¡å·å¤„ç†ç¨‹åº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_sighand</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sighand_struct <span style="color:#f92672">*</span>sig;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_SIGHAND) {  <span style="color:#75715e">// CLONE_SIGHAND è¡¨ç¤ºå…±äº«ä¿¡å·å¤„ç†ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">refcount_inc</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>count); <span style="color:#75715e">// å¼•ç”¨è®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹ä¿¡å·å¤„ç†ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	sig <span style="color:#f92672">=</span> <span style="color:#a6e22e">kmem_cache_alloc</span>(sighand_cachep, GFP_KERNEL);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RCU_INIT_POINTER</span>(tsk<span style="color:#f92672">-&gt;</span>sighand, sig);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>sig)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">refcount_set</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>count, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spin_lock_irq</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memcpy</span>(sig<span style="color:#f92672">-&gt;</span>action, current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>action, <span style="color:#66d9ef">sizeof</span>(sig<span style="color:#f92672">-&gt;</span>action));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spin_unlock_irq</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Reset all signal handler not set to SIG_IGN to SIG_DFL. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_CLEAR_SIGHAND)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flush_signal_handlers</span>(tsk, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ5ï¼‰ä¿¡å·ç»“æ„ä½“ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«ä¿¡å·ç»“æ„ä½“   <br>
â€‚â€ƒå‡½æ•°copy_signalå¤åˆ¶æˆ–å…±äº«ä¿¡å·ç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_signal</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> signal_struct <span style="color:#f92672">*</span>sig;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_THREAD)  <span style="color:#75715e">// CLONE_THREADè¡¨ç¤ºåˆ›å»ºçº¿ç¨‹ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«ä¿¡å·ç»“æ„ä½“signal_struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ºæ–°è¿›ç¨‹åˆ†é…ç»“æ„ä½“ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹èµ„æºé™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	sig <span style="color:#f92672">=</span> <span style="color:#a6e22e">kmem_cache_zalloc</span>(signal_cachep, GFP_KERNEL);
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>signal <span style="color:#f92672">=</span> sig;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>sig)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>nr_threads <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">atomic_set</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>live, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">refcount_set</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>sigcnt, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* list_add(thread_node, thread_head) without INIT_LIST_HEAD() */</span>
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>thread_head <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> list_head)<span style="color:#a6e22e">LIST_HEAD_INIT</span>(tsk<span style="color:#f92672">-&gt;</span>thread_node);
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>thread_node <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> list_head)<span style="color:#a6e22e">LIST_HEAD_INIT</span>(sig<span style="color:#f92672">-&gt;</span>thread_head);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init_waitqueue_head</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>wait_chldexit);
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>curr_target <span style="color:#f92672">=</span> tsk;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init_sigpending</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>shared_pending);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">INIT_HLIST_HEAD</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>multiprocess);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">seqlock_init</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>stats_lock);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prev_cputime_init</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>prev_cputime);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_POSIX_TIMERS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">INIT_LIST_HEAD</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>posix_timers);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">hrtimer_init</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>real_timer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>real_timer.function <span style="color:#f92672">=</span> it_real_fn;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">task_lock</span>(current<span style="color:#f92672">-&gt;</span>group_leader);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memcpy</span>(sig<span style="color:#f92672">-&gt;</span>rlim, current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>rlim, <span style="color:#66d9ef">sizeof</span> sig<span style="color:#f92672">-&gt;</span>rlim);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">task_unlock</span>(current<span style="color:#f92672">-&gt;</span>group_leader);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">posix_cpu_timers_init_group</span>(sig);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tty_audit_fork</span>(sig);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sched_autogroup_fork</span>(sig);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>oom_score_adj <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>oom_score_adj;
</span></span><span style="display:flex;"><span>	sig<span style="color:#f92672">-&gt;</span>oom_score_adj_min <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>oom_score_adj_min;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mutex_init</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>cred_guard_mutex);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">init_rwsem</span>(<span style="color:#f92672">&amp;</span>sig<span style="color:#f92672">-&gt;</span>exec_update_lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ6ï¼‰è™šæ‹Ÿå†…å­˜ï¼ŒåŒå±ä¸€ä¸ªçº¿ç¨‹ç»„çš„çº¿ç¨‹æ‰ä¼šå…±äº«è™šæ‹Ÿå†…å­˜  \
â€‚â€ƒå‡½æ•°copy_mmå¤åˆ¶æˆ–å…±äº«è™šæ‹Ÿå†…å­˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/freezer.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_mm</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#f92672">*</span>oldmm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> retval;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>min_flt <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>maj_flt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>nvcsw <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>nivcsw <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_DETECT_HUNG_TASK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	tsk<span style="color:#f92672">-&gt;</span>last_switch_count <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>nvcsw <span style="color:#f92672">+</span> tsk<span style="color:#f92672">-&gt;</span>nivcsw;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>last_switch_time <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Are we cloning a kernel thread?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * We need to steal a active VM for that..
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	oldmm <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>oldmm)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* initialize the new vmacache entries */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">vmacache_flush</span>(tsk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_VM) {  <span style="color:#75715e">// CLONE_VMè¡¨ç¤ºå…±äº«è™šæ‹Ÿå†…å­˜ï¼Œæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å†…å­˜æè¿°ç¬¦mm_struct
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">mmget</span>(oldmm);
</span></span><span style="display:flex;"><span>		mm <span style="color:#f92672">=</span> oldmm;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> good_mm;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	retval <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°è¿›ç¨‹å¤åˆ¶å½“å‰è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mm <span style="color:#f92672">=</span> <span style="color:#a6e22e">dup_mm</span>(tsk, current<span style="color:#f92672">-&gt;</span>mm);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mm)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> fail_nomem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>good_mm:
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>mm <span style="color:#f92672">=</span> mm;
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fail_nomem:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> retval;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ7ï¼‰å‘½åç©ºé—´    <br>
â€‚â€ƒå‡½æ•°copy_namespaceåˆ›å»ºæˆ–å…±äº«å‘½åç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/nsproxy.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_namespaces</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>old_ns <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>nsproxy;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> user_namespace <span style="color:#f92672">*</span>user_ns <span style="color:#f92672">=</span> <span style="color:#a6e22e">task_cred_xxx</span>(tsk, user_ns);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> nsproxy <span style="color:#f92672">*</span>new_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœå…±äº«é™¤äº†ç”¨æˆ·ä»¥å¤–çš„æ‰€æœ‰å…¶ä»–å‘½åç©ºé—´ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é‚£ä¹ˆæ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å…±äº«å‘½åç©ºé—´ä»£ç†ç»“æ„ä½“nsproxyï¼ŒæŠŠè®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(<span style="color:#f92672">!</span>(flags <span style="color:#f92672">&amp;</span> (CLONE_NEWNS <span style="color:#f92672">|</span> CLONE_NEWUTS <span style="color:#f92672">|</span> CLONE_NEWIPC <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>			      CLONE_NEWPID <span style="color:#f92672">|</span> CLONE_NEWNET <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>			      CLONE_NEWCGROUP <span style="color:#f92672">|</span> CLONE_NEWTIME)))) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(old_ns<span style="color:#f92672">-&gt;</span>time_ns_for_children <span style="color:#f92672">==</span> old_ns<span style="color:#f92672">-&gt;</span>time_ns)) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">get_nsproxy</span>(old_ns);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">ns_capable</span>(user_ns, CAP_SYS_ADMIN)) 
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¿›ç¨‹æ²¡æœ‰ç³»ç»Ÿç®¡ç†æƒé™ï¼Œé‚£ä¹ˆä¸å…è®¸åˆ›å»ºæ–°çš„å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EPERM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* CLONE_NEWIPC must detach from the undolist: after switching
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * to a new ipc namespace, the semaphore arrays from the old
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * namespace are unreachable.  In clone parlance, CLONE_SYSVSEM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * means share undolist with parent, so we must forbid using
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * it along with CLONE_NEWIPC. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ—¢è¦æ±‚åˆ›å»ºæ–°çš„è¿›ç¨‹é—´é€šä¿¡å‘½åç©ºé—´ï¼Œåˆè¦æ±‚å…±äº«UNIXç³»ç»Ÿ5ä¿¡å·é‡ï¼Œé‚£ä¹ˆè¿™ç§è¦æ±‚æ˜¯ä¸åˆç†çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> ((flags <span style="color:#f92672">&amp;</span> (CLONE_NEWIPC <span style="color:#f92672">|</span> CLONE_SYSVSEM)) <span style="color:#f92672">==</span>
</span></span><span style="display:flex;"><span>		(CLONE_NEWIPC <span style="color:#f92672">|</span> CLONE_SYSVSEM)) 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆ›å»ºæ–°çš„å‘½åç©ºé—´ä»£ç†ï¼Œç„¶ååˆ›å»ºæˆ–è€…å…±äº«å‘½åç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	new_ns <span style="color:#f92672">=</span> <span style="color:#a6e22e">create_new_namespaces</span>(flags, tsk, user_ns, tsk<span style="color:#f92672">-&gt;</span>fs);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR</span>(new_ns))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>  <span style="color:#a6e22e">PTR_ERR</span>(new_ns);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">timens_on_fork</span>(new_ns, tsk);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (ret) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">free_nsproxy</span>(new_ns);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	tsk<span style="color:#f92672">-&gt;</span>nsproxy <span style="color:#f92672">=</span> new_ns;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ8ï¼‰I/Oä¸Šä¸‹æ–‡    <br>
â€‚â€ƒå‡½æ•°copy_ioåˆ›å»ºæˆ–å…±äº«I/Oä¸Šä¸‹æ–‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_io</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_BLOCK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> io_context <span style="color:#f92672">*</span>ioc <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>io_context;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> io_context <span style="color:#f92672">*</span>new_ioc;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ioc)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Share io context with parent, if CLONE_IO is set */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_IO) {  <span style="color:#75715e">// CLONE_IO å…±äº«I/Oä¸Šå°æ–‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ioc_task_link</span>(ioc);  <span style="color:#75715e">// è®¡æ•°nr_tasksåŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		tsk<span style="color:#f92672">-&gt;</span>io_context <span style="color:#f92672">=</span> ioc;  <span style="color:#75715e">// å…±äº«I/Oä¸Šä¸‹æ–‡ç»“æ„ä½“io_context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ioprio_valid</span>(ioc<span style="color:#f92672">-&gt;</span>ioprio)) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»ºæ–°çš„I/Oä¸Šä¸‹æ–‡ï¼Œåˆå§‹åŒ–ï¼Œç»§æ‰¿å½“å‰è¿›ç¨‹çš„I/Oä¼˜å…ˆçº§
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		new_ioc <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_task_io_context</span>(tsk, GFP_KERNEL, NUMA_NO_NODE);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#f92672">!</span>new_ioc))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>ENOMEM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		new_ioc<span style="color:#f92672">-&gt;</span>ioprio <span style="color:#f92672">=</span> ioc<span style="color:#f92672">-&gt;</span>ioprio;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_io_context</span>(new_ioc);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€ƒ9ï¼‰å¤åˆ¶å¯„å­˜å™¨å€¼   <br>
â€‚â€ƒå‡½æ•°copy_thread_tlså¤åˆ¶å½“å‰è¿›ç¨‹çš„å¯„å­˜å™¨å€¼ï¼Œå¹¶ä¿®æ”¹ä¸€éƒ¨åˆ†å¯„å­˜å™¨å€¼ã€‚è¿›ç¨‹æœ‰ä¸¤å¤„ç”¨æ¥ä¿å­˜å¯„å­˜å™¨å€¼ï¼šä»ç”¨æˆ·æ¨¡å¼åˆ‡æ¢åˆ°å†…æ ¸æ¨¡å¼æ—¶ï¼ŒæŠŠç”¨æˆ·æ¨¡å¼çš„å„ç§å¯„å­˜å™¨ä¿å­˜åœ¨å†…æ ¸æ ˆåº•éƒ¨çš„ç»“æ„ä½“pt_regsä¸­ï¼›è¿›ç¨‹è°ƒåº¦å™¨è°ƒåº¦è¿›ç¨‹æ—¶ï¼Œåˆ‡æ¢å‡ºå»çš„è¿›ç¨‹æŠŠå¯„å­˜å™¨å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜threadä¸­ã€‚å› ä¸ºä¸åŒå¤„ç†å™¨æ¶æ„çš„å¯„å­˜å™¨ä¸åŒï¼Œæ‰€ä»¥å„ç§å¤„ç†å™¨æ¶æ„éœ€è¦è‡ªå·±å®šä¹‰ç»“æ„ä½“pt_regså’Œthread_struct</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221030211811.png" alt="20221030211811"  />
</p>
<p>â€‚â€ƒARM64æ¶æ„copy_thread_tls-&gt;copy_thread</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/kernel/process.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">copy_thread</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> clone_flags, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stack_start,
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> stk_sz, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> tls)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>childregs <span style="color:#f92672">=</span> <span style="color:#a6e22e">task_pt_regs</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ–°è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextæ¸…é›¶ï¼Œåœ¨è°ƒåº¦è¿›ç¨‹æ—¶åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹ä½¿ç”¨è¿™ä¸ªæˆå‘˜ä¿å­˜é€šç”¨å¯„å­˜å™¨çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memset</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> cpu_context));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* In case p was allocated the same task_struct pointer as some
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * other recently-exited task, make sure p is disassociated from
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * any cpu that may have run that now-exited task recently.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Otherwise we could erroneously skip reloading the FPSIMD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * registers for p. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fpsimd_flush_task_state</span>(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ptrauth_thread_init_kernel</span>(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(<span style="color:#f92672">!</span>(p<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> PF_KTHREAD))) {  <span style="color:#75715e">// ç”¨æˆ·è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#f92672">*</span>childregs <span style="color:#f92672">=</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">current_pt_regs</span>();
</span></span><span style="display:flex;"><span>		childregs<span style="color:#f92672">-&gt;</span>regs[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Read the current TLS pointer from tpidr_el0 as it may be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * out-of-sync with the saved value.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * ä»å¯„å­˜å™¨tpidr_el0è¯»å–å½“å‰çº¿ç¨‹çš„çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * å› ä¸ºå®ƒå¯èƒ½å’Œä¿å­˜çš„å€¼ä¸ä¸€è‡´ */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">*</span><span style="color:#a6e22e">task_user_tls</span>(p) <span style="color:#f92672">=</span> <span style="color:#a6e22e">read_sysreg</span>(tpidr_el0);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (stack_start) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_compat_thread</span>(<span style="color:#a6e22e">task_thread_info</span>(p)))
</span></span><span style="display:flex;"><span>				childregs<span style="color:#f92672">-&gt;</span>compat_sp <span style="color:#f92672">=</span> stack_start;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>				childregs<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> stack_start;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* If a TLS pointer was passed to clone, use it for the new thread. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * å¦‚æœæŠŠçº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„åœ°å€ä¼ ç»™ç³»ç»Ÿè°ƒç”¨cloneçš„ç¬¬4ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆæ–°çº¿ç¨‹å°†ä½¿ç”¨å®ƒ*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_SETTLS)
</span></span><span style="display:flex;"><span>			p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.uw.tp_value <span style="color:#f92672">=</span> tls;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">// å†…æ ¸çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">memset</span>(childregs, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> pt_regs));
</span></span><span style="display:flex;"><span>		childregs<span style="color:#f92672">-&gt;</span>pstate <span style="color:#f92672">=</span> PSR_MODE_EL1h;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ENABLED</span>(CONFIG_ARM64_UAO) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    <span style="color:#a6e22e">cpus_have_const_cap</span>(ARM64_HAS_UAO))
</span></span><span style="display:flex;"><span>			childregs<span style="color:#f92672">-&gt;</span>pstate <span style="color:#f92672">|=</span> PSR_UAO_BIT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">spectre_v4_enable_task_mitigation</span>(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">system_uses_irq_prio_masking</span>())
</span></span><span style="display:flex;"><span>			childregs<span style="color:#f92672">-&gt;</span>pmr_save <span style="color:#f92672">=</span> GIC_PRIO_IRQON;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.x19 <span style="color:#f92672">=</span> stack_start;
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.x20 <span style="color:#f92672">=</span> stk_sz;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.pc <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)ret_from_fork;
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">thread</span>.cpu_context.sp <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)childregs;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ptrace_hw_copy_thread</span>(p);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><strong>ï¼ˆ7ï¼‰è®¾ç½®è¿›ç¨‹å·å’Œè¿›ç¨‹å…³ç³»</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> __latent_entropy <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span><span style="color:#a6e22e">copy_process</span>(
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">struct</span> pid <span style="color:#f92672">*</span>pid,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">int</span> trace,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">int</span> node,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">struct</span> kernel_clone_args <span style="color:#f92672">*</span>args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ºæ–°è¿›ç¨‹åˆ†é…è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// pidç­‰äºinit_struct_pidçš„åœ°å€ï¼Œå†…æ ¸åˆå§‹åŒ–æ—¶ï¼Œå¼•å¯¼å¤„ç†å™¨ä¸ºæ¯ä¸ªä»å¤„ç†å™¨åˆ†å‰ç”Ÿæˆä¸€ä¸ªç©ºé—²çº¿ç¨‹ï¼ˆå‚è€ƒå‡½æ•°idle_threads_initï¼‰ï¼Œæ‰€æœ‰å¤„ç†å™¨çš„ç©ºé—²çº¿ç¨‹ä½¿ç”¨è¿›ç¨‹å·0ï¼Œå…¨å±€å˜é‡init_struct_pidå­˜æ”¾ç©ºé—²çº¿ç¨‹çš„è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (pid <span style="color:#f92672">!=</span> <span style="color:#f92672">&amp;</span>init_struct_pid) {
</span></span><span style="display:flex;"><span>        pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloc_pid</span>(p<span style="color:#f92672">-&gt;</span>nsproxy<span style="color:#f92672">-&gt;</span>pid_ns_for_children);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IS_ERR</span>(pid)) {
</span></span><span style="display:flex;"><span>            retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">PTR_ERR</span>(pid);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">goto</span> bad_fork_cleanup_thread;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è®¾ç½®æ–°è¿›ç¨‹é€€å‡ºæ—¶å‘é€ç»™çˆ¶è¿›ç¨‹çš„ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    p<span style="color:#f92672">-&gt;</span>pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">pid_nr</span>(pid);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_THREAD) {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>exit_signal <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">// æ–°çº¿ç¨‹é€€å‡ºæ—¶ä¸éœ€è¦å‘é€ä¿¡å·ç»™çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>group_leader <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>group_leader;  <span style="color:#75715e">// group_leaderæŒ‡å‘åŒä¸€ä¸ªç»„é•¿
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>tgid <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>tgid;  <span style="color:#75715e">// tgidå­˜æ”¾ç»„é•¿çš„è¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> CLONE_PARENT) <span style="color:#75715e">// CLONE_PARENT æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ˜¯å…„å¼Ÿå…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            p<span style="color:#f92672">-&gt;</span>exit_signal <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>group_leader<span style="color:#f92672">-&gt;</span>exit_signal;  <span style="color:#75715e">// æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalç­‰äºå½“å‰è¿›ç¨‹æ‰€å±çº¿ç¨‹ç»„çš„ç»„é•¿çš„æˆå‘˜exit_signal
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">else</span> <span style="color:#75715e">// çˆ¶å­å…³ç³»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            p<span style="color:#f92672">-&gt;</span>exit_signal <span style="color:#f92672">=</span> (clone_flags <span style="color:#f92672">&amp;</span> CSIGNAL); <span style="color:#75715e">// æ–°è¿›ç¨‹çš„æˆå‘˜exit_signalæ˜¯è°ƒç”¨è€…æŒ‡å®šçš„ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>group_leader <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>tgid <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>pid;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ§åˆ¶ç»„çš„è¿›ç¨‹æ•°æ§åˆ¶å™¨æ£€æŸ¥æ˜¯å¦å…è®¸åˆ›å»ºæ–°è¿›ç¨‹ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä»å½“å‰è¿›ç¨‹æ‰€å±çš„æ§åˆ¶ç»„ä¸€ç›´åˆ°æ§åˆ¶ç»„å±‚çº§çš„æ ¹ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¦‚æœå…¶ä¸­ä¸€ä¸ªæ§åˆ¶ç»„çš„è¿›ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºé™åˆ¶ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é‚£ä¹ˆä¸å…è®¸ä½¿ç”¨forkå’Œcloneåˆ›å»ºæ–°è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">cgroup_threadgroup_change_begin</span>(current);
</span></span><span style="display:flex;"><span>    retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">cgroup_can_fork</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (retval)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> bad_fork_free_pid;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">write_lock_irq</span>(<span style="color:#f92672">&amp;</span>tasklist_lock);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ä¸ºæ–°è¿›ç¨‹è®¾ç½®çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (clone_flags <span style="color:#f92672">&amp;</span> (CLONE_PARENT<span style="color:#f92672">|</span>CLONE_THREAD)) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹æ‹¥æœ‰ç›¸åŒçš„çˆ¶è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>real_parent <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>real_parent;  
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>parent_exec_id <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>parent_exec_id;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">-&gt;</span>real_parent <span style="color:#f92672">=</span> current;  <span style="color:#75715e">// æ–°è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯å½“å‰è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        p<span style="color:#f92672">-&gt;</span>parent_exec_id <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>self_exec_id;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spin_lock</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(p<span style="color:#f92672">-&gt;</span>pid)) {
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">init_task_pid</span>(p, PIDTYPE_PID, pid);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">thread_group_leader</span>(p)) {  <span style="color:#75715e">// true æ–°è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºåŒä¸€ä¸ªè¿›ç¨‹ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">init_task_pid</span>(p, PIDTYPE_PGID, <span style="color:#a6e22e">task_pgrp</span>(current));  <span style="color:#75715e">// æŒ‡å‘åŒä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿çš„è¿›ç¨‹å·ç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">init_task_pid</span>(p, PIDTYPE_SID, <span style="color:#a6e22e">task_session</span>(current));  <span style="color:#75715e">// æŒ‡å‘åŒä¸€ä¸ªä¼šè¯çš„æ§åˆ¶è¿›ç¨‹çš„è¿›ç¨‹å·ç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_child_reaper</span>(pid)) {  
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">ns_of_pid</span>(pid)<span style="color:#f92672">-&gt;</span>child_reaper <span style="color:#f92672">=</span> p;
</span></span><span style="display:flex;"><span>                p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">|=</span> SIGNAL_UNKILLABLE;  <span style="color:#75715e">// 1å·è¿›ç¨‹æ˜¯ä¸èƒ½æ€æ­»çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>leader_pid <span style="color:#f92672">=</span> pid;
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>tty <span style="color:#f92672">=</span> <span style="color:#a6e22e">tty_kref_get</span>(current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>tty);
</span></span><span style="display:flex;"><span>            p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>has_child_subreaper <span style="color:#f92672">=</span> p<span style="color:#f92672">-&gt;</span>real_parent<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span> has_child_subreaper <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>                                p<span style="color:#f92672">-&gt;</span>real_parent<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>is_child_subreaper;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">list_add_tail</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>sibling, <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>real_parent<span style="color:#f92672">-&gt;</span>children);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°çˆ¶è¿›ç¨‹çš„å­è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹é“¾è¡¨ä¸­ï¼Œé“¾è¡¨èŠ‚ç‚¹æ˜¯æˆå‘˜tasksï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">// å¤´èŠ‚ç‚¹æ˜¯ç©ºé—²çº¿ç¨‹çš„æˆå‘˜tasksï¼ˆinit_task.tasksï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">list_add_tail_rcu</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>tasks, <span style="color:#f92672">&amp;</span>init_task.tasks);  
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">attach_pid</span>(p, PIDTYPE_PGID);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹ç»„çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">attach_pid</span>(p, PIDTYPE_SID);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°ä¼šè¯çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">__this_cpu_inc</span>(process_counts);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">// åˆ›å»ºçº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>nr_threads<span style="color:#f92672">++</span>;  <span style="color:#75715e">// çº¿ç¨‹ç»„çš„çº¿ç¨‹è®¡æ•°å€¼åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">atomic_inc</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>live);  <span style="color:#75715e">// åŸå­å˜é‡çº¿ç¨‹ç»„çš„ç¬¬2ä¸ªçº¿ç¨‹è®¡æ•°å€¼åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">atomic_inc</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>sigcnt);  <span style="color:#75715e">// ä¿¡å·ç»“æ„ä½“çš„å¼•ç”¨è®¡æ•°åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">list_add_tail_rcu</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>thread_group,    
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>group_leader<span style="color:#f92672">-&gt;</span>thread_group);  <span style="color:#75715e">// çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„çº¿ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#a6e22e">list_add_tail_rcu</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>thread_node,
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>thread_head);  <span style="color:#75715e">// çº¿ç¨‹åŠ å…¥çº¿ç¨‹ç»„çš„ç¬¬äºŒæ¡çº¿ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">attach_pid</span>(p, PIDTYPE_PID);  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        nr_threads<span style="color:#f92672">++</span>;  <span style="color:#75715e">// æ–°è¿›ç¨‹æ·»åŠ åˆ°è¿›ç¨‹å·ç»“æ„ä½“çš„è¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    total_forks<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">spin_unlock</span>(<span style="color:#f92672">&amp;</span>current<span style="color:#f92672">-&gt;</span>sighand<span style="color:#f92672">-&gt;</span>siglock);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">write_unlock_irq</span>(<span style="color:#f92672">&amp;</span>tasklist_lock);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_fork_connector</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cgroup_post_fork</span>(p);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cgroup_threadgroup_change_end</span>(current);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3å”¤é†’æ–°è¿›ç¨‹">3.å”¤é†’æ–°è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#3å”¤é†’æ–°è¿›ç¨‹">#</a></h4>
<p>â€ƒwake_up_new_taskå‡½æ•°å”¤é†’æ–°è¿›ç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">wake_up_new_task</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq_flags rf;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">raw_spin_lock_irqsave</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>pi_lock, rf.flags);
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> TASK_RUNNING;  <span style="color:#75715e">// åˆ‡æ¢TASK_RUNNING
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Fork balancing, do it here and not earlier because:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *  - cpus_ptr can change in the fork path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *  - any previously selected CPU might disappear through hotplug
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Use __set_task_cpu() to avoid calling sched_class::migrate_task_rq,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * as we&#39;re not fully set-up yet.*/</span>
</span></span><span style="display:flex;"><span>	p<span style="color:#f92672">-&gt;</span>recent_used_cpu <span style="color:#f92672">=</span> <span style="color:#a6e22e">task_cpu</span>(p);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rseq_migrate</span>(p);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__set_task_cpu</span>(p, <span style="color:#a6e22e">select_task_rq</span>(p, <span style="color:#a6e22e">task_cpu</span>(p), SD_BALANCE_FORK, <span style="color:#ae81ff">0</span>));  <span style="color:#75715e">// åœ¨SMPç³»ç»Ÿä¸Šï¼Œåˆ›å»ºæ–°è¿›ç¨‹æ˜¯æ‰§è¡Œè´Ÿè½½å‡è¡¡çš„ç»ä½³æ—¶æœºï¼Œä¸ºæ–°è¿›ç¨‹é€‰æ‹©ä¸€ä¸ªè´Ÿè½½æœ€è½»çš„å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	rq <span style="color:#f92672">=</span> <span style="color:#a6e22e">__task_rq_lock</span>(p, <span style="color:#f92672">&amp;</span>rf);  <span style="color:#75715e">// é”ä½è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">update_rq_clock</span>(rq);  <span style="color:#75715e">// æ›´æ–°è¿è¡Œé˜Ÿåˆ—çš„æ—¶é’Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">post_init_entity_util_avg</span>(p);  <span style="color:#75715e">// æ ¹æ®å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼ï¼Œæ¨ç®—æ–°è¿›ç¨‹çš„å¹³å‡è´Ÿè½½ç»Ÿè®¡å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">activate_task</span>(rq, p, ENQUEUE_NOCLOCK); <span style="color:#75715e">// æŠŠæ–°è¿›ç¨‹æ’å…¥è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">trace_sched_wakeup_new</span>(p);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">check_preempt_curr</span>(rq, p, WF_FORK);  <span style="color:#75715e">// æ£€æŸ¥æ–°è¿›ç¨‹æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span>task_woken) {  <span style="color:#75715e">// åœ¨SMPç³»ç»Ÿä¸Šï¼Œè°ƒç”¨è°ƒåº¦ç±»çš„task_wokenæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Nothing relies on rq-&gt;lock after this, so its fine to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * drop it.*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rq_unpin_lock</span>(rq, <span style="color:#f92672">&amp;</span>rf);
</span></span><span style="display:flex;"><span>		p<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">task_woken</span>(rq, p);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rq_repin_lock</span>(rq, <span style="color:#f92672">&amp;</span>rf);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">task_rq_unlock</span>(rq, p, <span style="color:#f92672">&amp;</span>rf);  <span style="color:#75715e">// é‡Šæ”¾è¿è¡Œé˜Ÿåˆ—çš„é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="4æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ">4.æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ<a hidden class="anchor" aria-hidden="true" href="#4æ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œ">#</a></h4>
<p>â€ƒæ–°è¿›ç¨‹ç¬¬ä¸€æ¬¡è¿è¡Œï¼Œæ˜¯ä»å‡½æ•°ret_from_forkå¼€å§‹æ‰§è¡Œï¼ŒARM64çš„ret_from_forkå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    tsk   .req   x28      <span style="color:#75715e">//å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">SYM_CODE_START</span>(ret_from_fork)
</span></span><span style="display:flex;"><span>	bl	schedule_tail  <span style="color:#75715e">// ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cbz	x19, <span style="color:#ae81ff">1f</span>  <span style="color:#75715e">// not a kernel thread å¦‚æœå¯„å­˜å™¨x19çš„å€¼æ˜¯0ï¼Œè¯´æ˜å½“å‰è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ ‡å·1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mov	x0, x20  <span style="color:#75715e">// å†…æ ¸çº¿ç¨‹ï¼šx19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œx20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	blr	x19  <span style="color:#75715e">// è°ƒç”¨çº¿ç¨‹å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>	get_current_task tsk  <span style="color:#75715e">// ç”¨æˆ·è¿›ç¨‹ï¼šx28 = sp_el0 = å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b	ret_to_user  <span style="color:#75715e">// è¿”å›ç”¨æˆ·æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">SYM_CODE_END</span>(ret_from_fork)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NOKPROBE</span>(ret_from_fork)
</span></span></code></pre></div><p>â€‚â€ƒcopy_threadå‡½æ•°ä¸­ï¼Œæ–°è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹ï¼Œå¯„å­˜å™¨x19å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„åœ°å€ï¼Œå¯„å­˜å™¨x20å­˜æ”¾çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œå¦‚æœæ–°è¿›ç¨‹æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œå¯„å­˜å™¨x19å€¼æ˜¯0   <br>
â€‚â€ƒ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage __visible <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">schedule_tail</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__releases</span>(rq<span style="color:#f92672">-&gt;</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* New tasks start with FORK_PREEMPT_COUNT, see there and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * finish_task_switch() for details.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * finish_task_switch() will drop rq-&gt;lock() and lower preempt_count
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * and the preempt_enable() will end up enabling preemption (on
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * PREEMPT_COUNT kernels).*/</span>
</span></span><span style="display:flex;"><span>	rq <span style="color:#f92672">=</span> <span style="color:#a6e22e">finish_task_switch</span>(prev);  <span style="color:#75715e">// ä¸ºä¸Šä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œæ¸…ç†æ“ä½œ2.8.6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">balance_callback</span>(rq);  <span style="color:#75715e">// æ‰§è¡Œè¿è¡Œé˜Ÿåˆ—çš„æ‰€æœ‰è´Ÿè½½å‡è¡¡å›è°ƒå‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">preempt_enable</span>();  <span style="color:#75715e">// å¼€å¯å†…æ ¸æŠ¢å 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (current<span style="color:#f92672">-&gt;</span>set_child_tid)  <span style="color:#75715e">// pthreadåº“åœ¨è°ƒç”¨clone()åˆ›å»ºçº¿ç¨‹æ—¶è®¾ç½®äº†æ ‡å¿—ä½CLONE_CHILD_SETTIDï¼Œé‚£ä¹ˆæ–°è¿›ç¨‹æŠŠè‡ªå·±çš„è¿›ç¨‹æ ‡è¯†ç¬¦å†™åˆ°æŒ‡å®šä½ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">put_user</span>(<span style="color:#a6e22e">task_pid_vnr</span>(current), current<span style="color:#f92672">-&gt;</span>set_child_tid);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">calculate_sigpending</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="252-è£…è½½ç¨‹åº">2.5.2 è£…è½½ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#252-è£…è½½ç¨‹åº">#</a></h3>
<p>â€‚è°ƒåº¦å™¨è°ƒåº¦æ–°è¿›ç¨‹ï¼Œæ–°è¿›ç¨‹ä»å‡½æ•°<code>ret_from_fork</code>å¼€å§‹ï¼Œä»ç³»ç»Ÿè°ƒç”¨<code>fork</code>è¿”å›ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å€¼0ã€‚ç„¶åæ–°è¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨<code>execve</code>è£…è½½ç¨‹åºã€‚Linuxå†…æ ¸ç»ƒä¸ªè£…è½½ç¨‹åºç³»ç»Ÿè°ƒç”¨ï¼š    \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// è·¯å¾„åæ˜¯ç›¸å¯¹æ—¶execveè§£é‡Šä¸ºç›¸å¯¹è°ƒç”¨è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">execve</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>filename, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> argv[], <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> envp[]);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è·¯å¾„åæ˜¯ç›¸å¯¹çš„ï¼Œexecveatè§£é‡Šä¸ºç›¸å¯¹æ–‡ä»¶æè¿°ç¬¦dirfdæŒ‡å‘çš„ç›®å½•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// è·¯å¾„åæ—¶ç»å¯¹çš„ï¼Œexecveatå¿½ç•¥å‚æ•°dirfd
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">execveat</span>(<span style="color:#66d9ef">int</span> dirfd, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>pathname, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> argv[], <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">const</span> envp[], <span style="color:#66d9ef">int</span> flags);
</span></span></code></pre></div><p>â€‚â€ƒå‚æ•°argvæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„å‚æ•°æŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªå‚æ•°å­—ç¬¦ä¸²çš„åœ°å€ï¼Œargv[0]åº”è¯¥æŒ‡å‘è¦è£…è½½çš„ç¨‹åºçš„åç§°ã€‚å‚æ•°envpæ˜¯ä¼ ç»™æ–°ç¨‹åºçš„ç¯å¢ƒæŒ‡é’ˆæ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸€ä¸ªç¯å¢ƒå­—ç¬¦ä¸²çš„åœ°å€ï¼Œç¯å¢ƒå­—ç¬¦ä¸²çš„å½¢å¼æ˜¯â€œé”®=å€¼</p>
<p>â€ƒä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æœ€ç»ˆéƒ½è°ƒç”¨å‡½æ•°do_execveat_common
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221102001015.png" alt="20221102001015"  />
</p>
<p>â€‚â€ƒå‡½æ•°do_open_execatæ‰“å¼€å¯æ‰§è¡Œæ–‡ä»¶ã€‚   <br>
â€‚â€ƒå‡½æ•°sched_execã€‚è£…è½½ç¨‹åºæ˜¯å®ç°å¤„ç†å™¨è´Ÿè½½å‡è¡¡çš„æœºä¼šï¼Œæ­¤æ—¶è¿›ç¨‹åœ¨å†…å­˜å’Œç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€å°‘çš„ã€‚é€‰æ‹©è´Ÿè½½æœ€è½»çš„å¤„ç†å™¨ï¼Œç„¶åå”¤é†’å½“å‰å¤„ç†å™¨ä¸Šçš„è¿ç§»çº¿ç¨‹ï¼Œå½“å‰è¿›ç¨‹ç¡çœ ç­‰å¾…è¿ç§»çº¿ç¨‹æŠŠè‡ªå·±è¿ç§»åˆ°ç›®æ ‡å¤„ç†å™¨      <br>
â€‚â€ƒå‡½æ•°bprm_mm_initåˆ›å»ºæ–°çš„å†…å­˜æè¿°ç¬¦ï¼Œåˆ†é…é•¿åº¦ä¸ºä¸€é¡µçš„ä¸´æ—¶çš„ç”¨æˆ·æ ˆï¼Œè™šæ‹Ÿåœ°å€èŒƒå›´æ˜¯[STACK_TOP_MAXâˆ’é¡µé•¿åº¦ï¼ŒSTACK_TOP_MAX]ï¼Œbprm-&gt;pæŒ‡å‘åœ¨æ ˆåº•ä¿ç•™ä¸€ä¸ªå­—é•¿ï¼ˆæŒ‡é’ˆé•¿åº¦ï¼‰åçš„ä½ç½®           <br>
â€‚â€ƒå‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»æ–‡ä»¶çš„å‰é¢128å­—èŠ‚åˆ°ç¼“å†²åŒºã€‚128å­—èŠ‚æ˜¯ä»€ä¹ˆï¼Ÿ      \
â€‚â€ƒä¾æ¬¡æŠŠæ–‡ä»¶åç§°ã€ç¯å¢ƒå­—ç¬¦ä¸²å’Œå‚æ•°å­—ç¬¦ä¸²å‹åˆ°ç”¨æˆ·æ ˆ         <br>
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221102001840.png" alt="20221102001840"  />

â€‚â€ƒå‡½æ•°exec_binprmè°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«æ­£åœ¨è£…è½½çš„ç¨‹åºä¸ºæ­¢</p>
<h4 id="1äºŒè¿›åˆ¶æ ¼å¼">1.äºŒè¿›åˆ¶æ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#1äºŒè¿›åˆ¶æ ¼å¼">#</a></h4>
<p>â€‚LinuxäºŒè¿›åˆ¶æ ¼å¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/include/linux/binfmts.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> linux_binfmt {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> list_head lh;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> module <span style="color:#f92672">*</span>module;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>load_binary)(<span style="color:#66d9ef">struct</span> linux_binprm <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>load_shlib)(<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>core_dump)(<span style="color:#66d9ef">struct</span> coredump_params <span style="color:#f92672">*</span>cprm);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> min_coredump;	<span style="color:#75715e">/* minimal dump size */</span>
</span></span><span style="display:flex;"><span>} __randomize_layout;
</span></span></code></pre></div><p>â€ƒäºŒè¿›åˆ¶æ ¼å¼æä¾›3ä¸ªå‡½æ•°        <br>
â€‚â€ƒ(1)load_binary åŠ è½½æ™®é€šç¨‹åº       <br>
â€‚â€ƒ(2)load_shlib åŠ è½½å…±äº«åº“     <br>
â€‚â€ƒ(3)core_dump åœ¨è¿›ç¨‹å¼‚å¸¸é€€å‡ºæ—¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œmin_coredumpæŒ‡å®šæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶çš„æœ€å°é•¿åº¦     <br>
â€‚äºŒè¿›åˆ¶æ ¼å¼ä½¿ç”¨<code>register_binfmt</code>å‘å†…æ ¸æ³¨å†Œ</p>
<h4 id="2è£…è½½elfç¨‹åº">2.è£…è½½ELFç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#2è£…è½½elfç¨‹åº">#</a></h4>
<p>â€‚ELFæ–‡ä»¶,ELF(Executable and Linkable Format)å¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼ <code>linux-5.10.102/include/uapi/linux/elf.h</code></p>
<ul>
<li>ç›®æ ‡æ–‡ä»¶(å¯é‡å®šä½æ–‡ä»¶)ï¼Œ<code>.o</code>ï¼Œå¤šä¸ªæ¨¡æ¿æ–‡ä»¶é“¾æ¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“</li>
<li>å¯æ‰§è¡Œæ–‡ä»¶</li>
<li>å…±äº«åº“ <code>.so</code></li>
<li>æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶(core dump file)</li>
</ul>
<p>â€ƒELFæ–‡ä»¶åˆ†æˆ4éƒ¨åˆ†ï¼š<code>ELFé¦–éƒ¨ã€ç¨‹åºé¦–éƒ¨è¡¨(programe header table)ã€èŠ‚(section)å’ŒèŠ‚é¦–éƒ¨è¡¨(section header table)</code>ï¼ŒELFåªæœ‰é¦–éƒ¨çš„ä½ç½®æ˜¯å›ºå®šçš„ã€‚</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103105503.png" alt="20221103105503"  />
</p>
<p>â€‚â€ƒç¨‹åºé¦–éƒ¨è¡¨å°±æ˜¯æ®µè¡¨(segment table)ï¼Œ<code>æ®µ(segment)æ˜¯ä»è¿è¡Œè§’åº¦æè¿°</code>ï¼Œ<code>èŠ‚(section)æ˜¯ä»é“¾æ¥è§’åº¦æè¿°</code>ã€‚    <br>
â€ƒ64ä½ELFæ–‡ä»¶æ ¼å¼</p>
<p>å‚è€ƒé“¾æ¥ï¼š
ELF æ ¼å¼è¯¦è§£ <a href="https://blog.csdn.net/shanandqiu/article/details/115206426">https://blog.csdn.net/shanandqiu/article/details/115206426</a>     <br>
ELFæ–‡ä»¶æ ¼å¼ç®€ä»‹  <a href="https://blog.csdn.net/GrayOnDream/article/details/124564129">https://blog.csdn.net/GrayOnDream/article/details/124564129</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ELFé¦–éƒ¨</span>
</span></span><span style="display:flex;"><span>readelf -h &lt;ELFæ–‡ä»¶&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹ç¨‹åºé¦–éƒ¨è¡¨</span>
</span></span><span style="display:flex;"><span>readelf -l &lt;ELFæ–‡ä»¶&gt;
</span></span><span style="display:flex;"><span><span style="color:#75715e"># æŸ¥çœ‹èŠ‚é¦–éƒ¨è¡¨</span>
</span></span><span style="display:flex;"><span>readelf -S &lt;ELFæ–‡ä»¶&gt;
</span></span></code></pre></div><p>â€ƒELFè§£æç¨‹åº  <br>
â€‚â€ƒ<code>linux-5.10.102/fs/binfmt_elf.c</code> è§£æ64ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ— å…³ <br>
â€‚â€ƒ<code>linux-5.10.102/fs/compat_binfmt_elf.c</code>  åœ¨64ä½å†…æ ¸ä¸­è§£æ32ä½ELFç¨‹åºï¼Œå’Œå¤„ç†å™¨æ¶æ„æ—    \</p>
<p>â€ƒè£…è½½ELFç¨‹åºå‡½æ•°<code>load_elf_binary</code></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103112822.png" alt="20221103112822"  />
</p>
<p>â€‚â€ƒ1ï¼‰æ£€æŸ¥ELFé¦–éƒ¨ï¼Œæ£€æŸ¥æ˜¯ä¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…±äº«åº“ï¼Œæ£€æŸ¥å¤„ç†å™¨æ¶æ„
â€‚â€ƒ2ï¼‰è¯»å–ç¨‹åºé¦–éƒ¨è¡¨
â€‚â€ƒ3ï¼‰ç¨‹åºé¦–éƒ¨è¡¨ä¸­æŸ¥æ‰¾è§£é‡Šå™¨æ®µï¼Œå¦‚ç¨‹åºéœ€è¦é“¾æ¥åŠ¨æ€åº“ï¼Œå­˜åœ¨è§£é‡Šå™¨æ®µï¼Œä»è§£é‡Šå™¨æ®µè¯»å–è§£é‡Šå™¨çš„æ–‡ä»¶åç§°ï¼Œæ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–ELFé¦–éƒ¨ã€‚
â€‚â€ƒ4ï¼‰æ£€æŸ¥è§£é‡Šå™¨çš„ELFé¦–éƒ¨ï¼Œè¯»å–è§£é‡Šå™¨çš„ç¨‹åºé¦–éƒ¨è¡¨
â€‚â€ƒ5ï¼‰flush_old_execå‡½æ•°ç»ˆæ­¢çº¿ç¨‹ç»„ä¸­å…¶ä»–çº¿ç¨‹ï¼Œé‡Šæ”¾æ—§çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´
â€‚â€ƒ6ï¼‰setup_new_execå‡½æ•°è°ƒç”¨arch_pick_mmap_layoutè®¾ç½®å†…å­˜æ˜ å°„çš„å¸ƒå±€ï¼Œåœ¨å †å’Œæ ˆç›´æ¥æœ‰ä¸€ä¸ªå†…å­˜æ˜ å°„åŒºåŸŸ
â€‚â€ƒ7ï¼‰ä¹‹å‰è°ƒç”¨bprm_mm_initå‡½æ•°åˆ›å»ºä¸´æ—¶ç”¨æˆ·æ ˆï¼Œè°ƒç”¨set_arg_pageså‡½æ•°æŠŠç”¨æˆ·æ ˆå®šä¸‹æ¥ï¼Œæ›´æ–°ç”¨æˆ·æ ˆæ ‡å¿—ä½å’Œè®¿é—®æƒé™ï¼ŒæŠŠç”¨æˆ·æ ˆç§»åŠ¨åˆ°æœ€ç»ˆä½ç½®ï¼Œå¹¶æ‰©å¤§ç”¨æˆ·æ ˆ
â€‚â€ƒ8ï¼‰æŠŠå¯åŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´
â€‚â€ƒ9ï¼‰setbrkå‡½æ•°æŠŠåˆå§‹åŒ–æ•°æ®æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå¹¶è®¾ç½®å †çš„èµ·å§‹è™šæ‹Ÿåœ°å€ï¼Œè°ƒç”¨padzeroå‡½æ•°ç”¨é›¶å¡«å……æœªåˆå§‹åŒ–æ•°æ®æ®µ
â€‚â€ƒ10ï¼‰å¾—åˆ°ç¨‹åºå…¥å£ã€‚ç¨‹åºæœ‰è§£é‡Šå™¨æ®µï¼ŒåŠ è½½æ®µæ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç¨‹åºå…¥å£åˆ‡æ¢ä¸ºè§£é‡Šå™¨ç¨‹åºå…¥å£
â€‚â€ƒ11ï¼‰è°ƒç”¨create_elf_tablesä¾æ¬¡æŠŠä¼ é€’ELFè§£é‡Šå™¨ä¿¡æ¯çš„è¾…åŠ©å‘é‡ã€ç¯å¢ƒæŒ‡é’ˆæ•°ç»„envpã€å‚æ•°æŒ‡é’ˆæ•°ç»„argvå’Œå‚æ•°ä¸ªæ•°argcå‹åˆ°è¿›ç¨‹çš„ç”¨æˆ·æ ˆ
â€‚â€ƒ12ï¼‰è°ƒç”¨å‡½æ•°start_threadè®¾ç½®ç»“æ„ä½“pt_regsä¸­ç¨‹åºè®¡æ•°å™¨å’Œæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼ŒARM64æ¶æ„å®šä¹‰çš„å‡½æ•°start_thread</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/include/asm/processor.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start_thread_common</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pc)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memset</span>(regs, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(<span style="color:#f92672">*</span>regs));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">forget_syscall</span>(regs);
</span></span><span style="display:flex;"><span>	regs<span style="color:#f92672">-&gt;</span>pc <span style="color:#f92672">=</span> pc; <span style="color:#75715e">/* æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®ä¸ºç¨‹åºçš„å…¥å£ */</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">start_thread</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pc,
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> sp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">start_thread_common</span>(regs, pc);
</span></span><span style="display:flex;"><span>	regs<span style="color:#f92672">-&gt;</span>pstate <span style="color:#f92672">=</span> PSR_MODE_EL0t;  <span style="color:#75715e">/* æŠŠå¤„ç†å™¨çŠ¶æ€è®¾ç½®ä¸º0ï¼Œå…¶ä¸­å¼‚å¸¸çº§åˆ«æ˜¯0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">spectre_v4_enable_task_mitigation</span>(current);
</span></span><span style="display:flex;"><span>	regs<span style="color:#f92672">-&gt;</span>sp <span style="color:#f92672">=</span> sp;   <span style="color:#75715e">/*è®¾ç½®ç”¨æˆ·æ ˆæŒ‡é’ˆ */</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3è£…è½½è„šæœ¬ç¨‹åº">3.è£…è½½è„šæœ¬ç¨‹åº<a hidden class="anchor" aria-hidden="true" href="#3è£…è½½è„šæœ¬ç¨‹åº">#</a></h4>
<p>â€‚è„šæœ¬ç¨‹åºå‰ä¸¤ä¸ªå­—èŠ‚æ˜¯<code>#!</code>ï¼Œåé¢æ˜¯è§£é‡Šå™¨ç¨‹åºçš„åç§°å’Œå‚æ•°ã€‚è§£é‡Šå™¨ç”¨æ¥æ‰§è¡Œè„šæœ¬ç¨‹åº
â€ƒ<code>linux-5.10.102/fs/binfmt_script.c</code>å‡½æ•°<code>load_script</code>è´Ÿè´£è£…è½½è„šæœ¬ç¨‹åº</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103141127.png" alt="20221103141127"  />
</p>
<p>â€‚â€ƒ1ï¼‰æ£€æŸ¥å‰ä¸¤ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯è„šæœ¬ç¨‹åºçš„æ ‡è¯†ç¬¦    <br>
â€‚â€ƒ2ï¼‰è§£æå¤„è§£é‡Šç¨‹åºçš„åç§°å’Œå‚æ•°      <br>
â€‚â€ƒ3ï¼‰ä»ç”¨æˆ·æ ˆåˆ é™¤ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¾æ¬¡æŠŠè„šæœ¬ç¨‹åºçš„æ–‡ä»¶åç§°ã€ä¼ ç»™è§£é‡Šç¨‹åºçš„å‚æ•°å’Œè§£é‡Šç¨‹åºçš„åç§°å‹åˆ°ç”¨æˆ·æ ˆ      <br>
â€‚â€ƒ4ï¼‰è°ƒç”¨opens_execæ‰“å¼€è§£é‡Šç¨‹åºæ–‡ä»¶       <br>
â€‚â€ƒ5ï¼‰è°ƒç”¨å‡½æ•°prepare_binprmè®¾ç½®è¿›ç¨‹è¯ä¹¦ï¼Œç„¶åè¯»å–è§£é‡Šç¨‹åºæ–‡ä»¶çš„å‰128å­—èŠ‚åˆ°ç¼“å†²åŒº        <br>
â€‚â€ƒ6ï¼‰è°ƒç”¨å‡½æ•°search_binary_handlerï¼Œå°è¯•æ³¨å†Œè¿‡çš„æ¯ç§äºŒè¿›åˆ¶æ ¼å¼çš„å¤„ç†ç¨‹åºï¼Œç›´åˆ°æŸä¸ªå¤„ç†ç¨‹åºè¯†åˆ«è§£é‡Šç¨‹åºä¸ºæ­¢     \</p>
<h2 id="26-è¿›ç¨‹é€€å‡º">2.6 è¿›ç¨‹é€€å‡º<a hidden class="anchor" aria-hidden="true" href="#26-è¿›ç¨‹é€€å‡º">#</a></h2>
<p>â€‚è¿›ç¨‹é€€å‡ºä¸¤ç§æƒ…å†µï¼šè¿›ç¨‹ä¸»åŠ¨é€€å‡ºå’Œç»ˆæ­¢è¿›ç¨‹    <br>
â€‚Linuxå†…æ ¸ä¸¤ä¸ªä¸»åŠ¨é€€å‡ºçš„ç³»ç»Ÿè°ƒç”¨       \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// çº¿ç¨‹é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exit</span>(<span style="color:#66d9ef">int</span> status);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸€ä¸ªçº¿ç¨‹ç»„æ‰€æœ‰çº¿ç¨‹é€€å‡º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">exit_group</span>(<span style="color:#66d9ef">int</span> status);
</span></span></code></pre></div><p>â€ƒglibcåº“å‡½æ•°exitã€_exitå’Œ_Exitç”¨æ¥ä½¿è¿›ç¨‹é€€å‡ºï¼Œåº“å‡½æ•°è°ƒç”¨ç³»ç»Ÿè°ƒç”¨exit_groupã€‚åº“å‡½æ•°exitä¼šæ‰§è¡Œè¿›ç¨‹ä½¿ç”¨çš„atexitå’Œos_exitæ³¨å†Œçš„å‡½æ•°        <br>
â€‚â€ƒç»ˆæ­¢è¿›ç¨‹æ˜¯é€€å‡ºç»™è¿›ç¨‹å‘é€ä¿¡å·å®ç°çš„ï¼ŒLinuxè®·æ²³å‘é€ä¿¡å·çš„ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‘é€ä¿¡å·ç»™è¿›ç¨‹æˆ–è¿›ç¨‹ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">kill</span>(<span style="color:#66d9ef">pid_t</span> pid, <span style="color:#66d9ef">int</span> sig);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‘é€ä¿¡å·ç»™çº¿ç¨‹  å·²åºŸå¼ƒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tkill</span>(<span style="color:#66d9ef">int</span> tid, <span style="color:#66d9ef">int</span> sig);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‘é€ä¿¡å·ç»™çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">tgkill</span>(<span style="color:#66d9ef">int</span> tgid, <span style="color:#66d9ef">int</span> tid, <span style="color:#66d9ef">int</span> sig);
</span></span></code></pre></div><p>â€ƒçˆ¶è¿›ç¨‹æ˜¯å¦å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹å‡ï¼Œ
â€‚â€ƒ1ï¼‰çˆ¶è¿›ç¨‹å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶é‡Šæ”¾å„ç§èµ„æºï¼Œç•™ç©ºè¿›ç¨‹æè¿°ç¬¦çš„åƒµå°¸è¿›ç¨‹ï¼Œå‘é€ä¿¡å·SIGCHLD(CHILDæ˜¯child)é€šçŸ¥çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æŸ¥è¯¢è¿›ç¨‹ç»ˆæ­¢åŸå› ä»å­è¿›ç¨‹æ”¶å›è¿›ç¨‹æè¿°ç¬¦ã€‚è¿›ç¨‹é»˜è®¤å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨sigactionå¯¹ä¿¡å·SIGHLDè®¾ç½®æ ‡å¿—SA_NOCLDWAIT(CLDæ˜¯child)ï¼Œå­è¿›ç¨‹é€€å‡ºæ—¶ä¸å˜æˆåƒµå°¸è¿›ç¨‹æˆ–è®¾ç½®å¿½ç•¥ä¿¡å·SIGCHLD    <br>
â€‚â€ƒ2ï¼‰çˆ¶è¿›ç¨‹ä¸å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œè¿›ç¨‹é€€å‡ºæ˜¯é‡Šæ”¾å„ç§èµ„æºï¼Œé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦ <br>
â€ƒLinuxå†…æ ¸3ä¸ªç³»ç»Ÿè°ƒç”¨ç­‰å¾…å­è¿›ç¨‹çŠ¶æ€æ”¹å˜ï¼šå­è¿›ç¨‹ç»ˆæ­¢ã€ä¿¡å·SIGSTOPä½¿å­è¿›ç¨‹åœæ­¢æ‰§è¡Œæˆ–ä¿¡å·SIGCONTä½¿å­è¿›ç¨‹ç»§ç»­æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">pid_t</span> <span style="color:#a6e22e">waitpid</span>(<span style="color:#66d9ef">pid_t</span> pid, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>wstatus, <span style="color:#66d9ef">int</span> options);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">waitid</span>(<span style="color:#66d9ef">idtype_t</span> idtype, <span style="color:#66d9ef">id_t</span> id, <span style="color:#66d9ef">siginfo_t</span> <span style="color:#f92672">*</span>infop, <span style="color:#66d9ef">int</span> options);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pit_t</span> <span style="color:#a6e22e">wiat4</span>(<span style="color:#66d9ef">pit_t</span> pid, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>wstatus, <span style="color:#66d9ef">int</span> options, staruct usage <span style="color:#f92672">*</span>rusage);  <span style="color:#75715e">// åºŸå¼ƒ
</span></span></span></code></pre></div><p>â€ƒçˆ¶è¿›ç¨‹é€€å‡ºæ—¶ï¼Œç»™å­è¿›ç¨‹å¯»æ‰¾é¢†å…»è€…
â€‚â€ƒ1ï¼‰è¿›ç¨‹å±äºä¸€ä¸ªçº¿ç¨‹ç»„ï¼Œä¸”è¿˜æœ‰å…¶ä»–çº¿ç¨‹ï¼Œé€‰æ‹©ä»»æ„å…¶ä»–çº¿ç¨‹   <br>
â€‚â€ƒ2ï¼‰é€‰æ‹©æœ€äº²è¿‘çš„å……å½“&quot;æ›¿è¡¥é¢†å…»è€…&quot;çš„ç¥–å…ˆè¿›ç¨‹ï¼Œè¿›ç¨‹ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨prtctl(PR_SET_CHILD_SUBREAPER)è®¾ç½®ä¸ºæ›¿æ¢é¢†å…»è€…     <br>
â€‚â€ƒ3ï¼‰é€‰æ‹©æ‰€å±è¿›ç¨‹å·å‘½åç©ºé—´çš„1å·è¿›ç¨‹      <br>
â€‚â€ƒ</p>
<h3 id="261-çº¿ç¨‹ç»„é€€å‡º-exit_group">2.6.1 çº¿ç¨‹ç»„é€€å‡º exit_group<a hidden class="anchor" aria-hidden="true" href="#261-çº¿ç¨‹ç»„é€€å‡º-exit_group">#</a></h3>
<p>â€ƒ ç³»ç»Ÿè°ƒç”¨exit_groupæ‰§è¡Œæµç¨‹</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103145928.png" alt="20221103145928"  />
</p>
<p>â€ƒä¸€ä¸ªçº¿ç¨‹ç»„çš„ä¸¤ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1å’Œçº¿ç¨‹2ï¼Œçº¿ç¨‹1è°ƒç”¨exit_groupä½¿çº¿ç¨‹ç»„é€€å‡ºï¼Œçº¿ç¨‹1æ‰§è¡Œæµç¨‹ï¼š
â€ƒ1ï¼‰æŠŠé€€å‡ºç ä¿å­˜åœ¨ç»“æ„ä½“æˆå‘˜group_exit_codeä¸­ï¼Œä¼ é€’ç»™çº¿ç¨‹2    <br>
â€ƒ2ï¼‰ç»™çº¿ç¨‹ç»„è®¾ç½®æ­£åœ¨é€€å‡ºæ ‡å¿—     <br>
â€ƒ3ï¼‰å‘çº¿ç¨‹2å‘é€æ€æ­»ä¿¡å·ï¼Œå”¤é†’çº¿ç¨‹2ï¼Œçº¿ç¨‹2å¤„ç†æ€æ­»ä¿¡å·    <br>
â€ƒ4ï¼‰çº¿ç¨‹1è°ƒç”¨å‡½æ•°do_exitä»¥é€€å‡º    <br>
â€ƒçº¿ç¨‹2é€€å‡ºçš„æ‰§è¡Œæµç¨‹ï¼Œå‡½æ•°do_group_exitæ‰§è¡Œæµç¨‹</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103151545.png" alt="20221103151545"  />
</p>
<p>â€ƒçº¿ç¨‹2å¯èƒ½å‘æŒ¥ç”¨æˆ·æ¨¡å¼3ç§æƒ…å†µ
â€ƒï¼ˆ1ï¼‰æ‰§è¡Œå®Œç³»ç»Ÿè°ƒç”¨      <br>
â€ƒï¼ˆ2ï¼‰è¢«ä¸­æ–­æŠ¢å ï¼Œä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œå®Œ    <br>
â€ƒï¼ˆ3ï¼‰æ‰§è¡ŒæŒ‡ä»¤æ˜¯ç”Ÿæˆå¼‚å¸¸ï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºæ‰§è¡Œå®Œ     \</p>
<p>â€ƒdo_exitå‡½æ•°æ‰§è¡Œæµç¨‹
â€ƒï¼ˆ1ï¼‰é‡Šæ”¾å„ç§èµ„æºï¼ŒæŠŠèµ„æºå¼•ç”¨è®¡æ•°å‡ä¸€ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œåˆ™é‡Šæ”¾æ•°æ®ç»“æ„   <br>
â€ƒï¼ˆ2ï¼‰è°ƒç”¨å‡½æ•°exit_notifyï¼Œä¸ºå­è¿›ç¨‹é€‰æ‹©é¢†å…»è€…ï¼Œç„¶åæŠŠè‡ªå·±æ­»è®¯é€šçŸ¥çˆ¶è¿›ç¨‹   <br>
â€ƒï¼ˆ3ï¼‰æŠŠè¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸ºæ­»äº¡(TASK_DEAD)     <br>
â€ƒï¼ˆ4ï¼‰æœ€åä¸€æ¬¡è°ƒç”¨å‡½æ•°__scheduleä»¥è°ƒåº¦è¿›ç¨‹    <br>
â€ƒæ­»äº¡è¿›ç¨‹è°ƒç”¨__scheduleæ—¶è¿›ç¨‹è°ƒåº¦å™¨å¤„ç†æµç¨‹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__schedule</span>() <span style="color:#f92672">--&gt;</span> <span style="color:#a6e22e">context_switch</span>() <span style="color:#f92672">--&gt;</span> <span style="color:#a6e22e">finish_task_switch</span>()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span><span style="color:#a6e22e">finish_task_switch</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev)
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">__releases</span>(rq<span style="color:#f92672">-&gt;</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	prev_state <span style="color:#f92672">=</span> prev<span style="color:#f92672">-&gt;</span>state;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(prev_state <span style="color:#f92672">==</span> TASK_DEAD)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (prev<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span>task_dead)
</span></span><span style="display:flex;"><span>			prev<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">task_dead</span>(prev);  <span style="color:#75715e">// æ‰§è¡Œè°ƒåº¦ç±»task_dead
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å¦‚æœç»“æ„ä½“thread_infoæ”¾åœ¨è¿›ç¨‹æè¿°ç¬¦é‡Œé¢ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// è€Œä¸æ˜¯æ”¾åœ¨å†…æ ¸æ ˆçš„é¡¶éƒ¨ï¼Œé‚£ä¹ˆé‡Šæ”¾è¿›ç¨‹çš„å†…æ ¸æ ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">put_task_stack</span>(prev);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// è¿›ç¨‹æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œé‚£ä¹ˆé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">put_task_struct</span>(prev);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="262-ç»ˆæ­¢è¿›ç¨‹">2.6.2 ç»ˆæ­¢è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#262-ç»ˆæ­¢è¿›ç¨‹">#</a></h3>
<p>â€ƒç³»ç»Ÿè°ƒç”¨killå‘çº¿ç¨‹ç»„æˆ–è¿›ç¨‹ç»„å‘é€ä¿¡å·linux-5.10.102/kernel/signal.cï¼Œæ‰§è¡Œæµç¨‹
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103154752.png" alt="20221103154752"  />
</p>
<p>â€ƒå‡½æ•°__send_signalä¸»è¦ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/signal.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">__send_signal</span>(<span style="color:#66d9ef">int</span> sig, <span style="color:#66d9ef">struct</span> siginfo <span style="color:#f92672">*</span>info, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>t,
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">int</span> group, <span style="color:#66d9ef">int</span> from_ancestor_ns)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sigpending <span style="color:#f92672">*</span>pending;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sigqueue <span style="color:#f92672">*</span>q;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> override_rlimit;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, result;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	result <span style="color:#f92672">=</span> TRACE_SIGNAL_IGNORED;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç›®æ ‡çº¿ç¨‹å¿½ç•¥ä¿¡å·,ä¸å‘é€ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">prepare_signal</span>(sig, t,
</span></span><span style="display:flex;"><span>			from_ancestor_ns <span style="color:#f92672">||</span> (info <span style="color:#f92672">==</span> SEND_SIG_FORCED)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> ret;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç¡®å®šæŠŠä¿¡å·æ·»åŠ åˆ°å“ªä¸ªä¿¡å·é˜Ÿåˆ—å’Œé›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pending <span style="color:#f92672">=</span> group <span style="color:#f92672">?</span> <span style="color:#f92672">&amp;</span>t<span style="color:#f92672">-&gt;</span>signal<span style="color:#f92672">-&gt;</span>shared_pending : <span style="color:#f92672">&amp;</span>t<span style="color:#f92672">-&gt;</span>pending;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	result <span style="color:#f92672">=</span> TRACE_SIGNAL_ALREADY_PENDING;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¼ ç»Ÿä¿¡å·ï¼Œå¹¶ä¸”ä¿¡å·é›†åˆå·²ç»åŒ…å«åŒä¸€ä¸ªä¿¡å·,ä¸å‘é€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">legacy_queue</span>(pending, sig))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆ¤æ–­åˆ†é…ä¿¡å·é˜Ÿåˆ—èŠ‚ç‚¹æ—¶æ˜¯å¦å¯ä»¥å¿½ç•¥ä¿¡å·é˜Ÿåˆ—é•¿åº¦çš„é™åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (sig <span style="color:#f92672">&lt;</span> SIGRTMIN)
</span></span><span style="display:flex;"><span>		override_rlimit <span style="color:#f92672">=</span> (<span style="color:#a6e22e">is_si_special</span>(info) <span style="color:#f92672">||</span> info<span style="color:#f92672">-&gt;</span>si_code <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		override_rlimit <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆ†é…ä¸€ä¸ªä¿¡å·é˜Ÿåˆ—èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	q <span style="color:#f92672">=</span> <span style="color:#a6e22e">__sigqueue_alloc</span>(sig, t, GFP_ATOMIC <span style="color:#f92672">|</span> __GFP_NOTRACK_FALSE_POSITIVE,
</span></span><span style="display:flex;"><span>		override_rlimit);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (q) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">list_add_tail</span>(<span style="color:#f92672">&amp;</span>q<span style="color:#f92672">-&gt;</span>list, <span style="color:#f92672">&amp;</span>pending<span style="color:#f92672">-&gt;</span>list); <span style="color:#75715e">// æ·»åŠ åˆ°ä¿¡å·é˜Ÿåˆ—ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_si_special</span>(info)) {
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>out_set:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signalfd_notify</span>(t, sig);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sigaddset</span>(<span style="color:#f92672">&amp;</span>pending<span style="color:#f92672">-&gt;</span>signal, sig);  <span style="color:#75715e">// ä¿¡å·æ·»åŠ åˆ°ä¿¡å·é›†åˆä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// åœ¨çº¿ç¨‹ç»„ä¸­æŸ¥æ‰¾ä¸€ä¸ªæ²¡æœ‰å±è”½ä¿¡å·çš„çº¿ç¨‹ï¼Œå”¤é†’å®ƒï¼Œè®©å®ƒå¤„ç†ä¿¡å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">complete_signal</span>(sig, t, group); 
</span></span><span style="display:flex;"><span>ret:
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="263-æŸ¥è¯¢å­è¿›ç¨‹ç»ˆæ­¢åŸå› ">2.6.3 æŸ¥è¯¢å­è¿›ç¨‹ç»ˆæ­¢åŸå› <a hidden class="anchor" aria-hidden="true" href="#263-æŸ¥è¯¢å­è¿›ç¨‹ç»ˆæ­¢åŸå› ">#</a></h3>
<p>â€‚ç³»ç»Ÿè°ƒç”¨waitid</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">waitid</span>(<span style="color:#66d9ef">idtype_t</span> idtype, <span style="color:#66d9ef">id_t</span> id, <span style="color:#66d9ef">siginfo_t</span> <span style="color:#f92672">*</span>infop, <span style="color:#66d9ef">int</span> options);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pid_t</span> <span style="color:#a6e22e">waitpid</span>(<span style="color:#66d9ef">pid_t</span> pid, <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>wstatus, <span style="color:#66d9ef">int</span> options);
</span></span></code></pre></div><table>
	<tr>
	    <th>å‚æ•°</th>
	    <th>å‚æ•°å€¼</th>
	    <th>å«ä¹‰</th>  
	</tr >
	<tr >
	    <td rowspan="3">idtype</td>
	    <td>P_ALL</td>
	    <td>ç­‰å¾…ä»»æ„å­è¿›ç¨‹ï¼Œå¿½ç•¥å‚æ•°id</td>
	</tr>
	<tr>
	    <td>P_PID</td>
	    <td>ç­‰å¾…è¿›ç¨‹å·ä¸ºidçš„å­è¿›ç¨‹</td>
	</tr>
	<tr>
	    <td>P_PGID</td>
	    <td>ç­‰å¾…è¿›ç¨‹ç»„æ ‡è¯†ç¬¦æ˜¯idçš„ä»»æ„å­è¿›ç¨‹</td>
	</tr>
	<tr >
	    <td rowspan="5">options</td>
	    <td>WEXITED</td>
	    <td>ç­‰å¾…é€€å‡ºçš„å­è¿›ç¨‹</td>
	</tr>
	<tr>
	    <td >WSTOPPED</td>
	    <td>ç­‰å¾…æ”¶åˆ°ä¿¡å·SIGSTOPå¹¶åœæ­¢æ‰§è¡Œçš„å­è¿›ç¨‹</td>
	</tr>
	<tr>
	    <td >WCONTINUED</td>
	    <td >ç­‰å¾…æ”¶åˆ°ä¿¡å·SIGCONTå¹¶ç»§ç»­æ‰§è¡Œçš„å­è¿›ç¨‹</td>
	</tr>
	<tr>
	    <td >WNOHANG</td>
	    <td >å¦‚æœæ²¡æœ‰å­è¿›ç¨‹é€€å‡ºï¼Œç«‹å³è¿”å›</td>
	</tr>
	<tr>
	    <td >WNOWAIT</td>
	    <td >è®©å­è¿›ç¨‹å¤„äºåƒµå°¸çŠ¶æ€ï¼Œä»¥åå¯ä»¥å†æ¬¡æŸ¥è¯¢çŠ¶æ€ä¿¡æ¯</td>
	</tr>
</table>
<p>â€ƒdo_waitå‡½æ•°æ‰§è¡Œæµç¨‹</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103162302.png" alt="20221103162302"  />
</p>
<h2 id="27-è¿›ç¨‹çŠ¶æ€">2.7 è¿›ç¨‹çŠ¶æ€<a hidden class="anchor" aria-hidden="true" href="#27-è¿›ç¨‹çŠ¶æ€">#</a></h2>
<table>
	<tr>
	    <th>çŠ¶æ€</th>
	    <th>state</th>
	    <th>å«ä¹‰</th>  
	</tr >
	<tr >
	    <td>å°±ç»ªçŠ¶æ€</td>
	    <td>TASK_RUNNING</td>
	    <td>æ­£åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…è°ƒåº¦å™¨è°ƒåº¦</td>
	</tr>
	<tr>
	    <td>è¿è¡ŒçŠ¶æ€</td>
	    <td>TASK_RUNNING</td>
	    <td>è¢«è°ƒåº¦å™¨é€‰ä¸­ï¼Œæ­£åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œ</td>
	</tr>
	<tr>
	    <td>è½»åº¦ç¡çœ </td>
	    <td>TASK_INTERRUPTIBLE</td>
	    <td>å¯ä¿¡å·æ‰“æ–­çš„ç¡çœ çŠ¶æ€</td>
	</tr>
	<tr >
	    <td>ä¸­åº¦ç¡çœ </td>
	    <td>TASK_KILLABLE</td>
	    <td>åªèƒ½è¢«è‡´å‘½çš„ä¿¡å·æ‰“æ–­</td>
	</tr>
	<tr>
	    <td>æ·±åº¦ç¡çœ </td>
	    <td>TASK_UNINTERRUPTIBLE</td>
	    <td>ä¸å¯æ‰“æ–­çš„ç¡çœ çŠ¶æ€</td>
	</tr>
	<tr>
	    <td>åƒµå°¸çŠ¶æ€</td>
	    <td>TASK_DEAD</td>
	    <td>è¢«è°ƒåº¦å™¨é€‰ä¸­ï¼Œæ­£åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œ</td>
	</tr>
	<tr>
	    <td>æ­»äº¡çŠ¶æ€</td>
	    <td>TASK_DEAD</td>
	    <td>å¦‚æœçˆ¶è¿›ç¨‹ä¸å…³æ³¨å­è¿›ç¨‹é€€å‡ºäº‹ä»¶ï¼Œé‚£ä¹ˆå­è¿›ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨æ¶ˆäº¡</td>
	</tr>
</table>
<p>â€ƒè¿›ç¨‹çŠ¶æ€å˜è¿
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221103163416.png" alt="20221103163416"  />
</p>
<h2 id="28-è¿›ç¨‹è°ƒåº¦">2.8 è¿›ç¨‹è°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#28-è¿›ç¨‹è°ƒåº¦">#</a></h2>
<h3 id="281-è°ƒåº¦ç­–ç•¥">2.8.1 è°ƒåº¦ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#281-è°ƒåº¦ç­–ç•¥">#</a></h3>
<p>â€‚Linuxå†…æ ¸æ”¯æŒçš„è°ƒåº¦ç­–ç•¥
â€ƒï¼ˆ1ï¼‰é™åˆ¶è¿›ç¨‹ä½¿ç”¨é™æœŸè°ƒåº¦ç­–ç•¥(SCHED_DEADLINE)ï¼Œ3ä¸ªå‚æ•°ï¼šè¿è¡Œæ—¶é—´runtimeï¼Œæˆªæ­¢æœŸé™deadlineå’Œå‘¨æœŸperiod    <br>
â€ƒï¼ˆ2ï¼‰å®æ—¶è¿›ç¨‹æ”¯æŒä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼šå…ˆè¿›å…ˆå‡ºè°ƒåº¦(SCHED_FIFO)å’Œè½®æµè°ƒåº¦(SCHED_RR)   <br>
â€ƒï¼ˆ3ï¼‰æ™®é€šè¿›ç¨‹ä¸¤ç§è°ƒåº¦ç­–ç•¥ï¼šæ ‡å‡†è½®æµåˆ†æ—¶(SCHED_NORMAL)å’Œç©ºé—²(SCHED_BATCH)ï¼ŒLinuxå†…æ ¸å¼•å…¥å®Œå…¨å…¬å¹³è°ƒåº¦ç®—æ³•åï¼Œæ‰¹é‡è°ƒåº¦ç­–ç•¥åºŸå¼ƒã€‚     \</p>
<h3 id="282-è¿›ç¨‹ä¼˜å…ˆçº§">2.8.2 è¿›ç¨‹ä¼˜å…ˆçº§<a hidden class="anchor" aria-hidden="true" href="#282-è¿›ç¨‹ä¼˜å…ˆçº§">#</a></h3>
<p>â€‚é™æœŸè¿›ç¨‹çš„ä¼˜å…ˆçº§æ¯”å®æ—¶è¿›ç¨‹é«˜ï¼Œå®æ—¶è¿›ç¨‹çš„ä¼˜å…ˆçº§æ¯”æ™®é€šè¿›ç¨‹é«˜ã€‚  <br>
â€‚é™æœŸè¿›ç¨‹çš„ä¼˜å…ˆçº§æ˜¯âˆ’1ã€‚        <br>
â€‚å®æ—¶è¿›ç¨‹çš„å®æ—¶ä¼˜å…ˆçº§æ˜¯1ï½99ï¼Œä¼˜å…ˆçº§æ•°å€¼è¶Šå¤§ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ã€‚    <br>
â€‚æ™®é€šè¿›ç¨‹çš„é™æ€ä¼˜å…ˆçº§æ˜¯100ï½139ï¼Œä¼˜å…ˆçº§æ•°å€¼è¶Šå°ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜ï¼Œå¯é€šè¿‡ä¿®æ”¹niceå€¼ï¼ˆå³ç›¸å¯¹ä¼˜å…ˆçº§ï¼Œå–å€¼èŒƒå›´æ˜¯âˆ’20ï½19ï¼‰æ”¹å˜æ™®é€šè¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§ç­‰äº120åŠ ä¸Šniceå€¼   <br>
â€ƒtask_structä¸­ï¼Œ4ä¸ªæˆå‘˜å’Œä¼˜å…ˆçº§æœ‰å…³   \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>include<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>sched.h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> task_struct {
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span>                  prio;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span>                  static_prio;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span>                  normal_prio;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>         rt_priority;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><table>
	<tr>
	    <th>ä¼˜å…ˆçº§</th>
	    <th>é™æœŸè¿›ç¨‹</th>
	    <th>å®æ—¶è¿›ç¨‹</th>  
	    <th>æ™®é€šè¿›ç¨‹</th>  
	</tr >
	<tr >
	    <td>prio<br>è°ƒåº¦ä¼˜å…ˆçº§(æ•°å€¼è¶Šå°ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜)</td>
	    <td colspan="3">å¤§å¤šæ•°prioç­‰äºnormal_prio</td>
	</tr>
	<tr>
	    <td>static_prio<br>é™æ€ä¼˜å…ˆçº§</td>
	    <td>æ€»æ˜¯0</td>
	    <td>æ€»æ˜¯0</td>
	    <td>120 + niceå€¼æ•°å€¼è¶Šå°ï¼Œ<br>è¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜</td>
	</tr>
	<tr>
	    <td>normal_prio<br>æ­£å¸¸ä¼˜å…ˆçº§(æ•°å€¼è¶Šå°ï¼Œè¡¨ç¤ºä¼˜å…ˆçº§è¶Šé«˜)</td>
	    <td>-1</td>
	    <td>99 âˆ’ rt_priority</td>
	    <td>static_prio</td>
	</tr>
		<tr>
	    <td>å®æ—¶ä¼˜å…ˆçº§</td>
	    <td>æ€»æ˜¯0</td>
	    <td>å€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜</td>
	    <td> </td>
	</tr>
</table>
<h3 id="283-è°ƒåº¦ç±»">2.8.3 è°ƒåº¦ç±»<a hidden class="anchor" aria-hidden="true" href="#283-è°ƒåº¦ç±»">#</a></h3>
<p>â€‚Linuxå†…æ ¸æŠ½è±¡ä¸€ä¸ªè°ƒåº¦ç±»<code>sched_class</code>ï¼Œç›®å‰å®ç°5ç§è°ƒåº¦ç±»ï¼Œä¼˜å…ˆçº§ä»ä¸Šåˆ°ä¸‹ä»é«˜åˆ°ä½ï¼š</p>
<table>
	<tr>
	    <th>è°ƒåº¦ç±»</th>
	    <th>è°ƒåº¦ç­–ç•¥</th>
	    <th>è°ƒåº¦ç®—æ³•</th>  
	    <th>è°ƒåº¦å¯¹è±¡</th>  
	</tr >
	<tr >
	    <td>åœæœºè°ƒåº¦ç±»<br>stop_sched_class</td>
	    <td>æ— </td>
	    <td>æ— </td>
	    <td>åœæœºè¿›ç¨‹</td>
	</tr>
	<tr>
	    <td>é™æœŸè°ƒåº¦ç±»<br>dl_sched_class</td>
	    <td>SCHED_DEADLINE</td>
	    <td>æœ€æ—©æœŸé™ä¼˜å…ˆ</td>
	    <td>é™æœŸè¿›ç¨‹</td>
	</tr>
	<tr>
	    <td>å®æ—¶è°ƒåº¦ç±»<br>rt_sched_class</td>
	    <td>SCHED_FIFO<br>SCHED_RR</td>
	    <td>å…ˆè¿›å…ˆå‡º<br>è½®æµè°ƒåº¦</td>
	    <td>å®æ—¶è¿›ç¨‹</td>
	</tr>
		<tr>
	    <td>å…¬å¹³è°ƒåº¦ç±»<br>cfs_sched_class</td>
	    <td>SCHED_NORMAL<br>SCHED_IDIE</td>
	    <td>å®Œå…¨å…¬å¹³è°ƒåº¦ç®—æ³•</td>
	    <td>æ™®é€šè¿›ç¨‹</td>
	</tr>
	</tr>
		<tr>
	    <td>ç©ºé—²è°ƒåº¦ç±»<br>idle_sched_class</td>
	    <td>æ— </td>
	    <td>æ— </td>
	    <td>æ¯ä¸ªå¤„ç†å™¨ä¸Šçš„ç©ºé—²çº¿ç¨‹</td>
	</tr>
</table>
<p>â€ƒè¯¦ç»†ä¿¡æ¯å‚è€ƒä¹¦ç±</p>
<h3 id="284-è¿è¡Œé˜Ÿåˆ—">2.8.4 è¿è¡Œé˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#284-è¿è¡Œé˜Ÿåˆ—">#</a></h3>
<p>â€‚æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼Œç»“æ„ä½“rqï¼Œå®šä¹‰å…¨å±€å˜é‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/cpuacct.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DEFINE_PER_CPU_SHARED_ALIGNED</span>(<span style="color:#66d9ef">struct</span> rq, runqueues);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/sched.h  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> rq { <span style="color:#75715e">// è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> cfs_rq		cfs;  <span style="color:#75715e">// å…¬å¹³è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> rt_rq		rt;   <span style="color:#75715e">// å®æ—¶è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> dl_rq		dl;   <span style="color:#75715e">// é™æœŸè¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct	<span style="color:#f92672">*</span>idle;  <span style="color:#75715e">// ç©ºé—²çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> task_struct	<span style="color:#f92672">*</span>stop;  <span style="color:#75715e">// è¿ç§»çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><h3 id="285-ä»»åŠ¡åˆ†ç»„">2.8.5 ä»»åŠ¡åˆ†ç»„<a hidden class="anchor" aria-hidden="true" href="#285-ä»»åŠ¡åˆ†ç»„">#</a></h3>
<h4 id="1ä»»åŠ¡åˆ†ç»„æ–¹å¼">1.ä»»åŠ¡åˆ†ç»„æ–¹å¼<a hidden class="anchor" aria-hidden="true" href="#1ä»»åŠ¡åˆ†ç»„æ–¹å¼">#</a></h4>
<table>
	<tr>
	    <th>ä»»åŠ¡åˆ†ç»„æ–¹å¼</th>
	    <th>æ§åˆ¶å®</th>
	    <th>é…ç½®æ–¹å¼</th>  
	</tr >
	<tr >
	    <td>è‡ªåŠ¨ç»„</td>
	    <td>CONFIG_SCHED_AUTOGROUP</td>
	    <td>/proc/sys/kernel/sched_autogroup_enabled <br>è¿è¡Œè¿‡ç¨‹ä¸­å¼€å¯å…³é—­ï¼Œé»˜è®¤å€¼1<br>æºæ–‡ä»¶kernel/sched/auto_group.c</td>
	</tr>
	<tr>
	    <td>CPUæ§åˆ¶ç»„ç‰ˆæœ¬1</td>
	    <td>CONFIG_CGROUPS<br>CONFIG_CGROUP_SCHED</td>
	    <td>mount -t tmpfs cgroup_root /sys/fs/cgroup<br>mkdir /sys/fs/cgroup/cpu<br>mount -t cgroup -o cpu none /sys/fs/cgroup/cpu<br>cd /sys/fs/cgroup/cpu<br>mkdir multimedia  # åˆ›å»º"multimedia"ä»»åŠ¡ç»„<br>mkdir browser     # åˆ›å»º"browser"ä»»åŠ¡ç»„<br>echo 2048 > multimedia/cpu.shares<br>echo 1024 > browser/cpu.shares<br>echo < pid1> > browser/tasks <br>echo < pid2> > multimedia/tasks<br>echo < pid1> > browser/cgroup.procs<br>echo < pid2> > multimedia/cgroup.procs</td>
	</tr>
	<tr>
	    <td>cgroupç‰ˆæœ¬2</td>
	    <td> </td>
	    <td>mount -t tmpfs cgroup_root /sys/fs/cgroup<br>mount -t cgroup2  none /sys/fs/cgroup<br>cd /sys/fs/cgroup <br>
echo "+cpu" > cgroup.subtree_control<br>mkdir multimedia   # åˆ›å»º"multimedia"ä»»åŠ¡ç»„ <br>mkdir browser      # åˆ›å»º"browser"ä»»åŠ¡ç»„<br>echo 2048 > multimedia/cpu.weight<br>echo 1024 > browser/cpu.weight<br>echo < pid1> > browser/cgroup.procs<br>echo < pid2> > multimedia/cgroup.procs <br>echo threaded > browser/cgroup.type <br> echo < pid1> > browser/cgroup.threads <br>echo threaded > multimedia/cgroup.type <br>echo < pid2> > multimedia/cgroup.threads
</td>
	</tr>
</table>
<h4 id="2-æ•°æ®ç»“æ„">2. æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#2-æ•°æ®ç»“æ„">#</a></h4>
<p>â€‚task_group,é»˜è®¤ä»»åŠ¡ç»„æ˜¯æ›´ä»»åŠ¡ç»„(å…¨å±€å˜é‡root_task_group)</p>
<table>
	<tr>
	    <th>æˆå‘˜</th>
	    <th>è¯´æ˜</th>
	</tr >
	<tr >
	    <td>const struct sched_class *sched_class</td>
	    <td>è°ƒåº¦ç±»</td>
	</tr>
	<tr >
	    <td>struct sched_entity se</td>
	    <td>å…¬å¹³è°ƒåº¦å®ä½“</td>
	</tr>
		<tr >
	    <td>struct sched_dl_entity dl</td>
	    <td>é™æœŸè°ƒåº¦å®ä½“</td>
	</tr>
</table>
<p>â€ƒä»»åŠ¡ç»„åœ¨æ¯ä¸ªå¤„ç†å™¨ä¸Šæœ‰å…¬å¹³è°ƒåº¦å®ä½“ã€å…¬å¹³è¿è¡Œé˜Ÿåˆ—ã€å®æ—¶è°ƒåº¦å®ä½“å’Œå®æ—¶è¿è¡Œé˜Ÿåˆ—ï¼Œæ ¹ä»»åŠ¡ç»„æ¯”è¾ƒç‰¹æ®Šï¼šæ²¡æœ‰å…¬å¹³è°ƒåº¦å®ä½“å’Œå®æ—¶è°ƒåº¦å®ä½“</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221104104612.png" alt="20221104104612"  />
</p>
<p>â€‚æ¯ä¸ªå¤„ç†å™¨ä¸Šï¼Œè®¡ç®—ä»»åŠ¡ç»„çš„å…¬å¹³è°ƒåº¦å®ä½“çš„æƒé‡çš„æ–¹æ³•å¦‚ä¸‹ï¼ˆå‚è€ƒæºæ–‡ä»¶â€œkernel/ sched/fair.câ€ä¸­çš„å‡½æ•°update_cfs_shares</p>
<h3 id="286-è°ƒåº¦è¿›ç¨‹">2.8.6 è°ƒåº¦è¿›ç¨‹<a hidden class="anchor" aria-hidden="true" href="#286-è°ƒåº¦è¿›ç¨‹">#</a></h3>
<p>â€‚è°ƒåº¦è¿›ç¨‹çš„æ ¸å¿ƒå‡½æ•°æ˜¯<code>__schedule()</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kernel<span style="color:#f92672">/</span>sched<span style="color:#f92672">/</span>core.c
</span></span><span style="display:flex;"><span><span style="color:#75715e">// preemptæ˜¯å¦æŠ¢å ï¼ŒtrueæŠ¢å è°ƒåº¦ï¼Œfalseä¸»åŠ¨è°ƒåº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> __sched notrace <span style="color:#a6e22e">__schedule</span>(<span style="color:#66d9ef">bool</span> preempt)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">1.</span> <span style="color:#960050;background-color:#1e0010">è°ƒç”¨</span>pick_next_task<span style="color:#960050;background-color:#1e0010">é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ae81ff">2.</span> <span style="color:#960050;background-color:#1e0010">è°ƒç”¨</span>context_switch<span style="color:#960050;background-color:#1e0010">åˆ‡æ¢è¿›ç¨‹</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="1é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹-å‡½æ•°pick_next_task">1.é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹ å‡½æ•°pick_next_task<a hidden class="anchor" aria-hidden="true" href="#1é€‰æ‹©ä¸‹ä¸€ä¸ªè¿›ç¨‹-å‡½æ•°pick_next_task">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pick_next_task</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev, <span style="color:#66d9ef">struct</span> rq_flags <span style="color:#f92672">*</span>rf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> sched_class <span style="color:#f92672">*</span>class;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Optimization: we know that if all tasks are in the fair class we can
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * call that function directly, but only if the @prev task wasn&#39;t of a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * higher scheduling class, because otherwise those loose the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * opportunity to pull in more work from other CPUs.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¼˜åŒ–ï¼šå¦‚æœæ‰€æœ‰è¿›ç¨‹å±äºå…¬å¹³è°ƒåº¦ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ç›´æ¥è°ƒç”¨å…¬å¹³è°ƒåº¦ç±»çš„pick_next_taskæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(prev<span style="color:#f92672">-&gt;</span>sched_class <span style="color:#f92672">&lt;=</span> <span style="color:#f92672">&amp;</span>fair_sched_class <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		   rq<span style="color:#f92672">-&gt;</span>nr_running <span style="color:#f92672">==</span> rq<span style="color:#f92672">-&gt;</span>cfs.h_nr_running)) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		p <span style="color:#f92672">=</span> <span style="color:#a6e22e">pick_next_task_fair</span>(rq, prev, rf);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(p <span style="color:#f92672">==</span> RETRY_TASK))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> restart;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Assumes fair_sched_class-&gt;next == idle_sched_class */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å‡å®šå…¬å¹³è°ƒåº¦ç±»çš„ä¸‹ä¸€ä¸ªè°ƒåº¦ç±»æ˜¯ç©ºé—²è°ƒåº¦ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>p) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put_prev_task</span>(rq, prev);
</span></span><span style="display:flex;"><span>			p <span style="color:#f92672">=</span> <span style="color:#a6e22e">pick_next_task_idle</span>(rq);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>restart:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">put_prev_task_balance</span>(rq, prev, rf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">for_each_class</span>(class) {
</span></span><span style="display:flex;"><span>		p <span style="color:#f92672">=</span> class<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">pick_next_task</span>(rq);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (p)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> p;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* The idle class should always have a runnable task: */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç©ºé—²è°ƒåº¦ç±»åº”è¯¥æ€»æ˜¯æœ‰ä¸€ä¸ªè¿è¡Œçš„è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">BUG</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>å¾…è¡¥å……</p>
</blockquote>
<h4 id="2åˆ‡æ¢è¿›ç¨‹-context_switch">2.åˆ‡æ¢è¿›ç¨‹ context_switch<a hidden class="anchor" aria-hidden="true" href="#2åˆ‡æ¢è¿›ç¨‹-context_switch">#</a></h4>
<blockquote>
<p>1ï¼‰switch_mm_irqs_offè´Ÿè´£åˆ‡æ¢è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´
2ï¼‰switch_toåˆ‡æ¢å¤„ç†å™¨çš„å¯„å­˜å™¨</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> __always_inline <span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">context_switch</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev,
</span></span><span style="display:flex;"><span>	       <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>next, <span style="color:#66d9ef">struct</span> rq_flags <span style="color:#f92672">*</span>rf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prepare_task_switch</span>(rq, prev, next); <span style="color:#75715e">// å‡†å¤‡å·¥ä½œï¼Œè°ƒç”¨prepare_arch_switch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* For paravirt, this is coupled with an exit in switch_to to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * combine the page table reload and the switch backend into
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * one hypercall. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å¼€å§‹ä¸Šä¸‹æ–‡åˆ‡æ¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">arch_start_context_switch</span>(prev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * kernel -&gt; kernel   lazy + transfer active
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *   user -&gt; kernel   lazy + mmgrab() active
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * kernel -&gt;   user   switch + mmdrop() active
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *   user -&gt;   user   switch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>next<span style="color:#f92672">-&gt;</span>mm) {                 <span style="color:#75715e">// to kernel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// é€šçŸ¥å¤„ç†å™¨æ¶æ„ä¸éœ€è¦åˆ‡æ¢ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼ŒåŠ é€Ÿè¿›ç¨‹åˆ‡æ¢çš„æŠ€æœ¯ç§°ä¸ºæƒ°æ€§TLB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">enter_lazy_tlb</span>(prev<span style="color:#f92672">-&gt;</span>active_mm, next);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		next<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> prev<span style="color:#f92672">-&gt;</span>active_mm;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (prev<span style="color:#f92672">-&gt;</span>mm)     <span style="color:#75715e">// from user åˆ‡æ¢è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">mmgrab</span>(prev<span style="color:#f92672">-&gt;</span>active_mm);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			prev<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {                                        <span style="color:#75715e">// to user
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">membarrier_switch_mm</span>(rq, prev<span style="color:#f92672">-&gt;</span>active_mm, next<span style="color:#f92672">-&gt;</span>mm);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * sys_membarrier() requires an smp_mb() between setting
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * rq-&gt;curr / membarrier_switch_mm() and returning to userspace.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * The below provides this either through switch_mm(), or in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * case &#39;prev-&gt;active_mm == next-&gt;mm&#39; through
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * finish_task_switch()&#39;s mmdrop().
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">switch_mm_irqs_off</span>(prev<span style="color:#f92672">-&gt;</span>active_mm, next<span style="color:#f92672">-&gt;</span>mm, next);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>prev<span style="color:#f92672">-&gt;</span>mm) {                        <span style="color:#75715e">// from kernel
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">/* will mmdrop() in finish_task_switch(). */</span>
</span></span><span style="display:flex;"><span>			rq<span style="color:#f92672">-&gt;</span>prev_mm <span style="color:#f92672">=</span> prev<span style="color:#f92672">-&gt;</span>active_mm;
</span></span><span style="display:flex;"><span>			prev<span style="color:#f92672">-&gt;</span>active_mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rq<span style="color:#f92672">-&gt;</span>clock_update_flags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>(RQCF_ACT_SKIP<span style="color:#f92672">|</span>RQCF_REQ_SKIP);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">prepare_lock_switch</span>(rq, next, rf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Here we just switch the register state and the stack. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åªåˆ‡æ¢å¯„å­˜å™¨çŠ¶æ€å’Œæ ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">switch_to</span>(prev, next, prev);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">barrier</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">finish_task_switch</span>(prev);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ï¼ˆ1ï¼‰åˆ‡æ¢ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ARM64æ¶æ„ä½¿ç”¨switch_mm_irqs_off
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>include<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>mmu_context.h
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef switch_mm_irqs_off
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define switch_mm_irqs_off switch_mm
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>â€‚ switch_mmå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/include/asm/mmu_context.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">switch_mm</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>prev, <span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>next,
</span></span><span style="display:flex;"><span>	  <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (prev <span style="color:#f92672">!=</span> next)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">__switch_mm</span>(next);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Update the saved TTBR0_EL1 of the scheduled-in task as the previous
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * value may have not been initialised yet (activate_mm caller) or the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * ASID has changed since the last run (following the context switch
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * of another thread of the same process).*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* æ›´æ–°è°ƒå…¥è¿›ç¨‹ä¿å­˜çš„å¯„å­˜å™¨TTBR0_EL1å€¼ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * å› ä¸ºå¯èƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼ˆè°ƒç”¨è€…æ˜¯å‡½æ•°activate_mmï¼‰ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * æˆ–è€…ASIDè‡ªä»ä¸Šæ¬¡è¿è¡Œä»¥æ¥å·²ç»æ”¹å˜ï¼ˆåœ¨åŒä¸€ä¸ªçº¿ç¨‹ç»„çš„å¦ä¸€ä¸ªçº¿ç¨‹åˆ‡æ¢ä¸Šä¸‹æ–‡ä»¥åï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * é¿å…æŠŠä¿ç•™çš„å¯„å­˜å™¨TTBR0_EL1å€¼è®¾ç½®ä¸ºswapper_pg_dirï¼ˆinit_mmï¼›ä¾‹å¦‚é€šè¿‡å‡½æ•°idle_task_exitï¼‰*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">update_saved_ttbr0</span>(tsk, next);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__switch_mm</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>next)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*init_mm.pgd does not contain any user mappings and it is always
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * active for kernel addresses in TTBR1. Just set the reserved TTBR0.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*init_mm.pgdæ²¡æœ‰åŒ…å«ä»»ä½•ç”¨æˆ·è™šæ‹Ÿåœ°å€çš„æ˜ å°„ï¼Œå¯¹äºTTBR1çš„å†…æ ¸è™šæ‹Ÿåœ°å€æ€»æ˜¯æœ‰æ•ˆçš„ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    * åªè®¾ç½®ä¿ç•™çš„TTBR0 */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (next <span style="color:#f92672">==</span> <span style="color:#f92672">&amp;</span>init_mm) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cpu_set_reserved_ttbr0</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¸ºè¿›ç¨‹åˆ†é…åœ°å€ç©ºé—´æ ‡è¯†ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">check_and_switch_context</span>(next);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>å¾…è¡¥å……</p>
</blockquote>
<p>â€‚ï¼ˆ2ï¼‰åˆ‡æ¢å¯„å­˜å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/include/asm-generic/switch_to.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define switch_to(prev, next, last)					\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	do {								\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		((last) = __switch_to((prev), (next)));			\
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	} while (0)
</span></span></span></code></pre></div><p>â€ƒå‡½æ•°__switch_to</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>__notrace_funcgraph <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span><span style="color:#a6e22e">__switch_to</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev,
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>next)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>last;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fpsimd_thread_switch</span>(next);  <span style="color:#75715e">// åˆ‡æ¢æµ®ç‚¹å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">tls_thread_switch</span>(next);  <span style="color:#75715e">// åˆ‡æ¢æœ¬åœ°å­˜å‚¨ç›¸å…³çš„å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">hw_breakpoint_thread_switch</span>(next);  <span style="color:#75715e">// åˆ‡æ¢åŠäº‹å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">contextidr_thread_switch</span>(next);  <span style="color:#75715e">// æŠŠä¸Šä¸‹æ–‡æ ‡è¯†ç¬¦å¯„å­˜å™¨CONTEXTIDR_EL1è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªè¿›ç¨‹å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">entry_task_switch</span>(next);  <span style="color:#75715e">// ä½¿ç”¨å¤„ç†å™¨å˜é‡__entry_taskè®°å½•ä¸‹ä¸€ä¸ªè¿›ç¨‹æè¿°ç¬¦çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">uao_thread_switch</span>(next);  <span style="color:#75715e">// æ ¹æ®ä¸‹ä¸€ä¸ªè¿›ç¨‹å¯è®¿é—®çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸Šé™æ¢å¤ç”¨æˆ·è®¿é—®è¦†ç›–ï¼ˆUser Access Overrideï¼ŒUAOï¼‰çŠ¶æ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ssbs_thread_switch</span>(next);  <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">erratum_1418040_thread_switch</span>(next);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Complete any pending TLB or cache maintenance on this CPU in case
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * the thread migrates to a different CPU.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * This full barrier is also required by the membarrier system
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * call.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨è¿™ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œå®Œå‰é¢çš„æ‰€æœ‰é¡µè¡¨ç¼“å­˜æˆ–è€…ç¼“å­˜ç»´æŠ¤æ“ä½œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä»¥é˜²çº¿ç¨‹è¿ç§»åˆ°å…¶ä»–å¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// æ•°æ®åŒæ­¥å±éšœï¼Œç¡®ä¿å±éšœå‰é¢çš„ç¼“å­˜ç»´æŠ¤æ“ä½œå’Œé¡µè¡¨ç¼“å­˜ç»´æŠ¤æ“ä½œæ‰§è¡Œå®Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dsb</span>(ish);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* MTE thread switching must happen after the DSB above to ensure that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * any asynchronous tag check faults have been logged in the TFSR*_EL1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * registers.*/</span> 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mte_thread_switch</span>(next);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* the actual thread switch */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å®é™…çº¿ç¨‹åˆ‡æ¢  åˆ‡æ¢é€šç”¨å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	last <span style="color:#f92672">=</span> <span style="color:#a6e22e">cpu_switch_to</span>(prev, next);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> last;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚1ï¼‰åˆ‡æ¢æµ®ç‚¹å¯„å­˜å™¨ï¼Œå‡½æ•°fpsimd_thread_switchè´Ÿè´£åˆ‡æ¢æµ®ç‚¹ï¼Œå†…æ ¸ä¸å…è®¸ä½¿ç”¨æµ®ç‚¹æ•°ï¼Œåªæœ‰ç”¨æˆ·ç©ºé—´å¯ä»¥ä½¿ç”¨æµ®ç‚¹æ•°,åˆ‡æ¢å‡ºå»çš„è¿›ç¨‹æŠŠæµ®ç‚¹å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.fpsimd_stateä¸­ã€‚ARM64æ¶æ„å®ç°çš„linux-5.10.102/arch/arm64/kernel/fpsimd.cå‡½æ•°fpsimd_thread_switch   \
â€‚2ï¼‰åˆ‡æ¢é€šç”¨å¯„å­˜å™¨ï¼Œ</p>
<ul>
<li>è¢«è°ƒç”¨å‡½æ•°è´Ÿè´£ä¿å­˜çš„å¯„å­˜å™¨x19ï½x28</li>
<li>å¯„å­˜å™¨x29ï¼Œå³å¸§æŒ‡é’ˆï¼ˆFrame Pointerï¼ŒFPï¼‰å¯„å­˜å™¨</li>
<li>æ ˆæŒ‡é’ˆï¼ˆStack Pointerï¼ŒSPï¼‰å¯„å­˜å™¨</li>
<li>å¯„å­˜å™¨x30ï¼Œå³é“¾æ¥å¯„å­˜å™¨ï¼ˆLink Registerï¼ŒLRï¼‰ï¼Œå®ƒå­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€</li>
<li>ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0ï¼Œå†…æ ¸ä½¿ç”¨å®ƒå­˜æ”¾å½“å‰è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„ç¬¬ä¸€ä¸ªæˆå‘˜thread_infoçš„åœ°å€</li>
</ul>
<p>â€‚â€ƒcpu_switch_toæœ‰ä¸¤ä¸ªå‚æ•°ï¼šå¯„å­˜å™¨x0å­˜æ”¾ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ï¼Œå¯„å­˜å™¨x1å­˜æ”¾ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">SYM_FUNC_START</span>(cpu_switch_to)
</span></span><span style="display:flex;"><span>	mov	x10, <span style="color:#960050;background-color:#1e0010">#</span>THREAD_CPU_CONTEXT  <span style="color:#75715e">// cpu_switch_toæœ‰ä¸¤ä¸ªå‚æ•°ï¼šå¯„å­˜å™¨x0å­˜æ”¾ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€ï¼Œå¯„å­˜å™¨x1å­˜æ”¾ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	add	x8, x0, x10  <span style="color:#75715e">// x8å­˜æ”¾ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextçš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mov	x9, sp  <span style="color:#75715e">// x9ä¿å­˜æ ˆæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	stp	x19, x20, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>		<span style="color:#75715e">// store callee-saved registers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	stp	x21, x22, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>  <span style="color:#75715e">// æŠŠä¸Šä¸€ä¸ªè¿›ç¨‹çš„å¯„å­˜å™¨x19ï½x28ã€x29ã€SPå’ŒLR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	stp	x23, x24, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>  <span style="color:#75715e">// ä¿å­˜åˆ°ä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	stp	x25, x26, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>  <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	stp	x27, x28, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>	stp	x29, x9, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>  
</span></span><span style="display:flex;"><span>	str	lr, [x8]  <span style="color:#75715e">// LRå­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	add	x8, x1, x10  <span style="color:#75715e">// x8å­˜æ”¾ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextçš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ldp	x19, x20, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>		<span style="color:#75715e">// restore callee-saved registers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ldp	x21, x22, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>  <span style="color:#75715e">// ä½¿ç”¨ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ldp	x23, x24, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>  <span style="color:#75715e">// ä¿å­˜çš„å€¼æ¢å¤ä¸‹ä¸€ä¸ªè¿›ç¨‹çš„å¯„å­˜å™¨x19ï½x28ã€x29ã€SPå’ŒLR
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ldp	x25, x26, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>	ldp	x27, x28, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>	ldp	x29, x9, [x8], <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span>	ldr	lr, [x8]
</span></span><span style="display:flex;"><span>	mov	sp, x9
</span></span><span style="display:flex;"><span>	msr	sp_el0, x1  <span style="color:#75715e">// ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0è®¾ç½®ä¸ºä¸‹ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„ç¬¬ä¸€ä¸ªæˆå‘˜thread_infoçš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ptrauth_keys_install_kernel x1, x8, x9, x10
</span></span><span style="display:flex;"><span>	scs_save x0, x8  <span style="color:#75715e">// å‡½æ•°è¿”å›ï¼Œè¿”å›å€¼æ˜¯å¯„å­˜å™¨x0çš„å€¼ï¼šä¸Šä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	scs_load x1, x8
</span></span><span style="display:flex;"><span>	ret
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SYM_FUNC_END</span>(cpu_switch_to)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NOKPROBE</span>(cpu_switch_to)
</span></span></code></pre></div><p>â€‚â€ƒcpu_switch_toåˆ‡æ¢é€šç”¨å¯„å­˜å™¨çš„è¿‡ç¨‹ï¼Œä»è¿›ç¨‹prevåˆ‡æ¢åˆ°è¿›ç¨‹nextã€‚è¿›ç¨‹prevæŠŠé€šç”¨å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextä¸­ï¼Œç„¶åè¿›ç¨‹nextä»è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_contextæ¢å¤é€šç”¨å¯„å­˜å™¨çš„å€¼ï¼Œä½¿ç”¨ç”¨æˆ·æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0å­˜æ”¾è¿›ç¨‹nextçš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread_infoçš„åœ°å€    \</p>
<center>ARM64æ¶æ„åˆ‡æ¢é€šç”¨å¯„å­˜å™¨</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/2022-11-05_21-28.png" alt="2022-11-05_21-28"  />
</p>
<p>â€ƒé“¾æ¥å¯„å­˜å™¨å­˜æ”¾å‡½æ•°çš„è¿”å›åœ°å€ï¼Œå‡½æ•°cpu_switch_toæŠŠé“¾æ¥å¯„å­˜å™¨è®¾ç½®ä¸ºè¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context.pcï¼Œè¿›ç¨‹è¢«è°ƒåº¦åä»è¿”å›åœ°å€å¼€å§‹æ‰§è¡Œ   <br>
è¿›ç¨‹çš„è¿”å›åœ°å€åˆ†ä¸ºä»¥ä¸‹ä¸¤ç§æƒ…å†µ:</p>
<ul>
<li>åˆ›å»ºçš„æ–°è¿›ç¨‹ï¼Œå‡½æ•°copy_threadæŠŠè¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context.pcè®¾ç½®ä¸ºå‡½æ•°ret_from_forkçš„åœ°å€</li>
<li>å…¶ä»–æƒ…å†µï¼Œè¿”å›åœ°å€æ˜¯å‡½æ•°context_switchä¸­è°ƒç”¨å‡½æ•°cpu_switch_toä¹‹åçš„ä¸€è¡Œä»£ç ï¼šâ€œlast = å‡½æ•°cpu_switch_toçš„è¿”å›å€¼â€ï¼Œè¿”å›åœ°å€è®°å½•åœ¨è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread.cpu_context.pcä¸­</li>
</ul>
<p>â€‚ï¼ˆ3ï¼‰æ¸…ç†å·¥ä½œ
â€‚â€ƒå‡½æ•°finish_task_switchåœ¨ä»è¿›ç¨‹prevåˆ‡æ¢åˆ°è¿›ç¨‹nextåä¸ºè¿›ç¨‹prevæ‰§è¡Œæ¸…ç†å·¥ä½œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/core.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span><span style="color:#a6e22e">finish_task_switch</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>prev)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__releases</span>(rq<span style="color:#f92672">-&gt;</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq <span style="color:#f92672">=</span> <span style="color:#a6e22e">this_rq</span>();  <span style="color:#75715e">// rqæ˜¯å½“å‰å¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm <span style="color:#f92672">=</span> rq<span style="color:#f92672">-&gt;</span>prev_mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">long</span> prev_state;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*  The previous task will have left us with a preempt_count of 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * because it left us after:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *	schedule()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *	  preempt_disable();			// 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *	  __schedule()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *	    raw_spin_lock_irq(&amp;rq-&gt;lock)	// 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Also, see FORK_PREEMPT_COUNT.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">WARN_ONCE</span>(<span style="color:#a6e22e">preempt_count</span>() <span style="color:#f92672">!=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>PREEMPT_DISABLE_OFFSET,
</span></span><span style="display:flex;"><span>		      <span style="color:#e6db74">&#34;corrupted preempt_count: %s/%d/0x%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>		      current<span style="color:#f92672">-&gt;</span>comm, current<span style="color:#f92672">-&gt;</span>pid, <span style="color:#a6e22e">preempt_count</span>()))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">preempt_count_set</span>(FORK_PREEMPT_COUNT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	rq<span style="color:#f92672">-&gt;</span>prev_mm <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* A task struct has one reference for the use as &#34;current&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * If a task dies, then it sets TASK_DEAD in tsk-&gt;state and calls
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * schedule one last time. The schedule call will never return, and
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * the scheduled task must drop that reference.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * We must observe prev-&gt;state before clearing prev-&gt;on_cpu (in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * finish_task), otherwise a concurrent wakeup can get prev
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * running on another CPU and we could rave with its RUNNING -&gt; DEAD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * transition, resulting in a double drop.*/</span>
</span></span><span style="display:flex;"><span>	prev_state <span style="color:#f92672">=</span> prev<span style="color:#f92672">-&gt;</span>state;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">vtime_task_switch</span>(prev);  <span style="color:#75715e">// è®¡ç®—è¿›ç¨‹prevçš„æ—¶é—´ç»Ÿè®¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">perf_event_task_sched_in</span>(prev, current);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">finish_task</span>(prev);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠprev-&gt;on_cpuè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºè¿›ç¨‹prevæ²¡æœ‰åœ¨å¤„ç†å™¨ä¸Šè¿è¡Œï¼›ç„¶åé‡Šæ”¾è¿è¡Œé˜Ÿåˆ—çš„é”ï¼Œå¼€å¯ç¡¬ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">finish_lock_switch</span>(rq); 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">finish_arch_post_lock_switch</span>(); <span style="color:#75715e">// æ‰§è¡Œå¤„ç†å™¨æ¶æ„ç‰¹å®šçš„æ¸…ç†å·¥ä½œ,ARM64ä¸ºç©º
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kcov_finish_switch</span>(current);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fire_sched_in_preempt_notifiers</span>(current);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* When switching through a kernel thread, the loop in
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * membarrier_{private,global}_expedited() may have observed that
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * kernel thread and not issued an IPI. It is therefore possible to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * schedule between user-&gt;kernel-&gt;user threads without passing though
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * switch_mm(). Membarrier requires a barrier after storing to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * rq-&gt;curr, before returning to userspace, so provide them here:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * - a full memory barrier for {PRIVATE,GLOBAL}_EXPEDITED, implicitly
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 *   provided by mmdrop(),
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * - a sync_core for SYNC_CORE.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (mm) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">membarrier_mm_sync_core_before_usermode</span>(mm);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mmdrop</span>(mm);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(prev_state <span style="color:#f92672">==</span> TASK_DEAD)) { <span style="color:#75715e">// è¿›ç¨‹ä¸»åŠ¨é€€å‡ºæˆ–è€…è¢«ç»ˆæ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> (prev<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span>task_dead)
</span></span><span style="display:flex;"><span>			prev<span style="color:#f92672">-&gt;</span>sched_class<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">task_dead</span>(prev); <span style="color:#75715e">// æ‰€å±è°ƒåº¦ç±»çš„task_deadæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* * Remove function-return probe instances associated with this
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * task and put them back on the free list.*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">kprobe_flush_task</span>(prev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* Task is done with its stack. */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/*é‡Šæ”¾è¿›ç¨‹çš„å†…æ ¸æ ˆ */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_task_stack</span>(prev);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æŠŠè¿›ç¨‹æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°å‡1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸º0ï¼Œé‚£ä¹ˆé‡Šæ”¾è¿›ç¨‹æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">put_task_struct_rcu_user</span>(prev);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tick_nohz_task_switch</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> rq;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="287-è°ƒåº¦æ—¶æœº">2.8.7 è°ƒåº¦æ—¶æœº<a hidden class="anchor" aria-hidden="true" href="#287-è°ƒåº¦æ—¶æœº">#</a></h3>
<blockquote>
<p>è°ƒåº¦è¿›ç¨‹çš„æ—¶æœº: <br>
ï¼ˆ1ï¼‰è¿›ç¨‹ä¸»åŠ¨è°ƒç”¨<code>schedule()</code>å‡½æ•°
ï¼ˆ2ï¼‰å‘¨æœŸæ€§åœ°è°ƒåº¦ï¼ŒæŠ¢å å½“å‰è¿›ç¨‹ï¼Œå¼ºè¿«å½“å‰è¿›ç¨‹è®©å‡ºå¤„ç†å™¨
ï¼ˆ3ï¼‰å”¤é†’è¿›ç¨‹çš„æ—¶å€™ï¼Œè¢«å”¤é†’çš„è¿›ç¨‹å¯èƒ½æŠ¢å å½“å‰è¿›ç¨‹
ï¼ˆ4ï¼‰åˆ›å»ºæ–°è¿›ç¨‹çš„æ—¶å€™ï¼Œæ–°è¿›ç¨‹å¯èƒ½æŠ¢å å½“å‰è¿›ç¨‹ã€‚</p>
</blockquote>
<h4 id="1ä¸»åŠ¨è°ƒåº¦">1.ä¸»åŠ¨è°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#1ä¸»åŠ¨è°ƒåº¦">#</a></h4>
<p>â€‚å†…æ ¸ä¸­3ç§ä¸»åŠ¨è°ƒåº¦æ–¹å¼ï¼š
â€ƒï¼ˆ1ï¼‰ç›´æ¥è°ƒç”¨<code>schedule()</code>å‡½æ•°æ¥è°ƒåº¦è¿›ç¨‹
â€ƒï¼ˆ2ï¼‰è°ƒç”¨æœ‰æ¡ä»¶é‡è°ƒåº¦å‡½æ•°cond_resched()ã€‚éæŠ¢å å¼å†…æ ¸ä¸­ï¼Œå‡½æ•°cond_resched()åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å¦è®¾ç½®äº†éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œå°±è°ƒåº¦è¿›ç¨‹ï¼›æŠ¢å å¼å†…æ ¸ä¸­ï¼Œcond_resched()ä¸ºç©º
â€ƒï¼ˆ3ï¼‰å¦‚æœéœ€è¦ç­‰å¾…æŸä¸ªèµ„æºï¼Œä¾‹å¦‚äº’æ–¥é”æˆ–ä¿¡å·é‡ï¼Œé‚£ä¹ˆæŠŠè¿›ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸ºç¡çœ çŠ¶æ€ï¼Œç„¶åè°ƒç”¨schedule()å‡½æ•°ä»¥è°ƒåº¦è¿›ç¨‹</p>
<h4 id="2å‘¨æœŸè°ƒåº¦">2.å‘¨æœŸè°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#2å‘¨æœŸè°ƒåº¦">#</a></h4>
<p>â€ƒå‘¨æœŸè°ƒåº¦çš„å‡½æ•°æ˜¯scheduler_tick()ï¼Œå®ƒè°ƒç”¨å½“å‰è¿›ç¨‹æ‰€å±è°ƒåº¦ç±»çš„task_tickæ–¹æ³•ã€‚
â€‚ï¼ˆ1ï¼‰é™æœŸè°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦   <br>
â€ƒtask_tick &ndash;&gt; task_tick_dl &ndash;&gt; update_curr_dl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/deadline.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update_curr_dl</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>curr <span style="color:#f92672">=</span> rq<span style="color:#f92672">-&gt;</span>curr;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sched_dl_entity <span style="color:#f92672">*</span>dl_se <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>curr<span style="color:#f92672">-&gt;</span>dl;
</span></span><span style="display:flex;"><span>	u64 delta_exec, scaled_delta_exec;
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	delta_exec <span style="color:#f92672">=</span> now <span style="color:#f92672">-</span> curr<span style="color:#f92672">-&gt;</span>se.exec_start;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>((s64)delta_exec <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(dl_se<span style="color:#f92672">-&gt;</span>dl_yielded))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> throttle;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	dl_se<span style="color:#f92672">-&gt;</span>runtime <span style="color:#f92672">-=</span> scaled_delta_exec; <span style="color:#75715e">// è®¡ç®—é™æœŸè¿›ç¨‹çš„å‰©ä½™è¿è¡Œæ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>throttle:
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// // å¦‚æœé™æœŸè¿›ç¨‹ç”¨å®Œäº†è¿è¡Œæ—¶é—´æˆ–è€…ä¸»åŠ¨è®©å‡ºå¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">dl_runtime_exceeded</span>(dl_se) <span style="color:#f92672">||</span> dl_se<span style="color:#f92672">-&gt;</span>dl_yielded) { 
</span></span><span style="display:flex;"><span>		dl_se<span style="color:#f92672">-&gt;</span>dl_throttled <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;  <span style="color:#75715e">// è®¾ç½®èŠ‚æµæ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* If requested, inform the user about runtime overruns. */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">dl_runtime_exceeded</span>(dl_se) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>		    (dl_se<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> SCHED_FLAG_DL_OVERRUN))
</span></span><span style="display:flex;"><span>			dl_se<span style="color:#f92672">-&gt;</span>dl_overrun <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">__dequeue_task_dl</span>(rq, curr, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">is_dl_boosted</span>(dl_se) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">start_dl_timer</span>(curr)))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">enqueue_task_dl</span>(rq, curr, ENQUEUE_REPLENISH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_leftmost</span>(curr, <span style="color:#f92672">&amp;</span>rq<span style="color:#f92672">-&gt;</span>dl))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">resched_curr</span>(rq);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ï¼ˆ2ï¼‰å®æ—¶è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦   \</p>
<p>â€ƒå®æ—¶è°ƒåº¦ç±»çš„task_tickæ–¹æ³•æ˜¯å‡½æ•°task_tick_rt</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/rt.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">task_tick_rt</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> queued)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sched_rt_entity <span style="color:#f92672">*</span>rt_se <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>rt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (p<span style="color:#f92672">-&gt;</span>policy <span style="color:#f92672">!=</span> SCHED_RR) <span style="color:#75715e">// è°ƒåº¦ç­–ç•¥ä¸æ˜¯è½®æµè°ƒåº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æŠŠæ—¶é—´ç‰‡å‡ä¸€ï¼Œå¦‚æœæ²¡ç”¨å®Œæ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆè¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">--</span>p<span style="color:#f92672">-&gt;</span>rt.time_slice)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç”¨å®Œäº†æ—¶é—´ç‰‡ï¼Œé‚£ä¹ˆé‡æ–°åˆ†é…æ—¶é—´ç‰‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	p<span style="color:#f92672">-&gt;</span>rt.time_slice <span style="color:#f92672">=</span> sched_rr_timeslice;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Requeue to the end of queue if we (and all of our ancestors) are not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * the only element on the queue */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">for_each_sched_rt_entity</span>(rt_se) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (rt_se<span style="color:#f92672">-&gt;</span>run_list.prev <span style="color:#f92672">!=</span> rt_se<span style="color:#f92672">-&gt;</span>run_list.next) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">requeue_task_rt</span>(rq, p, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">resched_curr</span>(rq);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ï¼ˆ3ï¼‰å…¬å¹³è°ƒåº¦ç±»çš„å‘¨æœŸè°ƒåº¦     <br>
â€ƒå…¬å¹³è°ƒåº¦ç±»çš„task_tickæ–¹æ³•æ˜¯å‡½æ•°task_tick_fair</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/fair.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">task_tick_fair</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>curr, <span style="color:#66d9ef">int</span> queued)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> cfs_rq <span style="color:#f92672">*</span>cfs_rq;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>se <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>curr<span style="color:#f92672">-&gt;</span>se;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">for_each_sched_entity</span>(se) {
</span></span><span style="display:flex;"><span>		cfs_rq <span style="color:#f92672">=</span> <span style="color:#a6e22e">cfs_rq_of</span>(se);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">entity_tick</span>(cfs_rq, se, queued);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/fair.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">entity_tick</span>(<span style="color:#66d9ef">struct</span> cfs_rq <span style="color:#f92672">*</span>cfs_rq, <span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>curr, <span style="color:#66d9ef">int</span> queued)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (cfs_rq<span style="color:#f92672">-&gt;</span>nr_running <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„è¿›ç¨‹æ•°é‡è¶…è¿‡1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">check_preempt_tick</span>(cfs_rq, curr);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/fair.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">check_preempt_tick</span>(<span style="color:#66d9ef">struct</span> cfs_rq <span style="color:#f92672">*</span>cfs_rq, <span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>curr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ideal_runtime, delta_exec;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>se;
</span></span><span style="display:flex;"><span>	s64 delta;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	ideal_runtime <span style="color:#f92672">=</span> <span style="color:#a6e22e">sched_slice</span>(cfs_rq, curr);
</span></span><span style="display:flex;"><span>	delta_exec <span style="color:#f92672">=</span> curr<span style="color:#f92672">-&gt;</span>sum_exec_runtime <span style="color:#f92672">-</span> curr<span style="color:#f92672">-&gt;</span>prev_sum_exec_runtime;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (delta_exec <span style="color:#f92672">&gt;</span> ideal_runtime) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">resched_curr</span>(<span style="color:#a6e22e">rq_of</span>(cfs_rq));
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* The current task ran long enough, ensure it doesn&#39;t get
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		 * re-elected due to buddy favours.*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">clear_buddies</span>(cfs_rq, curr);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Ensure that a task that missed wakeup preemption by a
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * narrow margin doesn&#39;t have to wait for a full slice.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * This also mitigates buddy induced latencies under load.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (delta_exec <span style="color:#f92672">&lt;</span> sysctl_sched_min_granularity)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	se <span style="color:#f92672">=</span> <span style="color:#a6e22e">__pick_first_entity</span>(cfs_rq);
</span></span><span style="display:flex;"><span>	delta <span style="color:#f92672">=</span> curr<span style="color:#f92672">-&gt;</span>vruntime <span style="color:#f92672">-</span> se<span style="color:#f92672">-&gt;</span>vruntime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (delta <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (delta <span style="color:#f92672">&gt;</span> ideal_runtime)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">resched_curr</span>(<span style="color:#a6e22e">rq_of</span>(cfs_rq));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ï¼ˆ4ï¼‰ä¸­æ–­è¿”å›æ—¶è°ƒåº¦ã€‚
â€ƒARM64æ¶æ„çš„ä¸­æ–­å¤„ç†ç¨‹åºçš„å…¥å£æ˜¯e10_irqï¼Œä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œå®Œä»¥åï¼Œè·³è½¬åˆ°æ ‡å·ret_to_userä»¥è¿”å›ç”¨æˆ·æ¨¡å¼ã€‚æ ‡å·ret_to_useråˆ¤æ–­å½“å‰è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread_info.flagsæœ‰æ²¡æœ‰è®¾ç½®æ ‡å¿—ä½é›†åˆ_TIF_WORK_MASKä¸­çš„ä»»ä½•ä¸€ä¸ªæ ‡å¿—ä½ï¼Œå¦‚æœè®¾ç½®äº†å…¶ä¸­ä¸€ä¸ªæ ‡å¿—ä½ï¼Œé‚£ä¹ˆè·³è½¬åˆ°æ ‡å·work_pendingï¼Œæ ‡å·work_pendingè°ƒç”¨å‡½æ•°do_notify_resume</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S  5.10.102 ä»£ç ä¸­æ²¡æœ‰ï¼Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ret_to_user:
</span></span><span style="display:flex;"><span>     disable_irq                   <span style="color:#75715e">// ç¦æ­¢ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ldr  x1, [tsk, <span style="color:#960050;background-color:#1e0010">#</span>TSK_TI_FLAGS]
</span></span><span style="display:flex;"><span>     and  x2, x1, <span style="color:#960050;background-color:#1e0010">#</span>_TIF_WORK_MASK
</span></span><span style="display:flex;"><span>     cbnz x2, work_pending
</span></span><span style="display:flex;"><span>finish_ret_to_user:
</span></span><span style="display:flex;"><span>     enable_step_tsk x1, x2
</span></span><span style="display:flex;"><span>     kernel_exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENDPROC</span>(ret_to_user)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>work_pending:
</span></span><span style="display:flex;"><span>     mov  x0, sp
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      * å¯„å­˜å™¨x0å­˜æ”¾ç¬¬ä¸€ä¸ªå‚æ•°regs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      * å¯„å­˜å™¨x1å­˜æ”¾ç¬¬äºŒä¸ªå‚æ•°task_struct.thread_info.flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      */</span>
</span></span><span style="display:flex;"><span>     bl  do_notify_resume
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_TRACE_IRQFLAGS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     bl  trace_hardirqs_on         <span style="color:#75715e">// åœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œæ—¶å¼€å¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ldr x1, [tsk, <span style="color:#960050;background-color:#1e0010">#</span>TSK_TI_FLAGS]  <span style="color:#75715e">// é‡æ–°æ£€æŸ¥å•æ­¥æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     b   finish_ret_to_user
</span></span></code></pre></div><p>â€ƒå‡½æ•°do_notify_resumeåˆ¤æ–­å½“å‰è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦çš„æˆå‘˜thread_info.flagsæœ‰æ²¡æœ‰è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—ä½_TIF_NEED_RESCHEDï¼Œå¦‚æœè®¾ç½®äº†ï¼Œé‚£ä¹ˆè°ƒç”¨å‡½æ•°schedule()ä»¥è°ƒåº¦è¿›ç¨‹ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/signal.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">do_notify_resume</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs,
</span></span><span style="display:flex;"><span>                         <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> thread_flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_NEED_RESCHED) {
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">schedule</span>();
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>             <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">local_irq_disable</span>();
</span></span><span style="display:flex;"><span>        thread_flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">READ_ONCE</span>(<span style="color:#a6e22e">current_thread_info</span>()<span style="color:#f92672">-&gt;</span>flags);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">while</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_WORK_MASK);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3å”¤é†’è¿›ç¨‹æ—¶æŠ¢å ">3.å”¤é†’è¿›ç¨‹æ—¶æŠ¢å <a hidden class="anchor" aria-hidden="true" href="#3å”¤é†’è¿›ç¨‹æ—¶æŠ¢å ">#</a></h4>
<p>â€ƒå”¤é†’è¿›ç¨‹çš„æ—¶å€™ï¼Œè¢«å”¤é†’çš„è¿›ç¨‹å¯èƒ½æŠ¢å å½“å‰è¿›ç¨‹</p>
<center>å”¤é†’è¿›ç¨‹æ—¶æŠ¢å </center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221106214732.png" alt="20221106214732"  />
</p>
<p>â€‚ï¼ˆ1ï¼‰å¦‚æœè¢«å”¤é†’çš„è¿›ç¨‹å’Œå½“å‰è¿›ç¨‹å±äºç›¸åŒçš„è°ƒåº¦ç±»ï¼Œé‚£ä¹ˆè°ƒç”¨è°ƒåº¦ç±»çš„check_preempt_curræ–¹æ³•ä»¥æ£€æŸ¥æ˜¯å¦å¯ä»¥æŠ¢å å½“å‰è¿›ç¨‹   <br>
â€‚ï¼ˆ2ï¼‰å¦‚æœè¢«å”¤é†’çš„è¿›ç¨‹æ‰€å±è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§é«˜äºå½“å‰è¿›ç¨‹æ‰€å±è°ƒåº¦ç±»çš„ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—</p>
<table>
	<tr>
	    <th>è°ƒåº¦ç±»</th>
	    <th>check_preempt_curræ–¹æ³•æ˜¯å‡½æ•°</th>
	    <th>ç®—æ³•</th>  
	</tr >
	<tr >
	    <td>åœæœºè°ƒåº¦ç±»</td>
	    <td>check_preempt_curr_stop</td>
	    <td>ç©ºå‡½æ•°</td>
	</tr>
	<tr >
	    <td>é™æœŸè°ƒåº¦ç±»</td>
	    <td>check_preempt_curr_dl</td>
	    <td>å¦‚æœè¢«å”¤é†’çš„è¿›ç¨‹çš„ç»å¯¹æˆªæ­¢æœŸé™æ¯”å½“å‰è¿›ç¨‹çš„ç»å¯¹æˆªæ­¢æœŸé™å°ï¼Œé‚£ä¹ˆç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—</td>
	</tr>
	<tr >
	    <td>å®æ—¶è°ƒåº¦ç±»</td>
	    <td>check_preempt_curr_rt</td>
	    <td>ä¼˜å…ˆçº§æ¯”å½“å‰è¿›ç¨‹çš„ä¼˜å…ˆçº§é«˜ï¼Œé‚£ä¹ˆç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—</td>
	</tr>
	<tr >
	    <td>å…¬å¹³è°ƒåº¦ç±»</td>
	    <td>check_preempt_wakeup</td>
	    <td></td>
	</tr>
	<tr >
	    <td>ç©ºé—²è°ƒåº¦ç±»</td>
	    <td>check_preempt_curr_idle</td>
	    <td>æ— æ¡ä»¶æŠ¢å ï¼Œç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—</td>
	</tr>
</table>
<p>â€ƒcheck_preempt_wakeupå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/kernel/sched/fair.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check_preempt_wakeup</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> wake_flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å½“å‰è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯SCHED_IDLEï¼Œè¢«å”¤é†’çš„è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥æ˜¯SCHED_NORMALæˆ–è€…SCHED_BATCHï¼Œé‚£ä¹ˆå…è®¸æŠ¢å ï¼Œç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>curr <span style="color:#f92672">=</span> rq<span style="color:#f92672">-&gt;</span>curr;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>se <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>curr<span style="color:#f92672">-&gt;</span>se, <span style="color:#f92672">*</span>pse <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>se;
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">task_has_idle_policy</span>(curr)) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#a6e22e">likely</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">task_has_idle_policy</span>(p)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> preempt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(p<span style="color:#f92672">-&gt;</span>policy <span style="color:#f92672">!=</span> SCHED_NORMAL) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">sched_feat</span>(WAKEUP_PREEMPTION))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¸ºå½“å‰è¿›ç¨‹å’Œè¢«å”¤é†’çš„è¿›ç¨‹æ‰¾åˆ°ä¸¤ä¸ªå…„å¼Ÿè°ƒåº¦å®ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">find_matching_se</span>(<span style="color:#f92672">&amp;</span>se, <span style="color:#f92672">&amp;</span>pse);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">update_curr</span>(<span style="color:#a6e22e">cfs_rq_of</span>(se));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">BUG_ON</span>(<span style="color:#f92672">!</span>pse);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">wakeup_preempt_entity</span>(se, pse) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) { <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦å¯ä»¥æŠ¢å 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// å…è®¸æŠ¢å ï¼Œç»™å½“å‰è¿›ç¨‹è®¾ç½®éœ€è¦é‡æ–°è°ƒåº¦çš„æ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		...
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> preempt;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>preempt:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">resched_curr</span>(rq);
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wakeup_preempt_entity</span>(<span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>curr, <span style="color:#66d9ef">struct</span> sched_entity <span style="color:#f92672">*</span>se)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	s64 gran, vdiff <span style="color:#f92672">=</span> curr<span style="color:#f92672">-&gt;</span>vruntime <span style="color:#f92672">-</span> se<span style="color:#f92672">-&gt;</span>vruntime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vdiff <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	gran <span style="color:#f92672">=</span> <span style="color:#a6e22e">wakeup_gran</span>(se);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vdiff <span style="color:#f92672">&gt;</span> gran)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="4åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŠ¢å ">4.åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŠ¢å <a hidden class="anchor" aria-hidden="true" href="#4åˆ›å»ºæ–°è¿›ç¨‹æ—¶æŠ¢å ">#</a></h4>
<p>â€ƒä½¿ç”¨ç³»ç»Ÿè°ƒç”¨forkã€cloneå’Œ vforkåˆ›å»ºæ–°è¿›ç¨‹ä½¿ï¼Œæ–°è¿›ç¨‹å¯æŠ¢å å½“å‰è¿›ç¨‹ï¼›ä½¿ç”¨éŸ©å¼kernel_threadåˆ›å»ºæ–°çš„å†…æ ¸çº¿ç¨‹æ˜¯ï¼Œæ–°å†…æ ¸çº¿ç¨‹å¯æŠ¢å å½“å‰è¿›ç¨‹
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221106220629.png" alt="20221106220629"  />
</p>
<h4 id="5å†…æ ¸æŠ¢å ">5.å†…æ ¸æŠ¢å <a hidden class="anchor" aria-hidden="true" href="#5å†…æ ¸æŠ¢å ">#</a></h4>
<p>â€ƒå†…æ ¸æŠ¢å æ˜¯æŒ‡å½“è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„æ—¶å€™å¯ä»¥è¢«å…¶ä»–è¿›ç¨‹æŠ¢å ï¼Œéœ€è¦æ‰“å¼€é…ç½®å®CONFIG_PREEMPTã€‚æŠ¢å å¼å†…æ ¸å’ŒéæŠ¢å å¼å†…æ ¸ã€‚è¿›ç¨‹tthread_infoç»“æ„ä½“ä¸€ä¸ªç±»å‹ä¸ºintçš„æˆå‘˜preempt_countä¸ºæŠ¢å è®¡æ•°å™¨ã€‚</p>
<blockquote>
<p>å¾…è¡¥å……</p>
</blockquote>
<h4 id="6é«˜ç²¾åº¦è°ƒåº¦æ—¶é’Ÿ">6.é«˜ç²¾åº¦è°ƒåº¦æ—¶é’Ÿ<a hidden class="anchor" aria-hidden="true" href="#6é«˜ç²¾åº¦è°ƒåº¦æ—¶é’Ÿ">#</a></h4>
<p>â€ƒé«˜ç²¾åº¦æ—¶é’Ÿçš„ç²¾åº¦æ˜¯çº³ç§’,éœ€è¦é€šè¿‡é…ç½®å®å¯ç”¨ã€‚</p>
<h3 id="288-å¸¦å®½ç®¡ç†">2.8.8 å¸¦å®½ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#288-å¸¦å®½ç®¡ç†">#</a></h3>
<p>â€ƒè°ƒåº¦ç±»ç®¡ç†è¿›ç¨‹å ç”¨çš„å¤„ç†å™¨å¸¦å®½çš„æ–¹æ³•</p>
<h4 id="1é™æœŸè°ƒåº¦ç±»çš„å¸¦æ¡†ç®¡ç†">1.é™æœŸè°ƒåº¦ç±»çš„å¸¦æ¡†ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#1é™æœŸè°ƒåº¦ç±»çš„å¸¦æ¡†ç®¡ç†">#</a></h4>
<p>â€ƒæ¯ä¸ªé™æœŸè¿›ç¨‹æœ‰è‡ªå·±çš„å¸¦å®½ï¼Œå†…æ ¸æŠŠé™æœŸè¿›ç¨‹çš„è¿è¡Œæ—¶é—´ç»Ÿè®¡åˆ°æ ¹å®æ—¶ä»»åŠ¡ç»„çš„è¿è¡Œæ—¶é—´é‡Œé¢äº†ï¼Œé™æœŸè¿›ç¨‹å…±äº«å®æ—¶è¿›ç¨‹çš„å¸¦å®½</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/deadline.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update_curr_dl</span>(<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">rt_bandwidth_enabled</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">struct</span> rt_rq <span style="color:#f92672">*</span>rt_rq <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>rq<span style="color:#f92672">-&gt;</span>rt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raw_spin_lock</span>(<span style="color:#f92672">&amp;</span>rt_rq<span style="color:#f92672">-&gt;</span>rt_runtime_lock);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sched_rt_bandwidth_account</span>(rt_rq))
</span></span><span style="display:flex;"><span>                  rt_rq<span style="color:#f92672">-&gt;</span>rt_time <span style="color:#f92672">+=</span> delta_exec;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">raw_spin_unlock</span>(<span style="color:#f92672">&amp;</span>rt_rq<span style="color:#f92672">-&gt;</span>rt_runtime_lock);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2å®æ—¶è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†">2.å®æ—¶è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#2å®æ—¶è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†">#</a></h4>
<p>â€‚æŒ‡å®šå®æ—¶è¿›ç¨‹çš„å¸¦å®½æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼
â€‚ï¼ˆ1ï¼‰æŒ‡å®šå…¨å±€å¸¦å®½ï¼šå¸¦å®½åŒ…å«çš„ä¸¤ä¸ªå‚æ•°æ˜¯å‘¨æœŸå’Œè¿è¡Œæ—¶é—´ï¼Œå³æŒ‡å®šåœ¨æ¯ä¸ªå‘¨æœŸå†…æ‰€æœ‰å®æ—¶è¿›ç¨‹çš„è¿è¡Œæ—¶é—´æ€»å’Œã€‚   <br>
â€ƒé»˜è®¤çš„å‘¨æœŸæ˜¯1ç§’ï¼Œé»˜è®¤çš„è¿è¡Œæ—¶é—´æ˜¯0.95ç§’ã€‚å¯ä»¥å€ŸåŠ©æ–‡ä»¶â€œ/proc/sys/kernel/sched_rt_period_usâ€è®¾ç½®å‘¨æœŸï¼Œå€ŸåŠ©æ–‡ä»¶â€œ/proc/sys/kernel/sched_rt_runtime_usâ€è®¾ç½®è¿è¡Œæ—¶é—´        <br>
â€ƒé…ç½®å®CONFIG_RT_GROUP_SCHEDï¼Œå³æ”¯æŒå®æ—¶ä»»åŠ¡ç»„ï¼Œé‚£ä¹ˆå…¨å±€å¸¦å®½æŒ‡å®šäº†æ‰€æœ‰å®æ—¶ä»»åŠ¡ç»„çš„æ€»å¸¦å®½
â€‚ï¼ˆ2ï¼‰æŒ‡å®šæ¯ä¸ªå®æ—¶ä»»åŠ¡ç»„çš„å¸¦å®½ï¼šåœ¨æ¯ä¸ªæŒ‡å®šçš„å‘¨æœŸï¼Œå…è®¸ä¸€ä¸ªå®æ—¶ä»»åŠ¡ç»„æœ€å¤šæ‰§è¡Œé•¿æ—¶é—´ã€‚å½“å®æ—¶ä»»åŠ¡ç»„åœ¨ä¸€ä¸ªå‘¨æœŸç”¨å®Œäº†å¸¦å®½æ—¶ï¼Œè¿™ä¸ªä»»åŠ¡ç»„å°†ä¼šè¢«èŠ‚æµï¼Œä¸å…è®¸ç»§ç»­è¿è¡Œï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªå‘¨æœŸã€‚å¯ä»¥ä½¿ç”¨cgroupè®¾ç½®ä¸€ä¸ªå®æ—¶ä»»åŠ¡ç»„çš„å‘¨æœŸå’Œè¿è¡Œæ—¶é—´ï¼Œcgroupç‰ˆæœ¬1çš„é…ç½®æ–¹æ³•å¦‚ä¸‹</p>
<details>
<summary>cgroupç‰ˆæœ¬1çš„é…ç½®æ–¹æ³•</summary>
<br>
1ï¼‰cpu.rt_period_usï¼šå‘¨æœŸï¼Œé»˜è®¤å€¼æ˜¯1ç§’ã€‚   <br>
2ï¼‰cpu.rt_runtime_usï¼šè¿è¡Œæ—¶é—´ï¼Œé»˜è®¤å€¼æ˜¯0ï¼ŒæŠŠè¿è¡Œæ—¶é—´è®¾ç½®ä¸ºéé›¶å€¼ä»¥åæ‰å…è®¸æŠŠå®æ—¶è¿›ç¨‹åŠ å…¥ä»»åŠ¡ç»„ï¼Œè®¾ç½®ä¸ºâˆ’1è¡¨ç¤ºæ²¡æœ‰å¸¦å®½é™åˆ¶ã€‚
cgroupç‰ˆæœ¬1çš„é…ç½®ç¤ºä¾‹å¦‚ä¸‹ã€‚ <br>
1ï¼‰æŒ‚è½½cgroupæ–‡ä»¶ç³»ç»Ÿï¼ŒæŠŠCPUæ§åˆ¶å™¨å…³è”åˆ°æ§åˆ¶ç»„å±‚çº§æ ‘ã€‚   <br>
mount -t cgroup -o cpu none /sys/fs/cgroup/cpu      <br>
2ï¼‰åˆ›å»ºä¸€ä¸ªä»»åŠ¡ç»„ã€‚     <br>
cd /sys/fs/cgroup/cpu      <br>
mkdir browser   # åˆ›å»º"browser"ä»»åŠ¡ç»„       <br>
3ï¼‰æŠŠå®æ—¶è¿è¡Œæ—¶é—´è®¾ç½®ä¸º10æ¯«ç§’ã€‚         <br>
echo 10000 > browser/cpu.rt_runtime_us      <br>
4ï¼‰æŠŠä¸€ä¸ªå®æ—¶è¿›ç¨‹åŠ å…¥ä»»åŠ¡ç»„ã€‚         <br>
echo <pid> > browser/cgroup.procs      <br>
</details>
<p>â€‚cgroupç‰ˆæœ¬2ä»å†…æ ¸4.15ç‰ˆæœ¬å¼€å§‹æ”¯æŒCPUæ§åˆ¶å™¨ï¼Œæš‚æ—¶ä¸æ”¯æŒå®æ—¶è¿›ç¨‹ã€‚</p>
<p>â€ƒä¸€ä¸ªå¤„ç†å™¨ç”¨å®Œäº†å®æ—¶è¿è¡Œæ—¶é—´ï¼Œå¯ä»¥ä»å…¶ä»–å¤„ç†å™¨å€Ÿç”¨å®æ—¶è¿è¡Œæ—¶é—´ï¼Œç§°ä¸ºå®æ—¶è¿è¡Œæ—¶é—´å…±äº«ï¼Œå¯¹åº”è°ƒåº¦ç‰¹æ€§RT_RUNTIME_SHAREï¼Œé»˜è®¤å¼€å¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kernel<span style="color:#f92672">/</span>sched<span style="color:#f92672">/</span>features.h
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SCHED_FEAT</span>(RT_RUNTIME_SHARE, true)
</span></span></code></pre></div><p>å®æ—¶ä»»åŠ¡ç»„çš„å¸¦å®½å­˜æ”¾åœ¨ç»“æ„ä½“task_groupçš„æˆå‘˜rt_bandwidthä¸­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_group {
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_RT_GROUP_SCHED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> rt_bandwidth rt_bandwidth;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€ƒèŠ‚æµ</p>
<blockquote>
<p>ä¹¦ä¸­è¯¦ç»†è§£é‡Š</p>
</blockquote>
<h4 id="3å…¬å¹³è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†">3.å…¬å¹³è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#3å…¬å¹³è°ƒåº¦ç±»çš„å¸¦å®½ç®¡ç†">#</a></h4>
<p>â€ƒä½¿ç”¨å‘¨æœŸå’Œé™é¢æŒ‡å®šä¸€ä¸ªå…¬å¹³ä»»åŠ¡ç»„çš„å¸¦å®½    <br>
â€ƒä½¿ç”¨cgroupè®¾ç½®ä¸€ä¸ªå…¬å¹³ä»»åŠ¡ç»„çš„å‘¨æœŸå’Œé™é¢ï¼Œcgroupç‰ˆæœ¬1çš„é…ç½®  \</p>
<details>
<summary>cgroupç‰ˆæœ¬1çš„é…ç½®æ–¹æ³•</summary>
</details>
&emsp;cgroupç‰ˆæœ¬2çš„é…ç½®ç¤ºä¾‹  \
<details>
<summary>cgroupç‰ˆæœ¬2çš„é…ç½®æ–¹æ³•</summary>
</details>
<p>â€‚ï¼ˆ1ï¼‰èŠ‚æµï¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ï¼Œè°ƒåº¦å™¨ä¼šæ£€æŸ¥å…¬å¹³è¿è¡Œé˜Ÿåˆ—æ˜¯å¦ç”¨å®Œè¿è¡Œæ—¶é—´ã€‚
â€ƒ1ï¼‰put_prev_task_fairï¼šè°ƒåº¦å™¨æŠŠå½“å‰æ­£åœ¨è¿è¡Œçš„æ™®é€šè¿›ç¨‹æ”¾å›å…¬å¹³è¿è¡Œé˜Ÿåˆ—ã€‚
â€ƒ2ï¼‰pick_next_task_fairï¼šå½“å‰æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å±äºå…¬å¹³è°ƒåº¦ç±»ï¼Œè°ƒåº¦å™¨é€‰æ‹©ä¸‹ä¸€ä¸ªæ™®é€šè¿›ç¨‹ã€‚</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221106231743.png" alt="20221106231743"  />
</p>
<p>â€‚ï¼ˆ2ï¼‰å‘¨æœŸå®šæ—¶å™¨ï¼šåœ¨æ¯ä¸ªå‘¨æœŸçš„å¼€å§‹ï¼Œé‡æ–°å¡«å……ä»»åŠ¡ç»„çš„å¸¦å®½ï¼ŒæŠŠå¸¦å®½åˆ†é…ç»™èŠ‚æµçš„å…¬å¹³è¿è¡Œé˜Ÿåˆ—ã€‚å‘¨æœŸå®šæ—¶å™¨çš„å¤„ç†å‡½æ•°æ˜¯sched_cfs_period_timerï¼Œå®ƒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°do_sched_cfs_period_timer</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221106232422.png" alt="20221106232422"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/fair.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">do_sched_cfs_period_timer</span>(<span style="color:#66d9ef">struct</span> cfs_bandwidth <span style="color:#f92672">*</span>cfs_b, <span style="color:#66d9ef">int</span> overrun)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	throttled <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">list_empty</span>(<span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>throttled_cfs_rq);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__refill_cfs_bandwidth_runtime</span>(cfs_b); <span style="color:#75715e">// æ–°å¡«å……ä»»åŠ¡ç»„çš„å¸¦å®½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>throttled) {
</span></span><span style="display:flex;"><span>		cfs_b<span style="color:#f92672">-&gt;</span>idle <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (throttled <span style="color:#f92672">&amp;&amp;</span> cfs_b<span style="color:#f92672">-&gt;</span>runtime <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>		runtime <span style="color:#f92672">=</span> cfs_b<span style="color:#f92672">-&gt;</span>runtime;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">raw_spin_unlock</span>(<span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æŠŠä»»åŠ¡ç»„çš„å¯ç”¨è¿è¡Œæ—¶é—´åˆ†é…ç»™èŠ‚æµçš„å…¬å¹³è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		runtime <span style="color:#f92672">=</span> <span style="color:#a6e22e">distribute_cfs_runtime</span>(cfs_b, runtime,
</span></span><span style="display:flex;"><span>								runtime_expires);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">raw_spin_lock</span>(<span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		throttled <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">list_empty</span>(<span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>throttled_cfs_rq);
</span></span><span style="display:flex;"><span>		cfs_b<span style="color:#f92672">-&gt;</span>runtime <span style="color:#f92672">-=</span> <span style="color:#a6e22e">min</span>(runtime, cfs_b<span style="color:#f92672">-&gt;</span>runtime);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°__refill_cfs_bandwidth_runtimeè´Ÿè´£é‡æ–°å¡«å……ä»»åŠ¡ç»„çš„å¸¦å®½ï¼šâ€œæŠŠå¯ç”¨è¿è¡Œæ—¶é—´è®¾ç½®æˆé™é¢ï¼ŒæŠŠè¿è¡Œæ—¶é—´çš„åˆ°æœŸæ—¶é—´è®¾ç½®æˆå½“å‰æ—¶é—´åŠ ä¸Š1ä¸ªå‘¨æœŸâ€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/fair.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__refill_cfs_bandwidth_runtime</span>(<span style="color:#66d9ef">struct</span> cfs_bandwidth <span style="color:#f92672">*</span>cfs_b)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     u64 now;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> (cfs_b<span style="color:#f92672">-&gt;</span>quota <span style="color:#f92672">==</span> RUNTIME_INF)
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     now <span style="color:#f92672">=</span> <span style="color:#a6e22e">sched_clock_cpu</span>(<span style="color:#a6e22e">smp_processor_id</span>());
</span></span><span style="display:flex;"><span>     cfs_b<span style="color:#f92672">-&gt;</span>runtime <span style="color:#f92672">=</span> cfs_b<span style="color:#f92672">-&gt;</span>quota;
</span></span><span style="display:flex;"><span>     cfs_b<span style="color:#f92672">-&gt;</span>runtime_expires <span style="color:#f92672">=</span> now <span style="color:#f92672">+</span> <span style="color:#a6e22e">ktime_to_ns</span>(cfs_b<span style="color:#f92672">-&gt;</span>period);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°distribute_cfs_runtimeè´Ÿè´£æŠŠä»»åŠ¡ç»„çš„å¯ç”¨è¿è¡Œæ—¶é—´åˆ†é…ç»™èŠ‚æµçš„å…¬å¹³è¿è¡Œé˜Ÿåˆ—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">distribute_cfs_runtime</span>(<span style="color:#66d9ef">struct</span> cfs_bandwidth <span style="color:#f92672">*</span>cfs_b)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> cfs_rq <span style="color:#f92672">*</span>cfs_rq;
</span></span><span style="display:flex;"><span>	u64 runtime, remaining <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rcu_read_lock</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">list_for_each_entry_rcu</span>(cfs_rq, <span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>throttled_cfs_rq,
</span></span><span style="display:flex;"><span>				throttled_list) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>rq <span style="color:#f92672">=</span> <span style="color:#a6e22e">rq_of</span>(cfs_rq);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">struct</span> rq_flags rf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rq_lock_irqsave</span>(rq, <span style="color:#f92672">&amp;</span>rf);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">cfs_rq_throttled</span>(cfs_rq))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> next;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* By the above check, this should never be true */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">SCHED_WARN_ON</span>(cfs_rq<span style="color:#f92672">-&gt;</span>runtime_remaining <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">raw_spin_lock</span>(<span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* cfs_rq-&gt;runtime_remainingæ˜¯å…¬å¹³è¿è¡Œé˜Ÿåˆ—çš„å‰©ä½™è¿è¡Œæ—¶é—´ */</span>
</span></span><span style="display:flex;"><span>		runtime <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>cfs_rq<span style="color:#f92672">-&gt;</span>runtime_remaining <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (runtime <span style="color:#f92672">&gt;</span> cfs_b<span style="color:#f92672">-&gt;</span>runtime)
</span></span><span style="display:flex;"><span>			runtime <span style="color:#f92672">=</span> cfs_b<span style="color:#f92672">-&gt;</span>runtime;
</span></span><span style="display:flex;"><span>		cfs_b<span style="color:#f92672">-&gt;</span>runtime <span style="color:#f92672">-=</span> runtime;
</span></span><span style="display:flex;"><span>		remaining <span style="color:#f92672">=</span> cfs_b<span style="color:#f92672">-&gt;</span>runtime;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">raw_spin_unlock</span>(<span style="color:#f92672">&amp;</span>cfs_b<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		cfs_rq<span style="color:#f92672">-&gt;</span>runtime_remaining <span style="color:#f92672">+=</span> runtime;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* we check whether we&#39;re throttled above */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* ä¸Šé¢æ£€æŸ¥è¿‡æ˜¯å¦è¢«èŠ‚æµ */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (cfs_rq<span style="color:#f92672">-&gt;</span>runtime_remaining <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">unthrottle_cfs_rq</span>(cfs_rq);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>next:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">rq_unlock_irqrestore</span>(rq, <span style="color:#f92672">&amp;</span>rf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>remaining)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rcu_read_unlock</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ï¼ˆ3ï¼‰å–æœ‰ä½™è¡¥ä¸è¶³ï¼š</p>
<h2 id="29-smpè°ƒåº¦">2.9 SMPè°ƒåº¦<a hidden class="anchor" aria-hidden="true" href="#29-smpè°ƒåº¦">#</a></h2>
<p>â€‚SMPç³»ç»Ÿè¿›ç¨‹è°ƒåº¦å™¨ç‰¹æ€§:
â€‚ï¼ˆ1ï¼‰ä½¿æ¯ä¸ªå¤„ç†å™¨è´Ÿè½½å°½å¯èƒ½å‡è¡¡
â€‚ï¼ˆ2ï¼‰è®¾ç½®è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§(affinity)ï¼Œå³å…è®¸è¿›ç¨‹åœ¨å“ªäº›å¤„ç†å™¨ä¸Šæ‰§è¡Œ
â€‚ï¼ˆ3ï¼‰è¿›ç¨‹ä»ä¸€ä¸ªå¤„ç†å™¨è¿ç§»åˆ°å¦ä¸€ä¸ªå¤„ç†å™¨</p>
<h3 id="291-è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§">2.9.1 è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§<a hidden class="anchor" aria-hidden="true" href="#291-è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§">#</a></h3>
<p>â€‚è¿›ç¨‹æè¿°ç¬¦å¢åŠ ä¸¤ä¸ªæˆå‘˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> task_struct {
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span>               nr_cpus_allowed;   <span style="color:#75715e">// ä¿å­˜å…è®¸çš„å¤„ç†å™¨æ©ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">cpumask_t</span>         cpus_allowed;		<span style="color:#75715e">// ä¿å­˜å…è®¸çš„å¤„ç†å™¨æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h4 id="1åº”ç”¨ç¼–ç¨‹æ¥å£">1.åº”ç”¨ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#1åº”ç”¨ç¼–ç¨‹æ¥å£">#</a></h4>
<p>â€‚å†…æ ¸ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// sched_setaffinityç”¨æ¥è®¾ç½®è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§æ©ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sched_setaffinity</span>(<span style="color:#66d9ef">pid_t</span> pid, <span style="color:#66d9ef">size_t</span> cpusetsize, <span style="color:#66d9ef">cpu_set_t</span> <span style="color:#f92672">*</span>mask);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sched_getaffinityç”¨æ¥è·å–è¿›ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§æ©ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sched_getaffinity</span>(<span style="color:#66d9ef">pid_t</span> pid, <span style="color:#66d9ef">size_t</span> cpusetsize, <span style="color:#66d9ef">cpu_set_t</span> <span style="color:#f92672">*</span>mask);
</span></span></code></pre></div><p>â€‚å†…æ ¸çº¿ç¨‹å‡½æ•°è®¾ç½®å¤„ç†å™¨äº²å’Œæ€§æ©ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kthread_bindç”¨æ¥æŠŠä¸€ä¸ªåˆšåˆšåˆ›å»ºçš„å†…æ ¸çº¿ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªå¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kthread_bind</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cpu);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// set_cpus_allowed_ptrç”¨æ¥è®¾ç½®å†…æ ¸çº¿ç¨‹çš„å¤„ç†å™¨äº²å’Œæ€§æ©ç 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">set_cpus_allowed_ptr</span>(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> cpumask <span style="color:#f92672">*</span>new_mask);
</span></span></code></pre></div><h4 id="2ä½¿ç”¨cpuseté…ç½®">2.ä½¿ç”¨cpuseté…ç½®<a hidden class="anchor" aria-hidden="true" href="#2ä½¿ç”¨cpuseté…ç½®">#</a></h4>
<p>â€‚cpusetåœ¨å•ç‹¬ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨cpusetä¼ªæ–‡ä»¶ç³»ç»Ÿé…ç½®ï¼Œé…ç½®æ–¹æ³•</p>
<h3 id="292-å¯¹è°ƒåº¦å™¨çš„æ‰©å±•">2.9.2 å¯¹è°ƒåº¦å™¨çš„æ‰©å±•<a hidden class="anchor" aria-hidden="true" href="#292-å¯¹è°ƒåº¦å™¨çš„æ‰©å±•">#</a></h3>
<p>â€ƒSMPç³»ç»Ÿä¸Šï¼Œè°ƒåº¦ç±»å¢åŠ æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/sched/sched.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sched_class {
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SMP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä¸ºè¿›ç¨‹é€‰æ‹©è¿è¡Œé˜Ÿåˆ—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span>  (<span style="color:#f92672">*</span>select_task_rq)(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">int</span> task_cpu, <span style="color:#66d9ef">int</span> sd_flag, <span style="color:#66d9ef">int</span> flags);  
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨è¿›ç¨‹è¢«è¿ç§»åˆ°æ–°çš„å¤„ç†å™¨ä¹‹å‰è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>migrate_task_rq)(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç”¨æ¥åœ¨è¿›ç¨‹è¢«å”¤é†’ä»¥åè°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>task_woken) (<span style="color:#66d9ef">struct</span> rq <span style="color:#f92672">*</span>this_rq, <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>task);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è®¾ç½®å¤„ç†å™¨äº²å’Œæ€§çš„æ—¶å€™æ‰§è¡Œè°ƒåº¦ç±»çš„ç‰¹æ®Šå¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>set_cpus_allowed)(<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>p,
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> cpumask <span style="color:#f92672">*</span>newmask);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚è¿›ç¨‹åœ¨å†…å­˜å’Œç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æœ€å°‘çš„ï¼Œæ˜¯æœ‰ä»·å€¼çš„å®ç°è´Ÿè½½å‡è¡¡çš„æœºä¼šï¼š1ï¼‰åˆ›å»ºæ–°è¿›ç¨‹ï¼Œ2ï¼‰è°ƒç”¨execveè£…è½½ç¨‹åº</p>
<center>åˆ›å»ºæ–°è¿›ç¨‹æ—¶è´Ÿè½½å‡è¡¡</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221106235035.png" alt="20221106235035"  />
</p>
<center>è£…è½½ç¨‹åºæ—¶è´Ÿè½½å‡è¡¡</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221106235110.png" alt="20221106235110"  />
</p>
<h3 id="293-é™æœŸè°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">2.9.3 é™æœŸè°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡<a hidden class="anchor" aria-hidden="true" href="#293-é™æœŸè°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">#</a></h3>
<h3 id="294-å®æ—¶è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">2.9.4 å®æ—¶è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡<a hidden class="anchor" aria-hidden="true" href="#294-å®æ—¶è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">#</a></h3>
<h3 id="295-å…¬å¹³è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">2.9.5 å…¬å¹³è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡<a hidden class="anchor" aria-hidden="true" href="#295-å…¬å¹³è°ƒåº¦ç±»çš„å¤„ç†å™¨è´Ÿè½½å‡è¡¡">#</a></h3>
<h3 id="296-è¿ç§»çº¿ç¨‹">2.9.6 è¿ç§»çº¿ç¨‹<a hidden class="anchor" aria-hidden="true" href="#296-è¿ç§»çº¿ç¨‹">#</a></h3>
<p>â€‚æ¯ä¸ªå¤„ç†å™¨æœ‰ä¸€ä¸ªè¿ç§»çº¿ç¨‹ï¼Œçº¿ç¨‹åç§°æ˜¯â€œmigration/&lt;cpu_id&gt;â€ï¼Œå±äºåœæœºè°ƒåº¦ç±»ï¼Œå¯ä»¥æŠ¢å æ‰€æœ‰å…¶ä»–è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹ä¸å¯ä»¥æŠ¢å å®ƒã€‚è¿ç§»çº¿ç¨‹æœ‰ä¸¤ä¸ªä½œç”¨   <br>
â€‚ï¼ˆ1ï¼‰è°ƒåº¦å™¨å‘å‡ºè¿ç§»è¯·æ±‚ï¼Œè¿ç§»çº¿ç¨‹å¤„ç†è¿ç§»è¯·æ±‚ï¼ŒæŠŠè¿›ç¨‹è¿ç§»åˆ°ç›®æ ‡å¤„ç†å™¨ã€‚
â€‚ï¼ˆ2ï¼‰æ‰§è¡Œä¸»åŠ¨è´Ÿè½½å‡è¡¡ã€‚</p>
<h3 id="297-éš”ç¦»å¤„ç†å™¨">2.9.7 éš”ç¦»å¤„ç†å™¨<a hidden class="anchor" aria-hidden="true" href="#297-éš”ç¦»å¤„ç†å™¨">#</a></h3>
<h2 id="210-è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®‰å…¨">2.10 è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®‰å…¨<a hidden class="anchor" aria-hidden="true" href="#210-è¿›ç¨‹çš„ä¸Šä¸‹æ–‡å®‰å…¨">#</a></h2>
<h1 id="ç¬¬3ç« -å†…å­˜ç®¡ç†">ç¬¬3ç«  å†…å­˜ç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#ç¬¬3ç« -å†…å­˜ç®¡ç†">#</a></h1>
<h2 id="31-å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¶æ„">3.1 å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¶æ„<a hidden class="anchor" aria-hidden="true" href="#31-å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ¶æ„">#</a></h2>
<p>â€ƒç”¨æˆ·ç©ºé—´ã€å†…æ ¸ç©ºé—´å’Œç¡¬ä»¶3ä¸ªå±‚é¢
<img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221107001723.png" alt="20221107001723"  />
</p>
<h4 id="1ç”¨æˆ·ç©ºé—´">1.ç”¨æˆ·ç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#1ç”¨æˆ·ç©ºé—´">#</a></h4>
<p>â€‚åº”ç”¨ç¨‹åºä½¿ç”¨<code>malloc()</code>ç”³è¯·å†…å­˜ï¼Œä½¿ç”¨<code>free()</code>é‡Šæ”¾å†…å­˜ã€‚ <br>
â€‚malloc()å’Œfree()æ˜¯glibcåº“çš„å†…å­˜åˆ†é…å™¨<code>ptmalloc</code>æä¾›çš„æ¥å£ï¼Œptmallocä½¿ç”¨ç³»ç»Ÿè°ƒç”¨<code>brk</code>æˆ–<code>mmap</code>å‘å†…æ ¸ä»¥é¡µä¸ºå•ä½ç”³è¯·å†…å­˜ï¼Œç„¶ååˆ’åˆ†æˆå°å†…å­˜å—åˆ†é…ç»™åº”ç”¨ç¨‹åº    <br>
â€‚ç”¨æˆ·ç©ºé—´çš„å†…å­˜åˆ†é…å™¨ï¼Œé™¤äº†glibcåº“çš„ptmallocï¼Œè¿˜æœ‰è°·æ­Œçš„tcmallocå’ŒFreeBSDçš„<code>jemalloc</code></p>
<h4 id="2å†…æ ¸ç©ºé—´">2.å†…æ ¸ç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#2å†…æ ¸ç©ºé—´">#</a></h4>
<p>ï¼ˆ1ï¼‰å†…æ ¸ç©ºé—´çš„åŸºæœ¬åŠŸèƒ½   <br>
â€ƒè™šæ‹Ÿå†…å­˜ç®¡ç†è´Ÿè´£ä»è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´åˆ†é…è™šæ‹Ÿé¡µï¼Œsys_brkç”¨æ¥æ‰©å¤§æˆ–æ”¶ç¼©å †ï¼Œsys_mmapç”¨æ¥åœ¨å†…å­˜æ˜ å°„åŒºåŸŸåˆ†é…è™šæ‹Ÿé¡µï¼Œsys_munmapç”¨æ¥é‡Šæ”¾è™šæ‹Ÿé¡µ   <br>
â€ƒå†…æ ¸ä½¿ç”¨å»¶è¿Ÿåˆ†é…ç‰©ç†å†…å­˜çš„ç­–ç•¥ï¼Œè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿé¡µçš„æ—¶å€™ï¼Œè§¦å‘é¡µé”™è¯¯å¼‚å¸¸ï¼Œé¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºä»é¡µåˆ†é…å™¨ç”³è¯·ç‰©ç†é¡µï¼Œåœ¨è¿›ç¨‹çš„é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ   <br>
â€‚é¡µåˆ†é…å™¨è´Ÿè´£åˆ†é…ç‰©ç†é¡µï¼Œå½“å‰ä½¿ç”¨çš„é¡µåˆ†é…å™¨æ˜¯ä¼™ä¼´åˆ†é…å™¨ã€‚ <br>
â€ƒå†…æ ¸ç©ºé—´æä¾›äº†æŠŠé¡µåˆ’åˆ†æˆå°å†…å­˜å—åˆ†é…çš„å—åˆ†é…å™¨ï¼Œæä¾›åˆ†é…å†…å­˜çš„æ¥å£kmalloc()å’Œé‡Šæ”¾å†…å­˜çš„æ¥å£kfree()ï¼Œæ”¯æŒ3ç§å—åˆ†é…å™¨ï¼šSLABåˆ†é…å™¨ã€SLUBåˆ†é…å™¨å’ŒSLOBåˆ†é…å™¨ã€‚   \</p>
<p>ï¼ˆ2ï¼‰å†…æ ¸ç©ºé—´çš„æ‰©å±•åŠŸèƒ½ã€‚ \</p>
<p>â€ƒä¸è¿ç»­é¡µåˆ†é…å™¨æä¾›äº†åˆ†é…å†…å­˜çš„æ¥å£vmallocå’Œé‡Šæ”¾å†…å­˜çš„æ¥å£vfree  <br>
â€ƒè¿ç»­å†…å­˜åˆ†é…å™¨ï¼ˆContiguous Memory Allocatorï¼ŒCMAï¼‰ç”¨æ¥ç»™é©±åŠ¨ç¨‹åºé¢„ç•™ä¸€æ®µè¿ç»­çš„å†…å­˜ï¼Œå½“é©±åŠ¨ç¨‹åºä¸ç”¨çš„æ—¶å€™ï¼Œå¯ä»¥ç»™è¿›ç¨‹ä½¿ç”¨ï¼›å½“é©±åŠ¨ç¨‹åºéœ€è¦ä½¿ç”¨çš„æ—¶å€™ï¼ŒæŠŠè¿›ç¨‹å ç”¨çš„å†…å­˜é€šè¿‡å›æ”¶æˆ–è¿ç§»çš„æ–¹å¼è®©å‡ºæ¥ï¼Œç»™é©±åŠ¨ç¨‹åºä½¿ç”¨  \</p>
<h4 id="3ç¡¬ä»¶å±‚é¢">3.ç¡¬ä»¶å±‚é¢<a hidden class="anchor" aria-hidden="true" href="#3ç¡¬ä»¶å±‚é¢">#</a></h4>
<p>â€ƒå¤„ç†å™¨åŒ…å«ä¸€ä¸ªç§°ä¸ºå†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰çš„éƒ¨ä»¶ï¼Œè´Ÿè´£æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€   <br>
â€ƒå†…å­˜ç®¡ç†å•å…ƒåŒ…å«ä¸€ä¸ªç§°ä¸ºé¡µè¡¨ç¼“å­˜ï¼ˆTranslation Lookaside Bufferï¼ŒTLBï¼‰çš„éƒ¨ä»¶ï¼Œä¿å­˜æœ€è¿‘ä½¿ç”¨è¿‡çš„é¡µè¡¨æ˜ å°„ï¼Œé¿å…æ¯æ¬¡æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€éƒ½éœ€è¦æŸ¥è¯¢å†…å­˜ä¸­çš„é¡µè¡¨   \</p>
<h2 id="32-è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€">3.2 è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€<a hidden class="anchor" aria-hidden="true" href="#32-è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€">#</a></h2>
<h3 id="321-è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†">3.2.1 è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†<a hidden class="anchor" aria-hidden="true" href="#321-è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†">#</a></h3>
<p>â€ƒARM64å¤„ç†å™¨ä¸æ”¯æŒå®Œå…¨çš„64ä½è™šæ‹Ÿåœ°å€ï¼ŒARMv8.2 æ ‡å‡†çš„å¤§è™šæ‹Ÿåœ°å€(Large Virtual Addressï¼ŒLVA)æ”¯æŒï¼Œå¹¶ä¸”é¡µé•¿åº¦æ˜¯64KBï¼Œé‚£ä¹ˆè™šæ‹Ÿåœ°å€çš„æœ€å¤§å®½åº¦æ˜¯52ä½    <br>
â€ƒå¯ä»¥ä¸ºè™šæ‹Ÿåœ°å€é…ç½®æ¯”æœ€å¤§å®½åº¦å°çš„å®½åº¦ï¼Œå¹¶ä¸”å¯ä»¥ä¸ºå†…æ ¸è™šæ‹Ÿåœ°å€å’Œç”¨æˆ·è™šæ‹Ÿåœ°å€é…ç½®ä¸åŒçš„å®½åº¦ã€‚è½¬æ¢æ§åˆ¶å¯„å­˜å™¨ï¼ˆTranslation Control Registerï¼‰TCR_EL1çš„å­—æ®µT0SZå®šä¹‰äº†å¿…é¡»æ˜¯å…¨0çš„æœ€é«˜ä½çš„æ•°é‡ï¼Œå­—æ®µT1SZå®šä¹‰äº†å¿…é¡»æ˜¯å…¨1çš„æœ€é«˜ä½çš„æ•°é‡ï¼Œç”¨æˆ·è™šæ‹Ÿåœ°å€çš„å®½åº¦æ˜¯ï¼ˆ64-TCR_EL1.T0SZï¼‰ï¼Œå†…æ ¸è™šæ‹Ÿåœ°å€çš„å®½åº¦æ˜¯ï¼ˆ64-TCR_EL1.T1SZï¼‰   \</p>
<table>
	<tr>
	    <th>é¡µé•¿åº¦</th>
	    <th>è™šæ‹Ÿåœ°å€å®½åº¦</th>
	</tr >
	<tr >
	    <td>4KB</td>
	    <td>39</td>
	</tr>
	<tr >
	    <td>16KB</td>
	    <td>47</td>
	</tr>
	<tr >
	    <td>64KB</td>
	    <td>42</td>
	</tr>
	<tr >
	    <td colspan="2">å¯é€‰æ‹©48ä½è™šæ‹Ÿåœ°å€</td>
	</tr>
</table>
<h3 id="322-ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€">3.2.2 ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€<a hidden class="anchor" aria-hidden="true" href="#322-ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´å¸ƒå±€">#</a></h3>
<p>â€‚è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€æ˜¯0ï¼Œé•¿åº¦æ˜¯TASK_SIZEï¼ŒARM64æ¶æ„ä¸‹TASK_SIZEä¸‹  <br>
â€‚ï¼ˆ1ï¼‰32ä½ç”¨æˆ·ç©ºé—´ç¨‹åºï¼šTASK_SIZEå€¼æ˜¯TASK_SIZE_32ï¼Œå³0x100000000ï¼Œ4GB    <br>
â€‚ï¼ˆ2ï¼‰64ä½ç”¨æˆ·ç©ºé—´ç¨‹åºï¼šTASK_SIZEå€¼æ˜¯TASK_SIZE_64ï¼Œå³ <code>2^VA_BITS</code>ï¼ŒVA_BITSæ˜¯ç¼–è¯‘å†…æ ¸æ—¶é€‰æ‹©çš„è™šæ‹Ÿåœ°å€ä½æ•°ã€‚   \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//arch/arm64/include/asm/memory.h    linux4.x
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define VA_BITS          (CONFIG_ARM64_VA_BITS)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define TASK_SIZE_64     (UL(1) &lt;&lt; VA_BITS)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_COMPAT    </span><span style="color:#75715e">/* æ”¯æŒæ‰§è¡Œ32ä½ç”¨æˆ·ç©ºé—´ç¨‹åº */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define TASK_SIZE_32     UL(0x100000000)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* test_thread_flag(TIF_32BIT)åˆ¤æ–­ç”¨æˆ·ç©ºé—´ç¨‹åºæ˜¯ä¸æ˜¯32ä½ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define TASK_SIZE       (test_thread_flag(TIF_32BIT) ? \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  TASK_SIZE_32 : TASK_SIZE_64)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define TASK_SIZE_OF(tsk)  (test_tsk_thread_flag(tsk, TIF_32BIT) ? \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                  TASK_SIZE_32 : TASK_SIZE_64)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define TASK_SIZE    TASK_SIZE_64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_COMPAT */</span><span style="color:#75715e">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/include/asm/memory.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define VA_BITS			(CONFIG_ARM64_VA_BITS)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define _PAGE_OFFSET(va)	(-(UL(1) &lt;&lt; (va)))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PAGE_OFFSET		(_PAGE_OFFSET(VA_BITS))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define KIMAGE_VADDR		(MODULES_END)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BPF_JIT_REGION_START	(KASAN_SHADOW_END)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BPF_JIT_REGION_SIZE	(SZ_128M)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define BPF_JIT_REGION_END	(BPF_JIT_REGION_START + BPF_JIT_REGION_SIZE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MODULES_END		(MODULES_VADDR + MODULES_VSIZE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MODULES_VADDR		(BPF_JIT_REGION_END)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MODULES_VSIZE		(SZ_128M)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define VMEMMAP_START		(-VMEMMAP_SIZE - SZ_2M)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define VMEMMAP_END		(VMEMMAP_START + VMEMMAP_SIZE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PCI_IO_END		(VMEMMAP_START - SZ_2M)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define PCI_IO_START		(PCI_IO_END - PCI_IO_SIZE)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define FIXADDR_TOP		(PCI_IO_START - SZ_2M)
</span></span></span></code></pre></div><p>â€‚è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´åŒ…å«ï¼š    <br>
â€‚ï¼ˆ1ï¼‰ä»£ç æ®µã€æ•°æ®æ®µå’Œæœªåˆå§‹åŒ–æ•°æ®æ®µ    <br>
â€‚ï¼ˆ2ï¼‰åŠ¨æ€åº“ä»£ç æ®µã€æ•°æ®æ®µå’Œåˆå§‹åŒ–æ•°æ®æ®µ    <br>
â€‚ï¼ˆ3ï¼‰å­˜æ”¾åŠ¨æ€ç”Ÿæˆçš„æ•°æ®çš„å †      <br>
â€‚ï¼ˆ4ï¼‰å­˜æ”¾å±€éƒ¨å˜é‡å’Œå®ç°å‡½æ•°è°ƒç”¨çš„æ ˆ   <br>
â€‚ï¼ˆ5ï¼‰å­˜æ”¾åœ¨æ ˆåº•éƒ¨çš„ç¯å¢ƒå˜é‡å’Œå‚æ•°å­—ç¬¦ä¸²   <br>
â€‚ï¼ˆ6ï¼‰æŠŠæ–‡ä»¶åŒºé—´æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…å­˜æ˜ å°„åŒºåŸŸ   <br>
â€ƒå†…æ ¸ä½¿ç”¨å†…å­˜æè¿°ç¬¦<code>mm_struct</code>æè¿°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…å­˜æè¿°ç¬¦ä¸»è¦æˆå‘˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">atomic_t</span> mm_users;  <span style="color:#75715e">// å…±äº«åŒä¸€ä¸ªç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´è¿›ç¨‹çš„æ•°é‡ï¼Œå³çº¿ç¨‹ç»„åŒ…å«çš„è¿›ç¨‹çš„æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">atomic_t</span> mm_count;  <span style="color:#75715e">// å†…å­˜æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>mmap;  <span style="color:#75715e">// è™šæ‹Ÿå†…å­˜åŒºåŸŸé“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> rb_root mm_rb;  <span style="color:#75715e">// è™šæ‹Ÿå†…å­˜åŒºåŸŸçº¢é»‘æ ‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#a6e22e">long</span>(<span style="color:#f92672">*</span>get_unmapped_area)(<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>filp, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> len, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pgoff, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags);  <span style="color:#75715e">// åœ¨å†…å­˜æ˜ å°„åŒºåŸŸæ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰æ˜ å°„çš„åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pgd_t</span> <span style="color:#f92672">*</span>pgd;  <span style="color:#75715e">// æŒ‡å‘é¡µå…¨å±€ç›®å½•ï¼Œå³ç¬¬ä¸€çº§é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> mmap_base;  <span style="color:#75715e">// å†…å­˜æ˜ å°„åŒºçš„èµ·å§‹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> task_size;  <span style="color:#75715e">// ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´çš„é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start_code, end_code;  <span style="color:#75715e">// ä»£ç æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start_data, end_data;  <span style="color:#75715e">// æ•°æ®æ®µçš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start_brk, brk;  <span style="color:#75715e">// å †çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start_stack;  <span style="color:#75715e">// æ ˆçš„èµ·å§‹åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> arg_start, arg_end;  <span style="color:#75715e">// å‚æ•°å­—ç¬¦ä¸²èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> env_start, env_end;  <span style="color:#75715e">// ç¯å¢ƒå˜é‡çš„èµ·å§‹åœ°å€å’Œç»“æŸåœ°å€
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm;  <span style="color:#75715e">// è¿›ç¨‹mmæŒ‡å‘ä¸€ä¸ªå†…å­˜æè¿°ç¬¦ï¼Œå†…æ ¸çº¿ç¨‹mmä¸ºç©ºæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> mm_struct<span style="color:#960050;background-color:#1e0010">ã€€</span><span style="color:#f92672">*</span>active_mm;  <span style="color:#75715e">// è¿›ç¨‹çš„active_mmå’Œmmæ€»æ˜¯æŒ‡å‘åŒä¸€ä¸ªå†…å­˜æè¿°ç¬¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å†…æ ¸çº¿ç¨‹çš„active_mmåœ¨æ²¡æœ‰è¿è¡Œæ—¶æ˜¯ç©ºæŒ‡é’ˆï¼Œåœ¨è¿è¡Œæ—¶æŒ‡å‘ä»ä¸Šä¸€ä¸ªè¿›ç¨‹å€Ÿç”¨çš„å†…å­˜æè¿°ç¬¦
</span></span></span></code></pre></div><p>â€‚è¿›ç¨‹åœ°å€ç©ºé—´éšæœºåŒ–ï¼š  <br>
â€‚ï¼ˆ1ï¼‰è¿›ç¨‹æè¿°ç¬¦æˆå‘˜personalityæ˜¯å¦è®¾ç½®ADDR_NO_RANDOMIZE   <br>
â€‚ï¼ˆ2ï¼‰å…¨å±€å˜é‡<code>randomize_va_spce</code>ï¼š0è¡¨ç¤ºå…³é—­è™šæ‹Ÿåœ°å€ç©ºé—´éšæœºåŒ–ï¼Œ1è¡¨ç¤ºå†…å­˜æ˜ å°„åŒºå’Œæ ˆèµ·å§‹åœ°å€éšæœºåŒ–ï¼Œ2è¡¨ç¤ºå†…å­˜æ˜ å°„åŒºã€æ ˆå’Œå †èµ·å§‹åœ°å€éšæœºåŒ–ï¼Œæ–‡ä»¶<code>/proc/sys/kernel/randomize_va_space</code>ä¿®æ”¹ \</p>
<p>â€‚æ ˆå‘ä¸‹å¢é•¿ï¼Œèµ·å§‹åœ°å€STACK_TOPï¼Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/processor.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define STACK_TOP_MAX         TASK_SIZE_64
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_COMPAT  </span><span style="color:#75715e">/* æ”¯æŒæ‰§è¡Œ32ä½ç”¨æˆ·ç©ºé—´ç¨‹åº */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define AARCH32_VECTORS_BASE  0xffff0000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define STACK_TOP   (test_thread_flag(TIF_32BIT) ? \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 AARCH32_VECTORS_BASE : STACK_TOP_MAX)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define STACK_TOP    STACK_TOP_MAX
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_COMPAT */</span><span style="color:#75715e">
</span></span></span></code></pre></div><p>â€‚å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€æ˜¯å†…å­˜æè¿°ç¬¦çš„æˆå‘˜ mmap_base</p>
<center>ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä¸¤ç§å¸ƒå±€</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221109013928.png" alt="20221109013928"  />
</p>
<p>â€‚æ–°å¸ƒå±€ï¼šå†…å­˜æ˜ å°„åŒºåŸŸè‡ªé¡¶å‘ä¸‹å¢é•¿ï¼Œèµ·å§‹åœ°å€æ˜¯(STACK_TOP âˆ’ æ ˆçš„æœ€å¤§é•¿åº¦ âˆ’ é—´éš™)ï¼Œé»˜è®¤å¯ç”¨å†…å­˜æ˜ å°„åŒºåŸŸéšæœºåŒ–ï¼Œéœ€è¦æŠŠèµ·å§‹åœ°å€å‡å»ä¸€ä¸ªéšæœºå€¼   \</p>
<p>â€‚è¿›ç¨‹è°ƒç”¨execveä»¥è£…è½½ELFæ–‡ä»¶çš„æ—¶å€™ï¼Œå‡½æ•°load_elf_binaryå°†ä¼šåˆ›å»ºè¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´   \</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221109014232.png" alt="20221109014232"  />
</p>
<p>â€‚å‡½æ•°arch_pick_mmap_layoutè´Ÿè´£é€‰æ‹©å†…å­˜æ˜ å°„åŒºåŸŸçš„å¸ƒå±€ã€‚ARM64æ¶æ„å®šä¹‰çš„å‡½æ•°arch_pick_mmap_layout</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/mm/util.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">arch_pick_mmap_layout</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#66d9ef">struct</span> rlimit <span style="color:#f92672">*</span>rlim_stack)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> random_factor <span style="color:#f92672">=</span> <span style="color:#ae81ff">0UL</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (current<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> PF_RANDOMIZE)
</span></span><span style="display:flex;"><span>		random_factor <span style="color:#f92672">=</span> <span style="color:#a6e22e">arch_mmap_rnd</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">mmap_is_legacy</span>(rlim_stack)) { <span style="color:#75715e">// è‡ªåº•å‘ä¸Š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		mm<span style="color:#f92672">-&gt;</span>mmap_base <span style="color:#f92672">=</span> TASK_UNMAPPED_BASE <span style="color:#f92672">+</span> random_factor;
</span></span><span style="display:flex;"><span>		mm<span style="color:#f92672">-&gt;</span>get_unmapped_area <span style="color:#f92672">=</span> arch_get_unmapped_area;  <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> {  <span style="color:#75715e">// è‡ªé¡¶å‘ä¸‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		mm<span style="color:#f92672">-&gt;</span>mmap_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">mmap_base</span>(random_factor, rlim_stack);
</span></span><span style="display:flex;"><span>		mm<span style="color:#f92672">-&gt;</span>get_unmapped_area <span style="color:#f92672">=</span> arch_get_unmapped_area_topdown;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mmap_is_legacy</span>(<span style="color:#66d9ef">struct</span> rlimit <span style="color:#f92672">*</span>rlim_stack)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (current<span style="color:#f92672">-&gt;</span>personality <span style="color:#f92672">&amp;</span> ADDR_COMPAT_LAYOUT)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (rlim_stack<span style="color:#f92672">-&gt;</span>rlim_cur <span style="color:#f92672">==</span> RLIM_INFINITY)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> sysctl_legacy_va_layout;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€çš„è®¡ç®—</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// linux-5.10.102/arch/arm64/include/asm/efi.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_COMPAT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define STACK_RND_MASK			(test_thread_flag(TIF_32BIT) ? \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">						0x7ff &gt;&gt; (PAGE_SHIFT - 12) : \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">						0x3ffff &gt;&gt; (PAGE_SHIFT - 12))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define STACK_RND_MASK			(0x3ffff &gt;&gt; (PAGE_SHIFT - 12))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/mmap.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define MIN_GAP (SZ_128M + ((STACK_RND_MASK &lt;&lt; PAGE_SHIFT) + 1))
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_GAP (STACK_TOP/6*5)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">mmap_base</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> rnd)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> gap <span style="color:#f92672">=</span> <span style="color:#a6e22e">rlimit</span>(RLIMIT_STACK);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> (gap <span style="color:#f92672">&lt;</span> MIN_GAP)
</span></span><span style="display:flex;"><span>           gap <span style="color:#f92672">=</span> MIN_GAP;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (gap <span style="color:#f92672">&gt;</span> MAX_GAP)
</span></span><span style="display:flex;"><span>           gap <span style="color:#f92672">=</span> MAX_GAP;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">PAGE_ALIGN</span>(STACK_TOP <span style="color:#f92672">-</span> gap <span style="color:#f92672">-</span> rnd);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°load_elf_binaryï¼šå‡½æ•°setup_arg_pagesæŠŠæ ˆé¡¶è®¾ç½®ä¸ºSTACK_TOPå‡å»éšæœºå€¼ï¼Œç„¶åæŠŠç¯å¢ƒå˜é‡å’Œå‚æ•°ä»ä¸´æ—¶æ ˆç§»åˆ°æœ€ç»ˆçš„ç”¨æˆ·æ ˆï¼›å‡½æ•°set_brkè®¾ç½®å †çš„èµ·å§‹åœ°å€ï¼Œå¦‚æœå¯ç”¨å †éšæœºåŒ–ï¼ŒæŠŠå †çš„èµ·å§‹åœ°å€åŠ ä¸Šéšæœºå€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// fs/binfmt_elf.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">load_elf_binary</span>(<span style="color:#66d9ef">struct</span> linux_binprm <span style="color:#f92672">*</span>bprm)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">setup_arg_pages</span>(bprm, <span style="color:#a6e22e">randomize_stack_top</span>(STACK_TOP),
</span></span><span style="display:flex;"><span>                     executable_stack);
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     retval <span style="color:#f92672">=</span> <span style="color:#a6e22e">set_brk</span>(elf_bss, elf_brk, bss_prot);
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> ((current<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> PF_RANDOMIZE) <span style="color:#f92672">&amp;&amp;</span> (randomize_va_space <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>)) {
</span></span><span style="display:flex;"><span>           current<span style="color:#f92672">-&gt;</span>mm<span style="color:#f92672">-&gt;</span>brk <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>mm<span style="color:#f92672">-&gt;</span>start_brk <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">arch_randomize_brk</span>(current<span style="color:#f92672">-&gt;</span>mm);
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="323-å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€">3.2.3 å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€<a hidden class="anchor" aria-hidden="true" href="#323-å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€">#</a></h3>
<center>ARM64å¤„ç†å™¨æ¶æ„å†…æ ¸åœ°å€ç©ºé—´å¸ƒå±€</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221109225722.png" alt="20221109225722"  />
</p>
<p>â€‚(1)å…ˆè¡Œæ˜ å°„åŒºèŒƒå›´[PAGE_OFFSET, 2^64-1]ï¼Œèµ·å§‹åœ°å€PAGE_OFFSET = (OxFFFF FFFF FFFF FFFF &laquo; (VA_BITS-1))ï¼Œé•¿åº¦ä¸ºå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€åŠï¼Œè™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯çº¿æ€§å…³ç³»  \
â€ƒè™šæ‹Ÿåœ°å€ = ((ç‰©ç†åœ°å€-PHYS_OFFSET)+PAGE_OFFSET)ï¼ŒPHY_OFFSETæ˜¯å†…å­˜èµ·å§‹ç‰©ç†åœ°å€
â€‚(2)vmemmap åŒºåŸŸçš„èŒƒå›´æ˜¯[VMEMMAP_START, PAGE_OFFSET)ï¼Œé•¿åº¦æ˜¯VMEMMAP_SIZE =ï¼ˆçº¿æ€§æ˜ å°„åŒºåŸŸçš„é•¿åº¦ / é¡µé•¿åº¦ * pageç»“æ„ä½“çš„é•¿åº¦ä¸Šé™ï¼‰
â€‚(3)PCI I/OåŒºåŸŸçš„èŒƒå›´æ˜¯[PCI_IO_START, PCI_IO_END)ï¼Œé•¿åº¦æ˜¯16MBï¼Œç»“æŸåœ°å€æ˜¯PCI_IO_END = (VMEMMAP_START âˆ’ 2MB)ã€‚å¤–å›´ç»„ä»¶äº’è”ï¼ˆPeripheral Component Interconnectï¼ŒPCIï¼‰æ˜¯ä¸€ç§æ€»çº¿æ ‡å‡†ï¼ŒPCI I/OåŒºåŸŸæ˜¯PCIè®¾å¤‡çš„I/Oåœ°å€ç©ºé—´
â€‚(4)å®šæ˜ å°„åŒºåŸŸçš„èŒƒå›´æ˜¯[FIXADDR_START, FIXADDR_TOP)ï¼Œé•¿åº¦æ˜¯FIXADDR_SIZEï¼Œç»“æŸåœ°å€æ˜¯FIXADDR_TOP = (PCI_IO_START âˆ’ 2MB)
â€‚(5)vmallocåŒºåŸŸçš„èŒƒå›´æ˜¯[VMALLOC_START, VMALLOC_ENDï¼‰ï¼Œèµ·å§‹åœ°å€æ˜¯VMALLOC_STARTï¼Œç­‰äºå†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€ï¼Œç»“æŸåœ°å€æ˜¯VMALLOC_END = (PAGE_OFFSET âˆ’ PUD_SIZE âˆ’ VMEMMAP_SIZE âˆ’ 64KB)ï¼Œå…¶ä¸­PUD_SIZEæ˜¯é¡µä¸Šçº§ç›®å½•è¡¨é¡¹æ˜ å°„çš„åœ°å€ç©ºé—´çš„é•¿åº¦   <br>
â€ƒvmallocåŒºåŸŸæ˜¯å‡½æ•°vmallocä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…æ ¸é•œåƒåœ¨vmallocåŒºåŸŸï¼Œèµ·å§‹è™šæ‹Ÿåœ°å€æ˜¯(KIMAGE_VADDR + TEXT_OFFSET) ï¼Œå…¶ä¸­KIMAGE_VADDRæ˜¯å†…æ ¸é•œåƒçš„è™šæ‹Ÿåœ°å€çš„åŸºå‡†å€¼ï¼Œç­‰äºå†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€MODULES_ENDï¼›TEXT_OFFSETæ˜¯å†…å­˜ä¸­çš„å†…æ ¸é•œåƒç›¸å¯¹å†…å­˜èµ·å§‹ä½ç½®çš„åç§»      <br>
â€‚(6)å†…æ ¸æ¨¡å—åŒºåŸŸçš„èŒƒå›´æ˜¯[MODULES_VADDR, MODULES_END)ï¼Œé•¿åº¦æ˜¯128MBï¼Œèµ·å§‹åœ°å€æ˜¯MODULES_VADDR =ï¼ˆå†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ + KASANå½±å­åŒºåŸŸçš„é•¿åº¦ï¼‰ã€‚å†…æ ¸æ¨¡å—åŒºåŸŸæ˜¯å†…æ ¸æ¨¡å—ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€ç©ºé—´    <br>
â€‚(7)KASANå½±å­åŒºåŸŸçš„èµ·å§‹åœ°å€æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œé•¿åº¦æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´é•¿åº¦çš„1/8ã€‚å†…æ ¸åœ°å€æ¶ˆæ¯’å‰‚ï¼ˆKernel Address SANitizerï¼ŒKASANï¼‰æ˜¯ä¸€ä¸ªåŠ¨æ€çš„å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·       \</p>
<h2 id="33-ç‰©ç†åœ°å€ç©ºé—´">3.3 ç‰©ç†åœ°å€ç©ºé—´<a hidden class="anchor" aria-hidden="true" href="#33-ç‰©ç†åœ°å€ç©ºé—´">#</a></h2>
<p>â€‚å¤„ç†å™¨é€šè¿‡å¤–å›´è®¾å¤‡æ§åˆ¶å™¨çš„å¯„å­˜å™¨è®¿é—®å¤–å›´è®¾å¤‡ï¼Œå¯„å­˜å™¨åˆ†ä¸ºæ§åˆ¶å¯„å­˜å™¨ã€çŠ¶æ€å¯„å­˜å™¨å’Œæ•°æ®å¯„å­˜å™¨ä¸‰å¤§ç±»ï¼Œå¤–å›´è®¾å¤‡çš„å¯„å­˜å™¨é€šå¸¸è¢«è¿ç»­åœ°ç¼–å€ã€‚å¤„ç†å™¨å¯¹å¤–å›´è®¾å¤‡å¯„å­˜å™¨çš„ç¼–å€æ–¹å¼æœ‰ä¸¤ç§ï¼š     <br>
â€ƒï¼ˆ1ï¼‰I/Oæ˜ å°„æ–¹å¼(I/O-mapped)  <br>
â€ƒï¼ˆ2ï¼‰å†…å­˜æ˜ å°„æ–¹å¼(memroy-mapped)ï¼šç²¾ç®€æŒ‡ä»¤é›†çš„å¤„ç†å™¨é€šå¸¸åªå®ç°ä¸€ä¸ªç‰©ç†åœ°å€ç©ºé—´ï¼Œå¤–å›´è®¾å¤‡å’Œç‰©ç†å†…å­˜ä½¿ç”¨ç»Ÿä¸€çš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œå¤„ç†å™¨å¯ä»¥åƒè®¿é—®ä¸€ä¸ªå†…å­˜å•å…ƒé‚£æ ·è®¿é—®å¤–å›´è®¾å¤‡ï¼Œä¸éœ€è¦æä¾›ä¸“é—¨çš„I/OæŒ‡ä»¤     \</p>
<p>â€ƒç¨‹åºé€šè¿‡è™šæ‹Ÿåœ°å€è®¿é—®å¤–è®¾å¯„å­˜å™¨ï¼Œå†…æ ¸å‡½æ•°æŠŠå¤–è®¾å¯„å­˜å™¨ç‰©ç†åœ°å€æ˜ å°„åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ioremap()æŠŠå¤–è®¾å¯„å­˜å™¨ç‰©ç†åœ°å€æ˜ å°„åˆ°å†…æ ¸è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">ioremap</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> phys_addr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// io_remap_pfn_range()å‡½æ•°æŠŠå¤–è®¾å¯„å­˜å™¨çš„ç‰©ç†åœ°å€æ˜ å°„åˆ°è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">io_remap_pfn_range</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pfn, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size, <span style="color:#66d9ef">pgprot_t</span> prot);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// iounmap()åˆ é™¤å‡½æ•°ioremap()åˆ›å»ºæ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">iounmap</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr);
</span></span></code></pre></div><p>â€‚ARM64æ¶æ„ä¸¤ç§å†…å­˜ç±»å‹ï¼š
â€ƒï¼ˆ1ï¼‰æ­£å¸¸å†…å­˜(Normal Memory)ï¼šåŒ…æ‹¬ç‰©ç†å†…å­˜å’Œåªè¯»å­˜å‚¨å™¨(ROM)ï¼Œå…±äº«å±æ€§å’Œå¯ç¼“å­˜     <br>
â€ƒï¼ˆ2ï¼‰è®¾å¤‡å†…å­˜(Device Memory)ï¼šæŒ‡åˆ†é…ç»™å¤–å›´è®¾å¤‡å¯„å­˜å™¨çš„ç‰©ç†åœ°å€åŒºåŸŸï¼Œå¤–éƒ¨å…±äº«ï¼Œä¸å¯ç¼“å­˜  <br>
â€‚ARM64æ¶æ„3ç§å±æ€§æŠŠè®¾å¤‡åˆ†ä¸º4ç§ç±»å‹:      <br>
â€ƒï¼ˆ1ï¼‰Device-nGnRnE          <br>
â€ƒï¼ˆ2ï¼‰Device-nGnREã€‚          <br>
â€ƒï¼ˆ3ï¼‰Device-nGREã€‚       <br>
â€ƒï¼ˆ4ï¼‰Device-GRE         \</p>
<p>â€‚å¯„å­˜å™¨TCR_EL1ï¼ˆTranslation Control Register for Exception Level 1ï¼Œå¼‚å¸¸çº§åˆ«1çš„è½¬æ¢æ§åˆ¶å¯„å­˜å™¨ï¼‰çš„å­—æ®µIPSï¼ˆIntermediate Physical Address Sizeï¼Œä¸­é—´ç‰©ç†åœ°å€é•¿åº¦ï¼‰æ§åˆ¶ç‰©ç†åœ°å€çš„å®½åº¦ï¼ŒIPSå­—æ®µçš„é•¿åº¦æ˜¯3ä½</p>
<h2 id="34å†…å­˜æ˜ å°„">3.4ã€€å†…å­˜æ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#34å†…å­˜æ˜ å°„">#</a></h2>
<p>â€‚è¿›ç¨‹åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­åˆ›å»ºæ˜ å°„ï¼š
â€ƒï¼ˆ1ï¼‰æ–‡ä»¶æ˜ å°„ï¼ŒæŠŠæ–‡ä»¶ä¸€ä¸ªåŒºé—´æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ•°æ®æºæ˜¯å­˜å‚¨è®¾å¤‡ä¸Šçš„æ–‡ä»¶ï¼Œæ–‡ä»¶é¡µ   <br>
â€ƒï¼ˆ2ï¼‰åŒ¿åæ˜ å°„ï¼ŒæŠŠç‰©ç†å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ— æ•°æ®æºï¼ŒåŒ¿åé¡µ   <br>
â€‚ä¿®æ”¹å¯¹å…¶ä»–è¿›ç¨‹å¯è§å’Œé‡Šæ”¾ä¼ é€’åº•å±‚æ–‡ä»¶ï¼Œå†…å­˜æ˜ å°„åˆ†ä¸ºå…±äº«æ˜ å°„å’Œç§æœ‰æ˜ å°„ã€‚
&amp;enspï¼›ï¼ˆ1ï¼‰å…±äº«æ˜ å°„ï¼šä¿®æ”¹æ•°æ®æ—¶æ˜ å°„ç›¸åŒåŒºåŸŸçš„å…¶ä»–è¿›ç¨‹å¯ä»¥çœ‹è§ï¼Œå¦‚æœæ˜¯æ–‡ä»¶æ”¯æŒçš„æ˜ å°„ï¼Œä¿®æ”¹ä¼šä¼ é€’åˆ°åº•å±‚æ–‡ä»¶ã€‚   <br>
â€‚ï¼ˆ2ï¼‰ç§æœ‰æ˜ å°„ï¼šç¬¬ä¸€æ¬¡ä¿®æ”¹æ•°æ®æ—¶ä¼šä»æ•°æ®æºå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬ï¼Œç„¶åä¿®æ”¹å‰¯æœ¬ï¼Œå…¶ä»–è¿›ç¨‹çœ‹ä¸è§ï¼Œä¸å½±å“æ•°æ®æº    <br>
â€ƒ ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥ä½¿ç”¨å…±äº«çš„æ–‡ä»¶æ˜ å°„å®ç°å…±äº«å†…å­˜ï¼Œè¿›ç¨‹é—´é€šä¿¡ï¼Ÿã€‚åŒ¿åæ˜ å°„é€šå¸¸æ˜¯ç§æœ‰æ˜ å°„ï¼Œå…±äº«çš„åŒ¿åæ˜ å°„åªå¯èƒ½å‡ºç°åœ¨çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´ã€‚    <br>
â€‚è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œä»£ç æ®µå’Œæ•°æ®æ®µæ˜¯ç§æœ‰çš„æ–‡ä»¶æ˜ å°„ï¼Œæœªåˆå§‹åŒ–æ•°æ®æ®µã€å †å’Œæ ˆæ˜¯ç§æœ‰çš„åŒ¿åæ˜ å°„
â€‚å†…å­˜æ˜ å°„çš„åŸç†ã€‚   <br>
â€‚ï¼ˆ1ï¼‰åˆ›å»ºå†…å­˜æ˜ å°„çš„æ—¶å€™ï¼Œåœ¨è¿›ç¨‹çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­åˆ†é…ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸã€‚  <br>
â€‚ï¼ˆ2ï¼‰Linuxå†…æ ¸é‡‡ç”¨å»¶è¿Ÿåˆ†é…ç‰©ç†å†…å­˜çš„ç­–ç•¥ï¼Œåœ¨è¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®è™šæ‹Ÿé¡µçš„æ—¶å€™ï¼Œäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ã€‚å¦‚æœæ˜¯æ–‡ä»¶æ˜ å°„ï¼Œé‚£ä¹ˆåˆ†é…ç‰©ç†é¡µï¼ŒæŠŠæ–‡ä»¶æŒ‡å®šåŒºé—´çš„æ•°æ®è¯»åˆ°ç‰©ç†é¡µä¸­ï¼Œç„¶ååœ¨é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µï¼›å¦‚æœæ˜¯åŒ¿åæ˜ å°„ï¼Œé‚£ä¹ˆåˆ†é…ç‰©ç†é¡µï¼Œç„¶ååœ¨é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ</p>
<h4 id="341-åº”ç”¨ç¼–ç¨‹æ¥å£">3.4.1 åº”ç”¨ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#341-åº”ç”¨ç¼–ç¨‹æ¥å£">#</a></h4>
<p>â€‚ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// 1.mmap()åˆ›å»ºå†…å­˜æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mmap</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, <span style="color:#66d9ef">size_t</span> length, <span style="color:#66d9ef">int</span> prot, <span style="color:#66d9ef">int</span> flags, in fd, <span style="color:#66d9ef">off_t</span> offset);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2. mremap()æ‰©å¤§æˆ–ç¼©å°å†…å­˜æ˜ å°„ï¼Œå¯ç§»åŠ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">mreemap</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>old_address, <span style="color:#66d9ef">size_t</span> old_size, <span style="color:#66d9ef">size_t</span> new_size, <span style="color:#66d9ef">int</span> flags, ... <span style="color:#75715e">/*void *new_address */</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 3. munmap() åˆ é™¤å†…å­˜å°åˆ·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">munmap</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, <span style="color:#66d9ef">size_t</span> length);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 4. brk() è®¾ç½®å †ä¸Šç•Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">brk</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 6. mprotect()è®¾ç½®è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„è®¿é—®æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mprotect</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, <span style="color:#66d9ef">size_t</span> len, <span style="color:#66d9ef">int</span> prot);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 7. madvise ç®±å†…æ ¸ä½“æœ¯å†…å­˜ä½¿ç”¨å»ºè®®ï¼Œé…åˆå†…æ ¸é¢„è¯»å’Œç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">madvise</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, <span style="color:#66d9ef">size_t</span> length, <span style="color:#66d9ef">int</span> advice);
</span></span></code></pre></div><p>â€‚å†…æ ¸ç©ºé—´å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// 1. remap_pfn_rangeæŠŠå†…å­˜çš„ç‰©ç†é¡µæ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå®ç°è¿›ç¨‹å’Œå†…æ ¸å…±äº«å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">remap_pfn_range</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pfn,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size, <span style="color:#66d9ef">pgprot_t</span> prot);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 2.io_remap_pfn_rangeæŠŠå¤–è®¾å¯„å­˜å™¨çš„ç‰©ç†åœ°å€æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œè¿›ç¨‹å¯ä»¥ç›´æ¥è®¿é—®å¤–è®¾å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">io_remap_pfn_range</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> pfn, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size, <span style="color:#66d9ef">pgprot_t</span> prot);
</span></span></code></pre></div><p>â€‚åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨Cæ ‡å‡†åº“æä¾›çš„å‡½æ•°malloc()ç”³è¯·å†…å­˜ã€‚glibcåº“çš„å†…å­˜åˆ†é…å™¨ptmallocä½¿ç”¨brkæˆ–mmapå‘å†…æ ¸ä»¥é¡µä¸ºå•ä½ç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œç„¶åæŠŠé¡µåˆ’åˆ†æˆå°å†…å­˜å—åˆ†é…ç»™åº”ç”¨ç¨‹åºã€‚é»˜è®¤çš„é˜ˆå€¼æ˜¯128KBï¼Œå¦‚æœåº”ç”¨ç¨‹åºç”³è¯·çš„å†…å­˜é•¿åº¦å°äºé˜ˆå€¼ï¼Œptmallocåˆ†é…å™¨ä½¿ç”¨brkå‘å†…æ ¸ç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œå¦åˆ™ptmallocåˆ†é…å™¨ä½¿ç”¨mmapå‘å†…æ ¸ç”³è¯·è™šæ‹Ÿå†…å­˜   \</p>
<p>â€‚åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨mmapå‘å†…æ ¸ç”³è¯·è™šæ‹Ÿå†…å­˜
ç³»ç»Ÿè°ƒç”¨mmap()  <br>
ç³»ç»Ÿè°ƒç”¨mprotect()  <br>
ç³»ç»Ÿè°ƒç”¨madvise()</p>
<h3 id="342-æ•°æ®ç»“æ„">3.4.2 æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#342-æ•°æ®ç»“æ„">#</a></h3>
<h4 id="1-è™šæ‹Ÿå†…å­˜åŒºåŸŸ">1. è™šæ‹Ÿå†…å­˜åŒºåŸŸ<a hidden class="anchor" aria-hidden="true" href="#1-è™šæ‹Ÿå†…å­˜åŒºåŸŸ">#</a></h4>
<p>â€‚å†…æ ¸ä½¿ç”¨ç»“æ„ä½“<code>vm_area_struct</code>æè¿°è™šæ‹Ÿå†…å­˜åŒºåŸŸ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> vm_area_struct {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* The first cache line has the info for VMA tree walking. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Our start address within vm_mm. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_start;	  <span style="color:#75715e">// èµ·å§‹åœ°å€ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">/* The first byte after our end address within vm_mm. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_end;  <span style="color:#75715e">// ç»“æŸåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">/* linked list of VM areas per task, sorted by address */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è™šæ‹Ÿå†…å­˜åŒºåŸŸé“¾è¡¨ï¼ŒæŒ‰èµ·å§‹åœ°å€æ’åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vm_next, <span style="color:#f92672">*</span>vm_prev;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 	çº¢é»‘æ ‘èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> rb_node vm_rb;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Largest free memory gap in bytes to the left of this VMA.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * Either between this VMA and vma-&gt;vm_prev, or between one of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * VMAs below us in the VMA rbtree and its -&gt;vm_prev. This helps
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * get_unmapped_area find a free area of the right size.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> rb_subtree_gap;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Second cache line starts here. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŒ‡å‘å†…å­˜æè¿°ç¬¦ï¼Œå³è™šæ‹Ÿå†…å­˜åŒºåŸŸæ‰€å±çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>vm_mm;	<span style="color:#75715e">/* The address space we belong to. */</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Access permissions of this VMA.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * See vmf_insert_mixed_prot() for discussion.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¿æŠ¤ä½ï¼Œå³è®¿é—®æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">pgprot_t</span> vm_page_prot;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_flags;		<span style="color:#75715e">/* Flags, see mm.h. */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* For areas with an address space and backing store,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * linkage into the address_space-&gt;i_mmap interval tree.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¸ºäº†æ”¯æŒæŸ¥è¯¢ä¸€ä¸ªæ–‡ä»¶åŒºé—´è¢«æ˜ å°„åˆ°å“ªäº›è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// æŠŠä¸€ä¸ªæ–‡ä»¶æ˜ å°„åˆ°çš„æ‰€æœ‰è™šæ‹Ÿå†…å­˜åŒºåŸŸåŠ å…¥è¯¥æ–‡ä»¶çš„åœ°å€ç©ºé—´ç»“æ„ä½“
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// address_spaceçš„æˆå‘˜i_mmapæŒ‡å‘çš„åŒºé—´æ ‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">struct</span> rb_node rb;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> rb_subtree_last;
</span></span><span style="display:flex;"><span>	} shared;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/*  file&#39;s MAP_PRIVATE vma can be in both i_mmap tree and anon_vma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * list, after a COW of one of the file pages.	A MAP_SHARED vma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * can only be in the i_mmap tree.  An anonymous MAP_PRIVATE, stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	 * or brk vma (with NULL file) can only be in an anon_vma list.*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠè™šæ‹Ÿå†…å­˜åŒºåŸŸå…³è”çš„æ‰€æœ‰anon_vmaå®ä¾‹ä¸²è”èµ·æ¥ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä¸€ä¸ªè™šæ‹Ÿå†…å­˜åŒºåŸŸä¼šå…³è”åˆ°çˆ¶è¿›ç¨‹çš„anon_vmaå®ä¾‹å’Œè‡ªå·±çš„anon_vmaå®ä¾‹ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> list_head anon_vma_chain; <span style="color:#75715e">/* Serialized by mmap_lock &amp;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">					  * page_table_lock */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŒ‡å‘ä¸€ä¸ªanon_vmaå®ä¾‹ï¼Œç»“æ„ä½“anon_vmaç”¨æ¥ç»„ç»‡åŒ¿åé¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¢«æ˜ å°„åˆ°çš„æ‰€æœ‰è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> anon_vma <span style="color:#f92672">*</span>anon_vma;	<span style="color:#75715e">/* Serialized by page_table_lock */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Function pointers to deal with this struct. */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> vm_operations_struct <span style="color:#f92672">*</span>vm_ops;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* Information about our backing store: */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ–‡ä»¶åç§»ï¼Œå•ä½æ˜¯é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_pgoff;		<span style="color:#75715e">/* Offset (within vm_file) in PAGE_SIZE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">					   units */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ–‡ä»¶ï¼Œå¦‚æœæ˜¯ç§æœ‰çš„åŒ¿åæ˜ å°„ï¼Œè¯¥æˆå‘˜æ˜¯ç©ºæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span> vm_file;		<span style="color:#75715e">/* File we map to (can be NULL). */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> vm_private_data;		<span style="color:#75715e">/* was vm_pte (shared mem) */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_SWAP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">atomic_long_t</span> swap_readahead_info;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef CONFIG_MMU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> vm_region <span style="color:#f92672">*</span>vm_region;	<span style="color:#75715e">/* NOMMU mapping region */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_NUMA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> mempolicy <span style="color:#f92672">*</span>vm_policy;	<span style="color:#75715e">/* NUMA policy for the VMA */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> vm_userfaultfd_ctx vm_userfaultfd_ctx;
</span></span><span style="display:flex;"><span>} __randomize_layout;
</span></span></code></pre></div><center>æ–‡ä»¶æ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221111234010.png" alt="20221111234010"  />
</p>
<p>â€‚ï¼ˆ1ï¼‰æˆå‘˜vm_fileæŒ‡å‘æ–‡ä»¶çš„ä¸€ä¸ªæ‰“å¼€å®ä¾‹ï¼ˆfileï¼‰ã€‚ç´¢å¼•èŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªæ–‡ä»¶ï¼Œæè¿°æ–‡ä»¶çš„å±æ€§ã€‚    <br>
â€‚ï¼ˆ2ï¼‰æˆå‘˜vm_pgoffå­˜æ”¾æ–‡ä»¶çš„ä»¥é¡µä¸ºå•ä½çš„åç§»ã€‚   <br>
â€‚ï¼ˆ3ï¼‰æˆå‘˜vm_opsæŒ‡å‘è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆï¼Œåˆ›å»ºæ–‡ä»¶æ˜ å°„çš„æ—¶å€™è°ƒç”¨æ–‡ä»¶æ“ä½œé›†åˆä¸­çš„mmapæ–¹æ³•ï¼ˆfile-&gt;f_op-&gt;mmapï¼‰ä»¥æ³¨å†Œè™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆã€‚ä¾‹å¦‚ï¼šå‡è®¾æ–‡ä»¶å±äºEXT4æ–‡ä»¶ç³»ç»Ÿï¼Œæ–‡ä»¶æ“ä½œé›†åˆä¸­çš„mmapæ–¹æ³•æ˜¯å‡½æ•°ext4_file_mmapï¼Œè¯¥å‡½æ•°æŠŠè™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æˆå‘˜vm_opsè®¾ç½®ä¸ºext4_file_vm_ops</p>
<center>å…±äº«åŒ¿åæ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221111234048.png" alt="20221111234048"  />
</p>
<p>â€‚ï¼ˆ1ï¼‰æˆå‘˜vm_fileæŒ‡å‘æ–‡ä»¶çš„ä¸€ä¸ªæ‰“å¼€å®ä¾‹ï¼ˆfileï¼‰ã€‚   <br>
â€‚ï¼ˆ2ï¼‰æˆå‘˜vm_pgoffå­˜æ”¾æ–‡ä»¶çš„ä»¥é¡µä¸ºå•ä½çš„åç§»ã€‚   <br>
â€‚ï¼ˆ3ï¼‰æˆå‘˜vm_opsæŒ‡å‘å…±äº«å†…å­˜çš„è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆshmem_vm_opsã€‚</p>
<center>ç§æœ‰åŒ¿åæ˜ å°„çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zhuangll/PictureBed/main/blogs/pictures/20221112001338.png" alt="20221112001338"  />
</p>
<p>â€‚ï¼ˆ1ï¼‰é¡µä¿æŠ¤ä½ï¼ˆvm_area_struct.vm_page_protï¼‰ï¼šæè¿°è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„è®¿é—®æƒé™ã€‚å†…æ ¸å®šä¹‰äº†ä¸€ä¸ªä¿æŠ¤ä½æ˜ å°„æ•°ç»„ï¼ŒæŠŠVM_READã€VM_WRITEã€VM_EXECå’ŒVM_SHAREDè¿™4ä¸ªæ ‡å¿—è½¬æ¢æˆä¿æŠ¤ä½ç»„åˆ        <br>
â€‚Pä»£è¡¨ç§æœ‰ï¼ˆPrivateï¼‰ï¼ŒSä»£è¡¨å…±äº«ï¼ˆSharedï¼‰ï¼Œåé¢çš„3ä¸ªæ•°å­—åˆ†åˆ«è¡¨ç¤ºå¯è¯»ã€å¯å†™å’Œå¯æ‰§è¡Œï¼Œä¾‹å¦‚__P000è¡¨ç¤ºç§æœ‰ã€ä¸å¯è¯»ã€ä¸å¯å†™å’Œä¸å¯æ‰§è¡Œï¼Œ__S111è¡¨ç¤ºå…±äº«ã€å¯è¯»ã€å¯å†™å’Œå¯æ‰§è¡Œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/mmap.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">pgprot_t</span> protection_map[<span style="color:#ae81ff">16</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    __P000, __P001, __P010, __P011, __P100, __P101, __P110, __P111,
</span></span><span style="display:flex;"><span>    __S000, __S001, __S010, __S011, __S100, __S101, __S110, __S111
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">pgprot_t</span> <span style="color:#a6e22e">vm_get_page_prot</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">__pgprot</span>(<span style="color:#a6e22e">pgprot_val</span>(protection_map[vm_flags <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                (VM_READ<span style="color:#f92672">|</span>VM_WRITE<span style="color:#f92672">|</span>VM_EXEC<span style="color:#f92672">|</span>VM_SHARED)]) <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">pgprot_val</span>(<span style="color:#a6e22e">arch_vm_get_page_prot</span>(vm_flags)));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mman.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifndef arch_vm_get_page_prot
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define arch_vm_get_page_prot(vm_flags) __pgprot(0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><p>â€‚è™šæ‹Ÿå†…å­˜åŒºåŸŸæ ‡å¿—ï¼šç»“æ„ä½“vm_area_structçš„æˆå‘˜vm_flagså­˜æ”¾è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ ‡å¿—ï¼Œå¤´æ–‡ä»¶â€œinclude/linux/mm.hâ€å®šä¹‰äº†å„ç§æ ‡å¿—         <br>
VM_READã€VM_WRITEã€VM_EXECã€VM_SHAREDã€VM_GROWSDOWNã€VM_DONTEXPANDã€VM_ACCOUNTã€VM_NORESERVEã€VM_HUGETLBã€VM_ARCH_1ã€VM_ARCH_2ã€VM_HUGEPAGEã€VM_MERGEABLE</p>
<p>â€‚è™šæ‹Ÿå†…å­˜æ“ä½œé›†åˆï¼ˆvm_operations_structï¼‰ï¼šå®šä¹‰äº†è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„å„ç§æ“ä½œæ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mm.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> vm_operations_struct {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨åˆ›å»ºè™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨openæ–¹æ³•ï¼Œé€šå¸¸ä¸ä½¿ç”¨ï¼Œè®¾ç½®ä¸ºç©ºæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>open)(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span> area);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨åˆ é™¤è™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨closeæ–¹æ³•ï¼Œé€šå¸¸ä¸ä½¿ç”¨ï¼Œè®¾ç½®ä¸ºç©ºæŒ‡é’ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>close)(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span> area);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨mremapç§»åŠ¨è™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨mremapæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>mremap)(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span> area);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨mremapç§»åŠ¨è™šæ‹Ÿå†…å­˜åŒºåŸŸæ—¶è°ƒç”¨mremapæ–¹æ³•
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>fault)(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// huge_faultæ–¹æ³•é’ˆå¯¹ä½¿ç”¨é€æ˜å·¨å‹é¡µçš„æ–‡ä»¶æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>huge_fault)(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf, <span style="color:#66d9ef">enum</span> page_entry_size pe_size);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è¯»æ–‡ä»¶æ˜ å°„çš„è™šæ‹Ÿé¡µæ—¶ï¼Œå¦‚æœæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µï¼Œç”Ÿæˆç¼ºé¡µå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>map_pages)(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf,
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">pgoff_t</span> start_pgoff, <span style="color:#66d9ef">pgoff_t</span> end_pgoff);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* é€šçŸ¥ä»¥å‰çš„åªè¯»é¡µå³å°†å˜æˆå¯å†™ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	* å¦‚æœè¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå°†ä¼šå‘é€ä¿¡å·SIGBUSç»™è¿›ç¨‹*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>page_mkwrite)(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* ä½¿ç”¨VM_PFNMAPæˆ–è€…VM_MIXEDMAPæ—¶è°ƒç”¨ï¼ŒåŠŸèƒ½å’Œpage_mkwriteç›¸åŒ*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>pfn_mkwrite)(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2é“¾è¡¨å’Œæ ‘">2.é“¾è¡¨å’Œæ ‘<a hidden class="anchor" aria-hidden="true" href="#2é“¾è¡¨å’Œæ ‘">#</a></h4>
<center>è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„é“¾è¡¨å’Œæ ‘</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221114005059.png" alt="20221114005059"  />

â€‚(1)åŒå‘é“¾è¡¨ï¼Œmm_struct.mmapæŒ‡å‘ç¬¬ä¸€ä¸ªvm_area_structå®ä¾‹   <br>
â€‚(2)çº¢é»‘æ ‘ï¼Œmm_struct.mm_rbæŒ‡å‘çº¢é»‘æ ‘çš„æ ¹    \</p>
<h3 id="343-åˆ›å»ºå†…å­˜æ˜ å°„">3.4.3 åˆ›å»ºå†…å­˜æ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#343-åˆ›å»ºå†…å­˜æ˜ å°„">#</a></h3>
<p>â€‚Cæ ‡å‡†åº“å°è£…äº†å‡½æ•°mmapç”¨æ¥åˆ›å»ºå†…å­˜æ˜ å°„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>asmlinkage <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sys_mmap</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> len, 
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> prot, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, 
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> fd, <span style="color:#66d9ef">off_t</span> off); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>asmlinkage <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sys_mmap2</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> len, 
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> prot, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, 
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> fd, <span style="color:#66d9ef">off_t</span> off); 
</span></span></code></pre></div><p>â€‚ARM64æ¶æ„åªå®ç°ç³»ç»Ÿè°ƒç”¨mmap</p>
<center>ç³»ç»Ÿè°ƒç”¨sys_mmapæ‰§è¡Œæµç¨‹</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221114010335.png" alt="20221114010335"  />
</p>
<center>do_mmapçš„æ‰§è¡Œæµç¨‹</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221114010503.png" alt="20221114010503"  />
</p>
<p>å¾…è¡¥å……</p>
<h3 id="344-è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥">3.4.4 è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#344-è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥">#</a></h3>
<p>â€‚è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ï¼Œæ˜¯æŒ‡æ‰€æœ‰è¿›ç¨‹æäº¤çš„è™šæ‹Ÿå†…å­˜çš„æ€»å’Œè¶…è¿‡ç‰©ç†å†…å­˜çš„å®¹é‡ï¼Œå†…å­˜ç®¡ç†å­ç³»ç»Ÿæ”¯æŒ3ç§è™šæ‹Ÿå†…å­˜è¿‡é‡    <br>
â€‚ï¼ˆ1ï¼‰OVERCOMMIT_GUESS(0)ï¼šçŒœæµ‹ï¼Œä¼°ç®—å¯ç”¨å†…å­˜çš„æ•°é‡ï¼Œå› ä¸ºæ²¡æ³•å‡†ç¡®è®¡ç®—å¯ç”¨å†…å­˜çš„æ•°é‡ï¼Œæ‰€ä»¥è¯´æ˜¯çŒœæµ‹ã€‚   <br>
â€‚ï¼ˆ2ï¼‰OVERCOMMIT_ALWAYS(1)ï¼šæ€»æ˜¯å…è®¸è¿‡é‡æäº¤ã€‚   <br>
â€‚ï¼ˆ3ï¼‰OVERCOMMIT_NEVER(2)ï¼šä¸å…è®¸è¿‡é‡æäº¤ã€‚     <br>
â€ƒ<code>/proc/sys/vm/overcommit_memory</code>ä¿®æ”¹ç­–ç•¥
â€‚åœ¨åˆ›å»ºæ–°çš„å†…å­˜æ˜ å°„æ—¶ï¼Œè°ƒç”¨å‡½æ•°__vm_enough_memoryæ ¹æ®è™šæ‹Ÿå†…å­˜è¿‡é‡æäº¤ç­–ç•¥åˆ¤æ–­å†…å­˜æ˜¯å¦è¶³å¤Ÿ</p>
<h3 id="345-åˆ é™¤å†…å­˜æ˜ å°„">3.4.5 åˆ é™¤å†…å­˜æ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#345-åˆ é™¤å†…å­˜æ˜ å°„">#</a></h3>
<p>â€‚ç³»ç»Ÿè°ƒç”¨munmapç”¨æ¥åˆ é™¤å†…å­˜æ˜ å°„ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼šèµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œ<code>mm/mmap.c</code>ä¸­çš„å‡½æ•°do_munmap</p>
<center>ç³»ç»Ÿè°ƒç”¨munmapæ‰§è¡Œæµç¨‹</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221114231356.png" alt="20221114231356"  />
</p>
<h2 id="35-ç‰©ç†å†…å­˜ç»„ç»‡">3.5 ç‰©ç†å†…å­˜ç»„ç»‡<a hidden class="anchor" aria-hidden="true" href="#35-ç‰©ç†å†…å­˜ç»„ç»‡">#</a></h2>
<h3 id="351-ä½“ç³»ç»“æ„">3.5.1 ä½“ç³»ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#351-ä½“ç³»ç»“æ„">#</a></h3>
<p>â€‚å¤šå¤„ç†å™¨ç³»ç»Ÿä¸¤ç§ä½“ç³»ç»“æ„ï¼š
â€‚(1)éä¸€è‡´å†…å­˜è®¿é—®(Non-Uniform Memory Access NUMA)ï¼šå†…å­˜ä¸ºå¤šä¸ªå†…å­˜èŠ‚ç‚¹å¤šå¤„ç†å™¨ç³»ç»Ÿ  <br>
â€‚(2)å¯¹ç§°å¤šå¤„ç†å™¨(Symmetric Multi-Process SMP)ï¼šä¸€ç›´å†…å­˜è®¿é—®(UMA)</p>
<h3 id="352-å†…å­˜æ¨¡å‹">3.5.2 å†…å­˜æ¨¡å‹<a hidden class="anchor" aria-hidden="true" href="#352-å†…å­˜æ¨¡å‹">#</a></h3>
<p>â€‚å†…å­˜ç®¡ç†å­ç³»ç»Ÿæ”¯æŒ3ç§å†…å­˜æ¨¡å‹
â€‚(1)å¹³å¦å†…å­˜(Flat Memory)ï¼šå†…å­˜ç‰©ç†åœ°å€ç©ºé—´æ˜¯è¿ç»­çš„   <br>
â€‚(2)ä¸è¿ç»­å†…å­˜(Discontiguous Memory)ï¼šå†…å­˜ç‰©ç†åœ°å€ç©ºé—´å­˜åœ¨ç©ºæ´
â€‚(3)ç³»æ•°å†…å­˜(Sparse Memory)ï¼šå†…å­˜ç‰©ç†åœ°å€ç©ºé—´å­˜åœ¨ç©ºæ´</p>
<h3 id="353-ä¸‰çº§ç»“æ„">3.5.3 ä¸‰çº§ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#353-ä¸‰çº§ç»“æ„">#</a></h3>
<p>â€‚å†…å­˜ç®¡ç†å­ç³»ç»Ÿä½¿ç”¨èŠ‚ç‚¹(node)ã€åŒºåŸŸ(zone)å’Œé¡µ(page)ä¸‰çº§ç»“æ„æè¿°ç‰©ç†å†…å­˜ã€‚   \</p>
<h4 id="1å†…å­˜èŠ‚ç‚¹">1.å†…å­˜èŠ‚ç‚¹<a hidden class="anchor" aria-hidden="true" href="#1å†…å­˜èŠ‚ç‚¹">#</a></h4>
<p>â€‚å†…å­˜èŠ‚ç‚¹ä¸¤ç§æƒ…å†µï¼š
â€‚ï¼ˆ1ï¼‰NUMAç³»ç»Ÿå†…å­˜èŠ‚ç‚¹  <br>
â€‚ï¼ˆ2ï¼‰å…·æœ‰ä¸è¿ç»­å†…å­˜çš„UMAç³»ç»Ÿ  <br>
â€‚å†…å­˜èŠ‚ç‚¹ä½¿ç”¨<code>pglist_data</code>ç»“æ„ä½“æè¿°å†…å­˜å¸ƒå±€ï¼Œå†…æ ¸å®šä¹‰å®NODE_DATA(nid)ï¼Œè·å–èŠ‚ç‚¹çš„pglist_dataå®ä¾‹ã€‚å¹³å¦å†…å­˜æ¨¡å‹ï¼Œåªæœ‰ä¸€ä¸ªpglist_dataå®ä¾‹contig_page_data</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221114233416.png" alt="20221114233416"  />
</p>
<center>å†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹</center>
<p>â€‚pglist_dataç»“æ„ä¸»è¦æˆå‘˜ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mmzone.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> pglist_data {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> zone node_zones[MAX_NR_ZONES];          <span style="color:#75715e">/* å†…å­˜åŒºåŸŸæ•°ç»„ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> zonelist node_zonelists[MAX_ZONELISTS]; <span style="color:#75715e">/* å¤‡ç”¨åŒºåŸŸåˆ—è¡¨ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> nr_zones;                                  <span style="color:#75715e">/* è¯¥èŠ‚ç‚¹åŒ…å«çš„å†…å­˜åŒºåŸŸæ•°é‡ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_FLAT_NODE_MEM_MAP                    </span><span style="color:#75715e">/* é™¤äº†ç¨€ç–å†…å­˜æ¨¡å‹ä»¥å¤– */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>node_mem_map;                     <span style="color:#75715e">/* é¡µæè¿°ç¬¦æ•°ç»„ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_PAGE_EXTENSION
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> page_ext <span style="color:#f92672">*</span>node_page_ext;                <span style="color:#75715e">/* é¡µçš„æ‰©å±•å±æ€§ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> node_start_pfn;                  <span style="color:#75715e">/* è¯¥èŠ‚ç‚¹çš„èµ·å§‹ç‰©ç†é¡µå· */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> node_present_pages;              <span style="color:#75715e">/* ç‰©ç†é¡µæ€»æ•° */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> node_spanned_pages;              <span style="color:#75715e">/* ç‰©ç†é¡µèŒƒå›´çš„æ€»é•¿åº¦ï¼ŒåŒ…æ‹¬ç©ºæ´ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> node_id;                                   <span style="color:#75715e">/* èŠ‚ç‚¹æ ‡è¯†ç¬¦ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">pg_data_t</span>;
</span></span></code></pre></div><h4 id="2å†…å­˜åŒºåŸŸ">2.å†…å­˜åŒºåŸŸ<a hidden class="anchor" aria-hidden="true" href="#2å†…å­˜åŒºåŸŸ">#</a></h4>
<p>â€‚å†…æ ¸å®šä¹‰å†…å­˜èŠ‚ç‚¹åŒºåŸŸ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mmzone.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">enum</span> zone_type {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ZONE_DMA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ZONE_DMA,  <span style="color:#75715e">// ç›´æ¥å†…å­˜è®¿é—®åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_ZONE_DMA32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ZONE_DMA32,
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å†…æ ¸è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€æ˜¯çº¿æ€§æ˜ å°„çš„å…³ç³»ï¼Œå³è™šæ‹Ÿåœ°å€ =ï¼ˆç‰©ç†åœ°å€ + å¸¸é‡ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ZONE_NORMAL,  <span style="color:#75715e">// ç›´æ¥æ˜ å°„åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_HIGHMEM
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ZONE_HIGHMEM,  <span style="color:#75715e">// é«˜ç«¯å†…å­˜åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ZONE_MOVABLE,  <span style="color:#75715e">// å¯ç§»åŠ¨åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_ZONE_DEVICE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     ZONE_DEVICE,  <span style="color:#75715e">// è®¾å¤‡åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     __MAX_NR_ZONES
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚æ¯ä¸ªå†…å­˜åŒºåŸŸç”¨ä¸€ä¸ªzoneç»“æ„ä½“æè¿°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mmzone.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> zone {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> watermark[NR_WMARK];        <span style="color:#75715e">/* é¡µåˆ†é…å™¨ä½¿ç”¨çš„æ°´çº¿ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">long</span> lowmem_reserve[MAX_NR_ZONES];         <span style="color:#75715e">/* é¡µåˆ†é…å™¨ä½¿ç”¨ï¼Œå½“å‰åŒºåŸŸä¿ç•™å¤šå°‘é¡µä¸èƒ½å€Ÿç»™  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">											é«˜çš„åŒºåŸŸç±»å‹ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> pglist_data  <span style="color:#f92672">*</span>zone_pgdat;          <span style="color:#75715e">/* æŒ‡å‘å†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> per_cpu_pageset __percpu <span style="color:#f92672">*</span>pageset;  <span style="color:#75715e">/* æ¯å¤„ç†å™¨é¡µé›†åˆ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>     zone_start_pfn;         <span style="color:#75715e">/* å½“å‰åŒºåŸŸçš„èµ·å§‹ç‰©ç†é¡µå· */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>     managed_pages;          <span style="color:#75715e">/* ä¼™ä¼´åˆ†é…å™¨ç®¡ç†çš„ç‰©ç†é¡µçš„æ•°é‡ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>     spanned_pages;          <span style="color:#75715e">/* å½“å‰åŒºåŸŸè·¨è¶Šçš„æ€»é¡µæ•°ï¼ŒåŒ…æ‹¬ç©ºæ´ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>     present_pages;          <span style="color:#75715e">/* å½“å‰åŒºåŸŸå­˜åœ¨çš„ç‰©ç†é¡µçš„æ•°é‡ï¼Œä¸åŒ…æ‹¬ç©ºæ´ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span>        <span style="color:#f92672">*</span>name;                  <span style="color:#75715e">/* åŒºåŸŸåç§° */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>   
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> free_area  free_area[MAX_ORDER];    <span style="color:#75715e">/* ä¸åŒé•¿åº¦çš„ç©ºé—²åŒºåŸŸ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3ç‰©ç†é¡µ">3.ç‰©ç†é¡µ<a hidden class="anchor" aria-hidden="true" href="#3ç‰©ç†é¡µ">#</a></h4>
<p>â€‚æ¯ä¸ªç‰©ç†é¡µå¯¹åº”ä¸€ä¸ªpageç»“æ„ä½“ï¼Œç§°ä¸ºé¡µæè¿°ç¬¦ï¼Œå†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹çš„æˆå‘˜node_mem_mapæŒ‡å‘è¯¥å†…å­˜èŠ‚ç‚¹åŒ…å«çš„æ‰€æœ‰ç‰©ç†é¡µçš„é¡µæè¿°ç¬¦æ³¨å†Œçš„æ•°ç»„ã€‚   <br>
â€‚ç»“æ„ä½“pageæˆå‘˜flagså¸ƒå±€  <br>
| [SECTION] | [NODE] | ZONE | [LAST_CPUPID] | &hellip; | FLAGS |  <br>
â€‚SECTIONæ˜¯ç¨€ç–å†…å­˜æ¨¡å‹ä¸­çš„æ®µç¼–å·ï¼ŒNODEæ˜¯èŠ‚ç‚¹ç¼–å·ï¼ŒZONEæ˜¯åŒºåŸŸç±»å‹ï¼ŒFLAGSæ˜¯æ ‡å¿—ä½    <br>
â€‚å¤´æ–‡ä»¶<code>include/linux/mm_types.h</code>å®šä¹‰äº†pageç»“æ„ä½“</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mm.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å¾—åˆ°ç‰©ç†é¡µæ‰€å±çš„å†…å­˜èŠ‚ç‚¹çš„ç¼–å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">page_to_nid</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>page)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> (page<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&gt;&gt;</span> NODES_PGSHIFT) <span style="color:#f92672">&amp;</span> NODES_MASK;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¾—åˆ°ç‰©ç†é¡µæ‰€å±çš„å†…å­˜åŒºåŸŸçš„ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">enum</span> zone_type <span style="color:#a6e22e">page_zonenum</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>page)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> (page<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&gt;&gt;</span> ZONES_PGSHIFT) <span style="color:#f92672">&amp;</span> ZONES_MASK;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="36-å¼•å¯¼å†…å­˜åˆ†é…å™¨">3.6 å¼•å¯¼å†…å­˜åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#36-å¼•å¯¼å†…å­˜åˆ†é…å™¨">#</a></h2>
<p>â€‚åœ¨å†…æ ¸åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­éœ€è¦åˆ†é…å†…å­˜ï¼Œå†…æ ¸æä¾›äº†ä¸´æ—¶çš„å¼•å¯¼å†…å­˜åˆ†é…å™¨ï¼Œåœ¨é¡µåˆ†é…å™¨å’Œå—åˆ†é…å™¨åˆå§‹åŒ–å®Œæ¯•åï¼ŒæŠŠç©ºé—²çš„ç‰©ç†é¡µäº¤ç»™é¡µåˆ†é…å™¨ç®¡ç†ï¼Œä¸¢å¼ƒå¼•å¯¼å†…å­˜åˆ†é…å™¨ï¼Œå¼€å¯é…ç½®å®CONFIG_NO_BOOTMEMï¼Œ<code>memblock</code>å°±ä¼šå–ä»£bootmemã€‚
â€‚</p>
<h3 id="361-bootmemåˆ†é…å™¨">3.6.1 bootmemåˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#361-bootmemåˆ†é…å™¨">#</a></h3>
<h3 id="362-memblockåˆ†é…å™¨">3.6.2 memblockåˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#362-memblockåˆ†é…å™¨">#</a></h3>
<h4 id="1æ•°æ®ç»“æ„">1.æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#1æ•°æ®ç»“æ„">#</a></h4>
<p>â€‚memblockåˆ†é…å™¨æ•°æ®ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/memblock.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> memblock {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> bottom_up;  <span style="color:#75715e">/* è¡¨ç¤ºåˆ†é…å†…å­˜çš„æ–¹å¼ æ˜¯ä»ä¸‹å‘ä¸Šçš„æ–¹å‘ï¼Ÿ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">phys_addr_t</span> current_limit;  <span style="color:#75715e">// å¯åˆ†é…å†…å­˜çš„æœ€å¤§ç‰©ç†åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> memblock_type memory;  <span style="color:#75715e">// å­˜ç±»å‹ï¼ˆåŒ…æ‹¬å·²åˆ†é…çš„å†…å­˜å’Œæœªåˆ†é…çš„å†…å­˜ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> memblock_type reserved;  <span style="color:#75715e">// é¢„ç•™ç±»å‹ï¼ˆå·²åˆ†é…çš„å†…å­˜ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_HAVE_MEMBLOCK_PHYS_MAP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> memblock_type physmem;  <span style="color:#75715e">// ç‰©ç†å†…å­˜ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>â€‚å†…å­˜å—ç±»å‹çš„æ•°æ®ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/memblock.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> memblock_type {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> cnt;        <span style="color:#75715e">/* å†…å­˜å—åŒºåŸŸæ•°é‡ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> max;        <span style="color:#75715e">/* å·²åˆ†é…æ•°ç»„çš„å¤§å° */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">phys_addr_t</span> total_size;    <span style="color:#75715e">/* å†…å­˜å—åŒºåŸŸçš„æ€»é•¿åº¦ æ‰€æœ‰åŒºåŸŸçš„é•¿åº¦ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> memblock_region <span style="color:#f92672">*</span>regions;  <span style="color:#75715e">// æŒ‡å‘å†…å­˜å—åŒºåŸŸæ•°ç»„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name;  <span style="color:#75715e">// å­˜å—ç±»å‹çš„åç§°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>â€‚å†…å­˜å—åŒºåŸŸçš„æ•°æ®ç»“æ„</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/memblock.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> memblock_region {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">phys_addr_t</span> base;  <span style="color:#75715e">// èµ·å§‹ç‰©ç†åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">phys_addr_t</span> size;  <span style="color:#75715e">// é•¿åº¦
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags;  <span style="color:#75715e">// æ ‡å¿— MEMBLOCK_NONEæˆ–å…¶ä»–æ ‡å¿—
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_HAVE_MEMBLOCK_NODE_MAP
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">int</span> nid;  <span style="color:#75715e">// èŠ‚ç‚¹ç¼–å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif   
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* memblockæ ‡å¿—ä½çš„å®šä¹‰. */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>	MEMBLOCK_NONE      <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x0</span>,   <span style="color:#75715e">/* æ— ç‰¹æ®Šè¦æ±‚ */</span>
</span></span><span style="display:flex;"><span>	MEMBLOCK_HOTPLUG   <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x1</span>,   <span style="color:#75715e">/* å¯çƒ­æ’æ‹”åŒºåŸŸ */</span>
</span></span><span style="display:flex;"><span>	MEMBLOCK_MIRROR    <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2</span>,   <span style="color:#75715e">/* é•œåƒåŒºåŸŸ */</span>
</span></span><span style="display:flex;"><span>	MEMBLOCK_NOMAP     <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x4</span>,   <span style="color:#75715e">/* ä¸æ·»åŠ åˆ°å†…æ ¸ç›´æ¥æ˜ å°„ */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h4 id="2åˆå§‹åŒ–">2.åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#2åˆå§‹åŒ–">#</a></h4>
<p>â€‚æºæ–‡ä»¶â€œmm/memblock.câ€å®šä¹‰äº†å…¨å±€å˜é‡memblockï¼ŒæŠŠæˆå‘˜bottom_upåˆå§‹åŒ–ä¸ºå‡ï¼Œè¡¨ç¤ºä»é«˜åœ°å€å‘ä¸‹åˆ†é…ã€‚   <br>
â€‚ARM64å†…æ ¸åˆå§‹åŒ–memblockåˆ†é…å™¨çš„è¿‡ç¨‹æ˜¯ï¼š    <br>
â€‚ï¼ˆ1ï¼‰è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹â€œ/memoryâ€ï¼ŒæŠŠæ‰€æœ‰ç‰©ç†å†…å­˜èŒƒå›´æ·»åŠ åˆ°memblock. memoryï¼Œå…·ä½“è¿‡ç¨‹å‚è€ƒ3.6.3èŠ‚ã€‚    <br>
â€‚ï¼ˆ2ï¼‰åœ¨å‡½æ•°arm64_memblock_initä¸­åˆå§‹åŒ–memblockã€‚    <br>
â€‚arm64_memblock_initä¸»è¦æµç¨‹ï¼š</p>
<blockquote>
<p>start_kernel() &ndash;&gt; setup_arch() &ndash;&gt; arm64_memblock_init()</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/init.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __init <span style="color:#a6e22e">arm64_memblock_init</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> s64 linear_region_size <span style="color:#f92672">=</span> <span style="color:#f92672">-</span>(s64)PAGE_OFFSET;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä¸­èŠ‚ç‚¹â€œ/chosenâ€çš„å±æ€§â€œlinux,usable-memory-rangeâ€ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¾—åˆ°å¯ç”¨å†…å­˜çš„èŒƒå›´ï¼ŒæŠŠè¶…å‡ºè¿™ä¸ªèŒƒå›´çš„ç‰©ç†å†…å­˜èŒƒå›´ä»memblock.memoryä¸­åˆ é™¤ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fdt_enforce_memory_region</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å±€å˜é‡memstart_addrè®°å½•å†…å­˜çš„èµ·å§‹ç‰©ç†åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	memstart_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">round_down</span>(<span style="color:#a6e22e">memblock_start_of_DRAM</span>(),
</span></span><span style="display:flex;"><span>					ARM64_MEMSTART_ALIGN);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠçº¿æ€§æ˜ å°„åŒºåŸŸä¸èƒ½è¦†ç›–çš„ç‰©ç†å†…å­˜èŒƒå›´ä»memblock.memoryä¸­åˆ é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memblock_remove</span>(<span style="color:#66d9ef">max_t</span>(u64, memstart_addr <span style="color:#f92672">+</span> linear_region_size,
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">__pa_symbol</span>(_end)), ULLONG_MAX);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (memstart_addr <span style="color:#f92672">+</span> linear_region_size <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">memblock_end_of_DRAM</span>()) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* ç¡®ä¿memstart_addrä¸¥æ ¼å¯¹é½ */</span>
</span></span><span style="display:flex;"><span>		memstart_addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">round_up</span>(<span style="color:#a6e22e">memblock_end_of_DRAM</span>() <span style="color:#f92672">-</span> linear_region_size,
</span></span><span style="display:flex;"><span>						ARM64_MEMSTART_ALIGN);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memblock_remove</span>(<span style="color:#ae81ff">0</span>, memstart_addr);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (memory_limit <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">phys_addr_t</span>)ULLONG_MAX) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memblock_mem_limit_remove_map</span>(memory_limit);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">memblock_add</span>(<span style="color:#a6e22e">__pa_symbol</span>(_text), (u64)(_end <span style="color:#f92672">-</span> _text));
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠå†…æ ¸é•œåƒå ç”¨çš„ç‰©ç†å†…å­˜èŒƒå›´æ·»åŠ åˆ°memblock.reserved
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">memblock_reserve</span>(<span style="color:#a6e22e">__pa_symbol</span>(_text), _end <span style="color:#f92672">-</span> _text);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä»è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å†…å­˜ä¿ç•™åŒºåŸŸå’ŒèŠ‚ç‚¹â€œ/reserved-memoryâ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è¯»å–ä¿ç•™çš„ç‰©ç†å†…å­˜èŒƒå›´ï¼Œæ·»åŠ åˆ°memblock.reservedä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">early_init_fdt_scan_reserved_mem</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3ç¼–ç¨‹æ¥å£">3.ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#3ç¼–ç¨‹æ¥å£">#</a></h4>
<p>â€‚memblockåˆ†é…å™¨æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ·»åŠ æ–°çš„å†…å­˜å—åŒºåŸŸåˆ°memblock.memoryä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>memblock_add
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åˆ é™¤å†…å­˜å—åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>memblock_remove
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>memblock_alloc
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>memblock_free
</span></span></code></pre></div><h4 id="4ç®—æ³•">4.ç®—æ³•<a hidden class="anchor" aria-hidden="true" href="#4ç®—æ³•">#</a></h4>
<p>â€‚memblockåˆ†é…å™¨æŠŠæ‰€æœ‰å†…å­˜æ·»åŠ åˆ°memblock.memoryä¸­ï¼ŒæŠŠåˆ†é…å‡ºå»çš„å†…å­˜å—æ·»åŠ åˆ°memblock.reservedä¸­   <br>
â€‚å‡½æ•°memblock_allocè´Ÿè´£åˆ†é…å†…å­˜ï¼Œä¸»è¦ä¸ºå‡½æ•°memblock_alloc_range_nid  <br>
â€‚(1)memblock_find_in_range_nodeå‡½æ•°memblock_find_in_range_node   <br>
â€‚(2)memblock_reserveå‡½æ•°æŠŠåˆ†é…å‡ºå»çš„å†…å­˜å—åŒºåŸŸæ·»åŠ åˆ°memblock.reservedä¸­  \</p>
<h3 id="363-ç‰©ç†å†…å­˜ä¿¡æ¯">3.6.3 ç‰©ç†å†…å­˜ä¿¡æ¯<a hidden class="anchor" aria-hidden="true" href="#363-ç‰©ç†å†…å­˜ä¿¡æ¯">#</a></h3>
<p>â€‚å†…æ ¸åˆå§‹åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œå¼•å¯¼å†…å­˜åˆ†é…å™¨è´Ÿè´£åˆ†é…å†…å­˜ã€‚ARM64æ¶æ„ä½¿ç”¨æ‰å¹³è®¾å¤‡æ ‘ï¼ˆFlattened Device Treeï¼ŒFDTï¼‰æè¿°æ¿å¡çš„ç¡¬ä»¶ä¿¡æ¯ã€‚é©±åŠ¨å¼€å‘è€…ç¼–å†™è®¾å¤‡æ ‘æºæ–‡ä»¶ï¼ˆDevice Tree Sourceï¼ŒDTSï¼‰ï¼Œå­˜æ”¾åœ¨ç›®å½•â€œarch/arm64/boot/dtsâ€ä¸‹ï¼Œç„¶åä½¿ç”¨è®¾å¤‡æ ‘ç¼–è¯‘å™¨ï¼ˆDevice Tree Compilerï¼ŒDTCï¼‰æŠŠè®¾å¤‡æ ‘æºæ–‡ä»¶è½¬æ¢æˆè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆDevice Tree Blobï¼ŒDTBï¼‰ï¼Œæ¥ç€æŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶å†™åˆ°å­˜å‚¨è®¾å¤‡ä¸Šã€‚è®¾å¤‡å¯åŠ¨æ—¶ï¼Œå¼•å¯¼ç¨‹åºæŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ä»å­˜å‚¨è®¾å¤‡è¯»åˆ°å†…å­˜ä¸­ï¼Œå¼•å¯¼å†…æ ¸çš„æ—¶å€™æŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶çš„èµ·å§‹åœ°å€ä¼ ç»™å†…æ ¸ï¼Œå†…æ ¸è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶åå¾—åˆ°ç¡¬ä»¶ä¿¡æ¯   \</p>
<p>â€‚ è®¾å¤‡æ ‘æºæ–‡ä»¶<code>.dts</code>,æè¿°ç‰©ç†å†…å­˜å¸ƒå±€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#f92672">/</span> {  <span style="color:#75715e">// â€œ/â€æ ¹èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#address-cells = &lt;2&gt;;   </span><span style="color:#75715e">// åœ°å€çš„å•å…ƒæ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">#size-cells = &lt;2&gt;;  </span><span style="color:#75715e">// ä¸€ä¸ªé•¿åº¦çš„å•å…ƒæ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    memory<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#ae81ff">80000000</span> {  <span style="color:#75715e">// æè¿°ç‰©ç†å†…å­˜å¸ƒå±€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       device_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;memory&#34;</span>;  <span style="color:#75715e">// è®¾å¤‡ç±»å‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	   <span style="color:#75715e">// ç‰©ç†å†…å­˜èŒƒå›´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>       reg <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x00000000</span> <span style="color:#ae81ff">0x80000000</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0x80000000</span><span style="color:#f92672">&gt;</span>,
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x00000008</span> <span style="color:#ae81ff">0x80000000</span> <span style="color:#ae81ff">0</span> <span style="color:#ae81ff">0x80000000</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚å†…æ ¸åœ¨åˆå§‹åŒ–çš„æ—¶å€™è°ƒç”¨å‡½æ•°early_init_dt_scan_nodesä»¥è§£æè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»è€Œå¾—åˆ°ç‰©ç†å†…å­˜ä¿¡æ¯   \</p>
<blockquote>
<p>start_kernel() &ndash;&gt; setup_arch() &ndash;&gt; setup_machine_fdt() &ndash;&gt; early_init_dt_scan_nodes()</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// drivers/of/fdt.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __init <span style="color:#a6e22e">early_init_dt_scan_nodes</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* åˆå§‹åŒ–size-cellså’Œaddress-cellsä¿¡æ¯ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// early_init_dt_scan_rootï¼Œè§£ææ ¹èŠ‚ç‚¹çš„å±æ€§â€œ#address-cellsâ€å¾—åˆ°åœ°å€çš„å•å…ƒæ•°é‡ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ä¿å­˜åœ¨å…¨å±€å˜é‡dt_root_addr_cellsä¸­ï¼›è§£ææ ¹èŠ‚ç‚¹çš„å±æ€§â€œ#size-cellsâ€å¾—åˆ°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// é•¿åº¦çš„å•å…ƒæ•°é‡ï¼Œä¿å­˜åœ¨å…¨å±€å˜é‡dt_root_size_cellsä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">of_scan_flat_dt</span>(early_init_dt_scan_root, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* è°ƒç”¨å‡½æ•°early_init_dt_add_memory_archè®¾ç½®å†…å­˜ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">of_scan_flat_dt</span>(early_init_dt_scan_memory, NULL);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚early_init_dt_scan_memoryè§£æmemoryèŠ‚ç‚¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// drivers/of/fdt.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> __init <span style="color:#a6e22e">early_init_dt_scan_memory</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> node, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>uname,
</span></span><span style="display:flex;"><span>                      <span style="color:#66d9ef">int</span> depth, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è§£æèŠ‚ç‚¹çš„å±æ€§â€œdevice_typeâ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>type <span style="color:#f92672">=</span> <span style="color:#a6e22e">of_get_flat_dt_prop</span>(node, <span style="color:#e6db74">&#34;device_type&#34;</span>, NULL);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> __be32 <span style="color:#f92672">*</span>reg, <span style="color:#f92672">*</span>endp;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> l;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* åªæ‰«æ &#34;memory&#34; èŠ‚ç‚¹ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (type <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* å¦‚æœæ²¡æœ‰å±æ€§â€œdevice_typeâ€ï¼Œåˆ¤æ–­èŠ‚ç‚¹åç§°æ˜¯ä¸æ˜¯â€œmemory@0â€*/</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">IS_ENABLED</span>(CONFIG_PPC32) <span style="color:#f92672">||</span> depth <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">strcmp</span>(uname, <span style="color:#e6db74">&#34;memory@0&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">strcmp</span>(type, <span style="color:#e6db74">&#34;memory&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) <span style="color:#75715e">// æè¿°ç‰©ç†å†…å­˜ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	reg <span style="color:#f92672">=</span> <span style="color:#a6e22e">of_get_flat_dt_prop</span>(node, <span style="color:#e6db74">&#34;linux,usable-memory&#34;</span>, <span style="color:#f92672">&amp;</span>l);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (reg <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>		reg <span style="color:#f92672">=</span> <span style="color:#a6e22e">of_get_flat_dt_prop</span>(node, <span style="color:#e6db74">&#34;reg&#34;</span>, <span style="color:#f92672">&amp;</span>l);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (reg <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	endp <span style="color:#f92672">=</span> reg <span style="color:#f92672">+</span> (l <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(__be32));
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> ((endp <span style="color:#f92672">-</span> reg) <span style="color:#f92672">&gt;=</span> (dt_root_addr_cells <span style="color:#f92672">+</span> dt_root_size_cells)) {
</span></span><span style="display:flex;"><span>		u64 base, size;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		base <span style="color:#f92672">=</span> <span style="color:#a6e22e">dt_mem_next_cell</span>(dt_root_addr_cells, <span style="color:#f92672">&amp;</span>reg);
</span></span><span style="display:flex;"><span>		size <span style="color:#f92672">=</span> <span style="color:#a6e22e">dt_mem_next_cell</span>(dt_root_size_cells, <span style="color:#f92672">&amp;</span>reg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">early_init_dt_add_memory_arch</span>(base, size);
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚è§£æå‡ºæ¯å—å†…å­˜çš„èµ·å§‹åœ°å€å’Œå¤§å°åï¼Œè°ƒç”¨å‡½æ•°early_init_dt_add_memory_arch</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// drivers/of/fdt.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __init __weak <span style="color:#a6e22e">early_init_dt_add_memory_arch</span>(u64 base, u64 size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> u64 phys_offset <span style="color:#f92672">=</span> MIN_MEMBLOCK_ADDR;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">PAGE_ALIGNED</span>(base)) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">&lt;</span> PAGE_SIZE <span style="color:#f92672">-</span> (base <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>PAGE_MASK)) {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">pr_warn</span>(<span style="color:#e6db74">&#34;Ignoring memory block 0x%llx - 0x%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                  base, base <span style="color:#f92672">+</span> size);
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>         size <span style="color:#f92672">-=</span> PAGE_SIZE <span style="color:#f92672">-</span> (base <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>PAGE_MASK);
</span></span><span style="display:flex;"><span>         base <span style="color:#f92672">=</span> <span style="color:#a6e22e">PAGE_ALIGN</span>(base);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">&amp;=</span> PAGE_MASK;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (base <span style="color:#f92672">&gt;</span> MAX_MEMBLOCK_ADDR) {
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">pr_warning</span>(<span style="color:#e6db74">&#34;Ignoring memory block 0x%llx - 0x%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                  base, base <span style="color:#f92672">+</span> size);
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (base <span style="color:#f92672">+</span> size <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&gt;</span> MAX_MEMBLOCK_ADDR) {
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">pr_warning</span>(<span style="color:#e6db74">&#34;Ignoring memory range 0x%llx - 0x%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                  ((u64)MAX_MEMBLOCK_ADDR) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, base <span style="color:#f92672">+</span> size);
</span></span><span style="display:flex;"><span>         size <span style="color:#f92672">=</span> MAX_MEMBLOCK_ADDR <span style="color:#f92672">-</span> base <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (base <span style="color:#f92672">+</span> size <span style="color:#f92672">&lt;</span> phys_offset) {
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">pr_warning</span>(<span style="color:#e6db74">&#34;Ignoring memory block 0x%llx - 0x%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                base, base <span style="color:#f92672">+</span> size);
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (base <span style="color:#f92672">&lt;</span> phys_offset) {
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">pr_warning</span>(<span style="color:#e6db74">&#34;Ignoring memory range 0x%llx - 0x%llx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>                base, phys_offset);
</span></span><span style="display:flex;"><span>         size <span style="color:#f92672">-=</span> phys_offset <span style="color:#f92672">-</span> base;
</span></span><span style="display:flex;"><span>         base <span style="color:#f92672">=</span> phys_offset;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠç‰©ç†å†…å­˜èŒƒå›´æ·»åŠ åˆ°memblock.memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memblock_add</span>(base, size);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="37-ä¼™ä¼´åˆ†é…å™¨">3.7 ä¼™ä¼´åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#37-ä¼™ä¼´åˆ†é…å™¨">#</a></h2>
<p>â€‚å†…æ ¸åˆå§‹åŒ–å®Œæ¯•åï¼Œä½¿ç”¨é¡µåˆ†é…å™¨ç®¡ç†ç‰©ç†é¡µï¼Œå½“å‰ä½¿ç”¨çš„é¡µåˆ†é…å™¨æ˜¯ä¼™ä¼´åˆ†é…å™¨buddy allocato</p>
<h3 id="371-åŸºæœ¬çš„ä¼™ä¼´åˆ†é…å™¨">3.7.1 åŸºæœ¬çš„ä¼™ä¼´åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#371-åŸºæœ¬çš„ä¼™ä¼´åˆ†é…å™¨">#</a></h3>
<p>â€‚è¿ç»­çš„ç‰©ç†é¡µç§°ä¸ºé¡µå—ï¼ˆpage blockï¼‰ã€‚é˜¶ï¼ˆorderï¼‰æ˜¯ä¼™ä¼´åˆ†é…å™¨çš„ä¸€ä¸ªæœ¯è¯­ï¼Œæ˜¯é¡µçš„æ•°é‡å•ä½ï¼Œ2nä¸ªè¿ç»­é¡µç§°ä¸ºné˜¶é¡µå—ã€‚æ»¡è¶³ä»¥ä¸‹æ¡ä»¶çš„ä¸¤ä¸ªné˜¶é¡µå—ç§°ä¸ºä¼™ä¼´ï¼ˆbuddyï¼‰   <br>
â€‚ä¼™ä¼´åˆ†é…å™¨åˆ†é…å’Œé‡Šæ”¾ç‰©ç†é¡µçš„æ•°é‡å•ä½æ˜¯é˜¶</p>
<h3 id="372-åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨">3.7.2 åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#372-åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨">#</a></h3>
<h4 id="1æ•°æ®ç»“æ„-1">1.æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#1æ•°æ®ç»“æ„-1">#</a></h4>
<p>â€‚åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨ä¸“æ³¨äºæŸä¸ªå†…å­˜èŠ‚ç‚¹çš„æŸä¸ªåŒºåŸŸã€‚å†…å­˜åŒºåŸŸçš„ç»“æ„ä½“æˆå‘˜free_areaç”¨æ¥ç»´æŠ¤ç©ºé—²é¡µå—ï¼Œæ•°ç»„ä¸‹æ ‡å¯¹åº”é¡µå—çš„é˜¶æ•°ã€‚ç»“æ„ä½“free_areaçš„æˆå‘˜free_listæ˜¯ç©ºé—²é¡µå—çš„é“¾è¡¨nr_freeæ˜¯ç©ºé—²é¡µå—çš„æ•°é‡ã€‚å†…å­˜åŒºåŸŸçš„ç»“æ„ä½“æˆå‘˜managed_pagesæ˜¯ä¼™ä¼´åˆ†é…å™¨ç®¡ç†çš„ç‰©ç†é¡µçš„æ•°é‡ï¼Œä¸åŒ…æ‹¬å¼•å¯¼å†…å­˜åˆ†é…å™¨åˆ†é…çš„ç‰©ç†é¡µ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>include<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>mmzone.h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> zone {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ä¸åŒé•¿åº¦çš„ç©ºé—²åŒºåŸŸ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> free_area   free_area[MAX_ORDER];  <span style="color:#75715e">// MAX_ORDERæ˜¯æœ€å¤§é˜¶æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>      managed_pages;
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} ____cacheline_internodealigned_in_smp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> free_area {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> list_head  free_list[MIGRATE_TYPES];
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>     nr_free;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mmzone.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/* ç©ºé—²å†…å­˜ç®¡ç†-åˆ†åŒºçš„ä¼™ä¼´åˆ†é…å™¨ */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifndef CONFIG_FORCE_MAX_ZONEORDER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_ORDER   11
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_ORDER   CONFIG_FORCE_MAX_ZONEORDER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><h4 id="2æ ¹æ®åˆ†é…æ ‡å¿—å¾—åˆ°é¦–é€‰åŒºåŸŸç±»å‹">2ï¼æ ¹æ®åˆ†é…æ ‡å¿—å¾—åˆ°é¦–é€‰åŒºåŸŸç±»å‹<a hidden class="anchor" aria-hidden="true" href="#2æ ¹æ®åˆ†é…æ ‡å¿—å¾—åˆ°é¦–é€‰åŒºåŸŸç±»å‹">#</a></h4>
<h4 id="3-å¤‡ç”¨åŒºåŸŸåˆ—è¡¨">3. å¤‡ç”¨åŒºåŸŸåˆ—è¡¨<a hidden class="anchor" aria-hidden="true" href="#3-å¤‡ç”¨åŒºåŸŸåˆ—è¡¨">#</a></h4>
<h4 id="4åŒºåŸŸæ°´çº¿">4ï¼åŒºåŸŸæ°´çº¿<a hidden class="anchor" aria-hidden="true" href="#4åŒºåŸŸæ°´çº¿">#</a></h4>
<h4 id="5é˜²æ­¢è¿‡åº¦å€Ÿç”¨">5ï¼é˜²æ­¢è¿‡åº¦å€Ÿç”¨<a hidden class="anchor" aria-hidden="true" href="#5é˜²æ­¢è¿‡åº¦å€Ÿç”¨">#</a></h4>
<h3 id="373æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„">3.7.3ã€€æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„<a hidden class="anchor" aria-hidden="true" href="#373æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„">#</a></h3>
<h3 id="374æ¯å¤„ç†å™¨é¡µé›†åˆ">3.7.4ã€€æ¯å¤„ç†å™¨é¡µé›†åˆ<a hidden class="anchor" aria-hidden="true" href="#374æ¯å¤„ç†å™¨é¡µé›†åˆ">#</a></h3>
<p>â€‚å†…æ ¸é’ˆå¯¹åˆ†é…å•é¡µåšäº†æ€§èƒ½ä¼˜åŒ–ï¼Œä¸ºäº†å‡å°‘å¤„ç†å™¨ä¹‹é—´çš„é”ç«äº‰ï¼Œåœ¨å†…å­˜åŒºåŸŸå¢åŠ  1ä¸ªæ¯å¤„ç†å™¨é¡µé›†åˆã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>include<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>mmzone.h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> zone {
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> per_cpu_pageset __percpu <span style="color:#f92672">*</span>pageset;  <span style="color:#75715e">/* åœ¨æ¯ä¸ªå¤„ç†å™¨ä¸Šæœ‰ä¸€ä¸ªé¡µé›†åˆ */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} ____cacheline_internodealigned_in_smp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> per_cpu_pageset {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> per_cpu_pages pcp;
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> per_cpu_pages {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">int</span> count;      <span style="color:#75715e">/* é“¾è¡¨é‡Œé¢é¡µçš„æ•°é‡ */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">int</span> high;       <span style="color:#75715e">/* å¦‚æœé¡µçš„æ•°é‡è¾¾åˆ°é«˜æ°´çº¿ï¼Œéœ€è¦è¿”è¿˜ç»™ä¼™ä¼´åˆ†é…å™¨ */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">int</span> batch;      <span style="color:#75715e">/* æ‰¹é‡æ·»åŠ æˆ–åˆ é™¤çš„é¡µæ•°é‡ */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> list_head lists[MIGRATE_PCPTYPES]; <span style="color:#75715e">/* æ¯ç§è¿ç§»ç±»å‹ä¸€ä¸ªé¡µé“¾è¡¨ */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="375åˆ†é…é¡µ">3.7.5ã€€åˆ†é…é¡µ<a hidden class="anchor" aria-hidden="true" href="#375åˆ†é…é¡µ">#</a></h3>
<h4 id="1åˆ†é…æ¥å£">1ï¼åˆ†é…æ¥å£<a hidden class="anchor" aria-hidden="true" href="#1åˆ†é…æ¥å£">#</a></h4>
<p>â€‚é¡µåˆ†é…å™¨åˆ†é…é¡µæ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ±‚åˆ†é…ä¸€ä¸ªé˜¶æ•°ä¸ºorderçš„é¡µå—ï¼Œè¿”å›ä¸€ä¸ªpageå®ä¾‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">alloc_pages</span>(gfp_mask, order)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åœ¨é˜¶æ•°ä¸º0æƒ…å†µä¸‹çš„ç®€åŒ–å½¢å¼ï¼Œåªåˆ†é…ä¸€é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">alloc_page</span>(gfp_mask)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åªèƒ½ä»ä½ç«¯å†…å­˜åŒºåŸŸåˆ†é…é¡µï¼Œå¹¶ä¸”è¿”å›è™šæ‹Ÿåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__get_free_pages</span>(gfp_mask, order)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åœ¨é˜¶æ•°ä¸º0æƒ…å†µä¸‹çš„ç®€åŒ–å½¢å¼ï¼Œåªåˆ†é…ä¸€é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__get_free_page</span>(gfp_mask)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°gfp_maskè®¾ç½®äº†æ ‡å¿—ä½__GFP_ZEROä¸”é˜¶æ•°ä¸º0æƒ…å†µä¸‹çš„ç®€åŒ–å½¢å¼ï¼Œåªåˆ†é…ä¸€é¡µï¼Œå¹¶ä¸”ç”¨é›¶åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">get_zeroed_page</span>(gfp_mask)
</span></span></code></pre></div><h4 id="2åˆ†é…æ ‡å¿—ä½">2ï¼åˆ†é…æ ‡å¿—ä½<a hidden class="anchor" aria-hidden="true" href="#2åˆ†é…æ ‡å¿—ä½">#</a></h4>
<p>â€‚åˆ†é…é¡µçš„å‡½æ•°éƒ½å¸¦ä¸€ä¸ªåˆ†é…æ ‡å¿—ä½å‚æ•°ï¼Œåˆ†é…æ ‡å¿—ä½åˆ†ä¸ºä»¥ä¸‹5ç±»
â€‚(1)åŒºåŸŸä¿®é¥°ç¬¦</p>
<p>â€‚(2)é¡µç§»åŠ¨æ€§å’Œä½ç½®æç¤º</p>
<p>â€‚(3)æ°´çº¿ä¿®é¥°ç¬¦</p>
<p>â€‚(4)å›æ”¶ä¿®é¥°ç¬¦</p>
<p>â€‚(5)è¡ŒåŠ¨ä¿®é¥°ç¬¦</p>
<h4 id="3å¤åˆé¡µ">3ï¼å¤åˆé¡µ<a hidden class="anchor" aria-hidden="true" href="#3å¤åˆé¡µ">#</a></h4>
<p>â€‚å¦‚æœè®¾ç½®äº†æ ‡å¿—ä½__GFP_COMPå¹¶ä¸”åˆ†é…äº†ä¸€ä¸ªé˜¶æ•°å¤§äº0çš„é¡µå—ï¼Œé¡µåˆ†é…å™¨ä¼šæŠŠé¡µå—ç»„æˆå¤åˆé¡µï¼ˆcompound pageï¼‰ã€‚å¤åˆé¡µæœ€å¸¸è§çš„ç”¨å¤„æ˜¯åˆ›å»ºå·¨å‹é¡µã€‚  <br>
â€‚å¤åˆé¡µçš„ç¬¬ä¸€é¡µå«é¦–é¡µï¼ˆhead pageï¼‰ï¼Œå…¶ä»–é¡µéƒ½å«å°¾é¡µï¼ˆtail pageï¼‰</p>
<center>å¤åˆé¡µçš„ç»“æ„</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116001100.png" alt="20221116001100"  />
</p>
<h4 id="4å¯¹é«˜é˜¶åŸå­åˆ†é…çš„ä¼˜åŒ–å¤„ç†">4ï¼å¯¹é«˜é˜¶åŸå­åˆ†é…çš„ä¼˜åŒ–å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#4å¯¹é«˜é˜¶åŸå­åˆ†é…çš„ä¼˜åŒ–å¤„ç†">#</a></h4>
<h4 id="5æ ¸å¿ƒå‡½æ•°çš„å®ç°">5ï¼æ ¸å¿ƒå‡½æ•°çš„å®ç°<a hidden class="anchor" aria-hidden="true" href="#5æ ¸å¿ƒå‡½æ•°çš„å®ç°">#</a></h4>
<h3 id="376é‡Šæ”¾é¡µ">3.7.6ã€€é‡Šæ”¾é¡µ<a hidden class="anchor" aria-hidden="true" href="#376é‡Šæ”¾é¡µ">#</a></h3>
<p>â€‚é¡µåˆ†é…å™¨æä¾›äº†ä»¥ä¸‹é‡Šæ”¾é¡µçš„æ¥å£       <br>
â€‚ï¼ˆ1ï¼‰void __free_pages(struct page *page, unsigned int order)ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„pageå®ä¾‹çš„åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é˜¶æ•°   <br>
â€‚ï¼ˆ2ï¼‰void free_pages(unsigned long addr, unsigned int order)ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç¬¬ä¸€ä¸ªç‰©ç†é¡µçš„èµ·å§‹å†…æ ¸è™šæ‹Ÿåœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯é˜¶æ•°    \</p>
<h2 id="38å—åˆ†é…å™¨">3.8ã€€å—åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#38å—åˆ†é…å™¨">#</a></h2>
<p>â€‚Linuxå†…æ ¸æä¾›äº†å—åˆ†é…å™¨ï¼Œå¤„ç†å°å—å†…å­˜åˆ†é…é—®é¢˜ï¼Œæœ€æ—©ä¸ºSLABåˆ†é…å™¨ã€‚å¤§é‡ç‰©ç†å†…å­˜çš„å¤§å‹è®¡ç®—æœºä¸ŠSLUBåˆ†é…å™¨ï¼Œå°å†…å­˜çš„åµŒå…¥å¼è®¾å¤‡ä¸ŠSLOB   \</p>
<h3 id="381-ç¼–ç¨‹æ¥å£">3.8.1 ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#381-ç¼–ç¨‹æ¥å£">#</a></h3>
<p>â€‚3ç§å—åˆ†é…å™¨æä¾›äº†ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ï¼Œå—åˆ†é…å™¨åœ¨åˆå§‹åŒ–çš„æ—¶å€™åˆ›å»ºäº†ä¸€äº›é€šç”¨çš„å†…å­˜ç¼“å­˜ï¼Œä»æ™®é€šåŒºåŸŸåˆ†é…é¡µçš„å†…å­˜ç¼“å­˜çš„åç§°æ˜¯<code>kmalloc-&lt;size&gt;</code>ï¼ŒDMAåŒºåŸŸåˆ†é…é¡µçš„å†…å­˜ç¼“å­˜çš„åç§°æ˜¯<code>dma-kmalloc-&lt;size&gt;</code>ï¼Œæ‰§è¡Œå‘½ä»¤<code>cat /proc/slabinfo</code>å¯ä»¥çœ‹åˆ°è¿™äº›é€šç”¨çš„å†…å­˜ç¼“å­˜   \</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kmalloc</span>(<span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">gfp_t</span> flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡æ–°åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">krealloc</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>p, <span style="color:#66d9ef">size_t</span> new_size, <span style="color:#66d9ef">gfp_t</span> flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kfree</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>objp);
</span></span></code></pre></div><p>â€‚åˆ›å»ºä¸“ç”¨çš„å†…å­˜ç¼“å­˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆ›å»ºå†…å­˜ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span><span style="color:#a6e22e">kmem_cache_create</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, <span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">size_t</span> align, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>ctor)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä»æŒ‡å®šçš„å†…å­˜ç¼“å­˜åˆ†é…å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kmem_cache_alloc</span>(<span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>cachep, <span style="color:#66d9ef">gfp_t</span> flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾å¯¹è±¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kmem_cache_free</span>(<span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>cachep, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>objp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é”€æ¯å†…å­˜ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kmem_cache_destroy</span>(<span style="color:#66d9ef">struct</span> kmem_cache <span style="color:#f92672">*</span>s);
</span></span></code></pre></div><h3 id="382-slabåˆ†é…å™¨">3.8.2 SLABåˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#382-slabåˆ†é…å™¨">#</a></h3>
<h4 id="1æ•°æ®ç»“æ„-2">1.æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#1æ•°æ®ç»“æ„-2">#</a></h4>
<center>å†…å­˜ç¼“å­˜çš„æ•°æ®ç»“æ„</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116233943.png" alt="20221116233943"  />
</p>
<p>â€‚ï¼ˆ1ï¼‰æ¯ä¸ªå†…å­˜ç¼“å­˜å¯¹åº”ä¸€ä¸ªkmem_cacheå®ä¾‹    \</p>
<p>â€‚ï¼ˆ2ï¼‰æ¯ä¸ªå†…å­˜èŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªkmem_cache_nodeå®ä¾‹</p>
<p>â€‚pageç»“æ„ä½“çš„æˆå‘˜   <br>
â€‚1)flagsè®¾ç½®æ ‡å¿—ä½PG_slabï¼Œè¡¨ç¤ºé¡µå±äºSLABåˆ†é…å™¨      <br>
â€‚2)s_memå­˜æ”¾slabç¬¬ä¸€ä¸ªå¯¹è±¡çš„åœ°å€   <br>
â€‚3)activeè¡¨ç¤ºå·²åˆ†é…å¯¹è±¡çš„æ•°é‡   <br>
â€‚4)lruä½œä¸ºé“¾è¡¨èŠ‚ç‚¹åŠ å…¥å…¶ä¸­ä¸€æ¡slabé“¾è¡¨   <br>
â€‚5)slab_cacheæŒ‡å‘kmem_cacheå®ä¾‹   <br>
â€‚6)freelistæŒ‡å‘ç©ºé—²å¯¹è±¡é“¾è¡¨   \</p>
<p>â€‚ï¼ˆ3ï¼‰kmem_cacheå®ä¾‹çš„æˆå‘˜cpu_slabæŒ‡å‘array_cacheå®ä¾‹ï¼Œ</p>
<h4 id="2ç©ºé—²å¯¹è±¡é“¾è¡¨">2.ç©ºé—²å¯¹è±¡é“¾è¡¨<a hidden class="anchor" aria-hidden="true" href="#2ç©ºé—²å¯¹è±¡é“¾è¡¨">#</a></h4>
<p>â€‚æ¯ä¸ªslabéœ€è¦ä¸€ä¸ªç©ºé—²å¯¹è±¡é“¾è¡¨ï¼Œä»è€ŒæŠŠæ‰€æœ‰ç©ºé—²å¯¹è±¡é“¾æ¥èµ·æ¥ï¼Œç©ºé—²å¯¹è±¡é“¾è¡¨æ˜¯ç”¨æ•°ç»„å®ç°çš„ï¼Œpage-&gt;freelistæŒ‡å‘ç©ºé—²å¯¹è±¡é“¾è¡¨</p>
<center>ä½¿ç”¨å¯¹è±¡å­˜æ”¾ç©ºé—²å¯¹è±¡é“¾è¡¨-åˆå§‹çŠ¶æ€</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116234847.png" alt="20221116234847"  />
</p>
<center>ä½¿ç”¨å¯¹è±¡å­˜æ”¾ç©ºé—²å¯¹è±¡é“¾è¡¨-åˆ†é…æœ€åä¸€ä¸ªç©ºé—²å¯¹è±¡</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116235027.png" alt="20221116235027"  />
</p>
<center>ç©ºé—²å¯¹è±¡é“¾è¡¨åœ¨slabå¤–é¢</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116235136.png" alt="20221116235136"  />
</p>
<h4 id="3è®¡ç®—slabé•¿åº¦">3.è®¡ç®—slabé•¿åº¦<a hidden class="anchor" aria-hidden="true" href="#3è®¡ç®—slabé•¿åº¦">#</a></h4>
<p>â€‚å‡½æ•°calculate_slab_orderè´Ÿè´£è®¡ç®—slabé•¿åº¦ï¼Œä»0é˜¶åˆ°kmalloc()å‡½æ•°æ”¯æŒçš„æœ€å¤§é˜¶æ•°ï¼ˆKMALLOC_MAX_ORDERï¼‰</p>
<h4 id="4ç€è‰²">4.ç€è‰²<a hidden class="anchor" aria-hidden="true" href="#4ç€è‰²">#</a></h4>
<h4 id="5æ¯å¤„ç†å™¨æ•°ç»„ç¼“å­˜">5ï¼æ¯å¤„ç†å™¨æ•°ç»„ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#5æ¯å¤„ç†å™¨æ•°ç»„ç¼“å­˜">#</a></h4>
<p>â€‚å†…å­˜ç¼“å­˜ä¸ºæ¯ä¸ªå¤„ç†å™¨åˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„ç¼“å­˜ï¼ˆç»“æ„ä½“array_cacheï¼‰ã€‚é‡Šæ”¾å¯¹è±¡æ—¶ï¼ŒæŠŠå¯¹è±¡å­˜æ”¾åˆ°å½“å‰å¤„ç†å™¨å¯¹åº”çš„æ•°ç»„ç¼“å­˜ä¸­</p>
<center>æ¯å¤„ç†å™¨æ•°ç»„ç¼“å†²</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116235443.png" alt="20221116235443"  />
</p>
<h4 id="6å¯¹numaçš„æ”¯æŒ">6ï¼å¯¹NUMAçš„æ”¯æŒ<a hidden class="anchor" aria-hidden="true" href="#6å¯¹numaçš„æ”¯æŒ">#</a></h4>
<center>SLABåˆ†é…å™¨æ”¯æŒNUMA</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116235608.png" alt="20221116235608"  />
</p>
<h4 id="7å†…å­˜ç¼“å­˜åˆå¹¶">7ï¼å†…å­˜ç¼“å­˜åˆå¹¶<a hidden class="anchor" aria-hidden="true" href="#7å†…å­˜ç¼“å­˜åˆå¹¶">#</a></h4>
<p>â€‚å‡å°‘å†…å­˜å¼€é”€å’Œå¢åŠ å¯¹è±¡çš„ç¼“å­˜çƒ­åº¦ï¼Œå—åˆ†é…å™¨ä¼šåˆå¹¶ç›¸ä¼¼çš„å†…å­˜ç¼“å­˜</p>
<h4 id="8å›æ”¶å†…å­˜">8.å›æ”¶å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#8å›æ”¶å†…å­˜">#</a></h4>
<p>â€‚æ‰€æœ‰å¯¹è±¡ç©ºé—²çš„slabï¼Œæ²¡æœ‰ç«‹å³é‡Šæ”¾ï¼Œè€Œæ˜¯æ”¾åœ¨ç©ºé—²slabé“¾è¡¨ä¸­ã€‚åªæœ‰å†…å­˜èŠ‚ç‚¹ä¸Šç©ºé—²å¯¹è±¡çš„æ•°é‡è¶…è¿‡é™åˆ¶ï¼Œæ‰å¼€å§‹å›æ”¶ç©ºé—²slabï¼Œç›´åˆ°ç©ºé—²å¯¹è±¡çš„æ•°é‡å°äºæˆ–ç­‰äºé™åˆ¶    <br>
â€‚ç»“æ„ä½“kmem_cache_nodeçš„æˆå‘˜slabs_freeæ˜¯ç©ºé—²slabé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œæˆå‘˜free_objectsæ˜¯ç©ºé—²å¯¹è±¡çš„æ•°é‡ï¼Œæˆå‘˜free_limitæ˜¯ç©ºé—²å¯¹è±¡çš„æ•°é‡é™åˆ¶    \</p>
<center>å›æ”¶ç©ºé—²slab</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221116235852.png" alt="20221116235852"  />
</p>
<h3 id="383slubåˆ†é…å™¨">3.8.3ã€€SLUBåˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#383slubåˆ†é…å™¨">#</a></h3>
<h4 id="1æ•°æ®ç»“æ„-3">1ï¼æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#1æ•°æ®ç»“æ„-3">#</a></h4>
<center>SLUBåˆ†é…å™¨å†…å­˜ç¼“å­˜çš„æ•°æ®ç»“æ„</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117000104.png" alt="20221117000104"  />
</p>
<h4 id="2ç©ºé—²å¯¹è±¡é“¾è¡¨-1">2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨<a hidden class="anchor" aria-hidden="true" href="#2ç©ºé—²å¯¹è±¡é“¾è¡¨-1">#</a></h4>
<center>ç©ºé—²å¯¹è±¡é“¾è¡¨çš„åˆå§‹çŠ¶æ€</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117000219.png" alt="20221117000219"  />
</p>
<center>åˆ†é…ä¸€ä¸ªå¯¹è±¡ä»¥åçš„ç©ºé—²å¯¹è±¡é“¾è¡¨</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117000252.png" alt="20221117000252"  />
</p>
<h4 id="3è®¡ç®—slabé•¿åº¦-1">3ï¼è®¡ç®—slabé•¿åº¦<a hidden class="anchor" aria-hidden="true" href="#3è®¡ç®—slabé•¿åº¦-1">#</a></h4>
<p>â€‚SLUBåˆ†é…å™¨åœ¨åˆ›å»ºå†…å­˜ç¼“å­˜çš„æ—¶å€™è®¡ç®—äº†ä¸¤ç§slabé•¿åº¦ï¼šæœ€ä¼˜slabå’Œæœ€å°slab</p>
<h4 id="4æ¯å¤„ç†å™¨slabç¼“å­˜">4ï¼æ¯å¤„ç†å™¨slabç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#4æ¯å¤„ç†å™¨slabç¼“å­˜">#</a></h4>
<center>SLUBåˆ†é…å™¨çš„æ¯å¤„ç†å™¨slabç¼“å­˜</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/2022-11-17_00-04.png" alt="2022-11-17_00-04"  />
</p>
<h4 id="5å¯¹numaçš„æ”¯æŒ">5ï¼å¯¹NUMAçš„æ”¯æŒ<a hidden class="anchor" aria-hidden="true" href="#5å¯¹numaçš„æ”¯æŒ">#</a></h4>
<p>â€‚ï¼ˆ1ï¼‰å†…å­˜ç¼“å­˜é’ˆå¯¹æ¯ä¸ªå†…å­˜èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªkmem_cache_nodeå®ä¾‹   <br>
â€‚ï¼ˆ2ï¼‰åˆ†é…å¯¹è±¡æ—¶ï¼Œå¦‚æœå½“å‰å¤„ç†å™¨çš„slabç¼“å­˜æ˜¯ç©ºçš„ï¼Œéœ€è¦é‡å¡«å½“å‰å¤„ç†å™¨çš„slabç¼“å­˜   \</p>
<h4 id="6å›æ”¶å†…å­˜">6.å›æ”¶å†…å­˜<a hidden class="anchor" aria-hidden="true" href="#6å›æ”¶å†…å­˜">#</a></h4>
<p>â€‚å¯¹äºæ‰€æœ‰å¯¹è±¡ç©ºé—²çš„slabï¼Œå¦‚æœå†…å­˜èŠ‚ç‚¹çš„éƒ¨åˆ†ç©ºé—²slabçš„æ•°é‡å¤§äºæˆ–ç­‰äºæœ€å°éƒ¨åˆ†ç©ºé—²slabæ•°é‡ï¼Œé‚£ä¹ˆç›´æ¥é‡Šæ”¾ï¼Œå¦åˆ™æ”¾åœ¨éƒ¨åˆ†ç©ºé—²slabé“¾è¡¨çš„å°¾éƒ¨</p>
<h4 id="7è°ƒè¯•">7.è°ƒè¯•<a hidden class="anchor" aria-hidden="true" href="#7è°ƒè¯•">#</a></h4>
<h3 id="384slobåˆ†é…å™¨">3.8.4ã€€SLOBåˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#384slobåˆ†é…å™¨">#</a></h3>
<h4 id="1æ•°æ®ç»“æ„-4">1ï¼æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#1æ•°æ®ç»“æ„-4">#</a></h4>
<center>SLOBåˆ†é…å™¨å†…å­˜ç¼“å­˜çš„æ•°æ®ç»“æ„</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117223330.png" alt="20221117223330"  />
</p>
<h4 id="2ç©ºé—²å¯¹è±¡é“¾è¡¨-2">2ï¼ç©ºé—²å¯¹è±¡é“¾è¡¨<a hidden class="anchor" aria-hidden="true" href="#2ç©ºé—²å¯¹è±¡é“¾è¡¨-2">#</a></h4>
<center>ç©ºé—²å¯¹è±¡é“¾è¡¨çš„åˆå§‹çŠ¶æ€</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117223614.png" alt="20221117223614"  />
</p>
<center>åˆ†é…ä¸€ä¸ªå¯¹è±¡ä»¥åçš„ç©ºé—²å¯¹è±¡é“¾è¡¨</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117223707.png" alt="20221117223707"  />
</p>
<h4 id="3åˆ†é…å¯¹è±¡">3ï¼åˆ†é…å¯¹è±¡<a hidden class="anchor" aria-hidden="true" href="#3åˆ†é…å¯¹è±¡">#</a></h4>
<p>â€‚åˆ†é…å¯¹è±¡æ—¶ï¼Œæ ¹æ®å¯¹è±¡é•¿åº¦é€‰æ‹©ä¸åŒçš„ç­–ç•¥</p>
<h2 id="39ä¸è¿ç»­é¡µåˆ†é…å™¨">3.9ã€€ä¸è¿ç»­é¡µåˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#39ä¸è¿ç»­é¡µåˆ†é…å™¨">#</a></h2>
<h3 id="391ç¼–ç¨‹æ¥å£">3.9.1ã€€ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#391ç¼–ç¨‹æ¥å£">#</a></h3>
<p>â€‚ä¸è¿ç»­é¡µåˆ†é…å™¨æä¾›äº†ä»¥ä¸‹ç¼–ç¨‹æ¥å£</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// vmallocå‡½æ•°ï¼šåˆ†é…ä¸è¿ç»­çš„ç‰©ç†é¡µå¹¶ä¸”æŠŠç‰©ç†é¡µæ˜ å°„åˆ°è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">vmalloc</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// vfreeå‡½æ•°ï¼šé‡Šæ”¾vmallocåˆ†é…çš„ç‰©ç†é¡µå’Œè™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vfree</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// vmapå‡½æ•°ï¼šæŠŠå·²ç»åˆ†é…çš„ä¸è¿ç»­ç‰©ç†é¡µæ˜ å°„åˆ°è¿ç»­çš„è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// pagesæ˜¯pageæŒ‡é’ˆæ•°ç»„ï¼Œcountæ˜¯pageæŒ‡é’ˆæ•°ç»„å¤§å°ï¼Œflagsæ ‡å¿—ä½ï¼Œproté¡µä¿æŠ¤ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">vmap</span>(<span style="color:#66d9ef">struct</span> page <span style="color:#f92672">**</span>pages, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> count, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, <span style="color:#66d9ef">pgprot_t</span> prot);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// vunmapå‡½æ•°ï¼šé‡Šæ”¾ä½¿ç”¨vmapåˆ†é…çš„è™šæ‹Ÿåœ°å€ç©ºé—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">vunmap</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kvmallocå‡½æ•°ï¼šå…ˆå°è¯•ä½¿ç”¨kmallocåˆ†é…å†…å­˜å—ï¼Œå¦‚æœå¤±è´¥ï¼Œé‚£ä¹ˆä½¿ç”¨vmallocå‡½æ•°åˆ†é…ä¸è¿ç»­çš„ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kvmalloc</span>(<span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">gfp_t</span> flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kvfreeå‡½æ•°ï¼šå¦‚æœå†…å­˜å—æ˜¯ä½¿ç”¨vmallocåˆ†é…çš„ï¼Œé‚£ä¹ˆä½¿ç”¨vfreeé‡Šæ”¾ï¼Œå¦åˆ™ä½¿ç”¨kfreeé‡Šæ”¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">kvfree</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr);
</span></span></code></pre></div><h3 id="392æ•°æ®ç»“æ„">3.9.2ã€€æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#392æ•°æ®ç»“æ„">#</a></h3>
<center>ä¸è¿ç»­é¡µåˆ†é…å™¨çš„æ•°æ®ç»“æ„</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/2022-11-17_22-53_1.png" alt="2022-11-17_22-53_1"  />
</p>
<center>ä½¿ç”¨vmapå‡½æ•°åˆ†é…è™šæ‹Ÿå†…å­˜åŒºåŸŸ</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221117225854.png" alt="20221117225854"  />
</p>
<h3 id="393æŠ€æœ¯åŸç†">3.9.3ã€€æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#393æŠ€æœ¯åŸç†">#</a></h3>
<p>â€‚vmallocè™šæ‹Ÿåœ°å€ç©ºé—´çš„èŒƒå›´æ˜¯[VMALLOC_START, VMALLOC_END)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/pgtable.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define VMALLOC_START        (MODULES_END)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define VMALLOC_END       (PAGE_OFFSET - PUD_SIZE - VMEMMAP_SIZE - SZ_64K)
</span></span></span></code></pre></div><p>â€‚MODULES_ENDæ˜¯å†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€ï¼ŒPAGE_OFFSETæ˜¯çº¿æ€§æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼ŒPUD_SIZEæ˜¯ä¸€ä¸ªé¡µä¸Šå±‚ç›®å½•è¡¨é¡¹æ˜ å°„çš„åœ°å€ç©ºé—´é•¿åº¦ï¼ŒVMEMMAP_SIZEæ˜¯vmemmapåŒºåŸŸçš„é•¿åº¦ã€‚    <br>
â€‚vmallocè™šæ‹Ÿåœ°å€ç©ºé—´çš„èµ·å§‹åœ°å€ç­‰äºå†…æ ¸æ¨¡å—åŒºåŸŸçš„ç»“æŸåœ°å€ã€‚   <br>
â€‚vmallocè™šæ‹Ÿåœ°å€ç©ºé—´çš„ç»“æŸåœ°å€ç­‰äºï¼ˆçº¿æ€§æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€âˆ’ä¸€ä¸ªé¡µä¸Šå±‚ç›®å½•è¡¨é¡¹æ˜ å°„çš„åœ°å€ç©ºé—´é•¿åº¦âˆ’vmemmapåŒºåŸŸçš„é•¿åº¦âˆ’64KBï¼‰   <br>
â€‚å‡½æ•°vmallocçš„æ‰§è¡Œè¿‡ç¨‹åˆ†ä¸º3æ­¥       <br>
â€‚ï¼ˆ1ï¼‰åˆ†é…è™šæ‹Ÿå†…å­˜åŒºåŸŸ          <br>
â€ƒåˆ†é…vm_structå®ä¾‹å’Œvmap_areaå®ä¾‹    <br>
â€‚ï¼ˆ2ï¼‰ åˆ†é…ç‰©ç†é¡µ        <br>
â€ƒvm_structå®ä¾‹çš„æˆå‘˜nr_pageså­˜æ”¾é¡µæ•°nï¼›åˆ†é…pageæŒ‡é’ˆæ•°ç»„   <br>
â€‚ï¼ˆ3ï¼‰åœ¨å†…æ ¸çš„é¡µè¡¨ä¸­æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ    <br>
â€ƒå†…æ ¸çš„é¡µè¡¨å°±æ˜¯0å·å†…æ ¸çº¿ç¨‹çš„é¡µè¡¨ã€‚0å·å†…æ ¸çº¿ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦æ˜¯å…¨å±€å˜é‡init_taskï¼Œæˆå‘˜active_mmæŒ‡å‘å…¨å±€å˜é‡init_mmï¼Œinit_mmçš„æˆå‘˜pgdæŒ‡å‘é¡µå…¨å±€ç›®å½•swapper_pg_dir</p>
<h2 id="310æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨">3.10ã€€æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#310æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨">#</a></h2>
<p>â€‚å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯å¤„ç†å™¨å˜é‡ä¸ºæ¯ä¸ªå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªå˜é‡çš„å‰¯æœ¬</p>
<h3 id="3101ç¼–ç¨‹æ¥å£">3.10.1ã€€ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#3101ç¼–ç¨‹æ¥å£">#</a></h3>
<p>â€‚æ¯å¤„ç†å™¨å˜é‡åˆ†ä¸ºé™æ€å’ŒåŠ¨æ€ä¸¤ç§</p>
<h4 id="1é™æ€æ¯å¤„ç†å™¨å˜é‡">1.é™æ€æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#1é™æ€æ¯å¤„ç†å™¨å˜é‡">#</a></h4>
<p>â€‚å®â€œDEFINE_PER_CPU(type, name)â€å®šä¹‰æ™®é€šçš„é™æ€æ¯å¤„ç†å™¨å˜é‡ï¼Œä½¿ç”¨å®â€œDECLARE_PER_CPU(type, name)â€å£°æ˜æ™®é€šçš„é™æ€æ¯å¤„ç†å™¨å˜é‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// å®â€œDEFINE_PER_CPU(type, name)â€å±•å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// é™æ€æ¯å¤„ç†å™¨å˜é‡å­˜æ”¾åœ¨â€œ.data..percpuâ€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__attribute__</span>((<span style="color:#a6e22e">section</span>(<span style="color:#e6db74">&#34;.data..percpu&#34;</span>)))  <span style="color:#a6e22e">__typeof__</span>(type)  name
</span></span></code></pre></div><h4 id="2åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡">2ï¼åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#2åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡">#</a></h4>
<p>â€‚ä¸ºåŠ¨æ€æ¯å¤„ç†å™¨å˜é‡åˆ†é…å†…å­˜çš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// __alloc_percpu_gfpä¸ºåŠ¨æ€æ¯å¤„ç†å™¨å˜é‡åˆ†é…å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __percpu <span style="color:#f92672">*</span><span style="color:#a6e22e">__alloc_percpu_gfp</span>(<span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">size_t</span> align, <span style="color:#66d9ef">gfp_t</span> gfp);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®alloc_percpu_gfp(type, gfp)æ˜¯å‡½æ•°__alloc_percpu_gfpçš„ç®€åŒ–å½¢å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®alloc_percpu_gfp(type, gfp)æ˜¯å‡½æ•°__alloc_percpu_gfpçš„ç®€åŒ–å½¢å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> __percpu <span style="color:#f92672">*</span><span style="color:#a6e22e">__alloc_percpu</span>(<span style="color:#66d9ef">size_t</span> size, <span style="color:#66d9ef">size_t</span> align);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// free_percpué‡Šæ”¾åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡çš„å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">free_percpu</span>(<span style="color:#66d9ef">void</span> __percpu <span style="color:#f92672">*</span>__pdata);
</span></span></code></pre></div><h4 id="3è®¿é—®æ¯å¤„ç†å™¨å˜é‡">3ï¼è®¿é—®æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#3è®¿é—®æ¯å¤„ç†å™¨å˜é‡">#</a></h4>
<p>â€‚å®â€œthis_cpu_ptr(ptr)â€ç”¨æ¥å¾—åˆ°å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„åœ°å€ï¼Œå®â€œget_cpu_var(var)â€ç”¨æ¥å¾—åˆ°å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„å€¼</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// å®this_cpu_ptr(ptr)å±•å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> __ptr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>__ptr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>) (ptr);
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">typeof</span>(ptr)) (__ptr <span style="color:#f92672">+</span> <span style="color:#a6e22e">per_cpu_offset</span>(<span style="color:#a6e22e">raw_smp_processor_id</span>()));
</span></span></code></pre></div><p>â€‚å®â€œper_cpu_ptr(ptr, cpu)â€ç”¨æ¥å¾—åˆ°æŒ‡å®šå¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„åœ°å€ï¼Œå®â€œper_cpu(var, cpu)â€ç”¨æ¥å¾—åˆ°æŒ‡å®šå¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„å€¼ã€‚     <br>
â€‚å®â€œget_cpu_ptr(var)â€ç¦æ­¢å†…æ ¸æŠ¢å å¹¶ä¸”è¿”å›å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„åœ°å€ï¼Œå®â€œput_cpu_ptr(var)â€å¼€å¯å†…æ ¸æŠ¢å ï¼Œè¿™ä¸¤ä¸ªå®æˆå¯¹ä½¿ç”¨    <br>
â€‚å®â€œget_cpu_var(var)â€ç¦æ­¢å†…æ ¸æŠ¢å å¹¶ä¸”è¿”å›å½“å‰å¤„ç†å™¨çš„å˜é‡å‰¯æœ¬çš„å€¼ï¼Œå®â€œput_cpu_var(var)â€å¼€å¯å†…æ ¸æŠ¢å ï¼Œè¿™ä¸¤ä¸ªå®æˆå¯¹ä½¿ç”¨    \</p>
<h3 id="3102æŠ€æœ¯åŸç†">3.10.2ã€€æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#3102æŠ€æœ¯åŸç†">#</a></h3>
<p>â€‚æ¯å¤„ç†å™¨åŒºåŸŸæ˜¯æŒ‰å—ï¼ˆchunkï¼‰åˆ†é…çš„    <br>
â€‚åˆ†é…å—çš„æ–¹å¼æœ‰ä¸¤ç§:   <br>
â€‚(1)åˆ†é…å—çš„æ–¹å¼æœ‰ä¸¤ç§   <br>
â€‚(2)åˆ†é…å—çš„æ–¹å¼æœ‰ä¸¤ç§   \</p>
<center>åŸºäºvmallocåŒºåŸŸçš„æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221118000310.png" alt="20221118000310"  />

æ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªpcpu_chunkå®ä¾‹</p>
<p>â€‚</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221118000525.png" alt="20221118000525"  />
</p>
<center>åŸºäºå†…æ ¸å†…å­˜çš„æ¯å¤„ç†å™¨å†…å­˜åˆ†é…å™¨</center>
<h2 id="311é¡µè¡¨">3.11ã€€é¡µè¡¨<a hidden class="anchor" aria-hidden="true" href="#311é¡µè¡¨">#</a></h2>
<h3 id="3111ç»Ÿä¸€çš„é¡µè¡¨æ¡†æ¶">3.11.1ã€€ç»Ÿä¸€çš„é¡µè¡¨æ¡†æ¶<a hidden class="anchor" aria-hidden="true" href="#3111ç»Ÿä¸€çš„é¡µè¡¨æ¡†æ¶">#</a></h3>
<p>â€‚é¡µè¡¨ç”¨æ¥æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µï¼Œå¹¶ä¸”å­˜æ”¾é¡µçš„ä¿æŠ¤ä½ï¼Œå³è®¿é—®æƒé™     <br>
â€‚Linux 4.11ç‰ˆæœ¬ä»¥å‰ï¼ŒLinuxå†…æ ¸æŠŠé¡µè¡¨åˆ†ä¸º4çº§    <br>
â€‚(1)é¡µå…¨å±€ç›®å½•(Page Global Directory PGD)   <br>
â€‚(2)é¡µä¸Šå±‚ç›®å½•(Page Upper DIrectory PUD)    <br>
â€‚(3)é¡µä¸­é—´ç›®å½•(Page Middle Directory PMD)   <br>
â€‚(4)ç›´æ¥é¡µè¡¨(Page Table PT)      <br>
â€‚4.11ç‰ˆæœ¬æŠŠé¡µè¡¨æ‰©å±•åˆ°äº”çº§ï¼Œåœ¨é¡µå…¨å±€ç›®å½•å’Œé¡µä¸Šå±‚ç›®å½•ä¹‹é—´å¢åŠ äº†é¡µå››çº§ç›®å½•(Page 4th Directoryï¼ŒP4D)    \</p>
<p>â€‚å†…æ ¸ä¹Ÿæœ‰ä¸€ä¸ªé¡µè¡¨ï¼Œ0å·å†…æ ¸çº¿ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦init_taskçš„æˆå‘˜active_mmæŒ‡å‘å†…å­˜æè¿°ç¬¦init_mmï¼Œå†…å­˜æè¿°ç¬¦init_mmçš„æˆå‘˜pgdæŒ‡å‘å†…æ ¸çš„é¡µå…¨å±€ç›®å½•swapper_pg_dir   <br>
â€‚è™šæ‹Ÿåœ°å€è¢«åˆ†è§£ä¸º6ä¸ªéƒ¨åˆ†ï¼šé¡µå…¨å±€ç›®å½•ç´¢å¼•ã€é¡µå››çº§ç›®å½•ç´¢å¼•ã€é¡µä¸Šå±‚ç›®å½•ç´¢å¼•ã€é¡µä¸­é—´ç›®å½•ç´¢å¼•ã€ç›´æ¥é¡µè¡¨ç´¢å¼•å’Œé¡µå†…åç§»   \</p>
<h3 id="3112arm64å¤„ç†å™¨çš„é¡µè¡¨">3.11.2ã€€ARM64å¤„ç†å™¨çš„é¡µè¡¨<a hidden class="anchor" aria-hidden="true" href="#3112arm64å¤„ç†å™¨çš„é¡µè¡¨">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨æŠŠé¡µè¡¨ç§°ä¸ºè½¬æ¢è¡¨(translation table)ï¼Œæœ€å¤š4çº§ã€‚ARM64å¤„ç†å™¨æ”¯æŒ3 ç§é¡µé•¿åº¦ï¼š4KBã€16KBå’Œ64KBã€‚   ã€
â€‚é¡µé•¿åº¦æ˜¯4KBï¼šä½¿ç”¨4çº§è½¬æ¢è¡¨ï¼Œè½¬æ¢è¡¨å’Œå†…æ ¸çš„é¡µè¡¨æœ¯è¯­çš„å¯¹åº”å…³ç³»æ˜¯ï¼š0çº§è½¬æ¢è¡¨å¯¹åº”é¡µå…¨å±€ç›®å½•ï¼Œ1çº§è½¬æ¢è¡¨å¯¹åº”é¡µä¸Šå±‚ç›®å½•ï¼Œ2çº§è½¬æ¢è¡¨å¯¹åº”é¡µä¸­é—´ç›®å½•ï¼Œ3çº§è½¬æ¢è¡¨å¯¹åº”ç›´æ¥é¡µè¡¨  \</p>
<h2 id="312é¡µè¡¨ç¼“å­˜">3.12ã€€é¡µè¡¨ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#312é¡µè¡¨ç¼“å­˜">#</a></h2>
<p>â€‚å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰è´Ÿè´£æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ã€‚
â€‚TLBï¼ˆTranslation Lookaside Bufferï¼‰çš„é«˜é€Ÿç¼“å­˜ï¼ŒTLBç›´è¯‘ä¸ºè½¬æ¢åå¤‡ç¼“å†²åŒºï¼Œæ„è¯‘ä¸ºé¡µè¡¨ç¼“å­˜ï¼Œç¼“å­˜æœ€è¿‘ä½¿ç”¨è¿‡çš„é¡µè¡¨é¡¹ã€‚ä¸¤çº§é¡µè¡¨ç¼“å­˜ï¼šç¬¬ä¸€çº§TLBåˆ†ä¸ºæŒ‡ä»¤TLBå’Œæ•°æ®TLBï¼Œå¥½å¤„æ˜¯å–æŒ‡ä»¤å’Œå–æ•°æ®å¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼›ç¬¬äºŒçº§TLBæ˜¯ç»Ÿä¸€TLBï¼ˆUnified TLBï¼‰ï¼Œå³æŒ‡ä»¤å’Œæ•°æ®å…±ç”¨çš„TLB</p>
<h3 id="3121tlbè¡¨é¡¹æ ¼å¼">3.12.1ã€€TLBè¡¨é¡¹æ ¼å¼<a hidden class="anchor" aria-hidden="true" href="#3121tlbè¡¨é¡¹æ ¼å¼">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨çš„æ¯æ¡TLBè¡¨é¡¹ä¸ä»…åŒ…å«è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ï¼Œä¹ŸåŒ…å«å±æ€§ï¼šå†…å­˜ç±»å‹ã€ç¼“å­˜ç­–ç•¥ã€è®¿é—®æƒé™ã€åœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼ˆAddress Space Identifierï¼ŒASIDï¼‰å’Œè™šæ‹Ÿæœºæ ‡è¯†ç¬¦ï¼ˆVirtual Machine Identifierï¼ŒVMIDï¼‰ã€‚åœ°å€ç©ºé—´æ ‡è¯†ç¬¦åŒºåˆ†ä¸åŒè¿›ç¨‹çš„é¡µè¡¨é¡¹ï¼Œè™šæ‹Ÿæœºæ ‡è¯†ç¬¦åŒºåˆ†ä¸åŒè™šæ‹Ÿæœºçš„é¡µè¡¨é¡¹   \</p>
<h3 id="3122tlbç®¡ç†">3.12.2ã€€TLBç®¡ç†<a hidden class="anchor" aria-hidden="true" href="#3122tlbç®¡ç†">#</a></h3>
<p>â€‚é¡µè¡¨æ”¹å˜ä»¥åå†²åˆ·TLBçš„å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ä½¿æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_tlb_all</span>(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä½¿æŒ‡å®šç”¨æˆ·åœ°å€ç©ºé—´çš„æŸä¸ªèŒƒå›´çš„TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°vmaæ˜¯è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œstartæ˜¯èµ·å§‹åœ°å€ï¼Œendæ˜¯ç»“æŸåœ°å€ï¼ˆä¸åŒ…æ‹¬ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_tlb_range</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> end);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä½¿æŒ‡å®šç”¨æˆ·åœ°å€ç©ºé—´é‡Œé¢çš„æŒ‡å®šè™šæ‹Ÿé¡µçš„TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°vmaæ˜¯è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œuaddræ˜¯ä¸€ä¸ªè™šæ‹Ÿé¡µä¸­çš„ä»»æ„è™šæ‹Ÿåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_tlb_page</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> uaddr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä½¿å†…æ ¸çš„æŸä¸ªè™šæ‹Ÿåœ°å€èŒƒå›´çš„TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å‚æ•°startæ˜¯èµ·å§‹åœ°å€ï¼Œendæ˜¯ç»“æŸåœ°å€ï¼ˆä¸åŒ…æ‹¬ï¼‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_tlb_kernel_range</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> start, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> end);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¿®æ”¹é¡µè¡¨é¡¹ä»¥åæŠŠé¡µè¡¨é¡¹è®¾ç½®åˆ°é¡µè¡¨ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”±è½¯ä»¶ç®¡ç†é¡µè¡¨ç¼“å­˜çš„å¤„ç†å™¨å¿…é¡»å®ç°è¯¥å‡½æ•°ï¼Œä¾‹å¦‚MIPSå¤„ç†å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ARM64å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒå¯ä»¥è®¿é—®å†…å­˜ä¸­çš„é¡µè¡¨ï¼ŒæŠŠé¡µè¡¨é¡¹å¤åˆ¶åˆ°é¡µè¡¨ç¼“å­˜ï¼Œæ‰€ä»¥ARM64æ¶æ„çš„å‡½æ•°update_mmu_cacheä»€ä¹ˆéƒ½ä¸ç”¨åš
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">update_mmu_cache</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> address, <span style="color:#66d9ef">pte_t</span> <span style="color:#f92672">*</span>ptep);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å†…æ ¸æŠŠè¿›ç¨‹ä»ä¸€ä¸ªå¤„ç†å™¨è¿ç§»åˆ°å¦ä¸€ä¸ªå¤„ç†å™¨ä»¥åï¼Œè°ƒç”¨è¯¥å‡½æ•°ä»¥æ›´æ–°é¡µè¡¨ç¼“å­˜æˆ–ä¸Šä¸‹æ–‡ç‰¹å®šä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tlb_migrate_finish</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm);
</span></span></code></pre></div><p>â€‚ARM64æ¶æ„æ²¡æœ‰æä¾›å†™TLBçš„æŒ‡ä»¤ã€‚   <br>
â€‚ARM64æ¶æ„æä¾›äº†ä¸€æ¡TLBå¤±æ•ˆæŒ‡ä»¤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>TLBI <span style="color:#f92672">&lt;</span>type<span style="color:#f92672">&gt;&lt;</span>level<span style="color:#f92672">&gt;</span>{IS} {, <span style="color:#f92672">&lt;</span>Xt<span style="color:#f92672">&gt;</span>}
</span></span></code></pre></div><p>â€‚ARM64å†…æ ¸flush_tlb_allå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/tlbflush.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_tlb_all</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dsbæ•°æ®åŒæ­¥å±éšœ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dsb</span>(ishst);  <span style="color:#75715e">// ishstä¸­çš„ishè¡¨ç¤ºå…±äº«åŸŸæ˜¯å†…éƒ¨å…±äº«
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">__tlbi</span>(vmalle1is);  <span style="color:#75715e">// ä½¿æ‰€æœ‰æ ¸ä¸ŠåŒ¹é…å½“å‰VMIDã€é˜¶æ®µ1å’Œå¼‚å¸¸çº§åˆ«1çš„æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dsb</span>(ish);  <span style="color:#75715e">// ishè¡¨ç¤ºæ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤å¯¹æ‰€æœ‰æ ¸èµ·ä½œç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">isb</span>();  <span style="color:#75715e">// æŒ‡ä»¤åŒæ­¥å±éšœ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®å±•å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_tlb_all</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// dsbç¡®ä¿å±éšœå‰é¢çš„å­˜å‚¨æŒ‡ä»¤æ‰§è¡Œå®Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ishstä¸­çš„ishè¡¨ç¤ºå…±äº«åŸŸæ˜¯å†…éƒ¨å…±äº«
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// stè¡¨ç¤ºå­˜å‚¨ï¼ˆstoreï¼‰ï¼Œishstè¡¨ç¤ºæ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤å¯¹æ‰€æœ‰æ ¸çš„å­˜å‚¨æŒ‡ä»¤èµ·ä½œç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;dsb ishst&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä½¿æ‰€æœ‰æ ¸ä¸ŠåŒ¹é…å½“å‰VMIDã€é˜¶æ®µ1å’Œå¼‚å¸¸çº§åˆ«1çš„æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">asm</span> (<span style="color:#e6db74">&#34;tlbi vmalle1is&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç¡®ä¿å‰é¢çš„TLBå¤±æ•ˆæŒ‡ä»¤æ‰§è¡Œå®Œã€‚ishè¡¨ç¤ºæ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤å¯¹æ‰€æœ‰æ ¸èµ·ä½œç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;dsb ish&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// isbæ˜¯æŒ‡ä»¤åŒæ­¥å±éšœ,å†²åˆ·å¤„ç†å™¨çš„æµæ°´çº¿ï¼Œé‡æ–°è¯»å–å±éšœæŒ‡ä»¤åé¢çš„æ‰€æœ‰æŒ‡ä»¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;isb&#34;</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ARM64å†…æ ¸å®ç°äº†å‡½æ•°local_flush_tlb_allï¼Œç”¨æ¥ä½¿å½“å‰æ ¸çš„æ‰€æœ‰TLBè¡¨é¡¹å¤±æ•ˆ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/tlbflush.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">local_flush_tlb_all</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">dsb</span>(nshst);
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">__tlbi</span>(vmalle1);  <span style="color:#75715e">// ä»…ä»…ä½¿å½“å‰æ ¸çš„TLBè¡¨é¡¹å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#a6e22e">dsb</span>(nsh);  <span style="color:#75715e">// nshæ˜¯éå…±äº«,æ•°æ®åŒæ­¥å±éšœæŒ‡ä»¤ä»…ä»…åœ¨å½“å‰æ ¸èµ·ä½œç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#a6e22e">isb</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3123åœ°å€ç©ºé—´æ ‡è¯†ç¬¦">3.12.3ã€€åœ°å€ç©ºé—´æ ‡è¯†ç¬¦<a hidden class="anchor" aria-hidden="true" href="#3123åœ°å€ç©ºé—´æ ‡è¯†ç¬¦">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨çš„é¡µè¡¨ç¼“å­˜ä½¿ç”¨éå…¨å±€(not globalï¼ŒnG)ä½åŒºåˆ†å†…æ ¸å’Œè¿›ç¨‹çš„é¡µè¡¨é¡¹(nGä½ä¸º0è¡¨ç¤ºå†…æ ¸çš„é¡µè¡¨é¡¹)ï¼Œä½¿ç”¨åœ°å€ç©ºé—´æ ‡è¯†ç¬¦(Address Space Identifierï¼ŒASID)åŒºåˆ†ä¸åŒè¿›ç¨‹çš„é¡µè¡¨é¡¹   <br>
â€‚ARM64å¤„ç†å™¨çš„ASIDé•¿åº¦8ä½æˆ–è€…16ä½ï¼Œå¯„å­˜å™¨ID_AA64MMFR0_EL1æ®µASIDBitså­˜æ”¾å¤„ç†å™¨æ”¯æŒçš„ASIDé•¿åº¦ã€‚16ä½ASIDä½¿ç”¨å¯„å­˜å™¨TCR_EL1çš„AS(ASID Size)ä½æ§åˆ¶å®é™…ä½¿ç”¨çš„ASIDé•¿åº¦ï¼ŒAS 0ä¸º8ä½ASIDï¼ŒAS 1ä¸º16ä½ASID   <br>
â€‚å¯„å­˜å™¨TCR_EL1çš„A1ä½å†³å®šä½¿ç”¨å“ªä¸ªå¯„å­˜å™¨å­˜æ”¾å½“å‰è¿›ç¨‹çš„ASID,å¯„å­˜å™¨TTBR0_EL1 ç”¨æˆ·0æˆ–TTBR1_EL1å†…æ ¸ï¼Ÿå­˜æ”¾å½“å‰è¿›ç¨‹ASID      <br>
â€‚å†…å­˜æè¿°ç¬¦çš„æˆå‘˜contextå­˜æ”¾æ¶æ„ç‰¹å®šçš„å†…å­˜ç®¡ç†ä¸Šä¸‹æ–‡ï¼Œæ•°æ®ç±»å‹æ˜¯ç»“æ„ä½“mm_context_tï¼ŒARM64æ¶æ„å®šä¹‰çš„ç»“æ„ä½“     <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/mmu.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">atomic64_t</span>   id;  <span style="color:#75715e">// æˆå‘˜idå­˜æ”¾å†…æ ¸ç»™è¿›ç¨‹åˆ†é…çš„è½¯ä»¶ASID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">mm_context_t</span>;
</span></span></code></pre></div><p>â€‚å…¨å±€å˜é‡asid_bitsä¿å­˜ASIDé•¿åº¦ï¼Œå…¨å±€å˜é‡asid_generationçš„é«˜56ä½ä¿å­˜å…¨å±€ASIDç‰ˆæœ¬å·ï¼Œä½å›¾asid_mapè®°å½•å“ªäº›ASIDè¢«åˆ†é…     <br>
â€‚å½“å…¨å±€ASIDç‰ˆæœ¬å·åŠ 1æ—¶ï¼Œæ¯ä¸ªå¤„ç†å™¨éœ€è¦æ¸…ç©ºé¡µè¡¨ç¼“å­˜ï¼Œä½å›¾tlb_flush_pendingä¿å­˜éœ€è¦æ¸…ç©ºé¡µè¡¨ç¼“å­˜çš„å¤„ç†å™¨é›†åˆ       <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/context.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> u32 asid_bits;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">atomic64_t</span> asid_generation;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#f92672">*</span>asid_map;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">DEFINE_PER_CPU</span>(<span style="color:#66d9ef">atomic64_t</span>, active_asids);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">DEFINE_PER_CPU</span>(u64, reserved_asids);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">cpumask_t</span> tlb_flush_pending;
</span></span></code></pre></div><p>â€‚è¿›ç¨‹è¢«è°ƒåº¦æ—¶ï¼Œå‡½æ•°check_and_switch_contextè´Ÿè´£æ£€æŸ¥æ˜¯å¦éœ€è¦ç»™è¿›ç¨‹é‡æ–°åˆ†é…ASID     <br></p>
<blockquote>
<p>__schedule() -&gt; context_switch() -&gt; switch_mm_irqs_off() -&gt; switch_mm() -&gt; check_and_switch_context()</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/context.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">check_and_switch_context</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags;
</span></span><span style="display:flex;"><span>	u64 asid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic64_read</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>context.id);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>((asid <span style="color:#f92672">^</span> <span style="color:#a6e22e">atomic64_read</span>(<span style="color:#f92672">&amp;</span>asid_generation)) <span style="color:#f92672">&gt;&gt;</span> asid_bits)
</span></span><span style="display:flex;"><span>		<span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">atomic64_xchg_relaxed</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">per_cpu</span>(active_asids, cpu), asid))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> switch_mm_fastpath;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">raw_spin_lock_irqsave</span>(<span style="color:#f92672">&amp;</span>cpu_asid_lock, flags);
</span></span><span style="display:flex;"><span>	asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic64_read</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>context.id);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ((asid <span style="color:#f92672">^</span> <span style="color:#a6e22e">atomic64_read</span>(<span style="color:#f92672">&amp;</span>asid_generation)) <span style="color:#f92672">&gt;&gt;</span> asid_bits) {
</span></span><span style="display:flex;"><span>		asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">new_context</span>(mm, cpu);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">atomic64_set</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>context.id, asid);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">cpumask_test_and_clear_cpu</span>(cpu, <span style="color:#f92672">&amp;</span>tlb_flush_pending))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">local_flush_tlb_all</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">atomic64_set</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">per_cpu</span>(active_asids, cpu), asid);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">raw_spin_unlock_irqrestore</span>(<span style="color:#f92672">&amp;</span>cpu_asid_lock, flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	switch_mm_fastpath:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">system_uses_ttbr0_pan</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cpu_switch_mm</span>(mm<span style="color:#f92672">-&gt;</span>pgd, mm);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°new_contextè´Ÿè´£åˆ†é…ASID</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/context.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> u64 <span style="color:#a6e22e">new_context</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">static</span> u32 cur_idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	u64 asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic64_read</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>context.id);
</span></span><span style="display:flex;"><span>	u64 generation <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic64_read</span>(<span style="color:#f92672">&amp;</span>asid_generation);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (asid <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>			u64 newasid <span style="color:#f92672">=</span> generation <span style="color:#f92672">|</span> (asid <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>ASID_MASK);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">check_update_reserved_asid</span>(asid, newasid))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> newasid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		asid <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>ASID_MASK;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">__test_and_set_bit</span>(asid, asid_map))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> newasid;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">find_next_zero_bit</span>(asid_map, NUM_USER_ASIDS, cur_idx);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (asid <span style="color:#f92672">!=</span> NUM_USER_ASIDS)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> set_asid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	generation <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic64_add_return_relaxed</span>(ASID_FIRST_VERSION,
</span></span><span style="display:flex;"><span>							<span style="color:#f92672">&amp;</span>asid_generation);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">flush_context</span>(cpu);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">find_next_zero_bit</span>(asid_map, NUM_USER_ASIDS, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	set_asid:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__set_bit</span>(asid, asid_map);
</span></span><span style="display:flex;"><span>	cur_idx <span style="color:#f92672">=</span> asid;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> asid <span style="color:#f92672">|</span> generation;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°flush_contextè´Ÿè´£é‡æ–°åˆå§‹åŒ–ASIDåˆ†é…çŠ¶æ€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/context.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush_context</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cpu)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>	u64 asid;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">bitmap_clear</span>(asid_map, <span style="color:#ae81ff">0</span>, NUM_USER_ASIDS);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">smp_wmb</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">for_each_possible_cpu</span>(i) {
</span></span><span style="display:flex;"><span>		asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">atomic64_xchg_relaxed</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">per_cpu</span>(active_asids, i), <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (asid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>			asid <span style="color:#f92672">=</span> <span style="color:#a6e22e">per_cpu</span>(reserved_asids, i);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">__set_bit</span>(asid <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>ASID_MASK, asid_map);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">per_cpu</span>(reserved_asids, i) <span style="color:#f92672">=</span> asid;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cpumask_setall</span>(<span style="color:#f92672">&amp;</span>tlb_flush_pending);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3124è™šæ‹Ÿæœºæ ‡è¯†ç¬¦">3.12.4ã€€<strong>è™šæ‹Ÿæœºæ ‡è¯†ç¬¦</strong><a hidden class="anchor" aria-hidden="true" href="#3124è™šæ‹Ÿæœºæ ‡è¯†ç¬¦">#</a></h3>
<p>â€‚è™šæ‹Ÿæœºé‡Œé¢è¿è¡Œçš„å®¢æˆ·æ“ä½œç³»ç»Ÿçš„è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€åˆ†ä¸¤ä¸ªé˜¶æ®µï¼š  <br>
â€ƒç¬¬ 1 é˜¶æ®µæŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆä¸­é—´ç‰©ç†åœ°å€  <br>
â€ƒç¬¬ 2 é˜¶æ®µæŠŠä¸­é—´ç‰©ç†åœ°å€è½¬æ¢æˆç‰©ç†åœ°å€  <br>
â€‚ç¬¬ 1 é˜¶æ®µè½¬æ¢ç”±å®¢æˆ·æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ§åˆ¶ï¼Œå’Œéè™šæ‹ŸåŒ–çš„è½¬æ¢è¿‡ç¨‹ç›¸åŒã€‚ç¬¬ 2 é˜¶æ®µè½¬æ¢ç”±è™šæ‹Ÿæœºç›‘æ§å™¨æ§åˆ¶ï¼Œè™šæ‹Ÿæœºç›‘æ§å™¨ä¸ºæ¯ä¸ªè™šæ‹Ÿæœºç»´æŠ¤ä¸€ä¸ªè½¬æ¢è¡¨ï¼Œåˆ†é…ä¸€ä¸ªè™šæ‹Ÿæœºæ ‡è¯†ç¬¦(Virtual Machine Identifierï¼ŒVMID)ï¼Œå¯„å­˜å™¨VTTBR_EL2(è™šæ‹ŸåŒ–è½¬æ¢è¡¨åŸºå‡†å¯„å­˜å™¨ï¼ŒVirtualization Translation Table Base Register)å­˜æ”¾å½“å‰è™šæ‹Ÿæœºçš„é˜¶æ®µ2è½¬æ¢è¡¨çš„ç‰©ç†åœ°å€</p>
<h2 id="313å·¨å‹é¡µ">3.13ã€€å·¨å‹é¡µ<a hidden class="anchor" aria-hidden="true" href="#313å·¨å‹é¡µ">#</a></h2>
<p>â€‚ä½¿ç”¨é•¿åº¦ä¸º2MBç”šè‡³æ›´å¤§çš„å·¨å‹é¡µï¼Œå¯ä»¥å¤§å¹…å‡å°‘TLBæœªå‘½ä¸­å’Œç¼ºé¡µå¼‚å¸¸çš„æ•°é‡ï¼Œå¤§å¹…æé«˜åº”ç”¨ç¨‹åºçš„æ€§èƒ½   <br>
â€‚(1)ä½¿ç”¨hugetlbfsä¼ªæ–‡ä»¶ç³»ç»Ÿå®ç°å·¨å‹é¡µ   <br>
â€‚(2)é€æ˜å·¨å‹é¡µ    <br></p>
<h3 id="3131å¤„ç†å™¨å¯¹å·¨å‹é¡µçš„æ”¯æŒ">3.13.1ã€€å¤„ç†å™¨å¯¹å·¨å‹é¡µçš„æ”¯æŒ<a hidden class="anchor" aria-hidden="true" href="#3131å¤„ç†å™¨å¯¹å·¨å‹é¡µçš„æ”¯æŒ">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨æ”¯æŒå·¨å‹é¡µçš„æ–¹å¼æœ‰ä¸¤ç§  <br>
â€‚(1)é€šè¿‡å—æè¿°ç¬¦æ”¯æŒ  <br>
â€‚(2)é€šè¿‡é¡µ/å—æè¿°ç¬¦çš„è¿ç»­ä½æ”¯æŒ   <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221119224359.png" alt="20221119224359"  />
</p>
<center>é¡µé•¿åº¦ä¸º4KBæ—¶é€šè¿‡å—æè¿°ç¬¦æ”¯æŒå·¨å‹é¡µ</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221119224113.png" alt="20221119224113"  />
</p>
<center>é¡µé•¿åº¦ä¸º4KBæ—¶é€šè¿‡é¡µ/å—æè¿°ç¬¦çš„è¿ç»­ä½æ”¯æŒå·¨å‹é¡µ</center>
<h3 id="3132æ ‡å‡†å·¨å‹é¡µ">3.13.2ã€€æ ‡å‡†å·¨å‹é¡µ<a hidden class="anchor" aria-hidden="true" href="#3132æ ‡å‡†å·¨å‹é¡µ">#</a></h3>
<p>â€‚ç¼–è¯‘å†…æ ¸æ—¶éœ€è¦æ‰“å¼€é…ç½®å®CONFIG_HUGETLBFSå’ŒCONFIG_HUGETLB_PAGE  <br>
â€‚æ–‡ä»¶â€œ/proc/sys/vm/nr_hugepagesâ€æŒ‡å®šå·¨å‹é¡µæ± ä¸­æ°¸ä¹…å·¨å‹é¡µçš„æ•°é‡  <br></p>
<p>&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash; å¾…è¡¥å…… &mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&ndash;</p>
<h3 id="3133é€æ˜å·¨å‹é¡µ">3.13.3ã€€é€æ˜å·¨å‹é¡µ<a hidden class="anchor" aria-hidden="true" href="#3133é€æ˜å·¨å‹é¡µ">#</a></h3>
<p>â€‚(1)åˆ†é…é€æ˜å·¨å‹é¡µ   <br>
â€‚å‡½æ•°handle_mm_faultæ˜¯é¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ ¸å¿ƒå‡½æ•°ï¼Œå¦‚æœè§¦å‘å¼‚å¸¸çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸä½¿ç”¨æ™®é€šé¡µæˆ–é€æ˜å·¨å‹é¡µï¼ŒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°__handle_mm_fault
<img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221119224843.png" alt="20221119224843"  />
</p>
<center>é€æ˜å·¨å‹é¡µçš„é¡µé”™è¯¯å¼‚å¸¸å¤„ç†</center>
<p>â€‚å‡½æ•°create_huge_pmdè´Ÿè´£åˆ†é…é¡µä¸­é—´ç›®å½•çº§åˆ«çš„å·¨å‹é¡µ
<img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221119225521.png" alt="20221119225521"  />
</p>
<h2 id="314é¡µé”™è¯¯å¼‚å¸¸å¤„ç†">3.14ã€€é¡µé”™è¯¯å¼‚å¸¸å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#314é¡µé”™è¯¯å¼‚å¸¸å¤„ç†">#</a></h2>
<p>â€‚è™šæ‹Ÿé¡µæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µï¼Œæˆ–è€…æ²¡æœ‰è®¿é—®æƒé™ï¼Œå¤„ç†å™¨å°†ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸  <br>
â€‚ç¼ºé¡µå¼‚å¸¸,è™šæ‹Ÿé¡µæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µ   <br>
â€ƒ(1)è®¿é—®ç”¨æˆ·æ ˆçš„æ—¶å€™ï¼Œè¶…å‡ºäº†å½“å‰ç”¨æˆ·æ ˆçš„èŒƒå›´ï¼Œéœ€è¦æ‰©å¤§ç”¨æˆ·æ ˆ  <br>
â€‚(2)è¿›ç¨‹ç”³è¯·è™šæ‹Ÿå†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œé€šå¸¸æ²¡æœ‰åˆ†é…ç‰©ç†é¡µï¼Œè¿›ç¨‹ç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è§¦å‘é¡µé”™è¯¯å¼‚å¸¸  <br>
â€‚(3)å†…å­˜ä¸è¶³çš„æ—¶å€™ï¼Œå†…æ ¸æŠŠè¿›ç¨‹çš„åŒ¿åé¡µæ¢å‡ºåˆ°äº¤æ¢åŒº   <br>
â€‚(4)ä¸€ä¸ªæ–‡ä»¶é¡µè¢«æ˜ å°„åˆ°è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå†…å­˜ä¸è¶³çš„æ—¶å€™  <br>
â€‚(5)ç¨‹åºé”™è¯¯ï¼Œè®¿é—®æ²¡æœ‰åˆ†é…ç»™è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸ  <br></p>
<p>â€‚æ²¡æœ‰è®¿é—®æƒé™ï¼Œä¸¤ç§æƒ…å†µ  <br>
â€‚(1)å†™æ—¶å¤åˆ¶(Copy on Writeï¼ŒCoW)    é¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºæˆåŠŸåœ°æŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°ç‰©ç†é¡µ  <br>
â€‚(2)ç¨‹åºé”™è¯¯ï¼Œå‘é€æ®µè¿æ³•(SIGSEGV)ä¿¡å·ä»¥æ€æ­»è¿›ç¨‹  <br></p>
<h3 id="3141å¤„ç†å™¨æ¶æ„ç‰¹å®šéƒ¨åˆ†">3.14.1ã€€å¤„ç†å™¨æ¶æ„ç‰¹å®šéƒ¨åˆ†<a hidden class="anchor" aria-hidden="true" href="#3141å¤„ç†å™¨æ¶æ„ç‰¹å®šéƒ¨åˆ†">#</a></h3>
<h4 id="1ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸">1.ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#1ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸">#</a></h4>
<p>â€‚ARM64å¤„ç†å™¨åœ¨å–æŒ‡ä»¤æˆ–æ•°æ®ï¼Œéœ€æŠŠè™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ï¼Œåˆ†ä¸¤ç§æƒ…å†µ  <br>
â€‚(1)è™šæ‹Ÿåœ°å€çš„é«˜16ä½ä¸æ˜¯å…¨1æˆ–å…¨0ï¼Œæ˜¯éæ³•åœ°å€ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸   <br>
â€‚(2)è™šæ‹Ÿåœ°å€çš„é«˜16ä½æ˜¯å…¨1æˆ–å…¨0ï¼Œå†…å­˜ç®¡ç†å•å…ƒæ ¹æ®å…³é”®å­—{åœ°å€ç©ºé—´æ ‡è¯†ç¬¦ï¼Œè™šæ‹Ÿåœ°å€}æŸ¥æ‰¾TLB   <br></p>
<blockquote>
<p>å¯„å­˜å™¨TTBR1_EL1å­˜æ”¾å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€ï¼Œå¯„å­˜å™¨TTBR0_EL1å­˜æ”¾è¿›ç¨‹çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€  <br></p>
</blockquote>
<p>â€‚å‘½ä¸­äº†TLBè¡¨é¡¹ï¼Œä»TLBè¡¨é¡¹è¯»å–è®¿é—®æƒé™ï¼Œæ£€æŸ¥è®¿é—®æƒé™ï¼Œå¦‚æœæ²¡æœ‰è®¿é—®æƒé™ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸   <br>
â€‚æ²¡æœ‰å‘½ä¸­TLBè¡¨é¡¹ï¼Œå†…å­˜ç®¡ç†å•å…ƒå°†ä¼šæŸ¥è¯¢å†…å­˜ä¸­çš„é¡µè¡¨ï¼Œç§°ä¸ºè½¬æ¢è¡¨éå†ï¼ˆtranslation table walkï¼‰ï¼Œåˆ†ä¸¤ç§æƒ…å†µ   <br>
â€‚ï¼ˆ1ï¼‰è™šæ‹Ÿåœ°å€çš„é«˜16ä½å…¨éƒ¨æ˜¯1ï¼Œæ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€ï¼ŒæŸ¥è¯¢å†…æ ¸çš„é¡µè¡¨ï¼Œä»å¯„å­˜å™¨TTBR1_EL1å–å†…æ ¸çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€  <br>
â€‚ï¼ˆ2ï¼‰è™šæ‹Ÿåœ°å€çš„é«˜16ä½å…¨éƒ¨æ˜¯0ï¼Œç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼ŒæŸ¥è¯¢è¿›ç¨‹çš„é¡µè¡¨ï¼Œä»å¯„å­˜å™¨TTBR0_EL1å–è¿›ç¨‹çš„é¡µå…¨å±€ç›®å½•çš„ç‰©ç†åœ°å€  <br></p>
<h4 id="2å¤„ç†é¡µé”™è¯¯å¼‚å¸¸">2.å¤„ç†é¡µé”™è¯¯å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#2å¤„ç†é¡µé”™è¯¯å¼‚å¸¸">#</a></h4>
<p>â€‚ARM64æ¶æ„çš„å†…æ ¸å¼‚å¸¸å‘é‡è¡¨ï¼Œèµ·å§‹åœ°å€æ˜¯vectorsï¼ˆæºæ–‡ä»¶arch/arm64/ kernel/entry.Sï¼‰ï¼Œæ¯ä¸ªå¼‚å¸¸å‘é‡çš„é•¿åº¦æ˜¯128å­—èŠ‚ï¼Œåœ¨Linuxå†…æ ¸ä¸­æ¯ä¸ªå¼‚å¸¸å‘é‡åªæœ‰ä¸€æ¡æŒ‡ä»¤ï¼šè·³è½¬åˆ°å¯¹åº”çš„å¤„ç†ç¨‹åºã€‚å¼‚å¸¸å‘é‡è¡¨çš„è™šæ‹Ÿåœ°å€å­˜æ”¾åœ¨å¼‚å¸¸çº§åˆ«1çš„å‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨(Vector Base Address Register for Exception Level 1ï¼ŒVBAR_EL1)ä¸­</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221119231907.png" alt="20221119231907"  />
</p>
<center>ARM64å¤„ç†å™¨å¤„ç†é¡µé”™è¯¯å¼‚å¸¸</center>
<p>â€‚(1)å¼‚å¸¸ç±»å‹æ˜¯å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå¼‚å¸¸å‘é‡çš„åç§»æ˜¯0x200ï¼Œå¼‚å¸¸å‘é‡è·³è½¬åˆ°å‡½æ•°el1_sync  <br>
â€‚(2)å¼‚å¸¸ç±»å‹æ˜¯64ä½ç”¨æˆ·ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå¼‚å¸¸å‘é‡çš„åç§»æ˜¯0x400ï¼Œå¼‚å¸¸å‘é‡è·³è½¬åˆ°å‡½æ•°el0_sync <br>
â€‚(3)å¼‚å¸¸ç±»å‹æ˜¯32ä½ç”¨æˆ·ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå¼‚å¸¸å‘é‡çš„åç§»æ˜¯0x600ï¼Œå¼‚å¸¸å‘é‡è·³è½¬åˆ°å‡½æ•°el0_sync_compat   <br></p>
<p>â€‚å‡½æ•°el0_syncæ ¹æ®å¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨çš„å¼‚å¸¸ç±»åˆ«å­—æ®µå¤„ç†  <br>
â€‚(1)å¼‚å¸¸ç±»åˆ«æ˜¯å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„æ•°æ®ä¸­æ­¢(data abort)ï¼Œå³åœ¨å¼‚å¸¸çº§åˆ«0è®¿é—®æ•°æ®æ—¶ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_da   <br>
â€‚(2)å¼‚å¸¸ç±»åˆ«æ˜¯å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„æŒ‡ä»¤ä¸­æ­¢(instruction abort)ï¼Œå³åœ¨å¼‚å¸¸çº§åˆ«0å–æŒ‡ä»¤æ—¶ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_ia  <br>
â€‚ARM64å¤„ç†å™¨ï¼Œå¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨(ESR_EL1ï¼ŒException Syndrome Register for Exception Level 1)ç”¨æ¥å­˜æ”¾å¼‚å¸¸çš„ç—‡çŠ¶ä¿¡æ¯   <br>
â€ƒECï¼šå¼‚å¸¸ç±»åˆ«(Exception Class)ï¼ŒæŒ‡ç¤ºå¼•èµ·å¼‚å¸¸çš„åŸå›    <br>
â€ƒISSï¼šæŒ‡ä»¤ç‰¹å®šç—‡çŠ¶  <br></p>
<p>â€‚<strong>ï¼ˆ1ï¼‰do_mem_abortå‡½æ•°</strong>
â€ƒdo_mem_abortå‡½æ•°æ ¹æ®å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨çš„æŒ‡ä»¤ç‰¹å®šç—‡çŠ¶å­—æ®µçš„æŒ‡ä»¤é”™è¯¯çŠ¶æ€ç ï¼Œè°ƒç”¨æ•°ç»„fault_infoä¸­å¤„ç†å‡½æ•°   <Br>
â€ƒæŒ‡ä»¤é”™è¯¯çŠ¶æ€ç å’Œå¤„ç†å‡½æ•°çš„å¯¹åº”å…³ç³»</p>
<table>
	<tr>
	    <th>æŒ‡ä»¤é”™è¯¯çŠ¶æ€ç </th>
	    <th>è¯´ã€€ã€€æ˜</th>
	    <th>å¤„ ç† å‡½ æ•°</th>
	</tr >
	<tr >
	    <td>4</td>
	    <td>0çº§è½¬æ¢é”™è¯¯</td>
	    <td>do_translation_fault</td>
	</tr>
	<tr >
	    <td>5</td>
	    <td>1çº§è½¬æ¢é”™è¯¯</td>
	    <td>do_translation_fault</td>
	</tr>
	<tr >
	    <td>6</td>
	    <td>2çº§è½¬æ¢é”™è¯¯</td>
	    <td>do_translation_fault</td>
	</tr>
	<tr >
	    <td>7</td>
	    <td>3çº§è½¬æ¢é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>9</td>
	    <td>1çº§è®¿é—®æ ‡å¿—é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>10</td>
	    <td>2çº§è®¿é—®æ ‡å¿—é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>11</td>
	    <td>3çº§è®¿é—®æ ‡å¿—é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>13</td>
	    <td>1çº§æƒé™é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>14</td>
	    <td>2çº§æƒé™é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>15</td>
	    <td>3çº§æƒé™é”™è¯¯</td>
	    <td>do_page_fault</td>
	</tr>
	<tr >
	    <td>33</td>
	    <td>å¯¹é½é”™è¯¯</td>
	    <td>do_alignment_fault</td>
	</tr>
	<tr >
	    <td>å…¶ä»–</td>
	    <td>å…¶ä»–é”™è¯¯</td>
	    <td>do_bad</td>
	</tr>
</table>
<p>â€‚<strong>ï¼ˆ2ï¼‰do_translation_faultå‡½æ•°</strong>
â€‚do_translation_faultå¤„ç†åœ¨0çº§ã€1çº§æˆ–2çº§è½¬æ¢è¡¨ä¸­åŒ¹é…çš„è¡¨é¡¹æ˜¯æ— æ•ˆæè¿°ç¬¦</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221121233805.png" alt="20221121233805"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// addrè§¦å‘å¼‚å¸¸çš„è™šæ‹Ÿåœ°å€ esrå¼‚å¸¸ç—‡çŠ¶çŠ¶æ€å¯„å­˜å™¨å€¼ regsæŒ‡å‘å†…æ ¸æ ˆä¸­ä¿å­˜çš„è¢«æ‰“æ–­çš„è¿›ç¨‹çš„å¯„å­˜å™¨é›†åˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __kprobes <span style="color:#a6e22e">do_translation_fault</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> esr, <span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (addr <span style="color:#f92672">&lt;</span> TASK_SIZE)  
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">do_page_fault</span>(addr, esr, regs); <span style="color:#75715e">// è™šæ‹Ÿåœ°å€æ˜¯ç”¨æˆ·è™šæ‹Ÿåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// å¼‚å¸¸è™šæ‹Ÿåœ°å€æ˜¯å†…æ ¸è™šæ‹Ÿåœ°å€æˆ–ä¸è§„èŒƒåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">do_bad_area</span>(addr, esr, regs); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚do_bad_area</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">do_bad_area</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> esr, <span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk <span style="color:#f92672">=</span> current;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>active_mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> fault_info <span style="color:#f92672">*</span>inf;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">user_mode</span>(regs)) {
</span></span><span style="display:flex;"><span>		inf <span style="color:#f92672">=</span> <span style="color:#a6e22e">esr_to_fault_info</span>(esr);  <span style="color:#75715e">// å¼‚å¸¸æ˜¯åœ¨ç”¨æˆ·æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">__do_user_fault</span>(tsk, addr, esr, inf<span style="color:#f92672">-&gt;</span>sig, inf<span style="color:#f92672">-&gt;</span>code, regs);  <span style="color:#75715e">// å‘é€ä¿¡å·ä»¥æ€æ­»è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">__do_kernel_fault</span>(mm, addr, esr, regs);   <span style="color:#75715e">// å¼‚å¸¸æ˜¯åœ¨å†…æ ¸æ¨¡å¼ä¸‹ç”Ÿæˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>â€‚<strong>ï¼ˆ3ï¼‰å‡½æ•°do_page_fault</strong></p>
<center>å‡½æ•°do_page_faultçš„æ‰§è¡Œæµ</center>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221121234626.png" alt="20221121234626"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/fault.c   linux4.x
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __kprobes <span style="color:#a6e22e">do_page_fault</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> esr,
</span></span><span style="display:flex;"><span>                   <span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> fault, sig, code;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_flags <span style="color:#f92672">=</span> VM_READ <span style="color:#f92672">|</span> VM_WRITE;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> mm_flags <span style="color:#f92672">=</span> FAULT_FLAG_ALLOW_RETRY <span style="color:#f92672">|</span> FAULT_FLAG_KILLABLE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	tsk <span style="color:#f92672">=</span> current;
</span></span><span style="display:flex;"><span>	mm  <span style="color:#f92672">=</span> tsk<span style="color:#f92672">-&gt;</span>mm;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç¦æ­¢æ‰§è¡Œé¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œæˆ–è€…å¤„äºåŸå­ä¸Šä¸‹æ–‡ï¼Œæˆ–è€…å½“å‰è¿›ç¨‹æ˜¯å†…æ ¸çº¿ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">faulthandler_disabled</span>() <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>mm)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> no_context;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">user_mode</span>(regs))
</span></span><span style="display:flex;"><span>		mm_flags <span style="color:#f92672">|=</span> FAULT_FLAG_USER;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_el0_instruction_abort</span>(esr)) {
</span></span><span style="display:flex;"><span>		vm_flags <span style="color:#f92672">=</span> VM_EXEC;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> ((esr <span style="color:#f92672">&amp;</span> ESR_ELx_WNR) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(esr <span style="color:#f92672">&amp;</span> ESR_ELx_CM)) {
</span></span><span style="display:flex;"><span>		vm_flags <span style="color:#f92672">=</span> VM_WRITE;
</span></span><span style="display:flex;"><span>		mm_flags <span style="color:#f92672">|=</span> FAULT_FLAG_WRITE;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (addr <span style="color:#f92672">&lt;</span> USER_DS <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">is_permission_fault</span>(esr, regs, addr)) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* å¦‚æœä»å¼‚å¸¸çº§åˆ«0è¿›å…¥ï¼Œregs-&gt;orig_addr_limitå¯èƒ½æ˜¯0 */</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (regs<span style="color:#f92672">-&gt;</span>orig_addr_limit <span style="color:#f92672">==</span> KERNEL_DS)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;Accessing user space memory with fs=KERNEL_DS&#34;</span>, regs, esr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_el1_instruction_abort</span>(esr))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;Attempting to execute userspace memory&#34;</span>, regs, esr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">search_exception_tables</span>(regs<span style="color:#f92672">-&gt;</span>pc))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;Accessing user space memory outside uaccess.h routines&#34;</span>, regs, esr);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">down_read_trylock</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>mmap_sem)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">user_mode</span>(regs) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">search_exception_tables</span>(regs<span style="color:#f92672">-&gt;</span>pc))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> no_context;
</span></span><span style="display:flex;"><span>	retry:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">down_read</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>mmap_sem);
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">might_sleep</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	fault <span style="color:#f92672">=</span> <span style="color:#a6e22e">__do_page_fault</span>(mm, addr, mm_flags, vm_flags, tsk);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ((fault <span style="color:#f92672">&amp;</span> VM_FAULT_RETRY) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">fatal_signal_pending</span>(current))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (mm_flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_ALLOW_RETRY) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (fault <span style="color:#f92672">&amp;</span> VM_FAULT_MAJOR) {
</span></span><span style="display:flex;"><span>			tsk<span style="color:#f92672">-&gt;</span>maj_flt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			tsk<span style="color:#f92672">-&gt;</span>min_flt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (fault <span style="color:#f92672">&amp;</span> VM_FAULT_RETRY) {
</span></span><span style="display:flex;"><span>			mm_flags <span style="color:#f92672">&amp;=</span> <span style="color:#f92672">~</span>FAULT_FLAG_ALLOW_RETRY;
</span></span><span style="display:flex;"><span>			mm_flags <span style="color:#f92672">|=</span> FAULT_FLAG_TRIED;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> retry;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">up_read</span>(<span style="color:#f92672">&amp;</span>mm<span style="color:#f92672">-&gt;</span>mmap_sem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(<span style="color:#f92672">!</span>(fault <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_BADMAP <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>				VM_FAULT_BADACCESS))))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">user_mode</span>(regs))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> no_context;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (fault <span style="color:#f92672">&amp;</span> VM_FAULT_OOM) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">pagefault_out_of_memory</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (fault <span style="color:#f92672">&amp;</span> VM_FAULT_SIGBUS) {
</span></span><span style="display:flex;"><span>		sig <span style="color:#f92672">=</span> SIGBUS;
</span></span><span style="display:flex;"><span>		code <span style="color:#f92672">=</span> BUS_ADRERR;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		sig <span style="color:#f92672">=</span> SIGSEGV;
</span></span><span style="display:flex;"><span>		code <span style="color:#f92672">=</span> fault <span style="color:#f92672">==</span> VM_FAULT_BADACCESS <span style="color:#f92672">?</span>
</span></span><span style="display:flex;"><span>			SEGV_ACCERR : SEGV_MAPERR;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__do_user_fault</span>(tsk, addr, esr, sig, code, regs);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	no_context:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__do_kernel_fault</span>(mm, addr, esr, regs);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚åŸå­ä¸Šä¸‹æ–‡ï¼šæ‰§è¡Œç¡¬ä¸­æ–­ã€æ‰§è¡Œè½¯ä¸­æ–­ã€ç¦æ­¢ç¡¬ä¸­æ–­ã€ç¦æ­¢è½¯ä¸­æ–­å’Œç¦æ­¢å†…æ ¸æŠ¢å è¿™äº”ç§æƒ…å†µä¸å…è®¸ç¡çœ ï¼Œç§°ä¸ºåŸå­ä¸Šä¸‹æ–‡  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122000428.png" alt="20221122000428"  />
</p>
<center>å‡½æ•°__do_page_faultçš„æ‰§è¡Œæµç¨‹</center>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">__do_page_fault</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> mm_flags, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> vm_flags,
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>tsk)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> fault;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vma <span style="color:#f92672">=</span> <span style="color:#a6e22e">find_vma</span>(mm, addr);
</span></span><span style="display:flex;"><span>	fault <span style="color:#f92672">=</span> VM_FAULT_BADMAP;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#f92672">!</span>vma))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(vma<span style="color:#f92672">-&gt;</span>vm_start <span style="color:#f92672">&gt;</span> addr))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> check_stack;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	good_area:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> vm_flags)) {
</span></span><span style="display:flex;"><span>		fault <span style="color:#f92672">=</span> VM_FAULT_BADACCESS;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> out;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handle_mm_fault</span>(vma, addr <span style="color:#f92672">&amp;</span> PAGE_MASK, mm_flags);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	check_stack:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> VM_GROWSDOWN <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">expand_stack</span>(vma, addr))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> good_area;
</span></span><span style="display:flex;"><span>	out:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> fault;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3142ç”¨æˆ·ç©ºé—´é¡µé”™è¯¯å¼‚å¸¸">3.14.2ã€€ç”¨æˆ·ç©ºé—´é¡µé”™è¯¯å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#3142ç”¨æˆ·ç©ºé—´é¡µé”™è¯¯å¼‚å¸¸">#</a></h3>
<p>â€‚å‡½æ•°handle_mm_faultå¤„ç†ç”¨æˆ·ç©ºé—´çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œä¸¤ç§æƒ…å†µï¼š  <br>
â€ƒ(1)è¿›ç¨‹åœ¨ç”¨æˆ·æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸   <br>
â€ƒ(2)è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ã€‚è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ¨¡å¼ï¼Œç³»ç»Ÿè°ƒç”¨ä¼ å…¥ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œè¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒº    <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_mm_fault</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> address,
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">is_vm_hugetlb_page</span>(vma))) 
</span></span><span style="display:flex;"><span>         ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">hugetlb_fault</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, vma, address, flags);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>         ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">__handle_mm_fault</span>(vma, address, flags);
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122001007.png" alt="20221122001007"  />
</p>
<p>â€‚å·¨å‹é¡µå‡½æ•°hugetlb_faultï¼Œæ™®é€šé¡µ__handle_mm_fault</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">__handle_mm_fault</span>(<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> address,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_fault vmf <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>		.vma <span style="color:#f92672">=</span> vma,
</span></span><span style="display:flex;"><span>		.address <span style="color:#f92672">=</span> address <span style="color:#f92672">&amp;</span> PAGE_MASK,
</span></span><span style="display:flex;"><span>		.flags <span style="color:#f92672">=</span> flags,
</span></span><span style="display:flex;"><span>		.pgoff <span style="color:#f92672">=</span> <span style="color:#a6e22e">linear_page_index</span>(vma, address),
</span></span><span style="display:flex;"><span>		.gfp_mask <span style="color:#f92672">=</span> <span style="color:#a6e22e">__get_fault_gfp_mask</span>(vma),
</span></span><span style="display:flex;"><span>	};
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm <span style="color:#f92672">=</span> vma<span style="color:#f92672">-&gt;</span>vm_mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pgd_t</span> <span style="color:#f92672">*</span>pgd;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">p4d_t</span> <span style="color:#f92672">*</span>p4d;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨é¡µå…¨å±€ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pgd <span style="color:#f92672">=</span> <span style="color:#a6e22e">pgd_offset</span>(mm, address);
</span></span><span style="display:flex;"><span>	p4d <span style="color:#f92672">=</span> <span style="color:#a6e22e">p4d_alloc</span>(mm, pgd, address);  <span style="color:#75715e">// åœ¨é¡µå››çº§ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>p4d)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨é¡µä¸Šå±‚ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vmf.pud <span style="color:#f92672">=</span> <span style="color:#a6e22e">pud_alloc</span>(mm, p4d, address);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>vmf.pud)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨é¡µä¸­é—´ç›®å½•ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vmf.pmd <span style="color:#f92672">=</span> <span style="color:#a6e22e">pmd_alloc</span>(mm, vmf.pud, address);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>vmf.pmd)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åˆ°è¾¾ç›´æ¥é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">handle_pte_fault</span>(<span style="color:#f92672">&amp;</span>vmf);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122001438.png" alt="20221122001438"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">handle_pte_fault</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pte_t</span> entry;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç›´æ¥é¡µè¡¨ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€å¯¹åº”çš„è¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">pmd_none</span>(<span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pmd))) {
</span></span><span style="display:flex;"><span>		vmf<span style="color:#f92672">-&gt;</span>pte <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		vmf<span style="color:#f92672">-&gt;</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_offset_map</span>(vmf<span style="color:#f92672">-&gt;</span>pmd, vmf<span style="color:#f92672">-&gt;</span>address);
</span></span><span style="display:flex;"><span>		vmf<span style="color:#f92672">-&gt;</span>orig_pte <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pte;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">barrier</span>();
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pte_none</span>(vmf<span style="color:#f92672">-&gt;</span>orig_pte)) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">pte_unmap</span>(vmf<span style="color:#f92672">-&gt;</span>pte);
</span></span><span style="display:flex;"><span>			vmf<span style="color:#f92672">-&gt;</span>pte <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é¡µè¡¨é¡¹ä¸å­˜åœ¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>vmf<span style="color:#f92672">-&gt;</span>pte) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">vma_is_anonymous</span>(vmf<span style="color:#f92672">-&gt;</span>vma))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">do_anonymous_page</span>(vmf); 
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">do_fault</span>(vmf);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é¡µè¡¨é¡¹å­˜åœ¨ï¼Œä½†æ˜¯é¡µä¸åœ¨ç‰©ç†å†…å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">pte_present</span>(vmf<span style="color:#f92672">-&gt;</span>orig_pte))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">do_swap_page</span>(vmf);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	vmf<span style="color:#f92672">-&gt;</span>ptl <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_lockptr</span>(vmf<span style="color:#f92672">-&gt;</span>vma<span style="color:#f92672">-&gt;</span>vm_mm, vmf<span style="color:#f92672">-&gt;</span>pmd);  <span style="color:#75715e">// è·å–é¡µè¡¨é”çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">spin_lock</span>(vmf<span style="color:#f92672">-&gt;</span>ptl);  <span style="color:#75715e">// é”ä½é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	entry <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>orig_pte;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">pte_same</span>(<span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pte, entry)))  <span style="color:#75715e">// é‡æ–°è¯»å–é¡µè¡¨é¡¹çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">goto</span> unlock;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vmf<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_WRITE) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">pte_write</span>(entry))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">do_wp_page</span>(vmf);   <span style="color:#75715e">// æ‰§è¡Œå†™æ—¶å¤åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_mkdirty</span>(entry); <span style="color:#75715e">// é¡µè¡¨é¡¹æœ‰å†™æƒé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>	entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_mkyoung</span>(entry);  <span style="color:#75715e">// è®¾ç½®é¡µè¡¨é¡¹çš„è®¿é—®æ ‡å¿—ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ptep_set_access_flags</span>(vmf<span style="color:#f92672">-&gt;</span>vma, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte, entry,
</span></span><span style="display:flex;"><span>				vmf<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_WRITE)) { <span style="color:#75715e">// è®¾ç½®é¡µè¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">update_mmu_cache</span>(vmf<span style="color:#f92672">-&gt;</span>vma, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte); <span style="color:#75715e">// æ›´æ–°å¤„ç†å™¨çš„å†…å­˜ç®¡ç†å•å…ƒçš„é¡µè¡¨ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (vmf<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_WRITE)
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">flush_tlb_fix_spurious_fault</span>(vmf<span style="color:#f92672">-&gt;</span>vma, vmf<span style="color:#f92672">-&gt;</span>address);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	unlock: <span style="color:#75715e">// é‡Šæ”¾é¡µè¡¨çš„é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pte_unmap_unlock</span>(vmf<span style="color:#f92672">-&gt;</span>pte, vmf<span style="color:#f92672">-&gt;</span>ptl);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="1åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸">1ï¼åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#1åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸">#</a></h4>
<p>â€‚å‡½æ•°do_anonymous_pageå¤„ç†ç§æœ‰åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122002143.png" alt="20221122002143"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">do_anonymous_page</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>page;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pte_t</span> entry;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* æ²¡æœ‰â€œ-&gt;vm_opsâ€çš„æ–‡ä»¶æ˜ å°„ï¼Ÿ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> VM_SHARED)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_SIGBUS;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç›´æ¥é¡µè¡¨ä¸å­˜åœ¨ï¼Œåˆ†é…é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">pte_alloc</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, vmf<span style="color:#f92672">-&gt;</span>pmd, vmf<span style="color:#f92672">-&gt;</span>address))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* å¦‚æœæ˜¯è¯»æ“ä½œï¼Œæ˜ å°„åˆ°é›¶é¡µ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(vmf<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_WRITE) <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">!</span><span style="color:#a6e22e">mm_forbids_zeropage</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm)) {
</span></span><span style="display:flex;"><span>		entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_mkspecial</span>(<span style="color:#a6e22e">pfn_pte</span>(<span style="color:#a6e22e">my_zero_pfn</span>(vmf<span style="color:#f92672">-&gt;</span>address),
</span></span><span style="display:flex;"><span>							vma<span style="color:#f92672">-&gt;</span>vm_page_prot));
</span></span><span style="display:flex;"><span>		vmf<span style="color:#f92672">-&gt;</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_offset_map_lock</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, vmf<span style="color:#f92672">-&gt;</span>pmd,
</span></span><span style="display:flex;"><span>				vmf<span style="color:#f92672">-&gt;</span>address, <span style="color:#f92672">&amp;</span>vmf<span style="color:#f92672">-&gt;</span>ptl);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">pte_none</span>(<span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pte))
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> unlock;
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> setpte;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* åˆ†é…æˆ‘ä»¬è‡ªå·±çš„ç§æœ‰é¡µ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">anon_vma_prepare</span>(vma)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> oom;
</span></span><span style="display:flex;"><span>	page <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloc_zeroed_user_highpage_movable</span>(vma, vmf<span style="color:#f92672">-&gt;</span>address);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>page)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> oom;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__SetPageUptodate</span>(page);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">mk_pte</span>(page, vma<span style="color:#f92672">-&gt;</span>vm_page_prot);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> VM_WRITE)
</span></span><span style="display:flex;"><span>		entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_mkwrite</span>(<span style="color:#a6e22e">pte_mkdirty</span>(entry));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vmf<span style="color:#f92672">-&gt;</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_offset_map_lock</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, vmf<span style="color:#f92672">-&gt;</span>pmd, vmf<span style="color:#f92672">-&gt;</span>address,
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">&amp;</span>vmf<span style="color:#f92672">-&gt;</span>ptl);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">pte_none</span>(<span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pte))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> release;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">inc_mm_counter_fast</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, MM_ANONPAGES);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">page_add_new_anon_rmap</span>(page, vma, vmf<span style="color:#f92672">-&gt;</span>address, false);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lru_cache_add_active_or_unevictable</span>(page, vma);
</span></span><span style="display:flex;"><span>	setpte:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">set_pte_at</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte, entry);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* ä¸éœ€è¦ä»é¡µè¡¨ç¼“å­˜åˆ é™¤é¡µè¡¨é¡¹ï¼Œå› ä¸ºä»¥å‰è™šæ‹Ÿé¡µæ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†é¡µ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">update_mmu_cache</span>(vma, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte);
</span></span><span style="display:flex;"><span>	unlock:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pte_unmap_unlock</span>(vmf<span style="color:#f92672">-&gt;</span>pte, vmf<span style="color:#f92672">-&gt;</span>ptl);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	release:
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">put_page</span>(page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">goto</span> unlock;
</span></span><span style="display:flex;"><span>	oom_free_page:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">put_page</span>(page);
</span></span><span style="display:flex;"><span>	oom:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸">2ï¼æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#2æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸">#</a></h4>
<p>â€‚è§¦å‘æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸:  <br>
â€‚(1)å¯åŠ¨ç¨‹åºæ—¶ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è§¦å‘æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸  <br>
â€‚(2)è¿›ç¨‹ä½¿ç”¨mmapåˆ›å»ºæ–‡ä»¶æ˜ å°„ï¼Œç¬¬ä¸€æ¬¡è®¿é—®çš„æ—¶å€™è§¦å‘æ–‡ä»¶é¡µçš„ç¼ºé¡µå¼‚å¸¸   <br></p>
<p>â€‚å‡½æ•°do_faultå¤„ç†æ–‡ä»¶é¡µå’Œå…±äº«åŒ¿åé¡µçš„ç¼ºé¡µå¼‚å¸¸
<img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122002649.png" alt="20221122002649"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">do_fault</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* è¿™ä¸ªvm_area_structç»“æ„ä½“åœ¨æ‰§è¡Œmmap()çš„æ—¶å€™æ²¡æœ‰å®Œå…¨å¡«å……ï¼Œæˆ–è€…ç¼ºå°‘æ ‡å¿—ä½VM_DONTEXPANDã€‚ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>vma<span style="color:#f92672">-&gt;</span>vm_ops<span style="color:#f92672">-&gt;</span>fault)
</span></span><span style="display:flex;"><span>		ret <span style="color:#f92672">=</span> VM_FAULT_SIGBUS;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(vmf<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_WRITE))  <span style="color:#75715e">// ç¼ºé¡µå¼‚å¸¸æ˜¯ç”±è¯»æ–‡ä»¶é¡µè§¦å‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_read_fault</span>(vmf);  <span style="color:#75715e">// å¤„ç†è¯»æ–‡ä»¶é¡µé”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>(vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> VM_SHARED))  <span style="color:#75715e">// ç¼ºé¡µå¼‚å¸¸æ˜¯ç”±å†™ç§æœ‰æ–‡ä»¶é¡µè§¦å‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_cow_fault</span>(vmf);  <span style="color:#75715e">// å†™ç§æœ‰æ–‡ä»¶é¡µé”™è¯¯, æ‰§è¡Œå†™æ—¶å¤åˆ¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">else</span>  <span style="color:#75715e">// ç¼ºé¡µå¼‚å¸¸æ˜¯ç”±å†™å…±äº«æ–‡ä»¶é¡µè§¦å‘
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_shared_fault</span>(vmf);  <span style="color:#75715e">// å¤„ç†å†™å…±äº«æ–‡ä»¶é¡µé”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ï¼ˆ1ï¼‰å¤„ç†è¯»æ–‡ä»¶é¡µé”™è¯¯  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122003030.png" alt="20221122003030"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">do_read_fault</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å…¨å±€å˜é‡fault_around_bytesæ§åˆ¶æ€»é•¿åº¦ï¼Œé»˜è®¤å€¼æ˜¯64KBã€‚å¦‚æœé¡µé•¿åº¦æ˜¯4KBï¼Œå°±ä¸€æ¬¡è¯»å–16é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>vm_ops<span style="color:#f92672">-&gt;</span>map_pages <span style="color:#f92672">&amp;&amp;</span> fault_around_bytes <span style="color:#f92672">&gt;&gt;</span> PAGE_SHIFT <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>		ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_fault_around</span>(vmf);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (ret)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ–‡ä»¶é¡µè¯»åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">__do_fault</span>(vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(ret <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE <span style="color:#f92672">|</span> VM_FAULT_RETRY)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è™šæ‹Ÿé¡µæ˜ å°„åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­çš„ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ret <span style="color:#f92672">|=</span> <span style="color:#a6e22e">finish_fault</span>(vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">unlock_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(ret <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE <span style="color:#f92672">|</span> VM_FAULT_RETRY)))
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°finish_faultè´Ÿè´£è®¾ç½®é¡µè¡¨é¡¹ï¼ŒæŠŠä¸»è¦å·¥ä½œå§”æ‰˜ç»™å‡½æ•°alloc_set_pte</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221122003336.png" alt="20221122003336"  />
</p>
<center>å‡½æ•°finish_faultçš„æ‰§è¡Œæµç¨‹</center>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">alloc_set_pte</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf, <span style="color:#66d9ef">struct</span> mem_cgroup <span style="color:#f92672">*</span>memcg,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>page)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> write <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>flags <span style="color:#f92672">&amp;</span> FAULT_FLAG_WRITE;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pte_t</span> entry;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>vmf<span style="color:#f92672">-&gt;</span>pte) {  <span style="color:#75715e">// ç›´æ¥é¡µè¡¨ä¸å­˜åœ¨ï¼Œåˆ†é…ç›´æ¥é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_alloc_one_map</span>(vmf);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (ret)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* é”ä½é¡µè¡¨åé‡æ–°æ£€æŸ¥ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">pte_none</span>(<span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pte)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_NOPAGE;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ç›´æ¥é¡µè¡¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆåˆ†é…ç›´æ¥é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">flush_icache_page</span>(vma, page);
</span></span><span style="display:flex;"><span>	entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">mk_pte</span>(page, vma<span style="color:#f92672">-&gt;</span>vm_page_prot);  <span style="color:#75715e">// ä½¿ç”¨é¡µå¸§å·å’Œè®¿é—®æƒé™ç”Ÿæˆé¡µè¡¨é¡¹çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (write)  <span style="color:#75715e">// å†™è®¿é—®ï¼Œè®¾ç½®é¡µè¡¨é¡¹çš„è„æ ‡å¿—ä½å’Œå†™æƒé™ä½
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">maybe_mkwrite</span>(<span style="color:#a6e22e">pte_mkdirty</span>(entry), vma);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* å†™æ—¶å¤åˆ¶çš„é¡µ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (write <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>(vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> VM_SHARED)) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inc_mm_counter_fast</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, MM_ANONPAGES);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">page_add_new_anon_rmap</span>(page, vma, vmf<span style="color:#f92672">-&gt;</span>address, false);
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">lru_cache_add_active_or_unevictable</span>(page, vma);
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inc_mm_counter_fast</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, <span style="color:#a6e22e">mm_counter_file</span>(page));
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">page_add_file_rmap</span>(page, false);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">set_pte_at</span>(vma<span style="color:#f92672">-&gt;</span>vm_mm, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte, entry);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* ä¸éœ€è¦ä½¿æ— æ•ˆï¼šä¸€ä¸ªä¸å­˜åœ¨çš„é¡µä¸ä¼šè¢«ç¼“å­˜ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">update_mmu_cache</span>(vma, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221123012105.png" alt="20221123012105"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">do_cow_fault</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">anon_vma_prepare</span>(vma)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å…³è”ä¸€ä¸ªanon_vmaå®ä¾‹åˆ°è™šæ‹Ÿå†…å­˜åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vmf<span style="color:#f92672">-&gt;</span>cow_page <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloc_page_vma</span>(GFP_HIGHUSER_MOVABLE, vma, vmf<span style="color:#f92672">-&gt;</span>address);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>vmf<span style="color:#f92672">-&gt;</span>cow_page)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">__do_fault</span>(vmf);  <span style="color:#75715e">// æŠŠæ–‡ä»¶é¡µè¯»åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(ret <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE <span style="color:#f92672">|</span> VM_FAULT_RETRY)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> uncharge_out;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (ret <span style="color:#f92672">&amp;</span> VM_FAULT_DONE_COW)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠæ–‡ä»¶çš„é¡µç¼“å­˜ä¸­ç‰©ç†é¡µçš„æ•°æ®å¤åˆ¶åˆ°å‰¯æœ¬ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">copy_user_highpage</span>(vmf<span style="color:#f92672">-&gt;</span>cow_page, vmf<span style="color:#f92672">-&gt;</span>page, vmf<span style="color:#f92672">-&gt;</span>address, vma);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__SetPageUptodate</span>(vmf<span style="color:#f92672">-&gt;</span>cow_page);  <span style="color:#75715e">// è®¾ç½®å‰¯æœ¬é¡µæè¿°ç¬¦çš„æ ‡å¿—ä½PG_uptodateï¼Œè¡¨ç¤ºç‰©ç†é¡µåŒ…å«æœ‰æ•ˆçš„æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// è®¾ç½®é¡µè¡¨é¡¹ï¼ŒæŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°å‰¯æœ¬ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ret <span style="color:#f92672">|=</span> <span style="color:#a6e22e">finish_fault</span>(vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">unlock_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">put_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(ret <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE <span style="color:#f92672">|</span> VM_FAULT_RETRY)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> uncharge_out;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	uncharge_out:
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">put_page</span>(vmf<span style="color:#f92672">-&gt;</span>cow_page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221123012433.png" alt="20221123012433"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">do_shared_fault</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> ret, tmp;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æŠŠæ–‡ä»¶é¡µè¯»åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">__do_fault</span>(vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(ret <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE <span style="color:#f92672">|</span> VM_FAULT_RETRY)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (vma<span style="color:#f92672">-&gt;</span>vm_ops<span style="color:#f92672">-&gt;</span>page_mkwrite) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">unlock_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>		tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">do_page_mkwrite</span>(vmf);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#f92672">!</span>tmp <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>					(tmp <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE)))) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">put_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> tmp;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è®¾ç½®é¡µè¡¨é¡¹ï¼ŒæŠŠè™šæ‹Ÿé¡µæ˜ å°„åˆ°æ–‡ä»¶çš„é¡µç¼“å­˜ä¸­çš„ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ret <span style="color:#f92672">|=</span> <span style="color:#a6e22e">finish_fault</span>(vmf);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(ret <span style="color:#f92672">&amp;</span> (VM_FAULT_ERROR <span style="color:#f92672">|</span> VM_FAULT_NOPAGE <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>						VM_FAULT_RETRY))) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">unlock_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_page</span>(vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// è®¾ç½®é¡µçš„è„æ ‡å¿—ä½ï¼Œè¡¨ç¤ºé¡µçš„æ•°æ®è¢«ä¿®æ”¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fault_dirty_shared_page</span>(vma, vmf<span style="color:#f92672">-&gt;</span>page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3å†™æ—¶å¤åˆ¶">3ï¼å†™æ—¶å¤åˆ¶<a hidden class="anchor" aria-hidden="true" href="#3å†™æ—¶å¤åˆ¶">#</a></h4>
<p>â€‚ä¸¤ç§æƒ…å†µä¼šæ‰§è¡Œå†™æ—¶å¤åˆ¶(Copy on Writeï¼ŒCoW)   <br>
â€ƒ(1)è¿›ç¨‹åˆ†å‰ç”Ÿæˆå­è¿›ç¨‹çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…å¤åˆ¶ç‰©ç†é¡µï¼Œå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹ä»¥åªè¯»æ–¹å¼å…±äº«æ‰€æœ‰ç§æœ‰çš„åŒ¿åé¡µå’Œæ–‡ä»¶é¡µ  <br>
â€‚(2)è¿›ç¨‹åˆ›å»ºç§æœ‰çš„æ–‡ä»¶æ˜ å°„ï¼Œç„¶åè¯»è®¿é—®ï¼Œè§¦å‘é¡µé”™è¯¯å¼‚å¸¸   <br>
â€ƒå‡½æ•°do_wp_pageå¤„ç†å†™æ—¶å¤åˆ¶</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221123012905.png" alt="20221123012905"  />
</p>
<p>â€‚å‡½æ•°wp_page_copyæ‰§è¡Œå†™æ—¶å¤åˆ¶</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221123234243.png" alt="20221123234243"  />
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// mm/memory.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">wp_page_copy</span>(<span style="color:#66d9ef">struct</span> vm_fault <span style="color:#f92672">*</span>vmf)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> vm_area_struct <span style="color:#f92672">*</span>vma <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>vma;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm <span style="color:#f92672">=</span> vma<span style="color:#f92672">-&gt;</span>vm_mm;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>old_page <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>page;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> page <span style="color:#f92672">*</span>new_page <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">pte_t</span> entry;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> page_copied <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> mmun_start <span style="color:#f92672">=</span> vmf<span style="color:#f92672">-&gt;</span>address <span style="color:#f92672">&amp;</span> PAGE_MASK;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> mmun_end <span style="color:#f92672">=</span> mmun_start <span style="color:#f92672">+</span> PAGE_SIZE;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> mem_cgroup <span style="color:#f92672">*</span>memcg;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å…³è”ä¸€ä¸ªanon_vmaå®ä¾‹åˆ°è™šæ‹Ÿå†…å­˜åŒºåŸŸ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">unlikely</span>(<span style="color:#a6e22e">anon_vma_prepare</span>(vma)))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">goto</span> oom;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_zero_pfn</span>(<span style="color:#a6e22e">pte_pfn</span>(vmf<span style="color:#f92672">-&gt;</span>orig_pte))) {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ˜¯é›¶é¡µï¼Œåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åç”¨é›¶åˆå§‹åŒ–
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		new_page <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloc_zeroed_user_highpage_movable</span>(vma,vmf<span style="color:#f92672">-&gt;</span>address);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>new_page)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> oom;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ä¸æ˜¯é›¶é¡µï¼Œåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åæŠŠæ•°æ®å¤åˆ¶åˆ°æ–°çš„ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		new_page <span style="color:#f92672">=</span> <span style="color:#a6e22e">alloc_page_vma</span>(GFP_HIGHUSER_MOVABLE, vma,
</span></span><span style="display:flex;"><span>					vmf<span style="color:#f92672">-&gt;</span>address);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>new_page)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> oom;
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cow_user_page</span>(new_page, old_page, vmf<span style="color:#f92672">-&gt;</span>address, vma);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ä¸æ˜¯é›¶é¡µï¼Œé‚£ä¹ˆåˆ†é…ä¸€ä¸ªç‰©ç†é¡µï¼Œç„¶åæŠŠæ•°æ®å¤åˆ¶åˆ°æ–°çš„ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">__SetPageUptodate</span>(new_page); <span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mmu_notifier_invalidate_range_start</span>(mm, mmun_start, mmun_end);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	vmf<span style="color:#f92672">-&gt;</span>pte <span style="color:#f92672">=</span> <span style="color:#a6e22e">pte_offset_map_lock</span>(mm, vmf<span style="color:#f92672">-&gt;</span>pmd, vmf<span style="color:#f92672">-&gt;</span>address, <span style="color:#f92672">&amp;</span>vmf<span style="color:#f92672">-&gt;</span>ptl);  <span style="color:#75715e">// é”ä½é¡µè¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">likely</span>(<span style="color:#a6e22e">pte_same</span>(<span style="color:#f92672">*</span>vmf<span style="color:#f92672">-&gt;</span>pte, vmf<span style="color:#f92672">-&gt;</span>orig_pte))) {
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">flush_cache_page</span>(vma, vmf<span style="color:#f92672">-&gt;</span>address, <span style="color:#a6e22e">pte_pfn</span>(vmf<span style="color:#f92672">-&gt;</span>orig_pte));  <span style="color:#75715e">// ä»ç¼“å­˜ä¸­å†²åˆ·é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#75715e">// ä½¿ç”¨æ–°çš„ç‰©ç†é¡µå’Œè®¿é—®æƒé™ç”Ÿæˆé¡µè¡¨é¡¹çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">mk_pte</span>(new_page, vma<span style="color:#f92672">-&gt;</span>vm_page_prot);
</span></span><span style="display:flex;"><span>		entry <span style="color:#f92672">=</span> <span style="color:#a6e22e">maybe_mkwrite</span>(<span style="color:#a6e22e">pte_mkdirty</span>(entry), vma);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æŠŠé¡µè¡¨é¡¹æ¸…é™¤ï¼Œå¹¶ä¸”å†²åˆ·é¡µè¡¨ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">ptep_clear_flush_notify</span>(vma, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// å»ºç«‹æ–°ç‰©ç†é¡µåˆ°è™šæ‹Ÿé¡µçš„åå‘æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">page_add_new_anon_rmap</span>(new_page, vma, vmf<span style="color:#f92672">-&gt;</span>address, false);
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æŠŠç‰©ç†é¡µæ·»åŠ åˆ°æ´»åŠ¨LRUé“¾è¡¨æˆ–ä¸å¯å›æ”¶LRUé“¾è¡¨ä¸­ï¼Œé¡µå›æ”¶ç®—æ³•éœ€è¦ä»LRUé“¾è¡¨ä¸­é€‰æ‹©éœ€è¦å›æ”¶çš„ç‰©ç†é¡µ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">lru_cache_add_active_or_unevictable</span>(new_page, vma);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// ä¿®æ”¹é¡µè¡¨é¡¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">set_pte_at_notify</span>(mm, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte, entry);
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// æ›´æ–°é¡µè¡¨ç¼“å­˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">update_mmu_cache</span>(vma, vmf<span style="color:#f92672">-&gt;</span>address, vmf<span style="color:#f92672">-&gt;</span>pte);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (old_page) { <span style="color:#75715e">// åˆ é™¤æ—§ç‰©ç†é¡µåˆ°è™šæ‹Ÿé¡µçš„åå‘æ˜ å°„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">page_remove_rmap</span>(old_page, false);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">/* é‡Šæ”¾æ—§çš„ç‰©ç†é¡µ */</span>
</span></span><span style="display:flex;"><span>		new_page <span style="color:#f92672">=</span> old_page;
</span></span><span style="display:flex;"><span>		page_copied <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (new_page)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_page</span>(new_page);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// é‡Šæ”¾é¡µè¡¨çš„é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pte_unmap_unlock</span>(vmf<span style="color:#f92672">-&gt;</span>pte, vmf<span style="color:#f92672">-&gt;</span>ptl);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mmu_notifier_invalidate_range_end</span>(mm, mmun_start, mmun_end);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (old_page) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (page_copied <span style="color:#f92672">&amp;&amp;</span> (vma<span style="color:#f92672">-&gt;</span>vm_flags <span style="color:#f92672">&amp;</span> VM_LOCKED)) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">lock_page</span>(old_page);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">PageMlocked</span>(old_page))
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">munlock_vma_page</span>(old_page);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">unlock_page</span>(old_page);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_page</span>(old_page);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> page_copied <span style="color:#f92672">?</span> VM_FAULT_WRITE : <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	oom_free_new:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">put_page</span>(new_page);
</span></span><span style="display:flex;"><span>	oom:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (old_page)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">put_page</span>(old_page);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> VM_FAULT_OOM;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3143å†…æ ¸æ¨¡å¼é¡µé”™è¯¯å¼‚å¸¸">3.14.3ã€€å†…æ ¸æ¨¡å¼é¡µé”™è¯¯å¼‚å¸¸<a hidden class="anchor" aria-hidden="true" href="#3143å†…æ ¸æ¨¡å¼é¡µé”™è¯¯å¼‚å¸¸">#</a></h3>
<p>â€‚å†…æ ¸ä½¿ç”¨çº¿æ€§æ˜ å°„åŒºåŸŸçš„è™šæ‹Ÿåœ°å€ï¼Œåœ¨å†…å­˜ç®¡ç†å­ç³»ç»Ÿåˆå§‹åŒ–çš„æ—¶æŠŠè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼Œè¿è¡Œè¿‡ç¨‹ä¸­ä½¿ç”¨vmalloc()å‡½æ•°ä»vmallocåŒºåŸŸåˆ†é…è™šæ‹Ÿå†…å­˜åŒºåŸŸï¼Œvmalloc()å‡½æ•°ä¼šåˆ†é…å¹¶ä¸”æ˜ å°„åˆ°ç‰©ç†é¡µ    <br>
â€‚æœ‰äº›ç³»ç»Ÿè°ƒç”¨ä¼šä¼ å…¥ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œå†…æ ¸å¿…é¡»ä½¿ç”¨å¤´æ–‡ä»¶â€œuaccess.hâ€å®šä¹‰çš„ä¸“ç”¨å‡½æ•°è®¿é—®ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼Œä¸“ç”¨å‡½æ•°åœ¨å¼‚å¸¸è¡¨ä¸­æ·»åŠ äº†å¯èƒ½è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤åœ°å€å’Œå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„åœ°å€ã€‚å¦‚æœè®¿é—®ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºæ—¶ç”Ÿæˆé¡µé”™è¯¯å¼‚å¸¸ï¼Œé¡µé”™è¯¯å¼‚å¸¸å¤„ç†ç¨‹åºå‘ç°ç”¨æˆ·è™šæ‹Ÿåœ°å€æ²¡æœ‰è¢«åˆ†é…ç»™è¿›ç¨‹ï¼Œå°±åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾æŒ‡ä»¤åœ°å€å¯¹åº”çš„å¼‚å¸¸ä¿®æ­£ç¨‹åºï¼Œå¦‚æœæ‰¾åˆ°äº†ï¼Œä½¿ç”¨å¼‚å¸¸ä¿®æ­£ç¨‹åºä¿®æ­£å¼‚å¸¸ï¼Œé¿å…å†…æ ¸å´©æºƒ  <br></p>
<p>â€‚åœ¨å†…æ ¸æ¨¡å¼ä¸‹æ‰§è¡Œæ—¶è§¦å‘é¡µé”™è¯¯å¼‚å¸¸ï¼ŒARM64æ¶æ„å†…æ ¸çš„å¤„ç†æµç¨‹ï¼Œ3ç§å¤„ç†æ–¹å¼  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221123235909.png" alt="20221123235909"  />
</p>
<p>â€‚(1)ä¸å…è®¸å†…æ ¸æ‰§è¡Œç”¨æˆ·ç©ºé—´æ²»ç–—ï¼Œå†…æ ¸æ¨¡å¼æ‰§è¡Œç”¨æˆ·æ€æŒ‡ä»¤ï¼Œå†…æ ¸å´©æºƒ   <br>
â€‚(2)å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€ï¼Œå…ˆä½¿ç”¨å‡½æ•°__do_page_faultå¤„ç†ï¼Œå¤„ç†å¤±è´¥ä½¿ç”¨__do_kernel_faultå¤„ç†   <br>
â€‚(3)å…¶ä»–æƒ…å†µ __do_kernel_faultå¤„ç†  <br></p>
<h4 id="1å‡½æ•°__do_kernel_fault">1.å‡½æ•°__do_kernel_fault<a hidden class="anchor" aria-hidden="true" href="#1å‡½æ•°__do_kernel_fault">#</a></h4>
<p>â€‚è®¿é—®æ•°æ®ç”Ÿæˆçš„å¼‚å¸¸ï¼Œå‡½æ•°__do_kernel_faultå°è¯•åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾å¼‚å¸¸ä¿®æ­£ç¨‹åº  <br>
â€‚æ‰¾åˆ°å¼‚å¸¸ä¿®æ­£ç¨‹åºï¼ŒæŠŠä¿å­˜åœ¨å†…æ ¸æ ˆä¸­çš„å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨(ELR_EL1ï¼ŒException Link Register for Exception Level 1)çš„å€¼ä¿®æ”¹ä¸ºå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„è™šæ‹Ÿåœ°å€ã€‚å½“å¼‚å¸¸å¤„ç†ç¨‹åºè¿”å›çš„æ—¶å€™ï¼Œå¤„ç†å™¨æŠŠç¨‹åºè®¡æ•°å™¨è®¾ç½®æˆå¼‚å¸¸é“¾æ¥å¯„å­˜å™¨çš„å€¼ï¼Œæ‰§è¡Œå¼‚å¸¸ä¿®æ­£ç¨‹åº <br>
â€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¼‚å¸¸ä¿®æ­£ç¨‹åºï¼Œå†…æ ¸å´©æºƒ   <br>
â€‚å‡½æ•°__do_kernel_fault</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/fault.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__do_kernel_fault</span>(<span style="color:#66d9ef">struct</span> mm_struct <span style="color:#f92672">*</span>mm, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr,
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> esr, <span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>msg;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// å¦‚æœå¼‚å¸¸æ˜¯ç”±è®¿é—®æ•°æ®ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆåœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾å¼‚å¸¸ä¿®å¤ç¨‹åº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">is_el1_instruction_abort</span>(esr) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">fixup_exception</span>(regs))
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ¸…é™¤ä»»ä½•å¯èƒ½é˜»æ­¢åœ¨ç»ˆç«¯æ‰“å°ä¿¡æ¯çš„è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bust_spinlocks</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">is_permission_fault</span>(esr, regs, addr)) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (esr <span style="color:#f92672">&amp;</span> ESR_ELx_WNR)
</span></span><span style="display:flex;"><span>			msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;write to read-only memory&#34;</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>			msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;read from unreadable memory&#34;</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (addr <span style="color:#f92672">&lt;</span> PAGE_SIZE) {
</span></span><span style="display:flex;"><span>		msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NULL pointer dereference&#34;</span>;
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		msg <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;paging request&#34;</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ‰“å°è§¦å‘é¡µé”™è¯¯å¼‚å¸¸çš„åŸå› 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">pr_alert</span>(<span style="color:#e6db74">&#34;Unable to handle kernel %s at virtual address %08lx</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, msg,
</span></span><span style="display:flex;"><span>		addr);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// æ‰“å°é¡µè¡¨ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">show_pte</span>(mm, addr);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">die</span>(<span style="color:#e6db74">&#34;Oops&#34;</span>, regs, esr);  <span style="color:#75715e">// è°ƒç”¨å‡½æ•°die()ä»¥æ‰“å°å¯„å­˜å™¨ä¿¡æ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">bust_spinlocks</span>(<span style="color:#ae81ff">0</span>);  <span style="color:#75715e">// åœæ­¢æ¸…é™¤ä»»ä½•å¯èƒ½é˜»æ­¢æ‰“å°ä¿¡æ¯çš„è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">do_exit</span>(SIGKILL);  <span style="color:#75715e">// ç»ˆæ­¢å½“å‰è¿›ç¨‹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°fixup_exceptionæ ¹æ®æŒ‡ä»¤åœ°å€åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾ï¼Œç„¶åæŠŠä¿å­˜åœ¨å†…æ ¸æ ˆä¸­çš„å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨çš„å€¼ä¿®æ”¹ä¸ºå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„è™šæ‹Ÿåœ°å€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/mm/extable.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">fixup_exception</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> exception_table_entry <span style="color:#f92672">*</span>fixup;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fixup <span style="color:#f92672">=</span> <span style="color:#a6e22e">search_exception_tables</span>(<span style="color:#a6e22e">instruction_pointer</span>(regs));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (fixup)
</span></span><span style="display:flex;"><span>          regs<span style="color:#f92672">-&gt;</span>pc <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)<span style="color:#f92672">&amp;</span>fixup<span style="color:#f92672">-&gt;</span>fixup <span style="color:#f92672">+</span> fixup<span style="color:#f92672">-&gt;</span>fixup;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> fixup <span style="color:#f92672">!=</span> NULL;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å¼‚å¸¸è¡¨é¡¹ä¸­å­˜å‚¨çš„æŒ‡ä»¤åœ°å€æ˜¯ç›¸å¯¹åœ°å€ï¼šfixup-&gt;insn =ï¼ˆæŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€ âˆ’ &amp;fixup-&gt;insnï¼‰ <br>
â€‚å¼‚å¸¸è¡¨é¡¹ä¸­å­˜å‚¨çš„å¼‚å¸¸ä¿®æ­£ç¨‹åºçš„åœ°å€æ˜¯ç›¸å¯¹åœ°å€ï¼šfixup-&gt;fixup =ï¼ˆå¼‚å¸¸ä¿®æ­£ç¨‹åºçš„è™šæ‹Ÿåœ°å€ âˆ’ &amp;fixup-&gt;fixupï¼‰  <br>
â€‚regs-&gt;pcæ˜¯ä¿å­˜åœ¨å†…æ ¸æ ˆä¸­çš„å¼‚å¸¸é“¾æ¥å¯„å­˜å™¨çš„å€¼  <br></p>
<p>â€‚å‡½æ•°search_exception_tablesæ ¹æ®æŒ‡ä»¤åœ°å€åœ¨å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾è¡¨é¡¹</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/extable.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> exception_table_entry <span style="color:#f92672">*</span><span style="color:#a6e22e">search_exception_tables</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">struct</span> exception_table_entry <span style="color:#f92672">*</span>e;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// åœ¨å†…æ ¸çš„å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	e <span style="color:#f92672">=</span> <span style="color:#a6e22e">search_extable</span>(__start___ex_table, __stop___ex_table<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, addr); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>e)  <span style="color:#75715e">// åœ¨å†…æ ¸çš„å¼‚å¸¸è¡¨ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œæ ¹æ®è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€æ‰¾åˆ°å†…æ ¸æ¨¡å—ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		e <span style="color:#f92672">=</span> <span style="color:#a6e22e">search_module_extables</span>(addr);  <span style="color:#75715e">// åœ¨å†…æ ¸æ¨¡å—çš„å¼‚å¸¸è¡¨ä¸­æŸ¥æ‰¾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> e;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="2å¼‚å¸¸è¡¨">2.å¼‚å¸¸è¡¨<a hidden class="anchor" aria-hidden="true" href="#2å¼‚å¸¸è¡¨">#</a></h4>
<p>â€‚è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è¿è¡Œçš„æ—¶å€™ï¼Œè®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€æ—¶ï¼Œåº”ç”¨ç¨‹åºé€šå¸¸æ˜¯ä¸å¯ä¿¡ä»»çš„ï¼Œä¸èƒ½ä¿è¯ä¼ å…¥çš„ç”¨æˆ·è™šæ‹Ÿåœ°å€æ˜¯åˆæ³•çš„ï¼Œé‡‡å–æªæ–½ä¿æŠ¤å†…æ ¸ã€‚ä½¿ç”¨å¼‚å¸¸è¡¨ï¼Œæ¯æ¡è¡¨é¡¹æœ‰ä¸¤ä¸ªå­—æ®µ  <br>
â€ƒ(1)è§¦å‘å¼‚å¸¸çš„æŒ‡ä»¤çš„è™šæ‹Ÿåœ°å€   <br>
â€ƒ(2)å¼‚å¸¸ä¿®æ­£ç¨‹åºçš„èµ·å§‹è™šæ‹Ÿåœ°å€   <br></p>
<p>â€‚å¼‚å¸¸è¡¨é¡¹å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/extable.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> exception_table_entry
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">int</span> insn, fixup;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚å†…æ ¸æœ‰ä¸€å¼ å¼‚å¸¸è¡¨ï¼Œå…¨å±€å˜é‡__start___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨çš„èµ·å§‹åœ°å€ï¼Œ__stop___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨çš„ç»“æŸåœ°å€  <br>
â€‚è¿›ç¨‹åœ¨å†…æ ¸æ¨¡å¼ä¸‹è®¿é—®ç”¨æˆ·è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼Œåªå…è®¸ä½¿ç”¨å¤´æ–‡ä»¶â€œuaccess.hâ€å£°æ˜çš„å‡½æ•°ï¼Œä»¥å‡½æ•°get_userä¸ºä¾‹ï¼Œå‡½æ•°get_userä»ç”¨æˆ·ç©ºé—´è¯»å–Cè¯­è¨€æ ‡å‡†ç±»å‹çš„æ•°æ®ï¼ŒARM64æ¶æ„å®ç°  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/uaccess.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define get_user(x, ptr)                              \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">({                                                    \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    __typeof__(*(ptr)) __user *__p = (ptr);            \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    might_fault();                                    \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    access_ok(VERIFY_READ, __p, sizeof(*__p)) ?        \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        __get_user((x), __p) :                         \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        ((x) = 0, -EFAULT);                           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">})
</span></span></span></code></pre></div><p>â€‚åœ¨64ä½å†…æ ¸ä¸­é•¿æ•´æ•°çš„é•¿åº¦æ˜¯8å­—èŠ‚ï¼ŒæŠŠâ€œ__get_user((x), __p)â€å±•å¼€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(                              \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;1: ldr %x1, [%2]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,                      \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;2:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                                     \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .section .fixup, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">ax</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>            \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .align    2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                        \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;3:  mov    %w0, %3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                     \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    mov    %1, #0</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                      \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    b    2b</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                            \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .previous</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                          \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .pushsection    __ex_table, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">a</span><span style="color:#ae81ff">\&#34;\n</span><span style="color:#e6db74">&#34;</span>   \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .align    3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                        \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .long    (1b  - .), (3b - .)</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>       \
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;    .popsection</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;+r&#34;</span> (err), <span style="color:#e6db74">&#34;=&amp;r&#34;</span> (x)                    \
</span></span><span style="display:flex;"><span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;r&#34;</span> (__p), <span style="color:#e6db74">&#34;i&#34;</span> (<span style="color:#f92672">-</span>EFAULT))
</span></span></code></pre></div><p>â€‚é“¾æ¥è„šæœ¬</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/vmlinux.lds.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    . <span style="color:#f92672">=</span> <span style="color:#a6e22e">ALIGN</span>(SEGMENT_ALIGN);
</span></span><span style="display:flex;"><span>    _etext <span style="color:#f92672">=</span> .;          <span style="color:#75715e">/* ä»£ç æ®µçš„ç»“æŸåœ°å€ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">RO_DATA</span>(PAGE_SIZE)   <span style="color:#75715e">/* ä»è¿™é‡Œåˆ° */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">EXCEPTION_TABLE</span>(<span style="color:#ae81ff">8</span>)   <span style="color:#75715e">/* __init_beginå°†è¢«æ ‡è®°ä¸ºåªè¯»å’Œä¸å¯æ‰§è¡Œ */</span>
</span></span><span style="display:flex;"><span>    NOTES
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®EXCEPTION_TABLEçš„å®šä¹‰
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// include/asm-generic/vmlinux.lds.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// å¼‚å¸¸è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define EXCEPTION_TABLE(align)                         \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    . = ALIGN(align);                                  \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    __ex_table : AT(ADDR(__ex_table) - LOAD_OFFSET) {    \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        VMLINUX_SYMBOL(__start___ex_table) = .;          \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        KEEP(*(__ex_table))                             \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        VMLINUX_SYMBOL(__stop___ex_table) = .;           \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    }
</span></span></span></code></pre></div><p>â€‚å†…æ ¸çš„å…¨å±€å˜é‡__start___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨èŠ‚ï¼ˆ__ex_tableï¼‰çš„èµ·å§‹åœ°å€ï¼Œ__stop___ex_tableå­˜æ”¾å¼‚å¸¸è¡¨èŠ‚çš„ç»“æŸåœ°å€  <br></p>
<h2 id="315åç¢ç‰‡æŠ€æœ¯">3.15ã€€åç¢ç‰‡æŠ€æœ¯<a hidden class="anchor" aria-hidden="true" href="#315åç¢ç‰‡æŠ€æœ¯">#</a></h2>
<p>â€‚åç¢ç‰‡æŠ€æœ¯  <br>
â€ƒ(1)2.6.23ç‰ˆæœ¬å¼•å…¥äº†è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ  <br>
â€ƒ(2)3.5ç‰ˆæœ¬å†…å­˜ç¢ç‰‡æ•´ç†æŠ€æœ¯   <br>
â€ƒ(3).6.24ç‰ˆæœ¬å¼•å…¥äº†æ ¹æ®å¯ç§»åŠ¨æ€§åˆ†ç»„çš„æŠ€æœ¯  <br>
â€ƒ(4).6.35ç‰ˆæœ¬å¼•å…¥äº†å†…å­˜ç¢ç‰‡æ•´ç†æŠ€æœ¯   <br></p>
<h3 id="3151è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ">3.15.1ã€€è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ<a hidden class="anchor" aria-hidden="true" href="#3151è™šæ‹Ÿå¯ç§»åŠ¨åŒºåŸŸ">#</a></h3>
<p>â€‚å¯ç§»åŠ¨åŒºåŸŸ(ZONE_MOVABLE)æ˜¯ä¸€ä¸ªä¼ªå†…å­˜åŒºåŸŸï¼šæŠŠç‰©ç†å†…å­˜åˆ†ä¸ºä¸¤ä¸ªåŒºåŸŸï¼Œä¸€ä¸ªåŒºåŸŸç”¨äºåˆ†é…ä¸å¯ç§»åŠ¨çš„é¡µï¼Œå¦ä¸€ä¸ªåŒºåŸŸç”¨äºåˆ†é…å¯ç§»åŠ¨çš„é¡µ</p>
<h3 id="3152å†…å­˜ç¢ç‰‡æ•´ç†">3.15.2ã€€å†…å­˜ç¢ç‰‡æ•´ç†<a hidden class="anchor" aria-hidden="true" href="#3152å†…å­˜ç¢ç‰‡æ•´ç†">#</a></h3>
<p>â€‚å†…å­˜ç¢ç‰‡æ•´ç†(memory compactionï¼Œæ„è¯‘ä¸ºâ€œå†…å­˜ç¢ç‰‡æ•´ç†â€)ï¼šä»å†…å­˜åŒºåŸŸçš„åº•éƒ¨æ‰«æå·²åˆ†é…çš„å¯ç§»åŠ¨é¡µï¼Œä»å†…å­˜åŒºåŸŸçš„é¡¶éƒ¨æ‰«æç©ºé—²é¡µï¼ŒæŠŠåº•éƒ¨çš„å¯ç§»åŠ¨é¡µç§»åˆ°é¡¶éƒ¨çš„ç©ºé—²é¡µï¼Œåœ¨åº•éƒ¨å½¢æˆè¿ç»­çš„ç©ºé—²é¡µ   <br></p>
<h4 id="1ä½¿ç”¨æ–¹æ³•">1.ä½¿ç”¨æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#1ä½¿ç”¨æ–¹æ³•">#</a></h4>
<p>â€‚å†…å­˜ç¢ç‰‡æ•´ç†åŠŸèƒ½ï¼Œå¿…é¡»å¼€å¯é…ç½®æ–‡ä»¶â€œmm/Kconfigâ€å®šä¹‰çš„é…ç½®å®CONFIG_COMPACTIONï¼Œé»˜è®¤å¼€å¯</p>
<h2 id="316é¡µå›æ”¶">3.16ã€€é¡µå›æ”¶<a hidden class="anchor" aria-hidden="true" href="#316é¡µå›æ”¶">#</a></h2>
<p>â€‚ç”³è¯·åˆ†é…é¡µçš„æ—¶å€™ï¼Œé¡µåˆ†é…å™¨é¦–å…ˆå°è¯•ä½¿ç”¨ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœä½¿ç”¨ä½æ°´çº¿åˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜è½»å¾®ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šå”¤é†’å†…å­˜èŠ‚ç‚¹çš„é¡µå›æ”¶å†…æ ¸çº¿ç¨‹ï¼Œå¼‚æ­¥å›æ”¶é¡µï¼Œç„¶åå°è¯•ä½¿ç”¨æœ€ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœä½¿ç”¨æœ€ä½æ°´çº¿åˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜ä¸¥é‡ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šç›´æ¥å›æ”¶é¡µ  <br></p>
<p>â€‚å†…æ ¸ä½¿ç”¨LRUï¼ˆLeast Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ç®—æ³•é€‰æ‹©æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç‰©ç†é¡µ</p>
<h3 id="3161æ•°æ®ç»“æ„">3.16.1ã€€æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#3161æ•°æ®ç»“æ„">#</a></h3>
<h4 id="1lrué“¾è¡¨">1ï¼LRUé“¾è¡¨<a hidden class="anchor" aria-hidden="true" href="#1lrué“¾è¡¨">#</a></h4>
<p>â€‚é¡µå›æ”¶ç®—æ³•ä½¿ç”¨LRUç®—æ³•é€‰æ‹©å›æ”¶çš„é¡µã€‚æ¯ä¸ªå†…å­˜èŠ‚ç‚¹çš„pglist_dataå®ä¾‹æœ‰ä¸€ä¸ªæˆå‘˜lruvecï¼Œç§°ä¸ºLRUå‘é‡ï¼ŒLRUå‘é‡åŒ…å«5æ¡LRUé“¾è¡¨  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221124004231.png" alt="20221124004231"  />
</p>
<p>å¾…è¡¥å……</p>
<h3 id="3162å‘èµ·é¡µå›æ”¶">3.16.2ã€€å‘èµ·é¡µå›æ”¶<a hidden class="anchor" aria-hidden="true" href="#3162å‘èµ·é¡µå›æ”¶">#</a></h3>
<p>â€‚ç”³è¯·åˆ†é…é¡µçš„æ—¶å€™ï¼Œé¡µåˆ†é…å™¨é¦–å…ˆå°è¯•ä½¿ç”¨ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœä½¿ç”¨ä½æ°´çº¿åˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜è½»å¾®ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šå”¤é†’æ‰€æœ‰ç¬¦åˆåˆ†é…æ¡ä»¶çš„å†…å­˜èŠ‚ç‚¹çš„é¡µå›æ”¶çº¿ç¨‹ï¼Œå¼‚æ­¥å›æ”¶é¡µï¼Œç„¶åå°è¯•ä½¿ç”¨æœ€ä½æ°´çº¿åˆ†é…é¡µã€‚å¦‚æœåˆ†é…å¤±è´¥ï¼Œè¯´æ˜å†…å­˜ä¸¥é‡ä¸è¶³ï¼Œé¡µåˆ†é…å™¨å°†ä¼šç›´æ¥å›æ”¶é¡µã€‚å¦‚æœç›´æ¥å›æ”¶é¡µå¤±è´¥ï¼Œé‚£ä¹ˆåˆ¤æ–­æ˜¯å¦åº”è¯¥é‡æ–°å°è¯•å›æ”¶é¡µ    <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221124004637.png" alt="20221124004637"  />
</p>
<h3 id="3163è®¡ç®—æ‰«æçš„é¡µæ•°">3.16.3ã€€è®¡ç®—æ‰«æçš„é¡µæ•°<a hidden class="anchor" aria-hidden="true" href="#3163è®¡ç®—æ‰«æçš„é¡µæ•°">#</a></h3>
<h3 id="3164æ”¶ç¼©æ´»åŠ¨é¡µé“¾è¡¨">3.16.4ã€€æ”¶ç¼©æ´»åŠ¨é¡µé“¾è¡¨<a hidden class="anchor" aria-hidden="true" href="#3164æ”¶ç¼©æ´»åŠ¨é¡µé“¾è¡¨">#</a></h3>
<h3 id="3165å›æ”¶ä¸æ´»åŠ¨é¡µ">3.16.5ã€€å›æ”¶ä¸æ´»åŠ¨é¡µ<a hidden class="anchor" aria-hidden="true" href="#3165å›æ”¶ä¸æ´»åŠ¨é¡µ">#</a></h3>
<h3 id="3166é¡µäº¤æ¢">3.16.6ã€€é¡µäº¤æ¢<a hidden class="anchor" aria-hidden="true" href="#3166é¡µäº¤æ¢">#</a></h3>
<h3 id="3167å›æ”¶slabç¼“å­˜">3.16.7ã€€å›æ”¶slabç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#3167å›æ”¶slabç¼“å­˜">#</a></h3>
<h2 id="317å†…å­˜è€—å°½æ€æ‰‹">3.17ã€€å†…å­˜è€—å°½æ€æ‰‹<a hidden class="anchor" aria-hidden="true" href="#317å†…å­˜è€—å°½æ€æ‰‹">#</a></h2>
<p>â€‚å½“å†…å­˜ä¸¥é‡ä¸è¶³çš„æ—¶å€™ï¼Œé¡µåˆ†é…å™¨åœ¨å¤šæ¬¡å°è¯•ç›´æ¥é¡µå›æ”¶å¤±è´¥ä»¥åï¼Œå°±ä¼šè°ƒç”¨å†…å­˜è€—å°½æ€æ‰‹ï¼ˆOOM killerï¼ŒOOMæ˜¯â€œOut of Memoryâ€çš„ç¼©å†™ï¼‰ï¼Œé€‰æ‹©è¿›ç¨‹æ€æ­»ï¼Œé‡Šæ”¾å†…å­˜</p>
<div align=center>
<div class="mermaid">
  
 flowchart LR
    __alloc_pages_showpath[Hard edge] -->|Link text| __alloc_pages_may_oom(Round edge)
    __alloc_pages_may_oom --> out_of_memeory{Decision}

</div>
</div>
<h3 id="3171ä½¿ç”¨æ–¹æ³•">3.17.1ã€€ä½¿ç”¨æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#3171ä½¿ç”¨æ–¹æ³•">#</a></h3>
<h3 id="3172æŠ€æœ¯åŸç†">3.17.2ã€€æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#3172æŠ€æœ¯åŸç†">#</a></h3>
<h2 id="318å†…å­˜èµ„æºæ§åˆ¶å™¨">3.18ã€€å†…å­˜èµ„æºæ§åˆ¶å™¨<a hidden class="anchor" aria-hidden="true" href="#318å†…å­˜èµ„æºæ§åˆ¶å™¨">#</a></h2>
<p>â€‚æ§åˆ¶ç»„(cgroup)çš„å†…å­˜èµ„æºæ§åˆ¶å™¨ç”¨æ¥æ§åˆ¶ä¸€ç»„è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨é‡ï¼Œå¯ç”¨å†…å­˜èµ„æºæ§åˆ¶å™¨çš„æ§åˆ¶ç»„ç®€ç§°å†…å­˜æ§åˆ¶ç»„ï¼ˆmemcgï¼‰ã€‚æ§åˆ¶ç»„æŠŠå„ç§èµ„æºæ§åˆ¶å™¨ç§°ä¸ºå­ç³»ç»Ÿï¼Œå†…å­˜èµ„æºæ§åˆ¶å™¨ä¹Ÿç§°ä¸ºå†…å­˜å­ç³»ç»Ÿ</p>
<h3 id="3181ä½¿ç”¨æ–¹æ³•">3.18.1ã€€ä½¿ç”¨æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#3181ä½¿ç”¨æ–¹æ³•">#</a></h3>
<h3 id="3182æŠ€æœ¯åŸç†">3.18.2ã€€æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#3182æŠ€æœ¯åŸç†">#</a></h3>
<h2 id="319å¤„ç†å™¨ç¼“å­˜">3.19ã€€å¤„ç†å™¨ç¼“å­˜<a hidden class="anchor" aria-hidden="true" href="#319å¤„ç†å™¨ç¼“å­˜">#</a></h2>
<p>â€‚å¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´å¢åŠ äº†ç¼“å­˜ã€‚ç¼“å­˜å’Œå†…å­˜çš„åŒºåˆ«   <br>
â€ƒ(1)ç¼“å­˜æ˜¯é™æ€éšæœºè®¿é—®å­˜å‚¨å™¨(Static Random Access Memoryï¼ŒSRAM)   <br>
â€ƒ(2)å†…å­˜æ˜¯åŠ¨æ€éšæœºè®¿é—®å­˜å‚¨å™¨(Dynamic Random Access Memoryï¼ŒDRAM)  <br></p>
<p>â€‚ä¸€çº§ç¼“å­˜åˆ†ä¸ºä¸€çº§æŒ‡ä»¤ç¼“å­˜(i-cacheï¼Œinstruction cache)å’Œä¸€çº§æ•°æ®æ•°æ®(d-cacheï¼Œdata cache)ã€‚äºŒçº§ç¼“å­˜æ˜¯æŒ‡ä»¤å’Œæ•°æ®å…±äº«çš„ç»Ÿä¸€ç¼“å­˜(unified cache)  <br></p>
<h3 id="3191ç¼“å­˜ç»“æ„">3.19.1ã€€ç¼“å­˜ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#3191ç¼“å­˜ç»“æ„">#</a></h3>
<p>â€‚32KBå››è·¯ç»„ç›¸è¿ç¼“å­˜(32KB 4-way set associative cache)  <br>
â€‚ç¼“å­˜çš„ç»“æ„  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221124010057.png" alt="20221124010057"  />
</p>
<p>â€‚ç¼“å­˜ç”±å¤šä¸ªå®¹é‡ç›¸åŒçš„å­ç¼“å­˜å¹¶è”ç»„æˆï¼Œæ¯ä¸ªå­ç¼“å­˜ç§°ä¸ºè·¯(Way)ï¼Œå››è·¯è¡¨ç¤º4ä¸ªå­ç¼“å­˜å¹¶è”</p>
<p>â€‚ARM64å¤„ç†å™¨çš„æŒ‡ä»¤ç¼“å­˜æœ‰3ç§ç±»å‹  <br>
â€ƒ(1)PIPTç¼“å­˜ ï¼š ç‰©ç†åœ°å€ç”Ÿæˆç´¢å¼•å’Œæ ‡ç­¾çš„ç¼“å­˜<br>
â€ƒ(2)VPIPTï¼ˆVMID-aware PIPTï¼‰ç¼“å­˜  <br>
â€ƒ(3)VIPTï¼šè™šæ‹Ÿåœ°å€ç”Ÿæˆç´¢å¼•ã€ä»ç‰©ç†åœ°å€ç”Ÿæˆæ ‡ç­¾<br></p>
<h3 id="3192ç¼“å­˜ç­–ç•¥">3.19.2ã€€ç¼“å­˜ç­–ç•¥<a hidden class="anchor" aria-hidden="true" href="#3192ç¼“å­˜ç­–ç•¥">#</a></h3>
<p>â€‚ç¼“å­˜åˆ†é…æœ‰ä¸¤ç§ç­–ç•¥  <br>
â€ƒ(1)å†™åˆ†é…(write allocation)  <br>
â€ƒ(2)è¯»åˆ†é…(read allocation)  <br>
â€‚ç¼“å­˜æ›´æ–°æœ‰ä¸¤ç§ç­–ç•¥  <br>
â€ƒ(1)å†™å›(write back)  <br>
â€ƒ(2)å†™é€(write-through)  <br></p>
<h3 id="3193-ç¼“å­˜ç»´æŠ¤">3.19.3 ç¼“å­˜ç»´æŠ¤<a hidden class="anchor" aria-hidden="true" href="#3193-ç¼“å­˜ç»´æŠ¤">#</a></h3>
<h4 id="3arm64å¤„ç†å™¨ç¼“å­˜ç»´æŠ¤">3.ARM64å¤„ç†å™¨ç¼“å­˜ç»´æŠ¤<a hidden class="anchor" aria-hidden="true" href="#3arm64å¤„ç†å™¨ç¼“å­˜ç»´æŠ¤">#</a></h4>
<p>â€‚ARM64å¤„ç†å™¨æ”¯æŒ3ç§ç¼“å­˜æ“ä½œã€‚  <br>
â€ƒï¼ˆ1ï¼‰ä½¿ç¼“å­˜è¡Œå¤±æ•ˆï¼ˆinvalidateï¼‰ï¼šæ¸…é™¤ç¼“å­˜è¡Œçš„æœ‰æ•ˆä½ã€‚  <br>
â€ƒï¼ˆ2ï¼‰æ¸…ç†ï¼ˆcleanï¼‰ç¼“å­˜è¡Œï¼šé¦–å…ˆæŠŠæ ‡è®°ä¸ºè„çš„ç¼“å­˜è¡Œé‡Œé¢çš„æ•°æ®å†™åˆ°ä¸‹ä¸€çº§ç¼“å­˜æˆ–å†…å­˜ï¼Œç„¶åæ¸…é™¤ç¼“å­˜è¡Œçš„æœ‰æ•ˆä½ã€‚åªé€‚ç”¨äºä½¿ç”¨å†™å›ç­–ç•¥çš„æ•°æ®ç¼“å­˜ã€‚  <br>
â€ƒï¼ˆ3ï¼‰æ¸…é›¶ï¼ˆzeroï¼‰ï¼šæŠŠç¼“å­˜é‡Œé¢çš„ä¸€ä¸ªå†…å­˜å—æ¸…é›¶ï¼Œä¸éœ€è¦å…ˆä»å†…å­˜è¯»æ•°æ®åˆ°ç¼“å­˜ä¸­ã€‚åªé€‚ç”¨äºæ•°æ®ç¼“å­˜   <br></p>
<h3 id="3194smpç¼“å­˜ä¸€è‡´æ€§">3.19.4ã€€SMPç¼“å­˜ä¸€è‡´æ€§<a hidden class="anchor" aria-hidden="true" href="#3194smpç¼“å­˜ä¸€è‡´æ€§">#</a></h3>
<p>â€‚åŸç”Ÿçš„MESIåè®®æœ‰4ç§çŠ¶æ€ã€‚MESIæ˜¯4ç§çŠ¶æ€çš„é¦–å­—æ¯ç¼©å†™ï¼Œç¼“å­˜è¡Œçš„4ç§çŠ¶æ€</p>
<h2 id="320-è¿ç»­å†…å­˜åˆ†é…å™¨">3.20 è¿ç»­å†…å­˜åˆ†é…å™¨<a hidden class="anchor" aria-hidden="true" href="#320-è¿ç»­å†…å­˜åˆ†é…å™¨">#</a></h2>
<p>â€‚è¿ç»­å†…å­˜åˆ†é…å™¨ï¼ˆContiguous Memory Allocatorï¼ŒCMAï¼‰:ä¿ç•™ä¸€å—å¤§çš„å†…å­˜åŒºåŸŸï¼Œå½“è®¾å¤‡é©±åŠ¨ä¸ä½¿ç”¨çš„æ—¶å€™ï¼Œå†…æ ¸çš„å…¶ä»–æ¨¡å—å¯ä»¥ä½¿ç”¨</p>
<h2 id="321-userfaultfd">3.21 userfaultfd<a hidden class="anchor" aria-hidden="true" href="#321-userfaultfd">#</a></h2>
<p>â€‚userfaultfdï¼ˆç”¨æˆ·é¡µé”™è¯¯æ–‡ä»¶æè¿°ç¬¦ï¼‰ç”¨æ¥æ‹¦æˆªå’Œå¤„ç†ç”¨æˆ·ç©ºé—´çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œå†…æ ¸é€šè¿‡æ–‡ä»¶æè¿°ç¬¦å°†é¡µé”™è¯¯å¼‚å¸¸çš„ä¿¡æ¯ä¼ é€’ç»™ç”¨æˆ·ç©ºé—´ï¼Œç„¶åç”±ç”¨æˆ·ç©ºé—´å†³å®šè¦å¾€è™šæ‹Ÿé¡µå†™å…¥çš„æ•°æ®ã€‚ä¼ ç»Ÿçš„é¡µé”™è¯¯å¼‚å¸¸ç”±å†…æ ¸ç‹¬è‡ªå¤„ç†ï¼Œç°åœ¨æ”¹ä¸ºç”±å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¸€èµ·æ§åˆ¶ã€‚  <br>
â€‚userfaultfdæ˜¯ä¸ºäº†è§£å†³QEMU/KVMè™šæ‹ŸæœºåŠ¨æ€è¿ç§»çš„é—®é¢˜è€Œå‡ºç°çš„ã€‚æ‰€è°“åŠ¨æ€è¿ç§»ï¼Œå°±æ˜¯å°†è™šæ‹Ÿæœºä»ä¸€ç«¯è¿ç§»åˆ°å¦ä¸€ç«¯ï¼Œè€Œåœ¨è¿ç§»çš„è¿‡ç¨‹ä¸­è™šæ‹Ÿæœºèƒ½å¤Ÿç»§ç»­æä¾›æœåŠ¡ï¼Œæœ‰ä¸¤ç§å®ç°æ–¹æ¡ˆ</p>
<h2 id="322-å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·kasan">3.22 å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·KASAN<a hidden class="anchor" aria-hidden="true" href="#322-å†…å­˜é”™è¯¯æ£€æµ‹å·¥å…·kasan">#</a></h2>
<p>â€‚å†…æ ¸åœ°å€æ¶ˆæ¯’å‰‚ï¼ˆKernel Address SANitizerï¼ŒKASANï¼‰æ˜¯ä¸€ä¸ªåŠ¨æ€çš„å†…å­˜é”™è¯¯æ£€æŸ¥å·¥å…·ï¼Œä¸ºå‘ç°â€œé‡Šæ”¾åä½¿ç”¨â€å’Œâ€œè¶Šç•Œè®¿é—®â€è¿™ä¸¤ç±»ç¼ºé™·æä¾›äº†å¿«é€Ÿå’Œç»¼åˆçš„è§£å†³æ–¹æ¡ˆ  <br>
â€‚KASANä½¿ç”¨ç¼–è¯‘æ—¶æ’æ¡©ï¼ˆcompile-time instrumentationï¼‰æ£€æŸ¥æ¯ä¸ªå†…å­˜è®¿é—®</p>
<h1 id="ç¬¬4ç« -ä¸­æ–­å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨">ç¬¬4ç«  ä¸­æ–­ã€å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#ç¬¬4ç« -ä¸­æ–­å¼‚å¸¸å’Œç³»ç»Ÿè°ƒç”¨">#</a></h1>
<h2 id="41-arm64å¼‚å¸¸å¤„ç†">4.1 ARM64å¼‚å¸¸å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#41-arm64å¼‚å¸¸å¤„ç†">#</a></h2>
<h3 id="411-å¼‚å¸¸çº§åˆ«">4.1.1 å¼‚å¸¸çº§åˆ«<a hidden class="anchor" aria-hidden="true" href="#411-å¼‚å¸¸çº§åˆ«">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨4ä¸ªå¼‚å¸¸çº§åˆ«ï¼š0~3</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221124233511.png" alt="20221124233511"  />
</p>
<center>ARM64å¤„ç†å™¨çš„å¼‚å¸¸çº§åˆ«</center>
<p>â€‚è™šæ‹Ÿæœºé‡Œé¢è¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œè¿è¡Œè™šæ‹Ÿæœºçš„æ“ä½œç³»ç»Ÿç§°ä¸ºå®¿ä¸»æ“ä½œç³»ç»Ÿ(host OS)ï¼Œè™šæ‹Ÿæœºé‡Œé¢çš„æ“ä½œç³»ç»Ÿç§°ä¸ºå®¢æˆ·æ“ä½œç³»ç»Ÿ(guest OS)   <br>
â€‚å¼€æºè™šæ‹Ÿæœºç®¡ç†è½¯ä»¶æ˜¯QEMUï¼ŒQEMUæ”¯æŒåŸºäºå†…æ ¸çš„è™šæ‹Ÿæœº(Kernel-based Virtual Machineï¼ŒKVM)ã€‚KVMç›´æ¥åœ¨å¤„ç†å™¨ä¸Šæ‰§è¡Œå®¢æˆ·æ“ä½œç³»ç»Ÿï¼Œè™šæ‹Ÿæœºçš„æ‰§è¡Œé€Ÿåº¦å¾ˆå¿«ã€‚KVMæ˜¯å†…æ ¸çš„ä¸€ä¸ªæ¨¡å—ï¼ŒæŠŠå†…æ ¸å˜æˆè™šæ‹Ÿæœºç›‘æ§ç¨‹åºã€‚  <br>
â€‚ARM64æ¶æ„å¼•å…¥äº†è™šæ‹ŸåŒ–å®¿ä¸»æ‰©å±•ï¼Œåœ¨å¼‚å¸¸çº§åˆ«2æ‰§è¡Œå®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸ï¼Œä»QEMUåˆ‡æ¢åˆ°å®¢æˆ·æ“ä½œç³»ç»Ÿçš„æ—¶å€™ï¼ŒKVMä¸å†éœ€è¦ä»å¼‚å¸¸çº§åˆ«1åˆ‡æ¢åˆ°å¼‚å¸¸çº§åˆ«2ã€‚  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221124234127.png" alt="20221124234127"  />
</p>
<p>â€‚ARM64æ¶æ„çš„å®‰å…¨æ‰©å±•å®šä¹‰äº†ä¸¤ç§å®‰å…¨çŠ¶æ€ï¼šæ­£å¸¸ä¸–ç•Œå’Œå®‰å…¨ä¸–ç•Œã€‚é€šè¿‡å¼‚å¸¸çº§åˆ«3çš„å®‰å…¨ç›‘æ§å™¨åˆ‡æ¢</p>
<h3 id="412-å¼‚å¸¸åˆ†ç±»">4.1.2 å¼‚å¸¸åˆ†ç±»<a hidden class="anchor" aria-hidden="true" href="#412-å¼‚å¸¸åˆ†ç±»">#</a></h3>
<p>â€‚ARM64ä½“ç³»ç»“æ„ä¸­ï¼Œå¼‚å¸¸åˆ†ä¸ºåŒæ­¥å¼‚å¸¸å’Œå¼‚æ­¥å¼‚å¸¸   <br>
â€‚åŒæ­¥å¼‚å¸¸åŒ…æ‹¬ï¼š
â€ƒ(1)ç³»ç»Ÿè°ƒç”¨ï¼Œå¼‚å¸¸çº§åˆ«0ä½¿ç”¨svc(Supervisor Call)æŒ‡ä»¤é™·å…¥å¼‚å¸¸çº§åˆ«1ï¼Œå¼‚å¸¸çº§åˆ«1ä½¿ç”¨hvc(Hypervisor Call)æŒ‡ä»¤é™·å…¥å¼‚å¸¸çº§åˆ«2ï¼Œå¼‚å¸¸çº§åˆ«2ä½¿ç”¨smc(Secure Monitor Call)æŒ‡ä»¤é™·å…¥å¼‚å¸¸çº§åˆ«3  <br>
â€ƒ(2)æ•°æ®ä¸­æ­¢ï¼Œå³è®¿é—®æ•°æ®æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œæ— æ˜ å°„ï¼Œæ— å†™æƒé™  <br>
â€ƒ(3)æŒ‡ä»¤ä¸­æ­¢ï¼Œå–æŒ‡ä»¤æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œæ— æ˜ å°„ï¼Œæ— æ‰§è¡Œæƒé™   <br>
â€ƒ(4)æ ˆæŒ‡é’ˆæˆ–æŒ‡ä»¤åœ°å€æ²¡æœ‰å¯¹é½   <br>
â€ƒ(5)æ²¡æœ‰å®šä¹‰çš„æŒ‡ä»¤  <br>
â€ƒ(6)è°ƒè¯•å¼‚å¸¸  <br>
â€‚å¼‚æ­¥å¼‚å¸¸åŒ…æ‹¬:  <br>
â€ƒ(1)ä¸­æ–­(normal priority interruptï¼ŒIRQ)ï¼Œå³æ™®é€šä¼˜å…ˆçº§çš„ä¸­æ–­ã€‚  <br>
â€ƒ(2)å¿«é€Ÿä¸­æ–­(fast interrupt FIQ)ï¼Œé«˜ä¼˜å…ˆçº§ä¸­æ–­  <br>
â€ƒ(3)ç³»ç»Ÿé”™è¯¯(System Error SError)ï¼Œç¡¬ä»¶é”™è¯¯è§¦å‘çš„å¼‚å¸¸  <br></p>
<h3 id="413-å¼‚å¸¸å‘é‡è¡¨">4.1.3 å¼‚å¸¸å‘é‡è¡¨<a hidden class="anchor" aria-hidden="true" href="#413-å¼‚å¸¸å‘é‡è¡¨">#</a></h3>
<p>â€‚å­˜å‚¨å¼‚å¸¸å¤„ç†ç¨‹åºçš„å†…å­˜ä½ç½®ç§°ä¸ºå¼‚å¸¸å‘é‡ï¼ŒARM64å¤„ç†å™¨çš„å¼‚å¸¸çº§åˆ«1ã€2å’Œ3ï¼Œæ¯ä¸ªå¼‚å¸¸çº§åˆ«éƒ½æœ‰è‡ªå·±çš„å¼‚å¸¸å‘é‡è¡¨ï¼Œå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€å­˜æ”¾åœ¨å¯„å­˜å™¨VBAR_ELn(å‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨ï¼ŒVector Based Address Register)ä¸­   <br></p>
<table>
	<tr>
	    <th>åœ°å€</th>
	    <th>å¼‚å¸¸ç±»å‹</th>
	    <th>å«ä¹‰</th>  
	</tr >
	<tr >
	    <td>VBAR_ELn + 0x000</td>
	    <td>åŒæ­¥å¼‚å¸¸</td>
	    <td rowspan="4">å½“å‰å¼‚å¸¸çº§åˆ«ç”Ÿæˆçš„å¼‚å¸¸ï¼Œä½¿ç”¨å¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0</td>
	</tr>
	<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x080</td>
	    <td>ä¸­æ–­</td>
	</tr>
	<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x100</td>
	    <td>å¿«é€Ÿä¸­æ–­</td>
	</tr>
	<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x180</td>
	    <td>ç³»ç»Ÿé”™è¯¯</td>
	</tr>
	<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x200</td>
	    <td>åŒæ­¥å¼‚å¸¸</td>
	     <td rowspan="4">å½“å‰å¼‚å¸¸çº§åˆ«ç”Ÿæˆçš„å¼‚å¸¸ï¼Œä½¿ç”¨å½“å‰å¼‚å¸¸çº§åˆ«çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_ELn</td>
	</tr>
	<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x280</td>
	    <td>ä¸­æ–­</td>
	</tr>
		<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x300</td>
	    <td>å¿«é€Ÿä¸­æ–­</td>
	</tr>
	<tr>
	    <td>ã€€ ã€€ã€€ã€€ + 0x380</td>
	    <td>ç³»ç»Ÿé”™è¯¯</td>
	</tr>
		<tr>
	    <td>ã€€ ã€€ã€€ã€€ + 0x400</td>
	    <td>åŒæ­¥å¼‚å¸¸</td>
	    <td rowspan="4">64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«ï¼ˆnâˆ’1ï¼‰ç”Ÿæˆçš„å¼‚å¸¸</td>
	</tr>
	<tr>
	    <td>ã€€ ã€€ã€€ã€€ + 0x480</td>
	    <td>ä¸­æ–­</td>
	</tr>
		<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x500</td>
	    <td>å¿«é€Ÿä¸­æ–­</td>
	</tr>
		<tr >
	    <td>ã€€ ã€€ã€€ã€€ + 0x580</td>
	    <td>ç³»ç»Ÿé”™è¯¯</td>
	</tr>
	<tr>
	    <td>ã€€ ã€€ã€€ã€€ + 0x600</td>
	    <td>åŒæ­¥å¼‚å¸¸</td>
	    <td rowspan="4">32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«ï¼ˆnâˆ’1ï¼‰ç”Ÿæˆçš„å¼‚å¸¸</td>
	</tr>
	<tr>
	    <td>ã€€ ã€€ã€€ã€€ + 0x680</td>
	    <td>ä¸­æ–­</td>
	</tr>
	<tr>
	    <td>ã€€ ã€€ã€€ ã€€+ 0x700</td>
	    <td>å¿«é€Ÿä¸­æ–­</td>
	</tr>
	<tr>
	    <td> ã€€ã€€ã€€ + 0x780</td>
	    <td>ç³»ç»Ÿé”™è¯¯</td>
	</tr>
</table>
<p>â€‚ARM64æ¶æ„å†…æ ¸å®šä¹‰çš„å¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ach/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      .align    <span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENTRY</span>(vectors)
</span></span><span style="display:flex;"><span>   ventry el1_sync_invalid    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry el1_irq_invalid     <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry el1_fiq_invalid     <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry el1_error_invalid   <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>   ventry el1_sync            <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry el1_irq             <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry el1_fiq_invalid     <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry el1_error_invalid   <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯ï¼Œä½¿ç”¨æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP_EL1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>   ventry    el0_sync         <span style="color:#75715e">// 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_irq          <span style="color:#75715e">// 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_fiq_invalid  <span style="color:#75715e">// 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_error_invalid<span style="color:#75715e">// 64ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_COMPAT          </span><span style="color:#75715e">/* è¡¨ç¤ºæ”¯æŒæ‰§è¡Œ32ä½ç¨‹åº */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_sync_compat  <span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_irq_compat   <span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_fiq_invalid_compat <span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_error_invalid_compat<span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_sync_invalid <span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_irq_invalid  <span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_fiq_invalid  <span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„å¿«é€Ÿä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   ventry    el0_error_invalid<span style="color:#75715e">// 32ä½åº”ç”¨ç¨‹åºåœ¨å¼‚å¸¸çº§åˆ«0ç”Ÿæˆçš„ç³»ç»Ÿé”™è¯¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">END</span>(vectors)
</span></span></code></pre></div><p>â€‚ventryæ˜¯ä¸€ä¸ªå®ï¼Œå‚æ•°æ˜¯è·³è½¬æ ‡å·ï¼Œå³å¼‚å¸¸å¤„ç†ç¨‹åºçš„æ ‡å·</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/assembler.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     .macro    ventry    label
</span></span><span style="display:flex;"><span>    .align <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>    b    <span style="color:#960050;background-color:#1e0010">\</span>label
</span></span><span style="display:flex;"><span>    .endm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ventry el1_syncå±•å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.align <span style="color:#ae81ff">7</span>
</span></span><span style="display:flex;"><span>b  el1_sync
</span></span></code></pre></div><p>â€‚å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œ0å·å¤„ç†å™¨ç§°ä¸ºå¼•å¯¼å¤„ç†å™¨ï¼Œå…¶ä»–å¤„ç†å™¨ç§°ä¸ºä»å¤„ç†å™¨ã€‚å¼•å¯¼å¤„ç†å™¨åœ¨å‡½æ•°__primary_switched()ä¸­æŠŠå¯„å­˜å™¨VBAR_EL1è®¾ç½®ä¸ºå¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">_head</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">stext</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">__primary_switch</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">__primary_switched</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>__primary_switched:
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>   adr_l x8, vectors
</span></span><span style="display:flex;"><span>   msr   vbar_el1, x8        <span style="color:#75715e">// æŠŠå¯„å­˜å™¨VBAR_EL1è®¾ç½®ä¸ºå¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   isb
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>   b  start_kernel
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENDPROC</span>(__primary_switched)
</span></span></code></pre></div><p>â€‚ä»å¤„ç†å™¨åœ¨å‡½æ•°__secondary_switched()ä¸­æŠŠå¯„å­˜å™¨VBAR_EL1è®¾ç½®ä¸ºå¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨çš„èµ·å§‹è™šæ‹Ÿåœ°å€</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">secondary_entry</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">secondary_startup</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">__secondary_switched</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/head.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>__secondary_switched:
</span></span><span style="display:flex;"><span>    adr_l    x5, vectors
</span></span><span style="display:flex;"><span>    msr    vbar_el1, x5
</span></span><span style="display:flex;"><span>    isb
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    b  secondary_start_kernel
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENDPROC</span>(__secondary_switched)
</span></span></code></pre></div><h3 id="414-å¼‚å¸¸å¤„ç†">4.1.4 å¼‚å¸¸å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#414-å¼‚å¸¸å¤„ç†">#</a></h3>
<p>â€‚å¤„ç†å™¨å–å‡ºå¼‚å¸¸å¤„ç†çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ‰§è¡Œçš„æ“ä½œ  <br>
â€‚(1)æŠŠå½“å‰çš„å¤„ç†å™¨çŠ¶æ€ï¼ˆProcessor Stateï¼ŒPSTATEï¼‰ä¿å­˜åœ¨å¯„å­˜å™¨SPSR_EL1ï¼ˆä¿å­˜ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼ŒSaved Program Status Registerï¼‰ä¸­  <br>
â€‚(2)æŠŠè¿”å›åœ°å€ä¿å­˜åœ¨å¯„å­˜å™¨ELR_EL1ï¼ˆå¼‚å¸¸é“¾æ¥å¯„å­˜å™¨ï¼ŒException Link Registerï¼‰ä¸­   <br>
â€ƒç³»ç»Ÿè°ƒç”¨ï¼Œé‚£ä¹ˆè¿”å›åœ°å€æ˜¯ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤åé¢çš„æŒ‡ä»¤  <br>
â€ƒé™¤ç³»ç»Ÿè°ƒç”¨å¤–çš„åŒæ­¥å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿”å›åœ°å€æ˜¯ç”Ÿæˆå¼‚å¸¸çš„æŒ‡ä»¤  <br>
â€ƒå¼‚æ­¥å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿”å›åœ°å€æ˜¯æ²¡æœ‰æ‰§è¡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤  <br>
â€‚(3)æŠŠå¤„ç†å™¨çŠ¶æ€çš„DAIFè¿™4ä¸ªå¼‚å¸¸æ©ç ä½éƒ½è®¾ç½®ä¸º1ï¼Œç¦æ­¢è¿™4ç§å¼‚å¸¸ï¼ŒDæ˜¯è°ƒè¯•æ©ç ä½ï¼ˆDebug mask bitï¼‰ï¼ŒAæ˜¯ç³»ç»Ÿé”™è¯¯æ©ç ä½ï¼ˆSError mask bitï¼‰ï¼ŒIæ˜¯ä¸­æ–­æ©ç ä½ï¼ˆIRQ mask bitï¼‰ï¼ŒFæ˜¯å¿«é€Ÿä¸­æ–­æ©ç ä½ï¼ˆFIQ mask bitï¼‰  <br>
â€‚(4)åŒæ­¥å¼‚å¸¸æˆ–ç³»ç»Ÿé”™è¯¯å¼‚å¸¸ï¼ŒæŠŠç”Ÿæˆå¼‚å¸¸çš„åŸå› ä¿å­˜åœ¨å¯„å­˜å™¨ESR_EL1ï¼ˆå¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨ï¼ŒException Syndrome Registerï¼‰ä¸­ <br>
â€‚(5)åŒæ­¥å¼‚å¸¸ï¼ŒæŠŠé”™è¯¯åœ°å€ä¿å­˜åœ¨å¯„å­˜å™¨FAR_EL1ï¼ˆé”™è¯¯åœ°å€å¯„å­˜å™¨ï¼ŒFault Address Registerï¼‰ä¸­  <br>
â€‚(6)å¤„ç†å™¨å¤„äºç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰ï¼Œé‚£ä¹ˆæŠŠå¼‚å¸¸çº§åˆ«æå‡åˆ°1  <br>
â€‚(7)æ ¹æ®å‘é‡åŸºå‡†åœ°å€å¯„å­˜å™¨VBAR_EL1ã€å¼‚å¸¸ç±»å‹å’Œç”Ÿæˆå¼‚å¸¸çš„å¼‚å¸¸çº§åˆ«è®¡ç®—å‡ºå¼‚å¸¸å‘é‡çš„è™šæ‹Ÿåœ°å€ï¼Œæ‰§è¡Œå¼‚å¸¸å‘é‡  <br>
â€‚å¯¹äº64ä½åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰ä¸‹ç”Ÿæˆçš„åŒæ­¥å¼‚å¸¸ï¼Œå…¥å£æ˜¯el0_sync</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>el0_sync:
</span></span><span style="display:flex;"><span>	kernel_entry <span style="color:#ae81ff">0</span>  <span style="color:#75715e">// æŠŠæ‰€æœ‰é€šç”¨å¯„å­˜å™¨çš„å€¼ä¿å­˜åœ¨å½“å‰è¿›ç¨‹çš„å†…æ ¸æ ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mrs  x25, esr_el1                 <span style="color:#75715e">// è¯»å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lsr  x24, x25, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SHIFT  <span style="color:#75715e">// å¼‚å¸¸ç±»åˆ«
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SVC64       <span style="color:#75715e">// 64ä½ç³»ç»Ÿè°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_svc  <span style="color:#75715e">// ç³»ç»Ÿè°ƒç”¨ï¼Œè°ƒç”¨å‡½æ•°el0_svc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_DABT_LOW    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«0çš„æ•°æ®ä¸­æ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_da  <span style="color:#75715e">// è®¿é—®æ•°æ®æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_da
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_IABT_LOW    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«0çš„æŒ‡ä»¤ä¸­æ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_ia  <span style="color:#75715e">// å–æŒ‡ä»¤æ—¶çš„é¡µé”™è¯¯å¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_ia
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_FP_ASIMD    <span style="color:#75715e">// è®¿é—®æµ®ç‚¹æˆ–è€…é«˜çº§SIMD
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_fpsimd_acc  <span style="color:#75715e">// è®¿é—®æµ®ç‚¹æˆ–é«˜çº§SIMDï¼Œè°ƒç”¨å‡½æ•°el0_fpsimd_acc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_FP_EXC64    <span style="color:#75715e">// æµ®ç‚¹æˆ–è€…é«˜çº§SIMDå¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_fpsimd_exc  <span style="color:#75715e">// æµ®ç‚¹æˆ–é«˜çº§SIMDå¼‚å¸¸ï¼Œè°ƒç”¨å‡½æ•°el0_fpsimd_exc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SYS64       <span style="color:#75715e">// å¯é…ç½®é™·å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_sys  <span style="color:#75715e">// å¯é…ç½®é™·å…¥ï¼Œè°ƒç”¨å‡½æ•°el0_sys
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SP_ALIGN    <span style="color:#75715e">// æ ˆå¯¹é½å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_sp_pc
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_PC_ALIGN    <span style="color:#75715e">// æŒ‡ä»¤åœ°å€å¯¹é½å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_sp_pc
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_UNKNOWN     <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«0çš„æœªçŸ¥å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_undef
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_BREAKPT_LOW <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«0çš„è°ƒè¯•å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.ge el0_dbg
</span></span><span style="display:flex;"><span>	b    el0_inv
</span></span></code></pre></div><p>â€‚å¯é…ç½®é™·å…¥ï¼Œè°ƒç”¨å‡½æ•°el0_sys</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>el1_sync:
</span></span><span style="display:flex;"><span>	kernel_entry <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	mrs  x1, esr_el1                  <span style="color:#75715e">// è¯»å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lsr  x24, x1, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SHIFT   <span style="color:#75715e">// å¼‚å¸¸ç±»åˆ«
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_DABT_CUR    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1çš„æ•°æ®ä¸­æ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el1_da
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_IABT_CUR    <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1çš„æŒ‡ä»¤ä¸­æ­¢
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el1_ia
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SYS64       <span style="color:#75715e">// å¯é…ç½®é™·å…¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el1_undef
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SP_ALIGN    <span style="color:#75715e">// æ ˆå¯¹é½å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el1_sp_pc
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_PC_ALIGN    <span style="color:#75715e">// æŒ‡ä»¤åœ°å€å¯¹é½å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el1_sp_pc
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_UNKNOWN     <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1çš„æœªçŸ¥å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el1_undef
</span></span><span style="display:flex;"><span>	cmp  x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_BREAKPT_CUR <span style="color:#75715e">// å¼‚å¸¸çº§åˆ«1çš„è°ƒè¯•å¼‚å¸¸
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.ge el1_dbg
</span></span><span style="display:flex;"><span>	b    el1_inv
</span></span></code></pre></div><p>â€‚ä»¥64ä½åº”ç”¨ç¨‹åºåœ¨ç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰ä¸‹è®¿é—®æ•°æ®æ—¶ç”Ÿæˆçš„é¡µé”™è¯¯å¼‚å¸¸ä¸ºä¾‹ï¼Œå¤„ç†å‡½æ•°æ˜¯el0_da</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>el0_da:
</span></span><span style="display:flex;"><span>	mrs   x26, far_el1  <span style="color:#75715e">// è·å–æ•°æ®çš„è™šæ‹Ÿåœ°å€ï¼Œå­˜æ”¾åœ¨å¯„å­˜å™¨x26
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	enable_dbg_and_irq   <span style="color:#75715e">// msr   daifclr, #(8 | 2) å¼€å¯è°ƒè¯•å¼‚å¸¸å’Œä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	clear_address_tag x0, x26
</span></span><span style="display:flex;"><span>	mov  x1, x25
</span></span><span style="display:flex;"><span>	mov  x2, sp
</span></span><span style="display:flex;"><span>	bl   do_mem_abort  <span style="color:#75715e">// è°ƒç”¨Cè¯­è¨€å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b    ret_to_user
</span></span></code></pre></div><p>â€‚å†…æ ¸æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«1ï¼‰ä¸‹è®¿é—®æ•°æ®æ—¶ç”Ÿæˆçš„é¡µé”™è¯¯å¼‚å¸¸ä¸ºä¾‹è¯´æ˜ï¼Œå¤„ç†å‡½æ•°æ˜¯el1_da</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>el1_da:
</span></span><span style="display:flex;"><span>	mrs   x3, far_el1
</span></span><span style="display:flex;"><span>	enable_dbg
</span></span><span style="display:flex;"><span>	tbnz   x23, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">1f</span>
</span></span><span style="display:flex;"><span>	enable_irq
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>	clear_address_tag x0, x3
</span></span><span style="display:flex;"><span>	mov   x2, sp            <span style="color:#75715e">// ç»“æ„ä½“ pt_regs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	bl   do_mem_abort
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	disable_irq
</span></span><span style="display:flex;"><span>	kernel_exit <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>â€‚å¼‚å¸¸å¤„ç†ç¨‹åºæ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œè°ƒç”¨kernel_exitè¿”å›ã€‚kernel_exitæ˜¯ä¸€ä¸ªå®ï¼Œå‚æ•°elæ˜¯è¿”å›çš„å¼‚å¸¸çº§åˆ«ï¼Œ0è¡¨ç¤ºè¿”å›å¼‚å¸¸çº§åˆ«0ï¼Œ1è¡¨ç¤ºè¿”å›å¼‚å¸¸çº§åˆ«1</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    .macro  kernel_exit, el
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    ldp  x21, x22, [sp, <span style="color:#960050;background-color:#1e0010">#</span>S_PC]    <span style="color:#75715e">//åŠ è½½ä¿å­˜çš„å¯„å­˜å™¨ELR_EL1å’ŒSPSR_EL1çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#66d9ef">if</span>  <span style="color:#960050;background-color:#1e0010">\</span>el <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>                 <span style="color:#75715e">/* å¦‚æœè¿”å›ç”¨æˆ·æ¨¡å¼ï¼ˆå¼‚å¸¸çº§åˆ«0ï¼‰*/</span>
</span></span><span style="display:flex;"><span>    ldr  x23, [sp, <span style="color:#960050;background-color:#1e0010">#</span>S_SP]
</span></span><span style="display:flex;"><span>    msr  sp_el0, x23              <span style="color:#75715e">/* æ¢å¤å¼‚å¸¸çº§åˆ«0çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    .endif
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    msr  elr_el1, x21
</span></span><span style="display:flex;"><span>    msr  spsr_el1, x22
</span></span><span style="display:flex;"><span>    ldp  x0, x1, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    ldp  x2, x3, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    ldp  x4, x5, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>    ldp  x6, x7, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>    ldp  x8, x9, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>    ldp  x10, x11, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>    ldp  x12, x13, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">6</span>]
</span></span><span style="display:flex;"><span>    ldp  x14, x15, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>]
</span></span><span style="display:flex;"><span>    ldp  x16, x17, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    ldp  x18, x19, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">9</span>]
</span></span><span style="display:flex;"><span>    ldp  x20, x21, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>]
</span></span><span style="display:flex;"><span>    ldp  x22, x23, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">11</span>]
</span></span><span style="display:flex;"><span>    ldp  x24, x25, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span>]
</span></span><span style="display:flex;"><span>    ldp  x26, x27, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">13</span>]
</span></span><span style="display:flex;"><span>    ldp  x28, x29, [sp, <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">16</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">14</span>]
</span></span><span style="display:flex;"><span>    ldr  lr, [sp, <span style="color:#960050;background-color:#1e0010">#</span>S_LR]
</span></span><span style="display:flex;"><span>    add  sp, sp, <span style="color:#960050;background-color:#1e0010">#</span>S_FRAME_SIZE
</span></span><span style="display:flex;"><span>    eret
</span></span><span style="display:flex;"><span>    .endm
</span></span></code></pre></div><p>â€‚æ‰§è¡ŒæŒ‡ä»¤eretçš„æ—¶å€™ï¼Œå¤„ç†å™¨è‡ªåŠ¨ä½¿ç”¨å¯„å­˜å™¨SPSR_EL1ä¿å­˜çš„å€¼æ¢å¤å¤„ç†å™¨çŠ¶æ€ï¼Œä½¿ç”¨å¯„å­˜å™¨ELR_EL1ä¿å­˜çš„è¿”å›åœ°å€æ¢å¤ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counterï¼ŒPCï¼‰</p>
<h2 id="42-ä¸­æ–­">4.2 ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#42-ä¸­æ–­">#</a></h2>
<p>â€‚ä¸­æ–­æ˜¯å¤–å›´è®¾å¤‡é€šçŸ¥å¤„ç†å™¨çš„ä¸€ç§æœºåˆ¶</p>
<h3 id="421ä¸­æ–­æ§åˆ¶å™¨">4.2.1ã€€ä¸­æ–­æ§åˆ¶å™¨<a hidden class="anchor" aria-hidden="true" href="#421ä¸­æ–­æ§åˆ¶å™¨">#</a></h3>
<p>â€‚ARMæ ‡å‡†çš„ä¸­æ–­æ§åˆ¶å™¨ï¼Œç§°ä¸ºé€šç”¨ä¸­æ–­æ§åˆ¶å™¨ï¼ˆGeneric Interrupt Controllerï¼ŒGICï¼‰  <br>
â€‚è½¯ä»¶ GIC v2æ§åˆ¶å™¨æœ‰ä¸¤ä¸ªä¸»è¦çš„åŠŸèƒ½å—   <br>
â€ƒ1ï¼‰åˆ†å‘å™¨ï¼ˆDistributorï¼‰  <br>
â€ƒ2ï¼‰å¤„ç†å™¨æ¥å£ï¼ˆCPU Interfaceï¼‰   <br></p>
<p>â€‚ä¸­æ–­æœ‰ä»¥ä¸‹4ç§ç±»å‹:SGIã€PPIã€SPIã€LPI   <br>
â€ƒSGI  è½¯ä»¶ç”Ÿæˆçš„ä¸­æ–­ 0~15  <br>
â€ƒPPI  ç§æœ‰å¤–è®¾ä¸­æ–­ 16~31  <br>
â€ƒSPI  å…±äº«å¤–è®¾ä¸­æ–­ 32~1020   <br>
â€ƒLPI  å±€éƒ¨ç‰¹ç‚¹å¤–è®¾ä¸­æ–­</p>
<p>â€‚è¾¹æ²¿è§¦å‘ã€ç”µå¹³è§¦å‘  <br></p>
<p>â€‚ä¸­æ–­æœ‰ä»¥ä¸‹4ç§çŠ¶æ€ã€‚  <br>
â€‚ï¼ˆ1ï¼‰Inactiveï¼šä¸­æ–­æºæ²¡æœ‰å‘é€ä¸­æ–­ã€‚<br>
â€‚ï¼ˆ2ï¼‰Pendingï¼šä¸­æ–­æºå·²ç»å‘é€ä¸­æ–­ï¼Œç­‰å¾…å¤„ç†å™¨å¤„ç†ã€‚<br>
â€‚ï¼ˆ3ï¼‰Activeï¼šå¤„ç†å™¨å·²ç»ç¡®è®¤ä¸­æ–­ï¼Œæ­£åœ¨å¤„ç†ã€‚ <br>
â€‚ï¼ˆ4ï¼‰Active and pendingï¼šå¤„ç†å™¨æ­£åœ¨å¤„ç†ä¸­æ–­ï¼Œç›¸åŒçš„ä¸­æ–­æºåˆå‘é€äº†ä¸€ä¸ªä¸­æ–­ã€‚  <br></p>
<p>GIC v2æ§åˆ¶å™¨æè¿°ç¬¦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// drivers/irqchip/irq-gic.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> irq_chip gic_chip <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>      .irq_mask            <span style="color:#f92672">=</span> gic_mask_irq,
</span></span><span style="display:flex;"><span>      .irq_unmask          <span style="color:#f92672">=</span> gic_unmask_irq,
</span></span><span style="display:flex;"><span>      .irq_eoi             <span style="color:#f92672">=</span> gic_eoi_irq,
</span></span><span style="display:flex;"><span>      .irq_set_type        <span style="color:#f92672">=</span> gic_set_type,
</span></span><span style="display:flex;"><span>      .irq_get_irqchip_state <span style="color:#f92672">=</span> gic_irq_get_irqchip_state,
</span></span><span style="display:flex;"><span>      .irq_set_irqchip_state <span style="color:#f92672">=</span> gic_irq_set_irqchip_state,
</span></span><span style="display:flex;"><span>      .flags               <span style="color:#f92672">=</span> IRQCHIP_SET_TYPE_MASKED <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                           IRQCHIP_SKIP_SET_WAKE <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>                           IRQCHIP_MASK_ON_SUSPEND,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h3 id="422ä¸­æ–­åŸŸ">4.2.2ã€€ä¸­æ–­åŸŸ<a hidden class="anchor" aria-hidden="true" href="#422ä¸­æ–­åŸŸ">#</a></h3>
<p>â€‚æ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨æœ¬åœ°çš„ç¡¬ä»¶ä¸­æ–­å·æ˜ å°„åˆ°å…¨å±€å”¯ä¸€çš„Linuxä¸­æ–­å·ï¼ˆä¹Ÿç§°ä¸ºè™šæ‹Ÿä¸­æ–­å·ï¼‰ï¼Œå†…æ ¸å®šä¹‰äº†ä¸­æ–­åŸŸirq_domainï¼Œæ¯ä¸ªä¸­æ–­æ§åˆ¶å™¨æœ‰è‡ªå·±çš„ä¸­æ–­åŸŸ  <br></p>
<h4 id="1åˆ›å»ºä¸­æ–­åŸŸ">1ï¼åˆ›å»ºä¸­æ–­åŸŸ<a hidden class="anchor" aria-hidden="true" href="#1åˆ›å»ºä¸­æ–­åŸŸ">#</a></h4>
<p>â€‚ä¸­æ–­æ§åˆ¶å™¨çš„é©±åŠ¨ç¨‹åºä½¿ç”¨åˆ†é…å‡½æ•°irq_domain_add_*()åˆ›å»ºå’Œæ³¨å†Œä¸­æ–­åŸŸï¼Œè°ƒç”¨è€…ç»™åˆ†é…å‡½æ•°æä¾›irq_domain_opsç»“æ„ä½“ï¼Œåˆ†é…å‡½æ•°åœ¨æ‰§è¡ŒæˆåŠŸçš„æ—¶å€™è¿”å›irq_domainçš„æŒ‡é’ˆ<br>
â€‚åˆ†é…ä¸»è¦ä¸ºå‡½æ•°__irq_domain_add()ã€‚å‡½æ•°__irq_domain_add()çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ï¼šåˆ†é…ä¸€ä¸ªirq_domainç»“æ„ä½“ï¼Œåˆå§‹åŒ–æˆå‘˜ï¼Œç„¶åæŠŠä¸­æ–­åŸŸæ·»åŠ åˆ°å…¨å±€é“¾è¡¨irq_domain_listä¸­  <br></p>
<h4 id="2åˆ›å»ºæ˜ å°„">2ï¼åˆ›å»ºæ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#2åˆ›å»ºæ˜ å°„">#</a></h4>
<p>â€‚å‘ä¸­æ–­åŸŸæ·»åŠ ç¡¬ä»¶ä¸­æ–­å·åˆ°Linuxä¸­æ–­å·çš„æ˜ å°„ï¼Œå†…æ ¸æä¾›äº†å‡½æ•°irq_create_mapping</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">irq_create_mapping</span>(<span style="color:#66d9ef">struct</span> irq_domain <span style="color:#f92672">*</span>domain, <span style="color:#66d9ef">irq_hw_number_t</span> hwirq);
</span></span></code></pre></div><h4 id="3æŸ¥æ‰¾æ˜ å°„">3ï¼æŸ¥æ‰¾æ˜ å°„<a hidden class="anchor" aria-hidden="true" href="#3æŸ¥æ‰¾æ˜ å°„">#</a></h4>
<p>ä¸­æ–­å¤„ç†ç¨‹åºéœ€è¦æ ¹æ®ç¡¬ä»¶ä¸­æ–­å·æŸ¥æ‰¾Linuxä¸­æ–­å·ï¼Œå†…æ ¸æä¾›äº†å‡½æ•°irq_find_mappingï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">irq_find_mapping</span>(<span style="color:#66d9ef">struct</span> irq_domain <span style="color:#f92672">*</span>domain, <span style="color:#66d9ef">irq_hw_number_t</span> hwirq);
</span></span></code></pre></div><p>è¾“å…¥å‚æ•°æ˜¯ä¸­æ–­åŸŸå’Œç¡¬ä»¶ä¸­æ–­å·ï¼Œè¿”å›Linuxä¸­æ–­å·</p>
<h3 id="423ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–">4.2.3ã€€ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#423ä¸­æ–­æ§åˆ¶å™¨é©±åŠ¨åˆå§‹åŒ–">#</a></h3>
<p>â€‚ARM64æ¶æ„ä½¿ç”¨æ‰å¹³è®¾å¤‡æ ‘ï¼ˆFlattened Device Treeï¼ŒFDTï¼‰æè¿°æ¿å¡çš„ç¡¬ä»¶ä¿¡æ¯ã€‚ç¼–å†™è®¾å¤‡æ ‘æºæ–‡ä»¶ï¼ˆDevice Tree Sourceï¼ŒDTSï¼‰ï¼Œå­˜æ”¾åœ¨ç›®å½•â€œarch/arm64/boot/dtsâ€ä¸‹ï¼Œç„¶åä½¿ç”¨è®¾å¤‡æ ‘ç¼–è¯‘å™¨ï¼ˆDevice Tree Compilerï¼ŒDTCï¼‰æŠŠè®¾å¤‡æ ‘æºæ–‡ä»¶è½¬æ¢æˆè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆDevice Tree Blobï¼ŒDTBï¼‰ï¼Œæœ€åæŠŠè®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶å†™åˆ°å­˜å‚¨è®¾å¤‡ä¸Š</p>
<h4 id="1è®¾å¤‡æ ‘æºæ–‡ä»¶">1ï¼è®¾å¤‡æ ‘æºæ–‡ä»¶<a hidden class="anchor" aria-hidden="true" href="#1è®¾å¤‡æ ‘æºæ–‡ä»¶">#</a></h4>
<h4 id="3åˆå§‹åŒ–">3.åˆå§‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#3åˆå§‹åŒ–">#</a></h4>
<p>å‡½æ•°irqchip_init &ndash;&gt; of_irq_init &ndash;&gt; __irqchip_of_table  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">start_kernel</span>() 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">init_IRQ</span>() 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">irqchip_init</span>()
</span></span><span style="display:flex;"><span>	 <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">of_irq_init</span>()
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">gic_of_init</span>()
</span></span><span style="display:flex;"><span>	    <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">__gic_init_bases</span>()
</span></span><span style="display:flex;"><span>	  <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">__irqchip_of_table</span>()
</span></span></code></pre></div><h3 id="424linuxä¸­æ–­å¤„ç†">4.2.4ã€€Linuxä¸­æ–­å¤„ç†<a hidden class="anchor" aria-hidden="true" href="#424linuxä¸­æ–­å¤„ç†">#</a></h3>
<p>â€‚å‘ä¸­æ–­åŸŸæ·»åŠ ç¡¬ä»¶ä¸­æ–­å·åˆ°Linuxä¸­æ–­å·çš„æ˜ å°„æ—¶ï¼Œå†…æ ¸åˆ†é…ä¸€ä¸ªLinuxä¸­æ–­å·å’Œä¸€ä¸ªä¸­æ–­æè¿°ç¬¦irq_desc  <br>
â€‚ä¸­æ–­æè¿°ç¬¦æœ‰ä¸¤ä¸ªå±‚æ¬¡çš„ä¸­æ–­å¤„ç†å‡½æ•°</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221128230127.png" alt="20221128230127"  />
</p>
<p>â€‚å­˜å‚¨Linuxä¸­æ–­å·åˆ°ä¸­æ–­æè¿°ç¬¦çš„æ˜ å°„å…³ç³»  <br>
â€ƒ(1)ä¸­æ–­ç¼–å·æ˜¯ç¨€ç–çš„ï¼ˆå³ä¸è¿ç»­ï¼‰ï¼Œé‚£ä¹ˆä½¿ç”¨åŸºæ•°æ ‘ï¼ˆradix treeï¼‰å­˜å‚¨  <br>
â€ƒ(2)ä¸­æ–­ç¼–å·æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆä½¿ç”¨æ•°ç»„å­˜å‚¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/irq/irqdesc.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#ifdef CONFIG_SPARSE_IRQ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">RADIX_TREE</span>(irq_desc_tree, GFP_KERNEL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> irq_desc irq_desc[NR_IRQS] __cacheline_aligned_in_smp <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>     [<span style="color:#ae81ff">0</span> ... NR_IRQS<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]  <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            .handle_irq <span style="color:#f92672">=</span> handle_bad_irq,
</span></span><span style="display:flex;"><span>            .depth      <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            .lock       <span style="color:#f92672">=</span> <span style="color:#a6e22e">__RAW_SPIN_LOCK_UNLOCKED</span>(irq_desc<span style="color:#f92672">-&gt;</span>lock),
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">handle_irq</span>()
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">gic_irq_domain_map</span>()
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// ç¡¬ä»¶ä¸­æ–­å·å°äº32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">handle_percpu_devid_irq</span>()
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">// ä¸­æ–­å·å¤§äºæˆ–ç­‰äº32
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">handle_fasteoi_irq</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">irq_create_mapping</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">irq_domain_associate</span>() <span style="color:#f92672">-&gt;</span> domain<span style="color:#f92672">-&gt;</span>ops<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">map</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">// drivers/irqchip/irq-gic.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">gic_irq_domain_map</span>(<span style="color:#66d9ef">struct</span> irq_domain <span style="color:#f92672">*</span>d, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq,
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">irq_hw_number_t</span> hw)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> gic_chip_data <span style="color:#f92672">*</span>gic <span style="color:#f92672">=</span> d<span style="color:#f92672">-&gt;</span>host_data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (hw <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">32</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">irq_set_percpu_devid</span>(irq);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">irq_domain_set_info</span>(d, irq, hw, <span style="color:#f92672">&amp;</span>gic<span style="color:#f92672">-&gt;</span>chip, d<span style="color:#f92672">-&gt;</span>host_data,
</span></span><span style="display:flex;"><span>                         handle_percpu_devid_irq, NULL, NULL);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">irq_set_status_flags</span>(irq, IRQ_NOAUTOEN);
</span></span><span style="display:flex;"><span>      } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">irq_domain_set_info</span>(d, irq, hw, <span style="color:#f92672">&amp;</span>gic<span style="color:#f92672">-&gt;</span>chip, d<span style="color:#f92672">-&gt;</span>host_data,
</span></span><span style="display:flex;"><span>                         handle_fasteoi_irq, NULL, NULL);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">irq_set_probe</span>(irq);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221128230716.png" alt="20221128230716"  />
</p>
<center>Linuxä¸­æ–­å¤„ç†æµç¨‹</center>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/entry.S
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   .align   <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>  el0_irq:
</span></span><span style="display:flex;"><span>   kernel_entry <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  el0_irq_naked:
</span></span><span style="display:flex;"><span>   enable_dbg
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>   irq_handler
</span></span><span style="display:flex;"><span>   <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>   b   ret_to_user
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ENDPROC</span>(el0_irq)
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>   .macro   irq_handler
</span></span><span style="display:flex;"><span>   ldr_l   x1, handle_arch_irq
</span></span><span style="display:flex;"><span>   mov   x0, sp
</span></span><span style="display:flex;"><span>   irq_stack_entry
</span></span><span style="display:flex;"><span>   blr   x1
</span></span><span style="display:flex;"><span>   irq_stack_exit
</span></span><span style="display:flex;"><span>   .endm
</span></span></code></pre></div><p>â€‚å‡½æ•°handle_irq_eventï¼Œæ‰§è¡Œè®¾å¤‡é©±åŠ¨ç¨‹åºæ³¨å†Œçš„å¤„ç†å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// handle_irq_event()  -&gt;  handle_irq_event_percpu()  -&gt;  __handle_irq_event_percpu()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>kernel<span style="color:#f92672">/</span>irq<span style="color:#f92672">/</span>handle.c
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">irqreturn_t</span>  <span style="color:#a6e22e">__handle_irq_event_percpu</span>(<span style="color:#66d9ef">struct</span> irq_desc <span style="color:#f92672">*</span>desc, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">irqreturn_t</span> retval <span style="color:#f92672">=</span> IRQ_NONE;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq <span style="color:#f92672">=</span> desc<span style="color:#f92672">-&gt;</span>irq_data.irq;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> irqaction <span style="color:#f92672">*</span>action;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">for_each_action_of_desc</span>(desc, action) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">irqreturn_t</span> res;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>         res <span style="color:#f92672">=</span> action<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">handler</span>(irq, action<span style="color:#f92672">-&gt;</span>dev_id);
</span></span><span style="display:flex;"><span>         <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">switch</span> (res) {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">case</span> IRQ_WAKE_THREAD:
</span></span><span style="display:flex;"><span>             <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">__irq_wake_thread</span>(desc, action);
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">/*ç»§ç»­å¾€ä¸‹èµ°ï¼ŒæŠŠâ€œaction-&gt;flagsâ€ä½œä¸ºç”Ÿæˆéšæœºæ•°çš„ä¸€ä¸ªå› å­ */</span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">case</span> IRQ_HANDLED:
</span></span><span style="display:flex;"><span>             <span style="color:#f92672">*</span>flags <span style="color:#f92672">|=</span> action<span style="color:#f92672">-&gt;</span>flags;
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>         retval <span style="color:#f92672">|=</span> res;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> retval;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="425ä¸­æ–­çº¿ç¨‹åŒ–">4.2.5ã€€ä¸­æ–­çº¿ç¨‹åŒ–<a hidden class="anchor" aria-hidden="true" href="#425ä¸­æ–­çº¿ç¨‹åŒ–">#</a></h3>
<p>â€‚å†…æ ¸æä¾›çš„å‡½æ•°request_threaded_irq()ç”¨æ¥æ³¨å†Œçº¿ç¨‹åŒ–çš„ä¸­æ–­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">request_threaded_irq</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq, <span style="color:#66d9ef">irq_handler_t</span> handler,
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">irq_handler_t</span> thread_fn,
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>name, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>dev);
</span></span></code></pre></div><p>â€‚æ¯ä¸ªä¸­æ–­å¤„ç†æè¿°ç¬¦ï¼ˆirqactionï¼‰å¯¹åº”ä¸€ä¸ªå†…æ ¸çº¿ç¨‹ï¼Œæˆå‘˜threadæŒ‡å‘å†…æ ¸çº¿ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ï¼Œæˆå‘˜thread_fnæŒ‡å‘çº¿ç¨‹å¤„ç†å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/interrupt.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> irqaction {
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">irq_handler_t</span>      thread_fn;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span><span style="color:#66d9ef">thread</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} ____cacheline_internodealigned_in_smp;
</span></span></code></pre></div><p>â€‚ä¸­æ–­å¤„ç†çº¿ç¨‹æ˜¯ä¼˜å…ˆçº§ä¸º50ã€è°ƒåº¦ç­–ç•¥æ˜¯SCHED_FIFOçš„å®æ—¶å†…æ ¸çº¿ç¨‹ï¼Œåç§°æ˜¯â€œirq/â€åé¢è·Ÿç€Linuxä¸­æ–­å·ï¼Œçº¿ç¨‹å¤„ç†å‡½æ•°æ˜¯irq_thread()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">request_threaded_irq</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">__setup_irq</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">setup_irq_thread</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel/irq/manage.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">setup_irq_thread</span>(<span style="color:#66d9ef">struct</span> irqaction <span style="color:#f92672">*</span>new, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq, <span style="color:#66d9ef">bool</span> secondary)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>t;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> sched_param param <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>          .sched_priority <span style="color:#f92672">=</span> MAX_USER_RT_PRIO<span style="color:#f92672">/</span><span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>     };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>secondary) {
</span></span><span style="display:flex;"><span>           t <span style="color:#f92672">=</span> <span style="color:#a6e22e">kthread_create</span>(irq_thread, new, <span style="color:#e6db74">&#34;irq/%d-%s&#34;</span>, irq,
</span></span><span style="display:flex;"><span>                        new<span style="color:#f92672">-&gt;</span>name);
</span></span><span style="display:flex;"><span>     } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>           t <span style="color:#f92672">=</span> <span style="color:#a6e22e">kthread_create</span>(irq_thread, new, <span style="color:#e6db74">&#34;irq/%d-s-%s&#34;</span>, irq,
</span></span><span style="display:flex;"><span>                      new<span style="color:#f92672">-&gt;</span>name);
</span></span><span style="display:flex;"><span>           param.sched_priority <span style="color:#f92672">-=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">sched_setscheduler_nocheck</span>(t, SCHED_FIFO, <span style="color:#f92672">&amp;</span>param);
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">handle_fasteoi_irq</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">handle_irq_event</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">handle_irq_event_percpu</span>()  <span style="color:#f92672">-&gt;</span>  <span style="color:#a6e22e">__handle_irq_event_percpu</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel/irq/handle.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">irqreturn_t</span>  <span style="color:#a6e22e">__handle_irq_event_percpu</span>(<span style="color:#66d9ef">struct</span> irq_desc <span style="color:#f92672">*</span>desc, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">irqreturn_t</span> retval <span style="color:#f92672">=</span> IRQ_NONE;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq <span style="color:#f92672">=</span> desc<span style="color:#f92672">-&gt;</span>irq_data.irq;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> irqaction <span style="color:#f92672">*</span>action;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">for_each_action_of_desc</span>(desc, action) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">irqreturn_t</span> res;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>          res <span style="color:#f92672">=</span> action<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">handler</span>(irq, action<span style="color:#f92672">-&gt;</span>dev_id);
</span></span><span style="display:flex;"><span>          <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">switch</span> (res) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> IRQ_WAKE_THREAD:
</span></span><span style="display:flex;"><span>               <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>               <span style="color:#a6e22e">__irq_wake_thread</span>(desc, action);
</span></span><span style="display:flex;"><span>               <span style="color:#75715e">/*ç»§ç»­å¾€ä¸‹èµ°ï¼ŒæŠŠâ€œaction-&gt;flagsâ€ä½œä¸ºç”Ÿæˆéšæœºæ•°çš„ä¸€ä¸ªå› å­*/</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">case</span> IRQ_HANDLED:
</span></span><span style="display:flex;"><span>               <span style="color:#f92672">*</span>flags <span style="color:#f92672">|=</span> action<span style="color:#f92672">-&gt;</span>flags;
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          retval <span style="color:#f92672">|=</span> res;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> retval;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ä¸­æ–­å¤„ç†çº¿ç¨‹çš„å¤„ç†å‡½æ•°æ˜¯irq_thread()ï¼Œè°ƒç”¨å‡½æ•°irq_thread_fn()ï¼Œç„¶åå‡½æ•°irq_thread_fn()è°ƒç”¨æ³¨å†Œçš„çº¿ç¨‹å¤„ç†å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/irq/manage.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">irq_thread</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> callback_head on_exit_work;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> irqaction <span style="color:#f92672">*</span>action <span style="color:#f92672">=</span> data;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">struct</span> irq_desc <span style="color:#f92672">*</span>desc <span style="color:#f92672">=</span> <span style="color:#a6e22e">irq_to_desc</span>(action<span style="color:#f92672">-&gt;</span>irq);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">irqreturn_t</span> (<span style="color:#f92672">*</span>handler_fn)(<span style="color:#66d9ef">struct</span> irq_desc <span style="color:#f92672">*</span>desc,
</span></span><span style="display:flex;"><span>               <span style="color:#66d9ef">struct</span> irqaction <span style="color:#f92672">*</span>action);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (force_irqthreads <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">test_bit</span>(IRQTF_FORCED_THREAD,
</span></span><span style="display:flex;"><span>                         <span style="color:#f92672">&amp;</span>action<span style="color:#f92672">-&gt;</span>thread_flags))
</span></span><span style="display:flex;"><span>          handler_fn <span style="color:#f92672">=</span> irq_forced_thread_fn;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          handler_fn <span style="color:#f92672">=</span> irq_thread_fn;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">irq_wait_for_interrupt</span>(action)) {
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">irqreturn_t</span> action_ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>          action_ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">handler_fn</span>(desc, action);
</span></span><span style="display:flex;"><span>          <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">irqreturn_t</span>  <span style="color:#a6e22e">irq_thread_fn</span>(<span style="color:#66d9ef">struct</span> irq_desc <span style="color:#f92672">*</span>desc, <span style="color:#66d9ef">struct</span> irqaction <span style="color:#f92672">*</span>action)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">irqreturn_t</span> ret;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      ret <span style="color:#f92672">=</span> action<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">thread_fn</span>(action<span style="color:#f92672">-&gt;</span>irq, action<span style="color:#f92672">-&gt;</span>dev_id);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">irq_finalize_oneshot</span>(desc, action);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> ret;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="426ç¦æ­¢å¼€å¯ä¸­æ–­">4.2.6ã€€ç¦æ­¢/å¼€å¯ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#426ç¦æ­¢å¼€å¯ä¸­æ–­">#</a></h3>
<p>â€‚è½¯ä»¶å¯ä»¥ç¦æ­¢ä¸­æ–­ï¼Œä½¿å¤„ç†å™¨ä¸å“åº”æ‰€æœ‰ä¸­æ–­è¯·æ±‚ï¼Œä½†æ˜¯ä¸å¯å±è”½ä¸­æ–­ï¼ˆNon Maskable Interruptï¼ŒNMIï¼‰æ˜¯ä¸ªä¾‹å¤–ï¼Œæ¥å£ï¼š  <br>
â€ƒ(1)local_irq_disable()   <br>
â€ƒ(2)local_irq_save(flags) å…ˆæŠŠä¸­æ–­çŠ¶æ€ä¿å­˜åœ¨å‚æ•°flagsä¸­ï¼Œç„¶åç¦æ­¢ä¸­æ–­ <br></p>
<p>â€‚å¼€å¯ä¸­æ–­çš„æ¥å£ <br>
â€ƒ(1)local_irq_enable()  <br>
â€ƒ(2)local_irq_restore(flags)  æ¢å¤æœ¬åœ°å¤„ç†å™¨çš„ä¸­æ–­çŠ¶æ€  <br></p>
<p>â€‚ARM64æ¶æ„ç¦æ­¢ä¸­æ–­çš„å‡½æ•°local_irq_disable()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">local_irq_disable</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">raw_local_irq_disable</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">arch_local_irq_disable</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/irqflags.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸­æ–­æ©ç ä½è®¾ç½®æˆ1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">arch_local_irq_disable</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;msr       daifset, #2       // arch_local_irq_disable&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚ARM64æ¶æ„å¼€å¯ä¸­æ–­çš„å‡½æ•°local_irq_enable()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">local_irq_enable</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">raw_local_irq_enable</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">arch_local_irq_enable</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/irqflags.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ä¸­æ–­æ©ç ä½è®¾ç½®æˆ0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">arch_local_irq_enable</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#e6db74">&#34;msr       daifclr, #2     // arch_local_irq_enable&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="427ç¦æ­¢å¼€å¯å•ä¸ªä¸­æ–­">4.2.7ã€€ç¦æ­¢/å¼€å¯å•ä¸ªä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#427ç¦æ­¢å¼€å¯å•ä¸ªä¸­æ–­">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ç¦æ­¢å•ä¸ªä¸­æ–­çš„å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">disable_irq</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¼€å¯å•ä¸ªä¸­æ–­çš„å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">enable_irq</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> irq);
</span></span></code></pre></div><h3 id="428ä¸­æ–­äº²å’Œæ€§">4.2.8ã€€ä¸­æ–­äº²å’Œæ€§<a hidden class="anchor" aria-hidden="true" href="#428ä¸­æ–­äº²å’Œæ€§">#</a></h3>
<p>â€‚è®¾ç½®ä¸­æ–­äº²å’Œæ€§ï¼Œå…è®¸ä¸­æ–­æ§åˆ¶å™¨æŠŠæŸä¸ªä¸­æ–­è½¬å‘ç»™å“ªäº›å¤„ç†å™¨ï¼Œæœ‰ä¸¤ç§é…ç½®æ–¹æ³•  <br>
â€ƒ(1)å†™æ–‡ä»¶â€œ/proc/irq/IRQ#/smp_affinityâ€ï¼Œå‚æ•°æ˜¯ä½æ©ç   <br>
â€ƒ(2)æ–‡ä»¶â€œ/proc/irq/IRQ#/smp_affinity_listâ€ï¼Œå‚æ•°æ˜¯å¤„ç†å™¨åˆ—è¡¨  <br></p>
<h3 id="429å¤„ç†å™¨é—´ä¸­æ–­">4.2.9ã€€å¤„ç†å™¨é—´ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#429å¤„ç†å™¨é—´ä¸­æ–­">#</a></h3>
<p>â€‚å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªå¤„ç†å™¨å¯ä»¥å‘å…¶ä»–å¤„ç†å™¨å‘é€ä¸­æ–­  <br></p>
<p>â€‚å¤„ç†å¤„ç†å™¨é—´ä¸­æ–­çš„æ‰§è¡Œæµç¨‹</p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221128232922.png" alt="20221128232922"  />
</p>
<center>å¤„ç†å¤„ç†å™¨é—´ä¸­æ–­</center>
<h2 id="43ä¸­æ–­ä¸‹åŠéƒ¨">4.3ã€€ä¸­æ–­ä¸‹åŠéƒ¨<a hidden class="anchor" aria-hidden="true" href="#43ä¸­æ–­ä¸‹åŠéƒ¨">#</a></h2>
<p>â€‚ä¸­æ–­å¤„ç†ç¨‹åºåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸ŠåŠéƒ¨ï¼ˆtop halfï¼Œthï¼‰åœ¨å…³é—­ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œåªåšå¯¹æ—¶é—´éå¸¸æ•æ„Ÿã€ä¸ç¡¬ä»¶ç›¸å…³æˆ–è€…ä¸èƒ½è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­çš„å·¥ä½œï¼›ä¸‹åŠéƒ¨ï¼ˆbottom halfï¼Œbhï¼‰åœ¨å¼€å¯ä¸­æ–­çš„æƒ…å†µä¸‹æ‰§è¡Œï¼Œå¯ä»¥è¢«å…¶ä»–ä¸­æ–­æ‰“æ–­  <br>
â€‚ä¸ŠåŠéƒ¨ç§°ä¸ºç¡¬ä¸­æ–­ï¼ˆhardirqï¼‰ï¼Œä¸‹åŠéƒ¨æœ‰3ç§ï¼šè½¯ä¸­æ–­ï¼ˆsoftirqï¼‰ã€å°ä»»åŠ¡ï¼ˆtaskletï¼‰å’Œå·¥ä½œé˜Ÿåˆ—ï¼ˆworkqueueï¼‰ <br></p>
<h3 id="431è½¯ä¸­æ–­">4.3.1ã€€è½¯ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#431è½¯ä¸­æ–­">#</a></h3>
<p>â€‚å†…æ ¸å®šä¹‰äº†ä¸€å¼ è½¯ä¸­æ–­å‘é‡è¡¨ï¼Œæ¯ç§è½¯ä¸­æ–­æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œå¯¹åº”ä¸€ä¸ªsoftirq_actionå®ä¾‹ï¼Œsoftirq_actionå®ä¾‹çš„æˆå‘˜actionæ˜¯å¤„ç†å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/softirq.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/interrupt.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> softirq_action
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>action)(<span style="color:#66d9ef">struct</span> softirq_action <span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h4 id="1è½¯ä¸­æ–­çš„ç§ç±»">1ï¼è½¯ä¸­æ–­çš„ç§ç±»<a hidden class="anchor" aria-hidden="true" href="#1è½¯ä¸­æ–­çš„ç§ç±»">#</a></h4>
<p>â€‚å†…æ ¸å®šä¹‰äº†10ç§è½¯ä¸­æ–­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/interrupt.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">enum</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      HI_SOFTIRQ<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,    <span style="color:#75715e">// é«˜ä¼˜å…ˆçº§çš„å°ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      TIMER_SOFTIRQ,   <span style="color:#75715e">// å®šæ—¶å™¨è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      NET_TX_SOFTIRQ,  <span style="color:#75715e">// ç½‘ç»œæ ˆå‘é€æŠ¥æ–‡çš„è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      NET_RX_SOFTIRQ,  <span style="color:#75715e">// ç½‘ç»œæ ˆæ¥æ”¶æŠ¥æ–‡çš„è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      BLOCK_SOFTIRQ,   <span style="color:#75715e">// å—è®¾å¤‡è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      IRQ_POLL_SOFTIRQ, <span style="color:#75715e">// æ”¯æŒI/Oè½®è¯¢çš„å—è®¾å¤‡è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      TASKLET_SOFTIRQ,  <span style="color:#75715e">// ä½ä¼˜å…ˆçº§çš„å°ä»»åŠ¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      SCHED_SOFTIRQ,    <span style="color:#75715e">// è°ƒåº¦è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      HRTIMER_SOFTIRQ, <span style="color:#75715e">/* æ²¡æœ‰ä½¿ç”¨ï¼Œä½†æ˜¯ä¿ç•™ï¼Œå› ä¸ºæœ‰äº›å·¥å…·ä¾èµ–è¿™ä¸ªç¼–å· */</span>
</span></span><span style="display:flex;"><span>      RCU_SOFTIRQ,     <span style="color:#75715e">/* RCUè½¯ä¸­æ–­åº”è¯¥æ€»æ˜¯æœ€åä¸€ä¸ªè½¯ä¸­æ–­ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      NR_SOFTIRQS
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h4 id="2æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°">2ï¼æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°<a hidden class="anchor" aria-hidden="true" href="#2æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°">#</a></h4>
<p>â€‚open_softirq()ç”¨æ¥æ³¨å†Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ï¼Œåœ¨è½¯ä¸­æ–­å‘é‡è¡¨ä¸­ä¸ºæŒ‡å®šçš„è½¯ä¸­æ–­ç¼–å·è®¾ç½®å¤„ç†å‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/softirq.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">open_softirq</span>(<span style="color:#66d9ef">int</span> nr, <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>action)(<span style="color:#66d9ef">struct</span> softirq_action <span style="color:#f92672">*</span>))
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     softirq_vec[nr].action <span style="color:#f92672">=</span> action;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="3è§¦å‘è½¯ä¸­æ–­">3ï¼è§¦å‘è½¯ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#3è§¦å‘è½¯ä¸­æ–­">#</a></h4>
<p>å‡½æ•°raise_softirqç”¨æ¥è§¦å‘è½¯ä¸­æ–­ï¼Œå‚æ•°æ˜¯è½¯ä¸­æ–­ç¼–å·ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">raise_softirq</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> nr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raise_softirq</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">raise_softirq_irqoff</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">__raise_softirq_irqoff</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// kernel/softirq.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__raise_softirq_irqoff</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> nr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">or_softirq_pending</span>(<span style="color:#ae81ff">1UL</span> <span style="color:#f92672">&lt;&lt;</span> nr);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å®or_softirq_pendingå±•å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>irq_stat[<span style="color:#a6e22e">smp_processor_id</span>()].__softirq_pending <span style="color:#f92672">|=</span> (<span style="color:#ae81ff">1UL</span> <span style="color:#f92672">&lt;&lt;</span> nr);
</span></span></code></pre></div><h4 id="4æ‰§è¡Œè½¯ä¸­æ–­">4.æ‰§è¡Œè½¯ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#4æ‰§è¡Œè½¯ä¸­æ–­">#</a></h4>
<p>â€‚ä¸­æ–­å¤„ç†ç¨‹åºçš„ååŠéƒ¨åˆ†ï¼Œè°ƒç”¨å‡½æ•°irq_exit()ä»¥é€€å‡ºä¸­æ–­ä¸Šä¸‹æ–‡ï¼Œå¤„ç†è½¯ä¸­æ–­</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/softirq.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">irq_exit</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">preempt_count_sub</span>(HARDIRQ_OFFSET);
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">in_interrupt</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">local_softirq_pending</span>())
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">invoke_softirq</span>();
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/softirq.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">invoke_softirq</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">ksoftirqd_running</span>())
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>force_irqthreads) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">__do_softirq</span>();
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wakeup_softirqd</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚å‡½æ•°__do_softirqæ˜¯æ‰§è¡Œè½¯ä¸­æ–­çš„æ ¸å¿ƒå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/softirq.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define MAX_SOFTIRQ_TIME  msecs_to_jiffies(2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MAX_SOFTIRQ_RESTART 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage __visible <span style="color:#66d9ef">void</span> __softirq_entry <span style="color:#a6e22e">__do_softirq</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> end <span style="color:#f92672">=</span> jiffies <span style="color:#f92672">+</span> MAX_SOFTIRQ_TIME;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> old_flags <span style="color:#f92672">=</span> current<span style="color:#f92672">-&gt;</span>flags;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> max_restart <span style="color:#f92672">=</span> MAX_SOFTIRQ_RESTART;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> softirq_action <span style="color:#f92672">*</span>h;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">bool</span> in_hardirq;
</span></span><span style="display:flex;"><span>	__u32 pending;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> softirq_bit;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	pending <span style="color:#f92672">=</span> <span style="color:#a6e22e">local_softirq_pending</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__local_bh_disable_ip</span>(_RET_IP_, SOFTIRQ_OFFSET);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	restart:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">set_softirq_pending</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">local_irq_enable</span>();
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	h <span style="color:#f92672">=</span> softirq_vec;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> ((softirq_bit <span style="color:#f92672">=</span> <span style="color:#a6e22e">ffs</span>(pending))) {
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		h <span style="color:#f92672">+=</span> softirq_bit <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		h<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">action</span>(h);
</span></span><span style="display:flex;"><span>		<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>		h<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		pending <span style="color:#f92672">&gt;&gt;=</span> softirq_bit;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">local_irq_disable</span>();
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	pending <span style="color:#f92672">=</span> <span style="color:#a6e22e">local_softirq_pending</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (pending) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">time_before</span>(jiffies, end) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">need_resched</span>() <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">--</span>max_restart)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">goto</span> restart;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wakeup_softirqd</span>();
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__local_bh_enable</span>(SOFTIRQ_OFFSET);
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="5æŠ¢å è®¡æ•°å™¨">5ï¼æŠ¢å è®¡æ•°å™¨<a hidden class="anchor" aria-hidden="true" href="#5æŠ¢å è®¡æ•°å™¨">#</a></h4>
<p>â€‚è¿›ç¨‹çš„thread_infoç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨ï¼šint preempt_countï¼Œå®ƒç”¨æ¥è¡¨ç¤ºå½“å‰è¿›ç¨‹èƒ½ä¸èƒ½è¢«æŠ¢å ,å¯é€šè¿‡æŠ¢å è®¡æ•°å™¨åˆ¤æ–­å¤„åœ¨ä»€ä¹ˆåœºæ™¯  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// nclude/linux/preempt.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define in_irq()             (hardirq_count())  </span><span style="color:#75715e">// æ­£åœ¨æ‰§è¡Œç¡¬ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define in_softirq()         (softirq_count())  </span><span style="color:#75715e">// ç¦æ­¢è½¯ä¸­æ–­å’Œæ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define in_interrupt()       (irq_count())  </span><span style="color:#75715e">// æ­£åœ¨æ‰§è¡Œä¸å¯å±è”½ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define in_serving_softirq() (softirq_count() &amp; SOFTIRQ_OFFSET)  </span><span style="color:#75715e">// æ­£åœ¨æ‰§è¡Œè½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define in_nmi()             (preempt_count() &amp; NMI_MASK)  </span><span style="color:#75715e">// ä¸å¯å±è”½ä¸­æ–­åœºæ™¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define in_task()            (!(preempt_count() &amp; \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                             (NMI_MASK | HARDIRQ_MASK | SOFTIRQ_OFFSET)))  </span><span style="color:#75715e">// è¿›ç¨‹ä¸Šä¸‹æ–‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define hardirq_count() (preempt_count() &amp; HARDIRQ_MASK)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define softirq_count() (preempt_count() &amp; SOFTIRQ_MASK)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define irq_count()     (preempt_count() &amp; (HARDIRQ_MASK | SOFTIRQ_MASK \
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                    | NMI_MASK))
</span></span></span></code></pre></div><h4 id="6ç¦æ­¢å¼€å¯è½¯ä¸­æ–­">6ï¼ç¦æ­¢/å¼€å¯è½¯ä¸­æ–­<a hidden class="anchor" aria-hidden="true" href="#6ç¦æ­¢å¼€å¯è½¯ä¸­æ–­">#</a></h4>
<p>â€‚ç¦æ­¢è½¯ä¸­æ–­çš„å‡½æ•°æ˜¯local_bh_disable()</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>include<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>bottom_half.h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">local_bh_disable</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">__local_bh_disable_ip</span>(_THIS_IP_, SOFTIRQ_DISABLE_OFFSET);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> __always_inline <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__local_bh_disable_ip</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> ip, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cnt)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">preempt_count_add</span>(cnt);
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">barrier</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include<span style="color:#f92672">/</span>linux<span style="color:#f92672">/</span>preempt.h
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define SOFTIRQ_DISABLE_OFFSET    (2 * SOFTIRQ_OFFSET)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¼€å¯è½¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">local_bh_enable</span>()
</span></span></code></pre></div><h3 id="432-å°ä»»åŠ¡-tasklet">4.3.2 å°ä»»åŠ¡ tasklet<a hidden class="anchor" aria-hidden="true" href="#432-å°ä»»åŠ¡-tasklet">#</a></h3>
<p>â€‚å°ä»»åŠ¡ï¼ˆtaskletï¼‰æ˜¯åŸºäºè½¯ä¸­æ–­å®ç°</p>
<h4 id="1æ•°æ®ç»“æ„-5">1.æ•°æ®ç»“æ„<a hidden class="anchor" aria-hidden="true" href="#1æ•°æ®ç»“æ„-5">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/interrupt.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> tasklet_struct
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">struct</span> tasklet_struct <span style="color:#f92672">*</span>next;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> state;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">atomic_t</span> count;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>func)(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>);
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> data;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h4 id="2ç¼–ç¨‹æ¥å£">2ï¼ç¼–ç¨‹æ¥å£<a hidden class="anchor" aria-hidden="true" href="#2ç¼–ç¨‹æ¥å£">#</a></h4>
<h4 id="3æŠ€æœ¯åŸç†">3ï¼æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#3æŠ€æœ¯åŸç†">#</a></h4>
<h3 id="433å·¥ä½œé˜Ÿåˆ—">4.3.3ã€€å·¥ä½œé˜Ÿåˆ—<a hidden class="anchor" aria-hidden="true" href="#433å·¥ä½œé˜Ÿåˆ—">#</a></h3>
<h2 id="44ç³»ç»Ÿè°ƒç”¨">4.4ã€€ç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#44ç³»ç»Ÿè°ƒç”¨">#</a></h2>
<p>â€‚ç³»ç»Ÿè°ƒç”¨æ˜¯å†…æ ¸ç»™ç”¨æˆ·ç¨‹åºæä¾›çš„ç¼–ç¨‹æ¥å£ã€‚ç”¨æˆ·ç¨‹åºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œé€šå¸¸ä½¿ç”¨glibcåº“é’ˆå¯¹å•ä¸ªç³»ç»Ÿè°ƒç”¨å°è£…çš„å‡½æ•°ã€‚glibcåº“æ²¡æœ‰é’ˆå¯¹æŸä¸ªç³»ç»Ÿè°ƒç”¨å°è£…å‡½æ•°ï¼Œç”¨æˆ·ç¨‹åºå¯é€šç”¨çš„å°è£…å‡½æ•°syscall()  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define _GNU_SOURCE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/syscall.h&gt;   /* å®šä¹‰ SYS_xxx */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">long</span> <span style="color:#a6e22e">syscall</span>(<span style="color:#66d9ef">long</span> number, ...);  <span style="color:#75715e">// numberç³»ç»Ÿè°ƒç”¨å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿”å›å€¼  0æˆåŠŸï¼Œ-1é”™è¯¯ï¼Œé”™è¯¯å·åœ¨errno
</span></span></span></code></pre></div><p>â€‚åº”ç”¨ç¨‹åºä½¿ç”¨ç³»ç»Ÿè°ƒç”¨fork()åˆ›å»ºå­è¿›ç¨‹ï¼Œæœ‰ä¸¤ç§è°ƒç”¨æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">syscall</span>(SYS_fork);
</span></span></code></pre></div><p>â€‚ARM64å¤„ç†å™¨æä¾›çš„ç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤æ˜¯svc  <br>
â€ƒ(1)64ä½åº”ç”¨ç¨‹åºä½¿ç”¨å¯„å­˜å™¨x8ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·  <br>
â€ƒ(2)å¯„å­˜å™¨x0ï½x6æœ€å¤šå¯ä»¥ä¼ é€’7ä¸ªå‚æ•°  <br>
â€ƒ(3)ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œä½¿ç”¨å¯„å­˜å™¨x0å­˜æ”¾è¿”å›å€¼  <br></p>
<h3 id="441-å®šä¹‰ç³»ç»Ÿè°ƒç”¨">4.4.1 å®šä¹‰ç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#441-å®šä¹‰ç³»ç»Ÿè°ƒç”¨">#</a></h3>
<p>â€‚Linuxå†…æ ¸ä½¿ç”¨å®SYSCALL_DEFINEå®šä¹‰ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ›å»ºå­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨fork <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// kernel/fork.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">SYSCALL_DEFINE0</span>(fork)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_MMU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">_do_fork</span>(SIGCHLD, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, NULL, NULL, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#75715e">/* å¦‚æœå¤„ç†å™¨æ²¡æœ‰å†…å­˜ç®¡ç†å•å…ƒï¼Œé‚£ä¹ˆä¸æ”¯æŒ */</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span>EINVAL;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SYSCALL_DEFINE0(fork) å±•å¼€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">sys_fork</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// asmlinkage è¡¨ç¤ºCè¯­è¨€å‡½æ•°å¯ä»¥è¢«æ±‡ç¼–ä»£ç è°ƒç”¨
</span></span></span></code></pre></div><p>â€‚ARM64æ¶æ„å®šä¹‰çš„ç³»ç»Ÿè°ƒç”¨è¡¨sys_call_table</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/sys.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#undef __SYSCALL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __SYSCALL(nr, sym)     [nr] = sym,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">const</span> sys_call_table[__NR_syscalls] <span style="color:#a6e22e">__aligned</span>(<span style="color:#ae81ff">4096</span>) <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>     [<span style="color:#ae81ff">0</span> ... __NR_syscalls <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> sys_ni_syscall,
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm/unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>ARM64æ¶æ„ï¼Œå¤´æ–‡ä»¶â€œasm/unistd.hâ€æ˜¯â€œarch/arm64/include/asm/unistd.hâ€ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/unistd.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;uapi/asm/unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/uapi/asm/unistd.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;asm-generic/unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/asm-generic/unistd.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;uapi/asm-generic/unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/uapi/asm-generic/unistd.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define __NR_io_setup 0                                    </span><span style="color:#75715e">/* ç³»ç»Ÿè°ƒç”¨å·0 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__SC_COMP</span>(__NR_io_setup, sys_io_setup, compat_sys_io_setup) <span style="color:#75715e">/* [0] = sys_io_setup, */</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_fork 1079                </span><span style="color:#75715e">/* ç³»ç»Ÿè°ƒç”¨å·1079 */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_MMU
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__SYSCALL</span>(__NR_fork, sys_fork)        <span style="color:#75715e">/* [1079] = sys_fork, */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">__SYSCALL</span>(__NR_fork, sys_ni_syscall)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">/* CONFIG_MMU */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#undef __NR_syscalls
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define __NR_syscalls (__NR_fork+1)
</span></span></span></code></pre></div><h3 id="442-æ‰§è¡Œç³»ç»Ÿè°ƒç”¨">4.4.2 æ‰§è¡Œç³»ç»Ÿè°ƒç”¨<a hidden class="anchor" aria-hidden="true" href="#442-æ‰§è¡Œç³»ç»Ÿè°ƒç”¨">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨æŠŠç³»ç»Ÿè°ƒç”¨åˆ’åˆ†åˆ°åŒæ­¥å¼‚å¸¸ï¼Œåœ¨å¼‚å¸¸çº§åˆ«1çš„å¼‚å¸¸å‘é‡è¡¨ä¸­ï¼Œç³»ç»Ÿè°ƒç”¨çš„å…¥å£ï¼Œ64ä½åº”ç”¨ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æŒ‡ä»¤svcï¼Œç³»ç»Ÿè°ƒç”¨å…¥å£ el0_sync</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.align   <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>el0_sync:
</span></span><span style="display:flex;"><span>	kernel_entry <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	mrs   x25, esr_el1                 <span style="color:#75715e">// è¯»å¼‚å¸¸ç—‡çŠ¶å¯„å­˜å™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lsr   x24, x25, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SHIFT  <span style="color:#75715e">// å¼‚å¸¸ç±»åˆ«
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	cmp   x24, <span style="color:#960050;background-color:#1e0010">#</span>ESR_ELx_EC_SVC64       <span style="color:#75715e">// 64ä½ç³»ç»Ÿè°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.eq el0_svc
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span></code></pre></div><p>â€‚el0_svcè´Ÿè´£æ‰§è¡Œç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * è¿™äº›æ˜¯ç³»ç»Ÿè°ƒç”¨å¤„ç†ç¨‹åºä½¿ç”¨çš„å¯„å­˜å™¨ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å…è®¸æˆ‘ä»¬ç†è®ºä¸Šæœ€å¤šä¼ é€’7ä¸ªå‚æ•°ç»™ä¸€ä¸ªå‡½æ•° â€“ x0ï½x6
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * x7ä¿ç•™ï¼Œç”¨äº32ä½æ¨¡å¼çš„ç³»ç»Ÿè°ƒç”¨å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>sc_nr .req x25           <span style="color:#75715e">// ç³»ç»Ÿè°ƒç”¨çš„æ•°é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>scno      .req  x26      <span style="color:#75715e">// ç³»ç»Ÿè°ƒç”¨å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>stbl      .req  x27      <span style="color:#75715e">// ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>tsk       .req  x28      <span style="color:#75715e">// å½“å‰è¿›ç¨‹çš„thread_infoç»“æ„ä½“çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.align   <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>el0_svc:
</span></span><span style="display:flex;"><span>	adrp    stbl, sys_call_table      <span style="color:#75715e">// åŠ è½½ç³»ç»Ÿè°ƒç”¨è¡¨çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	uxtw    scno, w8         <span style="color:#75715e">// å¯„å­˜å™¨w8é‡Œé¢çš„ç³»ç»Ÿè°ƒç”¨å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	mov     sc_nr, <span style="color:#960050;background-color:#1e0010">#</span>__NR_syscalls
</span></span><span style="display:flex;"><span>el0_svc_naked:               <span style="color:#75715e">// 32ä½ç³»ç»Ÿè°ƒç”¨çš„å…¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	stp   x0, scno, [sp, <span style="color:#960050;background-color:#1e0010">#</span>S_ORIG_X0]   <span style="color:#75715e">// ä¿å­˜åŸæ¥çš„x0å’Œç³»ç»Ÿè°ƒç”¨å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	enable_dbg_and_irq
</span></span><span style="display:flex;"><span>	ct_user_exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// ptraceè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ï¼Œè·³è½¬åˆ°__sys_traceå¤„ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ldr   x16, [tsk, <span style="color:#960050;background-color:#1e0010">#</span>TSK_TI_FLAGS]   <span style="color:#75715e">// æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨é’©å­ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	tst   x16, <span style="color:#960050;background-color:#1e0010">#</span>_TIF_SYSCALL_WORK
</span></span><span style="display:flex;"><span>	b.ne      __sys_trace
</span></span><span style="display:flex;"><span>	cmp     scno, sc_nr         <span style="color:#75715e">// æ£€æŸ¥ç³»ç»Ÿè°ƒç”¨å·æ˜¯å¦è¶…è¿‡ä¸Šé™
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b.hs      ni_sys
</span></span><span style="display:flex;"><span>	ldr   x16, [stbl, scno, lsl <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">3</span>]   <span style="color:#75715e">// ç³»ç»Ÿè°ƒç”¨è¡¨è¡¨é¡¹çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	blr   x16                         <span style="color:#75715e">// è°ƒç”¨sys_*å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b   ret_fast_syscall
</span></span><span style="display:flex;"><span>	ni_sys:
</span></span><span style="display:flex;"><span>	mov   x0, sp
</span></span><span style="display:flex;"><span>	bl   do_ni_syscall
</span></span><span style="display:flex;"><span>	b   ret_fast_syscall
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENDPROC</span>(el0_svc) 
</span></span></code></pre></div><p>â€‚ret_fast_syscallä»ç³»ç»Ÿè°ƒç”¨è¿”å›ç”¨æˆ·ç©ºé—´</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> ret_fast_syscall:
</span></span><span style="display:flex;"><span>	disable_irq
</span></span><span style="display:flex;"><span>	str   x0, [sp, <span style="color:#960050;background-color:#1e0010">#</span>S_X0]   <span style="color:#75715e">/* DEFINE(S_X0, offsetof(struct pt_regs, regs[0])); */</span>
</span></span><span style="display:flex;"><span>	ldr   x1, [tsk, <span style="color:#960050;background-color:#1e0010">#</span>TSK_TI_FLAGS]
</span></span><span style="display:flex;"><span>	and   x2, x1, <span style="color:#960050;background-color:#1e0010">#</span>_TIF_SYSCALL_WORK
</span></span><span style="display:flex;"><span>	cbnz    x2, ret_fast_syscall_trace
</span></span><span style="display:flex;"><span>	and   x2, x1, <span style="color:#960050;background-color:#1e0010">#</span>_TIF_WORK_MASK
</span></span><span style="display:flex;"><span>	cbnz    x2, work_pending
</span></span><span style="display:flex;"><span>	enable_step_tsk x1, x2
</span></span><span style="display:flex;"><span>	kernel_exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	ret_fast_syscall_trace:
</span></span><span style="display:flex;"><span>	enable_irq                       <span style="color:#75715e">// å¼€å¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b   __sys_trace_return_skipped    <span style="color:#75715e">// æˆ‘ä»¬å·²ç»ä¿å­˜äº†x0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>work_pending:
</span></span><span style="display:flex;"><span>	mov   x0, sp                     <span style="color:#75715e">// &#39;regs&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	bl   do_notify_resume
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_TRACE_IRQFLAGS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 	bl   trace_hardirqs_on           <span style="color:#75715e">// åœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œæ—¶å¼€å¯ä¸­æ–­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ldr   x1, [tsk, <span style="color:#960050;background-color:#1e0010">#</span>TSK_TI_FLAGS]   <span style="color:#75715e">// é‡æ–°æ£€æŸ¥å•æ­¥æ‰§è¡Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	b   finish_ret_to_user
</span></span><span style="display:flex;"><span>ret_to_user:
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>finish_ret_to_user:
</span></span><span style="display:flex;"><span>	enable_step_tsk x1, x2
</span></span><span style="display:flex;"><span>	kernel_exit <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ENDPROC</span>(ret_to_user)
</span></span></code></pre></div><p>â€‚work_pendingè°ƒç”¨å‡½æ•°do_notify_resume</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/kernel/signal.c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>asmlinkage <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">do_notify_resume</span>(<span style="color:#66d9ef">struct</span> pt_regs <span style="color:#f92672">*</span>regs,
</span></span><span style="display:flex;"><span>                 <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> thread_flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">do</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_NEED_RESCHED) {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">schedule</span>();
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">local_irq_enable</span>();
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_UPROBE)
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">uprobe_notify_resume</span>(regs);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_SIGPENDING)
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">do_signal</span>(regs);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_NOTIFY_RESUME) {
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">clear_thread_flag</span>(TIF_NOTIFY_RESUME);
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">tracehook_notify_resume</span>(regs);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_FOREIGN_FPSTATE)
</span></span><span style="display:flex;"><span>					<span style="color:#a6e22e">fpsimd_restore_current_state</span>();
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">local_irq_disable</span>();
</span></span><span style="display:flex;"><span>		thread_flags <span style="color:#f92672">=</span> <span style="color:#a6e22e">READ_ONCE</span>(<span style="color:#a6e22e">current_thread_info</span>()<span style="color:#f92672">-&gt;</span>flags);
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">while</span> (thread_flags <span style="color:#f92672">&amp;</span> _TIF_WORK_MASK);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="ç¬¬5ç« -å†…æ ¸äº’æ–¥æŠ€æœ¯">ç¬¬5ç«  å†…æ ¸äº’æ–¥æŠ€æœ¯<a hidden class="anchor" aria-hidden="true" href="#ç¬¬5ç« -å†…æ ¸äº’æ–¥æŠ€æœ¯">#</a></h1>
<p>â€‚ä¸´ç•ŒåŒºçš„æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿æˆ–è€…å¯èƒ½ç¡çœ äº’æ–¥æŠ€æœ¯  <br>
â€ƒ(1)ä¿¡å·é‡  <br>
â€ƒ(2)è¯»å†™ä¿¡å·é‡  <br>
â€ƒ(3)äº’æ–¥é”   <br>
â€ƒ(4)å®æ—¶äº’æ–¥é”   <br>
â€‚ä¸´ç•ŒåŒºçš„æ‰§è¡Œæ—¶é—´å¾ˆçŸ­ï¼Œå¹¶ä¸”ä¸ä¼šç¡çœ  äº’æ–¥æŠ€æœ¯ <br>
â€ƒ(1)åŸå­å˜é‡   <br>
â€ƒ(2)è‡ªæ—‹é”   <br>
â€ƒ(3)è¯»å†™é”   <br>
â€ƒ(4)é¡ºåºé”   <br>
â€‚è¿›ç¨‹äº’æ–¥æŠ€æœ¯  <br>
â€ƒ(1)ç¦æ­¢å†…æ ¸æŠ¢å   <br>
â€ƒ(2)ç¦æ­¢è½¯ä¸­æ–­   <br>
â€ƒ(3)ç¦æ­¢ç¡¬ä¸­æ–­    <br>
â€‚å…ä½¿ç”¨é”çš„äº’æ–¥æŠ€æœ¯  <br>
â€ƒ(1)æ¯å¤„ç†å™¨å˜é‡  <br>
â€ƒ(2)æ¯å¤„ç†å™¨è®¡æ•°å™¨  <br>
â€ƒ(3)å†…å­˜å±éšœ   <br>
â€ƒ(4)è¯»-å¤åˆ¶æ›´æ–°(Read-Copy Update RCU)  <br>
â€ƒ(5)å¯ç¡çœ RCU  <br></p>
<p>â€‚å†…æ ¸æä¾›äº†æ­»é”æ£€æµ‹å·¥å…·lockdep <br></p>
<h2 id="51-ä¿¡å·é‡">5.1 ä¿¡å·é‡<a hidden class="anchor" aria-hidden="true" href="#51-ä¿¡å·é‡">#</a></h2>
<p>â€‚ä¿¡å·é‡å…è®¸å¤šä¸ªè¿›ç¨‹åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œä¿¡å·é‡çš„è®¡æ•°å€¼è®¾ç½®ä¸º1ï¼Œå³äºŒå€¼ä¿¡å·é‡ï¼Œè¿™ç§ä¿¡å·é‡ç§°ä¸ºäº’æ–¥ä¿¡å·é‡ï¼Œé€‚åˆä¿æŠ¤æ¯”è¾ƒé•¿çš„ä¸´ç•ŒåŒº    <br>
â€‚å†…æ ¸ä½¿ç”¨çš„ä¿¡å·é‡å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/semaphore.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> semaphore {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">raw_spinlock_t</span>   lock;  <span style="color:#75715e">// è‡ªæ—‹é”ï¼Œä¿æŠ¤ä¿¡å·é‡å…¶ä»–æˆå‘˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>     count;  <span style="color:#75715e">// è®¡æ•°å€¼ï¼Œå…è®¸å¤šå°‘ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒº
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">struct</span> list_head wait_list;  <span style="color:#75715e">// ç­‰å¾…è¿›å…¥ä¸´ç•ŒåŒºè¿›ç¨‹é“¾è¡¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><p>â€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// è·å–ä¿¡å·é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">down</span>(<span style="color:#66d9ef">struct</span> semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_interruptible</span>(<span style="color:#66d9ef">struct</span> semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_killable</span>(<span style="color:#66d9ef">struct</span> semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_trylock</span>(<span style="color:#66d9ef">struct</span> semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_timeout</span>(<span style="color:#66d9ef">struct</span> semaphore <span style="color:#f92672">*</span>sem, <span style="color:#66d9ef">long</span> jiffies);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾ä¿¡å·é‡å‡½æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">up</span>(<span style="color:#66d9ef">struct</span> semaphore <span style="color:#f92672">*</span>sem);
</span></span></code></pre></div><h2 id="52-è¯»å†™ä¿¡å·é‡">5.2 è¯»å†™ä¿¡å·é‡<a hidden class="anchor" aria-hidden="true" href="#52-è¯»å†™ä¿¡å·é‡">#</a></h2>
<p>â€‚è¯»å†™ä¿¡å·é‡,é€‚åˆåœ¨ä»¥è¯»ä¸ºä¸»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/rwsem.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> rw_semaphore {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">atomic_long_t</span> count;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> list_head wait_list;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">raw_spinlock_t</span> wait_lock;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct <span style="color:#f92672">*</span>owner;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>åˆå§‹åŒ–ï¼Œä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆå§‹åŒ–é™æ€è¯»å†™ä¿¡å·é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DECLARE_RWSEM</span>(name);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–è¯»å†™ä¿¡å·é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">init_rwsem</span>(sem);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”³è¯·è¯»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">down_read</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem)<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_read_trylock</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem)<span style="color:#960050;background-color:#1e0010">ï¼›</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾è¯»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">up_read</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”³è¯·å†™é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">down_write</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_write_killable</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">down_write_trylock</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å†™é”é™çº§ä¸ºè¯»é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">downgrade_write</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾å†™é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">up_write</span>(<span style="color:#66d9ef">struct</span> rw_semaphore <span style="color:#f92672">*</span>sem);
</span></span></code></pre></div><h2 id="53-äº’æ–¥é”">5.3 äº’æ–¥é”<a hidden class="anchor" aria-hidden="true" href="#53-äº’æ–¥é”">#</a></h2>
<p>â€‚äº’æ–¥é”åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è¿›å…¥ä¸´ç•ŒåŒºï¼Œé€‚åˆä¿æŠ¤æ¯”è¾ƒé•¿çš„ä¸´ç•ŒåŒº</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/mutex.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> mutex {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">atomic_long_t</span>  owner;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">spinlock_t</span>     wait_lock;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef CONFIG_MUTEX_SPIN_ON_OWNER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> optimistic_spin_queue osq; 
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">struct</span> list_head wait_list;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚ä½¿ç”¨äº’æ–¥é”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆå§‹åŒ–é™æ€äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DEFINE_MUTEX</span>(mutexname);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mutex_init</span>(mutex);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”³è¯·äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mutex_lock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mutex_lock_interruptible</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mutex_lock_killable</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">mutex_trylock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">mutex_unlock</span>(<span style="color:#66d9ef">struct</span> mutex <span style="color:#f92672">*</span>lock);
</span></span></code></pre></div><h2 id="54-å®æ—¶äº’æ–¥é”">5.4 å®æ—¶äº’æ–¥é”<a hidden class="anchor" aria-hidden="true" href="#54-å®æ—¶äº’æ–¥é”">#</a></h2>
<p>â€‚å®æ—¶äº’æ–¥é”æ˜¯å¯¹äº’æ–¥é”çš„æ”¹è¿›ï¼Œå®ç°äº†ä¼˜å…ˆçº§ç»§æ‰¿(priority inheritance)ï¼Œè§£å†³äº†ä¼˜å…ˆçº§åè½¬(priority inversion)é—®é¢˜</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/rtmutex.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> rt_mutex {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">raw_spinlock_t</span>     wait_lock;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rb_root     waiters;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> rb_node     <span style="color:#f92672">*</span>waiters_leftmost;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">struct</span> task_struct    <span style="color:#f92672">*</span>owner;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>â€‚åˆå§‹åŒ–ï¼Œä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆå§‹åŒ–é™æ€å®æ—¶äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DEFINE_RT_MUTEX</span>(mutexname);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–å®æ—¶äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">rt_mutex_init</span>(mutex);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”³è¯·å®æ—¶äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rt_mutex_lock</span>(<span style="color:#66d9ef">struct</span> rt_mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rt_mutex_lock_interruptible</span>(<span style="color:#66d9ef">struct</span> rt_mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rt_mutex_timed_lock</span>(<span style="color:#66d9ef">struct</span> rt_mutex <span style="color:#f92672">*</span>lock, <span style="color:#66d9ef">struct</span> hrtimer_sleeper <span style="color:#f92672">*</span>timeout);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">rt_mutex_trylock</span>(<span style="color:#66d9ef">struct</span> rt_mutex <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾å®æ—¶äº’æ–¥é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">rt_mutex_unlock</span>(<span style="color:#66d9ef">struct</span> rt_mutex <span style="color:#f92672">*</span>lock);
</span></span></code></pre></div><h2 id="55-åŸå­å˜é‡">5.5 åŸå­å˜é‡<a hidden class="anchor" aria-hidden="true" href="#55-åŸå­å˜é‡">#</a></h2>
<p>â€‚åŸå­å˜é‡ç”¨æ¥å®ç°å¯¹æ•´æ•°çš„äº’æ–¥è®¿é—®ï¼Œé€šå¸¸ç”¨æ¥å®ç°è®¡æ•°å™¨  <br>
â€‚å†…æ ¸å®šä¹‰äº†3ç§åŸå­å˜é‡</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ•´æ•°åŸå­å˜é‡ï¼Œæ•°æ®ç±»å‹æ˜¯atomic_t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/types.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> counter;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">atomic_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é•¿æ•´æ•°åŸå­å˜é‡ï¼Œæ•°æ®ç±»å‹æ˜¯atomic_long_t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 64ä½æ•´æ•°åŸå­å˜é‡ï¼Œæ•°æ®ç±»å‹æ˜¯atomic64_t
</span></span></span></code></pre></div><p>â€‚åŸå­å˜é‡ä½¿ç”¨æ–¹æ³•</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆå§‹åŒ–é™æ€åŸå­å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">atomic_t</span> <span style="color:#f92672">&lt;</span>name<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ATOMINC_INIT</span>(n);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŠ¨æ€åˆå§‹åŒ–åŸå­å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_set</span>(v, i);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¯»å–åŸå­å˜é‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_read</span>(v)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­å˜é‡åŠ iï¼Œå¹¶è¿”å›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_add_return</span>(i, v)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­å˜é‡våŠ i
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_add</span>(i, v)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­å˜é‡åŠ 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_inc</span>(v)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­å˜é‡vå‡i
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_sub</span>(i, v)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­å˜é‡å‡1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">atomic_dec</span>(v)
</span></span></code></pre></div><h3 id="arm64å¤„ç†å™¨çš„åŸå­å˜é‡å®ç°">ARM64å¤„ç†å™¨çš„åŸå­å˜é‡å®ç°<a hidden class="anchor" aria-hidden="true" href="#arm64å¤„ç†å™¨çš„åŸå­å˜é‡å®ç°">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨åŸå­å˜é‡æŒ‡ä»¤æ”¯æŒ  <br>
â€ƒ(1)ç‹¬å åŠ è½½æŒ‡ä»¤ldxr (load Exclusive Register)  <br>
â€ƒ(2)ç‹¬å å­˜å‚¨æŒ‡ä»¤stxr (Store Exclusive Register) <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ç‹¬å åŠ è½½æŒ‡ä»¤åŠ è½½32ä½æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ldxr <span style="color:#f92672">&lt;</span>Wt<span style="color:#f92672">&gt;</span>, [<span style="color:#f92672">&lt;</span>Xn<span style="color:#f92672">|</span>SP<span style="color:#f92672">&gt;</span>{,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>}]
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç‹¬å å­˜å‚¨æŒ‡ä»¤å­˜å‚¨32ä½æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>stxr <span style="color:#f92672">&lt;</span>Ws<span style="color:#f92672">&gt;</span>, <span style="color:#f92672">&lt;</span>Wt<span style="color:#f92672">&gt;</span>, [<span style="color:#f92672">&lt;</span>Xn<span style="color:#f92672">|</span>SP<span style="color:#f92672">&gt;</span>{,<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span>}]
</span></span><span style="display:flex;"><span><span style="color:#75715e">// åŸå­åŠ æ³•æŒ‡ä»¤staddæ“ä½œ32ä½æ•°æ®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>stadd <span style="color:#f92672">&lt;</span>Ws<span style="color:#f92672">&gt;</span>, [<span style="color:#f92672">&lt;</span>Xn<span style="color:#f92672">|</span>SP<span style="color:#f92672">&gt;</span>]
</span></span></code></pre></div><p>â€‚å‡½æ•°atomic_add(i, v)å®ç°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/atomic_ll_sc.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">atomic_add</span>(<span style="color:#66d9ef">int</span> i, <span style="color:#66d9ef">atomic_t</span> <span style="color:#f92672">*</span>v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> tmp;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> result;   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34;// atomic_add </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                    \
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   prfm   pstl1strm, %2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                         \
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;1:   ldxr   %w0, %2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                             \
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   &#34;</span> add <span style="color:#e6db74">&#34;   %w0, %w0, %w3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                      \
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   stxr   %w1, %w0, %2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>                          \
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   cbnz   %w1, 1b&#34;</span>                                 \
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;=&amp;r&#34;</span> (result), <span style="color:#e6db74">&#34;=&amp;r&#34;</span> (tmp), <span style="color:#e6db74">&#34;+Q&#34;</span> (v<span style="color:#f92672">-&gt;</span>counter)   \
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Ir&#34;</span> (i));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚åŸå­åŠ æ³•æŒ‡ä»¤staddå®ç°çš„å‡½æ•°atomic_add(i, v)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/atomic_lse.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">atomic_add</span>(<span style="color:#66d9ef">int</span> i, <span style="color:#66d9ef">atomic_t</span> <span style="color:#f92672">*</span>v)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">register</span> <span style="color:#66d9ef">int</span> w0 <span style="color:#66d9ef">asm</span> (<span style="color:#e6db74">&#34;w0&#34;</span>) <span style="color:#f92672">=</span> i;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">register</span> <span style="color:#66d9ef">atomic_t</span> <span style="color:#f92672">*</span>x1 <span style="color:#66d9ef">asm</span> (<span style="color:#e6db74">&#34;x1&#34;</span>) <span style="color:#f92672">=</span> v;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">asm</span> <span style="color:#66d9ef">volatile</span>(<span style="color:#e6db74">&#34; stadd    %w[i], %[v]</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>     \
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> [i] <span style="color:#e6db74">&#34;+r&#34;</span> (w0), [v] <span style="color:#e6db74">&#34;+Q&#34;</span> (v<span style="color:#f92672">-&gt;</span>counter)   \
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;r&#34;</span> (x1)                               \
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> );
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="56-è‡ªæ—‹é”">5.6 è‡ªæ—‹é”<a hidden class="anchor" aria-hidden="true" href="#56-è‡ªæ—‹é”">#</a></h2>
<p>â€‚è‡ªæ—‹é”ç”¨äºå¤„ç†å™¨ä¹‹é—´çš„äº’æ–¥ï¼Œé€‚åˆä¿æŠ¤å¾ˆçŸ­çš„ä¸´ç•ŒåŒºï¼Œä¸å…è®¸åœ¨ä¸´ç•ŒåŒºç¡çœ </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/spinlock_types.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> spinlock {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> raw_spinlock rlock;
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">spinlock_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> raw_spinlock {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">arch_spinlock_t</span> raw_lock;
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">raw_spinlock_t</span>;
</span></span></code></pre></div><p>â€‚Linuxå†…æ ¸æœ‰ä¸€ä¸ªå®æ—¶å†…æ ¸åˆ†æ”¯ï¼ˆå¼€å¯é…ç½®å®CONFIG_PREEMPT_RTï¼‰æ¥æ”¯æŒç¡¬å®æ—¶ç‰¹æ€§ï¼Œå†…æ ¸ä¸»çº¿åªæ”¯æŒè½¯å®æ—¶  <br>
â€‚æ•°æ®ç±»å‹arch_spinlock_tï¼ŒARM64æ¶æ„çš„å®šä¹‰</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/spinlock_types.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span><span style="color:#75715e">#ifdef __AARCH64EB__     </span><span style="color:#75715e">/* å¤§ç«¯å­—èŠ‚åºï¼ˆé«˜ä½å­˜æ”¾åœ¨ä½åœ°å€ï¼‰ */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     u16 next;
</span></span><span style="display:flex;"><span>     u16 owner;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#else                    </span><span style="color:#75715e">/* å°ç«¯å­—èŠ‚åºï¼ˆä½ä½å­˜æ”¾åœ¨ä½åœ°å€ï¼‰ */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     u16 owner;
</span></span><span style="display:flex;"><span>     u16 next;
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#a6e22e">__aligned</span>(<span style="color:#ae81ff">4</span>) <span style="color:#66d9ef">arch_spinlock_t</span>;
</span></span></code></pre></div><p>â€‚è‡ªæ—‹é”ä½¿ç”¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆå§‹åŒ–è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DEFINE_SPINLOCK</span>(x);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿è¡Œæ—¶åˆå§‹åŒ–è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">spin_lock_init</span>(x);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”³è¯·è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_lock</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_lock_bh</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_lock_irq</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spin_lock_irqsave</span>(lock, flags);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">spin_trylock</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_unlock</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_unlock_bh</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_unlock_irq</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">spin_unlock_irqrestore</span>(<span style="color:#66d9ef">spinlock_t</span> <span style="color:#f92672">*</span>lock, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> flags);
</span></span></code></pre></div><p>â€‚åŸå§‹è‡ªæ—‹é”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// åˆå§‹åŒ–åŸå§‹è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DEFINE_RAW_SPINLOCK</span>(x);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¿è¡Œæ—¶åˆå§‹åŒ–åŸå§‹è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">raw_spin_lock_init</span> (x);
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ç”³è¯·åŸå§‹è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">raw_spin_lock</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_lock_bh</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_lock_irq</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_lock_irqsave</span>(lock, flags)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_trylock</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// é‡Šæ”¾åŸå§‹è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">raw_spin_unlock</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_unlock_bh</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_unlock_irq</span>(lock)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">raw_spin_unlock_irqrestore</span>(lock, flags)
</span></span></code></pre></div><p>â€‚å‡½æ•°spin_lock()è´Ÿè´£ç”³è¯·è‡ªæ—‹é”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// spin_lock() -&gt; raw_spin_lock() -&gt; _raw_spin_lock() -&gt; __raw_spin_lock()  -&gt; do_raw_spin_lock() -&gt; arch_spin_lock()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>arch<span style="color:#f92672">/</span>arm64<span style="color:#f92672">/</span>include<span style="color:#f92672">/</span><span style="color:#66d9ef">asm</span><span style="color:#f92672">/</span>spinlock.h
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">arch_spin_lock</span>(<span style="color:#66d9ef">arch_spinlock_t</span> <span style="color:#f92672">*</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> tmp;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">arch_spinlock_t</span> lockval, newval;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">asm</span> <span style="color:#a6e22e">volatile</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ARM64_LSE_ATOMIC_INSN</span>(
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* LL/SC */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   prfm    pstl1strm, %3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;1:   ldaxr   %w0, %3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   add   %w1, %w0, %w5</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   stxr   %w2, %w1, %3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   cbnz   %w2, 1b</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* å¤§ç³»ç»Ÿæ‰©å±•çš„åŸå­æŒ‡ä»¤ */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   mov   %w2, %w5</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   ldadda   %w2, %w0, %3</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">__nops</span>(<span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>	)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* æˆ‘ä»¬å¾—åˆ°é”äº†å—ï¼Ÿ*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   eor   %w1, %w0, %w0, ror #16</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   cbz   %w1, 3f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   sevl</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;2:   wfe</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   ldaxrh   %w2, %4</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   eor   %w1, %w2, %w0, lsr #16</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;   cbnz   %w1, 2b</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">/* å¾—åˆ°é”ï¼Œä¸´ç•ŒåŒºä»è¿™é‡Œå¼€å§‹*/</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;3:&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;=&amp;r&#34;</span> (lockval), <span style="color:#e6db74">&#34;=&amp;r&#34;</span> (newval), <span style="color:#e6db74">&#34;=&amp;r&#34;</span> (tmp), <span style="color:#e6db74">&#34;+Q&#34;</span> (<span style="color:#f92672">*</span>lock)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Q&#34;</span> (lock<span style="color:#f92672">-&gt;</span>owner), <span style="color:#e6db74">&#34;I&#34;</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">&lt;&lt;</span> TICKET_SHIFT)
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;memory&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="57-è¯»å†™è‡ªæ—‹é”">5.7 è¯»å†™è‡ªæ—‹é”<a hidden class="anchor" aria-hidden="true" href="#57-è¯»å†™è‡ªæ—‹é”">#</a></h2>
<p>â€‚è¯»å†™è‡ªæ—‹é”(é€šå¸¸ç®€ç§°è¯»å†™é”)æ˜¯è‡ªæ—‹é”çš„æ”¹è¿›ï¼ŒåŒºåˆ†è¯»è€…å’Œå†™è€…ï¼Œå…è®¸å¤šä¸ªè¯»è€…åŒæ—¶è¿›å…¥ä¸´ç•ŒåŒºï¼Œè¯»è€…å’Œå†™è€…äº’æ–¥ï¼Œå†™è€…å’Œå†™è€…äº’æ–¥  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/rwlock_types.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">arch_rwlock_t</span> raw_lock;
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">rwlock_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arch/arm64/include/asm/spinlock_types.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> lock;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">arch_rwlock_t</span>;
</span></span></code></pre></div><h2 id="58-é¡ºåºé”">5.8 é¡ºåºé”<a hidden class="anchor" aria-hidden="true" href="#58-é¡ºåºé”">#</a></h2>
<p>â€‚é¡ºåºé”åŒºåˆ†è¯»è€…å’Œå†™è€…</p>
<h3 id="581å®Œæ•´ç‰ˆçš„é¡ºåºé”">5.8.1ã€€å®Œæ•´ç‰ˆçš„é¡ºåºé”<a hidden class="anchor" aria-hidden="true" href="#581å®Œæ•´ç‰ˆçš„é¡ºåºé”">#</a></h3>
<p>â€‚é¡ºåºé”åŒºåˆ†è¯»è€…å’Œå†™è€…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/seqlock.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> seqcount seqcount;  <span style="color:#75715e">// åºåˆ—å·
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">spinlock_t</span> lock;  <span style="color:#75715e">// è‡ªæ—‹é”
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} <span style="color:#66d9ef">seqlock_t</span>;
</span></span></code></pre></div><h3 id="582åªæä¾›åºåˆ—å·çš„é¡ºåºé”">5.8.2ã€€åªæä¾›åºåˆ—å·çš„é¡ºåºé”<a hidden class="anchor" aria-hidden="true" href="#582åªæä¾›åºåˆ—å·çš„é¡ºåºé”">#</a></h3>
<h2 id="59ç¦æ­¢å†…æ ¸æŠ¢å ">5.9ã€€ç¦æ­¢å†…æ ¸æŠ¢å <a hidden class="anchor" aria-hidden="true" href="#59ç¦æ­¢å†…æ ¸æŠ¢å ">#</a></h2>
<p>â€‚æ¯ä¸ªè¿›ç¨‹çš„thread_infoç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨ï¼šâ€œint preempt_countâ€ï¼Œå…¶ä¸­ç¬¬0ï½7ä½æ˜¯æŠ¢å è®¡æ•°ï¼Œç¬¬8ï½15ä½æ˜¯è½¯ä¸­æ–­è®¡æ•°ï¼Œç¬¬16ï½19ä½æ˜¯ç¡¬ä¸­æ–­è®¡æ•°ï¼Œç¬¬20ä½æ˜¯ä¸å¯å±è”½ä¸­æ–­è®¡æ•°  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ç¦æ­¢å†…æ ¸æŠ¢å çš„ç¼–ç¨‹æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">preempt_disable</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¼€å¯å†…æ ¸æŠ¢å çš„ç¼–ç¨‹æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">preempt_enable</span>()
</span></span></code></pre></div><p>â€‚ç”³è¯·è‡ªæ—‹é”çš„å‡½æ•°åŒ…å«äº†ç¦æ­¢å†…æ ¸æŠ¢å </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">spin_lock</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">raw_spin_lock</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">_raw_spin_lock</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">__raw_spin_lock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/spinlock_api_smp.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__raw_spin_lock</span>(<span style="color:#66d9ef">raw_spinlock_t</span> <span style="color:#f92672">*</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">preempt_disable</span>();
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">LOCK_CONTENDED</span>(lock, do_raw_spin_trylock, do_raw_spin_lock);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>â€‚é‡Šæ”¾è‡ªæ—‹é”çš„å‡½æ•°åŒ…å«äº†å¼€å¯å†…æ ¸æŠ¢å </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">spin_unlock</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">raw_spin_unlock</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">_raw_spin_unlock</span>() <span style="color:#f92672">-&gt;</span> <span style="color:#a6e22e">__raw_spin_unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/spinlock_api_smp.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__raw_spin_unlock</span>(<span style="color:#66d9ef">raw_spinlock_t</span> <span style="color:#f92672">*</span>lock)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     <span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">do_raw_spin_unlock</span>(lock);
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">preempt_enable</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="510è¿›ç¨‹å’Œè½¯ä¸­æ–­äº’æ–¥">5.10ã€€è¿›ç¨‹å’Œè½¯ä¸­æ–­äº’æ–¥<a hidden class="anchor" aria-hidden="true" href="#510è¿›ç¨‹å’Œè½¯ä¸­æ–­äº’æ–¥">#</a></h2>
<p>â€‚æ¯ä¸ªè¿›ç¨‹çš„thread_infoç»“æ„ä½“æœ‰ä¸€ä¸ªæŠ¢å è®¡æ•°å™¨â€œint preempt_countâ€ï¼Œå…¶ä¸­ç¬¬8ï½15ä½æ˜¯è½¯ä¸­æ–­è®¡æ•°  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ç¦æ­¢è½¯ä¸­æ–­çš„æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">local_bh_disable</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¼€å¯è½¯ä¸­æ–­çš„æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">local_bh_enable</span>()
</span></span></code></pre></div><h2 id="511è¿›ç¨‹å’Œç¡¬ä¸­æ–­äº’æ–¥">5.11ã€€è¿›ç¨‹å’Œç¡¬ä¸­æ–­äº’æ–¥<a hidden class="anchor" aria-hidden="true" href="#511è¿›ç¨‹å’Œç¡¬ä¸­æ–­äº’æ–¥">#</a></h2>
<p>â€‚è¿›ç¨‹å’Œç¡¬ä¸­æ–­å¯èƒ½è®¿é—®åŒä¸€ä¸ªå¯¹è±¡ï¼Œé‚£ä¹ˆè¿›ç¨‹å’Œç¡¬ä¸­æ–­éœ€è¦äº’æ–¥ï¼Œè¿›ç¨‹éœ€è¦ç¦æ­¢ç¡¬ä¸­æ–­  <br></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// ç¦æ­¢ç¡¬ä¸­æ–­çš„æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">local_irq_disable</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">local_irq_save</span>(flags)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¼€å¯ç¡¬ä¸­æ–­æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">local_irq_enable</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">local_irq_restore</span>(flags)
</span></span></code></pre></div><h2 id="512æ¯å¤„ç†å™¨å˜é‡">5.12ã€€æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#512æ¯å¤„ç†å™¨å˜é‡">#</a></h2>
<p>â€‚å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œæ¯å¤„ç†å™¨å˜é‡ä¸ºæ¯ä¸ªå¤„ç†å™¨ç”Ÿæˆä¸€ä¸ªå˜é‡çš„å‰¯æœ¬ <br>
â€‚æ¯å¤„ç†å™¨å˜é‡åˆ†ä¸ºé™æ€å’ŒåŠ¨æ€ä¸¤ç§ <br></p>
<h3 id="5121é™æ€æ¯å¤„ç†å™¨å˜é‡">5.12.1ã€€é™æ€æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#5121é™æ€æ¯å¤„ç†å™¨å˜é‡">#</a></h3>
<h3 id="5122åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡">5.12.2ã€€åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#5122åŠ¨æ€æ¯å¤„ç†å™¨å˜é‡">#</a></h3>
<h3 id="5123è®¿é—®æ¯å¤„ç†å™¨å˜é‡">5.12.3ã€€è®¿é—®æ¯å¤„ç†å™¨å˜é‡<a hidden class="anchor" aria-hidden="true" href="#5123è®¿é—®æ¯å¤„ç†å™¨å˜é‡">#</a></h3>
<h2 id="513æ¯å¤„ç†å™¨è®¡æ•°å™¨">5.13ã€€æ¯å¤„ç†å™¨è®¡æ•°å™¨<a hidden class="anchor" aria-hidden="true" href="#513æ¯å¤„ç†å™¨è®¡æ•°å™¨">#</a></h2>
<p>â€‚åŸå­å˜é‡ä½œä¸ºè®¡æ•°å™¨</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// include/linux/percpu_counter.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> percpu_counter {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">raw_spinlock_t</span> lock;
</span></span><span style="display:flex;"><span>	s64 count;
</span></span><span style="display:flex;"><span>	<span style="color:#960050;background-color:#1e0010">â€¦</span>
</span></span><span style="display:flex;"><span>	s32 __percpu <span style="color:#f92672">*</span>counters;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="514å†…å­˜å±éšœ">5.14ã€€å†…å­˜å±éšœ<a hidden class="anchor" aria-hidden="true" href="#514å†…å­˜å±éšœ">#</a></h2>
<p>â€‚å†…å­˜å±éšœï¼ˆmemory barrierï¼‰æ˜¯ä¸€ç§ä¿è¯å†…å­˜è®¿é—®é¡ºåºçš„æ–¹æ³•ï¼Œè§£å†³å†…å­˜è®¿é—®ä¹±åºé—®é¢˜  <br>
â€ƒ(1)    <br>
â€ƒ(2)    <br>
â€ƒ(3)    <br></p>
<p>â€‚å†…æ ¸æ”¯æŒ3ç§å†…å­˜å±éšœ  <br>
â€ƒ(1)ç¼–è¯‘å™¨å±éšœ  <br>
â€ƒ(2)å¤„ç†å™¨å†…å­˜å±éšœ  <br>
â€ƒ(3)å†…å­˜æ˜ å°„I/O (Memory Mapping I/O MMIO)å†™å±éšœ   <br></p>
<h3 id="5141ç¼–è¯‘å™¨å±éšœ">5.14.1ã€€ç¼–è¯‘å™¨å±éšœ<a hidden class="anchor" aria-hidden="true" href="#5141ç¼–è¯‘å™¨å±éšœ">#</a></h3>
<p>â€‚ç¼–è¯‘å™¨å±éšœ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">barrier</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/// GCCç¼–è¯‘å™¨å®šä¹‰çš„å®â€œbarrier()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// include/linux/compiler-gcc.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define barrier() __asm__ __volatile__(&#34;&#34;: : :&#34;memory&#34;)
</span></span></span></code></pre></div><h3 id="5142å¤„ç†å™¨å†…å­˜å±éšœ">5.14.2ã€€å¤„ç†å™¨å†…å­˜å±éšœ<a hidden class="anchor" aria-hidden="true" href="#5142å¤„ç†å™¨å†…å­˜å±éšœ">#</a></h3>
<p>â€‚å¤„ç†å™¨å†…å­˜å±éšœç”¨æ¥è§£å†³å¤„ç†å™¨ä¹‹é—´çš„å†…å­˜è®¿é—®ä¹±åºé—®é¢˜å’Œå¤„ç†å™¨è®¿é—®å¤–å›´è®¾å¤‡çš„ä¹±åºé—®é¢˜  <br></p>
<table>
	<tr>
	    <th>å†…å­˜å±éšœç±»å‹</th>
	    <th>å¼ºåˆ¶æ€§å†…å­˜å±éšœ</th>
	    <th>SMPå†…å­˜å±éšœ</th>  
	</tr >
	<tr >
	    <td >é€šç”¨å†…å­˜å±éšœ</td>
	    <td>mb()</td>
	    <td>smp_mb()</td>
	</tr>
	<tr >
	    <td >å†™å†…å­˜å±éšœ</td>
	    <td>wmb()</td>
	    <td>smp_wmb()</td>
	</tr>
	<tr >
	    <td >è¯»å†…å­˜å±éšœ</td>
	    <td>rmb()</td>
	    <td>smp_rmb()</td>
	</tr>
	<tr >
	    <td >æ•°æ®ä¾èµ–å±éšœ</td>
	    <td>read_barrier_depends()</td>
	    <td>smp_read_barrier_depends()</td>
	</tr>
</table>
<h3 id="5143-mmioå†™å±éšœ">5.14.3 MMIOå†™å±éšœ<a hidden class="anchor" aria-hidden="true" href="#5143-mmioå†™å±éšœ">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// å†…æ ¸ä¸ºå†…å­˜æ˜ å°„I/Oå†™æ“ä½œæä¾›äº†ä¸€ä¸ªç‰¹æ®Šçš„å±éšœ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mmiowb</span>();
</span></span></code></pre></div><h3 id="5144éšå«å†…å­˜å±éšœ">5.14.4ã€€éšå«å†…å­˜å±éšœ<a hidden class="anchor" aria-hidden="true" href="#5144éšå«å†…å­˜å±éšœ">#</a></h3>
<p>â€‚å†…æ ¸çš„æœ‰äº›å‡½æ•°éšå«å†…å­˜å±éšœ  <br>
â€‚ï¼ˆ1ï¼‰è·å–å’Œé‡Šæ”¾å‡½æ•°ã€‚  <br>
â€‚ï¼ˆ2ï¼‰ä¸­æ–­ç¦æ­¢å‡½æ•°ã€‚  <br></p>
<h3 id="5145arm64å¤„ç†å™¨å†…å­˜å±éšœ">5.14.5ã€€ARM64å¤„ç†å™¨å†…å­˜å±éšœ<a hidden class="anchor" aria-hidden="true" href="#5145arm64å¤„ç†å™¨å†…å­˜å±éšœ">#</a></h3>
<p>â€‚ARM64å¤„ç†å™¨æä¾›äº†3ç§å†…å­˜å±éšœ  <br>
â€‚(1)æŒ‡ä»¤åŒæ­¥å±éšœ(Instruction Synchronization Barrier ISB),æŒ‡ä»¤æ˜¯isb <br>
â€‚(2)æ•°æ®å†…å­˜å±éšœ(Data Memory Barrier DMB)ï¼ŒæŒ‡ä»¤æ˜¯dmb  <br>
â€‚(3)æ•°æ®åŒæ­¥å±éšœ(Data Synchronization Barrier DSb)ï¼ŒæŒ‡ä»¤æ˜¯dsb  <br></p>
<h2 id="515rcu">5.15ã€€RCU<a hidden class="anchor" aria-hidden="true" href="#515rcu">#</a></h2>
<p>â€‚RCU(Read-Copy Update)è¯»-å¤åˆ¶æ›´æ–°  <br></p>
<h3 id="5152æŠ€æœ¯åŸç†">5.15.2ã€€æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#5152æŠ€æœ¯åŸç†">#</a></h3>
<h2 id="516å¯ç¡çœ rcu">5.16ã€€å¯ç¡çœ RCU<a hidden class="anchor" aria-hidden="true" href="#516å¯ç¡çœ rcu">#</a></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"></code></pre></div><h2 id="517æ­»é”æ£€æµ‹å·¥å…·lockdep">5.17ã€€æ­»é”æ£€æµ‹å·¥å…·lockdep<a hidden class="anchor" aria-hidden="true" href="#517æ­»é”æ£€æµ‹å·¥å…·lockdep">#</a></h2>
<p>â€‚æ­»é”æœ‰ä»¥ä¸‹4ç§æƒ…å†µ  <br>
â€‚1ï¼‰è¿›ç¨‹é‡å¤ç”³è¯·åŒä¸€ä¸ªé”ï¼Œç§°ä¸ºAAæ­»é”  <br>
â€‚2ï¼‰è¿›ç¨‹ç”³è¯·è‡ªæ—‹é”æ—¶æ²¡æœ‰ç¦æ­¢ç¡¬ä¸­æ–­ï¼Œè¿›ç¨‹è·å–è‡ªæ—‹é”ä»¥åï¼Œç¡¬ä¸­æ–­æŠ¢å ï¼Œç”³è¯·åŒä¸€ä¸ªè‡ªæ—‹é”  <br>
â€‚3ï¼‰ä¸¤ä¸ªè¿›ç¨‹éƒ½è¦è·å–é”L1å’ŒL2ï¼Œè¿›ç¨‹1æŒæœ‰é”L1ï¼Œå†å»è·å–é”L2ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™è¿›ç¨‹2æŒæœ‰é”L2å¹¶ä¸”æ­£åœ¨å°è¯•è·å–é”L1ï¼Œé‚£ä¹ˆè¿›ç¨‹1å’Œè¿›ç¨‹2å°±ä¼šæ­»é”ï¼Œç§°ä¸ºAB-BAæ­»é”  <br>
â€‚4ï¼‰åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿›ç¨‹1æŒæœ‰é”L1ï¼Œå†å»è·å–é”L2ï¼Œåœ¨å¦ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿›ç¨‹2æŒæœ‰é”L2ï¼Œç¡¬ä¸­æ–­æŠ¢å è¿›ç¨‹2ä»¥åè·å–é”L1  <br></p>
<h3 id="5171ä½¿ç”¨æ–¹æ³•">5.17.1ã€€ä½¿ç”¨æ–¹æ³•<a hidden class="anchor" aria-hidden="true" href="#5171ä½¿ç”¨æ–¹æ³•">#</a></h3>
<p>â€‚æ­»é”æ£€æµ‹å·¥å…·lockdepçš„é…ç½®å®</p>
<h3 id="5172æŠ€æœ¯åŸç†">5.17.2ã€€æŠ€æœ¯åŸç†<a hidden class="anchor" aria-hidden="true" href="#5172æŠ€æœ¯åŸç†">#</a></h3>
<h1 id="ç¬¬6ç« -æ–‡ä»¶ç³»ç»Ÿ">ç¬¬6ç«  æ–‡ä»¶ç³»ç»Ÿ<a hidden class="anchor" aria-hidden="true" href="#ç¬¬6ç« -æ–‡ä»¶ç³»ç»Ÿ">#</a></h1>
<h2 id="61æ¦‚è¿°">6.1ã€€æ¦‚è¿°<a hidden class="anchor" aria-hidden="true" href="#61æ¦‚è¿°">#</a></h2>
<p>â€‚Linuxç³»ç»Ÿä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶  <br></p>
<p><img loading="lazy" src="https://raw.githubusercontent.com/zainll/PictureBed/main/blogs/pictures/20221201002338.png" alt="20221201002338"  />
</p>
<center>Linuxæ–‡ä»¶ç³»ç»Ÿçš„æ¶æ„</center>
<h3 id="611ç”¨æˆ·ç©ºé—´å±‚é¢">6.1.1ã€€ç”¨æˆ·ç©ºé—´å±‚é¢<a hidden class="anchor" aria-hidden="true" href="#611ç”¨æˆ·ç©ºé—´å±‚é¢">#</a></h3>
<p>â€‚åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥ä½¿ç”¨å†…æ ¸æä¾›çš„ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>mount
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å¸è½½ç›®å½•ä¸‹æŒ‚è½½çš„æ–‡ä»¶ç³»ç»Ÿ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>umount
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ‰“å¼€æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>open
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å…³é—­æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>close
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å†™æ–‡ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>write
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è®¾ç½®æ–‡ä»¶åç§»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>lseek
</span></span><span style="display:flex;"><span><span style="color:#75715e">// æ–‡ä»¶ä¿®æ”¹è¿‡çš„å±æ€§å’Œæ•°æ®ç«‹å³å†™åˆ°å­˜å‚¨è®¾å¤‡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fsync
</span></span></code></pre></div><p>â€‚glibcåº“å°è£…çš„æ ‡å‡†I/Oæµå‡½æ•°è®¿é—®æ–‡ä»¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// æ‰“å¼€æµ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fopen
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å…³é—­æµ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fclose
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è¯»æµ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fread
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å†™æµ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fwrite
</span></span><span style="display:flex;"><span><span style="color:#75715e">// è®¾ç½®æ–‡ä»¶åç§»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fseek
</span></span><span style="display:flex;"><span><span style="color:#75715e">// å†²åˆ·æµ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>fflush
</span></span></code></pre></div><h3 id="612ç¡¬ä»¶å±‚é¢">6.1.2ã€€ç¡¬ä»¶å±‚é¢<a hidden class="anchor" aria-hidden="true" href="#612ç¡¬ä»¶å±‚é¢">#</a></h3>
<p>â€‚å¤–éƒ¨å­˜å‚¨è®¾å¤‡åˆ†ä¸ºå—è®¾å¤‡ã€é—ªå­˜å’ŒNVDIMMè®¾å¤‡3ç±»  <br></p>
<p>â€‚é—ªå­˜æŒ‰å­˜å‚¨ç»“æ„åˆ†ä¸ºNANDé—ªå­˜å’ŒNORé—ªå­˜  <br></p>
<h3 id="613å†…æ ¸ç©ºé—´å±‚é¢">6.1.3ã€€å†…æ ¸ç©ºé—´å±‚é¢<a hidden class="anchor" aria-hidden="true" href="#613å†…æ ¸ç©ºé—´å±‚é¢">#</a></h3>
<p>â€‚ä½¿ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå®ç°èƒ½å¤Ÿå…±å­˜ï¼Œå†…æ ¸å®ç°äº†ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œç§°ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVirtual File Systemï¼ŒVFSï¼‰ï¼Œä¹Ÿç§°ä¸ºè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢ï¼ˆVirtual Filesystem Switchï¼ŒVFSï¼‰   <br>
â€‚æ–‡ä»¶ç³»ç»Ÿåˆ†ä¸ºä»¥ä¸‹4ç§  <br></p>


        </div>
        <div class="post-reward">
            <div style="padding: 0 0 0 0; margin: 0 0 0 0; width: 100%; font-size:16px; text-align: center;">
                <div id="QR" style="opacity: 0;">
                    <div id="wechat" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="wechat_qr" src="https://liuz0123.gitee.io/zain/img/wechat_pay.jpg" alt="wechat_pay"></a>
                        <p>å¾®ä¿¡</p>
                    </div>
                    <div id="alipay" style="display: inline-block">
                        <a class="fancybox" rel="group">
                            <img id="alipay_qr" src="https://liuz0123.gitee.io/zain/img/alipay.jpg" alt="alipay"></a>
                        <p>æ”¯ä»˜å®</p>
                    </div>
                </div>
                <button id="rewardButton"
                        onclick="
                    var qr = document.getElementById('QR');
                    if (qr.style.opacity === '0') {
                        qr.style.opacity='1';
                    } else {
                        qr.style.opacity='0'
                    }"
                >
                    <span>ğŸ§§ é¼“åŠ±</span>
                </button>
            </div>
        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://liuz0123.gitee.io/zain/posts/na/%E9%81%93%E6%AD%89/">
    <span class="title">Â« ä¸Šä¸€é¡µ</span>
    <br>
    <span>è¯·æ±‚å¨œçš„åŸè°…</span>
  </a>
  <a class="next" href="https://liuz0123.gitee.io/zain/posts/blog/git/">
    <span class="title">ä¸‹ä¸€é¡µ Â»</span>
    <br>
    <span>git</span>
  </a>
</nav>

        </footer>
    </div>



<div>
    <div class="pagination__title">
        <span class="pagination__title-h" style="font-size: 20px;">ğŸ’¬è¯„è®º</span>
        <hr />
    </div>

    <div id="tcomment"></div>

    <script src="https://cdn.staticfile.org/twikoo/1.6.7/twikoo.all.min.js">
    </script>
    

    

    <script>
        twikoo.init({
            envId: "https://twikoo.js.org/quick-start.html#%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2", 
            el: "#tcomment",
            lang: 'zh-CN',
            region: 'ap-guangzhou', 
            path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
            
            
            
            
            
            
            
        });
    </script>

</div>
</article>
</main>


<script async src="https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js"></script>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<footer class="footer">
    <span>
        Copyright
        &copy;
        2020-2022 
        <a href="https://liuz0123.gitee.io/zain/" style="color:#939393;">zain&#39;s Blog</a>
         All Rights Reserved
    </span>

    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;">å¤‡æ¡ˆå·ç”³è¯·ä¸­</a>&nbsp;

    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="å¡«è‡ªå·±çš„å…¬å®‰å›¾æ ‡é“¾æ¥" style="float:left;margin: 0px 5px 0px 0px;"/>
             å…¬ç½‘å®‰å¤‡
        </a>
    </span>

    <span id="busuanzi_container">
        <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
        æ€»è®¿å®¢æ•°: <span id="busuanzi_value_site_uv"></span>
        æ€»è®¿é—®é‡: <span id="busuanzi_value_site_pv"></span>
    </span>
    
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 400 || document.documentElement.scrollTop > 400) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'ğŸ“„å¤åˆ¶';

        function copyingDone() {
            copybutton.innerText = 'ğŸ‘ŒğŸ»å·²å¤åˆ¶!';
            setTimeout(() => {
                copybutton.innerText = 'ğŸ“„å¤åˆ¶';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\r\n' +
                    'ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºã€Œ'+"zain's Blog"+'ã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚' +
                    '\r\nåŸæ–‡é“¾æ¥ï¼š' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {
            }
            ;
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
